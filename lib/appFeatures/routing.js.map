{"version":3,"sources":["../../src/appFeatures/routing.js"],"names":["Feature","require","Enums","_","eachAsync_","module","exports","type","PLUGIN","load_","app","routes","on","waitFor","push","routersConfig","route","isPlainObject","options","loader_","log","name","mainRoute","baseRoute","pos","indexOf","substring","Array","isArray","rules"],"mappings":"AAAA;;;;AAOA,MAAM;AAAEA,EAAAA;AAAF,IAAcC,OAAO,CAAC,IAAD,CAAP,CAAcC,KAAlC;;AACA,MAAM;AAAEC,EAAAA,CAAF;AAAKC,EAAAA;AAAL,IAAoBH,OAAO,CAAC,YAAD,CAAjC;;AAEAI,MAAM,CAACC,OAAP,GAAiB;AAKbC,EAAAA,IAAI,EAAEP,OAAO,CAACQ,MALD;AAabC,EAAAA,KAAK,EAAE,CAACC,GAAD,EAAMC,MAAN,KAAiB;AACpBD,IAAAA,GAAG,CAACE,EAAJ,CAAO,WAAWZ,OAAO,CAACQ,MAA1B,EAAmCK,OAAD,IAAa;AAC3CA,MAAAA,OAAO,CAACC,IAAR,CACIV,UAAU,CAACO,MAAD,EAAS,OAAOI,aAAP,EAAsBC,KAAtB,KAAgC;AAC/C,YAAIb,CAAC,CAACc,aAAF,CAAgBF,aAAhB,CAAJ,EAAoC;AAChC,iBAAOX,UAAU,CAACW,aAAD,EAAgB,OAAOG,OAAP,EAAgBX,IAAhB,KAAyB;AACtD,gBAAIY,OAAO,GAAGlB,OAAO,CAAC,gBAAgBM,IAAjB,CAArB;;AAEAG,YAAAA,GAAG,CAACU,GAAJ,CAAQ,SAAR,EAAoB,MAAKb,IAAK,2BAA0BS,KAAM,aAAYN,GAAG,CAACW,IAAK,IAAnF;AAEA,mBAAOF,OAAO,CAACT,GAAD,EAAMM,KAAN,EAAaE,OAAb,CAAd;AACH,WANgB,CAAjB;AAOH,SARD,MAQO;AAEH,cAAII,SAAS,GAAG,GAAhB;AAAA,cACIC,SAAS,GAAGP,KADhB;AAEA,cAAIQ,GAAG,GAAGR,KAAK,CAACS,OAAN,CAAc,IAAd,CAAV;;AAEA,cAAID,GAAG,KAAK,CAAC,CAAb,EAAgB;AACZF,YAAAA,SAAS,GAAGN,KAAK,CAACU,SAAN,CAAgB,CAAhB,EAAmBF,GAAG,GAAG,CAAzB,CAAZ;AACAD,YAAAA,SAAS,GAAGP,KAAK,CAACU,SAAN,CAAgBF,GAAG,GAAG,CAAtB,CAAZ;AACH,WAHD,MAGO,IAAIG,KAAK,CAACC,OAAN,CAAcb,aAAd,CAAJ,EAAkC;AAErCO,YAAAA,SAAS,GAAG,OAAZ;AACH;;AAED,cAAIO,KAAK,GAAG;AACR,aAACP,SAAD,GAAaP;AADL,WAAZ;;AAIA,cAAII,OAAO,GAAGlB,OAAO,CAAC,iBAAD,CAArB;;AACAS,UAAAA,GAAG,CAACU,GAAJ,CAAQ,SAAR,EAAoB,kCAAiCG,SAAU,aAAYb,GAAG,CAACW,IAAK,IAApF;AAEA,iBAAOF,OAAO,CAACT,GAAD,EAAMa,SAAN,EAAiB;AAAEM,YAAAA,KAAK,EAAEA;AAAT,WAAjB,CAAd;AACH;AACJ,OAhCS,CADd;AAmCH,KApCD;AAqCH;AAnDY,CAAjB","sourcesContent":["\"use strict\";\n\n/**\n * Enable web request routing.\n * @module Feature_Routing\n */\n\nconst { Feature } = require(\"..\").Enums;\nconst { _, eachAsync_ } = require(\"@genx/july\");\n\nmodule.exports = {\n    /**\n     * This feature is loaded at ready (final) stage.\n     * @member {string}\n     */\n    type: Feature.PLUGIN,\n\n    /**\n     * Load the feature.\n     * @param {Routable} app - The app module object\n     * @param {object} routes - Routes and configuration\n     * @returns {Promise.<*>}\n     */\n    load_: (app, routes) => {\n        app.on(\"after:\" + Feature.PLUGIN, (waitFor) => {\n            waitFor.push(\n                eachAsync_(routes, async (routersConfig, route) => {\n                    if (_.isPlainObject(routersConfig)) {\n                        return eachAsync_(routersConfig, async (options, type) => {\n                            let loader_ = require(\"../routers/\" + type);\n\n                            app.log(\"verbose\", `A \"${type}\" router is created at \"${route}\" in app [${app.name}].`);\n\n                            return loader_(app, route, options);\n                        });\n                    } else {\n                        // 'route': 'method:/path'\n                        let mainRoute = \"/\",\n                            baseRoute = route;\n                        let pos = route.indexOf(\":/\");\n\n                        if (pos !== -1) {\n                            mainRoute = route.substring(0, pos + 2);\n                            baseRoute = route.substring(pos + 1);\n                        } else if (Array.isArray(routersConfig)) {\n                            //all handled by middleware chains\n                            mainRoute = \"all:/\";\n                        }\n\n                        let rules = {\n                            [mainRoute]: routersConfig,\n                        };\n\n                        let loader_ = require(\"../routers/rule\");\n                        app.log(\"verbose\", `A \"rule\" router is created at \"${baseRoute}\" in app [${app.name}].`);\n\n                        return loader_(app, baseRoute, { rules: rules });\n                    }\n                })\n            );\n        });\n    },\n};\n"],"file":"routing.js"}