{"version":3,"file":"routing.js","names":["Feature","require","Enums","_","eachAsync_","module","exports","type","PLUGIN","load_","app","routes","on","waitFor","push","routersConfig","route","isPlainObject","options","loader_","log","name","mainRoute","baseRoute","pos","indexOf","substring","Array","isArray","rules"],"sources":["../../src/appFeatures/routing.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Enable web request routing.\n * @module Feature_Routing\n */\n\nconst { Feature } = require(\"..\").Enums;\nconst { _, eachAsync_ } = require(\"@genx/july\");\n\nmodule.exports = {\n    /**\n     * This feature is loaded at ready (final) stage.\n     * @member {string}\n     */\n    type: Feature.PLUGIN,\n\n    /**\n     * Load the feature.\n     * @param {Routable} app - The app module object\n     * @param {object} routes - Routes and configuration\n     * @returns {Promise.<*>}\n     */\n    load_: (app, routes) => {\n        app.on(\"after:\" + Feature.PLUGIN, (waitFor) => {\n            waitFor.push(\n                eachAsync_(routes, async (routersConfig, route) => {\n                    if (_.isPlainObject(routersConfig)) {\n                        return eachAsync_(routersConfig, async (options, type) => {\n                            let loader_ = require(\"../routers/\" + type);\n\n                            app.log(\"verbose\", `A \"${type}\" router is created at \"${route}\" in app [${app.name}].`);\n\n                            return loader_(app, route, options);\n                        });\n                    } else {\n                        // 'route': 'method:/path'\n                        let mainRoute = \"/\",\n                            baseRoute = route;\n                        let pos = route.indexOf(\":/\");\n\n                        if (pos !== -1) {\n                            mainRoute = route.substring(0, pos + 2);\n                            baseRoute = route.substring(pos + 1);\n                        } else if (Array.isArray(routersConfig)) {\n                            //all handled by middleware chains\n                            mainRoute = \"all:/\";\n                        }\n\n                        let rules = {\n                            [mainRoute]: routersConfig,\n                        };\n\n                        let loader_ = require(\"../routers/rule\");\n                        app.log(\"verbose\", `A \"rule\" router is created at \"${baseRoute}\" in app [${app.name}].`);\n\n                        return loader_(app, baseRoute, { rules: rules });\n                    }\n                })\n            );\n        });\n    },\n};\n"],"mappings":"AAAA;;;;AAOA,MAAM;EAAEA;AAAF,IAAcC,OAAO,CAAC,IAAD,CAAP,CAAcC,KAAlC;;AACA,MAAM;EAAEC,CAAF;EAAKC;AAAL,IAAoBH,OAAO,CAAC,YAAD,CAAjC;;AAEAI,MAAM,CAACC,OAAP,GAAiB;EAKbC,IAAI,EAAEP,OAAO,CAACQ,MALD;EAabC,KAAK,EAAE,CAACC,GAAD,EAAMC,MAAN,KAAiB;IACpBD,GAAG,CAACE,EAAJ,CAAO,WAAWZ,OAAO,CAACQ,MAA1B,EAAmCK,OAAD,IAAa;MAC3CA,OAAO,CAACC,IAAR,CACIV,UAAU,CAACO,MAAD,EAAS,OAAOI,aAAP,EAAsBC,KAAtB,KAAgC;QAC/C,IAAIb,CAAC,CAACc,aAAF,CAAgBF,aAAhB,CAAJ,EAAoC;UAChC,OAAOX,UAAU,CAACW,aAAD,EAAgB,OAAOG,OAAP,EAAgBX,IAAhB,KAAyB;YACtD,IAAIY,OAAO,GAAGlB,OAAO,CAAC,gBAAgBM,IAAjB,CAArB;;YAEAG,GAAG,CAACU,GAAJ,CAAQ,SAAR,EAAoB,MAAKb,IAAK,2BAA0BS,KAAM,aAAYN,GAAG,CAACW,IAAK,IAAnF;YAEA,OAAOF,OAAO,CAACT,GAAD,EAAMM,KAAN,EAAaE,OAAb,CAAd;UACH,CANgB,CAAjB;QAOH,CARD,MAQO;UAEH,IAAII,SAAS,GAAG,GAAhB;UAAA,IACIC,SAAS,GAAGP,KADhB;UAEA,IAAIQ,GAAG,GAAGR,KAAK,CAACS,OAAN,CAAc,IAAd,CAAV;;UAEA,IAAID,GAAG,KAAK,CAAC,CAAb,EAAgB;YACZF,SAAS,GAAGN,KAAK,CAACU,SAAN,CAAgB,CAAhB,EAAmBF,GAAG,GAAG,CAAzB,CAAZ;YACAD,SAAS,GAAGP,KAAK,CAACU,SAAN,CAAgBF,GAAG,GAAG,CAAtB,CAAZ;UACH,CAHD,MAGO,IAAIG,KAAK,CAACC,OAAN,CAAcb,aAAd,CAAJ,EAAkC;YAErCO,SAAS,GAAG,OAAZ;UACH;;UAED,IAAIO,KAAK,GAAG;YACR,CAACP,SAAD,GAAaP;UADL,CAAZ;;UAIA,IAAII,OAAO,GAAGlB,OAAO,CAAC,iBAAD,CAArB;;UACAS,GAAG,CAACU,GAAJ,CAAQ,SAAR,EAAoB,kCAAiCG,SAAU,aAAYb,GAAG,CAACW,IAAK,IAApF;UAEA,OAAOF,OAAO,CAACT,GAAD,EAAMa,SAAN,EAAiB;YAAEM,KAAK,EAAEA;UAAT,CAAjB,CAAd;QACH;MACJ,CAhCS,CADd;IAmCH,CApCD;EAqCH;AAnDY,CAAjB"}