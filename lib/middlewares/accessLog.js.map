{"version":3,"file":"accessLog.js","names":["InvalidConfiguration","require","requireFeatures","HttpStatus","module","exports","opt","app","logger","getService","ctx","next","startAt","now","info","ip","header","method","url","originalUrl","httpVersion","req","protocol","toUpperCase","status","size","length","referer","userAgent","isoTimestamp","toISO","duration","diff","milliseconds","level","log","getStatusText"],"sources":["../../src/middlewares/accessLog.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Add access log for every http request\n * @module Middleware_AccessLog\n */\n\nconst { InvalidConfiguration } = require('@genx/error');\nconst { requireFeatures } = require('../utils/Helpers');\nconst HttpStatus = require('http-status-codes');\n\nmodule.exports = (opt, app) => {        \n    requireFeatures([ 'timezone', 'loggers' ], app, 'accessLog');    \n\n    if (!opt.logger) {\n        throw new InvalidConfiguration('Missing logger id.', app, 'middlewares.accessLog.logger');\n    }\n\n    let logger = app.getService('logger.' + opt.logger);\n    if (!logger) {\n        throw new InvalidConfiguration('Logger not found. Id: ' + opt.logger, app, 'middlewares.accessLog.logger');\n    }\n\n    return async (ctx, next) => {\n        let startAt = app.now();       \n\n        await next();        \n\n        let info = {\n            ip: ctx.header['x-real-ip'] || ctx.ip,\n            method: ctx.method,\n            url: ctx.url,\n            originalUrl: ctx.originalUrl,           \n            httpVersion: ctx.req.httpVersion,        \n            protocol: ctx.protocol.toUpperCase(),\n            status: ctx.status,\n            size: ctx.length || '-',\n            referer: ctx.header['referer'] || '-',\n            userAgent: ctx.header['user-agent'] || '-',\n            isoTimestamp: startAt.toISO(),        \n            duration: app.now().diff(startAt).milliseconds\n        };\n\n        let level = 'info';\n\n        if (ctx.status >= 500) {\n            level = 'error';\n        } else if (ctx.status >= 400) {\n            level = 'warn';\n        }\n        \n        logger.log(level, HttpStatus.getStatusText(ctx.status), info);\n    };\n};"],"mappings":"AAAA;;;;AAOA,MAAM;EAAEA;AAAF,IAA2BC,OAAO,CAAC,aAAD,CAAxC;;AACA,MAAM;EAAEC;AAAF,IAAsBD,OAAO,CAAC,kBAAD,CAAnC;;AACA,MAAME,UAAU,GAAGF,OAAO,CAAC,mBAAD,CAA1B;;AAEAG,MAAM,CAACC,OAAP,GAAiB,CAACC,GAAD,EAAMC,GAAN,KAAc;EAC3BL,eAAe,CAAC,CAAE,UAAF,EAAc,SAAd,CAAD,EAA4BK,GAA5B,EAAiC,WAAjC,CAAf;;EAEA,IAAI,CAACD,GAAG,CAACE,MAAT,EAAiB;IACb,MAAM,IAAIR,oBAAJ,CAAyB,oBAAzB,EAA+CO,GAA/C,EAAoD,8BAApD,CAAN;EACH;;EAED,IAAIC,MAAM,GAAGD,GAAG,CAACE,UAAJ,CAAe,YAAYH,GAAG,CAACE,MAA/B,CAAb;;EACA,IAAI,CAACA,MAAL,EAAa;IACT,MAAM,IAAIR,oBAAJ,CAAyB,2BAA2BM,GAAG,CAACE,MAAxD,EAAgED,GAAhE,EAAqE,8BAArE,CAAN;EACH;;EAED,OAAO,OAAOG,GAAP,EAAYC,IAAZ,KAAqB;IACxB,IAAIC,OAAO,GAAGL,GAAG,CAACM,GAAJ,EAAd;IAEA,MAAMF,IAAI,EAAV;IAEA,IAAIG,IAAI,GAAG;MACPC,EAAE,EAAEL,GAAG,CAACM,MAAJ,CAAW,WAAX,KAA2BN,GAAG,CAACK,EAD5B;MAEPE,MAAM,EAAEP,GAAG,CAACO,MAFL;MAGPC,GAAG,EAAER,GAAG,CAACQ,GAHF;MAIPC,WAAW,EAAET,GAAG,CAACS,WAJV;MAKPC,WAAW,EAAEV,GAAG,CAACW,GAAJ,CAAQD,WALd;MAMPE,QAAQ,EAAEZ,GAAG,CAACY,QAAJ,CAAaC,WAAb,EANH;MAOPC,MAAM,EAAEd,GAAG,CAACc,MAPL;MAQPC,IAAI,EAAEf,GAAG,CAACgB,MAAJ,IAAc,GARb;MASPC,OAAO,EAAEjB,GAAG,CAACM,MAAJ,CAAW,SAAX,KAAyB,GAT3B;MAUPY,SAAS,EAAElB,GAAG,CAACM,MAAJ,CAAW,YAAX,KAA4B,GAVhC;MAWPa,YAAY,EAAEjB,OAAO,CAACkB,KAAR,EAXP;MAYPC,QAAQ,EAAExB,GAAG,CAACM,GAAJ,GAAUmB,IAAV,CAAepB,OAAf,EAAwBqB;IAZ3B,CAAX;IAeA,IAAIC,KAAK,GAAG,MAAZ;;IAEA,IAAIxB,GAAG,CAACc,MAAJ,IAAc,GAAlB,EAAuB;MACnBU,KAAK,GAAG,OAAR;IACH,CAFD,MAEO,IAAIxB,GAAG,CAACc,MAAJ,IAAc,GAAlB,EAAuB;MAC1BU,KAAK,GAAG,MAAR;IACH;;IAED1B,MAAM,CAAC2B,GAAP,CAAWD,KAAX,EAAkB/B,UAAU,CAACiC,aAAX,CAAyB1B,GAAG,CAACc,MAA7B,CAAlB,EAAwDV,IAAxD;EACH,CA7BD;AA8BH,CA1CD"}