"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const _ = Util._;

const Literal = require('../enum/Literal');

const Router = require('@koa/router');

const Controller = require('../patterns/Controller');

const {
  hasMethod
} = require('../utils/Helpers');

const appendId = (baseEndpoint, idName) => idName ? `${baseEndpoint}/:${idName}` : baseEndpoint;

const getBaseEndpoint = (endpoint, remaps, controller, action, idName) => {
  if (!remaps) return endpoint;
  let controllerAction = controller + '.' + action;

  if (controllerAction in remaps) {
    return appendId(remaps[controllerAction], idName);
  }

  if (!controllerAction.endsWith('_')) {
    controllerAction += '_';

    if (controllerAction in remaps) {
      return appendId(remaps[controllerAction], idName);
    }
  }

  return endpoint;
};

module.exports = (app, baseRoute, options) => {
  let resourcePath = path.resolve(app.backendPath, options.resourcesPath || Literal.RESOURCES_PATH);
  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(options.errorOptions, app), 'jsonError');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let resourcesPath = path.join(resourcePath, "**", "*.js");
  let files = Util.glob.sync(resourcesPath, {
    nodir: true
  });

  _.each(files, file => {
    let relPathWoe = path.relative(resourcePath, file).slice(0, -3);
    let baseEndpoint;

    if (options.remaps && relPathWoe in options.remaps) {
      baseEndpoint = Util.ensureLeftSlash(Util.trimRightSlash(options.remaps[relPathWoe]));
    } else {
      baseEndpoint = Util.ensureLeftSlash(relPathWoe.split(path.sep).map(p => _.kebabCase(p)).join('/'));
    }

    let entityName = path.basename(file, '.js');
    let idName = _.camelCase(entityName) + 'Id';
    let endpointWithId = appendId(baseEndpoint, idName);

    let controller = require(file);

    let isObj = false;

    if (controller.prototype instanceof Controller) {
      controller = new controller(app);
      isObj = true;
    }

    if (hasMethod(controller, 'findMany_')) {
      app.addRoute(router, 'get', getBaseEndpoint(baseEndpoint, options.remaps, relPathWoe, 'findMany'), isObj ? controller.findMany_.bind(controller) : controller.findMany_);
    }

    if (hasMethod(controller, 'create_')) {
      app.addRoute(router, 'post', getBaseEndpoint(baseEndpoint, options.remaps, relPathWoe, 'create'), isObj ? controller.create_.bind(controller) : controller.create_);
    }

    if (hasMethod(controller, 'findOne_')) {
      app.addRoute(router, 'get', getBaseEndpoint(endpointWithId, options.remaps, relPathWoe, 'findOne', idName), isObj ? controller.findOne_.bind(controller) : controller.findOne_);
    }

    if (hasMethod(controller, 'updateOne_')) {
      app.addRoute(router, 'put', getBaseEndpoint(endpointWithId, options.remaps, relPathWoe, 'updateOne', idName), isObj ? controller.updateOne_.bind(controller) : controller.updateOne_);
    }

    if (hasMethod(controller, 'deleteOne_')) {
      app.addRoute(router, 'del', getBaseEndpoint(endpointWithId, options.remaps, relPathWoe, 'deleteOne', idName), isObj ? controller.deleteOne_.bind(controller) : controller.deleteOne_);
    }
  });

  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL3Jlc3QuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJVdGlsIiwiXyIsIkxpdGVyYWwiLCJSb3V0ZXIiLCJDb250cm9sbGVyIiwiaGFzTWV0aG9kIiwiYXBwZW5kSWQiLCJiYXNlRW5kcG9pbnQiLCJpZE5hbWUiLCJnZXRCYXNlRW5kcG9pbnQiLCJlbmRwb2ludCIsInJlbWFwcyIsImNvbnRyb2xsZXIiLCJhY3Rpb24iLCJjb250cm9sbGVyQWN0aW9uIiwiZW5kc1dpdGgiLCJtb2R1bGUiLCJleHBvcnRzIiwiYXBwIiwiYmFzZVJvdXRlIiwib3B0aW9ucyIsInJlc291cmNlUGF0aCIsInJlc29sdmUiLCJiYWNrZW5kUGF0aCIsInJlc291cmNlc1BhdGgiLCJSRVNPVVJDRVNfUEFUSCIsInJvdXRlciIsInByZWZpeCIsInVzZU1pZGRsZXdhcmUiLCJnZXRNaWRkbGV3YXJlRmFjdG9yeSIsImVycm9yT3B0aW9ucyIsIm1pZGRsZXdhcmVzIiwidXNlTWlkZGxld2FyZXMiLCJqb2luIiwiZmlsZXMiLCJnbG9iIiwic3luYyIsIm5vZGlyIiwiZWFjaCIsImZpbGUiLCJyZWxQYXRoV29lIiwicmVsYXRpdmUiLCJzbGljZSIsImVuc3VyZUxlZnRTbGFzaCIsInRyaW1SaWdodFNsYXNoIiwic3BsaXQiLCJzZXAiLCJtYXAiLCJwIiwia2ViYWJDYXNlIiwiZW50aXR5TmFtZSIsImJhc2VuYW1lIiwiY2FtZWxDYXNlIiwiZW5kcG9pbnRXaXRoSWQiLCJpc09iaiIsInByb3RvdHlwZSIsImFkZFJvdXRlIiwiZmluZE1hbnlfIiwiYmluZCIsImNyZWF0ZV8iLCJmaW5kT25lXyIsInVwZGF0ZU9uZV8iLCJkZWxldGVPbmVfIiwiYWRkUm91dGVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsVUFBRCxD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QWpDLEVBQTZDLFdBQTdDLEVBQTBEaEMsTUFBMUQsQ0FBM0MsRUFBOEc4QyxLQUFLLEdBQUcxQyxVQUFVLENBQUNpRCxVQUFYLENBQXNCSCxJQUF0QixDQUEyQjlDLFVBQTNCLENBQUgsR0FBNENBLFVBQVUsQ0FBQ2lELFVBQTFLO0FBQ0g7O0FBRUQsUUFBSXhELFNBQVMsQ0FBQ08sVUFBRCxFQUFhLFlBQWIsQ0FBYixFQUF5QztBQUNyQ00sTUFBQUEsR0FBRyxDQUFDc0MsUUFBSixDQUFhOUIsTUFBYixFQUFxQixLQUFyQixFQUE0QmpCLGVBQWUsQ0FBQzRDLGNBQUQsRUFBaUJqQyxPQUFPLENBQUNULE1BQXpCLEVBQWlDNkIsVUFBakMsRUFBNkMsV0FBN0MsRUFBMERoQyxNQUExRCxDQUEzQyxFQUE4RzhDLEtBQUssR0FBRzFDLFVBQVUsQ0FBQ2tELFVBQVgsQ0FBc0JKLElBQXRCLENBQTJCOUMsVUFBM0IsQ0FBSCxHQUE0Q0EsVUFBVSxDQUFDa0QsVUFBMUs7QUFDSDtBQUNKLEdBekNEOztBQTJDQTVDLEVBQUFBLEdBQUcsQ0FBQzZDLFNBQUosQ0FBY3JDLE1BQWQ7QUFDSCxDQS9ERCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCBfID0gVXRpbC5fO1xuY29uc3QgTGl0ZXJhbCA9IHJlcXVpcmUoJy4uL2VudW0vTGl0ZXJhbCcpO1xuY29uc3QgUm91dGVyID0gcmVxdWlyZSgnQGtvYS9yb3V0ZXInKTtcbmNvbnN0IENvbnRyb2xsZXIgPSByZXF1aXJlKCcuLi9wYXR0ZXJucy9Db250cm9sbGVyJyk7XG5jb25zdCB7IGhhc01ldGhvZCB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvSGVscGVycycpO1xuXG4vKipcbiAqIFJFU1RmdWwgcm91dGVyLlxuICogQG1vZHVsZSBSb3V0ZXJfUmVzdFxuICovXG5cbmNvbnN0IGFwcGVuZElkID0gKGJhc2VFbmRwb2ludCwgaWROYW1lKSA9PiBpZE5hbWUgPyBgJHtiYXNlRW5kcG9pbnR9Lzoke2lkTmFtZX1gIDogYmFzZUVuZHBvaW50OyBcblxuY29uc3QgZ2V0QmFzZUVuZHBvaW50ID0gKGVuZHBvaW50LCByZW1hcHMsIGNvbnRyb2xsZXIsIGFjdGlvbiwgaWROYW1lKSA9PiB7XG4gICAgaWYgKCFyZW1hcHMpIHJldHVybiBlbmRwb2ludDtcbiAgICBcbiAgICBsZXQgY29udHJvbGxlckFjdGlvbiA9IGNvbnRyb2xsZXIgKyAnLicgKyBhY3Rpb247XG4gICAgaWYgKGNvbnRyb2xsZXJBY3Rpb24gaW4gcmVtYXBzKSB7XG4gICAgICAgIHJldHVybiBhcHBlbmRJZChyZW1hcHNbY29udHJvbGxlckFjdGlvbl0sIGlkTmFtZSk7XG4gICAgfVxuXG4gICAgaWYgKCFjb250cm9sbGVyQWN0aW9uLmVuZHNXaXRoKCdfJykpIHtcbiAgICAgICAgY29udHJvbGxlckFjdGlvbiArPSAnXyc7XG4gICAgICAgIGlmIChjb250cm9sbGVyQWN0aW9uIGluIHJlbWFwcykge1xuICAgICAgICAgICAgcmV0dXJuIGFwcGVuZElkKHJlbWFwc1tjb250cm9sbGVyQWN0aW9uXSwgaWROYW1lKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBlbmRwb2ludDtcbn07XG5cbi8qXG5jb25zdCBiYXRjaFF1ZXJ5XyA9IGFzeW5jIChjdHgpID0+IHtcblxuICAgIFxuXG59O1xuKi9cblxuLyoqXG4gKiBDcmVhdGUgYSBSRVNUZnVsIHJvdXRlci5cbiAqIEBwYXJhbSB7Kn0gYXBwIFxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2VSb3V0ZSBcbiAqIEBwYXJhbSB7b2JqZWN0c30gb3B0aW9ucyBcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5yZXNvdXJjZXNQYXRoXVxuICogQHByb3BlcnR5IHtvYmplY3R8YXJyYXl9IFtvcHRpb25zLm1pZGRsZXdhcmVzXVxuICogQGV4YW1wbGVcbiAqICAnPGJhc2UgcGF0aD4nOiB7XG4gKiAgICAgIHJlc3Q6IHtcbiAqICAgICAgICAgIHJlc291cmNlc1BhdGg6XG4gKiAgICAgICAgICBtaWRkbGV3YXJlczpcbiAqICAgICAgfVxuICogIH1cbiAqICBcbiAqICByb3V0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cCBtZXRob2QgICAgZnVuY3Rpb24gb2YgY3RybFxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBmaW5kTWFueV8gXG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIHBvc3QgICAgICAgICAgIGNyZWF0ZV9cbiAqICAvOnJlc291cmNlLzp1bmlxdWUta2V5Lzp2YWx1ZSAgZ2V0ICAgICAgICAgICAgZmluZE9uZUJ5X1xuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBmaW5kT25lX1xuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBwdXQgICAgICAgICAgICB1cGRhdGVPbmVfXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGRlbCAgICAgICAgICAgIGRlbGV0ZU9uZV9cbiAqL1xubW9kdWxlLmV4cG9ydHMgPSAoYXBwLCBiYXNlUm91dGUsIG9wdGlvbnMpID0+IHtcbiAgICBsZXQgcmVzb3VyY2VQYXRoID0gcGF0aC5yZXNvbHZlKGFwcC5iYWNrZW5kUGF0aCwgb3B0aW9ucy5yZXNvdXJjZXNQYXRoIHx8IExpdGVyYWwuUkVTT1VSQ0VTX1BBVEgpO1xuICAgIFxuICAgIGxldCByb3V0ZXIgPSBiYXNlUm91dGUgPT09ICcvJyA/IG5ldyBSb3V0ZXIoKSA6IG5ldyBSb3V0ZXIoe3ByZWZpeDogYmFzZVJvdXRlfSk7XG5cbiAgICBhcHAudXNlTWlkZGxld2FyZShyb3V0ZXIsIGFwcC5nZXRNaWRkbGV3YXJlRmFjdG9yeSgnanNvbkVycm9yJykob3B0aW9ucy5lcnJvck9wdGlvbnMsIGFwcCksICdqc29uRXJyb3InKTtcblxuICAgIGlmIChvcHRpb25zLm1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGFwcC51c2VNaWRkbGV3YXJlcyhyb3V0ZXIsIG9wdGlvbnMubWlkZGxld2FyZXMpO1xuICAgIH1cblxuICAgIGxldCByZXNvdXJjZXNQYXRoID0gcGF0aC5qb2luKHJlc291cmNlUGF0aCwgXCIqKlwiLCBcIiouanNcIik7XG4gICAgbGV0IGZpbGVzID0gVXRpbC5nbG9iLnN5bmMocmVzb3VyY2VzUGF0aCwge25vZGlyOiB0cnVlfSk7XG5cbiAgICAvKlxuICAgIGlmIChvcHRpb25zLmJhdGNoUXVlcnkpIHtcbiAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3Bvc3QnLCBvcHRpb25zLmJhdGNoUXVlcnksIGJhdGNoUXVlcnlfKTtcbiAgICB9Ki9cblxuICAgIF8uZWFjaChmaWxlcywgZmlsZSA9PiB7XG4gICAgICAgIGxldCByZWxQYXRoV29lID0gcGF0aC5yZWxhdGl2ZShyZXNvdXJjZVBhdGgsIGZpbGUpLnNsaWNlKDAsIC0zKTsgICAgICAgICAgXG4gICAgICAgIGxldCBiYXNlRW5kcG9pbnQ7XG5cbiAgICAgICAgaWYgKG9wdGlvbnMucmVtYXBzICYmIHJlbFBhdGhXb2UgaW4gb3B0aW9ucy5yZW1hcHMpIHtcbiAgICAgICAgICAgIGJhc2VFbmRwb2ludCA9IFV0aWwuZW5zdXJlTGVmdFNsYXNoKFV0aWwudHJpbVJpZ2h0U2xhc2gob3B0aW9ucy5yZW1hcHNbcmVsUGF0aFdvZV0pKTsgICAgICAgICAgICAgICAgXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBiYXNlRW5kcG9pbnQgPSBVdGlsLmVuc3VyZUxlZnRTbGFzaChyZWxQYXRoV29lLnNwbGl0KHBhdGguc2VwKS5tYXAocCA9PiBfLmtlYmFiQ2FzZShwKSkuam9pbignLycpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gcGF0aC5iYXNlbmFtZShmaWxlLCAnLmpzJyk7XG4gICAgICAgIGxldCBpZE5hbWUgPSBfLmNhbWVsQ2FzZShlbnRpdHlOYW1lKSArICdJZCc7XG4gICAgICAgIGxldCBlbmRwb2ludFdpdGhJZCA9IGFwcGVuZElkKGJhc2VFbmRwb2ludCwgaWROYW1lKTtcbiAgICAgICAgXG4gICAgICAgIGxldCBjb250cm9sbGVyID0gcmVxdWlyZShmaWxlKTtcbiAgICAgICAgbGV0IGlzT2JqID0gZmFsc2U7XG4gICAgXG4gICAgICAgIGlmIChjb250cm9sbGVyLnByb3RvdHlwZSBpbnN0YW5jZW9mIENvbnRyb2xsZXIpIHtcbiAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBuZXcgY29udHJvbGxlcihhcHApO1xuICAgICAgICAgICAgaXNPYmogPSB0cnVlO1xuICAgICAgICB9ICAgICAgICBcblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdmaW5kTWFueV8nKSkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIGdldEJhc2VFbmRwb2ludChiYXNlRW5kcG9pbnQsIG9wdGlvbnMucmVtYXBzLCByZWxQYXRoV29lLCAnZmluZE1hbnknKSwgaXNPYmogPyBjb250cm9sbGVyLmZpbmRNYW55Xy5iaW5kKGNvbnRyb2xsZXIpIDogY29udHJvbGxlci5maW5kTWFueV8pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAnY3JlYXRlXycpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncG9zdCcsIGdldEJhc2VFbmRwb2ludChiYXNlRW5kcG9pbnQsIG9wdGlvbnMucmVtYXBzLCByZWxQYXRoV29lLCAnY3JlYXRlJyksIGlzT2JqID8gY29udHJvbGxlci5jcmVhdGVfLmJpbmQoY29udHJvbGxlcikgOiBjb250cm9sbGVyLmNyZWF0ZV8pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAnZmluZE9uZV8nKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIGdldEJhc2VFbmRwb2ludChlbmRwb2ludFdpdGhJZCwgb3B0aW9ucy5yZW1hcHMsIHJlbFBhdGhXb2UsICdmaW5kT25lJywgaWROYW1lKSwgaXNPYmogPyBjb250cm9sbGVyLmZpbmRPbmVfLmJpbmQoY29udHJvbGxlcikgOiBjb250cm9sbGVyLmZpbmRPbmVfKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ3VwZGF0ZU9uZV8nKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3B1dCcsIGdldEJhc2VFbmRwb2ludChlbmRwb2ludFdpdGhJZCwgb3B0aW9ucy5yZW1hcHMsIHJlbFBhdGhXb2UsICd1cGRhdGVPbmUnLCBpZE5hbWUpLCBpc09iaiA/IGNvbnRyb2xsZXIudXBkYXRlT25lXy5iaW5kKGNvbnRyb2xsZXIpIDogY29udHJvbGxlci51cGRhdGVPbmVfKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ2RlbGV0ZU9uZV8nKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2RlbCcsIGdldEJhc2VFbmRwb2ludChlbmRwb2ludFdpdGhJZCwgb3B0aW9ucy5yZW1hcHMsIHJlbFBhdGhXb2UsICdkZWxldGVPbmUnLCBpZE5hbWUpLCBpc09iaiA/IGNvbnRyb2xsZXIuZGVsZXRlT25lXy5iaW5kKGNvbnRyb2xsZXIpIDogY29udHJvbGxlci5kZWxldGVPbmVfKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgYXBwLmFkZFJvdXRlcihyb3V0ZXIpO1xufTsiXX0=