"use strict";

require("source-map-support/register");

const path = require("path");

const {
  fs
} = require("@genx/sys");

const {
  _,
  text
} = require("@genx/july");

const cachePages = {};
let cacheLayout;
const defaultOpts = {
  cache: false,
  titleHolder: "{{TITLE}}",
  bodyHolder: "{{BODY}}",
  indexName: "index",
  baseUrl: "/"
};

module.exports = function (options, app) {
  if (!(options && options.root)) {
    throw new Error("options.root required");
  }

  _.defaults(options, defaultOpts);

  options.baseUrl = text.ensureEndsWith(text.dropIfStartsWith(options.baseUrl, '/'), '/');
  options.layout = options.layout || path.join(options.root, "layout.html");

  if (typeof options.render !== "function") {
    let md = app.tryRequire("markdown-it")(options.mdOptions);

    options.render = content => md.render(content);
  }

  const defaultLayout = `
<!DOCTYPE html>
<html>
  <head>
    <title>{{TITLE}}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="https://cdn.staticfile.org/twitter-bootstrap/3.0.0-rc1/css/bootstrap.min.css" rel="stylesheet" media="screen">
  </head>
  <body>
    <div class="container">
    {{BODY}}
    </div>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="https://cdn.staticfile.org/jquery/2.0.3/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.0.0-rc1/js/bootstrap.min.js"></script>

    <!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
    <script src="https://cdn.staticfile.org/respond.js/1.2.0/respond.min.js"></script>
  </body>
</html>
`;
  return async (ctx, next) => {
    if (ctx.method !== "GET") {
      return next();
    }

    let pathname = text.dropIfStartsWith(ctx.path, '/');

    if (pathname + "/" === options.baseUrl || pathname === options.baseUrl) {
      pathname = options.baseUrl + options.indexName;
    } else if (!pathname.startsWith(options.baseUrl)) {
      return next();
    }

    pathname = pathname.substr(options.baseUrl.length);
    pathname = path.join(options.root, pathname + ".md");
    let html = await getPage(pathname);

    if (html === null) {
      return next();
    }

    ctx.type = "html";
    ctx.body = html;
  };

  async function getPage(filepath) {
    if (options.cache && filepath in cachePages) {
      return cachePages[filepath];
    }

    let r;

    try {
      r = await Promise.all([getLayout(), getContent(filepath)]);
    } catch (err) {
      if (err.code === "ENOENT") {
        return null;
      }

      throw err;
    }

    let layout = r[0];
    let content = r[1];
    let html = text.replaceAll(layout, options.titleHolder, content.title);
    html = text.replaceAll(html, options.bodyHolder, content.body);

    if (options.cache) {
      cachePages[filepath] = html;
    }

    return html;
  }

  async function getLayout() {
    if (options.cache && cacheLayout) return cacheLayout;
    let layout = (await fs.exists(options.layout)) ? await fs.readFile(options.layout, "utf8") : defaultLayout;
    if (options.cache) cacheLayout = layout;
    return layout;
  }

  async function getContent(filepath) {
    let content = await fs.readFile(filepath, "utf8");
    let title = content.slice(0, content.indexOf("\n")).trim().replace(/^[#\s]+/, "");
    let body = options.render(content);
    return {
      title: title,
      body: body
    };
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlcy9tYXJrZG93bi5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsImZzIiwiXyIsInRleHQiLCJjYWNoZVBhZ2VzIiwiY2FjaGVMYXlvdXQiLCJkZWZhdWx0T3B0cyIsImNhY2hlIiwidGl0bGVIb2xkZXIiLCJib2R5SG9sZGVyIiwiaW5kZXhOYW1lIiwiYmFzZVVybCIsIm1vZHVsZSIsImV4cG9ydHMiLCJvcHRpb25zIiwiYXBwIiwicm9vdCIsImRlZmF1bHRzIiwiZW5zdXJlRW5kc1dpdGgiLCJkcm9wSWZTdGFydHNXaXRoIiwibGF5b3V0Iiwiam9pbiIsInJlbmRlciIsIm1kIiwidHJ5UmVxdWlyZSIsIm1kT3B0aW9ucyIsImNvbnRlbnQiLCJkZWZhdWx0TGF5b3V0IiwiY3R4IiwibmV4dCIsIm1ldGhvZCIsInBhdGhuYW1lIiwic3RhcnRzV2l0aCIsInN1YnN0ciIsImxlbmd0aCIsImh0bWwiLCJnZXRQYWdlIiwidHlwZSIsImJvZHkiLCJmaWxlcGF0aCIsInIiLCJQcm9taXNlIiwiYWxsIiwiZ2V0TGF5b3V0IiwiZ2V0Q29udGVudCIsImVyciIsImNvZGUiLCJyZXBsYWNlQWxsIiwidGl0bGUiLCJleGlzdHMiLCJyZWFkRmlsZSIsInNsaWNlIiwiaW5kZXhPZiIsInRyaW0iLCJyZXBsYWNlIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBU0QsT0FBTyxDQUFDLFdBQUQsQ0FBdEI7O0FBQ0EsTUFBTTtBQUFFRSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBY0gsT0FBTyxDQUFDLFlBQUQsQ0FBM0I7O0FBT0EsTUFBTUksVUFBVSxHQUFHLEVBQW5CO0FBQ0EsSUFBSUMsV0FBSjtBQUVBLE1BQU1DLFdBQVcsR0FBRztBQUNoQkMsRUFBQUEsS0FBSyxFQUFFLEtBRFM7QUFFaEJDLEVBQUFBLFdBQVcsRUFBRSxXQUZHO0FBR2hCQyxFQUFBQSxVQUFVLEVBQUUsVUFISTtBQUloQkMsRUFBQUEsU0FBUyxFQUFFLE9BSks7QUFLaEJDLEVBQUFBLE9BQU8sRUFBRTtBQUxPLENBQXBCOztBQVFBQyxNQUFNLENBQUNDLE9BQVAsR0FBaUIsVUFBVUMsT0FBVixFQUFtQkMsR0FBbkIsRUFBd0I7QUFBQSxRQUM3QkQsT0FBTyxJQUFJQSxPQUFPLENBQUNFLElBRFU7QUFBQSxvQkFDSix1QkFESTtBQUFBOztBQUdyQ2QsRUFBQUEsQ0FBQyxDQUFDZSxRQUFGLENBQVdILE9BQVgsRUFBb0JSLFdBQXBCOztBQUVBUSxFQUFBQSxPQUFPLENBQUNILE9BQVIsR0FBa0JSLElBQUksQ0FBQ2UsY0FBTCxDQUFvQmYsSUFBSSxDQUFDZ0IsZ0JBQUwsQ0FBc0JMLE9BQU8sQ0FBQ0gsT0FBOUIsRUFBdUMsR0FBdkMsQ0FBcEIsRUFBaUUsR0FBakUsQ0FBbEI7QUFDQUcsRUFBQUEsT0FBTyxDQUFDTSxNQUFSLEdBQWlCTixPQUFPLENBQUNNLE1BQVIsSUFBa0JyQixJQUFJLENBQUNzQixJQUFMLENBQVVQLE9BQU8sQ0FBQ0UsSUFBbEIsRUFBd0IsYUFBeEIsQ0FBbkM7O0FBR0EsTUFBSSxPQUFPRixPQUFPLENBQUNRLE1BQWYsS0FBMEIsVUFBOUIsRUFBMEM7QUFDdEMsUUFBSUMsRUFBRSxHQUFHUixHQUFHLENBQUNTLFVBQUosQ0FBZSxhQUFmLEVBQThCVixPQUFPLENBQUNXLFNBQXRDLENBQVQ7O0FBQ0FYLElBQUFBLE9BQU8sQ0FBQ1EsTUFBUixHQUFrQkksT0FBRCxJQUFhSCxFQUFFLENBQUNELE1BQUgsQ0FBVUksT0FBVixDQUE5QjtBQUNIOztBQUVELFFBQU1DLGFBQWEsR0FBSTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztDQUF2QjtBQXdCQSxTQUFPLE9BQU9DLEdBQVAsRUFBWUMsSUFBWixLQUFxQjtBQUN4QixRQUFJRCxHQUFHLENBQUNFLE1BQUosS0FBZSxLQUFuQixFQUEwQjtBQUN0QixhQUFPRCxJQUFJLEVBQVg7QUFDSDs7QUFFRCxRQUFJRSxRQUFRLEdBQUc1QixJQUFJLENBQUNnQixnQkFBTCxDQUFzQlMsR0FBRyxDQUFDN0IsSUFBMUIsRUFBZ0MsR0FBaEMsQ0FBZjs7QUFJQSxRQUFJZ0MsUUFBUSxHQUFHLEdBQVgsS0FBbUJqQixPQUFPLENBQUNILE9BQTNCLElBQXNDb0IsUUFBUSxLQUFLakIsT0FBTyxDQUFDSCxPQUEvRCxFQUF3RTtBQUNwRW9CLE1BQUFBLFFBQVEsR0FBR2pCLE9BQU8sQ0FBQ0gsT0FBUixHQUFrQkcsT0FBTyxDQUFDSixTQUFyQztBQUNILEtBRkQsTUFFTyxJQUFJLENBQUNxQixRQUFRLENBQUNDLFVBQVQsQ0FBb0JsQixPQUFPLENBQUNILE9BQTVCLENBQUwsRUFBMkM7QUFDOUMsYUFBT2tCLElBQUksRUFBWDtBQUNIOztBQUVERSxJQUFBQSxRQUFRLEdBQUdBLFFBQVEsQ0FBQ0UsTUFBVCxDQUFnQm5CLE9BQU8sQ0FBQ0gsT0FBUixDQUFnQnVCLE1BQWhDLENBQVg7QUFDQUgsSUFBQUEsUUFBUSxHQUFHaEMsSUFBSSxDQUFDc0IsSUFBTCxDQUFVUCxPQUFPLENBQUNFLElBQWxCLEVBQXdCZSxRQUFRLEdBQUcsS0FBbkMsQ0FBWDtBQUdBLFFBQUlJLElBQUksR0FBRyxNQUFNQyxPQUFPLENBQUNMLFFBQUQsQ0FBeEI7O0FBQ0EsUUFBSUksSUFBSSxLQUFLLElBQWIsRUFBbUI7QUFDZixhQUFPTixJQUFJLEVBQVg7QUFDSDs7QUFDREQsSUFBQUEsR0FBRyxDQUFDUyxJQUFKLEdBQVcsTUFBWDtBQUNBVCxJQUFBQSxHQUFHLENBQUNVLElBQUosR0FBV0gsSUFBWDtBQUNILEdBekJEOztBQTJCQSxpQkFBZUMsT0FBZixDQUF1QkcsUUFBdkIsRUFBaUM7QUFDN0IsUUFBSXpCLE9BQU8sQ0FBQ1AsS0FBUixJQUFpQmdDLFFBQVEsSUFBSW5DLFVBQWpDLEVBQTZDO0FBQ3pDLGFBQU9BLFVBQVUsQ0FBQ21DLFFBQUQsQ0FBakI7QUFDSDs7QUFDRCxRQUFJQyxDQUFKOztBQUNBLFFBQUk7QUFDQUEsTUFBQUEsQ0FBQyxHQUFHLE1BQU1DLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLENBQUNDLFNBQVMsRUFBVixFQUFjQyxVQUFVLENBQUNMLFFBQUQsQ0FBeEIsQ0FBWixDQUFWO0FBQ0gsS0FGRCxDQUVFLE9BQU9NLEdBQVAsRUFBWTtBQUNWLFVBQUlBLEdBQUcsQ0FBQ0MsSUFBSixLQUFhLFFBQWpCLEVBQTJCO0FBQ3ZCLGVBQU8sSUFBUDtBQUNIOztBQUNELFlBQU1ELEdBQU47QUFDSDs7QUFFRCxRQUFJekIsTUFBTSxHQUFHb0IsQ0FBQyxDQUFDLENBQUQsQ0FBZDtBQUNBLFFBQUlkLE9BQU8sR0FBR2MsQ0FBQyxDQUFDLENBQUQsQ0FBZjtBQUNBLFFBQUlMLElBQUksR0FBR2hDLElBQUksQ0FBQzRDLFVBQUwsQ0FBZ0IzQixNQUFoQixFQUF3Qk4sT0FBTyxDQUFDTixXQUFoQyxFQUE2Q2tCLE9BQU8sQ0FBQ3NCLEtBQXJELENBQVg7QUFDQWIsSUFBQUEsSUFBSSxHQUFHaEMsSUFBSSxDQUFDNEMsVUFBTCxDQUFnQlosSUFBaEIsRUFBc0JyQixPQUFPLENBQUNMLFVBQTlCLEVBQTBDaUIsT0FBTyxDQUFDWSxJQUFsRCxDQUFQOztBQUVBLFFBQUl4QixPQUFPLENBQUNQLEtBQVosRUFBbUI7QUFDZkgsTUFBQUEsVUFBVSxDQUFDbUMsUUFBRCxDQUFWLEdBQXVCSixJQUF2QjtBQUNIOztBQUNELFdBQU9BLElBQVA7QUFDSDs7QUFFRCxpQkFBZVEsU0FBZixHQUEyQjtBQUN2QixRQUFJN0IsT0FBTyxDQUFDUCxLQUFSLElBQWlCRixXQUFyQixFQUFrQyxPQUFPQSxXQUFQO0FBQ2xDLFFBQUllLE1BQU0sR0FBRyxDQUFDLE1BQU1uQixFQUFFLENBQUNnRCxNQUFILENBQVVuQyxPQUFPLENBQUNNLE1BQWxCLENBQVAsSUFBb0MsTUFBTW5CLEVBQUUsQ0FBQ2lELFFBQUgsQ0FBWXBDLE9BQU8sQ0FBQ00sTUFBcEIsRUFBNEIsTUFBNUIsQ0FBMUMsR0FBZ0ZPLGFBQTdGO0FBQ0EsUUFBSWIsT0FBTyxDQUFDUCxLQUFaLEVBQW1CRixXQUFXLEdBQUdlLE1BQWQ7QUFDbkIsV0FBT0EsTUFBUDtBQUNIOztBQUVELGlCQUFld0IsVUFBZixDQUEwQkwsUUFBMUIsRUFBb0M7QUFDaEMsUUFBSWIsT0FBTyxHQUFHLE1BQU16QixFQUFFLENBQUNpRCxRQUFILENBQVlYLFFBQVosRUFBc0IsTUFBdEIsQ0FBcEI7QUFDQSxRQUFJUyxLQUFLLEdBQUd0QixPQUFPLENBQ2R5QixLQURPLENBQ0QsQ0FEQyxFQUNFekIsT0FBTyxDQUFDMEIsT0FBUixDQUFnQixJQUFoQixDQURGLEVBRVBDLElBRk8sR0FHUEMsT0FITyxDQUdDLFNBSEQsRUFHWSxFQUhaLENBQVo7QUFJQSxRQUFJaEIsSUFBSSxHQUFHeEIsT0FBTyxDQUFDUSxNQUFSLENBQWVJLE9BQWYsQ0FBWDtBQUNBLFdBQU87QUFDSHNCLE1BQUFBLEtBQUssRUFBRUEsS0FESjtBQUVIVixNQUFBQSxJQUFJLEVBQUVBO0FBRkgsS0FBUDtBQUlIO0FBQ0osQ0E3R0QiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XG5jb25zdCB7IGZzIH0gPSByZXF1aXJlKFwiQGdlbngvc3lzXCIpO1xuY29uc3QgeyBfLCB0ZXh0IH0gPSByZXF1aXJlKFwiQGdlbngvanVseVwiKTtcblxuLyoqXG4gKiBNYXJrZG93biBtaWRkbGV3YXJlLlxuICogQG1vZHVsZSBNaWRkbGV3YXJlX01hcmtkb3duXG4gKi9cblxuY29uc3QgY2FjaGVQYWdlcyA9IHt9O1xubGV0IGNhY2hlTGF5b3V0O1xuXG5jb25zdCBkZWZhdWx0T3B0cyA9IHtcbiAgICBjYWNoZTogZmFsc2UsXG4gICAgdGl0bGVIb2xkZXI6IFwie3tUSVRMRX19XCIsXG4gICAgYm9keUhvbGRlcjogXCJ7e0JPRFl9fVwiLFxuICAgIGluZGV4TmFtZTogXCJpbmRleFwiLFxuICAgIGJhc2VVcmw6IFwiL1wiLFxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAob3B0aW9ucywgYXBwKSB7XG4gICAgYXNzZXJ0OiBvcHRpb25zICYmIG9wdGlvbnMucm9vdCwgXCJvcHRpb25zLnJvb3QgcmVxdWlyZWRcIjtcblxuICAgIF8uZGVmYXVsdHMob3B0aW9ucywgZGVmYXVsdE9wdHMpO1xuXG4gICAgb3B0aW9ucy5iYXNlVXJsID0gdGV4dC5lbnN1cmVFbmRzV2l0aCh0ZXh0LmRyb3BJZlN0YXJ0c1dpdGgob3B0aW9ucy5iYXNlVXJsLCAnLycpLCAnLycpO1xuICAgIG9wdGlvbnMubGF5b3V0ID0gb3B0aW9ucy5sYXlvdXQgfHwgcGF0aC5qb2luKG9wdGlvbnMucm9vdCwgXCJsYXlvdXQuaHRtbFwiKTtcblxuICAgIC8vIHN1cHBvcnQgY3VzdG9tIG1hcmtkb3duIHJlbmRlclxuICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5yZW5kZXIgIT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBsZXQgbWQgPSBhcHAudHJ5UmVxdWlyZShcIm1hcmtkb3duLWl0XCIpKG9wdGlvbnMubWRPcHRpb25zKTtcbiAgICAgICAgb3B0aW9ucy5yZW5kZXIgPSAoY29udGVudCkgPT4gbWQucmVuZGVyKGNvbnRlbnQpO1xuICAgIH1cblxuICAgIGNvbnN0IGRlZmF1bHRMYXlvdXQgPSBgXG48IURPQ1RZUEUgaHRtbD5cbjxodG1sPlxuICA8aGVhZD5cbiAgICA8dGl0bGU+e3tUSVRMRX19PC90aXRsZT5cbiAgICA8bWV0YSBuYW1lPVwidmlld3BvcnRcIiBjb250ZW50PVwid2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMFwiPlxuICAgIDwhLS0gQm9vdHN0cmFwIC0tPlxuICAgIDxsaW5rIGhyZWY9XCJodHRwczovL2Nkbi5zdGF0aWNmaWxlLm9yZy90d2l0dGVyLWJvb3RzdHJhcC8zLjAuMC1yYzEvY3NzL2Jvb3RzdHJhcC5taW4uY3NzXCIgcmVsPVwic3R5bGVzaGVldFwiIG1lZGlhPVwic2NyZWVuXCI+XG4gIDwvaGVhZD5cbiAgPGJvZHk+XG4gICAgPGRpdiBjbGFzcz1cImNvbnRhaW5lclwiPlxuICAgIHt7Qk9EWX19XG4gICAgPC9kaXY+XG4gICAgPCEtLSBKYXZhU2NyaXB0IHBsdWdpbnMgKHJlcXVpcmVzIGpRdWVyeSkgLS0+XG4gICAgPHNjcmlwdCBzcmM9XCJodHRwczovL2Nkbi5zdGF0aWNmaWxlLm9yZy9qcXVlcnkvMi4wLjMvanF1ZXJ5Lm1pbi5qc1wiPjwvc2NyaXB0PlxuICAgIDwhLS0gSW5jbHVkZSBhbGwgY29tcGlsZWQgcGx1Z2lucyAoYmVsb3cpLCBvciBpbmNsdWRlIGluZGl2aWR1YWwgZmlsZXMgYXMgbmVlZGVkIC0tPlxuICAgIDxzY3JpcHQgc3JjPVwiaHR0cHM6Ly9jZG4uc3RhdGljZmlsZS5vcmcvdHdpdHRlci1ib290c3RyYXAvMy4wLjAtcmMxL2pzL2Jvb3RzdHJhcC5taW4uanNcIj48L3NjcmlwdD5cblxuICAgIDwhLS0gRW5hYmxlIHJlc3BvbnNpdmUgZmVhdHVyZXMgaW4gSUU4IHdpdGggUmVzcG9uZC5qcyAoaHR0cHM6Ly9naXRodWIuY29tL3Njb3R0amVobC9SZXNwb25kKSAtLT5cbiAgICA8c2NyaXB0IHNyYz1cImh0dHBzOi8vY2RuLnN0YXRpY2ZpbGUub3JnL3Jlc3BvbmQuanMvMS4yLjAvcmVzcG9uZC5taW4uanNcIj48L3NjcmlwdD5cbiAgPC9ib2R5PlxuPC9odG1sPlxuYDtcblxuICAgIHJldHVybiBhc3luYyAoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgIGlmIChjdHgubWV0aG9kICE9PSBcIkdFVFwiKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHBhdGhuYW1lID0gdGV4dC5kcm9wSWZTdGFydHNXaXRoKGN0eC5wYXRoLCAnLycpO1xuICAgICAgICAvLyBnZXQgbWQgZmlsZSBwYXRoXG5cbiAgICAgICAgLy8gaW5kZXggZmlsZVxuICAgICAgICBpZiAocGF0aG5hbWUgKyBcIi9cIiA9PT0gb3B0aW9ucy5iYXNlVXJsIHx8IHBhdGhuYW1lID09PSBvcHRpb25zLmJhc2VVcmwpIHtcbiAgICAgICAgICAgIHBhdGhuYW1lID0gb3B0aW9ucy5iYXNlVXJsICsgb3B0aW9ucy5pbmRleE5hbWU7XG4gICAgICAgIH0gZWxzZSBpZiAoIXBhdGhuYW1lLnN0YXJ0c1dpdGgob3B0aW9ucy5iYXNlVXJsKSkge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHBhdGhuYW1lID0gcGF0aG5hbWUuc3Vic3RyKG9wdGlvbnMuYmFzZVVybC5sZW5ndGgpO1xuICAgICAgICBwYXRobmFtZSA9IHBhdGguam9pbihvcHRpb25zLnJvb3QsIHBhdGhuYW1lICsgXCIubWRcIik7XG5cbiAgICAgICAgLy8gZ2VuZXJhdGUgaHRtbFxuICAgICAgICBsZXQgaHRtbCA9IGF3YWl0IGdldFBhZ2UocGF0aG5hbWUpO1xuICAgICAgICBpZiAoaHRtbCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgfVxuICAgICAgICBjdHgudHlwZSA9IFwiaHRtbFwiO1xuICAgICAgICBjdHguYm9keSA9IGh0bWw7XG4gICAgfTtcblxuICAgIGFzeW5jIGZ1bmN0aW9uIGdldFBhZ2UoZmlsZXBhdGgpIHtcbiAgICAgICAgaWYgKG9wdGlvbnMuY2FjaGUgJiYgZmlsZXBhdGggaW4gY2FjaGVQYWdlcykge1xuICAgICAgICAgICAgcmV0dXJuIGNhY2hlUGFnZXNbZmlsZXBhdGhdO1xuICAgICAgICB9XG4gICAgICAgIGxldCByO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgciA9IGF3YWl0IFByb21pc2UuYWxsKFtnZXRMYXlvdXQoKSwgZ2V0Q29udGVudChmaWxlcGF0aCldKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBpZiAoZXJyLmNvZGUgPT09IFwiRU5PRU5UXCIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBsYXlvdXQgPSByWzBdO1xuICAgICAgICBsZXQgY29udGVudCA9IHJbMV07XG4gICAgICAgIGxldCBodG1sID0gdGV4dC5yZXBsYWNlQWxsKGxheW91dCwgb3B0aW9ucy50aXRsZUhvbGRlciwgY29udGVudC50aXRsZSk7XG4gICAgICAgIGh0bWwgPSB0ZXh0LnJlcGxhY2VBbGwoaHRtbCwgb3B0aW9ucy5ib2R5SG9sZGVyLCBjb250ZW50LmJvZHkpO1xuXG4gICAgICAgIGlmIChvcHRpb25zLmNhY2hlKSB7XG4gICAgICAgICAgICBjYWNoZVBhZ2VzW2ZpbGVwYXRoXSA9IGh0bWw7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGh0bWw7XG4gICAgfVxuXG4gICAgYXN5bmMgZnVuY3Rpb24gZ2V0TGF5b3V0KCkge1xuICAgICAgICBpZiAob3B0aW9ucy5jYWNoZSAmJiBjYWNoZUxheW91dCkgcmV0dXJuIGNhY2hlTGF5b3V0O1xuICAgICAgICBsZXQgbGF5b3V0ID0gKGF3YWl0IGZzLmV4aXN0cyhvcHRpb25zLmxheW91dCkpID8gYXdhaXQgZnMucmVhZEZpbGUob3B0aW9ucy5sYXlvdXQsIFwidXRmOFwiKSA6IGRlZmF1bHRMYXlvdXQ7XG4gICAgICAgIGlmIChvcHRpb25zLmNhY2hlKSBjYWNoZUxheW91dCA9IGxheW91dDtcbiAgICAgICAgcmV0dXJuIGxheW91dDtcbiAgICB9XG5cbiAgICBhc3luYyBmdW5jdGlvbiBnZXRDb250ZW50KGZpbGVwYXRoKSB7XG4gICAgICAgIGxldCBjb250ZW50ID0gYXdhaXQgZnMucmVhZEZpbGUoZmlsZXBhdGgsIFwidXRmOFwiKTtcbiAgICAgICAgbGV0IHRpdGxlID0gY29udGVudFxuICAgICAgICAgICAgLnNsaWNlKDAsIGNvbnRlbnQuaW5kZXhPZihcIlxcblwiKSlcbiAgICAgICAgICAgIC50cmltKClcbiAgICAgICAgICAgIC5yZXBsYWNlKC9eWyNcXHNdKy8sIFwiXCIpO1xuICAgICAgICBsZXQgYm9keSA9IG9wdGlvbnMucmVuZGVyKGNvbnRlbnQpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGl0bGU6IHRpdGxlLFxuICAgICAgICAgICAgYm9keTogYm9keSxcbiAgICAgICAgfTtcbiAgICB9XG59O1xuIl19