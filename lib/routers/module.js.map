{"version":3,"file":"module.js","names":["require","path","_","url","urlUtil","text","Literal","Router","InvalidConfiguration","module","exports","app","baseRoute","moduleItem","controllerPath","join","backendPath","CONTROLLERS_PATH","controller","currentPrefix","route","router","prefix","dropIfEndsWith","middlewares","useMiddlewares","controllers","castArray","forEach","moduleController","controllerFile","isController","actionName","action","__metaHttpMethod","method","subRoute","ensureStartsWith","__metaRoute","kebabCase","bindAction","bind","ALLOWED_HTTP_METHODS","has","addRoute","__metaMiddlewares","concat","addRouter"],"sources":["../../src/routers/module.js"],"sourcesContent":["\"use strict\";\n\nconst path = require(\"path\");\nconst { _, url: urlUtil, text } = require(\"@genx/july\");\nconst Literal = require(\"../enum/Literal\");\nconst Router = require(\"@koa/router\");\nconst { InvalidConfiguration } = require(\"@genx/error\");\n\n/**\n * Module router for mounting a specific controller.\n * @module Router_Module\n */\n\n/**\n * Create a module-based router.\n * @param {Routable} app\n * @param {string} baseRoute\n * @param {*} moduleItem\n * @example\n *   '<base path>': {\n *       module: {\n *           middlewares:\n *           controller:\n *       }\n *   }\n *\n *   '<base path>': {\n *       module: \"controller\"\n *   }\n */\nmodule.exports = function (app, baseRoute, moduleItem) {\n    let controllerPath = path.join(app.backendPath, Literal.CONTROLLERS_PATH);\n\n    if (typeof moduleItem === \"string\") {\n        // [ 'controllerName' ]\n        moduleItem = {\n            controller: moduleItem,\n        };\n    }\n\n    let currentPrefix = urlUtil.join(baseRoute, moduleItem.route || \"/\");\n    let router = currentPrefix === \"/\" ? new Router() : new Router({ prefix: text.dropIfEndsWith(currentPrefix, \"/\") });\n\n    if (moduleItem.middlewares) {\n        //module-wide middlewares\n        app.useMiddlewares(router, moduleItem.middlewares);\n    }\n\n    const controllers = _.castArray(moduleItem.controller);\n\n    controllers.forEach((moduleController) => {\n        let controllerFile = path.join(controllerPath, moduleController + \".js\");\n        let controller;\n\n        controller = require(controllerFile);\n        let isController = false;\n\n        if (typeof controller === \"function\") {\n            controller = new controller(app);\n            isController = true;\n        }\n\n        for (let actionName in controller) {\n            let action = controller[actionName];\n            if (typeof action !== \"function\" || !action.__metaHttpMethod) continue; // only marked httpMethod should be mounted\n\n            const method = action.__metaHttpMethod;\n            let subRoute = text.ensureStartsWith(action.__metaRoute || _.kebabCase(actionName), \"/\");\n\n            let bindAction;\n\n            if (isController) {\n                bindAction = action.bind(controller);\n            } else {\n                bindAction = action;\n            }\n\n            if (!Literal.ALLOWED_HTTP_METHODS.has(method)) {\n                throw new InvalidConfiguration(\n                    \"Unsupported http method: \" + method,\n                    app,\n                    `routing.${baseRoute}.modules ${moduleItem.controller}.${actionName}`\n                );\n            }\n\n            app.addRoute(\n                router,\n                method,\n                subRoute,\n                action.__metaMiddlewares ? action.__metaMiddlewares.concat([bindAction]) : bindAction\n            );\n        }\n    });\n\n    app.addRouter(router);\n};\n"],"mappings":"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"}