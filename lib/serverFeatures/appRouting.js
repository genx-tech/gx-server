"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  eachAsync_
} = require('@genx/july');

const {
  fs
} = require('@genx/sys');

const {
  InvalidConfiguration
} = require('@genx/error');

const WebModule = require('../WebModule');

const Feature = require('@genx/app/lib/enum/Feature');

module.exports = {
  type: Feature.PLUGIN,
  load_: async (server, routes) => eachAsync_(routes, async (config, baseRoute) => {
    if (!config.name) {
      throw new InvalidConfiguration('Missing app name.', app, `appRouting.${baseRoute}.name`);
    }

    let options = Object.assign({
      env: server.env,
      logWithAppName: server.options.logWithAppName,
      traceMiddlewares: server.options.traceMiddlewares
    }, config.options);
    let appPath;

    if (config.npmModule) {
      appPath = server.toAbsolutePath('node_modules', config.name);
    } else {
      appPath = path.join(server.appModulesPath, config.name);
    }

    let exists = (await fs.pathExists(appPath)) && (await fs.stat(appPath)).isDirectory();

    if (!exists) {
      throw new InvalidConfiguration(`App [${config.name}] not exists.`, server, `appRouting.${baseRoute}.name`);
    }

    let app = new WebModule(server, config.name, baseRoute, appPath, options);
    app.now = server.now;
    app.__ = server.__;
    app.on('configLoaded', () => {
      if (!_.isEmpty(config.settings)) {
        app.config.settings = Object.assign({}, app.config.settings, config.settings);
        server.log('verbose', `App settings of [${app.name}] is overrided.`);
      }

      if (!_.isEmpty(config.middlewares)) {
        let middlewaresToAppend = app.config.middlewares;
        app.config.middlewares = Object.assign({}, config.middlewares);

        _.defaults(app.config.middlewares, middlewaresToAppend);
      }
    });
    let relativePath = path.relative(server.workingPath, appPath);
    server.log('verbose', `Loading app [${app.name}] from "${relativePath}" ...`);
    await app.start_();
    server.log('verbose', `App [${app.name}] is loaded.`);
    server.on('before:' + Feature.READY, () => {
      server.mountApp(app);
    });
  })
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXJGZWF0dXJlcy9hcHBSb3V0aW5nLmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwiXyIsImVhY2hBc3luY18iLCJmcyIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiV2ViTW9kdWxlIiwiRmVhdHVyZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0eXBlIiwiUExVR0lOIiwibG9hZF8iLCJzZXJ2ZXIiLCJyb3V0ZXMiLCJjb25maWciLCJiYXNlUm91dGUiLCJuYW1lIiwiYXBwIiwib3B0aW9ucyIsIk9iamVjdCIsImFzc2lnbiIsImVudiIsImxvZ1dpdGhBcHBOYW1lIiwidHJhY2VNaWRkbGV3YXJlcyIsImFwcFBhdGgiLCJucG1Nb2R1bGUiLCJ0b0Fic29sdXRlUGF0aCIsImpvaW4iLCJhcHBNb2R1bGVzUGF0aCIsImV4aXN0cyIsInBhdGhFeGlzdHMiLCJzdGF0IiwiaXNEaXJlY3RvcnkiLCJub3ciLCJfXyIsIm9uIiwiaXNFbXB0eSIsInNldHRpbmdzIiwibG9nIiwibWlkZGxld2FyZXMiLCJtaWRkbGV3YXJlc1RvQXBwZW5kIiwiZGVmYXVsdHMiLCJyZWxhdGl2ZVBhdGgiLCJyZWxhdGl2ZSIsIndvcmtpbmdQYXRoIiwic3RhcnRfIiwiUkVBRFkiLCJtb3VudEFwcCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFzQkEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFvQkYsT0FBTyxDQUFDLFlBQUQsQ0FBakM7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQTtBQUFGLElBQVNILE9BQU8sQ0FBQyxXQUFELENBQXRCOztBQUNBLE1BQU07QUFBRUksRUFBQUE7QUFBRixJQUEyQkosT0FBTyxDQUFDLGFBQUQsQ0FBeEM7O0FBQ0EsTUFBTUssU0FBUyxHQUFHTCxPQUFPLENBQUMsY0FBRCxDQUF6Qjs7QUFDQSxNQUFNTSxPQUFPLEdB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ZCxFQUFrQk4sTUFBTSxDQUFDeUIsV0FBekIsQ0FBekI7O0FBQ0F0QyxRQUFBQSxDQUFDLENBQUN3QyxRQUFGLENBQVd4QixHQUFHLENBQUNILE1BQUosQ0FBV3lCLFdBQXRCLEVBQW1DQyxtQkFBbkM7QUFDSDtBQUNKLEtBWEQ7QUFhQSxRQUFJRSxZQUFZLEdBQUczQyxJQUFJLENBQUM0QyxRQUFMLENBQWMvQixNQUFNLENBQUNnQyxXQUFyQixFQUFrQ3BCLE9BQWxDLENBQW5CO0FBQ0FaLElBQUFBLE1BQU0sQ0FBQzBCLEdBQVAsQ0FBVyxTQUFYLEVBQXVCLGdCQUFlckIsR0FBRyxDQUFDRCxJQUFLLFdBQVUwQixZQUFhLE9BQXRFO0FBRUEsVUFBTXpCLEdBQUcsQ0FBQzRCLE1BQUosRUFBTjtBQUVBakMsSUFBQUEsTUFBTSxDQUFDMEIsR0FBUCxDQUFXLFNBQVgsRUFBdUIsUUFBT3JCLEdBQUcsQ0FBQ0QsSUFBSyxjQUF2QztBQUdBSixJQUFBQSxNQUFNLENBQUN1QixFQUFQLENBQVUsWUFBWTdCLE9BQU8sQ0FBQ3dDLEtBQTlCLEVBQXFDLE1BQU07QUFDdkNsQyxNQUFBQSxNQUFNLENBQUNtQyxRQUFQLENBQWdCOUIsR0FBaEI7QUFDSCxLQUZEO0FBR0gsR0ExRDBDO0FBZDlCLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbi8qKlxuICogRW5hYmxlIHJvdXRpbmcgd2ViIHJlcXVlc3RzIHRvIGEgY2hpbGQgYXBwLlxuICogQG1vZHVsZSBGZWF0dXJlX0FwcFJvdXRpbmdcbiAqIFxuICogQGV4YW1wbGVcbiAqICBcbiAqICAnYXBwUm91dGluZyc6IHtcbiAqICAgICAgJzxtb3VudGluZyBwb2ludD4nOiB7XG4gKiAgICAgICAgICBuYW1lOiAnYXBwIG5hbWUnLCBcbiAqICAgICAgICAgIG5wbU1vZHVsZTogZmFsc2UsIC8vIHdoZXRoZXIgaXMgYSBucG0gbW9kdWxlXG4gKiAgICAgICAgICBvcHRpb25zOiB7IC8vIG1vZHVsZSBvcHRpb25zIFxuICogICAgICAgICAgfSxcbiAqICAgICAgICAgIHNldHRpbmdzOiB7IC8vIGNhbiBvdmVycmlkZSBtb2R1bGUgZGVmaW5lZCBzZXR0aW5nc1xuICogICAgICAgICAgfSxcbiAqICAgICAgICAgIG1pZGRsZXdhcmVzOiB7IC8vIGNhbiBvdmVycmlkZSBtaWRkbGV3YXJlcyBcbiAqICAgICAgICAgIH1cbiAqICAgICAgfVxuICogIH0gXG4gKi9cblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgZWFjaEFzeW5jXyB9ID0gcmVxdWlyZSgnQGdlbngvanVseScpO1xuY29uc3QgeyBmcyB9ID0gcmVxdWlyZSgnQGdlbngvc3lzJyk7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uIH0gPSByZXF1aXJlKCdAZ2VueC9lcnJvcicpO1xuY29uc3QgV2ViTW9kdWxlID0gcmVxdWlyZSgnLi4vV2ViTW9kdWxlJyk7XG5jb25zdCBGZWF0dXJlID0gcmVxdWlyZSgnQGdlbngvYXBwL2xpYi9lbnVtL0ZlYXR1cmUnKTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IHBsdWdpbiBzdGFnZS5cbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5QTFVHSU4sXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIHRoZSBmZWF0dXJlLlxuICAgICAqIEBwYXJhbSB7V2ViU2VydmVyfSBzZXJ2ZXIgLSBUaGUgd2ViIHNlcnZlciBtb2R1bGUgb2JqZWN0LlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByb3V0ZXMgLSBSb3V0ZXMgYW5kIGNvbmZpZ3VyYXRpb24uXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPCo+fVxuICAgICAqL1xuICAgIGxvYWRfOiBhc3luYyAoc2VydmVyLCByb3V0ZXMpID0+IGVhY2hBc3luY18ocm91dGVzLCBhc3luYyAoY29uZmlnLCBiYXNlUm91dGUpID0+IHtcbiAgICAgICAgaWYgKCFjb25maWcubmFtZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICdNaXNzaW5nIGFwcCBuYW1lLicsXG4gICAgICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgICAgIGBhcHBSb3V0aW5nLiR7YmFzZVJvdXRlfS5uYW1lYCk7XG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgbGV0IG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHsgXG4gICAgICAgICAgICBlbnY6IHNlcnZlci5lbnYsIFxuICAgICAgICAgICAgbG9nV2l0aEFwcE5hbWU6IHNlcnZlci5vcHRpb25zLmxvZ1dpdGhBcHBOYW1lLFxuICAgICAgICAgICAgdHJhY2VNaWRkbGV3YXJlczogc2VydmVyLm9wdGlvbnMudHJhY2VNaWRkbGV3YXJlc1xuICAgICAgICB9LCBjb25maWcub3B0aW9ucyk7XG5cbiAgICAgICAgbGV0IGFwcFBhdGg7ICAgICBcblxuICAgICAgICBpZiAoY29uZmlnLm5wbU1vZHVsZSkge1xuICAgICAgICAgICAgYXBwUGF0aCA9IHNlcnZlci50b0Fic29sdXRlUGF0aCgnbm9kZV9tb2R1bGVzJywgY29uZmlnLm5hbWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYXBwUGF0aCA9IHBhdGguam9pbihzZXJ2ZXIuYXBwTW9kdWxlc1BhdGgsIGNvbmZpZy5uYW1lKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBleGlzdHMgPSBhd2FpdCBmcy5wYXRoRXhpc3RzKGFwcFBhdGgpICYmIChhd2FpdCBmcy5zdGF0KGFwcFBhdGgpKS5pc0RpcmVjdG9yeSgpO1xuICAgICAgICBpZiAoIWV4aXN0cykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgIGBBcHAgWyR7Y29uZmlnLm5hbWV9XSBub3QgZXhpc3RzLmAsXG4gICAgICAgICAgICAgICAgc2VydmVyLFxuICAgICAgICAgICAgICAgIGBhcHBSb3V0aW5nLiR7YmFzZVJvdXRlfS5uYW1lYCk7XG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgbGV0IGFwcCA9IG5ldyBXZWJNb2R1bGUoc2VydmVyLCBjb25maWcubmFtZSwgYmFzZVJvdXRlLCBhcHBQYXRoLCBvcHRpb25zKTtcbiAgICAgICAgYXBwLm5vdyA9IHNlcnZlci5ub3c7XG4gICAgICAgIGFwcC5fXyA9IHNlcnZlci5fXztcbiAgICAgICAgXG4gICAgICAgIGFwcC5vbignY29uZmlnTG9hZGVkJywgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoY29uZmlnLnNldHRpbmdzKSkge1xuICAgICAgICAgICAgICAgIGFwcC5jb25maWcuc2V0dGluZ3MgPSBPYmplY3QuYXNzaWduKHt9LCBhcHAuY29uZmlnLnNldHRpbmdzLCBjb25maWcuc2V0dGluZ3MpO1xuICAgICAgICAgICAgICAgIHNlcnZlci5sb2coJ3ZlcmJvc2UnLCBgQXBwIHNldHRpbmdzIG9mIFske2FwcC5uYW1lfV0gaXMgb3ZlcnJpZGVkLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShjb25maWcubWlkZGxld2FyZXMpKSB7XG4gICAgICAgICAgICAgICAgbGV0IG1pZGRsZXdhcmVzVG9BcHBlbmQgPSBhcHAuY29uZmlnLm1pZGRsZXdhcmVzO1xuICAgICAgICAgICAgICAgIGFwcC5jb25maWcubWlkZGxld2FyZXMgPSBPYmplY3QuYXNzaWduKHt9LCBjb25maWcubWlkZGxld2FyZXMpO1xuICAgICAgICAgICAgICAgIF8uZGVmYXVsdHMoYXBwLmNvbmZpZy5taWRkbGV3YXJlcywgbWlkZGxld2FyZXNUb0FwcGVuZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCByZWxhdGl2ZVBhdGggPSBwYXRoLnJlbGF0aXZlKHNlcnZlci53b3JraW5nUGF0aCwgYXBwUGF0aCk7XG4gICAgICAgIHNlcnZlci5sb2coJ3ZlcmJvc2UnLCBgTG9hZGluZyBhcHAgWyR7YXBwLm5hbWV9XSBmcm9tIFwiJHtyZWxhdGl2ZVBhdGh9XCIgLi4uYCk7XG4gICAgXG4gICAgICAgIGF3YWl0IGFwcC5zdGFydF8oKTtcbiAgICAgICAgXG4gICAgICAgIHNlcnZlci5sb2coJ3ZlcmJvc2UnLCBgQXBwIFske2FwcC5uYW1lfV0gaXMgbG9hZGVkLmApO1xuXG4gICAgICAgIC8vZGVsYXllZCB0aGUgYXBwIHJvdXRlcyBtb3VudGluZyBhZnRlciBhbGwgcGx1Z2lucyBvZiB0aGUgc2VydmVyIGFyZSBsb2FkZWRcbiAgICAgICAgc2VydmVyLm9uKCdiZWZvcmU6JyArIEZlYXR1cmUuUkVBRFksICgpID0+IHtcbiAgICAgICAgICAgIHNlcnZlci5tb3VudEFwcChhcHApO1xuICAgICAgICB9KTsgICAgICAgIFxuICAgIH0pXG59OyJdfQ==