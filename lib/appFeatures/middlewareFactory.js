"use strict";

require("source-map-support/register");

const {
  _
} = require('@genx/july');

const {
  Feature
} = require('..').Enums;

const {
  InvalidConfiguration
} = require('@genx/error');

module.exports = {
  type: Feature.INIT,
  load_: (app, factories) => {
    _.forOwn(factories, (factoryInfo, name) => {
      app.registerMiddlewareFactory(name, (opt, ownerApp) => {
        if (!_.isEmpty(opt)) {
          throw new Error(`Pre-configured middleware factory "${name}" should be used with empty options.`);
        }

        let chains;

        if (_.isPlainObject(factoryInfo)) {
          chains = [];

          _.forOwn(factoryInfo, (options, middleware) => {
            chains.push(app.getMiddlewareFactory(middleware)(options, ownerApp));
          });
        } else if (Array.isArray(factoryInfo)) {
          chains = factoryInfo.map((middlewareInfo, i) => {
            if (_.isPlainObject(middlewareInfo)) {
              if (!middlewareInfo.name) {
                throw new InvalidConfiguration('Missing referenced middleware name.', app, `middlewareFactory.${name}[${i}].name`);
              }

              return app.getMiddlewareFactory(middlewareInfo.name)(middlewareInfo.options, ownerApp);
            }

            if (Array.isArray(middlewareInfo)) {
              if (middlewareInfo.length < 1 || middlewareInfo.length > 2 || typeof middlewareInfo[0] !== 'string') {
                throw new InvalidConfiguration('Invalid middleware factory item config.', app, `middlewareFactory.${name}[${i}]`);
              }

              return app.getMiddlewareFactory(middlewareInfo[0])(middlewareInfo.length > 1 ? middlewareInfo[1] : undefined, ownerApp);
            }

            if (typeof middlewareInfo === 'string') {
              return app.getMiddlewareFactory(middlewareInfo)(undefined, ownerApp);
            }

            throw new InvalidConfiguration('Invalid middleware factory item config.', app, `middlewareFactory.${name}[${i}]`);
          });
        } else {
          throw new InvalidConfiguration('Invalid middleware factory config.', app, `middlewareFactory.${name}`);
        }

        return chains.length === 1 ? chains[0] : chains;
      });
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcHBGZWF0dXJlcy9taWRkbGV3YXJlRmFjdG9yeS5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsIkZlYXR1cmUiLCJFbnVtcyIsIkludmFsaWRDb25maWd1cmF0aW9uIiwibW9kdWxlIiwiZXhwb3J0cyIsInR5cGUiLCJJTklUIiwibG9hZF8iLCJhcHAiLCJmYWN0b3JpZXMiLCJmb3JPd24iLCJmYWN0b3J5SW5mbyIsIm5hbWUiLCJyZWdpc3Rlck1pZGRsZXdhcmVGYWN0b3J5Iiwib3B0Iiwib3duZXJBcHAiLCJpc0VtcHR5IiwiY2hhaW5zIiwiaXNQbGFpbk9iamVjdCIsIm9wdGlvbnMiLCJtaWRkbGV3YXJlIiwicHVzaCIsImdldE1pZGRsZXdhcmVGYWN0b3J5IiwiQXJyYXkiLCJpc0FycmF5IiwibWFwIiwibWlkZGxld2FyZUluZm8iLCJpIiwibGVuZ3RoIiwidW5kZWZpbmVkIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQTRCQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBUUMsT0FBTyxDQUFDLFlBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQWNELE9BQU8sQ0FBQyxJQUFELENBQVAsQ0FBY0UsS0FBbEM7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQTJCSCxPQUFPLENBQUMsYUFBRCxDQUF4Qzs7QUFFQUksTUFBTSxDQUFDQyxPQUFQLEdBQWlCO0FBS2JDLEVBQUFBLElBQUksRUFBRUwsT0FBTyxDQUFDTSxJQUxEO0FBYWJDLEVBQUFBLEtBQUssRUFBRSxDQUFDQyxHQUFELEVBQU1DLFNBQU4sS0FBb0I7QUFDdkJYLElBQUFBLENBQUMsQ0FBQ1ksTUFBRixDQUFTRCxTQUFULEVBQW9CLENBQUNFLFdBQUQsRUFBY0MsSUFBZCxLQUF1QjtBQUN2Q0osTUFBQUEsR0FBRyxDQUFDSyx5QkFBSixDQUE4QkQsSUFBOUIsRUFBb0MsQ0FBQ0UsR0FBRCxFQUFNQyxRQUFOLEtBQW1CO0FBQUEsYUFDM0NqQixDQUFDLENBQUNrQixPQUFGLENBQVVGLEdBQVYsQ0FEMkM7QUFBQSwwQkFDMUIsc0NBQXFDRixJQUFLLHNDQURoQjtBQUFBOztBQUVuRCxZQUFJSyxNQUFKOztBQUVBLFlBQUluQixDQUFDLENBQUNvQixhQUFGLENBQWdCUCxXQUFoQixDQUFKLEVBQWtDO0FBQzlCTSxVQUFBQSxNQUFNLEdBQUcsRUFBVDs7QUFFQW5CLFVBQUFBLENBQUMsQ0FBQ1ksTUFBRixDQUFTQyxXQUFULEVBQXNCLENBQUNRLE9BQUQsRUFBVUMsVUFBVixLQUF5QjtBQUMzQ0gsWUFBQUEsTUFBTSxDQUFDSSxJQUFQLENBQVliLEdBQUcsQ0FBQ2Msb0JBQUosQ0FBeUJGLFVBQXpCLEVBQXFDRCxPQUFyQyxFQUE4Q0osUUFBOUMsQ0FBWjtBQUNILFdBRkQ7QUFHSCxTQU5ELE1BTU8sSUFBSVEsS0FBSyxDQUFDQyxPQUFOLENBQWNiLFdBQWQsQ0FBSixFQUFnQztBQUNuQ00sVUFBQUEsTUFBTSxHQUFHTixXQUFXLENBQUNjLEdBQVosQ0FBZ0IsQ0FBQ0MsY0FBRCxFQUFpQkMsQ0FBakIsS0FBdUI7QUFDNUMsZ0JBQUk3QixDQUFDLENBQUNvQixhQUFGLENBQWdCUSxjQUFoQixDQUFKLEVBQXFDO0FBQ2pDLGtCQUFJLENBQUNBLGNBQWMsQ0FBQ2QsSUFBcEIsRUFBMEI7QUFDdEIsc0JBQU0sSUFBSVYsb0JBQUosQ0FDRixxQ0FERSxFQUVGTSxHQUZFLEVBR0QscUJBQW9CSSxJQUFLLElBQUdlLENBQUUsUUFIN0IsQ0FBTjtBQUlIOztBQUVELHFCQUFPbkIsR0FBRyxDQUFDYyxvQkFBSixDQUF5QkksY0FBYyxDQUFDZCxJQUF4QyxFQUE4Q2MsY0FBYyxDQUFDUCxPQUE3RCxFQUFzRUosUUFBdEUsQ0FBUDtBQUNIOztBQUVELGdCQUFJUSxLQUFLLENBQUNDLE9BQU4sQ0FBY0UsY0FBZCxDQUFKLEVBQW1DO0FBQy9CLGtCQUFJQSxjQUFjLENBQUNFLE1BQWYsR0FBd0IsQ0FBeEIsSUFBNkJGLGNBQWMsQ0FBQ0UsTUFBZixHQUF3QixDQUFyRCxJQUEwRCxPQUFPRixjQUFjLENBQUMsQ0FBRCxDQUFyQixLQUE2QixRQUEzRixFQUFxRztBQUNqRyxzQkFBTSxJQUFJeEIsb0JBQUosQ0FDRix5Q0FERSxFQUVGTSxHQUZFLEVBR0QscUJBQW9CSSxJQUFLLElBQUdlLENBQUUsR0FIN0IsQ0FBTjtBQUlIOztBQUVELHFCQUFPbkIsR0FBRyxDQUFDYyxvQkFBSixDQUF5QkksY0FBYyxDQUFDLENBQUQsQ0FBdkMsRUFBNENBLGNBQWMsQ0FBQ0UsTUFBZixHQUF3QixDQUF4QixHQUE0QkYsY0FBYyxDQUFDLENBQUQsQ0FBMUMsR0FBZ0RHLFNBQTVGLEVBQXVHZCxRQUF2RyxDQUFQO0FBQ0g7O0FBRUQsZ0JBQUksT0FBT1csY0FBUCxLQUEwQixRQUE5QixFQUF3QztBQUNwQyxxQkFBT2xCLEdBQUcsQ0FBQ2Msb0JBQUosQ0FBeUJJLGNBQXpCLEVBQXlDRyxTQUF6QyxFQUFvRGQsUUFBcEQsQ0FBUDtBQUNIOztBQUVELGtCQUFNLElBQUliLG9CQUFKLENBQ0YseUNBREUsRUFFRk0sR0FGRSxFQUdELHFCQUFvQkksSUFBSyxJQUFHZSxDQUFFLEdBSDdCLENBQU47QUFJSCxXQS9CUSxDQUFUO0FBZ0NILFNBakNNLE1BaUNBO0FBQ0gsZ0JBQU0sSUFBSXpCLG9CQUFKLENBQ0Ysb0NBREUsRUFFRk0sR0FGRSxFQUdELHFCQUFvQkksSUFBSyxFQUh4QixDQUFOO0FBSUg7O0FBRUQsZUFBT0ssTUFBTSxDQUFDVyxNQUFQLEtBQWtCLENBQWxCLEdBQXNCWCxNQUFNLENBQUMsQ0FBRCxDQUE1QixHQUFrQ0EsTUFBekM7QUFDSCxPQW5ERDtBQW9ESCxLQXJERDtBQXNESDtBQXBFWSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKipcbiAqIEVuYWJsZSBvYmplY3Qgc3RvcmUgZmVhdHVyZVxuICogQG1vZHVsZSBGZWF0dXJlX09iamVjdFN0b3JlXG4gKiBcbiAqIEBleGFtcGxlXG4gKiAgIFwibWlkZGxld2FyZUZhY3RvcnlcIjoge1xuICogICAgICAgLy9uZXcgbWlkZGxld2FyZSBuYW1lXG4gKiAgICAgICBcImxpc3RPZk1pZGRsZXdhcmVcIjoge1xuICogICAgICAgICAgIFwibWlkZGxld2FyZTFcIjogeyAvLyBvcHRpb25zXG4gKiAgICAgICAgICAgICAgIC4uLlxuICogICAgICAgICAgIH0sXG4gKiAgICAgICAgICAgXCJtaWRkbGV3YXJlMlwiOiB7IC8vIG9wdGlvbnNcbiAqICAgICAgICAgICAgICAgLi4uXG4gKiAgICAgICAgICAgfVxuICogICAgICAgfSxcbiAqICAgICAgICBcImFsdExpc3RPZk1pZGRsZXdhcmVcIjogW1xuICogICAgICAgICAgIHtcbiAqICAgICAgICAgICAgICAgXCJuYW1lXCI6IFwibWlkZGxld2FyZTFcIixcbiAqICAgICAgICAgICAgICAgXCJvcHRpb25zXCI6IHsgLi4uIH0gXG4gKiAgICAgICAgICAgfSxcbiAqICAgICAgICAgICBbIFwibWlkZGxld2FyZTJcIiwgeyAuLi4gfSBdLFxuICogICAgICAgICAgIFwibWlkZGxld2FyZTNcIlxuICogICAgICAgXVxuICogICB9LFxuICovXG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgnQGdlbngvanVseScpO1xuY29uc3QgeyBGZWF0dXJlIH0gPSByZXF1aXJlKCcuLicpLkVudW1zO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiB9ID0gcmVxdWlyZSgnQGdlbngvZXJyb3InKTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgLyoqXG4gICAgICogVGhpcyBmZWF0dXJlIGlzIGxvYWRlZCBhdCBpbml0IHN0YWdlXG4gICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAqL1xuICAgIHR5cGU6IEZlYXR1cmUuSU5JVCxcblxuICAgIC8qKlxuICAgICAqIExvYWQgdGhlIGZlYXR1cmVcbiAgICAgKiBAcGFyYW0ge0FwcH0gYXBwIC0gVGhlIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IGZhY3RvcmllcyAtIE9iamVjdCBmYWN0b3JpZXNcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48Kj59XG4gICAgICovXG4gICAgbG9hZF86IChhcHAsIGZhY3RvcmllcykgPT4ge1xuICAgICAgICBfLmZvck93bihmYWN0b3JpZXMsIChmYWN0b3J5SW5mbywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgYXBwLnJlZ2lzdGVyTWlkZGxld2FyZUZhY3RvcnkobmFtZSwgKG9wdCwgb3duZXJBcHApID0+IHsgXG4gICAgICAgICAgICAgICAgYXNzZXJ0OiBfLmlzRW1wdHkob3B0KSwgYFByZS1jb25maWd1cmVkIG1pZGRsZXdhcmUgZmFjdG9yeSBcIiR7bmFtZX1cIiBzaG91bGQgYmUgdXNlZCB3aXRoIGVtcHR5IG9wdGlvbnMuYDtcbiAgICAgICAgICAgICAgICBsZXQgY2hhaW5zO1xuXG4gICAgICAgICAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChmYWN0b3J5SW5mbykpIHtcbiAgICAgICAgICAgICAgICAgICAgY2hhaW5zID0gW107XG4gICAgXG4gICAgICAgICAgICAgICAgICAgIF8uZm9yT3duKGZhY3RvcnlJbmZvLCAob3B0aW9ucywgbWlkZGxld2FyZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2hhaW5zLnB1c2goYXBwLmdldE1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmUpKG9wdGlvbnMsIG93bmVyQXBwKSk7XG4gICAgICAgICAgICAgICAgICAgIH0pOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGZhY3RvcnlJbmZvKSkge1xuICAgICAgICAgICAgICAgICAgICBjaGFpbnMgPSBmYWN0b3J5SW5mby5tYXAoKG1pZGRsZXdhcmVJbmZvLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KG1pZGRsZXdhcmVJbmZvKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbWlkZGxld2FyZUluZm8ubmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnTWlzc2luZyByZWZlcmVuY2VkIG1pZGRsZXdhcmUgbmFtZS4nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYG1pZGRsZXdhcmVGYWN0b3J5LiR7bmFtZX1bJHtpfV0ubmFtZWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcHAuZ2V0TWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUluZm8ubmFtZSkobWlkZGxld2FyZUluZm8ub3B0aW9ucywgb3duZXJBcHApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShtaWRkbGV3YXJlSW5mbykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWlkZGxld2FyZUluZm8ubGVuZ3RoIDwgMSB8fCBtaWRkbGV3YXJlSW5mby5sZW5ndGggPiAyIHx8IHR5cGVvZiBtaWRkbGV3YXJlSW5mb1swXSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0ludmFsaWQgbWlkZGxld2FyZSBmYWN0b3J5IGl0ZW0gY29uZmlnLicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgbWlkZGxld2FyZUZhY3RvcnkuJHtuYW1lfVske2l9XWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcHAuZ2V0TWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUluZm9bMF0pKG1pZGRsZXdhcmVJbmZvLmxlbmd0aCA+IDEgPyBtaWRkbGV3YXJlSW5mb1sxXSA6IHVuZGVmaW5lZCwgb3duZXJBcHApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG1pZGRsZXdhcmVJbmZvID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcHAuZ2V0TWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUluZm8pKHVuZGVmaW5lZCwgb3duZXJBcHApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0ludmFsaWQgbWlkZGxld2FyZSBmYWN0b3J5IGl0ZW0gY29uZmlnLicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBtaWRkbGV3YXJlRmFjdG9yeS4ke25hbWV9WyR7aX1dYCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICAgICAgICAgICdJbnZhbGlkIG1pZGRsZXdhcmUgZmFjdG9yeSBjb25maWcuJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGBtaWRkbGV3YXJlRmFjdG9yeS4ke25hbWV9YCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNoYWlucy5sZW5ndGggPT09IDEgPyBjaGFpbnNbMF0gOiBjaGFpbnM7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxufTsiXX0=