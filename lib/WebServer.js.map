{"version":3,"file":"WebServer.js","names":["require","path","_","eachAsync_","Runnable","ServiceContainer","Routable","Literal","defaultBackendPath","WebServer","constructor","name","options","isPlainObject","undefined","configName","SERVER_CFG_NAME","appModulesPath","APP_MODULES_PATH","server","isServer","backendPath","toAbsolutePath","route","on","loadMiddlewaresFrom","resolve","__dirname","MIDDLEWARES_PATH","stop_","started","appModules","app","appModulesByAlias","httpServer","Promise","reject","close","err","log","mountApp","assert","hasOwnProperty","mountRouter","router","existingApp","getAppByRoute","p","getAppByAlias","a","relativePath","modPath","join","requireFromApp","appName","getService","pos","indexOf","modAlias","substring","_getFeatureFallbackPath","pathArray","splice","SERVER_FEATURES_PATH","APP_FEATURES_PATH","FEATURES_PATH","module","exports"],"sources":["../src/WebServer.js"],"sourcesContent":["\"use strict\";\n\nconst path = require(\"path\");\nconst { _, eachAsync_ } = require(\"@genx/july\");\nconst { Runnable, ServiceContainer } = require(\"@genx/app\");\nconst Routable = require(\"./Routable\");\nconst Literal = require(\"./enum/Literal\");\nconst { defaultBackendPath } = require(\"./utils/Helpers\");\n\n/**\n * Web server class.\n * @class\n * @extends Routable(App)\n */\nclass WebServer extends Routable(Runnable(ServiceContainer)) {\n    /**\n     * @param {string} [name='server'] - The name of the server.\n     * @param {object} [options] - The app module's extra options defined in its parent's configuration.\n     * @property {object} [options.logger] - Logger options\n     * @property {bool} [options.verbose=false] - Flag to output trivial information for diagnostics\n     * @property {string} [options.env] - Environment, default to process.env.NODE_ENV\n     * @property {string} [options.workingPath] - App's working path, default to process.cwd()\n     * @property {string} [options.configPath] - App's config path, default to \"conf\" under workingPath\n     * @property {string} [options.configName] - App's config basename, default to \"app\"\n     * @property {string} [options.backendPath='server'] - Relative path of back-end server source files\n     * @property {string} [options.clientPath='client'] - Relative path of front-end client source files\n     * @property {string} [options.publicPath='public'] - Relative path of front-end static files\n     * @property {string} [options.appModulesPath=app_modules] - Relative path of child modules\n     */\n    constructor(name, options) {\n        if (typeof options === \"undefined\" && _.isPlainObject(name)) {\n            options = name;\n            name = undefined;\n        }\n\n        super(name || \"server\", {\n            configName: Literal.SERVER_CFG_NAME,\n            appModulesPath: Literal.APP_MODULES_PATH,\n            ...options,\n        });\n\n        /**\n         * Hosting server.\n         * @member {WebServer}\n         **/\n        this.server = this;\n\n        /**\n         * Whether it is a server.\n         * @member {boolean}\n         **/\n        this.isServer = true;\n\n        /**\n         * Backend files path.\n         * @member {string}\n         **/\n        this.backendPath = this.toAbsolutePath(this.options.backendPath || defaultBackendPath);\n\n        /**\n         * App modules path.\n         * @member {string}\n         */\n        this.appModulesPath = this.toAbsolutePath(this.options.appModulesPath);\n\n        /**\n         * Base route.\n         * @member {string}\n         */\n        this.route = \"/\";\n\n        this.on(\"configLoaded\", () => {\n            // load builtin middlewares\n            this.loadMiddlewaresFrom(path.resolve(__dirname, Literal.MIDDLEWARES_PATH));\n        });\n    }\n\n    async stop_() {\n        if (this.started) {\n            if (this.appModules) {\n                await eachAsync_(this.appModules, (app) => app.stop_());\n                delete this.appModules;\n                delete this.appModulesByAlias;\n            }\n        }\n\n        if (this.httpServer) {\n            await new Promise((resolve, reject) => {\n                this.httpServer.close((err) => {\n                    if (err) return reject(err);\n                    resolve();\n                });\n            });\n\n            delete this.httpServer;\n            this.log(\"info\", `The http service is stopped.`);\n        }\n\n        return super.stop_();\n    }\n\n    /**\n     * Mount an app at specified route.\n     * @param {WebModule} app\n     */\n    mountApp(app) {\n        if (!this.appModules) {\n            this.appModules = {};\n            this.appModulesByAlias = {};\n        }\n\n        assert: !this.appModules.hasOwnProperty(app.route);\n\n        this.mountRouter(app.route, app.router);\n\n        this.appModules[app.route] = app;\n\n        if (app.name in this.appModulesByAlias) {\n            let existingApp = this.appModulesByAlias[app.name];\n            //move bucket\n            this.appModulesByAlias[`${existingApp.name}[@${existingApp.route}]`] = existingApp;\n            delete this.appModulesByAlias[app.name];\n\n            this.appModulesByAlias[`${app.name}[@${app.route}]`] = app;\n        } else {\n            this.appModulesByAlias[app.name] = app;\n        }\n\n        this.log(\"verbose\", `All routes from app [${app.name}] are mounted under \"${app.route}\".`);\n    }\n\n    /**\n     * Get the app module object by base route\n     * @param {string} p - App module base route started with \"/\"\n     */\n    getAppByRoute(p) {\n        //todo: change to p-tree\n        return this.appModules[p];\n    }\n\n    /**\n     * Get the app module object by app alias, usually the app name if no duplicate entry\n     * @param {string} a - App module alias\n     */\n    getAppByAlias(a) {\n        return this.appModulesByAlias[a];\n    }\n\n    /**\n     * Require a js module from backend path\n     * @param {*} relativePath\n     */\n    require(relativePath) {\n        let modPath = path.join(this.backendPath, relativePath);\n        return require(modPath);\n    }\n\n    /**\n     * Require a module from the source path of an app module\n     * @param {*} relativePath\n     */\n    requireFromApp(appName, relativePath) {\n        const app = this.getAppByAlias(appName);\n        return app.require(relativePath);\n    }\n\n    /**\n     * Get a registered service\n     * @param {string} name\n     *\n     * @example\n     *  // Get service from a lib module\n     *  const service = app.getService('<lib name>/<service name>');\n     *  // e.g const service = app.getService('data/mysql.mydb');\n     *\n     *  // Get service from a web app module\n     *  const service = app.getService('<app name>:<service name>');\n     *  // e.g const service = app.getService('admin:mysql.mydb');\n     */\n    getService(name) {\n        let pos = name.indexOf(\":\");\n        if (pos === -1) {\n            return super.getService(name);\n        }\n\n        let modAlias = name.substring(0, pos);\n        name = name.substring(pos + 1);\n\n        let app = this.getAppByAlias(modAlias);\n        return app && app.getService(name, true);\n    }\n\n    _getFeatureFallbackPath() {\n        let pathArray = super._getFeatureFallbackPath();\n        pathArray.splice(\n            1,\n            0,\n            path.resolve(__dirname, Literal.SERVER_FEATURES_PATH),\n            path.resolve(__dirname, Literal.APP_FEATURES_PATH),\n            path.resolve(__dirname, Literal.FEATURES_PATH)\n        );\n        return pathArray;\n    }\n}\n\nmodule.exports = WebServer;\n"],"mappings":"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"}