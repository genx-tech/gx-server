"use strict";

require("source-map-support/register");

const Feature = require('@genx/app/lib/enum/Feature');

const Util = require('rk-utils');

const _ = Util._;
const Promise = Util.Promise;

const validator = require('validator');

const {
  InvalidConfiguration
} = require('@genx/error');

module.exports = {
  type: Feature.SERVICE,
  load_: function (server, options) {
    let koa = server.router;
    server.koa = koa;
    koa.env = server.env;
    koa.proxy = options.trustProxy && validator.toBoolean(options.trustProxy);

    if ('subdomainOffset' in options && options.subdomainOffset !== 2) {
      if (options.subdomainOffset < 2) {
        throw new InvalidConfiguration('Invalid subdomainOffset. Should be larger or equal to 2.', appModule, 'koa.subdomainOffset');
      }

      koa.subdomainOffset = options.subdomainOffset;
    }

    if (options.keys) {
      if (!_.isArray(options.keys)) {
        koa.keys = [options.keys];
      } else {
        koa.keys = options.keys;
      }
    }

    koa.on('error', (err, ctx) => {
      let extra = _.pick(err, ['status', 'code', 'info']);

      if (ctx) {
        extra.request = _.pick(ctx, ['method', 'url', 'ip']);
      }

      extra.app = ctx.appModule.name;

      if (err.status && err.status < 500) {
        if (server.env === 'development') {
          extra.stack = err.stack;
        }

        server.log('warn', `[${err.status}] ` + err.message, extra);
        return;
      }

      server.logError(err);
    });
    server.httpServer = require('http').createServer(koa.callback());
    let port = options.httpPort || 2331;
    server.on('ready', () => {
      server.httpServer.listen(port, function (err) {
        if (err) throw err;
        let address = server.httpServer.address();
        let host;

        if (address.family === 'IPv6' && address.address === '::') {
          host = '127.0.0.1';
        } else {
          host = address.address;
        }

        server.host = `${host}:${address.port}`;
        server.port = address.port;
        server.log('info', `A http service is listening on port [${address.port}] ...`);
        server.emit('httpReady');
      });
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXJGZWF0dXJlcy9rb2EuanMiXSwibmFtZXMiOlsiRmVhdHVyZSIsInJlcXVpcmUiLCJVdGlsIiwiXyIsIlByb21pc2UiLCJ2YWxpZGF0b3IiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0eXBlIiwiU0VSVklDRSIsImxvYWRfIiwic2VydmVyIiwib3B0aW9ucyIsImtvYSIsInJvdXRlciIsImVudiIsInByb3h5IiwidHJ1c3RQcm94eSIsInRvQm9vbGVhbiIsInN1YmRvbWFpbk9mZnNldCIsImFwcE1vZHVsZSIsImtleXMiLCJpc0FycmF5Iiwib24iLCJlcnIiLCJjdHgiLCJleHRyYSIsInBpY2siLCJyZXF1ZXN0IiwiYXBwIiwibmFtZSIsInN0YXR1cyIsInN0YWNrIiwibG9nIiwibWVzc2FnZSIsImxvZ0Vycm9yIiwiaHR0cFNlcnZlciIsImNyZWF0ZVNlcnZlciIsImNhbGxiYWNrIiwicG9ydCIsImh0dHBQb3J0IiwibGlzdGVuIiwiYWRkcmVzcyIsImhvc3QiLCJmYW1pbHkiLCJlbWl0Il0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLDRCQUFELENBQXZCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTUUsQ0FBQyxHQUFHRCxJQUFJLENBQUNDLENBQWY7QUFDQSxNQUFNQyxPQUFPLEdBQUdGLElBQUksQ0FBQ0UsT0FBckI7O0FBQ0EsTUFBTUMsU0FBUyxHQUFHSixPQUFPLENBQUMsV0FBRCxDQUF6Qjs7QUFDQSxNQUFNO0FBQUVLLEVBQUFBO0FBQUYsSUFBMkJMLE9BQU8sQ0FBQyxhQUFELENBQXhDOztBQWlCQU0sTUFBTSxDQUFDQyxPQUFQLEdBQWlCO0FBTWJDLEVBQUFBLElBQUksRUFBRVQsT0FBTyxDQUFDVSxPQU5EO0FBa0JiQyxFQUFBQSxLQUFLLEVBQUUsVUFBVUMsTUFBVixFQUFr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QUFQLENBQWtCTSxPQUFsQixFQUFkO0FBRUEsWUFBSUMsSUFBSjs7QUFDQSxZQUFJRCxPQUFPLENBQUNFLE1BQVIsS0FBbUIsTUFBbkIsSUFBNkJGLE9BQU8sQ0FBQ0EsT0FBUixLQUFvQixJQUFyRCxFQUEyRDtBQUN2REMsVUFBQUEsSUFBSSxHQUFHLFdBQVA7QUFDSCxTQUZELE1BRU87QUFDSEEsVUFBQUEsSUFBSSxHQUFHRCxPQUFPLENBQUNBLE9BQWY7QUFDSDs7QUFFRC9CLFFBQUFBLE1BQU0sQ0FBQ2dDLElBQVAsR0FBZSxHQUFFQSxJQUFLLElBQUdELE9BQU8sQ0FBQ0gsSUFBSyxFQUF0QztBQUNBNUIsUUFBQUEsTUFBTSxDQUFDNEIsSUFBUCxHQUFjRyxPQUFPLENBQUNILElBQXRCO0FBRUE1QixRQUFBQSxNQUFNLENBQUNzQixHQUFQLENBQVcsTUFBWCxFQUFvQix3Q0FBdUNTLE9BQU8sQ0FBQ0gsSUFBSyxPQUF4RTtBQUtBNUIsUUFBQUEsTUFBTSxDQUFDa0MsSUFBUCxDQUFZLFdBQVo7QUFDSCxPQXJCRDtBQXNCSCxLQXZCRDtBQXdCSDtBQTdGWSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBGZWF0dXJlID0gcmVxdWlyZSgnQGdlbngvYXBwL2xpYi9lbnVtL0ZlYXR1cmUnKTtcbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgXyA9IFV0aWwuXztcbmNvbnN0IFByb21pc2UgPSBVdGlsLlByb21pc2U7XG5jb25zdCB2YWxpZGF0b3IgPSByZXF1aXJlKCd2YWxpZGF0b3InKTtcbmNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24gfSA9IHJlcXVpcmUoJ0BnZW54L2Vycm9yJyk7XG5cbi8qKlxuICogS29hIG1pZGRsZXdhcmUgZnVuY3Rpb25cbiAqIEBjYWxsYmFjayBLb2FBY3Rpb25GdW5jdGlvblxuICogQGFzeW5jXG4gKiBAcGFyYW0ge29iamVjdH0gY3R4IC0gVGhlIGtvYSByZXF1ZXN0IGFuZCByZXNwb25zZSBjb250ZXh0LiBbU2VlIGtvYWpzIGFib3V0IGN0eCBkZXRhaWxzXXtAbGluayBodHRwOi8va29hanMuY29tLyNjb250ZXh0fVxuICogQHByb3BlcnR5IHtvYmplY3R9IGN0eC5yZXFldXN0IC0gVGhlIGtvYSByZXF1ZXN0IG9iamVjdC5cbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBjdHgucmVzcG9uc2UgLSBUaGUga29hIHJlc3BvbnNlIG9iamVjdC5cbiAqIEBwYXJhbSB7S29hQWN0aW9uRnVuY3Rpb259IFtuZXh0XSAtIE5leHQgbWlkZGxld2FyZSBvciBhY3Rpb24uXG4gKi9cblxuLyoqXG4gKiBFbmFibGUga29hLWJhc2VkIHdlYiBlbmdpbmUuXG4gKiBAbW9kdWxlIEZlYXR1cmVfS29hIFxuICovXG5cbm1vZHVsZS5leHBvcnRzID0ge1xuXG4gICAgLyoqXG4gICAgICogVGhpcyBmZWF0dXJlIGlzIGxvYWRlZCBhdCBzZXJ2aWNlIHN0YWdlXG4gICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAqL1xuICAgIHR5cGU6IEZlYXR1cmUuU0VSVklDRSxcblxuICAgIC8qKlxuICAgICAqIExvYWQgdGhlIGZlYXR1cmVcbiAgICAgKiBAcGFyYW0ge1dlYlNlcnZlcn0gc2VydmVyIC0gVGhlIHdlYiBzZXJ2ZXJcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyAtIE9wdGlvbnMgZm9yIHRoZSBmZWF0dXJlICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLnRydXN0UHJveHldIC0gV2hlbiB0cnVlIHByb3h5IGhlYWRlciBmaWVsZHMgd2lsbCBiZSB0cnVzdGVkXG4gICAgICogQHByb3BlcnR5IHtBcnJheS48c3RyaW5nPn0gW29wdGlvbnMua2V5c10gLSBTZXQgc2lnbmVkIGNvb2tpZSBrZXlzXG4gICAgICogQHByb3BlcnR5IHtpbnR9IFtvcHRpb25zLmh0dHBQb3J0XSAtIFRoZSBodHRwIHBvcnQgbnVtYmVyXG4gICAgICogQHByb3BlcnR5IHtpbnR9IFtvcHRpb25zLnN1YmRvbWFpbk9mZnNldD0yXSAtIFRoZSBvZmZzZXQgb2Ygc3ViZG9tYWlucyB0byBpZ25vcmUsIGRlZmF1bHQ6IDJcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48Kj59XG4gICAgICovXG4gICAgbG9hZF86IGZ1bmN0aW9uIChzZXJ2ZXIsIG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IGtvYSA9IHNlcnZlci5yb3V0ZXI7XG4gICAgICAgIHNlcnZlci5rb2EgPSBrb2E7XG4gICAgICAgIFxuICAgICAgICBrb2EuZW52ID0gc2VydmVyLmVudjtcbiAgICAgICAga29hLnByb3h5ID0gb3B0aW9ucy50cnVzdFByb3h5ICYmIHZhbGlkYXRvci50b0Jvb2xlYW4ob3B0aW9ucy50cnVzdFByb3h5KTtcblxuICAgICAgICBpZiAoKCdzdWJkb21haW5PZmZzZXQnIGluIG9wdGlvbnMpICYmIG9wdGlvbnMuc3ViZG9tYWluT2Zmc2V0ICE9PSAyKSB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5zdWJkb21haW5PZmZzZXQgPCAyKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAnSW52YWxpZCBzdWJkb21haW5PZmZzZXQuIFNob3VsZCBiZSBsYXJnZXIgb3IgZXF1YWwgdG8gMi4nLFxuICAgICAgICAgICAgICAgICAgICBhcHBNb2R1bGUsXG4gICAgICAgICAgICAgICAgICAgICdrb2Euc3ViZG9tYWluT2Zmc2V0J1xuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGtvYS5zdWJkb21haW5PZmZzZXQgPSBvcHRpb25zLnN1YmRvbWFpbk9mZnNldDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRpb25zLmtleXMpIHtcbiAgICAgICAgICAgIGlmICghXy5pc0FycmF5KG9wdGlvbnMua2V5cykpIHtcbiAgICAgICAgICAgICAgICBrb2Eua2V5cyA9IFsgb3B0aW9ucy5rZXlzIF07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGtvYS5rZXlzID0gb3B0aW9ucy5rZXlzO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAga29hLm9uKCdlcnJvcicsIChlcnIsIGN0eCkgPT4ge1xuICAgICAgICAgICAgbGV0IGV4dHJhID0gXy5waWNrKGVyciwgWyAnc3RhdHVzJywgJ2NvZGUnLCAnaW5mbycgXSk7XG5cbiAgICAgICAgICAgIGlmIChjdHgpIHtcbiAgICAgICAgICAgICAgICBleHRyYS5yZXF1ZXN0ID0gXy5waWNrKGN0eCwgWydtZXRob2QnLCAndXJsJywgJ2lwJ10pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBleHRyYS5hcHAgPSBjdHguYXBwTW9kdWxlLm5hbWU7XG5cbiAgICAgICAgICAgIGlmIChlcnIuc3RhdHVzICYmIGVyci5zdGF0dXMgPCA1MDApIHsgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHNlcnZlci5lbnYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAgICAgICAgICAgICAgICAgZXh0cmEuc3RhY2sgPSBlcnIuc3RhY2s7XG4gICAgICAgICAgICAgICAgfSAgIFxuICAgICAgICAgICAgICAgIHNlcnZlci5sb2coJ3dhcm4nLCBgWyR7ZXJyLnN0YXR1c31dIGAgKyBlcnIubWVzc2FnZSwgZXh0cmEpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH0gXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHNlcnZlci5sb2dFcnJvcihlcnIpO1xuICAgICAgICB9KTsgICAgICAgICAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBzZXJ2ZXIuaHR0cFNlcnZlciA9IHJlcXVpcmUoJ2h0dHAnKS5jcmVhdGVTZXJ2ZXIoa29hLmNhbGxiYWNrKCkpOyAgICAgICAgICAgICAgICBcblxuICAgICAgICBsZXQgcG9ydCA9IG9wdGlvbnMuaHR0cFBvcnQgfHwgMjMzMTtcblxuICAgICAgICBzZXJ2ZXIub24oJ3JlYWR5JywgKCkgPT4ge1xuICAgICAgICAgICAgc2VydmVyLmh0dHBTZXJ2ZXIubGlzdGVuKHBvcnQsIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7XG5cbiAgICAgICAgICAgICAgICBsZXQgYWRkcmVzcyA9IHNlcnZlci5odHRwU2VydmVyLmFkZHJlc3MoKTtcblxuICAgICAgICAgICAgICAgIGxldCBob3N0O1xuICAgICAgICAgICAgICAgIGlmIChhZGRyZXNzLmZhbWlseSA9PT0gJ0lQdjYnICYmIGFkZHJlc3MuYWRkcmVzcyA9PT0gJzo6Jykge1xuICAgICAgICAgICAgICAgICAgICBob3N0ID0gJzEyNy4wLjAuMSc7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaG9zdCA9IGFkZHJlc3MuYWRkcmVzcztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBzZXJ2ZXIuaG9zdCA9IGAke2hvc3R9OiR7YWRkcmVzcy5wb3J0fWA7XG4gICAgICAgICAgICAgICAgc2VydmVyLnBvcnQgPSBhZGRyZXNzLnBvcnQ7XG5cbiAgICAgICAgICAgICAgICBzZXJ2ZXIubG9nKCdpbmZvJywgYEEgaHR0cCBzZXJ2aWNlIGlzIGxpc3RlbmluZyBvbiBwb3J0IFske2FkZHJlc3MucG9ydH1dIC4uLmApO1xuICAgICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgICAqIEh0dHAgc2VydmVyIHJlYWR5IGV2ZW50XG4gICAgICAgICAgICAgICAgICogQGV2ZW50IFdlYlNlcnZlciNodHRwUmVhZHlcbiAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICBzZXJ2ZXIuZW1pdCgnaHR0cFJlYWR5Jyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxufTsiXX0=