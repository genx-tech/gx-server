"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const _ = Util._;
const Promise = Util.Promise;

const Literal = require('../enum/Literal');

const Router = require('@koa/router');

const Controller = require('../patterns/Controller');

const {
  InvalidConfiguration
} = require('../utils/Errors');

const {
  hasMethod
} = require('../utils/Helpers');

module.exports = (app, baseRoute, options) => {
  let resourcePath = path.resolve(app.backendPath, options.resourcesPath || Literal.RESOURCES_PATH);
  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(), 'jsonError');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let resourcesPath = path.join(resourcePath, "**", "*.js");
  let files = Util.glob.sync(resourcesPath, {
    nodir: true
  });

  _.each(files, file => {
    let relPath = path.relative(resourcePath, file);
    let batchUrl = Util.ensureLeftSlash(relPath.substring(0, relPath.length - 3).split(path.sep).map(p => _.kebabCase(p)).join('/'));
    let singleUrl = options.idRegExp ? batchUrl + `/:id(${options.idRegExp})` : batchUrl + '/:id';

    let controller = require(file);

    let isObj = false;

    if (controller.prototype instanceof Controller) {
      controller = new controller(app);
      isObj = true;
    }

    if (hasMethod(controller, 'findMany_')) {
      app.addRoute(router, 'get', batchUrl, isObj ? controller.findMany_.bind(controller) : controller.findMany_);
    }

    if (hasMethod(controller, 'create_')) {
      app.addRoute(router, 'post', batchUrl, isObj ? controller.create_.bind(controller) : controller.create_);
    }

    if (options.withKeyValuePairInPath && hasMethod(controller, 'findOneBy_')) {
      app.addRoute(router, 'get', batchUrl + '/:key/:value', isObj ? controller.findOneBy_.bind(controller) : controller.findOneBy_);
    }

    if (hasMethod(controller, 'findOne_')) {
      app.addRoute(router, 'get', singleUrl, isObj ? controller.findOne_.bind(controller) : controller.findOne_);
    }

    if (hasMethod(controller, 'updateOne_')) {
      app.addRoute(router, 'put', singleUrl, isObj ? controller.updateOne_.bind(controller) : controller.updateOne_);
    }

    if (hasMethod(controller, 'deleteOne_')) {
      app.addRoute(router, 'del', singleUrl, isObj ? controller.deleteOne_.bind(controller) : controller.deleteOne_);
    }
  });

  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL3Jlc3QuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJVdGlsIiwiXyIsIlByb21pc2UiLCJMaXRlcmFsIiwiUm91dGVyIiwiQ29udHJvbGxlciIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiaGFzTWV0aG9kIiwibW9kdWxlIiwiZXhwb3J0cyIsImFwcCIsImJhc2VSb3V0ZSIsIm9wdGlvbnMiLCJyZXNvdXJjZVBhdGgiLCJyZXNvbHZlIiwiYmFja2VuZFBhdGgiLCJyZXNvdXJjZXNQYXRoIiwiUkVTT1VSQ0VTX1BBVEgiLCJyb3V0ZXIiLCJwcmVmaXgiLCJ1c2VNaWRkbGV3YXJlIiwiZ2V0TWlkZGxld2FyZUZhY3RvcnkiLCJtaWRkbGV3YXJlcyIsInVzZU1pZGRsZXdhcmVzIiwiam9pbiIsImZpbGVzIiwiZ2xvYiIsInN5bmMiLCJub2RpciIsImVhY2giLCJmaWxlIiwicmVsUGF0aCIsInJlbGF0aXZlIiwiYmF0Y2hVcmwiLCJlbnN1cmVMZWZ0U2xhc2giLCJzdWJzdHJpbmciLCJsZW5ndGgiLCJzcGxpdCIsInNlcCIsIm1hcCIsInAiLCJrZWJhYkNhc2UiLCJzaW5nbGVVcmwiLCJpZFJlZ0V4cCIsImNvbnRyb2xsZXIiLCJpc09iaiIsInByb3RvdHlwZSIsImFkZFJvdXRlIiwiZmluZE1hbnlfIiwiYmluZCIsImNyZWF0ZV8iLCJ3aXRoS2V5VmFsdWVQYWlySW5QYXRoIiwiZmluZE9uZUJ5XyIsImZpbmRPbmVfIiwidXBkYXRlT25lXyIsImRlbGV0ZU9uZV8iLCJhZGRSb3V0ZXIiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU1FLENBQUMsR0FBR0QsSUFBSSxDQUFDQyxDQUFmO0FBQ0EsTUFBTUMsT0FBTyxHQUFHRixJQUFJLENBQUNFLE9BQXJCOztBQUNBLE1BQU1DLE9BQU8sR0FBR0osT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUNBLE1BQU1LLE1BQU0sR0FBR0wsT0FBTyxDQUFDLGFBQUQsQ0FBdEI7O0FBQ0EsTUFBTU0sVUFBVSxHQUFHTixPQUFPLENBQUMsd0JBQUQsQ0FBMUI7O0FBQ0EsTUFBTTtBQUFFTyxFQUFBQTtBQUFGLElBQTJCUCxPQUFPLENBQUMsaUJBQUQsQ0FBeEM7O0FBQ0EsTUFBTTtBQUFFUSxFQUFBQTtBQUFGLElBQWdCUixPQUFPLENBQUMsa0JBQUQsQ0FBN0I7O0FBZ0NBUyxNQUFNLENBQUNDLE9BQVAsR0FBaUIsQ0FBQ0MsR0FBRCxFQUFNQyxTQUFOLEVBQWlCQyxPQUFqQixLQUE2QjtBQUMxQyxNQUFJQyxZQUFZLEdBQUdmLElBQUksQ0FBQ2dCLE9BQUwsQ0FBYUosR0FBRyxDQUFDSyxXQUFqQixFQUE4QkgsT0FBTyxDQUFDSSxhQUFSLElBQXlCYixPQUFPLENBQUNjLGNBQS9ELENBQW5CO0FBRUEsTUFBSUMsTUFBTSxHQUFHUCxTQUFTLEtBQUssR0FBZCxHQUFvQixJQUFJUCxNQUFKLEVBQXBCLEdBQW1DLElBQUlBLE1BQUosQ0FBVztBQUFDZSxJQUFBQSxNQUFNLEVBQUVSO0FBQVQsR0FBWCxDQUFoRDtBQUVBRCxFQUFBQSxHQUFHLENBQUNVLGFBQUosQ0FBa0JGLE1BQWxCLEVBQTBCUixHQUFHLENBQUNXLG9CQUFKLENBQXlCLFdBQXpCLEdBQTFCLEVBQW1FLFdBQW5FOztBQUVBLE1BQUlULE9BQU8sQ0FBQ1UsV0FBWixFQUF5QjtBQUNyQlosSUFBQUEsR0FBRyxDQUFDYSxjQUFKLENBQW1CTCxNQUFuQixFQUEyQk4sT0FBTyxDQUFDVSxXQUFuQztBQUNIOztBQUVELE1BQUlOLGFBQWEsR0FBR2xCLElBQUksQ0FBQzBCLElBQUwsQ0FBVVgsWUFBVixFQUF3QixJQUF4QixFQUE4QixNQUE5QixDQUFwQjtBQUNBLE1BQUlZLEtBQUssR0FBR3pCLElBQUksQ0FBQzBCLElBQUwsQ0FBVUMsSUFBVixDQUFlWCxhQUFmLEVBQThCO0FBQUNZLElBQUFBLEtBQUssRUFBRTtBQUFSLEdBQTlCLENBQVo7O0FBRUEzQixFQUFBQSxDQUFDLENBQUM0QixJQUFGLENBQU9KLEtBQVAsRUFBY0ssSUFBSSxJQUFJO0FBQ2xCLFFBQUlDLE9BQU8sR0FBR2pDLElBQUksQ0FBQ2tDLFFBQUwsQ0FBY25CLFlBQWQsRUFBNEJpQixJQUE1QixDQUFkO0FBQ0EsUUFBSUcsUUFBUSxHQUFHakMsSUFBSSxDQUFDa0MsZUFBTCxDQUFxQkgsT0FBTyxDQUFDSSxTQUFSLENBQWtCLENBQWxCLEVBQXFCSixPQUFPLENBQUNLLE1BQVIsR0FBaUIsQ0FBdEMsRUFBeUNDLEtBQXpDLENBQStDdkMsSUFBSSxDQUFDd0MsR0FBcEQsRUFBeURDLEdBQXpELENBQTZEQyxDQUFDLElBQUl2QyxDQUFDLENBQUN3QyxTQUFGLENBQVlELENBQVosQ0FBbEUsRUFBa0ZoQixJQUFsRixDQUF1RixHQUF2RixDQUFyQixDQUFmO0FBQ0EsUUFBSWtCLFNBQVMsR0FBRzlCLE9BQU8sQ0FBQytCLFFBQVIsR0FBbUJWLFFBQVEsR0FBSSxRQUFPckIsT0FBTyxDQUFDK0IsUUFBUyxHQUF2RCxHQUE0RFYsUUFBUSxHQUFHLE1BQXZGOztBQUVBLFFBQUlXLFVBQVUsR0FBRzdDLE9BQU8sQ0FBQytCLElBQUQsQ0FBeEI7O0FBQ0EsUUFBSWUsS0FBSyxHQUFHLEtBQVo7O0FBRUEsUUFBSUQsVUFBVSxDQUFDRSxTQUFYLFlBQWdDekMsVUFBcEMsRUFBZ0Q7QUFDNUN1QyxNQUFBQSxVQUFVLEdBQUcsSUFBSUEsVUFBSixDQUFlbEMsR0FBZixDQUFiO0FBQ0FtQyxNQUFBQSxLQUFLLEdBQUcsSUFBUjtBQUNIOztBQUVELFFBQUl0QyxTQUFTLENBQUNxQyxVQUFELEVBQWEsV0FBYixDQUFiLEVBQXdDO0FBQ3BDbEMsTUFBQUEsR0FBRyxDQUFDcUMsUUFBSixDQUFhN0IsTUFBYixFQUFxQixLQUFyQixFQUE0QmUsUUFBNUIsRUFBc0NZLEtBQUssR0FBR0QsVUFBVSxDQUFDSSxTQUFYLENBQXFCQyxJQUFyQixDQUEwQkwsVUFBMUIsQ0FBSCxHQUEyQ0EsVUFBVSxDQUFDSSxTQUFqRztBQUNIOztBQUVELFFBQUl6QyxTQUFTLENBQUNxQyxVQUFELEVBQWEsU0FBYixDQUFiLEVBQXNDO0FBQ2xDbEMsTUFBQUEsR0FBRyxDQUFDcUMsUUFBSixDQUFhN0IsTUFBYixFQUFxQixNQUFyQixFQUE2QmUsUUFBN0IsRUFBdUNZLEtBQUssR0FBR0QsVUFBVSxDQUFDTSxPQUFYLENBQW1CRCxJQUFuQixDQUF3QkwsVUFBeEIsQ0FBSCxHQUF5Q0EsVUFBVSxDQUFDTSxPQUFoRztBQUNIOztBQUVELFFBQUl0QyxPQUFPLENBQUN1QyxzQkFBUixJQUFrQzVDLFNBQVMsQ0FBQ3FDLFVBQUQsRUFBYSxZQUFiLENBQS9DLEVBQTJFO0FBQ3ZFbEMsTUFBQUEsR0FBRyxDQUFDcUMsUUFBSixDQUFhN0IsTUFBYixFQUFxQixLQUFyQixFQUE0QmUsUUFBUSxHQUFHLGNBQXZDLEVBQXVEWSxLQUFLLEdBQUdELFVBQVUsQ0FBQ1EsVUFBWCxDQUFzQkgsSUFBdEIsQ0FBMkJMLFVBQTNCLENBQUgsR0FBNENBLFVBQVUsQ0FBQ1EsVUFBbkg7QUFDSDs7QUFFRCxRQUFJN0MsU0FBUyxDQUFDcUMsVUFBRCxFQUFhLFVBQWIsQ0FBYixFQUF1QztBQUNuQ2xDLE1BQUFBLEdBQUcsQ0FBQ3FDLFFBQUosQ0FBYTdCLE1BQWIsRUFBcUIsS0FBckIsRUFBNEJ3QixTQUE1QixFQUF1Q0csS0FBSyxHQUFHRCxVQUFVLENBQUNTLFFBQVgsQ0FBb0JKLElBQXBCLENBQXlCTCxVQUF6QixDQUFILEdBQTBDQSxVQUFVLENBQUNTLFFBQWpHO0FBQ0g7O0FBRUQsUUFBSTlDLFNBQVMsQ0FBQ3FDLFVBQUQsRUFBYSxZQUFiLENBQWIsRUFBeUM7QUFDckNsQyxNQUFBQSxHQUFHLENBQUNxQyxRQUFKLENBQWE3QixNQUFiLEVBQXFCLEtBQXJCLEVBQTRCd0IsU0FBNUIsRUFBdUNHLEtBQUssR0FBR0QsVUFBVSxDQUFDVSxVQUFYLENBQXNCTCxJQUF0QixDQUEyQkwsVUFBM0IsQ0FBSCxHQUE0Q0EsVUFBVSxDQUFDVSxVQUFuRztBQUNIOztBQUVELFFBQUkvQyxTQUFTLENBQUNxQyxVQUFELEVBQWEsWUFBYixDQUFiLEVBQXlDO0FBQ3JDbEMsTUFBQUEsR0FBRyxDQUFDcUMsUUFBSixDQUFhN0IsTUFBYixFQUFxQixLQUFyQixFQUE0QndCLFNBQTVCLEVBQXVDRyxLQUFLLEdBQUdELFVBQVUsQ0FBQ1csVUFBWCxDQUFzQk4sSUFBdEIsQ0FBMkJMLFVBQTNCLENBQUgsR0FBNENBLFVBQVUsQ0FBQ1csVUFBbkc7QUFDSDtBQUNKLEdBcENEOztBQXNDQTdDLEVBQUFBLEdBQUcsQ0FBQzhDLFNBQUosQ0FBY3RDLE1BQWQ7QUFDSCxDQXJERCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCBfID0gVXRpbC5fO1xuY29uc3QgUHJvbWlzZSA9IFV0aWwuUHJvbWlzZTtcbmNvbnN0IExpdGVyYWwgPSByZXF1aXJlKCcuLi9lbnVtL0xpdGVyYWwnKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJ0Brb2Evcm91dGVyJyk7XG5jb25zdCBDb250cm9sbGVyID0gcmVxdWlyZSgnLi4vcGF0dGVybnMvQ29udHJvbGxlcicpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvRXJyb3JzJyk7XG5jb25zdCB7IGhhc01ldGhvZCB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvSGVscGVycycpO1xuXG4vKipcbiAqIFJFU1RmdWwgcm91dGVyLlxuICogQG1vZHVsZSBSb3V0ZXJfUmVzdFxuICovXG5cbi8qKlxuICogQ3JlYXRlIGEgUkVTVGZ1bCByb3V0ZXIuXG4gKiBAcGFyYW0geyp9IGFwcCBcbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUm91dGUgXG4gKiBAcGFyYW0ge29iamVjdHN9IG9wdGlvbnMgXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucmVzb3VyY2VzUGF0aF1cbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fGFycmF5fSBbb3B0aW9ucy5taWRkbGV3YXJlc11cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMud2l0aEtleVZhbHVlUGFpckluUGF0aF1cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5pZFJlZ0V4cF1cbiAqIEBleGFtcGxlXG4gKiAgJzxiYXNlIHBhdGg+Jzoge1xuICogICAgICByZXN0OiB7XG4gKiAgICAgICAgICByZXNvdXJjZXNQYXRoOlxuICogICAgICAgICAgbWlkZGxld2FyZXM6XG4gKiAgICAgIH1cbiAqICB9XG4gKiAgXG4gKiAgcm91dGUgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAgbWV0aG9kICAgIGZ1bmN0aW9uIG9mIGN0cmxcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgZmluZE1hbnlfIFxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBwb3N0ICAgICAgICAgICBjcmVhdGVfXG4gKiAgLzpyZXNvdXJjZS86dW5pcXVlLWtleS86dmFsdWUgIGdldCAgICAgICAgICAgIGZpbmRPbmVCeV9cbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgZmluZE9uZV9cbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgcHV0ICAgICAgICAgICAgdXBkYXRlT25lX1xuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBkZWxldGUgICAgICAgICBkZWxldGVPbmVfXG4gKi9cbm1vZHVsZS5leHBvcnRzID0gKGFwcCwgYmFzZVJvdXRlLCBvcHRpb25zKSA9PiB7XG4gICAgbGV0IHJlc291cmNlUGF0aCA9IHBhdGgucmVzb2x2ZShhcHAuYmFja2VuZFBhdGgsIG9wdGlvbnMucmVzb3VyY2VzUGF0aCB8fCBMaXRlcmFsLlJFU09VUkNFU19QQVRIKTtcbiAgICBcbiAgICBsZXQgcm91dGVyID0gYmFzZVJvdXRlID09PSAnLycgPyBuZXcgUm91dGVyKCkgOiBuZXcgUm91dGVyKHtwcmVmaXg6IGJhc2VSb3V0ZX0pO1xuXG4gICAgYXBwLnVzZU1pZGRsZXdhcmUocm91dGVyLCBhcHAuZ2V0TWlkZGxld2FyZUZhY3RvcnkoJ2pzb25FcnJvcicpKCksICdqc29uRXJyb3InKTtcblxuICAgIGlmIChvcHRpb25zLm1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGFwcC51c2VNaWRkbGV3YXJlcyhyb3V0ZXIsIG9wdGlvbnMubWlkZGxld2FyZXMpO1xuICAgIH1cblxuICAgIGxldCByZXNvdXJjZXNQYXRoID0gcGF0aC5qb2luKHJlc291cmNlUGF0aCwgXCIqKlwiLCBcIiouanNcIik7XG4gICAgbGV0IGZpbGVzID0gVXRpbC5nbG9iLnN5bmMocmVzb3VyY2VzUGF0aCwge25vZGlyOiB0cnVlfSk7XG5cbiAgICBfLmVhY2goZmlsZXMsIGZpbGUgPT4ge1xuICAgICAgICBsZXQgcmVsUGF0aCA9IHBhdGgucmVsYXRpdmUocmVzb3VyY2VQYXRoLCBmaWxlKTsgICAgICAgICAgXG4gICAgICAgIGxldCBiYXRjaFVybCA9IFV0aWwuZW5zdXJlTGVmdFNsYXNoKHJlbFBhdGguc3Vic3RyaW5nKDAsIHJlbFBhdGgubGVuZ3RoIC0gMykuc3BsaXQocGF0aC5zZXApLm1hcChwID0+IF8ua2ViYWJDYXNlKHApKS5qb2luKCcvJykpO1xuICAgICAgICBsZXQgc2luZ2xlVXJsID0gb3B0aW9ucy5pZFJlZ0V4cCA/IGJhdGNoVXJsICsgYC86aWQoJHtvcHRpb25zLmlkUmVnRXhwfSlgIDogYmF0Y2hVcmwgKyAnLzppZCc7IFxuICAgICAgICBcbiAgICAgICAgbGV0IGNvbnRyb2xsZXIgPSByZXF1aXJlKGZpbGUpO1xuICAgICAgICBsZXQgaXNPYmogPSBmYWxzZTtcbiAgICBcbiAgICAgICAgaWYgKGNvbnRyb2xsZXIucHJvdG90eXBlIGluc3RhbmNlb2YgQ29udHJvbGxlcikge1xuICAgICAgICAgICAgY29udHJvbGxlciA9IG5ldyBjb250cm9sbGVyKGFwcCk7XG4gICAgICAgICAgICBpc09iaiA9IHRydWU7XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ2ZpbmRNYW55XycpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgYmF0Y2hVcmwsIGlzT2JqID8gY29udHJvbGxlci5maW5kTWFueV8uYmluZChjb250cm9sbGVyKSA6IGNvbnRyb2xsZXIuZmluZE1hbnlfKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ2NyZWF0ZV8nKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3Bvc3QnLCBiYXRjaFVybCwgaXNPYmogPyBjb250cm9sbGVyLmNyZWF0ZV8uYmluZChjb250cm9sbGVyKSA6IGNvbnRyb2xsZXIuY3JlYXRlXyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3B0aW9ucy53aXRoS2V5VmFsdWVQYWlySW5QYXRoICYmIGhhc01ldGhvZChjb250cm9sbGVyLCAnZmluZE9uZUJ5XycpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgYmF0Y2hVcmwgKyAnLzprZXkvOnZhbHVlJywgaXNPYmogPyBjb250cm9sbGVyLmZpbmRPbmVCeV8uYmluZChjb250cm9sbGVyKSA6IGNvbnRyb2xsZXIuZmluZE9uZUJ5Xyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdmaW5kT25lXycpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0Jywgc2luZ2xlVXJsLCBpc09iaiA/IGNvbnRyb2xsZXIuZmluZE9uZV8uYmluZChjb250cm9sbGVyKSA6IGNvbnRyb2xsZXIuZmluZE9uZV8pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAndXBkYXRlT25lXycpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncHV0Jywgc2luZ2xlVXJsLCBpc09iaiA/IGNvbnRyb2xsZXIudXBkYXRlT25lXy5iaW5kKGNvbnRyb2xsZXIpIDogY29udHJvbGxlci51cGRhdGVPbmVfKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ2RlbGV0ZU9uZV8nKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2RlbCcsIHNpbmdsZVVybCwgaXNPYmogPyBjb250cm9sbGVyLmRlbGV0ZU9uZV8uYmluZChjb250cm9sbGVyKSA6IGNvbnRyb2xsZXIuZGVsZXRlT25lXyk7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGFwcC5hZGRSb3V0ZXIocm91dGVyKTtcbn07Il19