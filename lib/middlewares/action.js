"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const _ = Util._;

const {
  InvalidConfiguration
} = require('../utils/Errors');

const Literal = require('../enum/Literal');

const path = require('path');

module.exports = (controllerAction, app) => {
  if (typeof controllerAction !== 'string') {
    throw new InvalidConfiguration('Invalid action syntax.', app);
  }

  let pos = controllerAction.lastIndexOf('.');

  if (pos < 0) {
    throw new InvalidConfiguration(`Unrecognized controller & action syntax: ${controllerAction}.`, app);
  }

  let controller = controllerAction.substr(0, pos);
  let action = controllerAction.substr(pos + 1);
  let controllerBasePath = path.join(app.backendPath, Literal.CONTROLLERS_PATH);
  let controllerPath = path.resolve(controllerBasePath, controller + '.js');

  let ctrl = require(controllerPath);

  let actioner = ctrl[action];

  if (Array.isArray(actioner)) {
    let actionFunction = actioner.concat().pop();

    if (typeof actionFunction !== 'function') {
      throw new InvalidConfiguration(`${controllerAction} does not contain a valid action in returned middleware chain.`, app);
    }

    return actioner.concat(app.wrapAction(actionFunction));
  }

  if (typeof actioner !== 'function') {
    throw new InvalidConfiguration(`${controllerAction} is not a valid action.`, app);
  }

  return app.wrapAction(actioner);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlcy9hY3Rpb24uanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJMaXRlcmFsIiwicGF0aCIsIm1vZHVsZSIsImV4cG9ydHMiLCJjb250cm9sbGVyQWN0aW9uIiwiYXBwIiwicG9zIiwibGFzdEluZGV4T2YiLCJjb250cm9sbGVyIiwic3Vic3RyIiwiYWN0aW9uIiwiY29udHJvbGxlckJhc2VQYXRoIiwiam9pbiIsImJhY2tlbmRQYXRoIiwiQ09OVFJPTExFUlNfUEFUSCIsImNvbnRyb2xsZXJQYXRoIiwicmVzb2x2ZSIsImN0cmwiLCJhY3Rpb25lciIsIkFycmF5IiwiaXNBcnJheSIsImFjdGlvbkZ1bmN0aW9uIiwiY29uY2F0IiwicG9wIiwid3JhcEFjdGlvbiJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFPQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU1DLENBQUMsR0FBR0YsSUFBSSxDQUFDRSxDQUFmOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUEyQkYsT0FBTyxDQUFDLGlCQUFELENBQXhDOztBQUNBLE1BQU1HLE9BQU8sR0FBR0gsT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUVBLE1BQU1JLElBQUksR0FBR0osT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBT0FLLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQixDQUFDQyxnQkFBRCxFQUFtQkMsR0FBbkIsS0FBMkI7QUFDeEMsTUFBSSxPQUFPRCxnQkFBUCxLQUE0QixRQUFoQyxFQUEwQztBQUN0QyxVQUFNLElBQUlMLG9CQUFKLENBQXlCLHdCQUF6QixFQUFtRE0sR0FBbkQsQ0FBTjtBQUNIOztBQUVELE1BQUlDLEdBQUcsR0FBR0YsZ0JBQWdCLENBQUNHLFdBQWpCLENBQTZCLEdBQTdCLENBQVY7O0FBQ0EsTUFBSUQsR0FBRyxHQUFHLENBQVYsRUFBYTtBQUNULFVBQU0sSUFBSVAsb0JBQUosQ0FBMEIsNENBQTJDSyxnQkFBaUIsR0FBdEYsRUFBMEZDLEdBQTFGLENBQU47QUFDSDs7QUFFRCxNQUFJRyxVQUFVLEdBQUdKLGdCQUFnQixDQUFDSyxNQUFqQixDQUF3QixDQUF4QixFQUEyQkgsR0FBM0IsQ0FBakI7QUFDQSxNQUFJSSxNQUFNLEdBQUdOLGdCQUFnQixDQUFDSyxNQUFqQixDQUF3QkgsR0FBRyxHQUFHLENBQTlCLENBQWI7QUFDQSxNQUFJSyxrQkFBa0IsR0FBR1YsSUFBSSxDQUFDVyxJQUFMLENBQVVQLEdBQUcsQ0FBQ1EsV0FBZCxFQUEyQmIsT0FBTyxDQUFDYyxnQkFBbkMsQ0FBekI7QUFFQSxNQUFJQyxjQUFjLEdBQUdkLElBQUksQ0FBQ2UsT0FBTCxDQUFhTCxrQkFBYixFQUFpQ0gsVUFBVSxHQUFHLEtBQTlDLENBQXJCOztBQUNBLE1BQUlTLElBQUksR0FBR3BCLE9BQU8sQ0FBQ2tCLGNBQUQsQ0FBbEI7O0FBRUEsTUFBSUcsUUFBUSxHQUFHRCxJQUFJLENBQUNQLE1BQUQsQ0FBbkI7O0FBRUEsTUFBSVMsS0FBSyxDQUFDQyxPQUFOLENBQWNGLFFBQWQsQ0FBSixFQUE2QjtBQUN6QixRQUFJRyxjQUFjLEdBQUdILFFBQVEsQ0FBQ0ksTUFBVCxHQUFrQkMsR0FBbEIsRUFBckI7O0FBQ0EsUUFBSSxPQUFPRixjQUFQLEtBQTBCLFVBQTlCLEVBQTBDO0FBQ3RDLFlBQU0sSUFBSXRCLG9CQUFKLENBQTBCLEdBQUVLLGdCQUFpQixnRUFBN0MsRUFBOEdDLEdBQTlHLENBQU47QUFDSDs7QUFFRCxXQUFPYSxRQUFRLENBQUNJLE1BQVQsQ0FBZ0JqQixHQUFHLENBQUNtQixVQUFKLENBQWVILGNBQWYsQ0FBaEIsQ0FBUDtBQUNIOztBQUVELE1BQUksT0FBT0gsUUFBUCxLQUFvQixVQUF4QixFQUFvQztBQUNoQyxVQUFNLElBQUluQixvQkFBSixDQUEwQixHQUFFSyxnQkFBaUIseUJBQTdDLEVBQXVFQyxHQUF2RSxDQUFOO0FBQ0g7O0FBRUQsU0FBT0EsR0FBRyxDQUFDbUIsVUFBSixDQUFlTixRQUFmLENBQVA7QUFDSCxDQWpDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKipcbiAqIFJlc3BvbnNlIGFjdGlvbiBhcyBtaWRkbGV3YXJlXG4gKiBAbW9kdWxlIE1pZGRsZXdhcmVfQWN0aW9uXG4gKi9cblxuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCBfID0gVXRpbC5fO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvRXJyb3JzJyk7XG5jb25zdCBMaXRlcmFsID0gcmVxdWlyZSgnLi4vZW51bS9MaXRlcmFsJyk7XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cbi8qKlxuICogQWN0aW9uIG1pZGRsZXdhcmUgY3JlYXRvclxuICogQHBhcmFtIHtzdHJpbmd9IGNvbnRyb2xsZXJBY3Rpb24gXG4gKiBAcGFyYW0ge1JvdXRhYmxlfSBhcHAgXG4gKi9cbm1vZHVsZS5leHBvcnRzID0gKGNvbnRyb2xsZXJBY3Rpb24sIGFwcCkgPT4ge1xuICAgIGlmICh0eXBlb2YgY29udHJvbGxlckFjdGlvbiAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKCdJbnZhbGlkIGFjdGlvbiBzeW50YXguJywgYXBwKTtcbiAgICB9XG5cbiAgICBsZXQgcG9zID0gY29udHJvbGxlckFjdGlvbi5sYXN0SW5kZXhPZignLicpO1xuICAgIGlmIChwb3MgPCAwKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihgVW5yZWNvZ25pemVkIGNvbnRyb2xsZXIgJiBhY3Rpb24gc3ludGF4OiAke2NvbnRyb2xsZXJBY3Rpb259LmAsIGFwcCk7XG4gICAgfVxuXG4gICAgbGV0IGNvbnRyb2xsZXIgPSBjb250cm9sbGVyQWN0aW9uLnN1YnN0cigwLCBwb3MpO1xuICAgIGxldCBhY3Rpb24gPSBjb250cm9sbGVyQWN0aW9uLnN1YnN0cihwb3MgKyAxKTtcbiAgICBsZXQgY29udHJvbGxlckJhc2VQYXRoID0gcGF0aC5qb2luKGFwcC5iYWNrZW5kUGF0aCwgTGl0ZXJhbC5DT05UUk9MTEVSU19QQVRIKTtcblxuICAgIGxldCBjb250cm9sbGVyUGF0aCA9IHBhdGgucmVzb2x2ZShjb250cm9sbGVyQmFzZVBhdGgsIGNvbnRyb2xsZXIgKyAnLmpzJyk7XG4gICAgbGV0IGN0cmwgPSByZXF1aXJlKGNvbnRyb2xsZXJQYXRoKTsgICAgXG5cbiAgICBsZXQgYWN0aW9uZXIgPSBjdHJsW2FjdGlvbl07ICAgXG5cbiAgICBpZiAoQXJyYXkuaXNBcnJheShhY3Rpb25lcikpIHtcbiAgICAgICAgbGV0IGFjdGlvbkZ1bmN0aW9uID0gYWN0aW9uZXIuY29uY2F0KCkucG9wKCk7XG4gICAgICAgIGlmICh0eXBlb2YgYWN0aW9uRnVuY3Rpb24gIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihgJHtjb250cm9sbGVyQWN0aW9ufSBkb2VzIG5vdCBjb250YWluIGEgdmFsaWQgYWN0aW9uIGluIHJldHVybmVkIG1pZGRsZXdhcmUgY2hhaW4uYCwgYXBwKTtcbiAgICAgICAgfSAgICBcblxuICAgICAgICByZXR1cm4gYWN0aW9uZXIuY29uY2F0KGFwcC53cmFwQWN0aW9uKGFjdGlvbkZ1bmN0aW9uKSk7XG4gICAgfSBcblxuICAgIGlmICh0eXBlb2YgYWN0aW9uZXIgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKGAke2NvbnRyb2xsZXJBY3Rpb259IGlzIG5vdCBhIHZhbGlkIGFjdGlvbi5gLCBhcHApO1xuICAgIH0gICAgXG5cbiAgICByZXR1cm4gYXBwLndyYXBBY3Rpb24oYWN0aW9uZXIpO1xufTsiXX0=