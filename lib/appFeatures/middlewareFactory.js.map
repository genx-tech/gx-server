{"version":3,"file":"middlewareFactory.js","names":["_","require","Feature","Enums","InvalidConfiguration","module","exports","type","INIT","load_","app","factories","forOwn","factoryInfo","name","registerMiddlewareFactory","opt","ownerApp","assert","isEmpty","chains","isPlainObject","options","middleware","push","getMiddlewareFactory","Array","isArray","map","middlewareInfo","i","length","undefined"],"sources":["../../src/appFeatures/middlewareFactory.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Enable middleware factory\n * @module Feature_MiddlewareFactory\n * \n * @example\n *   \"middlewareFactory\": {\n *       //new middleware name\n *       \"listOfMiddleware\": {\n *           \"middleware1\": { // options\n *               ...\n *           },\n *           \"middleware2\": { // options\n *               ...\n *           }\n *       },\n *        \"altListOfMiddleware\": [\n *           {\n *               \"name\": \"middleware1\",\n *               \"options\": { ... } \n *           },\n *           [ \"middleware2\", { ... } ],\n *           \"middleware3\"\n *       ]\n *   },\n */\n\nconst { _ } = require('@genx/july');\nconst { Feature } = require('..').Enums;\nconst { InvalidConfiguration } = require('@genx/error');\n\nmodule.exports = {\n    /**\n     * This feature is loaded at init stage\n     * @member {string}\n     */\n    type: Feature.INIT,\n\n    /**\n     * Load the feature\n     * @param {App} app - The app module object\n     * @param {object} factories - Object factories\n     * @returns {Promise.<*>}\n     */\n    load_: (app, factories) => {\n        _.forOwn(factories, (factoryInfo, name) => {\n            app.registerMiddlewareFactory(name, (opt, ownerApp) => { \n                assert: _.isEmpty(opt), `Pre-configured middleware factory \"${name}\" should be used with empty options.`;\n                let chains;\n\n                if (_.isPlainObject(factoryInfo)) {\n                    chains = [];\n    \n                    _.forOwn(factoryInfo, (options, middleware) => {\n                        chains.push(app.getMiddlewareFactory(middleware)(options, ownerApp));\n                    });                    \n                } else if (Array.isArray(factoryInfo)) {\n                    chains = factoryInfo.map((middlewareInfo, i) => {\n                        if (_.isPlainObject(middlewareInfo)) {\n                            if (!middlewareInfo.name) {\n                                throw new InvalidConfiguration(\n                                    'Missing referenced middleware name.',\n                                    app,\n                                    `middlewareFactory.${name}[${i}].name`);\n                            }\n\n                            return app.getMiddlewareFactory(middlewareInfo.name)(middlewareInfo.options, ownerApp);\n                        }\n\n                        if (Array.isArray(middlewareInfo)) {\n                            if (middlewareInfo.length < 1 || middlewareInfo.length > 2 || typeof middlewareInfo[0] !== 'string') {\n                                throw new InvalidConfiguration(\n                                    'Invalid middleware factory item config.',\n                                    app,\n                                    `middlewareFactory.${name}[${i}]`);\n                            }\n\n                            return app.getMiddlewareFactory(middlewareInfo[0])(middlewareInfo.length > 1 ? middlewareInfo[1] : undefined, ownerApp);\n                        }\n\n                        if (typeof middlewareInfo === 'string') {\n                            return app.getMiddlewareFactory(middlewareInfo)(undefined, ownerApp);\n                        }\n\n                        throw new InvalidConfiguration(\n                            'Invalid middleware factory item config.',\n                            app,\n                            `middlewareFactory.${name}[${i}]`);\n                    });\n                } else {\n                    throw new InvalidConfiguration(\n                        'Invalid middleware factory config.',\n                        app,\n                        `middlewareFactory.${name}`);\n                }\n\n                return chains.length === 1 ? chains[0] : chains;\n            });\n        });\n    }\n};"],"mappings":"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"}