{"version":3,"file":"gaml.js","names":["require","path","glob","_","naming","text","Literal","Router","hasMethod","appendId","baseEndpoint","idName","module","exports","app","baseRoute","options","resourcePath","resolve","backendPath","resourcesPath","RESOURCES_PATH","router","prefix","dropIfEndsWith","useMiddleware","getMiddlewareFactory","errorOptions","middlewares","useMiddlewares","join","files","sync","each","filepath","controller","relativePath","relative","dirPath","dirname","entityName","basename","entithNameWithPath","remaps","ensureStartsWith","urlPath","split","map","p","kebabCase","camelCase","endpointWithId","_action","find","bind","_middlewares","__metaMiddlewares","addRoute","post","ctx","findById","params","updateById","deleteById","addRouter"],"sources":["../../src/routers/gaml.js"],"sourcesContent":["\"use strict\";\n\nconst path = require(\"path\");\nconst { glob } = require(\"@genx/sys\");\nconst { _, naming, text } = require(\"@genx/july\");\nconst Literal = require(\"../enum/Literal\");\nconst Router = require(\"@koa/router\");\nconst { hasMethod } = require(\"../utils/Helpers\");\n\n/**\n * Gaml router.\n * @module Router_Gaml\n */\n\nconst appendId = (baseEndpoint, idName) => (idName ? `${baseEndpoint}/:${idName}` : baseEndpoint);\n\n/**\n * Create a gaml router.\n * @param {*} app\n * @param {string} baseRoute\n * @param {objects} options\n * @property {string} [options.resourcesPath]\n * @property {object|array} [options.middlewares]\n * @example\n *  '<base path>': {\n *      gaml: {\n *          resourcesPath:\n *          middlewares:\n *      }\n *  }\n *\n *  route                          http method    function of ctrl\n *  /:resource                     get            find\n *  /:resource                     post           post\n *  /:resource/:id                 get            findById\n *  /:resource/:id                 put            updateById\n *  /:resource/:id                 del            deleteById\n */\nmodule.exports = (app, baseRoute, options) => {\n    let resourcePath = path.resolve(app.backendPath, options.resourcesPath || Literal.RESOURCES_PATH);\n\n    let router = baseRoute === \"/\" ? new Router() : new Router({ prefix: text.dropIfEndsWith(baseRoute, \"/\") });\n\n    app.useMiddleware(router, app.getMiddlewareFactory(\"jsonError\")(options.errorOptions, app), \"jsonError\");\n\n    if (options.middlewares) {\n        app.useMiddlewares(router, options.middlewares);\n    }\n\n    let resourcesPath = path.join(resourcePath, \"**/*.js\");\n    let files = glob.sync(resourcesPath);\n\n    _.each(files, (filepath) => {\n        let controller = require(filepath);\n\n        if (typeof controller === \"function\") {\n            controller = new controller(app);\n\n            const relativePath = path.relative(resourcePath, filepath);\n            const dirPath = path.dirname(relativePath);\n            const entityName = path.basename(relativePath, '.js');\n            const entithNameWithPath = path.join(dirPath, entityName);\n\n            let baseEndpoint;\n            if (options.remaps && entithNameWithPath in options.remaps) {\n                baseEndpoint = text.ensureStartsWith(text.dropIfEndsWith(options.remaps[entithNameWithPath], \"/\"), \"/\");\n            } else {\n                const urlPath = entithNameWithPath.split('/').map(p => naming.kebabCase(p)).join('/');\n                baseEndpoint = text.ensureStartsWith(urlPath, \"/\");\n            }\n\n            let idName = naming.camelCase(entityName) + \"Id\";\n            let endpointWithId = appendId(baseEndpoint, idName);\n\n            if (hasMethod(controller, \"find\")) {\n                const _action = controller.find.bind(controller);\n                const _middlewares = controller.find.__metaMiddlewares;\n                app.addRoute(router, \"get\", baseEndpoint, _middlewares ? [..._middlewares, _action] : _action);\n            }\n\n            if (hasMethod(controller, \"post\")) {\n                const _action = controller.post.bind(controller);\n                const _middlewares = controller.post.__metaMiddlewares;\n                app.addRoute(router, \"post\", baseEndpoint, _middlewares ? [..._middlewares, _action] : _action);\n            }\n\n            if (hasMethod(controller, \"findById\")) {\n                const _action = (ctx) => controller.findById(ctx, ctx.params[idName]);\n                const _middlewares = controller.findById.__metaMiddlewares;\n                app.addRoute(router, \"get\", endpointWithId, _middlewares ? [..._middlewares, _action] : _action);\n            }\n\n            if (hasMethod(controller, \"updateById\")) {\n                const _action = (ctx) => controller.updateById(ctx, ctx.params[idName]);\n                const _middlewares = controller.updateById.__metaMiddlewares;\n                app.addRoute(router, \"put\", endpointWithId, _middlewares ? [..._middlewares, _action] : _action);\n            }\n\n            if (hasMethod(controller, \"deleteById\")) {\n                const _action = (ctx) => controller.deleteById(ctx, ctx.params[idName]);\n                const _middlewares = controller.deleteById.__metaMiddlewares;\n                app.addRoute(router, \"del\", endpointWithId, _middlewares ? [..._middlewares, _action] : _action);\n            }\n        }\n    });\n    app.addRouter(router);\n};\n"],"mappings":"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"}