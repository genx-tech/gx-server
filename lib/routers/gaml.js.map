{"version":3,"file":"gaml.js","names":["path","require","glob","_","naming","text","Literal","Router","hasMethod","appendId","baseEndpoint","idName","module","exports","app","baseRoute","options","resourcePath","resolve","backendPath","resourcesPath","RESOURCES_PATH","router","prefix","dropIfEndsWith","useMiddleware","getMiddlewareFactory","errorOptions","middlewares","useMiddlewares","join","files","sync","each","filepath","controller","relativePath","relative","dirPath","dirname","entityName","basename","entithNameWithPath","remaps","ensureStartsWith","urlPath","split","map","p","kebabCase","camelCase","endpointWithId","_action","find","bind","_middlewares","__metaMiddlewares","addRoute","post","ctx","findById","params","updateById","deleteById","addRouter"],"sources":["../../src/routers/gaml.js"],"sourcesContent":["\"use strict\";\n\nconst path = require(\"path\");\nconst { glob } = require(\"@genx/sys\");\nconst { _, naming, text } = require(\"@genx/july\");\nconst Literal = require(\"../enum/Literal\");\nconst Router = require(\"@koa/router\");\nconst { hasMethod } = require(\"../utils/Helpers\");\n\n/**\n * Gaml router.\n * @module Router_Gaml\n */\n\nconst appendId = (baseEndpoint, idName) => (idName ? `${baseEndpoint}/:${idName}` : baseEndpoint);\n\n/**\n * Create a gaml router.\n * @param {*} app\n * @param {string} baseRoute\n * @param {objects} options\n * @property {string} [options.resourcesPath]\n * @property {object|array} [options.middlewares]\n * @example\n *  '<base path>': {\n *      gaml: {\n *          resourcesPath:\n *          middlewares:\n *      }\n *  }\n *\n *  route                          http method    function of ctrl\n *  /:resource                     get            find\n *  /:resource                     post           post\n *  /:resource/:id                 get            findById\n *  /:resource/:id                 put            updateById\n *  /:resource/:id                 del            deleteById\n */\nmodule.exports = (app, baseRoute, options) => {\n    let resourcePath = path.resolve(app.backendPath, options.resourcesPath || Literal.RESOURCES_PATH);\n\n    let router = baseRoute === \"/\" ? new Router() : new Router({ prefix: text.dropIfEndsWith(baseRoute, \"/\") });\n\n    app.useMiddleware(router, app.getMiddlewareFactory(\"jsonError\")(options.errorOptions, app), \"jsonError\");\n\n    if (options.middlewares) {\n        app.useMiddlewares(router, options.middlewares);\n    }\n\n    let resourcesPath = path.join(resourcePath, \"**/*.js\");\n    let files = glob.sync(resourcesPath);\n\n    _.each(files, (filepath) => {\n        let controller = require(filepath);\n\n        if (typeof controller === \"function\") {\n            controller = new controller(app);\n\n            const relativePath = path.relative(resourcePath, filepath);\n            const dirPath = path.dirname(relativePath);\n            const entityName = path.basename(relativePath, '.js');\n            const entithNameWithPath = path.join(dirPath, entityName);\n\n            let baseEndpoint;\n            if (options.remaps && entithNameWithPath in options.remaps) {\n                baseEndpoint = text.ensureStartsWith(text.dropIfEndsWith(options.remaps[entithNameWithPath], \"/\"), \"/\");\n            } else {\n                const urlPath = entithNameWithPath.split('/').map(p => naming.kebabCase(p)).join('/');\n                baseEndpoint = text.ensureStartsWith(urlPath, \"/\");\n            }\n\n            let idName = naming.camelCase(entityName) + \"Id\";\n            let endpointWithId = appendId(baseEndpoint, idName);\n\n            if (hasMethod(controller, \"find\")) {\n                const _action = controller.find.bind(controller);\n                const _middlewares = controller.find.__metaMiddlewares;\n                app.addRoute(router, \"get\", baseEndpoint, _middlewares ? [..._middlewares, _action] : _action);\n            }\n\n            if (hasMethod(controller, \"post\")) {\n                const _action = controller.post.bind(controller);\n                const _middlewares = controller.post.__metaMiddlewares;\n                app.addRoute(router, \"post\", baseEndpoint, _middlewares ? [..._middlewares, _action] : _action);\n            }\n\n            if (hasMethod(controller, \"findById\")) {\n                const _action = (ctx) => controller.findById(ctx, ctx.params[idName]);\n                const _middlewares = controller.findById.__metaMiddlewares;\n                app.addRoute(router, \"get\", endpointWithId, _middlewares ? [..._middlewares, _action] : _action);\n            }\n\n            if (hasMethod(controller, \"updateById\")) {\n                const _action = (ctx) => controller.updateById(ctx, ctx.params[idName]);\n                const _middlewares = controller.updateById.__metaMiddlewares;\n                app.addRoute(router, \"put\", endpointWithId, _middlewares ? [..._middlewares, _action] : _action);\n            }\n\n            if (hasMethod(controller, \"deleteById\")) {\n                const _action = (ctx) => controller.deleteById(ctx, ctx.params[idName]);\n                const _middlewares = controller.deleteById.__metaMiddlewares;\n                app.addRoute(router, \"del\", endpointWithId, _middlewares ? [..._middlewares, _action] : _action);\n            }\n        }\n    });\n    app.addRouter(router);\n};\n"],"mappings":"AAAA;;;;AAEA,MAAMA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAApB;;AACA,MAAM;EAAEC;AAAF,IAAWD,OAAO,CAAC,WAAD,CAAxB;;AACA,MAAM;EAAEE,CAAF;EAAKC,MAAL;EAAaC;AAAb,IAAsBJ,OAAO,CAAC,YAAD,CAAnC;;AACA,MAAMK,OAAO,GAAGL,OAAO,CAAC,iBAAD,CAAvB;;AACA,MAAMM,MAAM,GAAGN,OAAO,CAAC,aAAD,CAAtB;;AACA,MAAM;EAAEO;AAAF,IAAgBP,OAAO,CAAC,kBAAD,CAA7B;;AAOA,MAAMQ,QAAQ,GAAG,CAACC,YAAD,EAAeC,MAAf,KAA2BA,MAAM,GAAI,GAAED,YAAa,KAAIC,MAAO,EAA9B,GAAkCD,YAApF;;AAwBAE,MAAM,CAACC,OAAP,GAAiB,CAACC,GAAD,EAAMC,SAAN,EAAiBC,OAAjB,KAA6B;EAC1C,IAAIC,YAAY,GAAGjB,IAAI,CAACkB,OAAL,CAAaJ,GAAG,CAACK,WAAjB,EAA8BH,OAAO,CAACI,aAAR,IAAyBd,OAAO,CAACe,cAA/D,CAAnB;EAEA,IAAIC,MAAM,GAAGP,SAAS,KAAK,GAAd,GAAoB,IAAIR,MAAJ,EAApB,GAAmC,IAAIA,MAAJ,CAAW;IAAEgB,MAAM,EAAElB,IAAI,CAACmB,cAAL,CAAoBT,SAApB,EAA+B,GAA/B;EAAV,CAAX,CAAhD;EAEAD,GAAG,CAACW,aAAJ,CAAkBH,MAAlB,EAA0BR,GAAG,CAACY,oBAAJ,CAAyB,WAAzB,EAAsCV,OAAO,CAACW,YAA9C,EAA4Db,GAA5D,CAA1B,EAA4F,WAA5F;;EAEA,IAAIE,OAAO,CAACY,WAAZ,EAAyB;IACrBd,GAAG,CAACe,cAAJ,CAAmBP,MAAnB,EAA2BN,OAAO,CAACY,WAAnC;EACH;;EAED,IAAIR,aAAa,GAAGpB,IAAI,CAAC8B,IAAL,CAAUb,YAAV,EAAwB,SAAxB,CAApB;EACA,IAAIc,KAAK,GAAG7B,IAAI,CAAC8B,IAAL,CAAUZ,aAAV,CAAZ;;EAEAjB,CAAC,CAAC8B,IAAF,CAAOF,KAAP,EAAeG,QAAD,IAAc;IACxB,IAAIC,UAAU,GAAGlC,OAAO,CAACiC,QAAD,CAAxB;;IAEA,IAAI,OAAOC,UAAP,KAAsB,UAA1B,EAAsC;MAClCA,UAAU,GAAG,IAAIA,UAAJ,CAAerB,GAAf,CAAb;MAEA,MAAMsB,YAAY,GAAGpC,IAAI,CAACqC,QAAL,CAAcpB,YAAd,EAA4BiB,QAA5B,CAArB;MACA,MAAMI,OAAO,GAAGtC,IAAI,CAACuC,OAAL,CAAaH,YAAb,CAAhB;MACA,MAAMI,UAAU,GAAGxC,IAAI,CAACyC,QAAL,CAAcL,YAAd,EAA4B,KAA5B,CAAnB;MACA,MAAMM,kBAAkB,GAAG1C,IAAI,CAAC8B,IAAL,CAAUQ,OAAV,EAAmBE,UAAnB,CAA3B;MAEA,IAAI9B,YAAJ;;MACA,IAAIM,OAAO,CAAC2B,MAAR,IAAkBD,kBAAkB,IAAI1B,OAAO,CAAC2B,MAApD,EAA4D;QACxDjC,YAAY,GAAGL,IAAI,CAACuC,gBAAL,CAAsBvC,IAAI,CAACmB,cAAL,CAAoBR,OAAO,CAAC2B,MAAR,CAAeD,kBAAf,CAApB,EAAwD,GAAxD,CAAtB,EAAoF,GAApF,CAAf;MACH,CAFD,MAEO;QACH,MAAMG,OAAO,GAAGH,kBAAkB,CAACI,KAAnB,CAAyB,GAAzB,EAA8BC,GAA9B,CAAkCC,CAAC,IAAI5C,MAAM,CAAC6C,SAAP,CAAiBD,CAAjB,CAAvC,EAA4DlB,IAA5D,CAAiE,GAAjE,CAAhB;QACApB,YAAY,GAAGL,IAAI,CAACuC,gBAAL,CAAsBC,OAAtB,EAA+B,GAA/B,CAAf;MACH;;MAED,IAAIlC,MAAM,GAAGP,MAAM,CAAC8C,SAAP,CAAiBV,UAAjB,IAA+B,IAA5C;MACA,IAAIW,cAAc,GAAG1C,QAAQ,CAACC,YAAD,EAAeC,MAAf,CAA7B;;MAEA,IAAIH,SAAS,CAAC2B,UAAD,EAAa,MAAb,CAAb,EAAmC;QAC/B,MAAMiB,OAAO,GAAGjB,UAAU,CAACkB,IAAX,CAAgBC,IAAhB,CAAqBnB,UAArB,CAAhB;;QACA,MAAMoB,YAAY,GAAGpB,UAAU,CAACkB,IAAX,CAAgBG,iBAArC;QACA1C,GAAG,CAAC2C,QAAJ,CAAanC,MAAb,EAAqB,KAArB,EAA4BZ,YAA5B,EAA0C6C,YAAY,GAAG,CAAC,GAAGA,YAAJ,EAAkBH,OAAlB,CAAH,GAAgCA,OAAtF;MACH;;MAED,IAAI5C,SAAS,CAAC2B,UAAD,EAAa,MAAb,CAAb,EAAmC;QAC/B,MAAMiB,OAAO,GAAGjB,UAAU,CAACuB,IAAX,CAAgBJ,IAAhB,CAAqBnB,UAArB,CAAhB;;QACA,MAAMoB,YAAY,GAAGpB,UAAU,CAACuB,IAAX,CAAgBF,iBAArC;QACA1C,GAAG,CAAC2C,QAAJ,CAAanC,MAAb,EAAqB,MAArB,EAA6BZ,YAA7B,EAA2C6C,YAAY,GAAG,CAAC,GAAGA,YAAJ,EAAkBH,OAAlB,CAAH,GAAgCA,OAAvF;MACH;;MAED,IAAI5C,SAAS,CAAC2B,UAAD,EAAa,UAAb,CAAb,EAAuC;QACnC,MAAMiB,OAAO,GAAIO,GAAD,IAASxB,UAAU,CAACyB,QAAX,CAAoBD,GAApB,EAAyBA,GAAG,CAACE,MAAJ,CAAWlD,MAAX,CAAzB,CAAzB;;QACA,MAAM4C,YAAY,GAAGpB,UAAU,CAACyB,QAAX,CAAoBJ,iBAAzC;QACA1C,GAAG,CAAC2C,QAAJ,CAAanC,MAAb,EAAqB,KAArB,EAA4B6B,cAA5B,EAA4CI,YAAY,GAAG,CAAC,GAAGA,YAAJ,EAAkBH,OAAlB,CAAH,GAAgCA,OAAxF;MACH;;MAED,IAAI5C,SAAS,CAAC2B,UAAD,EAAa,YAAb,CAAb,EAAyC;QACrC,MAAMiB,OAAO,GAAIO,GAAD,IAASxB,UAAU,CAAC2B,UAAX,CAAsBH,GAAtB,EAA2BA,GAAG,CAACE,MAAJ,CAAWlD,MAAX,CAA3B,CAAzB;;QACA,MAAM4C,YAAY,GAAGpB,UAAU,CAAC2B,UAAX,CAAsBN,iBAA3C;QACA1C,GAAG,CAAC2C,QAAJ,CAAanC,MAAb,EAAqB,KAArB,EAA4B6B,cAA5B,EAA4CI,YAAY,GAAG,CAAC,GAAGA,YAAJ,EAAkBH,OAAlB,CAAH,GAAgCA,OAAxF;MACH;;MAED,IAAI5C,SAAS,CAAC2B,UAAD,EAAa,YAAb,CAAb,EAAyC;QACrC,MAAMiB,OAAO,GAAIO,GAAD,IAASxB,UAAU,CAAC4B,UAAX,CAAsBJ,GAAtB,EAA2BA,GAAG,CAACE,MAAJ,CAAWlD,MAAX,CAA3B,CAAzB;;QACA,MAAM4C,YAAY,GAAGpB,UAAU,CAAC4B,UAAX,CAAsBP,iBAA3C;QACA1C,GAAG,CAAC2C,QAAJ,CAAanC,MAAb,EAAqB,KAArB,EAA4B6B,cAA5B,EAA4CI,YAAY,GAAG,CAAC,GAAGA,YAAJ,EAAkBH,OAAlB,CAAH,GAAgCA,OAAxF;MACH;IACJ;EACJ,CApDD;;EAqDAtC,GAAG,CAACkD,SAAJ,CAAc1C,MAAd;AACH,CApED"}