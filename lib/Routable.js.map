{"version":3,"sources":["../src/Routable.js"],"names":["path","require","fs","glob","_","url","urlUtil","text","ApplicationError","InvalidConfiguration","Literal","Koa","mount","Routable","T","constructor","name","options","clientPath","toAbsolutePath","CLIENT_SRC_PATH","publicPath","PUBLIC_PATH","router","use","ctx","next","appModule","on","middlewareDir","join","backendPath","MIDDLEWARES_PATH","existsSync","loadMiddlewaresFrom","start_","middlewareFactoryRegistry","stop_","getBackendAction","actionByPath","lpos","lastIndexOf","Error","controller","substr","method","controllerObj","resolve","error","methodFunc","dir","files","sync","nodir","forEach","file","registerMiddlewareFactory","basename","factoryMethod","pre","log","getMiddlewareFactory","hasOwnProperty","server","npmMiddleware","tryRequire","useMiddlewares","middlewares","middlewareFactory","middleware","middlewareFunctions","isPlainObject","forOwn","push","castArray","each","middlewareEntry","type","undefined","Array","isArray","length","m","useMiddleware","addRoute","route","actions","handlers","_wrapMiddlewareTracer","lastIndex","action","i","middlewareItem","assert","endpoint","opts","prefix","addRouter","nestedRouter","routes","allowedMethods","mountRouter","toWebPath","relativePath","pathOrQuery","query","isObject","pop","unshift","ensureStartsWith","appendQuery","replace","traceMiddlewares","ret","_getFeatureFallbackPath","concat","FEATURES_PATH","module","exports"],"mappings":"AAAA;;;;AAEA,MAAMA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAApB;;AACA,MAAM;AAAEC,EAAAA,EAAF;AAAMC,EAAAA;AAAN,IAAeF,OAAO,CAAC,WAAD,CAA5B;;AACA,MAAM;AAAEG,EAAAA,CAAF;AAAKC,EAAAA,GAAG,EAAEC,OAAV;AAAmBC,EAAAA;AAAnB,IAA4BN,OAAO,CAAC,YAAD,CAAzC;;AACA,MAAM;AAAEO,EAAAA,gBAAF;AAAoBC,EAAAA;AAApB,IAA6CR,OAAO,CAAC,aAAD,CAA1D;;AACA,MAAMS,OAAO,GAAGT,OAAO,CAAC,gBAAD,CAAvB;;AACA,MAAMU,GAAG,GAAGV,OAAO,CAAC,KAAD,CAAnB;;AACA,MAAMW,KAAK,GAAGX,OAAO,CAAC,WAAD,CAArB;;AAEA,MAAMY,QAAQ,GAAGC,CAAC,IAAI,cAAcA,CAAd,CAAgB;AAQlCC,EAAAA,WAAW,CAACC,IAAD,EAAOC,OAAP,EAAgB;AACvB,UAAMD,IAAN,EAAYC,OAAZ;AAMA,SAAKC,UAAL,GAAkB,KAAKC,cAAL,CAAoB,KAAKF,OAAL,CAAaC,UAAb,IAA2BR,OAAO,CAACU,eAAvD,CAAlB;AAMA,SAAKC,UAAL,GAAkB,KAAKF,cAAL,CAAoB,KAAKF,OAAL,CAAaI,UAAb,IAA2BX,OAAO,CAACY,WAAvD,CAAlB;AAMA,SAAKC,MAAL,GAAc,IAAIZ,GAAJ,EAAd;AAGA,SAAKY,MAAL,CAAYC,GAAZ,CAAgB,CAACC,GAAD,EAAMC,IAAN,KAAe;AAC3BD,MAAAA,GAAG,CAACE,SAAJ,GAAgB,IAAhB;AACA,aAAOD,IAAI,EAAX;AACH,KAHD;AAKA,SAAKE,EAAL,CAAQ,cAAR,EAAwB,MAAM;AAE1B,UAAIC,aAAa,GAAG7B,IAAI,CAAC8B,IAAL,CAAU,KAAKC,WAAf,EAA4BrB,OAAO,CAACsB,gBAApC,CAApB;;AAEA,UAAI9B,EAAE,CAAC+B,UAAH,CAAcJ,aAAd,CAAJ,EAAkC;AAC9B,aAAKK,mBAAL,CAAyBL,aAAzB;AACH;AACJ,KAPD;AAQH;;AAEW,QAANM,MAAM,GAAG;AAKX,SAAKC,yBAAL,GAAiC,EAAjC;AAEA,WAAO,MAAMD,MAAN,EAAP;AACH;;AAEU,QAALE,KAAK,GAAG;AACV,WAAO,KAAKD,yBAAZ;AAEA,WAAO,MAAMC,KAAN,EAAP;AACH;;AAEDC,EAAAA,gBAAgB,CAACC,YAAD,EAAe;AAC3B,QAAIC,IAAI,GAAGD,YAAY,CAACE,WAAb,CAAyB,GAAzB,CAAX;;AAEA,QAAID,IAAI,KAAK,CAAC,CAAd,EAAiB;AACb,YAAM,IAAIE,KAAJ,CAAW,wBAAuBH,YAAa,EAA/C,CAAN;AACH;;AAED,QAAII,UAAU,GAAGJ,YAAY,CAACK,MAAb,CAAoB,CAApB,EAAuBJ,IAAvB,CAAjB;AACA,QAAIK,MAAM,GAAGN,YAAY,CAACK,MAAb,CAAoBJ,IAAI,GAAC,CAAzB,CAAb;AACA,QAAIM,aAAJ;;AAEA,QAAI;AACAA,MAAAA,aAAa,GAAG7C,OAAO,CAACD,IAAI,CAAC+C,OAAL,CAAa,KAAKhB,WAAlB,EAA+BY,UAA/B,CAAD,CAAvB;AACH,KAFD,CAEE,OAAOK,KAAP,EAAc;AACZ,YAAM,IAAIN,KAAJ,CAAW,iCAAgCC,UAAW,EAAtD,CAAN;AACH;;AAED,QAAIM,UAAU,GAAGH,aAAa,CAACD,MAAD,CAA9B;;AACA,QAAI,OAAOI,UAAP,KAAsB,UAA1B,EAAsC;AAClC,YAAM,IAAIP,KAAJ,CAAW,2CAA0CH,YAAa,EAAlE,CAAN;AACH;;AAED,WAAOU,UAAP;AACH;;AAMDf,EAAAA,mBAAmB,CAACgB,GAAD,EAAM;AACrB,QAAIC,KAAK,GAAGhD,IAAI,CAACiD,IAAL,CAAUpD,IAAI,CAAC8B,IAAL,CAAUoB,GAAV,EAAe,MAAf,CAAV,EAAkC;AAACG,MAAAA,KAAK,EAAE;AAAR,KAAlC,CAAZ;AACAF,IAAAA,KAAK,CAACG,OAAN,CAAcC,IAAI,IAAI,KAAKC,yBAAL,CAA+BxD,IAAI,CAACyD,QAAL,CAAcF,IAAd,EAAoB,KAApB,CAA/B,EAA2DtD,OAAO,CAACsD,IAAD,CAAlE,CAAtB;AACH;;AAODC,EAAAA,yBAAyB,CAACxC,IAAD,EAAO0C,aAAP,EAAsB;AAC3CC,IAAAA,GAAG,EAAE,OAAOD,aAAP,KAAyB,UAAzB,EAAqC,iCAAiC1C,IAAtE;;AAEL,QAAIA,IAAI,IAAI,KAAKoB,yBAAjB,EAA4C;AACxC,YAAM,IAAI5B,gBAAJ,CAAqB,iBAAgBQ,IAAhB,GAAsB,uBAA3C,CAAN;AACH;;AAED,SAAKoB,yBAAL,CAA+BpB,IAA/B,IAAuC0C,aAAvC;AACA,SAAKE,GAAL,CAAS,SAAT,EAAqB,gCAA+B5C,IAAK,IAAzD;AACH;;AAOD6C,EAAAA,oBAAoB,CAAC7C,IAAD,EAAO;AACvB,QAAI,KAAKoB,yBAAL,CAA+B0B,cAA/B,CAA8C9C,IAA9C,CAAJ,EAAyD;AACrD,aAAO,KAAKoB,yBAAL,CAA+BpB,IAA/B,CAAP;AACH;;AAED,QAAI,KAAK+C,MAAL,IAAe,KAAKA,MAAL,KAAgB,IAAnC,EAAyC;AACrC,aAAO,KAAKA,MAAL,CAAYF,oBAAZ,CAAiC7C,IAAjC,CAAP;AACH;;AAED,QAAIgD,aAAa,GAAG,KAAKC,UAAL,CAAgBjD,IAAhB,CAApB;;AACA,QAAIgD,aAAJ,EAAmB;AACf,aAAOA,aAAP;AACH;;AAED,UAAM,IAAIxD,gBAAJ,CAAsB,wCAAuCQ,IAAK,IAAlE,CAAN;AACH;;AAQDkD,EAAAA,cAAc,CAAC3C,MAAD,EAAS4C,WAAT,EAAsB;AAChC,QAAIC,iBAAJ,EAAuBC,UAAvB;AACA,QAAIC,mBAAmB,GAAG,EAA1B;;AAEA,QAAIlE,CAAC,CAACmE,aAAF,CAAgBJ,WAAhB,CAAJ,EAAkC;AAC9B/D,MAAAA,CAAC,CAACoE,MAAF,CAASL,WAAT,EAAsB,CAAClD,OAAD,EAAUD,IAAV,KAAmB;AACrCoD,QAAAA,iBAAiB,GAAG,KAAKP,oBAAL,CAA0B7C,IAA1B,CAApB;AACAqD,QAAAA,UAAU,GAAGD,iBAAiB,CAACnD,OAAD,EAAU,IAAV,CAA9B;AACAqD,QAAAA,mBAAmB,CAACG,IAApB,CAAyB;AAAEzD,UAAAA,IAAF;AAAQqD,UAAAA;AAAR,SAAzB;AACH,OAJD;AAKH,KAND,MAMO;AACHF,MAAAA,WAAW,GAAG/D,CAAC,CAACsE,SAAF,CAAYP,WAAZ,CAAd;;AAEA/D,MAAAA,CAAC,CAACuE,IAAF,CAAOR,WAAP,EAAoBS,eAAe,IAAI;AACnC,YAAIC,IAAI,GAAG,OAAOD,eAAlB;;AAEA,YAAIC,IAAI,KAAK,QAAb,EAAuB;AAEnBT,UAAAA,iBAAiB,GAAG,KAAKP,oBAAL,CAA0Be,eAA1B,CAApB;AACAP,UAAAA,UAAU,GAAGD,iBAAiB,CAACU,SAAD,EAAY,IAAZ,CAA9B;AACAR,UAAAA,mBAAmB,CAACG,IAApB,CAAyB;AAAEzD,YAAAA,IAAI,EAAE4D,eAAR;AAA0BP,YAAAA;AAA1B,WAAzB;AACH,SALD,MAKO,IAAIQ,IAAI,KAAK,UAAb,EAAyB;AAC5BP,UAAAA,mBAAmB,CAACG,IAApB,CAAyB;AAAEzD,YAAAA,IAAI,EAAE4D,eAAe,CAAC5D,IAAhB,IAAwB,mBAAhC;AAAqDqD,YAAAA,UAAU,EAAEO;AAAjE,WAAzB;AACH,SAFM,MAEA,IAAIG,KAAK,CAACC,OAAN,CAAcJ,eAAd,CAAJ,EAAoC;AAEvC,cAAIA,eAAe,CAACK,MAAhB,KAA2B,CAA/B,EAAkC;AAC9B,kBAAM,IAAIxE,oBAAJ,CACF,wCADE,EAEF,IAFE,EAGF,aAHE,CAAN;AAKH;;AAED2D,UAAAA,iBAAiB,GAAG,KAAKP,oBAAL,CAA0Be,eAAe,CAAC,CAAD,CAAzC,CAApB;AACAP,UAAAA,UAAU,GAAGD,iBAAiB,CAACQ,eAAe,CAACK,MAAhB,GAAyB,CAAzB,GAA6BL,eAAe,CAAC,CAAD,CAA5C,GAAkD,IAAnD,EAAyD,IAAzD,CAA9B;AACAN,UAAAA,mBAAmB,CAACG,IAApB,CAAyB;AAAEzD,YAAAA,IAAI,EAAE4D,eAAe,CAAC,CAAD,CAAvB;AAA4BP,YAAAA;AAA5B,WAAzB;AACH,SAbM,MAaA;AACH,cAAI,CAACjE,CAAC,CAACmE,aAAF,CAAgBK,eAAhB,CAAD,IAAqC,EAAE,UAAUA,eAAZ,CAAzC,EAAuE;AACnE,kBAAM,IAAInE,oBAAJ,CACF,2BADE,EAEF,IAFE,EAGF,aAHE,CAAN;AAKH;;AAED2D,UAAAA,iBAAiB,GAAG,KAAKP,oBAAL,CAA0Be,eAAe,CAAC5D,IAA1C,CAApB;AACAqD,UAAAA,UAAU,GAAGD,iBAAiB,CAACQ,eAAe,CAAC3D,OAAjB,EAA0B,IAA1B,CAA9B;AACAqD,UAAAA,mBAAmB,CAACG,IAApB,CAAyB;AAAEzD,YAAAA,IAAI,EAAE4D,eAAe,CAAC5D,IAAxB;AAA8BqD,YAAAA;AAA9B,WAAzB;AACH;AACJ,OApCD;AAqCH;;AAEDC,IAAAA,mBAAmB,CAAChB,OAApB,CAA4B,CAAC;AAAEtC,MAAAA,IAAF;AAAQqD,MAAAA;AAAR,KAAD,KAA0B;AAClD,UAAIU,KAAK,CAACC,OAAN,CAAcX,UAAd,CAAJ,EAA+B;AAC3BA,QAAAA,UAAU,CAACf,OAAX,CAAmB4B,CAAC,IAAI,KAAKC,aAAL,CAAmB5D,MAAnB,EAA2B2D,CAA3B,EAA8BlE,IAA9B,CAAxB;AACH,OAFD,MAEO;AACH,aAAKmE,aAAL,CAAmB5D,MAAnB,EAA2B8C,UAA3B,EAAuCrD,IAAvC;AACH;AACJ,KAND;AAQA,WAAO,IAAP;AACH;;AASDoE,EAAAA,QAAQ,CAAC7D,MAAD,EAASsB,MAAT,EAAiBwC,KAAjB,EAAwBC,OAAxB,EAAiC;AACrC,QAAIC,QAAQ,GAAG,EAAf;AAAA,QAAmBnB,iBAAnB;;AAEA,QAAIhE,CAAC,CAACmE,aAAF,CAAgBe,OAAhB,CAAJ,EAA8B;AAC1BlF,MAAAA,CAAC,CAACoE,MAAF,CAASc,OAAT,EAAkB,CAACrE,OAAD,EAAUD,IAAV,KAAmB;AACjCoD,QAAAA,iBAAiB,GAAG,KAAKP,oBAAL,CAA0B7C,IAA1B,CAApB;AACAuE,QAAAA,QAAQ,CAACd,IAAT,CAAc,KAAKe,qBAAL,CAA2BpB,iBAAiB,CAACnD,OAAD,EAAU,IAAV,CAA5C,EAA6DD,IAA7D,CAAd;AACH,OAHD;AAIH,KALD,MAKO;AACHsE,MAAAA,OAAO,GAAGlF,CAAC,CAACsE,SAAF,CAAYY,OAAZ,CAAV;AACA,UAAIG,SAAS,GAAGH,OAAO,CAACL,MAAR,GAAiB,CAAjC;;AAEA7E,MAAAA,CAAC,CAACuE,IAAF,CAAOW,OAAP,EAAgB,CAACI,MAAD,EAASC,CAAT,KAAe;AAC3B,YAAId,IAAI,GAAG,OAAOa,MAAlB;;AAEA,YAAIC,CAAC,KAAKF,SAAV,EAAqB;AAEjB,cAAIZ,IAAI,KAAK,QAAT,IAAqBa,MAAM,CAACjD,WAAP,CAAmB,GAAnB,IAA0B,CAAnD,EAAsD;AAClDiD,YAAAA,MAAM,GAAG;AACL1E,cAAAA,IAAI,EAAE,QADD;AAELC,cAAAA,OAAO,EAAEyE;AAFJ,aAAT;AAKAb,YAAAA,IAAI,GAAG,QAAP;AACH;AACJ;;AAED,YAAIA,IAAI,KAAK,QAAb,EAAuB;AAEnBT,UAAAA,iBAAiB,GAAG,KAAKP,oBAAL,CAA0B6B,MAA1B,CAApB;AAEA,cAAIrB,UAAU,GAAGD,iBAAiB,CAAC,IAAD,EAAO,IAAP,CAAlC;;AAGA,cAAIW,KAAK,CAACC,OAAN,CAAcX,UAAd,CAAJ,EAA+B;AAC3BA,YAAAA,UAAU,CAACf,OAAX,CAAmB,CAACsC,cAAD,EAAiBD,CAAjB,KAAuBJ,QAAQ,CAACd,IAAT,CACtC,KAAKe,qBAAL,CAA2BI,cAA3B,EAA4C,GAAEF,MAAO,IAAGC,CAAE,EAAf,IAAoBtB,UAAU,CAACrD,IAAX,GAAmB,MAAMqD,UAAU,CAACrD,IAApC,GAA4C,EAAhE,CAA3C,CADsC,CAA1C;AAGH,WAJD,MAIO;AACHuE,YAAAA,QAAQ,CAACd,IAAT,CAAc,KAAKe,qBAAL,CAA2BnB,UAA3B,EAAuCqB,MAAvC,CAAd;AACH;AACJ,SAdD,MAcO,IAAIb,IAAI,KAAK,UAAb,EAAyB;AAC5BU,UAAAA,QAAQ,CAACd,IAAT,CAAc,KAAKe,qBAAL,CAA2BE,MAA3B,CAAd;AACH,SAFM,MAEA,IAAIX,KAAK,CAACC,OAAN,CAAcU,MAAd,CAAJ,EAA2B;AAC9BG,UAAAA,MAAM,EAAEH,MAAM,CAACT,MAAP,GAAgB,CAAhB,IAAqBS,MAAM,CAACT,MAAP,IAAiB,CAAtC,EAAyC,0BAAzC;;AAERb,UAAAA,iBAAiB,GAAG,KAAKP,oBAAL,CAA0B6B,MAAM,CAAC,CAAD,CAAhC,CAApB;AACAH,UAAAA,QAAQ,CAACd,IAAT,CAAc,KAAKe,qBAAL,CAA2BpB,iBAAiB,CAACsB,MAAM,CAACT,MAAP,GAAgB,CAAhB,GAAoBS,MAAM,CAAC,CAAD,CAA1B,GAAgCZ,SAAjC,EAA4C,IAA5C,CAA5C,CAAd;AACH,SALM,MAKA;AACHe,UAAAA,MAAM,EAAEzF,CAAC,CAACmE,aAAF,CAAgBmB,MAAhB,KAA2B,UAAUA,MAArC,EAA6C,0BAA7C;;AAERtB,UAAAA,iBAAiB,GAAG,KAAKP,oBAAL,CAA0B6B,MAAM,CAAC1E,IAAjC,CAApB;AACAuE,UAAAA,QAAQ,CAACd,IAAT,CAAc,KAAKe,qBAAL,CAA2BpB,iBAAiB,CAACsB,MAAM,CAACzE,OAAR,EAAiB,IAAjB,CAA5C,EAAoEyE,MAAM,CAAC1E,IAA3E,CAAd;AACH;AACJ,OA1CD;AA2CH;;AAEDO,IAAAA,MAAM,CAACsB,MAAD,CAAN,CAAewC,KAAf,EAAsB,GAAGE,QAAzB;AAEA,QAAIO,QAAQ,GAAGvE,MAAM,CAACwE,IAAP,CAAYC,MAAZ,GAAqB1F,OAAO,CAACwB,IAAR,CAAa,KAAKuD,KAAlB,EAAyB9D,MAAM,CAACwE,IAAP,CAAYC,MAArC,EAA6CX,KAA7C,CAArB,GAA2E/E,OAAO,CAACwB,IAAR,CAAa,KAAKuD,KAAlB,EAAyBA,KAAzB,CAA1F;AAEA,SAAKzB,GAAL,CAAS,SAAT,EAAqB,UAASf,MAAO,IAAGiD,QAAS,2BAA0B,KAAK9E,IAAK,IAArF;AAEA,WAAO,IAAP;AACH;;AAMDiF,EAAAA,SAAS,CAACC,YAAD,EAAe;AACpB,SAAK3E,MAAL,CAAYC,GAAZ,CAAgB0E,YAAY,CAACC,MAAb,EAAhB;AACA,SAAK5E,MAAL,CAAYC,GAAZ,CAAgB0E,YAAY,CAACE,cAAb,EAAhB;AAIA,WAAO,IAAP;AACH;;AAODC,EAAAA,WAAW,CAAChB,KAAD,EAAQ9D,MAAR,EAAgB;AACvB,SAAKA,MAAL,CAAYC,GAAZ,CAAgBZ,KAAK,CAACyE,KAAD,EAAQ9D,MAAR,CAArB;AACH;;AAQD+E,EAAAA,SAAS,CAACC,YAAD,EAAe,GAAGC,WAAlB,EAA+B;AACpC,QAAInG,GAAJ,EAASoG,KAAT;;AAEA,QAAID,WAAW,IAAIA,WAAW,CAACvB,MAAZ,GAAqB,CAApC,KAA0CuB,WAAW,CAACvB,MAAZ,GAAqB,CAArB,IAA0BuB,WAAW,CAAC,CAAD,CAAX,KAAmB1B,SAAvF,CAAJ,EAAuG;AACnG,UAAI1E,CAAC,CAACsG,QAAF,CAAWF,WAAW,CAACA,WAAW,CAACvB,MAAZ,GAAqB,CAAtB,CAAtB,CAAJ,EAAqD;AACjDwB,QAAAA,KAAK,GAAGD,WAAW,CAACG,GAAZ,EAAR;AACH;;AACDH,MAAAA,WAAW,CAACI,OAAZ,CAAoBL,YAApB;AACAlG,MAAAA,GAAG,GAAGC,OAAO,CAACwB,IAAR,CAAa,KAAKuD,KAAlB,EAAyB,GAAGmB,WAA5B,CAAN;AACH,KAND,MAMO;AACHnG,MAAAA,GAAG,GAAGC,OAAO,CAACwB,IAAR,CAAa,KAAKuD,KAAlB,EAAyBkB,YAAzB,CAAN;AACH;;AAEDlG,IAAAA,GAAG,GAAGE,IAAI,CAACsG,gBAAL,CAAsBxG,GAAtB,EAA2B,GAA3B,CAAN;;AAEA,QAAIoG,KAAJ,EAAW;AACPpG,MAAAA,GAAG,GAAGC,OAAO,CAACwG,WAAR,CAAoBzG,GAApB,EAAyBoG,KAAzB,CAAN;AACApG,MAAAA,GAAG,GAAGA,GAAG,CAAC0G,OAAJ,CAAY,IAAZ,EAAkB,GAAlB,CAAN;AACH;;AAED,WAAO1G,GAAP;AACH;;AAED8E,EAAAA,aAAa,CAAC5D,MAAD,EAAS8C,UAAT,EAAqBrD,IAArB,EAA2B;AACpC6E,IAAAA,MAAM,EAAE,OAAOxB,UAAP,KAAsB,UAAtB,EAAkCA,UAAlC;;AACR9C,IAAAA,MAAM,CAACC,GAAP,CAAW,KAAKgE,qBAAL,CAA2BnB,UAA3B,EAAuCrD,IAAvC,CAAX;AACA,SAAK4C,GAAL,CAAS,SAAT,EAAqB,wBAAuB5C,IAAK,IAAjD;AACH;;AAEDwE,EAAAA,qBAAqB,CAACnB,UAAD,EAAarD,IAAb,EAAmB;AACpC,QAAI,KAAKC,OAAL,CAAa+F,gBAAjB,EAAmC;AAC/B,aAAO,OAAOvF,GAAP,EAAYC,IAAZ,KAAqB;AACxB,aAAKkC,GAAL,CAAS,OAAT,EAAmB,uBAAsB5C,IAAI,IAAIqD,UAAU,CAACrD,IAAK,OAAjE;AACA,YAAIiG,GAAG,GAAG,MAAM5C,UAAU,CAAC5C,GAAD,EAAMC,IAAN,CAA1B;AACA,aAAKkC,GAAL,CAAS,OAAT,EAAmB,6BAA4B5C,IAAI,IAAIqD,UAAU,CAACrD,IAAK,IAAvE;AACA,eAAOiG,GAAP;AACH,OALD;AAMH;;AAED,WAAO5C,UAAP;AACH;;AAED6C,EAAAA,uBAAuB,GAAG;AACtB,WAAO,MAAMA,uBAAN,GAAgCC,MAAhC,CAAuC,CAAEnH,IAAI,CAAC8B,IAAL,CAAU,KAAKC,WAAf,EAA4BrB,OAAO,CAAC0G,aAApC,CAAF,CAAvC,CAAP;AACH;;AA3ViC,CAAtC;;AA8VAC,MAAM,CAACC,OAAP,GAAiBzG,QAAjB","sourcesContent":["\"use strict\";\n\nconst path = require('path');\nconst { fs, glob } = require('@genx/sys');\nconst { _, url: urlUtil, text } = require('@genx/july');\nconst { ApplicationError, InvalidConfiguration } = require('@genx/error');\nconst Literal = require('./enum/Literal');\nconst Koa = require('koa');\nconst mount = require('koa-mount');\n\nconst Routable = T => class extends T {    \n    /**     \n     * @param {string} name - The name of the routable instance.     \n     * @param {object} [options] - Routable options               \n     * @property {string} [options.backendPath='server'] - Relative path of back-end server source files\n     * @property {string} [options.clientPath='client'] - Relative path of front-end client source files     \n     * @property {string} [options.publicPath='public'] - Relative path of front-end static files \n     */         \n    constructor(name, options) {\n        super(name, options);        \n\n        /**\n         * Frontend source files path.\n         * @member {string}\n         **/\n        this.clientPath = this.toAbsolutePath(this.options.clientPath || Literal.CLIENT_SRC_PATH);\n\n        /**\n         * Frontend static files path.\n         * @member {string}\n         **/\n        this.publicPath = this.toAbsolutePath(this.options.publicPath || Literal.PUBLIC_PATH);\n\n        /**\n         * Each app has its own router.\n         * @member {Koa}\n         **/\n        this.router = new Koa();\n\n        //inject the appModule instance in the first middleware\n        this.router.use((ctx, next) => { \n            ctx.appModule = this; \n            return next(); \n        });\n\n        this.on('configLoaded', () => {\n            //load middlewares if exists in server or app path\n            let middlewareDir = path.join(this.backendPath, Literal.MIDDLEWARES_PATH);\n            \n            if (fs.existsSync(middlewareDir)) {\n                this.loadMiddlewaresFrom(middlewareDir);\n            }            \n        });  \n    }\n\n    async start_() {\n        /**\n         * Middleware factory registry.\n         * @member {object}\n         */\n        this.middlewareFactoryRegistry = {};\n\n        return super.start_();\n    }\n\n    async stop_() {\n        delete this.middlewareFactoryRegistry;\n\n        return super.stop_();\n    }\n\n    getBackendAction(actionByPath) {\n        let lpos = actionByPath.lastIndexOf('.');\n\n        if (lpos === -1) {\n            throw new Error(`Invalid action path: ${actionByPath}`);\n        }\n\n        let controller = actionByPath.substr(0, lpos);\n        let method = actionByPath.substr(lpos+1);\n        let controllerObj;\n\n        try {\n            controllerObj = require(path.resolve(this.backendPath, controller));\n        } catch (error) {\n            throw new Error(`Backend controller not found: ${controller}`);\n        }       \n\n        let methodFunc = controllerObj[method];\n        if (typeof methodFunc !== 'function') {\n            throw new Error(`The specified action is not a function: ${actionByPath}`);\n        }\n\n        return methodFunc;\n    }\n\n    /**\n     * Load and regsiter middleware files from a specified path.\n     * @param dir\n     */\n    loadMiddlewaresFrom(dir) {\n        let files = glob.sync(path.join(dir, '*.js'), {nodir: true});\n        files.forEach(file => this.registerMiddlewareFactory(path.basename(file, '.js'), require(file)));\n    }\n\n    /**\n     * Register the factory method of a named middleware.     \n     * @param {string} name - The name of the middleware \n     * @param {function} factoryMethod - The factory method of a middleware\n     */\n    registerMiddlewareFactory(name, factoryMethod) {\n        pre: typeof factoryMethod === 'function', 'Invalid middleware factory: ' + name;        \n\n        if (name in this.middlewareFactoryRegistry) {\n            throw new ApplicationError('Middleware \"'+ name +'\" already registered!');\n        }\n\n        this.middlewareFactoryRegistry[name] = factoryMethod;\n        this.log('verbose', `Registered named middleware [${name}].`);\n    }\n\n    /**\n     * Get the factory method of a middleware from module hierarchy.     \n     * @param name\n     * @returns {function}\n     */\n    getMiddlewareFactory(name) {\n        if (this.middlewareFactoryRegistry.hasOwnProperty(name)) {\n            return this.middlewareFactoryRegistry[name];\n        }\n\n        if (this.server && this.server !== this) {\n            return this.server.getMiddlewareFactory(name);\n        }\n\n        let npmMiddleware = this.tryRequire(name);\n        if (npmMiddleware) {\n            return npmMiddleware;\n        }\n\n        throw new ApplicationError(`Don't know where to load middleware \"${name}\".`);\n    }\n\n    /**\n     * Use middlewares\n     * @param {Router} router\n     * @param {*} middlewares - Can be an array of middleware entries or a key-value list of registerred middlewares\n     * @returns {Routable}\n     */\n    useMiddlewares(router, middlewares) {\n        let middlewareFactory, middleware;\n        let middlewareFunctions = [];\n        \n        if (_.isPlainObject(middlewares)) {\n            _.forOwn(middlewares, (options, name) => {\n                middlewareFactory = this.getMiddlewareFactory(name);   \n                middleware = middlewareFactory(options, this);\n                middlewareFunctions.push({ name, middleware });                \n            });\n        } else {\n            middlewares = _.castArray(middlewares);          \n        \n            _.each(middlewares, middlewareEntry => {\n                let type = typeof middlewareEntry;\n\n                if (type === 'string') {\n                    // [ 'namedMiddleware' ]\n                    middlewareFactory = this.getMiddlewareFactory(middlewareEntry);\n                    middleware = middlewareFactory(undefined, this);\n                    middlewareFunctions.push({ name: middlewareEntry , middleware });\n                } else if (type === 'function') {\n                    middlewareFunctions.push({ name: middlewareEntry.name || 'unamed middleware', middleware: middlewareEntry});\n                } else if (Array.isArray(middlewareEntry)) {\n                    // [ [ 'namedMiddleware', config ] ]\n                    if (middlewareEntry.length === 0) {\n                        throw new InvalidConfiguration(\n                            'Empty array found as middleware entry!',\n                            this,\n                            'middlewares'\n                        );\n                    }\n\n                    middlewareFactory = this.getMiddlewareFactory(middlewareEntry[0]);\n                    middleware = middlewareFactory(middlewareEntry.length > 1 ? middlewareEntry[1] : null, this);\n                    middlewareFunctions.push({ name: middlewareEntry[0], middleware });\n                } else {\n                    if (!_.isPlainObject(middlewareEntry) || !('name' in middlewareEntry)) {\n                        throw new InvalidConfiguration(\n                            'Invalid middleware entry!',\n                            this,\n                            'middlewares'\n                        );\n                    }\n\n                    middlewareFactory = this.getMiddlewareFactory(middlewareEntry.name);\n                    middleware = middlewareFactory(middlewareEntry.options, this);\n                    middlewareFunctions.push({ name: middlewareEntry.name, middleware });\n                }\n            });\n        } \n        \n        middlewareFunctions.forEach(({ name, middleware }) => {            \n            if (Array.isArray(middleware)) {\n                middleware.forEach(m => this.useMiddleware(router, m, name));\n            } else {\n                this.useMiddleware(router, middleware, name);\n            }            \n        });        \n\n        return this;\n    }\n\n    /**\n     * Add a route to a router, skipped while the server running in deaf mode.     \n     * @param router\n     * @param method\n     * @param route\n     * @param actions\n     */\n    addRoute(router, method, route, actions) {\n        let handlers = [], middlewareFactory;\n\n        if (_.isPlainObject(actions)) {\n            _.forOwn(actions, (options, name) => {\n                middlewareFactory = this.getMiddlewareFactory(name);\n                handlers.push(this._wrapMiddlewareTracer(middlewareFactory(options, this), name));\n            });\n        } else {\n            actions = _.castArray(actions);\n            let lastIndex = actions.length - 1;\n\n            _.each(actions, (action, i) => {\n                let type = typeof action;\n\n                if (i === lastIndex) {\n                    // last middleware may be an action\n                    if (type === 'string' && action.lastIndexOf('.') > 0) {\n                        action = {\n                            name: 'action',\n                            options: action\n                        };\n\n                        type = 'object';\n                    }    \n                }\n\n                if (type === 'string') {\n                    // [ 'namedMiddleware' ]\n                    middlewareFactory = this.getMiddlewareFactory(action);   \n\n                    let middleware = middlewareFactory(null, this);\n\n                    //in case it's register by the middlewareFactory feature\n                    if (Array.isArray(middleware)) {\n                        middleware.forEach((middlewareItem, i) => handlers.push(\n                            this._wrapMiddlewareTracer(middlewareItem, `${action}-${i}` + (middleware.name ? ('-' + middleware.name) : ''))\n                        ));\n                    } else {                    \n                        handlers.push(this._wrapMiddlewareTracer(middleware, action));\n                    }\n                } else if (type === 'function') {\n                    handlers.push(this._wrapMiddlewareTracer(action));\n                } else if (Array.isArray(action)) {\n                    assert: action.length > 0 && action.length <= 2, 'Invalid middleware entry';\n\n                    middlewareFactory = this.getMiddlewareFactory(action[0]);                    \n                    handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.length > 1 ? action[1] : undefined, this)));                    \n                } else {\n                    assert: _.isPlainObject(action) && 'name' in action, 'Invalid middleware entry';\n\n                    middlewareFactory = this.getMiddlewareFactory(action.name);                    \n                    handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.options, this), action.name));\n                }\n            })\n        }\n\n        router[method](route, ...handlers);\n\n        let endpoint = router.opts.prefix ? urlUtil.join(this.route, router.opts.prefix, route) : urlUtil.join(this.route, route);\n\n        this.log('verbose', `Route \"${method}:${endpoint}\" is added from module [${this.name}].`);\n\n        return this;\n    }    \n\n    /**\n     * Attach a router to this app module, skipped while the server running in deaf mode     \n     * @param {Router} nestedRouter\n     */\n    addRouter(nestedRouter) {\n        this.router.use(nestedRouter.routes());\n        this.router.use(nestedRouter.allowedMethods());\n\n        //for debugging all registered routes\n        //console.log(nestedRouter.stack.map(i => i.path));\n        return this;\n    }\n\n    /**\n     * Attach a router to this app module by mounting the router to a route\n     * @param {*} route \n     * @param {*} router \n     */\n    mountRouter(route, router) {\n        this.router.use(mount(route, router));\n    }\n\n    /**\n     * Translate a relative path and query parameters if any to a url path     \n     * @param {string} relativePath - Relative path\n     * @param {...*} [pathOrQuery] - Queries\n     * @returns {string}\n     */\n    toWebPath(relativePath, ...pathOrQuery) {\n        let url, query;\n\n        if (pathOrQuery && pathOrQuery.length > 0 && (pathOrQuery.length > 1 || pathOrQuery[0] !== undefined)) {\n            if (_.isObject(pathOrQuery[pathOrQuery.length - 1])) {\n                query = pathOrQuery.pop();\n            }\n            pathOrQuery.unshift(relativePath);\n            url = urlUtil.join(this.route, ...pathOrQuery);\n        } else {\n            url = urlUtil.join(this.route, relativePath);\n        }\n\n        url = text.ensureStartsWith(url, '/');\n\n        if (query) {\n            url = urlUtil.appendQuery(url, query);\n            url = url.replace('/?', '?');\n        }\n\n        return url;\n    }   \n\n    useMiddleware(router, middleware, name) {          \n        assert: typeof middleware === 'function', middleware;\n        router.use(this._wrapMiddlewareTracer(middleware, name));\n        this.log('verbose', `Attached middleware [${name}].`);\n    }\n\n    _wrapMiddlewareTracer(middleware, name) {        \n        if (this.options.traceMiddlewares) {            \n            return async (ctx, next) => {                \n                this.log('debug', `Step in middleware \"${name || middleware.name}\" ...`);                \n                let ret = await middleware(ctx, next);\n                this.log('debug', `Step out from middleware \"${name || middleware.name}\".`);                \n                return ret;\n            }\n        }\n\n        return middleware;\n    }\n\n    _getFeatureFallbackPath() {\n        return super._getFeatureFallbackPath().concat([ path.join(this.backendPath, Literal.FEATURES_PATH) ]);\n    }\n};\n\nmodule.exports = Routable;"],"file":"Routable.js"}