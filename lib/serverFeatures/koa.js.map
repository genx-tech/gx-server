{"version":3,"file":"koa.js","names":["require","_","validator","InvalidConfiguration","Feature","module","exports","type","SERVICE","load_","server","options","koa","router","env","proxy","trustProxy","toBoolean","subdomainOffset","appModule","keys","isArray","on","err","ctx","extra","pick","request","app","name","status","stack","log","message","logError","httpServer","createServer","callback","port","httpPort","listen","address","host","family","emit"],"sources":["../../src/serverFeatures/koa.js"],"sourcesContent":["\"use strict\";\n\nconst { _ } = require('@genx/july');\nconst validator = require('validator');\nconst { InvalidConfiguration } = require('@genx/error');\nconst Feature = require('@genx/app/lib/enum/Feature');\n\n/**\n * Koa middleware function\n * @callback KoaActionFunction\n * @async\n * @param {object} ctx - The koa request and response context. [See koajs about ctx details]{@link http://koajs.com/#context}\n * @property {object} ctx.reqeust - The koa request object.\n * @property {object} ctx.response - The koa response object.\n * @param {KoaActionFunction} [next] - Next middleware or action.\n */\n\n/**\n * Enable koa-based web engine.\n * @module Feature_Koa \n */\n\nmodule.exports = {\n\n    /**\n     * This feature is loaded at service stage\n     * @member {string}\n     */\n    type: Feature.SERVICE,\n\n    /**\n     * Load the feature\n     * @param {WebServer} server - The web server\n     * @param {object} options - Options for the feature     \n     * @property {bool} [options.trustProxy] - When true proxy header fields will be trusted\n     * @property {Array.<string>} [options.keys] - Set signed cookie keys\n     * @property {int} [options.httpPort] - The http port number\n     * @property {int} [options.subdomainOffset=2] - The offset of subdomains to ignore, default: 2\n     * @returns {Promise.<*>}\n     */\n    load_: function (server, options) {\n        let koa = server.router;\n        server.koa = koa;\n        \n        koa.env = server.env;\n        koa.proxy = options.trustProxy && validator.toBoolean(options.trustProxy);\n\n        if (('subdomainOffset' in options) && options.subdomainOffset !== 2) {\n            if (options.subdomainOffset < 2) {\n                throw new InvalidConfiguration(\n                    'Invalid subdomainOffset. Should be larger or equal to 2.',\n                    appModule,\n                    'koa.subdomainOffset'\n                );\n            }\n\n            koa.subdomainOffset = options.subdomainOffset;\n        }\n\n        if (options.keys) {\n            if (!_.isArray(options.keys)) {\n                koa.keys = [ options.keys ];\n            } else {\n                koa.keys = options.keys;\n            }\n        }\n\n        koa.on('error', (err, ctx) => {\n            let extra = _.pick(err, [ 'status', 'code', 'info' ]);\n\n            if (ctx) {\n                extra.request = _.pick(ctx, ['method', 'url', 'ip']);\n            }\n\n            extra.app = ctx.appModule.name;\n\n            if (err.status && err.status < 500) {             \n                if (server.env === 'development') {\n                    extra.stack = err.stack;\n                }   \n                server.log('warn', `[${err.status}] ` + err.message, extra);\n                return;\n            } \n            \n            server.logError(err);\n        });                \n        \n        server.httpServer = require('http').createServer(koa.callback());                \n\n        let port = options.httpPort || 2331;\n\n        server.on('ready', () => {\n            server.httpServer.listen(port, function (err) {\n                if (err) throw err;\n\n                let address = server.httpServer.address();\n\n                let host;\n                if (address.family === 'IPv6' && address.address === '::') {\n                    host = '127.0.0.1';\n                } else {\n                    host = address.address;\n                }\n\n                server.host = `${host}:${address.port}`;\n                server.port = address.port;\n\n                server.log('info', `A http service is listening on port [${address.port}] ...`);\n                /**\n                 * Http server ready event\n                 * @event WebServer#httpReady\n                 */\n                server.emit('httpReady');\n            });\n        });\n    }\n};"],"mappings":"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"}