"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob,
  urlJoin,
  ensureLeftSlash,
  ensureRightSlash,
  urlAppendQuery
} = require('rk-utils');

const {
  Helpers: {
    tryRequire
  }
} = require('@genx/app');

const Errors = require('@genx/error');

const Literal = require('./enum/Literal');

const Koa = require('koa');

const mount = require('koa-mount');

const Routable = T => class extends T {
  constructor(name, options) {
    super(name, options);
    this.clientPath = this.toAbsolutePath(this.options.clientPath || Literal.CLIENT_SRC_PATH);
    this.publicPath = this.toAbsolutePath(this.options.publicPath || Literal.PUBLIC_PATH);
    this.router = new Koa();
    this.router.use((ctx, next) => {
      ctx.appModule = this;
      return next();
    });
    this.on('configLoaded', () => {
      let middlewareDir = path.join(this.backendPath, Literal.MIDDLEWARES_PATH);

      if (fs.existsSync(middlewareDir)) {
        this.loadMiddlewaresFrom(middlewareDir);
      }
    });
  }

  async start_() {
    this.middlewareFactoryRegistry = {};
    return super.start_();
  }

  async stop_() {
    delete this.middlewareFactoryRegistry;
    return super.stop_();
  }

  getBackendAction(actionByPath) {
    let lpos = actionByPath.lastIndexOf('.');

    if (lpos === -1) {
      throw new Error(`Invalid action path: ${actionByPath}`);
    }

    let controller = actionByPath.substr(0, lpos);
    let method = actionByPath.substr(lpos + 1);
    let controllerObj;

    try {
      controllerObj = require(path.join(this.backendPath, controller));
    } catch (error) {
      throw new Error(`Backend controller not found: ${controller}`);
    }

    let methodFunc = controllerObj[method];

    if (typeof methodFunc !== 'function') {
      throw new Error(`The specified action is not a function: ${actionByPath}`);
    }

    return methodFunc;
  }

  loadMiddlewaresFrom(dir) {
    let files = glob.sync(path.join(dir, '*.js'), {
      nodir: true
    });
    files.forEach(file => this.registerMiddlewareFactory(path.basename(file, '.js'), require(file)));
  }

  registerMiddlewareFactory(name, factoryMethod) {
    if (!(typeof factoryMethod === 'function')) {
      throw new Error('Invalid middleware factory: ' + name);
    }

    if (name in this.middlewareFactoryRegistry) {
      throw new Errors.ServerError('Middleware "' + name + '" already registered!');
    }

    this.middlewareFactoryRegistry[name] = factoryMethod;
    this.log('verbose', `Registered named middleware [${name}].`);
  }

  getMiddlewareFactory(name) {
    if (this.middlewareFactoryRegistry.hasOwnProperty(name)) {
      return this.middlewareFactoryRegistry[name];
    }

    if (this.server && this.server !== this) {
      return this.server.getMiddlewareFactory(name);
    }

    let npmMiddleware = tryRequire(name);

    if (npmMiddleware) {
      return npmMiddleware;
    }

    throw new Errors.ServerError(`Don't know where to load middleware "${name}".`);
  }

  useMiddlewares(router, middlewares) {
    let middlewareFactory, middleware;
    let middlewareFunctions = [];

    if (_.isPlainObject(middlewares)) {
      _.forOwn(middlewares, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        middleware = middlewareFactory(options, this);
        middlewareFunctions.push({
          name,
          middleware
        });
      });
    } else {
      middlewares = _.castArray(middlewares);

      _.each(middlewares, middlewareEntry => {
        let type = typeof middlewareEntry;

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(middlewareEntry);
          middleware = middlewareFactory(undefined, this);
          middlewareFunctions.push({
            name: middlewareEntry,
            middleware
          });
        } else if (type === 'function') {
          middlewareFunctions.push({
            name: middlewareEntry.name || 'unamed middleware',
            middleware: middlewareEntry
          });
        } else if (Array.isArray(middlewareEntry)) {
          if (middlewareEntry.length === 0) {
            throw new Errors.InvalidConfiguration('Empty array found as middleware entry!', this, 'middlewares');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry[0]);
          middleware = middlewareFactory(middlewareEntry.length > 1 ? middlewareEntry[1] : null, this);
          middlewareFunctions.push({
            name: middlewareEntry[0],
            middleware
          });
        } else {
          if (!_.isPlainObject(middlewareEntry) || !('name' in middlewareEntry)) {
            throw new Errors.InvalidConfiguration('Invalid middleware entry!', this, 'middlewares');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry.name);
          middleware = middlewareFactory(middlewareEntry.options, this);
          middlewareFunctions.push({
            name: middlewareEntry.name,
            middleware
          });
        }
      });
    }

    middlewareFunctions.forEach(({
      name,
      middleware
    }) => {
      if (Array.isArray(middleware)) {
        middleware.forEach(m => this.useMiddleware(router, m, name));
      } else {
        this.useMiddleware(router, middleware, name);
      }
    });
    return this;
  }

  addRoute(router, method, route, actions) {
    let handlers = [],
        middlewareFactory;

    if (_.isPlainObject(actions)) {
      _.forOwn(actions, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        handlers.push(this._wrapMiddlewareTracer(middlewareFactory(options, this), name));
      });
    } else {
      actions = _.castArray(actions);
      let lastIndex = actions.length - 1;

      _.each(actions, (action, i) => {
        let type = typeof action;

        if (i === lastIndex) {
          if (type === 'string' && action.lastIndexOf('.') > 0) {
            action = {
              name: 'action',
              options: action
            };
            type = 'object';
          }
        }

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(action);
          let middleware = middlewareFactory(null, this);

          if (Array.isArray(middleware)) {
            middleware.forEach((middlewareItem, i) => handlers.push(this._wrapMiddlewareTracer(middlewareItem, `${action}-${i}` + (middleware.name ? '-' + middleware.name : ''))));
          } else {
            handlers.push(this._wrapMiddlewareTracer(middleware, action));
          }
        } else if (type === 'function') {
          handlers.push(this._wrapMiddlewareTracer(action));
        } else if (Array.isArray(action)) {
          if (!(action.length > 0 && action.length <= 2)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action[0]);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.length > 1 ? action[1] : undefined, this)));
        } else {
          if (!(_.isPlainObject(action) && 'name' in action)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action.name);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.options, this), action.name));
        }
      });
    }

    router[method](route, ...handlers);
    let endpoint = router.opts.prefix ? urlJoin(this.route, router.opts.prefix, route) : urlJoin(this.route, route);
    this.log('verbose', `Route "${method}:${endpoint}" is added from module [${this.name}].`);
    return this;
  }

  addRouter(nestedRouter) {
    this.router.use(nestedRouter.routes());
    this.router.use(nestedRouter.allowedMethods());
    return this;
  }

  mountRouter(route, router) {
    this.router.use(mount(route, router));
  }

  toWebPath(relativePath, ...pathOrQuery) {
    let url, query;

    if (pathOrQuery && pathOrQuery.length > 0 && (pathOrQuery.length > 1 || pathOrQuery[0] !== undefined)) {
      if (_.isObject(pathOrQuery[pathOrQuery.length - 1])) {
        query = pathOrQuery.pop();
      }

      pathOrQuery.unshift(relativePath);
      url = urlJoin(this.route, ...pathOrQuery);
    } else {
      url = urlJoin(this.route, relativePath);
    }

    url = ensureLeftSlash(url);

    if (query) {
      url = urlAppendQuery(url, query);
      url = url.replace('/?', '?');
    }

    return url;
  }

  useMiddleware(router, middleware, name) {
    if (!(typeof middleware === 'function')) {
      throw new Error(middleware);
    }

    router.use(this._wrapMiddlewareTracer(middleware, name));
    this.log('verbose', `Attached middleware [${name}].`);
  }

  _wrapMiddlewareTracer(middleware, name) {
    if (this.options.traceMiddlewares) {
      return async (ctx, next) => {
        this.log('debug', `Step in middleware "${name || middleware.name}" ...`);
        let ret = await middleware(ctx, next);
        this.log('debug', `Step out from middleware "${name || middleware.name}".`);
        return ret;
      };
    }

    return middleware;
  }

  _getFeatureFallbackPath() {
    return super._getFeatureFallbackPath().concat([path.join(this.backendPath, Literal.FEATURES_PATH)]);
  }

};

module.exports = Routable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Sb3V0YWJsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJ1cmxKb2luIiwiZW5zdXJlTGVmdFNsYXNoIiwiZW5zdXJlUmlnaHRTbGFzaCIsInVybEFwcGVuZFF1ZXJ5IiwiSGVscGVycyIsInRyeVJlcXVpcmUiLCJFcnJvcnMiLCJMaXRlcmFsIiwiS29hIiwibW91bnQiLCJSb3V0YWJsZSIsIlQiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJvcHRpb25zIiwiY2xpZW50UGF0aCIsInRvQWJzb2x1dGVQYXRoIiwiQ0xJRU5UX1NSQ19QQVRIIiwicHVibGljUGF0aCIsIlBVQkxJQ19QQVRIIiwicm91dGVyIiwidXNlIiwiY3R4IiwibmV4dCIsImFwcE1vZHVsZSIsIm9uIiwibWlkZGxld2FyZURpciIsImpvaW4iLCJiYWNrZW5kUGF0aCIsIk1JRERMRVdBUkVTX1BBVEgiLCJleGlzdHNTeW5jIiwibG9hZE1pZGRsZXdhcmVzRnJvbSIsInN0YXJ0XyIsIm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnkiLCJzdG9wXyIsImdldEJhY2tlbmRBY3Rpb24iLCJhY3Rpb25CeVBhdGgiLCJscG9zIiwibGFzdEluZGV4T2YiLCJFcnJvciIsImNvbnRyb2xsZXIiLCJzdWJzdHIiLCJtZXRob2QiLCJjb250cm9sbGVyT2JqIiwiZXJyb3IiLCJtZXRob2RGdW5jIiwiZGlyIiwiZmlsZXMiLCJzeW5jIiwibm9kaXIiLCJmb3JFYWNoIiwiZmlsZSIsInJlZ2lzdGVyTWlkZGxld2FyZUZhY3RvcnkiLCJiYXNlbmFtZSIsImZhY3RvcnlNZXRob2QiLCJTZXJ2ZXJFcnJvciIsImxvZyIsImdldE1pZGRsZXdhcmVGYWN0b3J5IiwiaGFzT3duUHJvcGVydHkiLCJzZXJ2ZXIiLCJucG1NaWRkbGV3YXJlIiwidXNlTWlkZGxld2FyZXMiLCJtaWRkbGV3YXJlcyIsIm1pZGRsZXdhcmVGYWN0b3J5IiwibWlkZGxld2FyZSIsIm1pZGRsZXdhcmVGdW5jdGlvbnMiLCJpc1BsYWluT2JqZWN0IiwiZm9yT3duIiwicHVzaCIsImNhc3RBcnJheSIsImVhY2giLCJtaWRkbGV3YXJlRW50cnkiLCJ0eXBlIiwidW5kZWZpbmVkIiwiQXJyYXkiLCJpc0FycmF5IiwibGVuZ3RoIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJtIiwidXNlTWlkZGxld2FyZSIsImFkZFJvdXRlIiwicm91dGUiLCJhY3Rpb25zIiwiaGFuZGxlcnMiLCJfd3JhcE1pZGRsZXdhcmVUcmFjZXIiLCJsYXN0SW5kZXgiLCJhY3Rpb24iLCJpIiwibWlkZGxld2FyZUl0ZW0iLCJlbmRwb2ludCIsIm9wdHMiLCJwcmVmaXgiLCJhZGRSb3V0ZXIiLCJuZXN0ZWRSb3V0ZXIiLCJyb3V0ZXMiLCJhbGxvd2VkTWV0aG9kcyIsIm1vdW50Um91dGVyIiwidG9XZWJQYXRoIiwicmVsYXRpdmVQYXRoIiwicGF0aE9yUXVlcnkiLCJ1cmwiLCJxdWVyeSIsImlzT2JqZWN0IiwicG9wIiwidW5zaGlmdCIsInJlcGxhY2UiLCJ0cmFjZU1pZGRsZXdhcmVzIiwicmV0IiwiX2dldEZlYXR1cmVGYWxsYmFja1BhdGgiLCJjb25jYXQiLCJGRUFUVVJFU19QQVRIIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxFQUFMO0FBQVNDLEVBQUFBLElBQVQ7QUFBZUMsRUFBQUEsT0FBZjtBQUF3QkMsRUFBQUEsZUFBeEI7QUFBeUNDLEVBQUFBLGdCQUF6QztBQUEyREMsRUFBQUE7QUFBM0QsSUFBOEVQLE9BQU8sQ0FBQyxVQUFELENBQTNGOztBQUNBLE1BQU07QUFBRVEsRUFBQUEsT0FBTyxFQUFFO0FBQUVDLElBQUFBO0FBQUY7QUFBWCxJQUE4QlQsT0FBTyxDQUFDLFdBQUQsQ0FBM0M7O0FBQ0EsTUFBTVUsTUFBTSxHQUFHVixPQUFPLENB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QUwsQ0FBUyxTQUFULEVBQXFCLHdCQUF1QjNDLElBQUssSUFBakQ7QUFDSDs7QUFFRHVFLEVBQUFBLHFCQUFxQixDQUFDcEIsVUFBRCxFQUFhbkQsSUFBYixFQUFtQjtBQUNwQyxRQUFJLEtBQUtDLE9BQUwsQ0FBYTRGLGdCQUFqQixFQUFtQztBQUMvQixhQUFPLE9BQU9wRixHQUFQLEVBQVlDLElBQVosS0FBcUI7QUFDeEIsYUFBS2lDLEdBQUwsQ0FBUyxPQUFULEVBQW1CLHVCQUFzQjNDLElBQUksSUFBSW1ELFVBQVUsQ0FBQ25ELElBQUssT0FBakU7QUFDQSxZQUFJOEYsR0FBRyxHQUFHLE1BQU0zQyxVQUFVLENBQUMxQyxHQUFELEVBQU1DLElBQU4sQ0FBMUI7QUFDQSxhQUFLaUMsR0FBTCxDQUFTLE9BQVQsRUFBbUIsNkJBQTRCM0MsSUFBSSxJQUFJbUQsVUFBVSxDQUFDbkQsSUFBSyxJQUF2RTtBQUNBLGVBQU84RixHQUFQO0FBQ0gsT0FMRDtBQU1IOztBQUVELFdBQU8zQyxVQUFQO0FBQ0g7O0FBRUQ0QyxFQUFBQSx1QkFBdUIsR0FBRztBQUN0QixXQUFPLE1BQU1BLHVCQUFOLEdBQWdDQyxNQUFoQyxDQUF1QyxDQUFFbEgsSUFBSSxDQUFDZ0MsSUFBTCxDQUFVLEtBQUtDLFdBQWYsRUFBNEJyQixPQUFPLENBQUN1RyxhQUFwQyxDQUFGLENBQXZDLENBQVA7QUFDSDs7QUF4VmlDLENBQXRDOztBQTJWQUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCdEcsUUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgZnMsIGdsb2IsIHVybEpvaW4sIGVuc3VyZUxlZnRTbGFzaCwgZW5zdXJlUmlnaHRTbGFzaCwgdXJsQXBwZW5kUXVlcnkgfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IEhlbHBlcnM6IHsgdHJ5UmVxdWlyZSB9IH0gPSByZXF1aXJlKCdAZ2VueC9hcHAnKTtcbmNvbnN0IEVycm9ycyA9IHJlcXVpcmUoJ0BnZW54L2Vycm9yJyk7XG5jb25zdCBMaXRlcmFsID0gcmVxdWlyZSgnLi9lbnVtL0xpdGVyYWwnKTtcbmNvbnN0IEtvYSA9IHJlcXVpcmUoJ2tvYScpO1xuY29uc3QgbW91bnQgPSByZXF1aXJlKCdrb2EtbW91bnQnKTtcblxuY29uc3QgUm91dGFibGUgPSBUID0+IGNsYXNzIGV4dGVuZHMgVCB7ICAgIFxuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgcm91dGFibGUgaW5zdGFuY2UuICAgICBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gUm91dGFibGUgb3B0aW9ucyAgICAgICAgICAgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5iYWNrZW5kUGF0aD0nc2VydmVyJ10gLSBSZWxhdGl2ZSBwYXRoIG9mIGJhY2stZW5kIHNlcnZlciBzb3VyY2UgZmlsZXNcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuY2xpZW50UGF0aD0nY2xpZW50J10gLSBSZWxhdGl2ZSBwYXRoIG9mIGZyb250LWVuZCBjbGllbnQgc291cmNlIGZpbGVzICAgICBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucHVibGljUGF0aD0ncHVibGljJ10gLSBSZWxhdGl2ZSBwYXRoIG9mIGZyb250LWVuZCBzdGF0aWMgZmlsZXMgXG4gICAgICovICAgICAgICAgXG4gICAgY29uc3RydWN0b3IobmFtZSwgb3B0aW9ucykge1xuICAgICAgICBzdXBlcihuYW1lLCBvcHRpb25zKTsgICAgICAgIFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBGcm9udGVuZCBzb3VyY2UgZmlsZXMgcGF0aC5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMuY2xpZW50UGF0aCA9IHRoaXMudG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLmNsaWVudFBhdGggfHwgTGl0ZXJhbC5DTElFTlRfU1JDX1BBVEgpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBGcm9udGVuZCBzdGF0aWMgZmlsZXMgcGF0aC5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMucHVibGljUGF0aCA9IHRoaXMudG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLnB1YmxpY1BhdGggfHwgTGl0ZXJhbC5QVUJMSUNfUEFUSCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEVhY2ggYXBwIGhhcyBpdHMgb3duIHJvdXRlci5cbiAgICAgICAgICogQG1lbWJlciB7S29hfVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMucm91dGVyID0gbmV3IEtvYSgpO1xuXG4gICAgICAgIC8vaW5qZWN0IHRoZSBhcHBNb2R1bGUgaW5zdGFuY2UgaW4gdGhlIGZpcnN0IG1pZGRsZXdhcmVcbiAgICAgICAgdGhpcy5yb3V0ZXIudXNlKChjdHgsIG5leHQpID0+IHsgXG4gICAgICAgICAgICBjdHguYXBwTW9kdWxlID0gdGhpczsgXG4gICAgICAgICAgICByZXR1cm4gbmV4dCgpOyBcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5vbignY29uZmlnTG9hZGVkJywgKCkgPT4ge1xuICAgICAgICAgICAgLy9sb2FkIG1pZGRsZXdhcmVzIGlmIGV4aXN0cyBpbiBzZXJ2ZXIgb3IgYXBwIHBhdGhcbiAgICAgICAgICAgIGxldCBtaWRkbGV3YXJlRGlyID0gcGF0aC5qb2luKHRoaXMuYmFja2VuZFBhdGgsIExpdGVyYWwuTUlERExFV0FSRVNfUEFUSCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChmcy5leGlzdHNTeW5jKG1pZGRsZXdhcmVEaXIpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2FkTWlkZGxld2FyZXNGcm9tKG1pZGRsZXdhcmVEaXIpO1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuICAgICAgICB9KTsgIFxuICAgIH1cblxuICAgIGFzeW5jIHN0YXJ0XygpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIE1pZGRsZXdhcmUgZmFjdG9yeSByZWdpc3RyeS5cbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5ID0ge307XG5cbiAgICAgICAgcmV0dXJuIHN1cGVyLnN0YXJ0XygpO1xuICAgIH1cblxuICAgIGFzeW5jIHN0b3BfKCkge1xuICAgICAgICBkZWxldGUgdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5O1xuXG4gICAgICAgIHJldHVybiBzdXBlci5zdG9wXygpO1xuICAgIH1cblxuICAgIGdldEJhY2tlbmRBY3Rpb24oYWN0aW9uQnlQYXRoKSB7XG4gICAgICAgIGxldCBscG9zID0gYWN0aW9uQnlQYXRoLmxhc3RJbmRleE9mKCcuJyk7XG5cbiAgICAgICAgaWYgKGxwb3MgPT09IC0xKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgYWN0aW9uIHBhdGg6ICR7YWN0aW9uQnlQYXRofWApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNvbnRyb2xsZXIgPSBhY3Rpb25CeVBhdGguc3Vic3RyKDAsIGxwb3MpO1xuICAgICAgICBsZXQgbWV0aG9kID0gYWN0aW9uQnlQYXRoLnN1YnN0cihscG9zKzEpO1xuICAgICAgICBsZXQgY29udHJvbGxlck9iajtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29udHJvbGxlck9iaiA9IHJlcXVpcmUocGF0aC5qb2luKHRoaXMuYmFja2VuZFBhdGgsIGNvbnRyb2xsZXIpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQmFja2VuZCBjb250cm9sbGVyIG5vdCBmb3VuZDogJHtjb250cm9sbGVyfWApO1xuICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgIGxldCBtZXRob2RGdW5jID0gY29udHJvbGxlck9ialttZXRob2RdO1xuICAgICAgICBpZiAodHlwZW9mIG1ldGhvZEZ1bmMgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHNwZWNpZmllZCBhY3Rpb24gaXMgbm90IGEgZnVuY3Rpb246ICR7YWN0aW9uQnlQYXRofWApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG1ldGhvZEZ1bmM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9hZCBhbmQgcmVnc2l0ZXIgbWlkZGxld2FyZSBmaWxlcyBmcm9tIGEgc3BlY2lmaWVkIHBhdGguXG4gICAgICogQHBhcmFtIGRpclxuICAgICAqL1xuICAgIGxvYWRNaWRkbGV3YXJlc0Zyb20oZGlyKSB7XG4gICAgICAgIGxldCBmaWxlcyA9IGdsb2Iuc3luYyhwYXRoLmpvaW4oZGlyLCAnKi5qcycpLCB7bm9kaXI6IHRydWV9KTtcbiAgICAgICAgZmlsZXMuZm9yRWFjaChmaWxlID0+IHRoaXMucmVnaXN0ZXJNaWRkbGV3YXJlRmFjdG9yeShwYXRoLmJhc2VuYW1lKGZpbGUsICcuanMnKSwgcmVxdWlyZShmaWxlKSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlZ2lzdGVyIHRoZSBmYWN0b3J5IG1ldGhvZCBvZiBhIG5hbWVkIG1pZGRsZXdhcmUuICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBtaWRkbGV3YXJlIFxuICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGZhY3RvcnlNZXRob2QgLSBUaGUgZmFjdG9yeSBtZXRob2Qgb2YgYSBtaWRkbGV3YXJlXG4gICAgICovXG4gICAgcmVnaXN0ZXJNaWRkbGV3YXJlRmFjdG9yeShuYW1lLCBmYWN0b3J5TWV0aG9kKSB7XG4gICAgICAgIHByZTogdHlwZW9mIGZhY3RvcnlNZXRob2QgPT09ICdmdW5jdGlvbicsICdJbnZhbGlkIG1pZGRsZXdhcmUgZmFjdG9yeTogJyArIG5hbWU7ICAgICAgICBcblxuICAgICAgICBpZiAobmFtZSBpbiB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcnMuU2VydmVyRXJyb3IoJ01pZGRsZXdhcmUgXCInKyBuYW1lICsnXCIgYWxyZWFkeSByZWdpc3RlcmVkIScpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5W25hbWVdID0gZmFjdG9yeU1ldGhvZDtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgUmVnaXN0ZXJlZCBuYW1lZCBtaWRkbGV3YXJlIFske25hbWV9XS5gKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGZhY3RvcnkgbWV0aG9kIG9mIGEgbWlkZGxld2FyZSBmcm9tIG1vZHVsZSBoaWVyYXJjaHkuICAgICBcbiAgICAgKiBAcGFyYW0gbmFtZVxuICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbn1cbiAgICAgKi9cbiAgICBnZXRNaWRkbGV3YXJlRmFjdG9yeShuYW1lKSB7XG4gICAgICAgIGlmICh0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnkuaGFzT3duUHJvcGVydHkobmFtZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnlbbmFtZV07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5zZXJ2ZXIgJiYgdGhpcy5zZXJ2ZXIgIT09IHRoaXMpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNlcnZlci5nZXRNaWRkbGV3YXJlRmFjdG9yeShuYW1lKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBucG1NaWRkbGV3YXJlID0gdHJ5UmVxdWlyZShuYW1lKTtcbiAgICAgICAgaWYgKG5wbU1pZGRsZXdhcmUpIHtcbiAgICAgICAgICAgIHJldHVybiBucG1NaWRkbGV3YXJlO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhyb3cgbmV3IEVycm9ycy5TZXJ2ZXJFcnJvcihgRG9uJ3Qga25vdyB3aGVyZSB0byBsb2FkIG1pZGRsZXdhcmUgXCIke25hbWV9XCIuYCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXNlIG1pZGRsZXdhcmVzXG4gICAgICogQHBhcmFtIHtSb3V0ZXJ9IHJvdXRlclxuICAgICAqIEBwYXJhbSB7Kn0gbWlkZGxld2FyZXMgLSBDYW4gYmUgYW4gYXJyYXkgb2YgbWlkZGxld2FyZSBlbnRyaWVzIG9yIGEga2V5LXZhbHVlIGxpc3Qgb2YgcmVnaXN0ZXJyZWQgbWlkZGxld2FyZXNcbiAgICAgKiBAcmV0dXJucyB7Um91dGFibGV9XG4gICAgICovXG4gICAgdXNlTWlkZGxld2FyZXMocm91dGVyLCBtaWRkbGV3YXJlcykge1xuICAgICAgICBsZXQgbWlkZGxld2FyZUZhY3RvcnksIG1pZGRsZXdhcmU7XG4gICAgICAgIGxldCBtaWRkbGV3YXJlRnVuY3Rpb25zID0gW107XG4gICAgICAgIFxuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KG1pZGRsZXdhcmVzKSkge1xuICAgICAgICAgICAgXy5mb3JPd24obWlkZGxld2FyZXMsIChvcHRpb25zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KG5hbWUpOyAgIFxuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeShvcHRpb25zLCB0aGlzKTtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lLCBtaWRkbGV3YXJlIH0pOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbWlkZGxld2FyZXMgPSBfLmNhc3RBcnJheShtaWRkbGV3YXJlcyk7ICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgIF8uZWFjaChtaWRkbGV3YXJlcywgbWlkZGxld2FyZUVudHJ5ID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgdHlwZSA9IHR5cGVvZiBtaWRkbGV3YXJlRW50cnk7XG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gWyAnbmFtZWRNaWRkbGV3YXJlJyBdXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShtaWRkbGV3YXJlRW50cnkpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlID0gbWlkZGxld2FyZUZhY3RvcnkodW5kZWZpbmVkLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5wdXNoKHsgbmFtZTogbWlkZGxld2FyZUVudHJ5ICwgbWlkZGxld2FyZSB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5wdXNoKHsgbmFtZTogbWlkZGxld2FyZUVudHJ5Lm5hbWUgfHwgJ3VuYW1lZCBtaWRkbGV3YXJlJywgbWlkZGxld2FyZTogbWlkZGxld2FyZUVudHJ5fSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KG1pZGRsZXdhcmVFbnRyeSkpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gWyBbICduYW1lZE1pZGRsZXdhcmUnLCBjb25maWcgXSBdXG4gICAgICAgICAgICAgICAgICAgIGlmIChtaWRkbGV3YXJlRW50cnkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3JzLkludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdFbXB0eSBhcnJheSBmb3VuZCBhcyBtaWRkbGV3YXJlIGVudHJ5IScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWlkZGxld2FyZXMnXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmVFbnRyeVswXSk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeShtaWRkbGV3YXJlRW50cnkubGVuZ3RoID4gMSA/IG1pZGRsZXdhcmVFbnRyeVsxXSA6IG51bGwsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lOiBtaWRkbGV3YXJlRW50cnlbMF0sIG1pZGRsZXdhcmUgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFfLmlzUGxhaW5PYmplY3QobWlkZGxld2FyZUVudHJ5KSB8fCAhKCduYW1lJyBpbiBtaWRkbGV3YXJlRW50cnkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3JzLkludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdJbnZhbGlkIG1pZGRsZXdhcmUgZW50cnkhJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtaWRkbGV3YXJlcydcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUVudHJ5Lm5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlID0gbWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUVudHJ5Lm9wdGlvbnMsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lOiBtaWRkbGV3YXJlRW50cnkubmFtZSwgbWlkZGxld2FyZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMuZm9yRWFjaCgoeyBuYW1lLCBtaWRkbGV3YXJlIH0pID0+IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG1pZGRsZXdhcmUpKSB7XG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZS5mb3JFYWNoKG0gPT4gdGhpcy51c2VNaWRkbGV3YXJlKHJvdXRlciwgbSwgbmFtZSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVzZU1pZGRsZXdhcmUocm91dGVyLCBtaWRkbGV3YXJlLCBuYW1lKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSByb3V0ZSB0byBhIHJvdXRlciwgc2tpcHBlZCB3aGlsZSB0aGUgc2VydmVyIHJ1bm5pbmcgaW4gZGVhZiBtb2RlLiAgICAgXG4gICAgICogQHBhcmFtIHJvdXRlclxuICAgICAqIEBwYXJhbSBtZXRob2RcbiAgICAgKiBAcGFyYW0gcm91dGVcbiAgICAgKiBAcGFyYW0gYWN0aW9uc1xuICAgICAqL1xuICAgIGFkZFJvdXRlKHJvdXRlciwgbWV0aG9kLCByb3V0ZSwgYWN0aW9ucykge1xuICAgICAgICBsZXQgaGFuZGxlcnMgPSBbXSwgbWlkZGxld2FyZUZhY3Rvcnk7XG5cbiAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChhY3Rpb25zKSkge1xuICAgICAgICAgICAgXy5mb3JPd24oYWN0aW9ucywgKG9wdGlvbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSk7XG4gICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaCh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlRmFjdG9yeShvcHRpb25zLCB0aGlzKSwgbmFtZSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhY3Rpb25zID0gXy5jYXN0QXJyYXkoYWN0aW9ucyk7XG4gICAgICAgICAgICBsZXQgbGFzdEluZGV4ID0gYWN0aW9ucy5sZW5ndGggLSAxO1xuXG4gICAgICAgICAgICBfLmVhY2goYWN0aW9ucywgKGFjdGlvbiwgaSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCB0eXBlID0gdHlwZW9mIGFjdGlvbjtcblxuICAgICAgICAgICAgICAgIGlmIChpID09PSBsYXN0SW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gbGFzdCBtaWRkbGV3YXJlIG1heSBiZSBhbiBhY3Rpb25cbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnICYmIGFjdGlvbi5sYXN0SW5kZXhPZignLicpID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICdhY3Rpb24nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IGFjdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICdvYmplY3QnO1xuICAgICAgICAgICAgICAgICAgICB9ICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAvLyBbICduYW1lZE1pZGRsZXdhcmUnIF1cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvbik7ICAgXG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeShudWxsLCB0aGlzKTtcblxuICAgICAgICAgICAgICAgICAgICAvL2luIGNhc2UgaXQncyByZWdpc3RlciBieSB0aGUgbWlkZGxld2FyZUZhY3RvcnkgZmVhdHVyZVxuICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShtaWRkbGV3YXJlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZS5mb3JFYWNoKChtaWRkbGV3YXJlSXRlbSwgaSkgPT4gaGFuZGxlcnMucHVzaChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlSXRlbSwgYCR7YWN0aW9ufS0ke2l9YCArIChtaWRkbGV3YXJlLm5hbWUgPyAoJy0nICsgbWlkZGxld2FyZS5uYW1lKSA6ICcnKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICkpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmUsIGFjdGlvbikpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIoYWN0aW9uKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGFjdGlvbikpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiBhY3Rpb24ubGVuZ3RoID4gMCAmJiBhY3Rpb24ubGVuZ3RoIDw9IDIsICdJbnZhbGlkIG1pZGRsZXdhcmUgZW50cnknO1xuXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShhY3Rpb25bMF0pOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uLmxlbmd0aCA+IDEgPyBhY3Rpb25bMV0gOiB1bmRlZmluZWQsIHRoaXMpKSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQ6IF8uaXNQbGFpbk9iamVjdChhY3Rpb24pICYmICduYW1lJyBpbiBhY3Rpb24sICdJbnZhbGlkIG1pZGRsZXdhcmUgZW50cnknO1xuXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShhY3Rpb24ubmFtZSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaCh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlRmFjdG9yeShhY3Rpb24ub3B0aW9ucywgdGhpcyksIGFjdGlvbi5uYW1lKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIHJvdXRlclttZXRob2RdKHJvdXRlLCAuLi5oYW5kbGVycyk7XG5cbiAgICAgICAgbGV0IGVuZHBvaW50ID0gcm91dGVyLm9wdHMucHJlZml4ID8gdXJsSm9pbih0aGlzLnJvdXRlLCByb3V0ZXIub3B0cy5wcmVmaXgsIHJvdXRlKSA6IHVybEpvaW4odGhpcy5yb3V0ZSwgcm91dGUpO1xuXG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYFJvdXRlIFwiJHttZXRob2R9OiR7ZW5kcG9pbnR9XCIgaXMgYWRkZWQgZnJvbSBtb2R1bGUgWyR7dGhpcy5uYW1lfV0uYCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfSAgICBcblxuICAgIC8qKlxuICAgICAqIEF0dGFjaCBhIHJvdXRlciB0byB0aGlzIGFwcCBtb2R1bGUsIHNraXBwZWQgd2hpbGUgdGhlIHNlcnZlciBydW5uaW5nIGluIGRlYWYgbW9kZSAgICAgXG4gICAgICogQHBhcmFtIHtSb3V0ZXJ9IG5lc3RlZFJvdXRlclxuICAgICAqL1xuICAgIGFkZFJvdXRlcihuZXN0ZWRSb3V0ZXIpIHtcbiAgICAgICAgdGhpcy5yb3V0ZXIudXNlKG5lc3RlZFJvdXRlci5yb3V0ZXMoKSk7XG4gICAgICAgIHRoaXMucm91dGVyLnVzZShuZXN0ZWRSb3V0ZXIuYWxsb3dlZE1ldGhvZHMoKSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEF0dGFjaCBhIHJvdXRlciB0byB0aGlzIGFwcCBtb2R1bGUgYnkgbW91bnRpbmcgdGhlIHJvdXRlciB0byBhIHJvdXRlXG4gICAgICogQHBhcmFtIHsqfSByb3V0ZSBcbiAgICAgKiBAcGFyYW0geyp9IHJvdXRlciBcbiAgICAgKi9cbiAgICBtb3VudFJvdXRlcihyb3V0ZSwgcm91dGVyKSB7XG4gICAgICAgIHRoaXMucm91dGVyLnVzZShtb3VudChyb3V0ZSwgcm91dGVyKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIGEgcmVsYXRpdmUgcGF0aCBhbmQgcXVlcnkgcGFyYW1ldGVycyBpZiBhbnkgdG8gYSB1cmwgcGF0aCAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHJlbGF0aXZlUGF0aCAtIFJlbGF0aXZlIHBhdGhcbiAgICAgKiBAcGFyYW0gey4uLip9IFtwYXRoT3JRdWVyeV0gLSBRdWVyaWVzXG4gICAgICogQHJldHVybnMge3N0cmluZ31cbiAgICAgKi9cbiAgICB0b1dlYlBhdGgocmVsYXRpdmVQYXRoLCAuLi5wYXRoT3JRdWVyeSkge1xuICAgICAgICBsZXQgdXJsLCBxdWVyeTtcblxuICAgICAgICBpZiAocGF0aE9yUXVlcnkgJiYgcGF0aE9yUXVlcnkubGVuZ3RoID4gMCAmJiAocGF0aE9yUXVlcnkubGVuZ3RoID4gMSB8fCBwYXRoT3JRdWVyeVswXSAhPT0gdW5kZWZpbmVkKSkge1xuICAgICAgICAgICAgaWYgKF8uaXNPYmplY3QocGF0aE9yUXVlcnlbcGF0aE9yUXVlcnkubGVuZ3RoIC0gMV0pKSB7XG4gICAgICAgICAgICAgICAgcXVlcnkgPSBwYXRoT3JRdWVyeS5wb3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBhdGhPclF1ZXJ5LnVuc2hpZnQocmVsYXRpdmVQYXRoKTtcbiAgICAgICAgICAgIHVybCA9IHVybEpvaW4odGhpcy5yb3V0ZSwgLi4ucGF0aE9yUXVlcnkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdXJsID0gdXJsSm9pbih0aGlzLnJvdXRlLCByZWxhdGl2ZVBhdGgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdXJsID0gZW5zdXJlTGVmdFNsYXNoKHVybCk7XG5cbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICB1cmwgPSB1cmxBcHBlbmRRdWVyeSh1cmwsIHF1ZXJ5KTtcbiAgICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKCcvPycsICc/Jyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdXJsO1xuICAgIH0gICBcblxuICAgIHVzZU1pZGRsZXdhcmUocm91dGVyLCBtaWRkbGV3YXJlLCBuYW1lKSB7ICAgICAgICAgIFxuICAgICAgICBhc3NlcnQ6IHR5cGVvZiBtaWRkbGV3YXJlID09PSAnZnVuY3Rpb24nLCBtaWRkbGV3YXJlO1xuICAgICAgICByb3V0ZXIudXNlKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmUsIG5hbWUpKTtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgQXR0YWNoZWQgbWlkZGxld2FyZSBbJHtuYW1lfV0uYCk7XG4gICAgfVxuXG4gICAgX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmUsIG5hbWUpIHsgICAgICAgIFxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnRyYWNlTWlkZGxld2FyZXMpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBhc3luYyAoY3R4LCBuZXh0KSA9PiB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRoaXMubG9nKCdkZWJ1ZycsIGBTdGVwIGluIG1pZGRsZXdhcmUgXCIke25hbWUgfHwgbWlkZGxld2FyZS5uYW1lfVwiIC4uLmApOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgbWlkZGxld2FyZShjdHgsIG5leHQpO1xuICAgICAgICAgICAgICAgIHRoaXMubG9nKCdkZWJ1ZycsIGBTdGVwIG91dCBmcm9tIG1pZGRsZXdhcmUgXCIke25hbWUgfHwgbWlkZGxld2FyZS5uYW1lfVwiLmApOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICByZXR1cm4gcmV0O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG1pZGRsZXdhcmU7XG4gICAgfVxuXG4gICAgX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKSB7XG4gICAgICAgIHJldHVybiBzdXBlci5fZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCgpLmNvbmNhdChbIHBhdGguam9pbih0aGlzLmJhY2tlbmRQYXRoLCBMaXRlcmFsLkZFQVRVUkVTX1BBVEgpIF0pO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gUm91dGFibGU7Il19