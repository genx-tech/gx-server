"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  eachAsync_
} = require('rk-utils');

const {
  Runable,
  ServiceContainer
} = require('@genx/app');

const Routable = require('./Routable');

const Literal = require('./enum/Literal');

const {
  defaultBackendPath
} = require('./utils/Helpers');

const mount = require('koa-mount');

class WebServer extends Routable(Runable(ServiceContainer)) {
  constructor(name, options) {
    if (typeof options === 'undefined' && _.isPlainObject(name)) {
      options = name;
      name = undefined;
    }

    super(name || 'server', Object.assign({
      configName: Literal.SERVER_CFG_NAME
    }, options));
    this.server = this;
    this.isServer = true;
    this.backendPath = this.toAbsolutePath(this.options.backendPath || defaultBackendPath);
    this.appModulesPath = this.toAbsolutePath(this.options.appModulesPath || Literal.APP_MODULES_PATH);
    this.route = "/";
    this.on('configLoaded', () => {
      this.loadMiddlewaresFrom(path.resolve(__dirname, Literal.MIDDLEWARES_PATH));
    });
  }

  async stop_() {
    if (this.started) {
      if (this.appModules) {
        await eachAsync_(this.appModules, app => app.stop_());
        delete this.appModules;
        delete this.appModulesByAlias;
      }

      if (this.libModules) {
        await eachAsync_(this.libModules, lib => lib.stop_());
        delete this.libModules;
      }
    }

    if (this.httpServer) {
      await new Promise((resolve, reject) => {
        this.httpServer.close(err => {
          if (err) return reject(err);
          resolve();
        });
      });
      delete this.httpServer;
      this.log('info', `The http service is stopped.`);
    }

    return super.stop_();
  }

  mountApp(app) {
    if (!this.appModules) {
      this.appModules = {};
      this.appModulesByAlias = {};
    }

    if (!!this.appModules.hasOwnProperty(app.route)) {
      throw new Error("Assertion failed: !this.appModules.hasOwnProperty(app.route)");
    }

    this.router.use(mount(app.route, app.router));
    this.appModules[app.route] = app;

    if (app.name in this.appModulesByAlias) {
      let existingApp = this.appModulesByAlias[app.name];
      this.appModulesByAlias[`${existingApp.name}[@${existingApp.route}]`] = existingApp;
      delete this.appModulesByAlias[app.name];
      this.appModulesByAlias[`${app.name}[@${app.route}]`] = app;
    } else {
      this.appModulesByAlias[app.name] = app;
    }

    this.log('verbose', `All routes from app [${app.name}] are mounted under "${app.route}".`);
  }

  registerLib(lib) {
    if (!this.libModules) {
      this.libModules = {};
    }

    this.libModules[lib.name] = lib;
  }

  getAppByRoute(p) {
    return this.appModules[p];
  }

  getAppByAlias(a) {
    return this.appModulesByAlias[a];
  }

  getLib(libName) {
    if (!this.libModules) {
      throw new Error('"libModules" feature is required to access lib among modules.');
    }

    let libModule = this.libModules[libName];

    if (!libModule) {
      throw new Error(`Lib module [${libName}] not found.`);
    }

    return libModule;
  }

  requireFromLib(libName, relativePath) {
    let libModule = this.getLib(libName);
    return libModule.require(relativePath);
  }

  getService(name) {
    let pos = name.indexOf(':');

    if (pos === -1) {
      return super.getService(name);
    }

    let modAlias = name.substr(0, pos);
    name = name.substr(pos + 1);
    let app = this.getAppByAlias(modAlias);
    return app && app.getService(name, true);
  }

  _getFeatureFallbackPath() {
    let pathArray = super._getFeatureFallbackPath();

    pathArray.splice(1, 0, path.resolve(__dirname, Literal.FEATURES_PATH), path.resolve(__dirname, Literal.APP_FEATURES_PATH), path.resolve(__dirname, Literal.SERVER_FEATURES_PATH));
    return pathArray;
  }

}

module.exports = WebServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9XZWJTZXJ2ZXIuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwiZWFjaEFzeW5jXyIsIlJ1bmFibGUiLCJTZXJ2aWNlQ29udGFpbmVyIiwiUm91dGFibGUiLCJMaXRlcmFsIiwiZGVmYXVsdEJhY2tlbmRQYXRoIiwibW91bnQiLCJXZWJTZXJ2ZXIiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJvcHRpb25zIiwiaXNQbGFpbk9iamVjdCIsInVuZGVmaW5lZCIsIk9iamVjdCIsImFzc2lnbiIsImNvbmZpZ05hbWUiLCJTRVJWRVJfQ0ZHX05BTUUiLCJzZXJ2ZXIiLCJpc1NlcnZlciIsImJhY2tlbmRQYXRoIiwidG9BYnNvbHV0ZVBhdGgiLCJhcHBNb2R1bGVzUGF0aCIsIkFQUF9NT0RVTEVTX1BBVEgiLCJyb3V0ZSIsIm9uIiwibG9hZE1pZGRsZXdhcmVzRnJvbSIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJNSURETEVXQVJFU19QQVRIIiwic3RvcF8iLCJzdGFydGVkIiwiYXBwTW9kdWxlcyIsImFwcCIsImFwcE1vZHVsZXNCeUFsaWFzIiwibGliTW9kdWxlcyIsImxpYiIsImh0dHBTZXJ2ZXIiLCJQcm9taXNlIiwicmVqZWN0IiwiY2xvc2UiLCJlcnIiLCJsb2ciLCJtb3VudEFwcCIsImhhc093blByb3BlcnR5Iiwicm91dGVyIiwidXNlIiwiZXhpc3RpbmdBcHAiLCJyZWdpc3RlckxpYiIsImdldEFwcEJ5Um91dGUiLCJwIiwiZ2V0QXBwQnlBbGlhcyIsImEiLCJnZXRMaWIiLCJsaWJOYW1lIiwiRXJyb3IiLCJsaWJNb2R1bGUiLCJyZXF1aXJlRnJvbUxpYiIsInJlbGF0aXZlUGF0aCIsImdldFNlcnZpY2UiLCJwb3MiLCJpbmRleE9mIiwibW9kQWxpYXMiLCJzdWJzdHIiLCJfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCIsInBhdGhBcnJheSIsInNwbGljZSIsIkZFQVRVUkVTX1BBVEgiLCJBUFBfRkVBVFVSRVNfUEFUSCIsIlNFUlZF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Q0FBQyxDQUFiLEVBQWdCO0FBQ1osYUFBTyxNQUFNRCxVQUFOLENBQWlCakQsSUFBakIsQ0FBUDtBQUNIOztBQUVELFFBQUlvRCxRQUFRLEdBQUdwRCxJQUFJLENBQUNxRCxNQUFMLENBQVksQ0FBWixFQUFlSCxHQUFmLENBQWY7QUFDQWxELElBQUFBLElBQUksR0FBR0EsSUFBSSxDQUFDcUQsTUFBTCxDQUFZSCxHQUFHLEdBQUMsQ0FBaEIsQ0FBUDtBQUVBLFFBQUkzQixHQUFHLEdBQUcsS0FBS2tCLGFBQUwsQ0FBbUJXLFFBQW5CLENBQVY7QUFDQSxXQUFPN0IsR0FBRyxJQUFJQSxHQUFHLENBQUMwQixVQUFKLENBQWVqRCxJQUFmLEVBQXFCLElBQXJCLENBQWQ7QUFDSDs7QUFFRHNELEVBQUFBLHVCQUF1QixHQUFHO0FBQ3RCLFFBQUlDLFNBQVMsR0FBRyxNQUFNRCx1QkFBTixFQUFoQjs7QUFDQUMsSUFBQUEsU0FBUyxDQUFDQyxNQUFWLENBQWlCLENBQWpCLEVBQW9CLENBQXBCLEVBQXVCcEUsSUFBSSxDQUFDNkIsT0FBTCxDQUFhQyxTQUFiLEVBQXdCdkIsT0FBTyxDQUFDOEQsYUFBaEMsQ0FBdkIsRUFBdUVyRSxJQUFJLENBQUM2QixPQUFMLENBQWFDLFNBQWIsRUFBd0J2QixPQUFPLENBQUMrRCxpQkFBaEMsQ0FBdkUsRUFBMkh0RSxJQUFJLENBQUM2QixPQUFMLENBQWFDLFNBQWIsRUFBd0J2QixPQUFPLENBQUNnRSxvQkFBaEMsQ0FBM0g7QUFDQSxXQUFPSixTQUFQO0FBQ0g7O0FBak11RDs7QUFvTTVESyxNQUFNLENBQUNDLE9BQVAsR0FBaUIvRCxTQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCBlYWNoQXN5bmNfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBSdW5hYmxlLCBTZXJ2aWNlQ29udGFpbmVyIH0gPSByZXF1aXJlKCdAZ2VueC9hcHAnKTtcbmNvbnN0IFJvdXRhYmxlID0gcmVxdWlyZSgnLi9Sb3V0YWJsZScpO1xuY29uc3QgTGl0ZXJhbCA9IHJlcXVpcmUoJy4vZW51bS9MaXRlcmFsJyk7XG5jb25zdCB7IGRlZmF1bHRCYWNrZW5kUGF0aCB9ID0gcmVxdWlyZSgnLi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBtb3VudCA9IHJlcXVpcmUoJ2tvYS1tb3VudCcpO1xuXG4vKipcbiAqIFdlYiBzZXJ2ZXIgY2xhc3MuXG4gKiBAY2xhc3NcbiAqIEBleHRlbmRzIFJvdXRhYmxlKEFwcClcbiAqL1xuY2xhc3MgV2ViU2VydmVyIGV4dGVuZHMgUm91dGFibGUoUnVuYWJsZShTZXJ2aWNlQ29udGFpbmVyKSkge1xuICAgIC8qKiAgICAgICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW25hbWU9J3NlcnZlciddIC0gVGhlIG5hbWUgb2YgdGhlIHNlcnZlci4gICAgIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBUaGUgYXBwIG1vZHVsZSdzIGV4dHJhIG9wdGlvbnMgZGVmaW5lZCBpbiBpdHMgcGFyZW50J3MgY29uZmlndXJhdGlvbi5cbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW29wdGlvbnMubG9nZ2VyXSAtIExvZ2dlciBvcHRpb25zXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy52ZXJib3NlPWZhbHNlXSAtIEZsYWcgdG8gb3V0cHV0IHRyaXZpYWwgaW5mb3JtYXRpb24gZm9yIGRpYWdub3N0aWNzXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmVudl0gLSBFbnZpcm9ubWVudCwgZGVmYXVsdCB0byBwcm9jZXNzLmVudi5OT0RFX0VOVlxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy53b3JraW5nUGF0aF0gLSBBcHAncyB3b3JraW5nIHBhdGgsIGRlZmF1bHQgdG8gcHJvY2Vzcy5jd2QoKVxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5jb25maWdQYXRoXSAtIEFwcCdzIGNvbmZpZyBwYXRoLCBkZWZhdWx0IHRvIFwiY29uZlwiIHVuZGVyIHdvcmtpbmdQYXRoICAgXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmNvbmZpZ05hbWVdIC0gQXBwJ3MgY29uZmlnIGJhc2VuYW1lLCBkZWZhdWx0IHRvIFwiYXBwXCJcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuYmFja2VuZFBhdGg9J3NlcnZlciddIC0gUmVsYXRpdmUgcGF0aCBvZiBiYWNrLWVuZCBzZXJ2ZXIgc291cmNlIGZpbGVzXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmNsaWVudFBhdGg9J2NsaWVudCddIC0gUmVsYXRpdmUgcGF0aCBvZiBmcm9udC1lbmQgY2xpZW50IHNvdXJjZSBmaWxlcyAgICAgXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnB1YmxpY1BhdGg9J3B1YmxpYyddIC0gUmVsYXRpdmUgcGF0aCBvZiBmcm9udC1lbmQgc3RhdGljIGZpbGVzICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5hcHBNb2R1bGVzUGF0aD1hcHBfbW9kdWxlc10gLSBSZWxhdGl2ZSBwYXRoIG9mIGNoaWxkIG1vZHVsZXMgICAgICAgICAgICAgICAgICAgIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAndW5kZWZpbmVkJyAmJiBfLmlzUGxhaW5PYmplY3QobmFtZSkpIHtcbiAgICAgICAgICAgIG9wdGlvbnMgPSBuYW1lO1xuICAgICAgICAgICAgbmFtZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgfSAgICAgICAgXG5cbiAgICAgICAgc3VwZXIobmFtZSB8fCAnc2VydmVyJywgT2JqZWN0LmFzc2lnbih7IGNvbmZpZ05hbWU6IExpdGVyYWwuU0VSVkVSX0NGR19OQU1FIH0sIG9wdGlvbnMpKTsgICAgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEhvc3Rpbmcgc2VydmVyLlxuICAgICAgICAgKiBAbWVtYmVyIHtXZWJTZXJ2ZXJ9XG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5zZXJ2ZXIgPSB0aGlzO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBXaGV0aGVyIGl0IGlzIGEgc2VydmVyLlxuICAgICAgICAgKiBAbWVtYmVyIHtib29sZWFufVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMuaXNTZXJ2ZXIgPSB0cnVlO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBCYWNrZW5kIGZpbGVzIHBhdGguXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gICAgICAgICBcbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLmJhY2tlbmRQYXRoID0gdGhpcy50b0Fic29sdXRlUGF0aCh0aGlzLm9wdGlvbnMuYmFja2VuZFBhdGggfHwgZGVmYXVsdEJhY2tlbmRQYXRoKTsgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFwcCBtb2R1bGVzIHBhdGguXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuYXBwTW9kdWxlc1BhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5hcHBNb2R1bGVzUGF0aCB8fCBMaXRlcmFsLkFQUF9NT0RVTEVTX1BBVEgpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBCYXNlIHJvdXRlLlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnJvdXRlID0gXCIvXCI7XG4gICAgICAgIFxuICAgICAgICB0aGlzLm9uKCdjb25maWdMb2FkZWQnLCAoKSA9PiB7XG4gICAgICAgICAgICAvLyBsb2FkIGJ1aWx0aW4gbWlkZGxld2FyZXNcbiAgICAgICAgICAgIHRoaXMubG9hZE1pZGRsZXdhcmVzRnJvbShwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBMaXRlcmFsLk1JRERMRVdBUkVTX1BBVEgpKTtcbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9XG5cbiAgICBhc3luYyBzdG9wXygpIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhcnRlZCkge1xuICAgICAgICAgICAgaWYgKHRoaXMuYXBwTW9kdWxlcykge1xuICAgICAgICAgICAgICAgIGF3YWl0IGVhY2hBc3luY18odGhpcy5hcHBNb2R1bGVzLCBhcHAgPT4gYXBwLnN0b3BfKCkpO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmFwcE1vZHVsZXM7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuYXBwTW9kdWxlc0J5QWxpYXM7XG4gICAgICAgICAgICB9ICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAodGhpcy5saWJNb2R1bGVzKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgZWFjaEFzeW5jXyh0aGlzLmxpYk1vZHVsZXMsIGxpYiA9PiBsaWIuc3RvcF8oKSk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubGliTW9kdWxlcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmh0dHBTZXJ2ZXIpIHtcbiAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmh0dHBTZXJ2ZXIuY2xvc2UoKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycik7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgZGVsZXRlIHRoaXMuaHR0cFNlcnZlcjtcbiAgICAgICAgICAgIHRoaXMubG9nKCdpbmZvJywgYFRoZSBodHRwIHNlcnZpY2UgaXMgc3RvcHBlZC5gKTsgXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc3VwZXIuc3RvcF8oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNb3VudCBhbiBhcHAgYXQgc3BlY2lmaWVkIHJvdXRlLlxuICAgICAqIEBwYXJhbSB7V2ViTW9kdWxlfSBhcHAgXG4gICAgICovXG4gICAgbW91bnRBcHAoYXBwKSB7XG4gICAgICAgIGlmICghdGhpcy5hcHBNb2R1bGVzKSB7XG4gICAgICAgICAgICB0aGlzLmFwcE1vZHVsZXMgPSB7fTtcbiAgICAgICAgICAgIHRoaXMuYXBwTW9kdWxlc0J5QWxpYXMgPSB7fTtcbiAgICAgICAgfVxuXG4gICAgICAgIGFzc2VydDogIXRoaXMuYXBwTW9kdWxlcy5oYXNPd25Qcm9wZXJ0eShhcHAucm91dGUpO1xuXG4gICAgICAgIHRoaXMucm91dGVyLnVzZShtb3VudChhcHAucm91dGUsIGFwcC5yb3V0ZXIpKTtcbiAgICAgICAgdGhpcy5hcHBNb2R1bGVzW2FwcC5yb3V0ZV0gPSBhcHA7XG5cbiAgICAgICAgaWYgKGFwcC5uYW1lIGluIHRoaXMuYXBwTW9kdWxlc0J5QWxpYXMpIHtcbiAgICAgICAgICAgIGxldCBleGlzdGluZ0FwcCA9IHRoaXMuYXBwTW9kdWxlc0J5QWxpYXNbYXBwLm5hbWVdO1xuICAgICAgICAgICAgLy9tb3ZlIGJ1Y2tldFxuICAgICAgICAgICAgdGhpcy5hcHBNb2R1bGVzQnlBbGlhc1tgJHtleGlzdGluZ0FwcC5uYW1lfVtAJHtleGlzdGluZ0FwcC5yb3V0ZX1dYF0gPSBleGlzdGluZ0FwcDtcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmFwcE1vZHVsZXNCeUFsaWFzW2FwcC5uYW1lXTtcblxuICAgICAgICAgICAgdGhpcy5hcHBNb2R1bGVzQnlBbGlhc1tgJHthcHAubmFtZX1bQCR7YXBwLnJvdXRlfV1gXSA9IGFwcDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYXBwTW9kdWxlc0J5QWxpYXNbYXBwLm5hbWVdID0gYXBwO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgQWxsIHJvdXRlcyBmcm9tIGFwcCBbJHthcHAubmFtZX1dIGFyZSBtb3VudGVkIHVuZGVyIFwiJHthcHAucm91dGV9XCIuYCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVnaXN0ZXIgYSBsb2FkZWQgbGliIG1vZHVsZVxuICAgICAqIEBwYXJhbSB7TGliTW9kdWxlfSBsaWIgXG4gICAgICovXG4gICAgcmVnaXN0ZXJMaWIobGliKSB7XG4gICAgICAgIGlmICghdGhpcy5saWJNb2R1bGVzKSB7XG4gICAgICAgICAgICB0aGlzLmxpYk1vZHVsZXMgPSB7fTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubGliTW9kdWxlc1tsaWIubmFtZV0gPSBsaWI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSBhcHAgbW9kdWxlIG9iamVjdCBieSBiYXNlIHJvdXRlXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHAgLSBBcHAgbW9kdWxlIGJhc2Ugcm91dGUgc3RhcnRlZCB3aXRoIFwiL1wiXG4gICAgICovXG4gICAgZ2V0QXBwQnlSb3V0ZShwKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwcE1vZHVsZXNbcF07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSBhcHAgbW9kdWxlIG9iamVjdCBieSBhcHAgYWxpYXMsIHVzdWFsbHkgdGhlIGFwcCBuYW1lIGlmIG5vIGR1cGxpY2F0ZSBlbnRyeVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBhIC0gQXBwIG1vZHVsZSBhbGlhc1xuICAgICAqL1xuICAgIGdldEFwcEJ5QWxpYXMoYSkge1xuICAgICAgICByZXR1cm4gdGhpcy5hcHBNb2R1bGVzQnlBbGlhc1thXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGxpYiBtb2R1bGVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbGliTmFtZSBcbiAgICAgKi9cbiAgICBnZXRMaWIobGliTmFtZSkge1xuICAgICAgICBpZiAoIXRoaXMubGliTW9kdWxlcykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcImxpYk1vZHVsZXNcIiBmZWF0dXJlIGlzIHJlcXVpcmVkIHRvIGFjY2VzcyBsaWIgYW1vbmcgbW9kdWxlcy4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBsaWJNb2R1bGUgPSB0aGlzLmxpYk1vZHVsZXNbbGliTmFtZV07XG4gICAgICAgIFxuICAgICAgICBpZiAoIWxpYk1vZHVsZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBMaWIgbW9kdWxlIFske2xpYk5hbWV9XSBub3QgZm91bmQuYCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbGliTW9kdWxlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcXVpcmUgYSBtb2R1bGUgZnJvbSB0aGUgc291cmNlIHBhdGggb2YgYSBsaWJyYXJ5IG1vZHVsZVxuICAgICAqIEBwYXJhbSB7Kn0gcmVsYXRpdmVQYXRoIFxuICAgICAqL1xuICAgIHJlcXVpcmVGcm9tTGliKGxpYk5hbWUsIHJlbGF0aXZlUGF0aCkge1xuICAgICAgICBsZXQgbGliTW9kdWxlID0gdGhpcy5nZXRMaWIobGliTmFtZSk7XG4gICAgICAgIHJldHVybiBsaWJNb2R1bGUucmVxdWlyZShyZWxhdGl2ZVBhdGgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBhIHJlZ2lzdGVyZWQgc2VydmljZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFxuICAgICAqL1xuICAgIGdldFNlcnZpY2UobmFtZSkge1xuICAgICAgICBsZXQgcG9zID0gbmFtZS5pbmRleE9mKCc6Jyk7XG4gICAgICAgIGlmIChwb3MgPT09IC0xKSB7XG4gICAgICAgICAgICByZXR1cm4gc3VwZXIuZ2V0U2VydmljZShuYW1lKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBtb2RBbGlhcyA9IG5hbWUuc3Vic3RyKDAsIHBvcyk7XG4gICAgICAgIG5hbWUgPSBuYW1lLnN1YnN0cihwb3MrMSk7XG5cbiAgICAgICAgbGV0IGFwcCA9IHRoaXMuZ2V0QXBwQnlBbGlhcyhtb2RBbGlhcyk7XG4gICAgICAgIHJldHVybiBhcHAgJiYgYXBwLmdldFNlcnZpY2UobmFtZSwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKSB7XG4gICAgICAgIGxldCBwYXRoQXJyYXkgPSBzdXBlci5fZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCgpO1xuICAgICAgICBwYXRoQXJyYXkuc3BsaWNlKDEsIDAsIHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIExpdGVyYWwuRkVBVFVSRVNfUEFUSCksIHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIExpdGVyYWwuQVBQX0ZFQVRVUkVTX1BBVEgpLCBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBMaXRlcmFsLlNFUlZFUl9GRUFUVVJFU19QQVRIKSk7XG4gICAgICAgIHJldHVybiBwYXRoQXJyYXk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFdlYlNlcnZlcjsiXX0=