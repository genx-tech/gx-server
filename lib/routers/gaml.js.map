{"version":3,"sources":["../../src/routers/gaml.js"],"names":["path","require","glob","_","naming","text","Literal","Router","hasMethod","appendId","baseEndpoint","idName","module","exports","app","baseRoute","options","resourcePath","resolve","backendPath","resourcesPath","RESOURCES_PATH","router","prefix","dropIfEndsWith","useMiddleware","getMiddlewareFactory","errorOptions","middlewares","useMiddlewares","join","files","sync","nodir","each","file","entityName","basename","controller","remaps","ensureStartsWith","kebabCase","camelCase","endpointWithId","_action","find","bind","_middlewares","__metaMiddlewares","addRoute","post","ctx","findById","params","updateById","deleteById","addRouter"],"mappings":"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","sourcesContent":["\"use strict\";\n\nconst path = require(\"path\");\nconst { glob } = require(\"@genx/sys\");\nconst { _, naming, text } = require(\"@genx/july\");\nconst Literal = require(\"../enum/Literal\");\nconst Router = require(\"@koa/router\");\nconst { hasMethod } = require(\"../utils/Helpers\");\n\n/**\n * Gaml router.\n * @module Router_Gaml\n */\n\nconst appendId = (baseEndpoint, idName) => (idName ? `${baseEndpoint}/:${idName}` : baseEndpoint);\n\n/**\n * Create a gaml router.\n * @param {*} app\n * @param {string} baseRoute\n * @param {objects} options\n * @property {string} [options.resourcesPath]\n * @property {object|array} [options.middlewares]\n * @example\n *  '<base path>': {\n *      gaml: {\n *          resourcesPath:\n *          middlewares:\n *      }\n *  }\n *\n *  route                          http method    function of ctrl\n *  /:resource                     get            find\n *  /:resource                     post           post\n *  /:resource/:id                 get            findById\n *  /:resource/:id                 put            updateById\n *  /:resource/:id                 del            deleteById\n */\nmodule.exports = (app, baseRoute, options) => {\n    let resourcePath = path.resolve(app.backendPath, options.resourcesPath || Literal.RESOURCES_PATH);\n\n    let router = baseRoute === \"/\" ? new Router() : new Router({ prefix: text.dropIfEndsWith(baseRoute, \"/\") });\n\n    app.useMiddleware(router, app.getMiddlewareFactory(\"jsonError\")(options.errorOptions, app), \"jsonError\");\n\n    if (options.middlewares) {\n        app.useMiddlewares(router, options.middlewares);\n    }\n\n    let resourcesPath = path.join(resourcePath, \"*.js\");\n    let files = glob.sync(resourcesPath, { nodir: true });\n\n    _.each(files, (file) => {\n        let entityName = path.basename(file, \".js\");\n        let controller = require(file);\n\n        if (typeof controller === \"function\") {\n            controller = new controller(app);\n        }\n\n        let baseEndpoint;\n\n        if (options.remaps && entityName in options.remaps) {\n            baseEndpoint = text.ensureStartsWith(text.dropIfEndsWith(options.remaps[entityName], \"/\"), \"/\");\n        } else {\n            baseEndpoint = text.ensureStartsWith(naming.kebabCase(entityName), \"/\");\n        }\n\n        let idName = naming.camelCase(entityName) + \"Id\";\n        let endpointWithId = appendId(baseEndpoint, idName);\n\n        if (hasMethod(controller, \"find\")) {\n            const _action = controller.find.bind(controller);\n            const _middlewares = controller.find.__metaMiddlewares;\n            app.addRoute(router, \"get\", baseEndpoint, _middlewares ? [..._middlewares, _action] : _action);\n        }\n\n        if (hasMethod(controller, \"post\")) {\n            const _action = controller.post.bind(controller);\n            const _middlewares = controller.post.__metaMiddlewares;\n            app.addRoute(router, \"post\", baseEndpoint, _middlewares ? [..._middlewares, _action] : _action);\n        }\n\n        if (hasMethod(controller, \"findById\")) {\n            const _action = (ctx) => controller.findById(ctx, ctx.params[idName]);\n            const _middlewares = controller.findById.__metaMiddlewares;\n            app.addRoute(router, \"get\", endpointWithId, _middlewares ? [..._middlewares, _action] : _action);\n        }\n\n        if (hasMethod(controller, \"updateById\")) {\n            const _action = (ctx) => controller.updateById(ctx, ctx.params[idName]);\n            const _middlewares = controller.updateById.__metaMiddlewares;\n            app.addRoute(router, \"put\", endpointWithId, _middlewares ? [..._middlewares, _action] : _action);\n        }\n\n        if (hasMethod(controller, \"deleteById\")) {\n            const _action = (ctx) => controller.deleteById(ctx, ctx.params[idName]);\n            const _middlewares = controller.deleteById.__metaMiddlewares;\n            app.addRoute(router, \"del\", endpointWithId, _middlewares ? [..._middlewares, _action] : _action);\n        }\n    });\n\n    app.addRouter(router);\n};\n"],"file":"gaml.js"}