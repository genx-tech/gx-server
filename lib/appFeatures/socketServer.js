"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  urlJoin,
  ensureLeftSlash
} = require('rk-utils');

const {
  Feature,
  Literal
} = require('..').enum;

const {
  tryRequire
} = require('@genx/app/lib/utils/Helpers');

const SocketServer = tryRequire('socket.io');

const {
  InvalidConfiguration
} = require('../utils/Errors');

function loadEventHandler(appModule, channelName, controllerBasePath, handlerName, isMiddleware = false) {
  let pos = handlerName.lastIndexOf('.');

  if (pos < 0) {
    if (isMiddleware) {
      throw new InvalidConfiguration(`Invalid middleware reference: ${handlerName}`, appModule, channelName ? `socketServer.channels.${channelName}.middlewares` : 'socketServer.middlewares');
    } else {
      throw new InvalidConfiguration(`Invalid event handler reference: ${handlerName}`, appModule, `socketServer.channels.${channelName}.events`);
    }
  }

  let controller = handlerName.substr(0, pos);
  let action = handlerName.substr(pos + 1);
  let controllerPath = path.resolve(controllerBasePath, controller + '.js');

  let ctrl = require(controllerPath);

  let middlewareHandler = ctrl[action];

  if (typeof middlewareHandler !== 'function') {
    if (isMiddleware) {
      throw new InvalidConfiguration(`Middleware function not found: ${handlerName}`, appModule, channelName ? `socketServer.channels.${channelName}.middlewares` : 'socketServer.middlewares');
    } else {
      throw new InvalidConfiguration(`Event handler function not found: ${handlerName}`, appModule, `socketServer.channels.${channelName}.events`);
    }
  }

  return middlewareHandler;
}

module.exports = {
  type: Feature.PLUGIN,
  load_: (appModule, servers) => {
    servers = _.castArray(servers);
    servers.forEach((config, i) => {
      let serverTag = `socketServer#${i}`;
      let io,
          standalone = false;
      let endpointPath = config.path ? urlJoin(appModule.route, config.path) : appModule.route;
      endpointPath = ensureLeftSlash(endpointPath);
      let serviceTag = `socketServer:${endpointPath}`;

      if (appModule.hasService(serviceTag)) {
        throw new InvalidConfiguration('Socket server path conflict.', appModule, 'socketServer.path');
      }

      appModule.log('verbose', `[${serverTag}]Server listening at: ${endpointPath}`);
      let options = {
        path: endpointPath
      };

      if (config.port) {
        io = new SocketServer(options);
        standalone = true;
      } else {
        io = new SocketServer(appModule.server.httpServer, options);
      }

      io.on('connection', socket => {
        appModule.log('info', `[${serverTag}]New client connected.`, {
          id: socket.id,
          handshake: socket.handshake
        });
      });
      let controllersPath = path.resolve(appModule.backendPath, config.controllersPath || Literal.WS_CONTROLLERS_PATH);

      if (config.middlewares) {
        io.use(loadEventHandler(appModule, null, controllersPath, middlewareName, true));
      }

      if (_.isEmpty(config.channels)) {
        throw new InvalidConfiguration('Missing channels config.', appModule, 'socketServer.channels');
      }

      _.forOwn(config.channels, (info, name) => {
        name = ensureLeftSlash(name);
        let ioChannel = io.of(name);

        if (info.middlewares) {
          let m = Array.isArray(info.middlewares) ? info.middlewares : [info.middlewares];
          m.forEach(middlewareName => {
            ioChannel.use(loadEventHandler(appModule, name, controllersPath, middlewareName, true));
          });
        }

        let eventHandlers;

        if (info.controller) {
          let rpcControllerPath = path.resolve(controllersPath, info.controller + '.js');
          eventHandlers = require(rpcControllerPath);
          appModule.log('info', `[${serverTag}]Controller "${info.controller}" attached for channel "${name}".`);
        }

        if (info.events) {
          eventHandlers = {};

          _.forOwn(info.events, (handler, event) => {
            eventHandlers[event] = loadEventHandler(appModule, name, controllersPath, handler);
          });

          appModule.log('info', `[${serverTag}]Event handlers attached for channel "${name}".`, {
            events: Object.keys(eventHandlers)
          });
        }

        if (_.isEmpty(eventHandlers)) {
          throw new InvalidConfiguration('Missing socket response controller or event hooks.', appModule, `socketServer.channels.${name}`);
        }

        ioChannel.on('connect', function (socket) {
          appModule.log('info', `[${serverTag}]Client [id=${socket.id}] connected to channel "${name}".`);

          for (let event in eventHandlers) {
            let handler = eventHandlers[event];
            socket.on(event, (data, cb) => handler({
              appModule,
              socket
            }, data).then(cb));
          }

          if (info.welcomeMessage) {
            socket.emit('welcome', info.welcomeMessage);
          }

          socket.on('disconnect', () => {
            appModule.log('info', `[${serverTag}]Client [id=${socket.id}] disconnected from channel "${name}".`);
          });
        });
      });

      if (standalone) {
        io.listen(config.port);
        appModule.log('info', `[${serverTag}]A standalone socket server is listening on port [${config.port}] ...`);
      }

      appModule.registerService(serviceTag, io);
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcHBGZWF0dXJlcy9zb2NrZXRTZXJ2ZXIuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwidXJsSm9pbiIsImVuc3VyZUxlZnRTbGFzaCIsIkZlYXR1cmUiLCJMaXRlcmFsIiwiZW51bSIsInRyeVJlcXVpcmUiLCJTb2NrZXRTZXJ2ZXIiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsImxvYWRFdmVudEhhbmRsZXIiLCJhcHBNb2R1bGUiLCJjaGFubmVsTmFtZSIsImNvbnRyb2xsZXJCYXNlUGF0aCIsImhhbmRsZXJOYW1lIiwiaXNNaWRkbGV3YXJlIiwicG9zIiwibGFzdEluZGV4T2YiLCJjb250cm9sbGVyIiwic3Vic3RyIiwiYWN0aW9uIiwiY29udHJvbGxlclBhdGgiLCJyZXNvbHZlIiwiY3RybCIsIm1pZGRsZXdhcmVIYW5kbGVyIiwibW9kdWxlIiwiZXhwb3J0cyIsInR5cGUiLCJQTFVHSU4iLCJsb2FkXyIsInNlcnZlcnMiLCJjYXN0QXJyYXkiLCJmb3JFYWNoIiwiY29uZmlnIiwiaSIsInNlcnZlclRhZyIsImlvIiwic3RhbmRhbG9uZSIsImVuZHBvaW50UGF0aCIsInJvdXRlIiwic2VydmljZVRhZyIsImhhc1NlcnZpY2UiLCJsb2ciLCJvcHRpb25zIiwicG9ydCIsInNlcnZlciIsImh0dHBTZXJ2ZXIiLCJvbiIsInNvY2tldCIsImlkIiwiaGFuZHNoYWtlIiwiY29udHJvbGxlcnNQYXRoIiwiYmFja2VuZFBhdGgiLCJXU19DT05UUk9MTEVSU19QQVRIIiwibWlkZGxld2FyZXMiLCJ1c2UiLCJtaWRkbGV3YXJlTmFtZSIsImlzRW1wdHkiLCJjaGFubmVscyIsImZvck93biIsImluZm8iLCJuYW1lIiwiaW9DaGFubmVsIiwib2YiLCJtIiwiQXJyYXkiLCJpc0FycmF5IiwiZXZlbnRIYW5kbGVycyIsInJwY0NvbnRyb2xsZXJQYXRoIiwiZXZlbnRzIiwiaGFuZGxlciIsImV2ZW50IiwiT2JqZWN0Iiwia2V5cyIsImRhdGEiLCJjYiIsInRoZW4iLCJ3ZWxjb21lTWVzc2FnZSIsImVtaXQiLCJsaXN0ZW4iLCJyZWdpc3RlclNlcnZpY2UiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBU0EsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsT0FBTDtBQUFjQyxFQUFBQTtBQUFkLElBQWtDSCxPQUFPLENBQUMsVUFBRCxDQUEvQzs7QUFDQSxNQUFNO0FBQUVJLEVBQUFBLE9BQUY7QUFBV0MsRUFBQUE7QUFBWCxJQUF1QkwsT0FBTyxDQUFDLElBQUQsQ0FBUCxDQUFjTSxJQUEzQzs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBaUJQLE9BQU8sQ0FBQyw2QkFBRCxDQUE5Qjs7QUFDQSxNQUFNUSxZQUFZLEdBQUdELFVBQVUsQ0FBQyxXQUFELENBQS9COztBQUNBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUEyQlQsT0FBTyxDQUFDLGlCQUFELENBQXhDOztBQUVBLFNBQVNVLGdCQUFULENBQTBCQyxTQUExQixFQUFxQ0MsV0FBckMsRUFBa0RDLGtCQUFsRCxFQUFzRUMsV0FBdEUsRUFBbUZDLFlBQVksR0FBRyxLQUFsRyxFQUF5RztBQUNyRyxNQUFJQyxHQUFHLEdBQUdGLFdBQVcsQ0FBQ0csV0FBWixDQUF3QixHQUF4QixDQUFWOztBQUNBLE1BQUlELEdBQUcsR0FBRyxDQUFWLEVBQWE7QUFDVCxRQUFJRCxZQUFKLEVBQWtCO0FBQ2QsWUFBTSxJQUFJTixvQkFBSixDQUNELGlDQUFnQ0ssV0FBWSxFQUQzQyxFQUVGSCxTQUZFLEVBR0ZDLFdBQVcsR0FBSSx5QkFBd0JBLFdBQVksY0FBeEMsR0FBd0QsMEJBSGpFLENBQU47QUFLSCxLQU5ELE1BTU87QUFDSCxZQUFNLElBQUlILG9CQUFKLENBQ0Qsb0NBQW1DSyxXQUFZLEVBRDlDLEVBRUZILFNBRkUsRUFHRCx5QkFBd0JDLFdBQVksU0FIbkMsQ0FBTjtBQUtIO0FBQ0o7O0FBRUQs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QUFNLENBQUNXLElBQUssT0FBcEc7QUFDSDs7QUFFRGpDLE1BQUFBLFNBQVMsQ0FBQ3FFLGVBQVYsQ0FBMEJ4QyxVQUExQixFQUFzQ0osRUFBdEM7QUFDSCxLQXRIRDtBQXVISDtBQTNJWSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKipcbiAqIFNvY2tldCBiYXNlZCBScGMgU2VydmVyXG4gKiBAbW9kdWxlIEZlYXR1cmVfU29ja2V0U2VydmVyXG4gKiBcbiAqIG1pZGRsZXdhcmU6IChwYWNrZXQsIG5leHQpID0+IHt9XG4gKi9cblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgdXJsSm9pbiwgZW5zdXJlTGVmdFNsYXNoIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBGZWF0dXJlLCBMaXRlcmFsIH0gPSByZXF1aXJlKCcuLicpLmVudW07XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJ0BnZW54L2FwcC9saWIvdXRpbHMvSGVscGVycycpO1xuY29uc3QgU29ja2V0U2VydmVyID0gdHJ5UmVxdWlyZSgnc29ja2V0LmlvJyk7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uIH0gPSByZXF1aXJlKCcuLi91dGlscy9FcnJvcnMnKTtcblxuZnVuY3Rpb24gbG9hZEV2ZW50SGFuZGxlcihhcHBNb2R1bGUsIGNoYW5uZWxOYW1lLCBjb250cm9sbGVyQmFzZVBhdGgsIGhhbmRsZXJOYW1lLCBpc01pZGRsZXdhcmUgPSBmYWxzZSkge1xuICAgIGxldCBwb3MgPSBoYW5kbGVyTmFtZS5sYXN0SW5kZXhPZignLicpO1xuICAgIGlmIChwb3MgPCAwKSB7XG4gICAgICAgIGlmIChpc01pZGRsZXdhcmUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICBgSW52YWxpZCBtaWRkbGV3YXJlIHJlZmVyZW5jZTogJHtoYW5kbGVyTmFtZX1gLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICBjaGFubmVsTmFtZSA/IGBzb2NrZXRTZXJ2ZXIuY2hhbm5lbHMuJHtjaGFubmVsTmFtZX0ubWlkZGxld2FyZXNgIDogJ3NvY2tldFNlcnZlci5taWRkbGV3YXJlcydcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgYEludmFsaWQgZXZlbnQgaGFuZGxlciByZWZlcmVuY2U6ICR7aGFuZGxlck5hbWV9YCxcbiAgICAgICAgICAgICAgICBhcHBNb2R1bGUsXG4gICAgICAgICAgICAgICAgYHNvY2tldFNlcnZlci5jaGFubmVscy4ke2NoYW5uZWxOYW1lfS5ldmVudHNgXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGNvbnRyb2xsZXIgPSBoYW5kbGVyTmFtZS5zdWJzdHIoMCwgcG9zKTtcbiAgICBsZXQgYWN0aW9uID0gaGFuZGxlck5hbWUuc3Vic3RyKHBvcyArIDEpO1xuXG4gICAgbGV0IGNvbnRyb2xsZXJQYXRoID0gcGF0aC5yZXNvbHZlKGNvbnRyb2xsZXJCYXNlUGF0aCwgY29udHJvbGxlciArICcuanMnKTtcbiAgICBsZXQgY3RybCA9IHJlcXVpcmUoY29udHJvbGxlclBhdGgpO1xuICAgIGxldCBtaWRkbGV3YXJlSGFuZGxlciA9IGN0cmxbYWN0aW9uXTtcbiAgICBpZiAodHlwZW9mIG1pZGRsZXdhcmVIYW5kbGVyICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGlmIChpc01pZGRsZXdhcmUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICBgTWlkZGxld2FyZSBmdW5jdGlvbiBub3QgZm91bmQ6ICR7aGFuZGxlck5hbWV9YCxcbiAgICAgICAgICAgICAgICBhcHBNb2R1bGUsXG4gICAgICAgICAgICAgICAgY2hhbm5lbE5hbWUgPyBgc29ja2V0U2VydmVyLmNoYW5uZWxzLiR7Y2hhbm5lbE5hbWV9Lm1pZGRsZXdhcmVzYCA6ICdzb2NrZXRTZXJ2ZXIubWlkZGxld2FyZXMnXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgIGBFdmVudCBoYW5kbGVyIGZ1bmN0aW9uIG5vdCBmb3VuZDogJHtoYW5kbGVyTmFtZX1gLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICBgc29ja2V0U2VydmVyLmNoYW5uZWxzLiR7Y2hhbm5lbE5hbWV9LmV2ZW50c2BcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbWlkZGxld2FyZUhhbmRsZXI7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuXG4gICAgLyoqXG4gICAgICogVGhpcyBmZWF0dXJlIGlzIGxvYWRlZCBhdCBwbHVnaW4gc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5QTFVHSU4sXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIHRoZSBycGMgU2VydmVyXG4gICAgICogQHBhcmFtIHtBcHBNb2R1bGV9IGFwcE1vZHVsZSAtIFRoZSBhcHAgbW9kdWxlIG9iamVjdFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb25maWcgLSBScGMgc2VydmVyIGNvbmZpZ1xuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbY29uZmlnLnBhdGhdIC0gVGhlIHBhdGggb2Ygc29ja2V0IHNlcnZlclxuICAgICAqIEBwcm9wZXJ0eSB7aW50fSBbY29uZmlnLnBvcnRdIC0gVGhlIHBvcnQgbnVtYmVyIG9mIHRoZSBzZXJ2ZXJcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW2NvbmZpZy5jb250cm9sbGVyc1BhdGhdIC0gVGhlIHBvcnQgbnVtYmVyIG9mIHRoZSBzZXJ2ZXIgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbY29uZmlnLm1pZGRsZXdhcmVzXSAtIE1pZGRsZXdhcmVzIGZvciBhbGwgY2hhbm5lbFxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0LjxzdHJpbmcsIE9iamVjdD59IFtjb25maWcuY2hhbm5lbHNdIC0gQ2hhbm5lbHNcbiAgICAgKi9cbiAgICBsb2FkXzogKGFwcE1vZHVsZSwgc2VydmVycykgPT4geyAgICAgICAgXG4gICAgICAgIHNlcnZlcnMgPSBfLmNhc3RBcnJheShzZXJ2ZXJzKTtcbiAgICAgICAgc2VydmVycy5mb3JFYWNoKChjb25maWcsIGkpID0+IHtcbiAgICAgICAgICAgIGxldCBzZXJ2ZXJUYWcgPSBgc29ja2V0U2VydmVyIyR7aX1gO1xuICAgICAgICAgICAgbGV0IGlvLCBzdGFuZGFsb25lID0gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAgICAgbGV0IGVuZHBvaW50UGF0aCA9IGNvbmZpZy5wYXRoID8gdXJsSm9pbihhcHBNb2R1bGUucm91dGUsIGNvbmZpZy5wYXRoKSA6IGFwcE1vZHVsZS5yb3V0ZTtcbiAgICAgICAgICAgIGVuZHBvaW50UGF0aCA9IGVuc3VyZUxlZnRTbGFzaChlbmRwb2ludFBhdGgpO1xuXG4gICAgICAgICAgICBsZXQgc2VydmljZVRhZyA9IGBzb2NrZXRTZXJ2ZXI6JHtlbmRwb2ludFBhdGh9YDtcblxuICAgICAgICAgICAgaWYgKGFwcE1vZHVsZS5oYXNTZXJ2aWNlKHNlcnZpY2VUYWcpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAnU29ja2V0IHNlcnZlciBwYXRoIGNvbmZsaWN0LicsXG4gICAgICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICAgICAgJ3NvY2tldFNlcnZlci5wYXRoJ1xuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGFwcE1vZHVsZS5sb2coJ3ZlcmJvc2UnLCBgWyR7c2VydmVyVGFnfV1TZXJ2ZXIgbGlzdGVuaW5nIGF0OiAke2VuZHBvaW50UGF0aH1gKTsgICAgICAgIFxuXG4gICAgICAgICAgICBsZXQgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICBwYXRoOiBlbmRwb2ludFBhdGhcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmIChjb25maWcucG9ydCkge1xuICAgICAgICAgICAgICAgIGlvID0gbmV3IFNvY2tldFNlcnZlcihvcHRpb25zKTtcbiAgICAgICAgICAgICAgICBzdGFuZGFsb25lID0gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaW8gPSBuZXcgU29ja2V0U2VydmVyKGFwcE1vZHVsZS5zZXJ2ZXIuaHR0cFNlcnZlciwgb3B0aW9ucylcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaW8ub24oJ2Nvbm5lY3Rpb24nLCBzb2NrZXQgPT4ge1xuICAgICAgICAgICAgICAgIGFwcE1vZHVsZS5sb2coJ2luZm8nLCBgWyR7c2VydmVyVGFnfV1OZXcgY2xpZW50IGNvbm5lY3RlZC5gLCB7XG4gICAgICAgICAgICAgICAgICAgIGlkOiBzb2NrZXQuaWQsXG4gICAgICAgICAgICAgICAgICAgIGhhbmRzaGFrZTogc29ja2V0LmhhbmRzaGFrZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGxldCBjb250cm9sbGVyc1BhdGggPSBwYXRoLnJlc29sdmUoYXBwTW9kdWxlLmJhY2tlbmRQYXRoLCBjb25maWcuY29udHJvbGxlcnNQYXRoIHx8IExpdGVyYWwuV1NfQ09OVFJPTExFUlNfUEFUSCk7XG5cbiAgICAgICAgICAgIGlmIChjb25maWcubWlkZGxld2FyZXMpIHtcbiAgICAgICAgICAgICAgICBpby51c2UobG9hZEV2ZW50SGFuZGxlcihhcHBNb2R1bGUsIG51bGwsIGNvbnRyb2xsZXJzUGF0aCwgbWlkZGxld2FyZU5hbWUsIHRydWUpKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKF8uaXNFbXB0eShjb25maWcuY2hhbm5lbHMpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAnTWlzc2luZyBjaGFubmVscyBjb25maWcuJyxcbiAgICAgICAgICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgICAgICAgICAnc29ja2V0U2VydmVyLmNoYW5uZWxzJ1xuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9ICAgICAgICBcblxuICAgICAgICAgICAgXy5mb3JPd24oY29uZmlnLmNoYW5uZWxzLCAoaW5mbywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIG5hbWUgPSBlbnN1cmVMZWZ0U2xhc2gobmFtZSk7XG5cbiAgICAgICAgICAgICAgICBsZXQgaW9DaGFubmVsID0gaW8ub2YobmFtZSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoaW5mby5taWRkbGV3YXJlcykge1xuICAgICAgICAgICAgICAgICAgICBsZXQgbSA9IEFycmF5LmlzQXJyYXkoaW5mby5taWRkbGV3YXJlcykgPyBpbmZvLm1pZGRsZXdhcmVzIDogWyBpbmZvLm1pZGRsZXdhcmVzIF07XG4gICAgICAgICAgICAgICAgICAgIG0uZm9yRWFjaChtaWRkbGV3YXJlTmFtZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpb0NoYW5uZWwudXNlKGxvYWRFdmVudEhhbmRsZXIoYXBwTW9kdWxlLCBuYW1lLCBjb250cm9sbGVyc1BhdGgsIG1pZGRsZXdhcmVOYW1lLCB0cnVlKSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxldCBldmVudEhhbmRsZXJzO1xuXG4gICAgICAgICAgICAgICAgaWYgKGluZm8uY29udHJvbGxlcikgeyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJwY0NvbnRyb2xsZXJQYXRoID0gcGF0aC5yZXNvbHZlKGNvbnRyb2xsZXJzUGF0aCwgaW5mby5jb250cm9sbGVyICsgJy5qcycpO1xuICAgICAgICAgICAgICAgICAgICBldmVudEhhbmRsZXJzID0gcmVxdWlyZShycGNDb250cm9sbGVyUGF0aCk7XG5cbiAgICAgICAgICAgICAgICAgICAgYXBwTW9kdWxlLmxvZygnaW5mbycsIGBbJHtzZXJ2ZXJUYWd9XUNvbnRyb2xsZXIgXCIke2luZm8uY29udHJvbGxlcn1cIiBhdHRhY2hlZCBmb3IgY2hhbm5lbCBcIiR7bmFtZX1cIi5gKTtcbiAgICAgICAgICAgICAgICB9IFxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChpbmZvLmV2ZW50cykge1xuICAgICAgICAgICAgICAgICAgICBldmVudEhhbmRsZXJzID0ge307XG5cbiAgICAgICAgICAgICAgICAgICAgXy5mb3JPd24oaW5mby5ldmVudHMsIChoYW5kbGVyLCBldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRIYW5kbGVyc1tldmVudF0gPSBsb2FkRXZlbnRIYW5kbGVyKGFwcE1vZHVsZSwgbmFtZSwgY29udHJvbGxlcnNQYXRoLCBoYW5kbGVyKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBhcHBNb2R1bGUubG9nKCdpbmZvJywgYFske3NlcnZlclRhZ31dRXZlbnQgaGFuZGxlcnMgYXR0YWNoZWQgZm9yIGNoYW5uZWwgXCIke25hbWV9XCIuYCwge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzOiBPYmplY3Qua2V5cyhldmVudEhhbmRsZXJzKVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoXy5pc0VtcHR5KGV2ZW50SGFuZGxlcnMpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICAgICAgICAgICdNaXNzaW5nIHNvY2tldCByZXNwb25zZSBjb250cm9sbGVyIG9yIGV2ZW50IGhvb2tzLicsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcHBNb2R1bGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBgc29ja2V0U2VydmVyLmNoYW5uZWxzLiR7bmFtZX1gXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaW9DaGFubmVsLm9uKCdjb25uZWN0JywgZnVuY3Rpb24gKHNvY2tldCkge1xuICAgICAgICAgICAgICAgICAgICBhcHBNb2R1bGUubG9nKCdpbmZvJywgYFske3NlcnZlclRhZ31dQ2xpZW50IFtpZD0ke3NvY2tldC5pZH1dIGNvbm5lY3RlZCB0byBjaGFubmVsIFwiJHtuYW1lfVwiLmApO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vUmVnaXN0ZXIgZXZlbnQgaGFuZGxlcnNcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgZXZlbnQgaW4gZXZlbnRIYW5kbGVycykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGhhbmRsZXIgPSBldmVudEhhbmRsZXJzW2V2ZW50XTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0Lm9uKGV2ZW50LCAoZGF0YSwgY2IpID0+IGhhbmRsZXIoeyBhcHBNb2R1bGUsIHNvY2tldCB9LCBkYXRhKS50aGVuKGNiKSk7XG4gICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZm8ud2VsY29tZU1lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldC5lbWl0KCd3ZWxjb21lJywgaW5mby53ZWxjb21lTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBzb2NrZXQub24oJ2Rpc2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHBNb2R1bGUubG9nKCdpbmZvJywgYFske3NlcnZlclRhZ31dQ2xpZW50IFtpZD0ke3NvY2tldC5pZH1dIGRpc2Nvbm5lY3RlZCBmcm9tIGNoYW5uZWwgXCIke25hbWV9XCIuYCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChzdGFuZGFsb25lKSB7XG4gICAgICAgICAgICAgICAgaW8ubGlzdGVuKGNvbmZpZy5wb3J0KTtcbiAgICAgICAgICAgICAgICBhcHBNb2R1bGUubG9nKCdpbmZvJywgYFske3NlcnZlclRhZ31dQSBzdGFuZGFsb25lIHNvY2tldCBzZXJ2ZXIgaXMgbGlzdGVuaW5nIG9uIHBvcnQgWyR7Y29uZmlnLnBvcnR9XSAuLi5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYXBwTW9kdWxlLnJlZ2lzdGVyU2VydmljZShzZXJ2aWNlVGFnLCBpbyk7XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxufTsiXX0=