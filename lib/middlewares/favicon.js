"use strict";

require("source-map-support/register");

const {
  _
} = require('@genx/july');

const {
  fs
} = require('@genx/sys');

const path = require('path');

const {
  HttpCode,
  InvalidConfiguration
} = require('@genx/error');

let favicon = (options, app) => {
  if (_.isString(options)) {
    options = {
      path: options
    };
  }

  let faviconPath = options && options.path && app.toAbsolutePath(options.path) || path.join(app.publicPath, 'favicon.ico');

  if (!fs.existsSync(faviconPath)) {
    throw new InvalidConfiguration(`Favicon path "${faviconPath}" not exists.`, app, 'middlewares.favicon');
  }

  let icon;
  const maxAge = options.maxAge == null ? 86400000 : Math.min(Math.max(0, options.maxAge), 31556926000);
  const cacheControl = `public, max-age=${maxAge / 1000 | 0}`;
  return async (ctx, next) => {
    if ('/favicon.ico' !== ctx.path || 'GET' !== ctx.method && 'HEAD' !== ctx.method) {
      return next();
    }

    if (!icon) {
      let stats = await fs.stat(faviconPath);

      if (stats.size > 1048576) {
        app.log('warn', 'favicon.ico too large.', stats);
        ctx.throw(HttpCode.NOT_FOUND);
      }

      icon = await fs.readFile(faviconPath);
    }

    ctx.set('Cache-Control', cacheControl);
    ctx.type = 'image/x-icon';
    ctx.body = icon;
  };
};

module.exports = favicon;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlcy9mYXZpY29uLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiZnMiLCJwYXRoIiwiSHR0cENvZGUiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsImZhdmljb24iLCJvcHRpb25zIiwiYXBwIiwiaXNTdHJpbmciLCJmYXZpY29uUGF0aCIsInRvQWJzb2x1dGVQYXRoIiwiam9pbiIsInB1YmxpY1BhdGgiLCJleGlzdHNTeW5jIiwiaWNvbiIsIm1heEFnZSIsIk1hdGgiLCJtaW4iLCJtYXgiLCJjYWNoZUNvbnRyb2wiLCJjdHgiLCJuZXh0IiwibWV0aG9kIiwic3RhdHMiLCJzdGF0Iiwic2l6ZSIsImxvZyIsInRocm93IiwiTk9UX0ZPVU5EIiwicmVhZEZpbGUiLCJzZXQiLCJ0eXBlIiwiYm9keSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBT0EsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQVFDLE9BQU8sQ0FBQyxZQUFELENBQXJCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFTRCxPQUFPLENBQUMsV0FBRCxDQUF0Qjs7QUFDQSxNQUFNRSxJQUFJLEdBQUdGLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUcsRUFBQUEsUUFBRjtBQUFZQyxFQUFBQTtBQUFaLElBQXFDSixPQUFPLENBQUMsYUFBRCxDQUFsRDs7QUFFQSxJQUFJSyxPQUFPLEdBQUcsQ0FBQ0MsT0FBRCxFQUFVQyxHQUFWLEtBQWtCO0FBQzVCLE1BQUlSLENBQUMsQ0FBQ1MsUUFBRixDQUFXRixPQUFYLENBQUosRUFBeUI7QUFDckJBLElBQUFBLE9BQU8sR0FBRztBQUFFSixNQUFBQSxJQUFJLEVBQUVJO0FBQVIsS0FBVjtBQUNIOztBQUVELE1BQUlHLFdBQVcsR0FBR0gsT0FBTyxJQUFJQSxPQUFPLENBQUNKLElBQW5CLElBQTJCSyxHQUFHLENBQUNHLGNBQUosQ0FBbUJKLE9BQU8sQ0FBQ0osSUFBM0IsQ0FBM0IsSUFBK0RBLElBQUksQ0FBQ1MsSUFBTCxDQUFVSixHQUFHLENBQUNLLFVBQWQsRUFBMEIsYUFBMUIsQ0FBakY7O0FBQ0EsTUFBSSxDQUFDWCxFQUFFLENBQUNZLFVBQUgsQ0FBY0osV0FBZCxDQUFMLEVBQWlDO0FBQzdCLFVBQU0sSUFBSUwsb0JBQUosQ0FDRCxpQkFBZ0JLLFdBQVksZUFEM0IsRUFFRkYsR0FGRSxFQUdGLHFCQUhFLENBQU47QUFLSDs7QUFFRCxNQUFJTyxJQUFKO0FBQ0EsUUFBTUMsTUFBTSxHQUFHVCxPQUFPLENBQUNTLE1BQVIsSUFBa0IsSUFBbEIsR0FDVCxRQURTLEdBRVRDLElBQUksQ0FBQ0MsR0FBTCxDQUFTRCxJQUFJLENBQUNFLEdBQUwsQ0FBUyxDQUFULEVBQVlaLE9BQU8sQ0FBQ1MsTUFBcEIsQ0FBVCxFQUFzQyxXQUF0QyxDQUZOO0FBR0EsUUFBTUksWUFBWSxHQUFJLG1CQUFrQkosTUFBTSxHQUFHLElBQVQsR0FBZ0IsQ0FBRSxFQUExRDtBQUVBLFNBQU8sT0FBT0ssR0FBUCxFQUFZQyxJQUFaLEtBQXFCO0FBQ3hCLFFBQUksbUJBQW1CRCxHQUFHLENBQUNsQixJQUF2QixJQUFnQyxVQUFVa0IsR0FBRyxDQUFDRSxNQUFkLElBQXdCLFdBQVdGLEdBQUcsQ0FBQ0UsTUFBM0UsRUFBb0Y7QUFDaEYsYUFBT0QsSUFBSSxFQUFYO0FBQ0g7O0FBRUQsUUFBSSxDQUFDUCxJQUFMLEVBQVc7QUFDUCxVQUFJUyxLQUFLLEdBQUcsTUFBTXRCLEVBQUUsQ0FBQ3VCLElBQUgsQ0FBUWYsV0FBUixDQUFsQjs7QUFFQSxVQUFJYyxLQUFLLENBQUNFLElBQU4sR0FBYSxPQUFqQixFQUEwQjtBQUN0QmxCLFFBQUFBLEdBQUcsQ0FBQ21CLEdBQUosQ0FBUSxNQUFSLEVBQWdCLHdCQUFoQixFQUEwQ0gsS0FBMUM7QUFDQUgsUUFBQUEsR0FBRyxDQUFDTyxLQUFKLENBQVV4QixRQUFRLENBQUN5QixTQUFuQjtBQUNIOztBQUVEZCxNQUFBQSxJQUFJLEdBQUcsTUFBTWIsRUFBRSxDQUFDNEIsUUFBSCxDQUFZcEIsV0FBWixDQUFiO0FBQ0g7O0FBQ0RXLElBQUFBLEdBQUcsQ0FBQ1UsR0FBSixDQUFRLGVBQVIsRUFBeUJYLFlBQXpCO0FBQ0FDLElBQUFBLEdBQUcsQ0FBQ1csSUFBSixHQUFXLGNBQVg7QUFDQVgsSUFBQUEsR0FBRyxDQUFDWSxJQUFKLEdBQVdsQixJQUFYO0FBQ0gsR0FsQkQ7QUFtQkgsQ0F2Q0Q7O0FBeUNBbUIsTUFBTSxDQUFDQyxPQUFQLEdBQWlCN0IsT0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuLyoqXG4gKiBNaWRkbGV3YXJlIHRvIHNlcnZlIGZhdmljb24gcmVxdWVzdC5cbiAqIEBtb2R1bGUgTWlkZGxld2FyZV9GYXZpY29uXG4gKi9cblxuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdAZ2VueC9qdWx5Jyk7XG5jb25zdCB7IGZzIH0gPSByZXF1aXJlKCdAZ2VueC9zeXMnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IEh0dHBDb2RlLCBJbnZhbGlkQ29uZmlndXJhdGlvbiB9ID0gcmVxdWlyZSgnQGdlbngvZXJyb3InKTtcblxubGV0IGZhdmljb24gPSAob3B0aW9ucywgYXBwKSA9PiB7XG4gICAgaWYgKF8uaXNTdHJpbmcob3B0aW9ucykpIHtcbiAgICAgICAgb3B0aW9ucyA9IHsgcGF0aDogb3B0aW9ucyB9O1xuICAgIH0gXG4gICAgXG4gICAgbGV0IGZhdmljb25QYXRoID0gb3B0aW9ucyAmJiBvcHRpb25zLnBhdGggJiYgYXBwLnRvQWJzb2x1dGVQYXRoKG9wdGlvbnMucGF0aCkgfHwgcGF0aC5qb2luKGFwcC5wdWJsaWNQYXRoLCAnZmF2aWNvbi5pY28nKTtcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZmF2aWNvblBhdGgpKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgIGBGYXZpY29uIHBhdGggXCIke2Zhdmljb25QYXRofVwiIG5vdCBleGlzdHMuYCxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgICdtaWRkbGV3YXJlcy5mYXZpY29uJ1xuICAgICAgICApO1xuICAgIH0gICBcblxuICAgIGxldCBpY29uO1xuICAgIGNvbnN0IG1heEFnZSA9IG9wdGlvbnMubWF4QWdlID09IG51bGxcbiAgICAgICAgPyA4NjQwMDAwMFxuICAgICAgICA6IE1hdGgubWluKE1hdGgubWF4KDAsIG9wdGlvbnMubWF4QWdlKSwgMzE1NTY5MjYwMDApO1xuICAgIGNvbnN0IGNhY2hlQ29udHJvbCA9IGBwdWJsaWMsIG1heC1hZ2U9JHttYXhBZ2UgLyAxMDAwIHwgMH1gO1xuXG4gICAgcmV0dXJuIGFzeW5jIChjdHgsIG5leHQpID0+IHtcbiAgICAgICAgaWYgKCcvZmF2aWNvbi5pY28nICE9PSBjdHgucGF0aCB8fCAoJ0dFVCcgIT09IGN0eC5tZXRob2QgJiYgJ0hFQUQnICE9PSBjdHgubWV0aG9kKSkge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghaWNvbikge1xuICAgICAgICAgICAgbGV0IHN0YXRzID0gYXdhaXQgZnMuc3RhdChmYXZpY29uUGF0aCk7XG4gICAgICAgICAgICAvL21heGltdW0gMU1cbiAgICAgICAgICAgIGlmIChzdGF0cy5zaXplID4gMTA0ODU3Nikge1xuICAgICAgICAgICAgICAgIGFwcC5sb2coJ3dhcm4nLCAnZmF2aWNvbi5pY28gdG9vIGxhcmdlLicsIHN0YXRzKTtcbiAgICAgICAgICAgICAgICBjdHgudGhyb3coSHR0cENvZGUuTk9UX0ZPVU5EKTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGljb24gPSBhd2FpdCBmcy5yZWFkRmlsZShmYXZpY29uUGF0aCk7XG4gICAgICAgIH1cbiAgICAgICAgY3R4LnNldCgnQ2FjaGUtQ29udHJvbCcsIGNhY2hlQ29udHJvbCk7XG4gICAgICAgIGN0eC50eXBlID0gJ2ltYWdlL3gtaWNvbic7XG4gICAgICAgIGN0eC5ib2R5ID0gaWNvbjtcbiAgICB9O1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBmYXZpY29uOyJdfQ==