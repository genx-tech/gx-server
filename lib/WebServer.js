"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  eachAsync_
} = require('rk-utils');

const {
  Runable,
  ServiceContainer
} = require('@genx/app');

const Routable = require('./Routable');

const Literal = require('./enum/Literal');

const {
  defaultBackendPath
} = require('./utils/Helpers');

class WebServer extends Routable(Runable(ServiceContainer)) {
  constructor(name, options) {
    if (typeof options === 'undefined' && _.isPlainObject(name)) {
      options = name;
      name = undefined;
    }

    super(name || 'server', Object.assign({
      configName: Literal.SERVER_CFG_NAME
    }, options));
    this.server = this;
    this.isServer = true;
    this.backendPath = this.toAbsolutePath(this.options.backendPath || defaultBackendPath);
    this.appModulesPath = this.toAbsolutePath(this.options.appModulesPath || Literal.APP_MODULES_PATH);
    this.route = "/";
    this.on('configLoaded', () => {
      this.loadMiddlewaresFrom(path.resolve(__dirname, Literal.MIDDLEWARES_PATH));
    });
  }

  async stop_() {
    if (this.started) {
      if (this.appModules) {
        await eachAsync_(this.appModules, app => app.stop_());
        delete this.appModules;
        delete this.appModulesByAlias;
      }

      if (this.libModules) {
        await eachAsync_(this.libModules, lib => lib.stop_());
        delete this.libModules;
      }
    }

    if (this.httpServer) {
      await new Promise((resolve, reject) => {
        this.httpServer.close(err => {
          if (err) return reject(err);
          resolve();
        });
      });
      delete this.httpServer;
      this.log('info', `The http service is stopped.`);
    }

    return super.stop_();
  }

  mountApp(app) {
    if (!this.appModules) {
      this.appModules = {};
      this.appModulesByAlias = {};
    }

    if (!!this.appModules.hasOwnProperty(app.route)) {
      throw new Error("Assertion failed: !this.appModules.hasOwnProperty(app.route)");
    }

    this.mountRouter(app.route, app.router);
    this.appModules[app.route] = app;

    if (app.name in this.appModulesByAlias) {
      let existingApp = this.appModulesByAlias[app.name];
      this.appModulesByAlias[`${existingApp.name}[@${existingApp.route}]`] = existingApp;
      delete this.appModulesByAlias[app.name];
      this.appModulesByAlias[`${app.name}[@${app.route}]`] = app;
    } else {
      this.appModulesByAlias[app.name] = app;
    }

    this.log('verbose', `All routes from app [${app.name}] are mounted under "${app.route}".`);
  }

  getAppByRoute(p) {
    return this.appModules[p];
  }

  getAppByAlias(a) {
    return this.appModulesByAlias[a];
  }

  requireFromApp(appName, relativePath) {
    const app = this.getAppByAlias(appName);
    return app.require(relativePath);
  }

  getService(name) {
    let pos = name.indexOf(':');

    if (pos === -1) {
      return super.getService(name);
    }

    let modAlias = name.substr(0, pos);
    name = name.substr(pos + 1);
    let app = this.getAppByAlias(modAlias);
    return app && app.getService(name, true);
  }

  _getFeatureFallbackPath() {
    let pathArray = super._getFeatureFallbackPath();

    pathArray.splice(1, 0, path.resolve(__dirname, Literal.FEATURES_PATH), path.resolve(__dirname, Literal.APP_FEATURES_PATH), path.resolve(__dirname, Literal.SERVER_FEATURES_PATH));
    return pathArray;
  }

}

module.exports = WebServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9XZWJTZXJ2ZXIuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwiZWFjaEFzeW5jXyIsIlJ1bmFibGUiLCJTZXJ2aWNlQ29udGFpbmVyIiwiUm91dGFibGUiLCJMaXRlcmFsIiwiZGVmYXVsdEJhY2tlbmRQYXRoIiwiV2ViU2VydmVyIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImlzUGxhaW5PYmplY3QiLCJ1bmRlZmluZWQiLCJPYmplY3QiLCJhc3NpZ24iLCJjb25maWdOYW1lIiwiU0VSVkVSX0NGR19OQU1FIiwic2VydmVyIiwiaXNTZXJ2ZXIiLCJiYWNrZW5kUGF0aCIsInRvQWJzb2x1dGVQYXRoIiwiYXBwTW9kdWxlc1BhdGgiLCJBUFBfTU9EVUxFU19QQVRIIiwicm91dGUiLCJvbiIsImxvYWRNaWRkbGV3YXJlc0Zyb20iLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiTUlERExFV0FSRVNfUEFUSCIsInN0b3BfIiwic3RhcnRlZCIsImFwcE1vZHVsZXMiLCJhcHAiLCJhcHBNb2R1bGVzQnlBbGlhcyIsImxpYk1vZHVsZXMiLCJsaWIiLCJodHRwU2VydmVyIiwiUHJvbWlzZSIsInJlamVjdCIsImNsb3NlIiwiZXJyIiwibG9nIiwibW91bnRBcHAiLCJoYXNPd25Qcm9wZXJ0eSIsIm1vdW50Um91dGVyIiwicm91dGVyIiwiZXhpc3RpbmdBcHAiLCJnZXRBcHBCeVJvdXRlIiwicCIsImdldEFwcEJ5QWxpYXMiLCJhIiwicmVxdWlyZUZyb21BcHAiLCJhcHBOYW1lIiwicmVsYXRpdmVQYXRoIiwiZ2V0U2VydmljZSIsInBvcyIsImluZGV4T2YiLCJtb2RBbGlhcyIsInN1YnN0ciIsIl9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoIiwicGF0aEFycmF5Iiwic3BsaWNlIiwiRkVBVFVSRVNfUEFUSCIsIkFQUF9GRUFUVVJFU19QQVRIIiwiU0VSVkVSX0ZFQVRVUkVTX1BBVEgiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBp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QWIsRUFBd0J0QixPQUFPLENBQUMwRCxpQkFBaEMsQ0FBdkUsRUFBMkhqRSxJQUFJLENBQUM0QixPQUFMLENBQWFDLFNBQWIsRUFBd0J0QixPQUFPLENBQUMyRCxvQkFBaEMsQ0FBM0g7QUFDQSxXQUFPSixTQUFQO0FBQ0g7O0FBckt1RDs7QUF3SzVESyxNQUFNLENBQUNDLE9BQVAsR0FBaUIzRCxTQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCBlYWNoQXN5bmNfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBSdW5hYmxlLCBTZXJ2aWNlQ29udGFpbmVyIH0gPSByZXF1aXJlKCdAZ2VueC9hcHAnKTtcbmNvbnN0IFJvdXRhYmxlID0gcmVxdWlyZSgnLi9Sb3V0YWJsZScpO1xuY29uc3QgTGl0ZXJhbCA9IHJlcXVpcmUoJy4vZW51bS9MaXRlcmFsJyk7XG5jb25zdCB7IGRlZmF1bHRCYWNrZW5kUGF0aCB9ID0gcmVxdWlyZSgnLi91dGlscy9IZWxwZXJzJyk7XG5cbi8qKlxuICogV2ViIHNlcnZlciBjbGFzcy5cbiAqIEBjbGFzc1xuICogQGV4dGVuZHMgUm91dGFibGUoQXBwKVxuICovXG5jbGFzcyBXZWJTZXJ2ZXIgZXh0ZW5kcyBSb3V0YWJsZShSdW5hYmxlKFNlcnZpY2VDb250YWluZXIpKSB7XG4gICAgLyoqICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbbmFtZT0nc2VydmVyJ10gLSBUaGUgbmFtZSBvZiB0aGUgc2VydmVyLiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIFRoZSBhcHAgbW9kdWxlJ3MgZXh0cmEgb3B0aW9ucyBkZWZpbmVkIGluIGl0cyBwYXJlbnQncyBjb25maWd1cmF0aW9uLlxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbb3B0aW9ucy5sb2dnZXJdIC0gTG9nZ2VyIG9wdGlvbnNcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLnZlcmJvc2U9ZmFsc2VdIC0gRmxhZyB0byBvdXRwdXQgdHJpdmlhbCBpbmZvcm1hdGlvbiBmb3IgZGlhZ25vc3RpY3NcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuZW52XSAtIEVudmlyb25tZW50LCBkZWZhdWx0IHRvIHByb2Nlc3MuZW52Lk5PREVfRU5WXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLndvcmtpbmdQYXRoXSAtIEFwcCdzIHdvcmtpbmcgcGF0aCwgZGVmYXVsdCB0byBwcm9jZXNzLmN3ZCgpXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmNvbmZpZ1BhdGhdIC0gQXBwJ3MgY29uZmlnIHBhdGgsIGRlZmF1bHQgdG8gXCJjb25mXCIgdW5kZXIgd29ya2luZ1BhdGggICBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuY29uZmlnTmFtZV0gLSBBcHAncyBjb25maWcgYmFzZW5hbWUsIGRlZmF1bHQgdG8gXCJhcHBcIlxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5iYWNrZW5kUGF0aD0nc2VydmVyJ10gLSBSZWxhdGl2ZSBwYXRoIG9mIGJhY2stZW5kIHNlcnZlciBzb3VyY2UgZmlsZXNcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuY2xpZW50UGF0aD0nY2xpZW50J10gLSBSZWxhdGl2ZSBwYXRoIG9mIGZyb250LWVuZCBjbGllbnQgc291cmNlIGZpbGVzICAgICBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucHVibGljUGF0aD0ncHVibGljJ10gLSBSZWxhdGl2ZSBwYXRoIG9mIGZyb250LWVuZCBzdGF0aWMgZmlsZXMgICAgXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmFwcE1vZHVsZXNQYXRoPWFwcF9tb2R1bGVzXSAtIFJlbGF0aXZlIHBhdGggb2YgY2hpbGQgbW9kdWxlcyAgICAgICAgICAgICAgICAgICAgXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobmFtZSwgb3B0aW9ucykge1xuICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICd1bmRlZmluZWQnICYmIF8uaXNQbGFpbk9iamVjdChuYW1lKSkge1xuICAgICAgICAgICAgb3B0aW9ucyA9IG5hbWU7XG4gICAgICAgICAgICBuYW1lID0gdW5kZWZpbmVkO1xuICAgICAgICB9ICAgICAgICBcblxuICAgICAgICBzdXBlcihuYW1lIHx8ICdzZXJ2ZXInLCBPYmplY3QuYXNzaWduKHsgY29uZmlnTmFtZTogTGl0ZXJhbC5TRVJWRVJfQ0ZHX05BTUUgfSwgb3B0aW9ucykpOyAgICBcblxuICAgICAgICAvKipcbiAgICAgICAgICogSG9zdGluZyBzZXJ2ZXIuXG4gICAgICAgICAqIEBtZW1iZXIge1dlYlNlcnZlcn1cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLnNlcnZlciA9IHRoaXM7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFdoZXRoZXIgaXQgaXMgYSBzZXJ2ZXIuXG4gICAgICAgICAqIEBtZW1iZXIge2Jvb2xlYW59XG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5pc1NlcnZlciA9IHRydWU7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEJhY2tlbmQgZmlsZXMgcGF0aC5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSAgICAgICAgIFxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMuYmFja2VuZFBhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5iYWNrZW5kUGF0aCB8fCBkZWZhdWx0QmFja2VuZFBhdGgpOyBcblxuICAgICAgICAvKipcbiAgICAgICAgICogQXBwIG1vZHVsZXMgcGF0aC5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5hcHBNb2R1bGVzUGF0aCA9IHRoaXMudG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLmFwcE1vZHVsZXNQYXRoIHx8IExpdGVyYWwuQVBQX01PRFVMRVNfUEFUSCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEJhc2Ugcm91dGUuXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMucm91dGUgPSBcIi9cIjtcbiAgICAgICAgXG4gICAgICAgIHRoaXMub24oJ2NvbmZpZ0xvYWRlZCcsICgpID0+IHtcbiAgICAgICAgICAgIC8vIGxvYWQgYnVpbHRpbiBtaWRkbGV3YXJlc1xuICAgICAgICAgICAgdGhpcy5sb2FkTWlkZGxld2FyZXNGcm9tKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIExpdGVyYWwuTUlERExFV0FSRVNfUEFUSCkpO1xuICAgICAgICB9KTsgICAgICAgIFxuICAgIH1cblxuICAgIGFzeW5jIHN0b3BfKCkge1xuICAgICAgICBpZiAodGhpcy5zdGFydGVkKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5hcHBNb2R1bGVzKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgZWFjaEFzeW5jXyh0aGlzLmFwcE1vZHVsZXMsIGFwcCA9PiBhcHAuc3RvcF8oKSk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuYXBwTW9kdWxlcztcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5hcHBNb2R1bGVzQnlBbGlhcztcbiAgICAgICAgICAgIH0gICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICh0aGlzLmxpYk1vZHVsZXMpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBlYWNoQXN5bmNfKHRoaXMubGliTW9kdWxlcywgbGliID0+IGxpYi5zdG9wXygpKTtcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5saWJNb2R1bGVzO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuaHR0cFNlcnZlcikge1xuICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuaHR0cFNlcnZlci5jbG9zZSgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3QoZXJyKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBkZWxldGUgdGhpcy5odHRwU2VydmVyO1xuICAgICAgICAgICAgdGhpcy5sb2coJ2luZm8nLCBgVGhlIGh0dHAgc2VydmljZSBpcyBzdG9wcGVkLmApOyBcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzdXBlci5zdG9wXygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE1vdW50IGFuIGFwcCBhdCBzcGVjaWZpZWQgcm91dGUuXG4gICAgICogQHBhcmFtIHtXZWJNb2R1bGV9IGFwcCBcbiAgICAgKi9cbiAgICBtb3VudEFwcChhcHApIHtcbiAgICAgICAgaWYgKCF0aGlzLmFwcE1vZHVsZXMpIHtcbiAgICAgICAgICAgIHRoaXMuYXBwTW9kdWxlcyA9IHt9O1xuICAgICAgICAgICAgdGhpcy5hcHBNb2R1bGVzQnlBbGlhcyA9IHt9O1xuICAgICAgICB9XG5cbiAgICAgICAgYXNzZXJ0OiAhdGhpcy5hcHBNb2R1bGVzLmhhc093blByb3BlcnR5KGFwcC5yb3V0ZSk7XG5cbiAgICAgICAgdGhpcy5tb3VudFJvdXRlcihhcHAucm91dGUsIGFwcC5yb3V0ZXIpO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5hcHBNb2R1bGVzW2FwcC5yb3V0ZV0gPSBhcHA7XG5cbiAgICAgICAgaWYgKGFwcC5uYW1lIGluIHRoaXMuYXBwTW9kdWxlc0J5QWxpYXMpIHtcbiAgICAgICAgICAgIGxldCBleGlzdGluZ0FwcCA9IHRoaXMuYXBwTW9kdWxlc0J5QWxpYXNbYXBwLm5hbWVdO1xuICAgICAgICAgICAgLy9tb3ZlIGJ1Y2tldFxuICAgICAgICAgICAgdGhpcy5hcHBNb2R1bGVzQnlBbGlhc1tgJHtleGlzdGluZ0FwcC5uYW1lfVtAJHtleGlzdGluZ0FwcC5yb3V0ZX1dYF0gPSBleGlzdGluZ0FwcDtcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmFwcE1vZHVsZXNCeUFsaWFzW2FwcC5uYW1lXTtcblxuICAgICAgICAgICAgdGhpcy5hcHBNb2R1bGVzQnlBbGlhc1tgJHthcHAubmFtZX1bQCR7YXBwLnJvdXRlfV1gXSA9IGFwcDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYXBwTW9kdWxlc0J5QWxpYXNbYXBwLm5hbWVdID0gYXBwO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgQWxsIHJvdXRlcyBmcm9tIGFwcCBbJHthcHAubmFtZX1dIGFyZSBtb3VudGVkIHVuZGVyIFwiJHthcHAucm91dGV9XCIuYCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSBhcHAgbW9kdWxlIG9iamVjdCBieSBiYXNlIHJvdXRlXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHAgLSBBcHAgbW9kdWxlIGJhc2Ugcm91dGUgc3RhcnRlZCB3aXRoIFwiL1wiXG4gICAgICovXG4gICAgZ2V0QXBwQnlSb3V0ZShwKSB7XG4gICAgICAgIC8vdG9kbzogY2hhbmdlIHRvIHAtdHJlZVxuICAgICAgICByZXR1cm4gdGhpcy5hcHBNb2R1bGVzW3BdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgYXBwIG1vZHVsZSBvYmplY3QgYnkgYXBwIGFsaWFzLCB1c3VhbGx5IHRoZSBhcHAgbmFtZSBpZiBubyBkdXBsaWNhdGUgZW50cnlcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gYSAtIEFwcCBtb2R1bGUgYWxpYXNcbiAgICAgKi9cbiAgICBnZXRBcHBCeUFsaWFzKGEpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwTW9kdWxlc0J5QWxpYXNbYV07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVxdWlyZSBhIG1vZHVsZSBmcm9tIHRoZSBzb3VyY2UgcGF0aCBvZiBhbiBhcHAgbW9kdWxlXG4gICAgICogQHBhcmFtIHsqfSByZWxhdGl2ZVBhdGggXG4gICAgICovXG4gICAgcmVxdWlyZUZyb21BcHAoYXBwTmFtZSwgcmVsYXRpdmVQYXRoKSB7XG4gICAgICAgIGNvbnN0IGFwcCA9IHRoaXMuZ2V0QXBwQnlBbGlhcyhhcHBOYW1lKTtcbiAgICAgICAgcmV0dXJuIGFwcC5yZXF1aXJlKHJlbGF0aXZlUGF0aCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGEgcmVnaXN0ZXJlZCBzZXJ2aWNlXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgXG4gICAgICovXG4gICAgZ2V0U2VydmljZShuYW1lKSB7XG4gICAgICAgIGxldCBwb3MgPSBuYW1lLmluZGV4T2YoJzonKTtcbiAgICAgICAgaWYgKHBvcyA9PT0gLTEpIHtcbiAgICAgICAgICAgIHJldHVybiBzdXBlci5nZXRTZXJ2aWNlKG5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG1vZEFsaWFzID0gbmFtZS5zdWJzdHIoMCwgcG9zKTtcbiAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyKHBvcysxKTtcblxuICAgICAgICBsZXQgYXBwID0gdGhpcy5nZXRBcHBCeUFsaWFzKG1vZEFsaWFzKTtcbiAgICAgICAgcmV0dXJuIGFwcCAmJiBhcHAuZ2V0U2VydmljZShuYW1lLCB0cnVlKTtcbiAgICB9XG5cbiAgICBfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCgpIHtcbiAgICAgICAgbGV0IHBhdGhBcnJheSA9IHN1cGVyLl9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoKCk7XG4gICAgICAgIHBhdGhBcnJheS5zcGxpY2UoMSwgMCwgcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgTGl0ZXJhbC5GRUFUVVJFU19QQVRIKSwgcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgTGl0ZXJhbC5BUFBfRkVBVFVSRVNfUEFUSCksIHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIExpdGVyYWwuU0VSVkVSX0ZFQVRVUkVTX1BBVEgpKTtcbiAgICAgICAgcmV0dXJuIHBhdGhBcnJheTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gV2ViU2VydmVyOyJdfQ==