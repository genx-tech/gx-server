"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  eachAsync_,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('@koa/router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  NotFound
} = require('../utils/Errors');

function mergeQuery(query, extra) {
  return query && query.$query ? {
    $query: { ...query.$query,
      ...extra
    }
  } : { ...query,
    ...extra
  };
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.rpc.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.rpc.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(), 'jsonError');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];

    _.forOwn(entityModels, (methods, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      _.forOwn(methods, (methodInfo, methodName) => {
        let params = methodInfo.params ? Object.values(methodInfo.params).reduce((result, v) => {
          result[v.name] = _.omit(v, ['name']);
          return result;
        }, {}) : {};
        list.push({
          method: methodInfo.httpMethod,
          url: urlJoin(baseRoute, entityNameInUrl, methodName),
          desc: methodInfo.desc,
          params
        });
      });
    });

    ctx.body = list;
  });
  ['get', 'post'].forEach(method => {
    app.addRoute(router, method, '/:entity/:method', async ctx => {
      let db = ctx.appModule.db(options.schemaName);

      let entityName = _.camelCase(ctx.params.entity);

      let methodName = _.camelCase(ctx.params.method);

      let apiInfo = entityModels[entityName];
      apiInfo = apiInfo && apiInfo[methodName];

      if (!apiInfo || apiInfo.httpMethod.toUpperCase() !== ctx.method) {
        throw new BadRequest('API endpoint not found.');
      }

      let args = [ctx];

      if (apiInfo.params) {
        apiInfo.params.forEach(param => {
          let argName = param.name;
          let value = ctx.query[argName] || ctx.request.body[argName];

          if (_.isNil(value) && !param.optional) {
            throw new BadRequest(`Required argument "${argName}" is not given.`);
          }

          args.push(value);
        });
      }

      let EntityModel = db.model(entityName);
      let asyncMethodName = methodName + '_';

      if (typeof EntityModel[asyncMethodName] !== 'function') {
        throw new NotFound(`RPC endpoint "${ctx.path}" not found.`);
      }

      if (options.invokeTracking) {
        app.log('verbose', `Invoking a process API [${entityName}.${methodName}] ...`);
      }

      ctx.body = await EntityModel[asyncMethodName](...args);
    });
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL3JwYy5qcyJdLCJuYW1lcyI6WyJfIiwiZnMiLCJlYWNoQXN5bmNfIiwidXJsSm9pbiIsImdldFZhbHVlQnlQYXRoIiwicmVxdWlyZSIsIlJvdXRlciIsIkh0dHBDb2RlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJCYWRSZXF1ZXN0IiwiTm90Rm91bmQiLCJtZXJnZVF1ZXJ5IiwicXVlcnkiLCJleHRyYSIsIiRxdWVyeSIsIm1vZHVsZSIsImV4cG9ydHMiLCJhcHAiLCJiYXNlUm91dGUiLCJvcHRpb25zIiwic2NoZW1hTmFtZSIsImVudGl0eU1vZGVscyIsInJvdXRlciIsInByZWZpeCIsInVzZU1pZGRsZXdhcmUiLCJnZXRNaWRkbGV3YXJlRmFjdG9yeSIsIm1pZGRsZXdhcmVzIiwidXNlTWlkZGxld2FyZXMiLCJhcGlMaXN0RW5kcG9pbnQiLCJyZWFkSnNvblN5bmMiLCJ0b0Fic29sdXRlUGF0aCIsImFkZFJvdXRlIiwiY3R4IiwibGlzdCIsImZvck93biIsIm1ldGhvZHMiLCJlbnRpdHlOYW1lIiwiZW50aXR5TmFtZUluVXJsIiwia2ViYWJDYXNlIiwibWV0aG9kSW5mbyIsIm1ldGhvZE5hbWUiLCJwYXJhbXMiLCJPYmplY3QiLCJ2YWx1ZXMiLCJyZWR1Y2UiLCJyZXN1bHQiLCJ2IiwibmFtZSIsIm9taXQiLCJwdXNoIiwibWV0aG9kIiwiaHR0cE1ldGhvZCIsInVybCIsImRlc2MiLCJib2R5IiwiZm9yRWFjaCIsImRiIiwiYXBwTW9kdWxlIiwiY2FtZWxDYXNlIiwiZW50aXR5IiwiYXBpSW5mbyIsInRvVXBwZXJDYXNlIiwiYXJncyIsInBhcmFtIiwiYXJnTmFtZSIsInZhbHVlIiwicmVxdWVzdCIsImlzTmlsIiwib3B0aW9uYWwiLCJFbnRpdHlNb2RlbCIsIm1vZGVsIiwiYXN5bmNNZXRob2ROYW1lIiwicGF0aCIsImludm9rZVRyYWNraW5nIiwibG9nIiwiYWRkUm91dGVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztB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Q0FBYyxpQkFBZ0JzQixHQUFHLENBQUN3QyxJQUFLLGNBQXZDLENBQU47QUFDSDs7QUFFRCxVQUFJckQsT0FBTyxDQUFDc0QsY0FBWixFQUE0QjtBQUN4QnhELFFBQUFBLEdBQUcsQ0FBQ3lELEdBQUosQ0FBUSxTQUFSLEVBQW9CLDJCQUEwQnRDLFVBQVcsSUFBR0ksVUFBVyxPQUF2RTtBQUNIOztBQUVEUixNQUFBQSxHQUFHLENBQUNzQixJQUFKLEdBQVcsTUFBTWUsV0FBVyxDQUFDRSxlQUFELENBQVgsQ0FBNkIsR0FBR1QsSUFBaEMsQ0FBakI7QUFDSCxLQXRDRDtBQXVDSCxHQXhDRDtBQTBDQTdDLEVBQUFBLEdBQUcsQ0FBQzBELFNBQUosQ0FBY3JELE1BQWQ7QUFDSCxDQWhHRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8sIGZzLCBlYWNoQXN5bmNfLCB1cmxKb2luLCBnZXRWYWx1ZUJ5UGF0aCB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJ0Brb2Evcm91dGVyJyk7XG5jb25zdCBIdHRwQ29kZSA9IHJlcXVpcmUoJ2h0dHAtc3RhdHVzLWNvZGVzJyk7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uLCBCYWRSZXF1ZXN0LCBOb3RGb3VuZCB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvRXJyb3JzJyk7XG5cbi8qKlxuICogUkVTVGZ1bCByb3V0ZXIuXG4gKiBAbW9kdWxlIFJvdXRlcl9SZXN0XG4gKi9cblxuIGZ1bmN0aW9uIG1lcmdlUXVlcnkocXVlcnksIGV4dHJhKSB7XG4gICAgcmV0dXJuIChxdWVyeSAmJiBxdWVyeS4kcXVlcnkpID8geyAkcXVlcnk6IHsgLi4ucXVlcnkuJHF1ZXJ5LCAuLi5leHRyYSB9IH0gOiB7IC4uLnF1ZXJ5LCAuLi5leHRyYSB9O1xuIH1cblxuLyoqXG4gKiBDcmVhdGUgYSBSRVNUZnVsIHJvdXRlci5cbiAqIEBwYXJhbSB7Kn0gYXBwIFxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2VSb3V0ZSBcbiAqIEBwYXJhbSB7b2JqZWN0c30gb3B0aW9ucyBcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5yZXNvdXJjZXNQYXRoXVxuICogQHByb3BlcnR5IHtvYmplY3R8YXJyYXl9IFtvcHRpb25zLm1pZGRsZXdhcmVzXVxuICogQGV4YW1wbGVcbiAqICAnPGJhc2UgcGF0aD4nOiB7XG4gKiAgICAgIHJwYzogeyAgICAgICAgICBcbiAqICAgICAgICAgIG1pZGRsZXdhcmVzOiB7fSxcbiAqICAgICAgICAgIHNjaGVtYU5hbWU6ICcnLFxuICogICAgICAgICAgZW50aXR5TW9kZWxzOiB7fXw8Y29uZmlnIHBhdGg+LCAgXG4gKiAgICAgICAgICBhcGlMaXN0RW5kcG9pbnQ6ICcvX2xpc3QnXG4gKiAgICAgIH1cbiAqICB9XG4gKiAgXG4gKiAgcm91dGUgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAgbWV0aG9kICAgIGZ1bmN0aW9uIG9mIGN0cmxcbiAqICAvOm1vZGVsLzptZXRob2QgICAgICAgICAgICAgICAgcG9zdCAgICAgICAgICAgbW9kZWwubWV0aG9kIFxuICovXG5tb2R1bGUuZXhwb3J0cyA9IChhcHAsIGJhc2VSb3V0ZSwgb3B0aW9ucykgPT4ge1xuICAgIGlmICghb3B0aW9ucy5zY2hlbWFOYW1lKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIHNjaGVtYSBuYW1lIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgYHJvdXRpbmcuJHtiYXNlUm91dGV9LnJwYy5zY2hlbWFOYW1lYFxuICAgICAgICApO1xuICAgIH0gICAgXG5cbiAgICBpZiAoIW9wdGlvbnMuZW50aXR5TW9kZWxzKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIGVudGl0eSBtb2RlbHMgY29uZmlnLicsXG4gICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICBgcm91dGluZy4ke2Jhc2VSb3V0ZX0ucnBjLmVudGl0eU1vZGVsc2BcbiAgICAgICAgKTsgICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBsZXQgcm91dGVyID0gYmFzZVJvdXRlID09PSAnLycgPyBuZXcgUm91dGVyKCkgOiBuZXcgUm91dGVyKHtwcmVmaXg6IGJhc2VSb3V0ZX0pO1xuXG4gICAgYXBwLnVzZU1pZGRsZXdhcmUocm91dGVyLCBhcHAuZ2V0TWlkZGxld2FyZUZhY3RvcnkoJ2pzb25FcnJvcicpKCksICdqc29uRXJyb3InKTtcblxuICAgIGlmIChvcHRpb25zLm1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGFwcC51c2VNaWRkbGV3YXJlcyhyb3V0ZXIsIG9wdGlvbnMubWlkZGxld2FyZXMpO1xuICAgIH1cblxuICAgIGxldCBhcGlMaXN0RW5kcG9pbnQgPSBvcHRpb25zLmFwaUxpc3RFbmRwb2ludCB8fCAnL19saXN0JztcblxuICAgIGxldCBlbnRpdHlNb2RlbHMgPSBvcHRpb25zLmVudGl0eU1vZGVscztcblxuICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5lbnRpdHlNb2RlbHMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGVudGl0eU1vZGVscyA9IGZzLnJlYWRKc29uU3luYyhhcHAudG9BYnNvbHV0ZVBhdGgob3B0aW9ucy5lbnRpdHlNb2RlbHMpKTsgXG4gICAgfVxuXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIGFwaUxpc3RFbmRwb2ludCwgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgbGlzdCA9IFtdO1xuICAgICAgICBcbiAgICAgICAgXy5mb3JPd24oZW50aXR5TW9kZWxzLCAobWV0aG9kcywgZW50aXR5TmFtZSkgPT4ge1xuICAgICAgICAgICAgLy90b2RvOiBmaWx0ZXIgZW50aXR5IG9yIG1ldGhvZHMgYnkgY29uZmlnXG4gICAgICAgICAgICBsZXQgZW50aXR5TmFtZUluVXJsID0gXy5rZWJhYkNhc2UoZW50aXR5TmFtZSk7ICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgXy5mb3JPd24obWV0aG9kcywgKG1ldGhvZEluZm8sIG1ldGhvZE5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgcGFyYW1zID0gbWV0aG9kSW5mby5wYXJhbXMgPyBPYmplY3QudmFsdWVzKG1ldGhvZEluZm8ucGFyYW1zKS5yZWR1Y2UoKHJlc3VsdCwgdikgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRbdi5uYW1lXSA9IF8ub21pdCh2LCBbJ25hbWUnXSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICAgICAgfSwge30pIDoge307XG5cbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyBtZXRob2Q6IG1ldGhvZEluZm8uaHR0cE1ldGhvZCwgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCBtZXRob2ROYW1lKSwgZGVzYzogbWV0aG9kSW5mby5kZXNjLCBwYXJhbXMgfSk7XG4gICAgICAgICAgICB9KTsgICAgICAgIFxuICAgICAgICB9KTtcblxuICAgICAgICBjdHguYm9keSA9IGxpc3Q7XG4gICAgfSk7XG5cbiAgICBbJ2dldCcsICdwb3N0J10uZm9yRWFjaChtZXRob2QgPT4geyAgICAgICAgIFxuICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCBtZXRob2QsICcvOmVudGl0eS86bWV0aG9kJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgICAgIGxldCBtZXRob2ROYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5tZXRob2QpO1xuICAgICAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgICAgICBhcGlJbmZvID0gYXBpSW5mbyAmJiBhcGlJbmZvW21ldGhvZE5hbWVdO1xuICAgICAgICAgICAgaWYgKCFhcGlJbmZvIHx8IGFwaUluZm8uaHR0cE1ldGhvZC50b1VwcGVyQ2FzZSgpICE9PSBjdHgubWV0aG9kKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0FQSSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBhcmdzID0gWyBjdHggXTtcblxuICAgICAgICAgICAgaWYgKGFwaUluZm8ucGFyYW1zKSB7XG4gICAgICAgICAgICAgICAgYXBpSW5mby5wYXJhbXMuZm9yRWFjaChwYXJhbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBhcmdOYW1lID0gcGFyYW0ubmFtZTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gY3R4LnF1ZXJ5W2FyZ05hbWVdIHx8IGN0eC5yZXF1ZXN0LmJvZHlbYXJnTmFtZV07XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKF8uaXNOaWwodmFsdWUpICYmICFwYXJhbS5vcHRpb25hbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoYFJlcXVpcmVkIGFyZ3VtZW50IFwiJHthcmdOYW1lfVwiIGlzIG5vdCBnaXZlbi5gKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaCh2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpOyBcbiAgICAgICAgICAgIGxldCBhc3luY01ldGhvZE5hbWUgPSBtZXRob2ROYW1lICsgJ18nO1xuXG4gICAgICAgICAgICBpZiAodHlwZW9mIEVudGl0eU1vZGVsW2FzeW5jTWV0aG9kTmFtZV0gIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmQoYFJQQyBlbmRwb2ludCBcIiR7Y3R4LnBhdGh9XCIgbm90IGZvdW5kLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5pbnZva2VUcmFja2luZykge1xuICAgICAgICAgICAgICAgIGFwcC5sb2coJ3ZlcmJvc2UnLCBgSW52b2tpbmcgYSBwcm9jZXNzIEFQSSBbJHtlbnRpdHlOYW1lfS4ke21ldGhvZE5hbWV9XSAuLi5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY3R4LmJvZHkgPSBhd2FpdCBFbnRpdHlNb2RlbFthc3luY01ldGhvZE5hbWVdKC4uLmFyZ3MpO1xuICAgICAgICB9KTtcbiAgICB9KTsgICAgXG5cbiAgICBhcHAuYWRkUm91dGVyKHJvdXRlcik7XG59OyJdfQ==