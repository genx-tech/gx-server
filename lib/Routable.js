"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob,
  urlJoin,
  ensureLeftSlash,
  ensureRightSlash,
  urlAppendQuery
} = require('rk-utils');

const {
  Helpers: {
    tryRequire
  }
} = require('@genx/app');

const Errors = require('./utils/Errors');

const Literal = require('./enum/Literal');

const Koa = require('koa');

const Routable = T => class extends T {
  constructor(name, options) {
    super(name, options);
    this.clientPath = this.toAbsolutePath(this.options.clientPath || Literal.CLIENT_SRC_PATH);
    this.publicPath = this.toAbsolutePath(this.options.publicPath || Literal.PUBLIC_PATH);
    this.backendPath = this.toAbsolutePath(this.options.backendPath || (process.env.NODE_RT && process.env.NODE_RT === 'babel' ? Literal.BACKEND_SRC_PATH : Literal.BACKEND_PATH));
    this.router = new Koa();
    this.router.use((ctx, next) => {
      ctx.app = ctx.appModule = this;
      return next();
    });
    this.on('configLoaded', () => {
      let middlewareDir = path.join(this.backendPath, Literal.MIDDLEWARES_PATH);

      if (fs.existsSync(middlewareDir)) {
        this.loadMiddlewaresFrom(middlewareDir);
      }
    });
  }

  async start_() {
    this.middlewareFactoryRegistry = {};
    return super.start_();
  }

  async stop_() {
    delete this.middlewareFactoryRegistry;
    return super.stop_();
  }

  loadMiddlewaresFrom(dir) {
    let files = glob.sync(path.join(dir, '*.js'), {
      nodir: true
    });
    files.forEach(file => this.registerMiddlewareFactory(path.basename(file, '.js'), require(file)));
  }

  registerMiddlewareFactory(name, factoryMethod) {
    if (!(typeof factoryMethod === 'function')) {
      throw new Error('Invalid middleware factory: ' + name);
    }

    if (name in this.middlewareFactoryRegistry) {
      throw new Errors.ServerError('Middleware "' + name + '" already registered!');
    }

    this.middlewareFactoryRegistry[name] = factoryMethod;
    this.log('verbose', `Registered named middleware [${name}].`);
  }

  getMiddlewareFactory(name) {
    if (this.middlewareFactoryRegistry.hasOwnProperty(name)) {
      return this.middlewareFactoryRegistry[name];
    }

    if (this.server && this.server !== this) {
      return this.server.getMiddlewareFactory(name);
    }

    let npmMiddleware = tryRequire(name);

    if (npmMiddleware) {
      return npmMiddleware;
    }

    throw new Errors.ServerError(`Don't know where to load middleware "${name}".`);
  }

  useMiddlewares(router, middlewares) {
    let middlewareFactory, middleware;
    let middlewareFunctions = [];

    if (_.isPlainObject(middlewares)) {
      _.forOwn(middlewares, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        middleware = middlewareFactory(options, this);
        middlewareFunctions.push({
          name,
          middleware
        });
      });
    } else {
      middlewares = _.castArray(middlewares);

      _.each(middlewares, middlewareEntry => {
        let type = typeof middlewareEntry;

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(middlewareEntry);
          middleware = middlewareFactory(undefined, this);
          middlewareFunctions.push({
            name: middlewareEntry,
            middleware
          });
        } else if (type === 'function') {
          middlewareFunctions.push({
            name: middlewareEntry.name || 'unamed middleware',
            middleware: middlewareEntry
          });
        } else if (Array.isArray(middlewareEntry)) {
          if (middlewareEntry.length === 0) {
            throw new Errors.InvalidConfiguration('Empty array found as middleware entry!', this, 'middlewares');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry[0]);
          middleware = middlewareFactory(middlewareEntry.length > 1 ? middlewareEntry[1] : null, this);
          middlewareFunctions.push({
            name: middlewareEntry[0],
            middleware
          });
        } else {
          if (!_.isPlainObject(middlewareEntry) || !('name' in middlewareEntry)) {
            throw new Errors.InvalidConfiguration('Invalid middleware entry!', this, 'middlewares');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry.name);
          middleware = middlewareFactory(middlewareEntry.options, this);
          middlewareFunctions.push({
            name: middlewareEntry.name,
            middleware
          });
        }
      });
    }

    middlewareFunctions.forEach(({
      name,
      middleware
    }) => {
      if (Array.isArray(middleware)) {
        middleware.forEach(m => this.useMiddleware(router, m, name));
      } else {
        this.useMiddleware(router, middleware, name);
      }
    });
    return this;
  }

  addRoute(router, method, route, actions) {
    let handlers = [],
        middlewareFactory;

    if (_.isPlainObject(actions)) {
      _.forOwn(actions, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        handlers.push(this._wrapMiddlewareTracer(middlewareFactory(options, this), name));
      });
    } else {
      actions = _.castArray(actions);
      let lastIndex = actions.length - 1;

      _.each(actions, (action, i) => {
        let type = typeof action;

        if (i === lastIndex) {
          if (type === 'string' && action.lastIndexOf('.') > 0) {
            action = {
              name: 'action',
              options: action
            };
            type = 'object';
          }
        }

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(action);
          let middleware = middlewareFactory(null, this);

          if (Array.isArray(middleware)) {
            middleware.forEach((middlewareItem, i) => handlers.push(this._wrapMiddlewareTracer(middlewareItem, `${action}-${i}` + (middleware.name ? '-' + middleware.name : ''))));
          } else {
            handlers.push(this._wrapMiddlewareTracer(middleware, action));
          }
        } else if (type === 'function') {
          handlers.push(this._wrapMiddlewareTracer(action));
        } else if (Array.isArray(action)) {
          if (!(action.length > 0 && action.length <= 2)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action[0]);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.length > 1 ? action[1] : undefined, this)));
        } else {
          if (!(_.isPlainObject(action) && 'name' in action)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action.name);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.options, this), action.name));
        }
      });
    }

    router[method](route, ...handlers);
    let endpoint = router.opts.prefix ? urlJoin(this.route, router.opts.prefix, route) : urlJoin(this.route, route);
    this.log('verbose', `Route "${method}:${endpoint}" is added from module [${this.name}].`);
    return this;
  }

  addRouter(nestedRouter) {
    this.router.use(nestedRouter.routes());
    this.router.use(nestedRouter.allowedMethods());
    return this;
  }

  toWebPath(relativePath, ...pathOrQuery) {
    let url, query;

    if (pathOrQuery && pathOrQuery.length > 0 && (pathOrQuery.length > 1 || pathOrQuery[0] !== undefined)) {
      if (_.isObject(pathOrQuery[pathOrQuery.length - 1])) {
        query = pathOrQuery.pop();
      }

      pathOrQuery.unshift(relativePath);
      url = urlJoin(this.route, ...pathOrQuery);
    } else {
      url = urlJoin(this.route, relativePath);
    }

    url = ensureLeftSlash(url);

    if (query) {
      url = urlAppendQuery(url, query);
      url = url.replace('/?', '?');
    }

    return url;
  }

  wrapAction(action) {
    return async ctx => {
      ctx.toUrl = (relativePath, ...pathOrQuery) => {
        return ctx.origin + this.toWebPath(relativePath, ...pathOrQuery);
      };

      Object.assign(ctx.state, {
        _self: ctx.originalUrl || this.toWebPath(ctx.url),
        __: ctx.__,
        _base: ensureRightSlash(this.toWebPath()),
        _makePath: (relativePath, query) => this.toWebPath(relativePath, query),
        _makeUrl: (relativePath, query) => ctx.toUrl(relativePath, query)
      });

      if (ctx.csrf) {
        ctx.state._csrf = ctx.csrf;
      }

      return action(ctx);
    };
  }

  useMiddleware(router, middleware, name) {
    if (!(typeof middleware === 'function')) {
      throw new Error(middleware);
    }

    router.use(this._wrapMiddlewareTracer(middleware, name));
    this.log('verbose', `Attached middleware [${name}].`);
  }

  _wrapMiddlewareTracer(middleware, name) {
    if (this.options.traceMiddlewares) {
      return async (ctx, next) => {
        this.log('debug', `Step in middleware "${name || middleware.name}" ...`);
        let ret = await middleware(ctx, next);
        this.log('debug', `Step out from middleware "${name || middleware.name}".`);
        return ret;
      };
    }

    return middleware;
  }

  _getFeatureFallbackPath() {
    return super._getFeatureFallbackPath().concat([path.join(this.backendPath, Literal.FEATURES_PATH)]);
  }

};

module.exports = Routable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Sb3V0YWJsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJ1cmxKb2luIiwiZW5zdXJlTGVmdFNsYXNoIiwiZW5zdXJlUmlnaHRTbGFzaCIsInVybEFwcGVuZFF1ZXJ5IiwiSGVscGVycyIsInRyeVJlcXVpcmUiLCJFcnJvcnMiLCJMaXRlcmFsIiwiS29hIiwiUm91dGFibGUiLCJUIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImNsaWVudFBhdGgiLCJ0b0Fic29sdXRlUGF0aCIsIkNMSUVOVF9TUkNfUEFUSCIsInB1YmxpY1BhdGgiLCJQVUJMSUNfUEFUSCIsImJhY2tlbmRQYXRoIiwicHJvY2VzcyIsImVudiIsIk5PREVfUlQiLCJCQUNLRU5EX1NSQ19QQVRIIiwiQkFDS0VORF9QQVRIIiwicm91dGVyIiwidXNlIiwiY3R4IiwibmV4dCIsImFwcCIsImFwcE1vZHVsZSIsIm9uIiwibWlkZGxld2FyZURpciIsImpvaW4iLCJNSURETEVXQVJFU19QQVRIIiwiZXhpc3RzU3luYyIsImxvYWRNaWRkbGV3YXJlc0Zyb20iLCJzdGFydF8iLCJtaWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5Iiwic3RvcF8iLCJkaXIiLCJmaWxlcyIsInN5bmMiLCJub2RpciIsImZvckVhY2giLCJmaWxlIiwicmVnaXN0ZXJNaWRkbGV3YXJlRmFjdG9yeSIsImJhc2VuYW1lIiwiZmFjdG9yeU1ldGhvZCIsIlNlcnZlckVycm9yIiwibG9nIiwiZ2V0TWlkZGxld2FyZUZhY3RvcnkiLCJoYXNPd25Qcm9wZXJ0eSIsInNlcnZlciIsIm5wbU1pZGRsZXdhcmUiLCJ1c2VNaWRkbGV3YXJlcyIsIm1pZGRsZXdhcmVzIiwibWlkZGxld2FyZUZhY3RvcnkiLCJtaWRkbGV3YXJlIiwibWlkZGxld2FyZUZ1bmN0aW9ucyIsImlzUGxhaW5PYmplY3QiLCJmb3JPd24iLCJwdXNoIiwiY2FzdEFycmF5IiwiZWFjaCIsIm1pZGRsZXdhcmVFbnRyeSIsInR5cGUiLCJ1bmRlZmluZWQiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsIm0iLCJ1c2VNaWRkbGV3YXJlIiwiYWRkUm91dGUiLCJtZXRob2QiLCJyb3V0ZSIsImFjdGlvbnMiLCJoYW5kbGVycyIsIl93cmFwTWlkZGxld2FyZVRyYWNlciIsImxhc3RJbmRleCIsImFjdGlvbiIsImkiLCJsYXN0SW5kZXhPZiIsIm1pZGRsZXdhcmVJdGVtIiwiZW5kcG9pbnQiLCJvcHRzIiwicHJlZml4IiwiYWRkUm91dGVyIiwibmVzdGVkUm91dGVyIiwicm91dGVzIiwiYWxsb3dlZE1ldGhvZHMiLCJ0b1dlYlBhdGgiLCJyZWxhdGl2ZVBhdGgiLCJwYXRoT3JRdWVyeSIsInVybCIsInF1ZXJ5IiwiaXNPYmplY3QiLCJwb3AiLCJ1bnNoaWZ0IiwicmVwbGFjZSIsIndyYXBBY3Rpb24iLCJ0b1VybCIsIm9yaWdpbiIsIk9iamVjdCIsImFzc2lnbiIsInN0YXRlIiwiX3NlbGYiLCJvcmlnaW5hbFVybCIsIl9fIiwiX2Jhc2UiLCJfbWFrZVBhdGgiLCJfbWFrZVVybCIsImNzcmYiLCJfY3NyZiIsInRyYWNlTWlkZGxld2FyZXMiLCJyZXQiLCJfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCIsImNvbmNhdCIsIkZFQVRVUkVTX1BBVEgiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUEsSUFBVDtBQUFlQyxFQUFBQSxPQUFmO0FBQXdCQyxFQUFBQSxlQUF4QjtBQUF5Q0MsRUFBQUEsZ0JBQXpDO0FBQTJEQyxFQUFBQTtBQUEzRCxJQUE4RVAsT0FBTyxDQUFDLFVBQUQsQ0FBM0Y7O0FBQ0EsTUFBTTtBQUFFUSxFQUFBQSxPQUFPLEVBQUU7QUFBRUMsSUFBQUE7QUFBRjtBQUFYLElBQThCVCxPQUFPLENBQUMsV0FBRCxDQUEzQzs7QUFDQSxNQUFNVSxNQUFNLEdBQUdWLE9BQU8sQ0FBQyxnQkFBRCxDQUF0Qjs7QUFDQSxNQUFNVyxPQUFPLEdBQUdYLE9BQU8sQ0FBQyxnQkFBRCxDQUF2Qjs7QUFDQSxNQUFNWSxHQUFHLEdBQUdaLE9BQU8sQ0FBQyxLQUFELENBQW5COztBQUVBLE1BQU1hLFFBQVEsR0FBR0MsQ0FBQyxJQUFJLGNBQWNBLENBQWQsQ0FBZ0I7QUFRbENDLEVBQUFBLFdBQVcsQ0FBQ0MsSUFBRCxFQUFPQyxPQUFQLEVBQWdCO0FBQ3ZCLFVBQU1ELElBQU4sRUFBWUMsT0FBWjtBQU1BLFNBQUtDLFVBQUwsR0FBa0IsS0FBS0MsY0FBTCxDQUFvQixLQUFLRixPQUFMLENBQWFDLFVBQWIsSUFBMkJQLE9BQU8sQ0FBQ1MsZUFBdkQsQ0FBbEI7QUFNQSxTQUFLQyxVQUFMLEdBQWtCLEtBQUtGLGNBQUwsQ0FBb0IsS0FBS0YsT0FBTCxDQUFhSSxVQUFiLElBQTJCVixPQUFPLENBQUNXLFdBQXZELENBQWxCO0FBTUEsU0FBS0MsV0FBTCxHQUFtQixLQUFLSixjQUFMLENBQW9CLEtBQUtGLE9BQUwsQ0FBYU0sV0FBYixLQUE2QkMsT0FBTyxDQUFDQyxHQUFSLENBQVlDLE9BQVosSUFBdUJGLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxPQUFaLEtBQXdCLE9BQS9DLEdBQXlEZixPQUFPLENBQUNnQixnQkFBakUsR0FBb0ZoQixPQUFPLENBQUNpQixZQUF6SCxDQUFwQixDQUFuQjtBQU1BLFNBQUtDLE1BQUwsR0FBYyxJQUFJakIsR0FBSixFQUFkO0FBR0EsU0FBS2lCLE1BQUwsQ0FBWUMsR0FBWixDQUFnQixDQUFDQyxHQUFELEVBQU1DLElBQU4sS0FBZTtBQUMzQkQsTUFBQUEsR0FBRyxDQUFDRSxHQUFKLEdBQVVGLEdBQUcsQ0FBQ0csU0FBSixHQUFnQixJQUExQjtBQUNBLGFBQU9GLElBQUksRUFBWDtBQUNILEtBSEQ7QUFLQSxTQUFLRyxFQUFMLENBQVEsY0FBUixFQUF3QixNQUFNO0FBRTFCLFVBQUlDLGFBQWEsR0FBR3JDLElBQUksQ0FBQ3NDLElBQUwsQ0FBVSxLQUFLZCxXQUFmLEVBQTRCWixPQUFPLENBQUMyQixnQkFBcEMsQ0FBcEI7O0FBRUEsVUFBSXBDLEVBQUUsQ0FBQ3FDLFVBQUgsQ0FBY0gsYUFBZCxDQUFKLEVBQWtDO0FBQzlCLGFBQUtJLG1CQUFMLENBQXlCSixhQUF6QjtBQUNIO0FBQ0osS0FQRDtBQVFIOztBQUVELFFBQU1LLE1BQU4sR0FBZTtBQUtYLFNBQUtDLHlCQUFMLEdBQWlDLEVBQWpDO0FBRUEsV0FBTyxNQUFNRCxNQUFOLEVBQVA7QUFDSDs7QUFFRCxRQUFNRSxLQUFOLEdBQWM7QUFDVixXQUFPLEtBQUtELHlCQUFaO0FBRUEsV0FBTyxNQUFNQyxLQUFOLEVBQVA7QUFDSDs7QUFNREgsRUFBQUEsbUJBQW1CLENBQUNJLEdBQUQsRUFBTTtBQUNyQixRQUFJQyxLQUFLLEdBQUcxQyxJQUFJLENBQUMyQyxJQUFMLENBQVUvQyxJQUFJLENBQUNzQyxJQUFMLENBQVVPLEdBQVYsRUFBZSxNQUFmLENBQVYsRUFBa0M7QUFBQ0csTUFBQUEsS0FBSyxFQUFFO0FBQVIsS0FBbEMsQ0FBWjtBQUNBRixJQUFBQSxLQUFLLENBQUNHLE9BQU4sQ0FBY0MsSUFBSSxJQUFJLEtBQUtDLHlCQUFMLENBQStCbkQsSUFBSSxDQUFDb0QsUUFBTCxDQUFjRixJQUFkLEVBQW9CLEtBQXBCLENBQS9CLEVBQTJEakQsT0FBTyxDQUFDaUQsSUFBRCxDQUFsRSxDQUF0QjtBQUNIOztBQU9EQyxFQUFBQSx5QkFBeUIsQ0FBQ2xDLElBQUQsRUFBT29DLGFBQVAsRUFBc0I7QUFBQSxVQUN0QyxPQUFPQSxhQUFQLEtBQXlCLFVBRGE7QUFBQSxzQkFDRCxpQ0FBaUNwQyxJQURoQztBQUFBOztBQUczQyxRQUFJQSxJQUFJLElBQUksS0FBSzBCLHlCQUFqQixFQUE0QztBQUN4QyxZQUFNLElBQUloQyxNQUFNLENBQUMyQyxXQUFYLENBQXVCLGlCQUFnQnJDLElBQWhCLEdBQXNCLHVCQUE3QyxDQUFOO0FBQ0g7O0FBRUQsU0FBSzBCLHlCQUFMLENBQStCMUIsSUFBL0IsSUFBdUNvQyxhQUF2QztBQUNBLFNBQUtFLEdBQUwsQ0FBUyxTQUFULEVBQXFCLGdDQUErQnRDLElBQUssSUFBekQ7QUFDSDs7QUFPRHVDLEVBQUFBLG9CQUFvQixDQUFDdkMsSUFBRCxFQUFPO0FBQ3ZCLFFBQUksS0FBSzBCLHlCQUFMLENBQStCYyxjQUEvQixDQUE4Q3hDLElBQTlDLENBQUosRUFBeUQ7QUFDckQsYUFBTyxLQUFLMEIseUJBQUwsQ0FBK0IxQixJQUEvQixDQUFQO0FBQ0g7O0FBRUQsUUFBSSxLQUFLeUMsTUFBTCxJQUFlLEtBQUtBLE1BQUwsS0FBZ0IsSUFBbkMsRUFBeUM7QUFDckMsYUFBTyxLQUFLQSxNQUFMLENBQVlGLG9CQUFaLENBQWlDdkMsSUFBakMsQ0FBUDtBQUNIOztBQUVELFFBQUkwQyxhQUFhLEdBQUdqRCxVQUFVLENBQUNPLElBQUQsQ0FBOUI7O0FBQ0EsUUFBSTBDLGFBQUosRUFBbUI7QUFDZixhQUFPQSxhQUFQO0FBQ0g7O0FBRUQsVUFBTSxJQUFJaEQsTUFBTSxDQUFDMkMsV0FBWCxDQUF3Qix3Q0FBdUNyQyxJQUFLLElBQXBFLENBQU47QUFDSDs7QUFRRDJDLEVBQUFBLGNBQWMsQ0FBQzlCLE1BQUQsRUFBUytCLFdBQVQsRUFBc0I7QUFDaEMsUUFBSUMsaUJBQUosRUFBdUJDLFVBQXZCO0FBQ0EsUUFBSUMsbUJBQW1CLEdBQUcsRUFBMUI7O0FBRUEsUUFBSTlELENBQUMsQ0FBQytELGFBQUYsQ0FBZ0JKLFdBQWhCLENBQUosRUFBa0M7QUFDOUIzRCxNQUFBQSxDQUFDLENBQUNnRSxNQUFGLENBQVNMLFdBQVQsRUFBc0IsQ0FBQzNDLE9BQUQsRUFBVUQsSUFBVixLQUFtQjtBQUNyQzZDLFFBQUFBLGlCQUFpQixHQUFHLEtBQUtOLG9CQUFMLENBQTBCdkMsSUFBMUIsQ0FBcEI7QUFDQThDLFFBQUFBLFVBQVUsR0FBR0QsaUJBQWlCLENBQUM1QyxPQUFELEVBQVUsSUFBVixDQUE5QjtBQUNBOEMsUUFBQUEsbUJBQW1CLENBQUNHLElBQXBCLENBQXlCO0FBQUVsRCxVQUFBQSxJQUFGO0FBQVE4QyxVQUFBQTtBQUFSLFNBQXpCO0FBQ0gsT0FKRDtBQUtILEtBTkQsTUFNTztBQUNIRixNQUFBQSxXQUFXLEdBQUczRCxDQUFDLENBQUNrRSxTQUFGLENBQVlQLFdBQVosQ0FBZDs7QUFFQTNELE1BQUFBLENBQUMsQ0FBQ21FLElBQUYsQ0FBT1IsV0FBUCxFQUFvQlMsZUFBZSxJQUFJO0FBQ25DLFlBQUlDLElBQUksR0FBRyxPQUFPRCxlQUFsQjs7QUFFQSxZQUFJQyxJQUFJLEtBQUssUUFBYixFQUF1QjtBQUVuQlQsVUFBQUEsaUJBQWlCLEdBQUcsS0FBS04sb0JBQUwsQ0FBMEJjLGVBQTFCLENBQXBCO0FBQ0FQLFVBQUFBLFVBQVUsR0FBR0QsaUJBQWlCLENBQUNVLFNBQUQsRUFBWSxJQUFaLENBQTlCO0FBQ0FSLFVBQUFBLG1CQUFtQixDQUFDRyxJQUFwQixDQUF5QjtBQUFFbEQsWUFBQUEsSUFBSSxFQUFFcUQsZUFBUjtBQUEwQlAsWUFBQUE7QUFBMUIsV0FBekI7QUFDSCxTQUxELE1BS08sSUFBSVEsSUFBSSxLQUFLLFVBQWIsRUFBeUI7QUFDNUJQLFVBQUFBLG1CQUFtQixDQUFDRyxJQUFwQixDQUF5QjtBQUFFbEQsWUFBQUEsSUFBSSxFQUFFcUQsZUFBZSxDQUFDckQsSUFBaEIsSUFBd0IsbUJBQWhDO0FBQXFEOEMsWUFBQUEsVUFBVSxFQUFFTztBQUFqRSxXQUF6QjtBQUNILFNBRk0sTUFFQSxJQUFJRyxLQUFLLENBQUNDLE9BQU4sQ0FBY0osZUFBZCxDQUFKLEVBQW9DO0FBRXZDLGNBQUlBLGVBQWUsQ0FBQ0ssTUFBaEIsS0FBMkIsQ0FBL0IsRUFBa0M7QUFDOUIsa0JBQU0sSUFBSWhFLE1BQU0sQ0FBQ2lFLG9CQUFYLENBQ0Ysd0NBREUsRUFFRixJQUZFLEVBR0YsYUFIRSxDQUFOO0FBS0g7O0FBRURkLFVBQUFBLGlCQUFpQixHQUFHLEtBQUtOLG9CQUFMLENBQTBCYyxlQUFlLENBQUMsQ0FBRCxDQUF6QyxDQUFwQjtBQUNBUCxVQUFBQSxVQUFVLEdBQUdELGlCQUFpQixDQUFDUSxlQUFlLENBQUNLLE1BQWhCLEdBQXlCLENBQXpCLEdBQTZCTCxlQUFlLENBQUMsQ0FBRCxDQUE1QyxHQUFrRCxJQUFuRCxFQUF5RCxJQUF6RCxDQUE5QjtBQUNBTixVQUFBQSxtQkFBbUIsQ0FBQ0csSUFBcEIsQ0FBeUI7QUFBRWxELFlBQUFBLElBQUksRUFBRXFELGVBQWUsQ0FBQyxDQUFELENBQXZCO0FBQTRCUCxZQUFBQTtBQUE1QixXQUF6QjtBQUNILFNBYk0sTUFhQTtBQUNILGNBQUksQ0FBQzdELENBQUMsQ0FBQytELGFBQUYsQ0FBZ0JLLGVBQWhCLENBQUQsSUFBcUMsRUFBRSxVQUFVQSxlQUFaLENBQXpDLEVBQXVFO0FBQ25FLGtCQUFNLElBQUkzRCxNQUFNLENBQUNpRSxvQkFBWCxDQUNGLDJCQURFLEVBRUYsSUFGRSxFQUdGLGFBSEUsQ0FBTjtBQUtIOztBQUVEZCxVQUFBQSxpQkFBaUIsR0FBRyxLQUFLTixvQkFBTCxDQUEwQmMsZUFBZSxDQUFDckQsSUFBMUMsQ0FBcEI7QUFDQThDLFVBQUFBLFVBQVUsR0FBR0QsaUJBQWlCLENBQUNRLGVBQWUsQ0FBQ3BELE9BQWpCLEVBQTBCLElBQTFCLENBQTlCO0FBQ0E4QyxVQUFBQSxtQkFBbUIsQ0FBQ0csSUFBcEIsQ0FBeUI7QUFBRWxELFlBQUFBLElBQUksRUFBRXFELGVBQWUsQ0FBQ3JELElBQXhCO0FBQThCOEMsWUFBQUE7QUFBOUIsV0FBekI7QUFDSDtBQUNKLE9BcENEO0FBcUNIOztBQUVEQyxJQUFBQSxtQkFBbUIsQ0FBQ2YsT0FBcEIsQ0FBNEIsQ0FBQztBQUFFaEMsTUFBQUEsSUFBRjtBQUFROEMsTUFBQUE7QUFBUixLQUFELEtBQTBCO0FBQ2xELFVBQUlVLEtBQUssQ0FBQ0MsT0FBTixDQUFjWCxVQUFkLENBQUosRUFBK0I7QUFDM0JBLFFBQUFBLFVBQVUsQ0FBQ2QsT0FBWCxDQUFtQjRCLENBQUMsSUFBSSxLQUFLQyxhQUFMLENBQW1CaEQsTUFBbkIsRUFBMkIrQyxDQUEzQixFQUE4QjVELElBQTlCLENBQXhCO0FBQ0gsT0FGRCxNQUVPO0FBQ0gsYUFBSzZELGFBQUwsQ0FBbUJoRCxNQUFuQixFQUEyQmlDLFVBQTNCLEVBQXVDOUMsSUFBdkM7QUFDSDtBQUNKLEtBTkQ7QUFRQSxXQUFPLElBQVA7QUFDSDs7QUFTRDhELEVBQUFBLFFBQVEsQ0FBQ2pELE1BQUQsRUFBU2tELE1BQVQsRUFBaUJDLEtBQWpCLEVBQXdCQyxPQUF4QixFQUFpQztBQUNyQyxRQUFJQyxRQUFRLEdBQUcsRUFBZjtBQUFBLFFBQW1CckIsaUJBQW5COztBQUVBLFFBQUk1RCxDQUFDLENBQUMrRCxhQUFGLENBQWdCaUIsT0FBaEIsQ0FBSixFQUE4QjtBQUMxQmhGLE1BQUFBLENBQUMsQ0FBQ2dFLE1BQUYsQ0FBU2dCLE9BQVQsRUFBa0IsQ0FBQ2hFLE9BQUQsRUFBVUQsSUFBVixLQUFtQjtBQUNqQzZDLFFBQUFBLGlCQUFpQixHQUFHLEtBQUtOLG9CQUFMLENBQTBCdkMsSUFBMUIsQ0FBcEI7QUFDQWtFLFFBQUFBLFFBQVEsQ0FBQ2hCLElBQVQsQ0FBYyxLQUFLaUIscUJBQUwsQ0FBMkJ0QixpQkFBaUIsQ0FBQzVDLE9BQUQsRUFBVSxJQUFWLENBQTVDLEVBQTZERCxJQUE3RCxDQUFkO0FBQ0gsT0FIRDtBQUlILEtBTEQsTUFLTztBQUNIaUUsTUFBQUEsT0FBTyxHQUFHaEYsQ0FBQyxDQUFDa0UsU0FBRixDQUFZYyxPQUFaLENBQVY7QUFDQSxVQUFJRyxTQUFTLEdBQUdILE9BQU8sQ0FBQ1AsTUFBUixHQUFpQixDQUFqQzs7QUFFQXpFLE1BQUFBLENBQUMsQ0FBQ21FLElBQUYsQ0FBT2EsT0FBUCxFQUFnQixDQUFDSSxNQUFELEVBQVNDLENBQVQsS0FBZTtBQUMzQixZQUFJaEIsSUFBSSxHQUFHLE9BQU9lLE1BQWxCOztBQUVBLFlBQUlDLENBQUMsS0FBS0YsU0FBVixFQUFxQjtBQUVqQixjQUFJZCxJQUFJLEtBQUssUUFBVCxJQUFxQmUsTUFBTSxDQUFDRSxXQUFQLENBQW1CLEdBQW5CLElBQTBCLENBQW5ELEVBQXNEO0FBQ2xERixZQUFBQSxNQUFNLEdBQUc7QUFDTHJFLGNBQUFBLElBQUksRUFBRSxRQUREO0FBRUxDLGNBQUFBLE9BQU8sRUFBRW9FO0FBRkosYUFBVDtBQUtBZixZQUFBQSxJQUFJLEdBQUcsUUFBUDtBQUNIO0FBQ0o7O0FBRUQsWUFBSUEsSUFBSSxLQUFLLFFBQWIsRUFBdUI7QUFFbkJULFVBQUFBLGlCQUFpQixHQUFHLEtBQUtOLG9CQUFMLENBQTBCOEIsTUFBMUIsQ0FBcEI7QUFFQSxjQUFJdkIsVUFBVSxHQUFHRCxpQkFBaUIsQ0FBQyxJQUFELEVBQU8sSUFBUCxDQUFsQzs7QUFHQSxjQUFJVyxLQUFLLENBQUNDLE9BQU4sQ0FBY1gsVUFBZCxDQUFKLEVBQStCO0FBQzNCQSxZQUFBQSxVQUFVLENBQUNkLE9BQVgsQ0FBbUIsQ0FBQ3dDLGNBQUQsRUFBaUJGLENBQWpCLEtBQXVCSixRQUFRLENBQUNoQixJQUFULENBQ3RDLEtBQUtpQixxQkFBTCxDQUEyQkssY0FBM0IsRUFBNEMsR0FBRUgsTUFBTyxJQUFHQyxDQUFFLEVBQWYsSUFBb0J4QixVQUFVLENBQUM5QyxJQUFYLEdBQW1CLE1BQU04QyxVQUFVLENBQUM5QyxJQUFwQyxHQUE0QyxFQUFoRSxDQUEzQyxDQURzQyxDQUExQztBQUdILFdBSkQsTUFJTztBQUNIa0UsWUFBQUEsUUFBUSxDQUFDaEIsSUFBVCxDQUFjLEtBQUtpQixxQkFBTCxDQUEyQnJCLFVBQTNCLEVBQXVDdUIsTUFBdkMsQ0FBZDtBQUNIO0FBQ0osU0FkRCxNQWNPLElBQUlmLElBQUksS0FBSyxVQUFiLEVBQXlCO0FBQzVCWSxVQUFBQSxRQUFRLENBQUNoQixJQUFULENBQWMsS0FBS2lCLHFCQUFMLENBQTJCRSxNQUEzQixDQUFkO0FBQ0gsU0FGTSxNQUVBLElBQUliLEtBQUssQ0FBQ0MsT0FBTixDQUFjWSxNQUFkLENBQUosRUFBMkI7QUFBQSxnQkFDdEJBLE1BQU0sQ0FBQ1gsTUFBUCxHQUFnQixDQUFoQixJQUFxQlcsTUFBTSxDQUFDWCxNQUFQLElBQWlCLENBRGhCO0FBQUEsNEJBQ21CLDBCQURuQjtBQUFBOztBQUc5QmIsVUFBQUEsaUJBQWlCLEdBQUcsS0FBS04sb0JBQUwsQ0FBMEI4QixNQUFNLENBQUMsQ0FBRCxDQUFoQyxDQUFwQjtBQUNBSCxVQUFBQSxRQUFRLENBQUNoQixJQUFULENBQWMsS0FBS2lCLHFCQUFMLENBQTJCdEIsaUJBQWlCLENBQUN3QixNQUFNLENBQUNYLE1BQVAsR0FBZ0IsQ0FBaEIsR0FBb0JXLE1BQU0sQ0FBQyxDQUFELENBQTFCLEdBQWdDZCxTQUFqQyxFQUE0QyxJQUE1QyxDQUE1QyxDQUFkO0FBQ0gsU0FMTSxNQUtBO0FBQUEsZ0JBQ0t0RSxDQUFDLENBQUMrRCxhQUFGLENBQWdCcUIsTUFBaEIsS0FBMkIsVUFBVUEsTUFEMUM7QUFBQSw0QkFDa0QsMEJBRGxEO0FBQUE7O0FBR0h4QixVQUFBQSxpQkFBaUIsR0FBRyxLQUFLTixvQkFBTCxDQUEwQjhCLE1BQU0sQ0FBQ3JFLElBQWpDLENBQXBCO0FBQ0FrRSxVQUFBQSxRQUFRLENBQUNoQixJQUFULENBQWMsS0FBS2lCLHFCQUFMLENBQTJCdEIsaUJBQWlCLENBQUN3QixNQUFNLENBQUNwRSxPQUFSLEVBQWlCLElBQWpCLENBQTVDLEVBQW9Fb0UsTUFBTSxDQUFDckUsSUFBM0UsQ0FBZDtBQUNIO0FBQ0osT0ExQ0Q7QUEyQ0g7O0FBRURhLElBQUFBLE1BQU0sQ0FBQ2tELE1BQUQsQ0FBTixDQUFlQyxLQUFmLEVBQXNCLEdBQUdFLFFBQXpCO0FBRUEsUUFBSU8sUUFBUSxHQUFHNUQsTUFBTSxDQUFDNkQsSUFBUCxDQUFZQyxNQUFaLEdBQXFCdkYsT0FBTyxDQUFDLEtBQUs0RSxLQUFOLEVBQWFuRCxNQUFNLENBQUM2RCxJQUFQLENBQVlDLE1BQXpCLEVBQWlDWCxLQUFqQyxDQUE1QixHQUFzRTVFLE9BQU8sQ0FBQyxLQUFLNEUsS0FBTixFQUFhQSxLQUFiLENBQTVGO0FBRUEsU0FBSzFCLEdBQUwsQ0FBUyxTQUFULEVBQXFCLFVBQVN5QixNQUFPLElBQUdVLFFBQVMsMkJBQTBCLEtBQUt6RSxJQUFLLElBQXJGO0FBRUEsV0FBTyxJQUFQO0FBQ0g7O0FBTUQ0RSxFQUFBQSxTQUFTLENBQUNDLFlBQUQsRUFBZTtBQUNwQixTQUFLaEUsTUFBTCxDQUFZQyxHQUFaLENBQWdCK0QsWUFBWSxDQUFDQyxNQUFiLEVBQWhCO0FBQ0EsU0FBS2pFLE1BQUwsQ0FBWUMsR0FBWixDQUFnQitELFlBQVksQ0FBQ0UsY0FBYixFQUFoQjtBQUNBLFdBQU8sSUFBUDtBQUNIOztBQVFEQyxFQUFBQSxTQUFTLENBQUNDLFlBQUQsRUFBZSxHQUFHQyxXQUFsQixFQUErQjtBQUNwQyxRQUFJQyxHQUFKLEVBQVNDLEtBQVQ7O0FBRUEsUUFBSUYsV0FBVyxJQUFJQSxXQUFXLENBQUN4QixNQUFaLEdBQXFCLENBQXBDLEtBQTBDd0IsV0FBVyxDQUFDeEIsTUFBWixHQUFxQixDQUFyQixJQUEwQndCLFdBQVcsQ0FBQyxDQUFELENBQVgsS0FBbUIzQixTQUF2RixDQUFKLEVBQXVHO0FBQ25HLFVBQUl0RSxDQUFDLENBQUNvRyxRQUFGLENBQVdILFdBQVcsQ0FBQ0EsV0FBVyxDQUFDeEIsTUFBWixHQUFxQixDQUF0QixDQUF0QixDQUFKLEVBQXFEO0FBQ2pEMEIsUUFBQUEsS0FBSyxHQUFHRixXQUFXLENBQUNJLEdBQVosRUFBUjtBQUNIOztBQUNESixNQUFBQSxXQUFXLENBQUNLLE9BQVosQ0FBb0JOLFlBQXBCO0FBQ0FFLE1BQUFBLEdBQUcsR0FBRy9GLE9BQU8sQ0FBQyxLQUFLNEUsS0FBTixFQUFhLEdBQUdrQixXQUFoQixDQUFiO0FBQ0gsS0FORCxNQU1PO0FBQ0hDLE1BQUFBLEdBQUcsR0FBRy9GLE9BQU8sQ0FBQyxLQUFLNEUsS0FBTixFQUFhaUIsWUFBYixDQUFiO0FBQ0g7O0FBRURFLElBQUFBLEdBQUcsR0FBRzlGLGVBQWUsQ0FBQzhGLEdBQUQsQ0FBckI7O0FBRUEsUUFBSUMsS0FBSixFQUFXO0FBQ1BELE1BQUFBLEdBQUcsR0FBRzVGLGNBQWMsQ0FBQzRGLEdBQUQsRUFBTUMsS0FBTixDQUFwQjtBQUNBRCxNQUFBQSxHQUFHLEdBQUdBLEdBQUcsQ0FBQ0ssT0FBSixDQUFZLElBQVosRUFBa0IsR0FBbEIsQ0FBTjtBQUNIOztBQUVELFdBQU9MLEdBQVA7QUFDSDs7QUFRRE0sRUFBQUEsVUFBVSxDQUFDcEIsTUFBRCxFQUFTO0FBQ2YsV0FBTyxNQUFPdEQsR0FBUCxJQUFlO0FBQ2xCQSxNQUFBQSxHQUFHLENBQUMyRSxLQUFKLEdBQVksQ0FBQ1QsWUFBRCxFQUFlLEdBQUdDLFdBQWxCLEtBQWtDO0FBQzFDLGVBQU9uRSxHQUFHLENBQUM0RSxNQUFKLEdBQWEsS0FBS1gsU0FBTCxDQUFlQyxZQUFmLEVBQTZCLEdBQUdDLFdBQWhDLENBQXBCO0FBQ0gsT0FGRDs7QUFJQVUsTUFBQUEsTUFBTSxDQUFDQyxNQUFQLENBQWM5RSxHQUFHLENBQUMrRSxLQUFsQixFQUF5QjtBQUNyQkMsUUFBQUEsS0FBSyxFQUFFaEYsR0FBRyxDQUFDaUYsV0FBSixJQUFtQixLQUFLaEIsU0FBTCxDQUFlakUsR0FBRyxDQUFDb0UsR0FBbkIsQ0FETDtBQUVyQmMsUUFBQUEsRUFBRSxFQUFFbEYsR0FBRyxDQUFDa0YsRUFGYTtBQUdyQkMsUUFBQUEsS0FBSyxFQUFFNUcsZ0JBQWdCLENBQUMsS0FBSzBGLFNBQUwsRUFBRCxDQUhGO0FBSXJCbUIsUUFBQUEsU0FBUyxFQUFFLENBQUNsQixZQUFELEVBQWVHLEtBQWYsS0FBeUIsS0FBS0osU0FBTCxDQUFlQyxZQUFmLEVBQTZCRyxLQUE3QixDQUpmO0FBS3JCZ0IsUUFBQUEsUUFBUSxFQUFFLENBQUNuQixZQUFELEVBQWVHLEtBQWYsS0FBeUJyRSxHQUFHLENBQUMyRSxLQUFKLENBQVVULFlBQVYsRUFBd0JHLEtBQXhCO0FBTGQsT0FBekI7O0FBUUEsVUFBSXJFLEdBQUcsQ0FBQ3NGLElBQVIsRUFBYztBQUNWdEYsUUFBQUEsR0FBRyxDQUFDK0UsS0FBSixDQUFVUSxLQUFWLEdBQWtCdkYsR0FBRyxDQUFDc0YsSUFBdEI7QUFDSDs7QUFFRCxhQUFPaEMsTUFBTSxDQUFDdEQsR0FBRCxDQUFiO0FBQ0gsS0FsQkQ7QUFtQkg7O0FBRUQ4QyxFQUFBQSxhQUFhLENBQUNoRCxNQUFELEVBQVNpQyxVQUFULEVBQXFCOUMsSUFBckIsRUFBMkI7QUFBQSxVQUM1QixPQUFPOEMsVUFBUCxLQUFzQixVQURNO0FBQUEsc0JBQ01BLFVBRE47QUFBQTs7QUFFcENqQyxJQUFBQSxNQUFNLENBQUNDLEdBQVAsQ0FBVyxLQUFLcUQscUJBQUwsQ0FBMkJyQixVQUEzQixFQUF1QzlDLElBQXZDLENBQVg7QUFDQSxTQUFLc0MsR0FBTCxDQUFTLFNBQVQsRUFBcUIsd0JBQXVCdEMsSUFBSyxJQUFqRDtBQUNIOztBQUVEbUUsRUFBQUEscUJBQXFCLENBQUNyQixVQUFELEVBQWE5QyxJQUFiLEVBQW1CO0FBQ3BDLFFBQUksS0FBS0MsT0FBTCxDQUFhc0csZ0JBQWpCLEVBQW1DO0FBQy9CLGFBQU8sT0FBT3hGLEdBQVAsRUFBWUMsSUFBWixLQUFxQjtBQUN4QixhQUFLc0IsR0FBTCxDQUFTLE9BQVQsRUFBbUIsdUJBQXNCdEMsSUFBSSxJQUFJOEMsVUFBVSxDQUFDOUMsSUFBSyxPQUFqRTtBQUNBLFlBQUl3RyxHQUFHLEdBQUcsTUFBTTFELFVBQVUsQ0FBQy9CLEdBQUQsRUFBTUMsSUFBTixDQUExQjtBQUNBLGFBQUtzQixHQUFMLENBQVMsT0FBVCxFQUFtQiw2QkFBNEJ0QyxJQUFJLElBQUk4QyxVQUFVLENBQUM5QyxJQUFLLElBQXZFO0FBQ0EsZUFBT3dHLEdBQVA7QUFDSCxPQUxEO0FBTUg7O0FBRUQsV0FBTzFELFVBQVA7QUFDSDs7QUFFRDJELEVBQUFBLHVCQUF1QixHQUFHO0FBQ3RCLFdBQU8sTUFBTUEsdUJBQU4sR0FBZ0NDLE1BQWhDLENBQXVDLENBQUUzSCxJQUFJLENBQUNzQyxJQUFMLENBQVUsS0FBS2QsV0FBZixFQUE0QlosT0FBTyxDQUFDZ0gsYUFBcEMsQ0FBRixDQUF2QyxDQUFQO0FBQ0g7O0FBeFZpQyxDQUF0Qzs7QUEyVkFDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQmhILFFBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IF8sIGZzLCBnbG9iLCB1cmxKb2luLCBlbnN1cmVMZWZ0U2xhc2gsIGVuc3VyZVJpZ2h0U2xhc2gsIHVybEFwcGVuZFF1ZXJ5IH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBIZWxwZXJzOiB7IHRyeVJlcXVpcmUgfSB9ID0gcmVxdWlyZSgnQGdlbngvYXBwJyk7XG5jb25zdCBFcnJvcnMgPSByZXF1aXJlKCcuL3V0aWxzL0Vycm9ycycpO1xuY29uc3QgTGl0ZXJhbCA9IHJlcXVpcmUoJy4vZW51bS9MaXRlcmFsJyk7XG5jb25zdCBLb2EgPSByZXF1aXJlKCdrb2EnKTtcblxuY29uc3QgUm91dGFibGUgPSBUID0+IGNsYXNzIGV4dGVuZHMgVCB7ICAgIFxuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgcm91dGFibGUgaW5zdGFuY2UuICAgICBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gUm91dGFibGUgb3B0aW9ucyAgICAgICAgICAgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5iYWNrZW5kUGF0aD0nc2VydmVyJ10gLSBSZWxhdGl2ZSBwYXRoIG9mIGJhY2stZW5kIHNlcnZlciBzb3VyY2UgZmlsZXNcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuY2xpZW50UGF0aD0nY2xpZW50J10gLSBSZWxhdGl2ZSBwYXRoIG9mIGZyb250LWVuZCBjbGllbnQgc291cmNlIGZpbGVzICAgICBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucHVibGljUGF0aD0ncHVibGljJ10gLSBSZWxhdGl2ZSBwYXRoIG9mIGZyb250LWVuZCBzdGF0aWMgZmlsZXMgXG4gICAgICovICAgICAgICAgXG4gICAgY29uc3RydWN0b3IobmFtZSwgb3B0aW9ucykge1xuICAgICAgICBzdXBlcihuYW1lLCBvcHRpb25zKTsgICAgICAgIFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBGcm9udGVuZCBzb3VyY2UgZmlsZXMgcGF0aC5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMuY2xpZW50UGF0aCA9IHRoaXMudG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLmNsaWVudFBhdGggfHwgTGl0ZXJhbC5DTElFTlRfU1JDX1BBVEgpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBGcm9udGVuZCBzdGF0aWMgZmlsZXMgcGF0aC5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMucHVibGljUGF0aCA9IHRoaXMudG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLnB1YmxpY1BhdGggfHwgTGl0ZXJhbC5QVUJMSUNfUEFUSCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEJhY2tlbmQgZmlsZXMgcGF0aC5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSAgICAgICAgIFxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMuYmFja2VuZFBhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5iYWNrZW5kUGF0aCB8fCAocHJvY2Vzcy5lbnYuTk9ERV9SVCAmJiBwcm9jZXNzLmVudi5OT0RFX1JUID09PSAnYmFiZWwnID8gTGl0ZXJhbC5CQUNLRU5EX1NSQ19QQVRIIDogTGl0ZXJhbC5CQUNLRU5EX1BBVEgpKTsgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEVhY2ggYXBwIGhhcyBpdHMgb3duIHJvdXRlci5cbiAgICAgICAgICogQG1lbWJlciB7S29hfVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMucm91dGVyID0gbmV3IEtvYSgpO1xuXG4gICAgICAgIC8vaW5qZWN0IHRoZSBhcHBNb2R1bGUgaW5zdGFuY2UgaW4gdGhlIGZpcnN0IG1pZGRsZXdhcmVcbiAgICAgICAgdGhpcy5yb3V0ZXIudXNlKChjdHgsIG5leHQpID0+IHsgXG4gICAgICAgICAgICBjdHguYXBwID0gY3R4LmFwcE1vZHVsZSA9IHRoaXM7IFxuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTsgXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMub24oJ2NvbmZpZ0xvYWRlZCcsICgpID0+IHtcbiAgICAgICAgICAgIC8vbG9hZCBtaWRkbGV3YXJlcyBpZiBleGlzdHMgaW4gc2VydmVyIG9yIGFwcCBwYXRoXG4gICAgICAgICAgICBsZXQgbWlkZGxld2FyZURpciA9IHBhdGguam9pbih0aGlzLmJhY2tlbmRQYXRoLCBMaXRlcmFsLk1JRERMRVdBUkVTX1BBVEgpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhtaWRkbGV3YXJlRGlyKSkge1xuICAgICAgICAgICAgICAgIHRoaXMubG9hZE1pZGRsZXdhcmVzRnJvbShtaWRkbGV3YXJlRGlyKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSk7ICBcbiAgICB9XG5cbiAgICBhc3luYyBzdGFydF8oKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBNaWRkbGV3YXJlIGZhY3RvcnkgcmVnaXN0cnkuXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeSA9IHt9O1xuXG4gICAgICAgIHJldHVybiBzdXBlci5zdGFydF8oKTtcbiAgICB9XG5cbiAgICBhc3luYyBzdG9wXygpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeTtcblxuICAgICAgICByZXR1cm4gc3VwZXIuc3RvcF8oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMb2FkIGFuZCByZWdzaXRlciBtaWRkbGV3YXJlIGZpbGVzIGZyb20gYSBzcGVjaWZpZWQgcGF0aC5cbiAgICAgKiBAcGFyYW0gZGlyXG4gICAgICovXG4gICAgbG9hZE1pZGRsZXdhcmVzRnJvbShkaXIpIHtcbiAgICAgICAgbGV0IGZpbGVzID0gZ2xvYi5zeW5jKHBhdGguam9pbihkaXIsICcqLmpzJyksIHtub2RpcjogdHJ1ZX0pO1xuICAgICAgICBmaWxlcy5mb3JFYWNoKGZpbGUgPT4gdGhpcy5yZWdpc3Rlck1pZGRsZXdhcmVGYWN0b3J5KHBhdGguYmFzZW5hbWUoZmlsZSwgJy5qcycpLCByZXF1aXJlKGZpbGUpKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVnaXN0ZXIgdGhlIGZhY3RvcnkgbWV0aG9kIG9mIGEgbmFtZWQgbWlkZGxld2FyZS4gICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIG1pZGRsZXdhcmUgXG4gICAgICogQHBhcmFtIHtmdW5jdGlvbn0gZmFjdG9yeU1ldGhvZCAtIFRoZSBmYWN0b3J5IG1ldGhvZCBvZiBhIG1pZGRsZXdhcmVcbiAgICAgKi9cbiAgICByZWdpc3Rlck1pZGRsZXdhcmVGYWN0b3J5KG5hbWUsIGZhY3RvcnlNZXRob2QpIHtcbiAgICAgICAgcHJlOiB0eXBlb2YgZmFjdG9yeU1ldGhvZCA9PT0gJ2Z1bmN0aW9uJywgJ0ludmFsaWQgbWlkZGxld2FyZSBmYWN0b3J5OiAnICsgbmFtZTsgICAgICAgIFxuXG4gICAgICAgIGlmIChuYW1lIGluIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9ycy5TZXJ2ZXJFcnJvcignTWlkZGxld2FyZSBcIicrIG5hbWUgKydcIiBhbHJlYWR5IHJlZ2lzdGVyZWQhJyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnlbbmFtZV0gPSBmYWN0b3J5TWV0aG9kO1xuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBSZWdpc3RlcmVkIG5hbWVkIG1pZGRsZXdhcmUgWyR7bmFtZX1dLmApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgZmFjdG9yeSBtZXRob2Qgb2YgYSBtaWRkbGV3YXJlIGZyb20gbW9kdWxlIGhpZXJhcmNoeS4gICAgIFxuICAgICAqIEBwYXJhbSBuYW1lXG4gICAgICogQHJldHVybnMge2Z1bmN0aW9ufVxuICAgICAqL1xuICAgIGdldE1pZGRsZXdhcmVGYWN0b3J5KG5hbWUpIHtcbiAgICAgICAgaWYgKHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeVtuYW1lXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnNlcnZlciAmJiB0aGlzLnNlcnZlciAhPT0gdGhpcykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VydmVyLmdldE1pZGRsZXdhcmVGYWN0b3J5KG5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG5wbU1pZGRsZXdhcmUgPSB0cnlSZXF1aXJlKG5hbWUpO1xuICAgICAgICBpZiAobnBtTWlkZGxld2FyZSkge1xuICAgICAgICAgICAgcmV0dXJuIG5wbU1pZGRsZXdhcmU7XG4gICAgICAgIH1cblxuICAgICAgICB0aHJvdyBuZXcgRXJyb3JzLlNlcnZlckVycm9yKGBEb24ndCBrbm93IHdoZXJlIHRvIGxvYWQgbWlkZGxld2FyZSBcIiR7bmFtZX1cIi5gKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVc2UgbWlkZGxld2FyZXNcbiAgICAgKiBAcGFyYW0ge1JvdXRlcn0gcm91dGVyXG4gICAgICogQHBhcmFtIHsqfSBtaWRkbGV3YXJlcyAtIENhbiBiZSBhbiBhcnJheSBvZiBtaWRkbGV3YXJlIGVudHJpZXMgb3IgYSBrZXktdmFsdWUgbGlzdCBvZiByZWdpc3RlcnJlZCBtaWRkbGV3YXJlc1xuICAgICAqIEByZXR1cm5zIHtSb3V0YWJsZX1cbiAgICAgKi9cbiAgICB1c2VNaWRkbGV3YXJlcyhyb3V0ZXIsIG1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGxldCBtaWRkbGV3YXJlRmFjdG9yeSwgbWlkZGxld2FyZTtcbiAgICAgICAgbGV0IG1pZGRsZXdhcmVGdW5jdGlvbnMgPSBbXTtcbiAgICAgICAgXG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QobWlkZGxld2FyZXMpKSB7XG4gICAgICAgICAgICBfLmZvck93bihtaWRkbGV3YXJlcywgKG9wdGlvbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSk7ICAgXG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZSA9IG1pZGRsZXdhcmVGYWN0b3J5KG9wdGlvbnMsIHRoaXMpO1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMucHVzaCh7IG5hbWUsIG1pZGRsZXdhcmUgfSk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtaWRkbGV3YXJlcyA9IF8uY2FzdEFycmF5KG1pZGRsZXdhcmVzKTsgICAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgXy5lYWNoKG1pZGRsZXdhcmVzLCBtaWRkbGV3YXJlRW50cnkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCB0eXBlID0gdHlwZW9mIG1pZGRsZXdhcmVFbnRyeTtcblxuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAvLyBbICduYW1lZE1pZGRsZXdhcmUnIF1cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmVFbnRyeSk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeSh1bmRlZmluZWQsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lOiBtaWRkbGV3YXJlRW50cnkgLCBtaWRkbGV3YXJlIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lOiBtaWRkbGV3YXJlRW50cnkubmFtZSB8fCAndW5hbWVkIG1pZGRsZXdhcmUnLCBtaWRkbGV3YXJlOiBtaWRkbGV3YXJlRW50cnl9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkobWlkZGxld2FyZUVudHJ5KSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBbIFsgJ25hbWVkTWlkZGxld2FyZScsIGNvbmZpZyBdIF1cbiAgICAgICAgICAgICAgICAgICAgaWYgKG1pZGRsZXdhcmVFbnRyeS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcnMuSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0VtcHR5IGFycmF5IGZvdW5kIGFzIG1pZGRsZXdhcmUgZW50cnkhJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtaWRkbGV3YXJlcydcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUVudHJ5WzBdKTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZSA9IG1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmVFbnRyeS5sZW5ndGggPiAxID8gbWlkZGxld2FyZUVudHJ5WzFdIDogbnVsbCwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMucHVzaCh7IG5hbWU6IG1pZGRsZXdhcmVFbnRyeVswXSwgbWlkZGxld2FyZSB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIV8uaXNQbGFpbk9iamVjdChtaWRkbGV3YXJlRW50cnkpIHx8ICEoJ25hbWUnIGluIG1pZGRsZXdhcmVFbnRyeSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcnMuSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0ludmFsaWQgbWlkZGxld2FyZSBlbnRyeSEnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ21pZGRsZXdhcmVzJ1xuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShtaWRkbGV3YXJlRW50cnkubmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeShtaWRkbGV3YXJlRW50cnkub3B0aW9ucywgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMucHVzaCh7IG5hbWU6IG1pZGRsZXdhcmVFbnRyeS5uYW1lLCBtaWRkbGV3YXJlIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IFxuICAgICAgICBcbiAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5mb3JFYWNoKCh7IG5hbWUsIG1pZGRsZXdhcmUgfSkgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobWlkZGxld2FyZSkpIHtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlLmZvckVhY2gobSA9PiB0aGlzLnVzZU1pZGRsZXdhcmUocm91dGVyLCBtLCBuYW1lKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMudXNlTWlkZGxld2FyZShyb3V0ZXIsIG1pZGRsZXdhcmUsIG5hbWUpO1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIHJvdXRlIHRvIGEgcm91dGVyLCBza2lwcGVkIHdoaWxlIHRoZSBzZXJ2ZXIgcnVubmluZyBpbiBkZWFmIG1vZGUuICAgICBcbiAgICAgKiBAcGFyYW0gcm91dGVyXG4gICAgICogQHBhcmFtIG1ldGhvZFxuICAgICAqIEBwYXJhbSByb3V0ZVxuICAgICAqIEBwYXJhbSBhY3Rpb25zXG4gICAgICovXG4gICAgYWRkUm91dGUocm91dGVyLCBtZXRob2QsIHJvdXRlLCBhY3Rpb25zKSB7XG4gICAgICAgIGxldCBoYW5kbGVycyA9IFtdLCBtaWRkbGV3YXJlRmFjdG9yeTtcblxuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KGFjdGlvbnMpKSB7XG4gICAgICAgICAgICBfLmZvck93bihhY3Rpb25zLCAob3B0aW9ucywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShuYW1lKTtcbiAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmVGYWN0b3J5KG9wdGlvbnMsIHRoaXMpLCBuYW1lKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFjdGlvbnMgPSBfLmNhc3RBcnJheShhY3Rpb25zKTtcbiAgICAgICAgICAgIGxldCBsYXN0SW5kZXggPSBhY3Rpb25zLmxlbmd0aCAtIDE7XG5cbiAgICAgICAgICAgIF8uZWFjaChhY3Rpb25zLCAoYWN0aW9uLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHR5cGUgPSB0eXBlb2YgYWN0aW9uO1xuXG4gICAgICAgICAgICAgICAgaWYgKGkgPT09IGxhc3RJbmRleCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBsYXN0IG1pZGRsZXdhcmUgbWF5IGJlIGFuIGFjdGlvblxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3N0cmluZycgJiYgYWN0aW9uLmxhc3RJbmRleE9mKCcuJykgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJ2FjdGlvbicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uczogYWN0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ29iamVjdCc7XG4gICAgICAgICAgICAgICAgICAgIH0gICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFsgJ25hbWVkTWlkZGxld2FyZScgXVxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uKTsgICBcblxuICAgICAgICAgICAgICAgICAgICBsZXQgbWlkZGxld2FyZSA9IG1pZGRsZXdhcmVGYWN0b3J5KG51bGwsIHRoaXMpO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vaW4gY2FzZSBpdCdzIHJlZ2lzdGVyIGJ5IHRoZSBtaWRkbGV3YXJlRmFjdG9yeSBmZWF0dXJlXG4gICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG1pZGRsZXdhcmUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlLmZvckVhY2goKG1pZGRsZXdhcmVJdGVtLCBpKSA9PiBoYW5kbGVycy5wdXNoKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmVJdGVtLCBgJHthY3Rpb259LSR7aX1gICsgKG1pZGRsZXdhcmUubmFtZSA/ICgnLScgKyBtaWRkbGV3YXJlLm5hbWUpIDogJycpKVxuICAgICAgICAgICAgICAgICAgICAgICAgKSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZSwgYWN0aW9uKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaCh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihhY3Rpb24pKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoYWN0aW9uKSkge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQ6IGFjdGlvbi5sZW5ndGggPiAwICYmIGFjdGlvbi5sZW5ndGggPD0gMiwgJ0ludmFsaWQgbWlkZGxld2FyZSBlbnRyeSc7XG5cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvblswXSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaCh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlRmFjdG9yeShhY3Rpb24ubGVuZ3RoID4gMSA/IGFjdGlvblsxXSA6IHVuZGVmaW5lZCwgdGhpcykpKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydDogXy5pc1BsYWluT2JqZWN0KGFjdGlvbikgJiYgJ25hbWUnIGluIGFjdGlvbiwgJ0ludmFsaWQgbWlkZGxld2FyZSBlbnRyeSc7XG5cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvbi5uYW1lKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvbi5vcHRpb25zLCB0aGlzKSwgYWN0aW9uLm5hbWUpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG5cbiAgICAgICAgcm91dGVyW21ldGhvZF0ocm91dGUsIC4uLmhhbmRsZXJzKTtcblxuICAgICAgICBsZXQgZW5kcG9pbnQgPSByb3V0ZXIub3B0cy5wcmVmaXggPyB1cmxKb2luKHRoaXMucm91dGUsIHJvdXRlci5vcHRzLnByZWZpeCwgcm91dGUpIDogdXJsSm9pbih0aGlzLnJvdXRlLCByb3V0ZSk7XG5cbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgUm91dGUgXCIke21ldGhvZH06JHtlbmRwb2ludH1cIiBpcyBhZGRlZCBmcm9tIG1vZHVsZSBbJHt0aGlzLm5hbWV9XS5gKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9ICAgIFxuXG4gICAgLyoqXG4gICAgICogQXR0YWNoIGEgcm91dGVyIHRvIHRoaXMgYXBwIG1vZHVsZSwgc2tpcHBlZCB3aGlsZSB0aGUgc2VydmVyIHJ1bm5pbmcgaW4gZGVhZiBtb2RlICAgICBcbiAgICAgKiBAcGFyYW0ge1JvdXRlcn0gbmVzdGVkUm91dGVyXG4gICAgICovXG4gICAgYWRkUm91dGVyKG5lc3RlZFJvdXRlcikge1xuICAgICAgICB0aGlzLnJvdXRlci51c2UobmVzdGVkUm91dGVyLnJvdXRlcygpKTtcbiAgICAgICAgdGhpcy5yb3V0ZXIudXNlKG5lc3RlZFJvdXRlci5hbGxvd2VkTWV0aG9kcygpKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIGEgcmVsYXRpdmUgcGF0aCBhbmQgcXVlcnkgcGFyYW1ldGVycyBpZiBhbnkgdG8gYSB1cmwgcGF0aCAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHJlbGF0aXZlUGF0aCAtIFJlbGF0aXZlIHBhdGhcbiAgICAgKiBAcGFyYW0gey4uLip9IFtwYXRoT3JRdWVyeV0gLSBRdWVyaWVzXG4gICAgICogQHJldHVybnMge3N0cmluZ31cbiAgICAgKi9cbiAgICB0b1dlYlBhdGgocmVsYXRpdmVQYXRoLCAuLi5wYXRoT3JRdWVyeSkge1xuICAgICAgICBsZXQgdXJsLCBxdWVyeTtcblxuICAgICAgICBpZiAocGF0aE9yUXVlcnkgJiYgcGF0aE9yUXVlcnkubGVuZ3RoID4gMCAmJiAocGF0aE9yUXVlcnkubGVuZ3RoID4gMSB8fCBwYXRoT3JRdWVyeVswXSAhPT0gdW5kZWZpbmVkKSkge1xuICAgICAgICAgICAgaWYgKF8uaXNPYmplY3QocGF0aE9yUXVlcnlbcGF0aE9yUXVlcnkubGVuZ3RoIC0gMV0pKSB7XG4gICAgICAgICAgICAgICAgcXVlcnkgPSBwYXRoT3JRdWVyeS5wb3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBhdGhPclF1ZXJ5LnVuc2hpZnQocmVsYXRpdmVQYXRoKTtcbiAgICAgICAgICAgIHVybCA9IHVybEpvaW4odGhpcy5yb3V0ZSwgLi4ucGF0aE9yUXVlcnkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdXJsID0gdXJsSm9pbih0aGlzLnJvdXRlLCByZWxhdGl2ZVBhdGgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdXJsID0gZW5zdXJlTGVmdFNsYXNoKHVybCk7XG5cbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICB1cmwgPSB1cmxBcHBlbmRRdWVyeSh1cmwsIHF1ZXJ5KTtcbiAgICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKCcvPycsICc/Jyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdXJsO1xuICAgIH0gICAgXG5cbiAgICAvKipcbiAgICAgKiBQcmVwYXJlIGNvbnRleHQgZm9yIGtvYSBhY3Rpb25cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gY3R4IC0gS29hIHJlcXVlc3QgY29udGV4dFxuICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGFjdGlvbiAtIEFjdGlvbiBmdW5jdGlvblxuICAgICAqIEByZXR1cm4ge2Z1bmN0aW9ufVxuICAgICAqL1xuICAgIHdyYXBBY3Rpb24oYWN0aW9uKSB7XG4gICAgICAgIHJldHVybiBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgICAgICBjdHgudG9VcmwgPSAocmVsYXRpdmVQYXRoLCAuLi5wYXRoT3JRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBjdHgub3JpZ2luICsgdGhpcy50b1dlYlBhdGgocmVsYXRpdmVQYXRoLCAuLi5wYXRoT3JRdWVyeSk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKGN0eC5zdGF0ZSwge1xuICAgICAgICAgICAgICAgIF9zZWxmOiBjdHgub3JpZ2luYWxVcmwgfHwgdGhpcy50b1dlYlBhdGgoY3R4LnVybCksXG4gICAgICAgICAgICAgICAgX186IGN0eC5fXyxcbiAgICAgICAgICAgICAgICBfYmFzZTogZW5zdXJlUmlnaHRTbGFzaCh0aGlzLnRvV2ViUGF0aCgpKSxcbiAgICAgICAgICAgICAgICBfbWFrZVBhdGg6IChyZWxhdGl2ZVBhdGgsIHF1ZXJ5KSA9PiB0aGlzLnRvV2ViUGF0aChyZWxhdGl2ZVBhdGgsIHF1ZXJ5KSxcbiAgICAgICAgICAgICAgICBfbWFrZVVybDogKHJlbGF0aXZlUGF0aCwgcXVlcnkpID0+IGN0eC50b1VybChyZWxhdGl2ZVBhdGgsIHF1ZXJ5KSAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChjdHguY3NyZikgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGN0eC5zdGF0ZS5fY3NyZiA9IGN0eC5jc3JmO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gYWN0aW9uKGN0eCk7XG4gICAgICAgIH07ICAgICAgICBcbiAgICB9ICAgXG5cbiAgICB1c2VNaWRkbGV3YXJlKHJvdXRlciwgbWlkZGxld2FyZSwgbmFtZSkgeyAgICAgICAgICBcbiAgICAgICAgYXNzZXJ0OiB0eXBlb2YgbWlkZGxld2FyZSA9PT0gJ2Z1bmN0aW9uJywgbWlkZGxld2FyZTtcbiAgICAgICAgcm91dGVyLnVzZSh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlLCBuYW1lKSk7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYEF0dGFjaGVkIG1pZGRsZXdhcmUgWyR7bmFtZX1dLmApO1xuICAgIH1cblxuICAgIF93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlLCBuYW1lKSB7ICAgICAgICBcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy50cmFjZU1pZGRsZXdhcmVzKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gYXN5bmMgKGN0eCwgbmV4dCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nKCdkZWJ1ZycsIGBTdGVwIGluIG1pZGRsZXdhcmUgXCIke25hbWUgfHwgbWlkZGxld2FyZS5uYW1lfVwiIC4uLmApOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgbWlkZGxld2FyZShjdHgsIG5leHQpO1xuICAgICAgICAgICAgICAgIHRoaXMubG9nKCdkZWJ1ZycsIGBTdGVwIG91dCBmcm9tIG1pZGRsZXdhcmUgXCIke25hbWUgfHwgbWlkZGxld2FyZS5uYW1lfVwiLmApOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICByZXR1cm4gcmV0O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG1pZGRsZXdhcmU7XG4gICAgfVxuXG4gICAgX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKSB7XG4gICAgICAgIHJldHVybiBzdXBlci5fZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCgpLmNvbmNhdChbIHBhdGguam9pbih0aGlzLmJhY2tlbmRQYXRoLCBMaXRlcmFsLkZFQVRVUkVTX1BBVEgpIF0pO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gUm91dGFibGU7Il19