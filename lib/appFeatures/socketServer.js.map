{"version":3,"file":"socketServer.js","names":["path","require","_","url","urlUtil","text","Feature","Enums","InvalidConfiguration","DEFAULT_CONTROLLER_PATH","loadEventHandler","appModule","namespace","controllerBasePath","handlerName","isMiddleware","pos","lastIndexOf","controller","substr","action","controllerPath","resolve","ctrl","middlewareHandler","startSocketServer","config","SocketServer","tryRequire","port","logger","wsPath","options","getService","log","args","io","standalone","endpointPath","join","route","ensureStartsWith","serviceTag","hasService","i","server","httpServer","on","socket","endpoint","id","handshake","controllersPath","backendPath","middlewares","use","middlewareName","isEmpty","routes","forOwn","info","name","namespaceChannel","of","m","Array","isArray","forEach","eventHandlers","rpcControllerPath","events","handler","event","Object","keys","ctx","onDisconnect","catch","error","message","data","cb","then","onConnect","listen","registerService","module","exports","type","PLUGIN","load_","servers"],"sources":["../../src/appFeatures/socketServer.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Socket based Rpc Server\n * @module Feature_SocketServer\n * \n * middleware: (packet, next) => {}\n */\n\nconst path = require('path');\nconst { _, url: urlUtil, text } = require('@genx/july');\nconst { Feature } = require('..').Enums;\nconst { InvalidConfiguration } = require('@genx/error');\n\nconst DEFAULT_CONTROLLER_PATH = 'events';\n\nfunction loadEventHandler(appModule, namespace, controllerBasePath, handlerName, isMiddleware = false) {\n    let pos = handlerName.lastIndexOf('.');\n    if (pos < 0) {\n        if (isMiddleware) {\n            throw new InvalidConfiguration(\n                `Invalid middleware reference: ${handlerName}`,\n                appModule,\n                namespace ? `socketServer.routes[\"${namespace}\"].middlewares` : 'socketServer.middlewares'\n            );\n        } else {\n            throw new InvalidConfiguration(\n                `Invalid event handler reference: ${handlerName}`,\n                appModule,\n                `socketServer.routes[\"${namespace}\"].events`\n            );\n        }\n    }\n\n    let controller = handlerName.substr(0, pos);\n    let action = handlerName.substr(pos + 1);\n\n    let controllerPath = path.resolve(controllerBasePath, controller + '.js');\n    let ctrl = require(controllerPath);\n    \n    let middlewareHandler = ctrl[action];\n    if (typeof middlewareHandler !== 'function') {\n        if (isMiddleware) {\n            throw new InvalidConfiguration(\n                `Middleware function not found: ${handlerName}`,\n                appModule,\n                namespace ? `socketServer.routes[\"${namespace}\"].middlewares` : 'socketServer.middlewares'\n            );\n        } else {\n            throw new InvalidConfiguration(\n                `Event handler function not found: ${handlerName}`,\n                appModule,\n                `socketServer.routes[\"${namespace}\"].events`\n            );\n        }\n    }\n\n    return middlewareHandler;\n}\n\nfunction startSocketServer(appModule, config) {\n    const SocketServer = appModule.tryRequire('socket.io');\n\n    let { port, logger, path: wsPath, ...options } = config;\n\n    if (logger && typeof logger === 'string') {\n        logger = appModule.getService('logger.' + logger);\n    }\n\n    function log(...args) {\n        logger && logger.log(...args);\n    }\n\n    let io, standalone = false;\n\n    let endpointPath = wsPath ? urlUtil.join(appModule.route, wsPath) : appModule.route;\n    endpointPath = text.ensureStartsWith(endpointPath, '/');\n\n    let serviceTag = port ? `socketServer:${port}${endpointPath}` : `socketServer:${endpointPath}`;\n\n    if (appModule.hasService(serviceTag)) {\n        throw new InvalidConfiguration(\n            'Socket server path or port conflict.',\n            appModule,\n            `socketServer[${i}].(path|port)`\n        );\n    }            \n\n    options.path = endpointPath;\n\n    if (port) {\n        io = new SocketServer(options);\n        standalone = true;\n        appModule.log('verbose', `A standalone socket server is listening at [port=${port}, path=${endpointPath}].`);        \n    } else {\n        io = new SocketServer(appModule.server.httpServer, options);\n        port = appModule.server.port;\n        appModule.log('verbose', `A socket server is listening at [path=${endpointPath}].`);        \n    }\n\n    io.on('connection', socket => {\n        log('info', 'client connect', {\n            endpoint: endpointPath,\n            port,\n            id: socket.id,\n            ...socket.handshake\n        });\n    });\n\n    let controllersPath = path.resolve(appModule.backendPath, config.controllersPath || DEFAULT_CONTROLLER_PATH);\n\n    if (config.middlewares) {\n        io.use(loadEventHandler(appModule, null, controllersPath, middlewareName, true));\n    }\n\n    if (_.isEmpty(config.routes)) {\n        throw new InvalidConfiguration(\n            'Missing routes config.',\n            appModule,\n            'socketServer.routes'\n        );\n    }        \n\n    _.forOwn(config.routes, (info, name) => {\n        name = text.ensureStartsWith(name, '/');\n\n        let namespaceChannel = io.of(name);\n\n        if (info.middlewares) {\n            let m = Array.isArray(info.middlewares) ? info.middlewares : [ info.middlewares ];\n            m.forEach(middlewareName => {\n                namespaceChannel.use(loadEventHandler(appModule, name, controllersPath, middlewareName, true));\n            });\n        }\n\n        let eventHandlers;\n\n        if (info.controller) {                \n            let rpcControllerPath = path.resolve(controllersPath, info.controller + '.js');\n            eventHandlers = require(rpcControllerPath);\n\n            appModule.log('verbose', `[${serviceTag}]Controller \"${info.controller}\" is attached for namespace \"${name}\".`);\n        } \n        \n        if (info.events) {\n            eventHandlers = {};\n\n            _.forOwn(info.events, (handler, event) => {\n                eventHandlers[event] = loadEventHandler(appModule, name, controllersPath, handler);                    \n            });\n\n            appModule.log('verbose', `[${serviceTag}]Event handlers are attached for namespace \"${name}\".`, {\n                events: Object.keys(eventHandlers)\n            });\n        }\n\n        namespaceChannel.on('connect', function (socket) {\n            let ctx = { appModule, socket };\n\n            socket.on('disconnect', () => {\n                log('verbose', 'namespace disconnect', { \n                    endpoint: endpointPath,\n                    port,\n                    id: socket.id, \n                    namespace: name \n                });\n\n                if (info.onDisconnect) {\n                    loadEventHandler(appModule, name, controllersPath, info.onDisconnect)(ctx).catch(error => log('error', error.message));            \n                }     \n            });\n\n            log('verbose', 'namespace connect', { \n                endpoint: endpointPath,\n                port,\n                id: socket.id, \n                namespace: name \n            });           \n\n            //Register event handlers\n            eventHandlers && _.forOwn(eventHandlers, (handler, event) => {\n                socket.on(event, (data, cb) => handler(ctx, data).then(cb));\n            });                \n\n            if (info.onConnect) {\n                loadEventHandler(appModule, name, controllersPath, info.onConnect)(ctx).catch(error => log('error', error.message));            \n            }            \n        });\n    });\n\n    if (standalone) {\n        io.listen(config.port);\n    }\n\n    appModule.registerService(serviceTag, io);\n\n    return io;\n}\n\nmodule.exports = {\n\n    /**\n     * This feature is loaded at plugin stage\n     * @member {string}\n     */\n    type: Feature.PLUGIN,\n\n    /**\n     * The socket server options.\n     * @typedef {Object} ServerOptions\n     * @property {string} [path=/socket.io] - name of the path to capture\n     * @property {boolean} [serveClient=true] - whether to serve the client files\n     * @property {Adapter} adapter - the adapter to use. Defaults to an instance of the Adapter that ships with socket.io which is memory based. See socket.io-adapter\n     * @property {string} origins - the allowed origins\n     * @property {Parser} parser - the parser to use. Defaults to an instance of the Parser that ships with socket.io. See socket.io-parser\n     * @see {@link https://socket.io/docs/server-api/} for more options\n     */\n\n    /**\n     * Load the rpc Server\n     * @param {AppModule} appModule - The app module object\n     * @param {ServerOptions[]} servers - Rpc server config\n     */\n    load_: (appModule, servers) => {        \n\n        if (Array.isArray(servers)) {\n            return servers.forEach(server => startSocketServer(appModule, server));            \n        }\n\n        let io = startSocketServer(appModule, servers);\n\n        //default socket server\n        appModule.registerService('socketServer', io);\n    }\n};"],"mappings":"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"}