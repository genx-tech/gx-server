"use strict";

require("source-map-support/register");

const {
  Feature
} = require("..").Enums;

const {
  _,
  eachAsync_
} = require("@genx/july");

module.exports = {
  type: Feature.PLUGIN,
  load_: (app, routes) => {
    app.on("after:" + Feature.PLUGIN, waitFor => {
      waitFor.push(eachAsync_(routes, async (routersConfig, route) => {
        if (_.isPlainObject(routersConfig)) {
          return eachAsync_(routersConfig, async (options, type) => {
            let loader_ = require("../routers/" + type);

            app.log("verbose", `A "${type}" router is created at "${route}" in app [${app.name}].`);
            return loader_(app, route, options);
          });
        } else {
          let mainRoute = "/",
              baseRoute = route;
          let pos = route.indexOf(":/");

          if (pos !== -1) {
            mainRoute = route.substring(0, pos + 2);
            baseRoute = route.substring(pos + 1);
          } else if (Array.isArray(routersConfig)) {
            mainRoute = "all:/";
          }

          let rules = {
            [mainRoute]: routersConfig
          };

          let loader_ = require("../routers/rule");

          app.log("verbose", `A "rule" router is created at "${baseRoute}" in app [${app.name}].`);
          return loader_(app, baseRoute, {
            rules: rules
          });
        }
      }));
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcHBGZWF0dXJlcy9yb3V0aW5nLmpzIl0sIm5hbWVzIjpbIkZlYXR1cmUiLCJyZXF1aXJlIiwiRW51bXMiLCJfIiwiZWFjaEFzeW5jXyIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0eXBlIiwiUExVR0lOIiwibG9hZF8iLCJhcHAiLCJyb3V0ZXMiLCJvbiIsIndhaXRGb3IiLCJwdXNoIiwicm91dGVyc0NvbmZpZyIsInJvdXRlIiwiaXNQbGFpbk9iamVjdCIsIm9wdGlvbnMiLCJsb2FkZXJfIiwibG9nIiwibmFtZSIsIm1haW5Sb3V0ZSIsImJhc2VSb3V0ZSIsInBvcyIsImluZGV4T2YiLCJzdWJzdHJpbmciLCJBcnJheSIsImlzQXJyYXkiLCJydWxlcyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFPQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBY0MsT0FBTyxDQUFDLElBQUQsQ0FBUCxDQUFjQyxLQUFsQzs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFvQkgsT0FBTyxDQUFDLFlBQUQsQ0FBakM7O0FBRUFJLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQUtiQyxFQUFBQSxJQUFJLEVBQUVQLE9BQU8sQ0FBQ1EsTUFMRDtBQWFiQyxFQUFBQSxLQUFLLEVBQUUsQ0FBQ0MsR0FBRCxFQUFNQyxNQUFOLEtBQWlCO0FBQ3BCRCxJQUFBQSxHQUFHLENBQUNFLEVBQUosQ0FBTyxXQUFXWixPQUFPLENBQUNRLE1BQTFCLEVBQW1DSyxPQUFELElBQWE7QUFDM0NBLE1BQUFBLE9BQU8sQ0FBQ0MsSUFBUixDQUNJVixVQUFVLENBQUNPLE1BQUQsRUFBUyxPQUFPSSxhQUFQLEVBQXNCQyxLQUF0QixLQUFnQztBQUMvQyxZQUFJYixDQUFDLENBQUNjLGFBQUYsQ0FBZ0JGLGFBQWhCLENBQUosRUFBb0M7QUFDaEMsaUJBQU9YLFVBQVUsQ0FBQ1csYUFBRCxFQUFnQixPQUFPRyxPQUFQLEVBQWdCWCxJQUFoQixLQUF5QjtBQUN0RCxnQkFBSVksT0FBTyxHQUFHbEIsT0FBTyxDQUFDLGdCQUFnQk0sSUFBakIsQ0FBckI7O0FBRUFHLFlBQUFBLEdBQUcsQ0FBQ1UsR0FBSixDQUFRLFNBQVIsRUFBb0IsTUFBS2IsSUFBSywyQkFBMEJTLEtBQU0sYUFBWU4sR0FBRyxDQUFDVyxJQUFLLElBQW5GO0FBRUEsbUJBQU9GLE9BQU8sQ0FBQ1QsR0FBRCxFQUFNTSxLQUFOLEVBQWFFLE9BQWIsQ0FBZDtBQUNILFdBTmdCLENBQWpCO0FBT0gsU0FSRCxNQVFPO0FBRUgsY0FBSUksU0FBUyxHQUFHLEdBQWhCO0FBQUEsY0FDSUMsU0FBUyxHQUFHUCxLQURoQjtBQUVBLGNBQUlRLEdBQUcsR0FBR1IsS0FBSyxDQUFDUyxPQUFOLENBQWMsSUFBZCxDQUFWOztBQUVBLGNBQUlELEdBQUcsS0FBSyxDQUFDLENBQWIsRUFBZ0I7QUFDWkYsWUFBQUEsU0FBUyxHQUFHTixLQUFLLENBQUNVLFNBQU4sQ0FBZ0IsQ0FBaEIsRUFBbUJGLEdBQUcsR0FBRyxDQUF6QixDQUFaO0FBQ0FELFlBQUFBLFNBQVMsR0FBR1AsS0FBSyxDQUFDVSxTQUFOLENBQWdCRixHQUFHLEdBQUcsQ0FBdEIsQ0FBWjtBQUNILFdBSEQsTUFHTyxJQUFJRyxLQUFLLENBQUNDLE9BQU4sQ0FBY2IsYUFBZCxDQUFKLEVBQWtDO0FBRXJDTyxZQUFBQSxTQUFTLEdBQUcsT0FBWjtBQUNIOztBQUVELGNBQUlPLEtBQUssR0FBRztBQUNSLGFBQUNQLFNBQUQsR0FBYVA7QUFETCxXQUFaOztBQUlBLGNBQUlJLE9BQU8sR0FBR2xCLE9BQU8sQ0FBQyxpQkFBRCxDQUFyQjs7QUFDQVMsVUFBQUEsR0FBRyxDQUFDVSxHQUFKLENBQVEsU0FBUixFQUFvQixrQ0FBaUNHLFNBQVUsYUFBWWIsR0FBRyxDQUFDVyxJQUFLLElBQXBGO0FBRUEsaUJBQU9GLE9BQU8sQ0FBQ1QsR0FBRCxFQUFNYSxTQUFOLEVBQWlCO0FBQUVNLFlBQUFBLEtBQUssRUFBRUE7QUFBVCxXQUFqQixDQUFkO0FBQ0g7QUFDSixPQWhDUyxDQURkO0FBbUNILEtBcENEO0FBcUNIO0FBbkRZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbi8qKlxuICogRW5hYmxlIHdlYiByZXF1ZXN0IHJvdXRpbmcuXG4gKiBAbW9kdWxlIEZlYXR1cmVfUm91dGluZ1xuICovXG5cbmNvbnN0IHsgRmVhdHVyZSB9ID0gcmVxdWlyZShcIi4uXCIpLkVudW1zO1xuY29uc3QgeyBfLCBlYWNoQXN5bmNfIH0gPSByZXF1aXJlKFwiQGdlbngvanVseVwiKTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgLyoqXG4gICAgICogVGhpcyBmZWF0dXJlIGlzIGxvYWRlZCBhdCByZWFkeSAoZmluYWwpIHN0YWdlLlxuICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgKi9cbiAgICB0eXBlOiBGZWF0dXJlLlBMVUdJTixcblxuICAgIC8qKlxuICAgICAqIExvYWQgdGhlIGZlYXR1cmUuXG4gICAgICogQHBhcmFtIHtSb3V0YWJsZX0gYXBwIC0gVGhlIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJvdXRlcyAtIFJvdXRlcyBhbmQgY29uZmlndXJhdGlvblxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogKGFwcCwgcm91dGVzKSA9PiB7XG4gICAgICAgIGFwcC5vbihcImFmdGVyOlwiICsgRmVhdHVyZS5QTFVHSU4sICh3YWl0Rm9yKSA9PiB7XG4gICAgICAgICAgICB3YWl0Rm9yLnB1c2goXG4gICAgICAgICAgICAgICAgZWFjaEFzeW5jXyhyb3V0ZXMsIGFzeW5jIChyb3V0ZXJzQ29uZmlnLCByb3V0ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KHJvdXRlcnNDb25maWcpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWFjaEFzeW5jXyhyb3V0ZXJzQ29uZmlnLCBhc3luYyAob3B0aW9ucywgdHlwZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBsb2FkZXJfID0gcmVxdWlyZShcIi4uL3JvdXRlcnMvXCIgKyB0eXBlKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5sb2coXCJ2ZXJib3NlXCIsIGBBIFwiJHt0eXBlfVwiIHJvdXRlciBpcyBjcmVhdGVkIGF0IFwiJHtyb3V0ZX1cIiBpbiBhcHAgWyR7YXBwLm5hbWV9XS5gKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2FkZXJfKGFwcCwgcm91dGUsIG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAncm91dGUnOiAnbWV0aG9kOi9wYXRoJ1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG1haW5Sb3V0ZSA9IFwiL1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhc2VSb3V0ZSA9IHJvdXRlO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBvcyA9IHJvdXRlLmluZGV4T2YoXCI6L1wiKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvcyAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluUm91dGUgPSByb3V0ZS5zdWJzdHJpbmcoMCwgcG9zICsgMik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFzZVJvdXRlID0gcm91dGUuc3Vic3RyaW5nKHBvcyArIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJvdXRlcnNDb25maWcpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9hbGwgaGFuZGxlZCBieSBtaWRkbGV3YXJlIGNoYWluc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW5Sb3V0ZSA9IFwiYWxsOi9cIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJ1bGVzID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFttYWluUm91dGVdOiByb3V0ZXJzQ29uZmlnLFxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGxvYWRlcl8gPSByZXF1aXJlKFwiLi4vcm91dGVycy9ydWxlXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLmxvZyhcInZlcmJvc2VcIiwgYEEgXCJydWxlXCIgcm91dGVyIGlzIGNyZWF0ZWQgYXQgXCIke2Jhc2VSb3V0ZX1cIiBpbiBhcHAgWyR7YXBwLm5hbWV9XS5gKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvYWRlcl8oYXBwLCBiYXNlUm91dGUsIHsgcnVsZXM6IHJ1bGVzIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgIH0sXG59O1xuIl19