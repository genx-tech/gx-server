"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const _ = Util._;
const Promise = Util.Promise;

const Literal = require('../enum/Literal');

const Router = require('@koa/router');

const Controller = require('../patterns/Controller');

const {
  InvalidConfiguration
} = require('../utils/Errors');

const {
  hasMethod
} = require('../utils/Helpers');

module.exports = (app, baseRoute, options) => {
  let resourcePath = path.resolve(app.backendPath, options.resourcesPath || Literal.RESOURCES_PATH);
  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(options.errorOptions, app), 'jsonError');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let resourcesPath = path.join(resourcePath, "**", "*.js");
  let files = Util.glob.sync(resourcesPath, {
    nodir: true
  });

  _.each(files, file => {
    let relPathWoe = path.relative(resourcePath, file).slice(0, -3);
    let baseEndpoint,
        entityName = path.basename(file, '.js');

    if (options.remaps && relPathWoe in options.remaps) {
      baseEndpoint = Util.ensureLeftSlash(Util.trimRightSlash(options.remaps[relPathWoe]));
    } else {
      baseEndpoint = Util.ensureLeftSlash(relPathWoe.split(path.sep).map(p => _.kebabCase(p)).join('/'));
    }

    let idName = _.camelCase(entityName) + 'Id';
    let singleUrl = options.idRegExp ? baseEndpoint + `/:${idName}(${options.idRegExp})` : baseEndpoint + `/:${idName}`;

    let controller = require(file);

    let isObj = false;

    if (controller.prototype instanceof Controller) {
      controller = new controller(app);
      isObj = true;
    }

    if (hasMethod(controller, 'findMany_')) {
      app.addRoute(router, 'get', baseEndpoint, isObj ? controller.findMany_.bind(controller) : controller.findMany_);
    }

    if (hasMethod(controller, 'create_')) {
      app.addRoute(router, 'post', baseEndpoint, isObj ? controller.create_.bind(controller) : controller.create_);
    }

    if (options.withKeyValuePairInPath && hasMethod(controller, 'findOneBy_')) {
      app.addRoute(router, 'get', baseEndpoint + '/:key/:value', isObj ? controller.findOneBy_.bind(controller) : controller.findOneBy_);
    }

    if (hasMethod(controller, 'findOne_')) {
      app.addRoute(router, 'get', singleUrl, isObj ? controller.findOne_.bind(controller) : controller.findOne_);
    }

    if (hasMethod(controller, 'updateOne_')) {
      app.addRoute(router, 'put', singleUrl, isObj ? controller.updateOne_.bind(controller) : controller.updateOne_);
    }

    if (hasMethod(controller, 'deleteOne_')) {
      app.addRoute(router, 'del', singleUrl, isObj ? controller.deleteOne_.bind(controller) : controller.deleteOne_);
    }
  });

  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL3Jlc3QuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJVdGlsIiwiXyIsIlByb21pc2UiLCJMaXRlcmFsIiwiUm91dGVyIiwiQ29udHJvbGxlciIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiaGFzTWV0aG9kIiwibW9kdWxlIiwiZXhwb3J0cyIsImFwcCIsImJhc2VSb3V0ZSIsIm9wdGlvbnMiLCJyZXNvdXJjZVBhdGgiLCJyZXNvbHZlIiwiYmFja2VuZFBhdGgiLCJyZXNvdXJjZXNQYXRoIiwiUkVTT1VSQ0VTX1BBVEgiLCJyb3V0ZXIiLCJwcmVmaXgiLCJ1c2VNaWRkbGV3YXJlIiwiZ2V0TWlkZGxld2FyZUZhY3RvcnkiLCJlcnJvck9wdGlvbnMiLCJtaWRkbGV3YXJlcyIsInVzZU1pZGRsZXdhcmVzIiwiam9pbiIsImZpbGVzIiwiZ2xvYiIsInN5bmMiLCJub2RpciIsImVhY2giLCJmaWxlIiwicmVsUGF0aFdvZSIsInJlbGF0aXZlIiwic2xpY2UiLCJiYXNlRW5kcG9pbnQiLCJlbnRpdHlOYW1lIiwiYmFzZW5hbWUiLCJyZW1hcHMiLCJlbnN1cmVMZWZ0U2xhc2giLCJ0cmltUmlnaHRTbGFzaCIsInNwbGl0Iiwic2VwIiwibWFwIiwicCIsImtlYmFiQ2FzZSIsImlkTmFtZSIsImNhbWVsQ2FzZSIsInNpbmdsZVVybCIsImlkUmVnRXhwIiwiY29udHJvbGxlciIsImlzT2JqIiwicHJvdG90eXBlIiwiYWRkUm91dGUiLCJmaW5kTWFueV8iLCJiaW5kIiwiY3JlYXRlXyIsIndpdGhLZXlWYWx1ZVBhaXJJblBhdGgiLCJmaW5kT25lQnlfIiwiZmluZE9uZV8iLCJ1cGRhdGVPbmVfIiwiZGVsZXRlT25lXyIsImFkZFJvdXRlciJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLFVBQUQsQ0FB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aUIsWUFBWSxHQUFHLGNBQTNDLEVBQTJEZ0IsS0FBSyxHQUFHRCxVQUFVLENBQUNRLFVBQVgsQ0FBc0JILElBQXRCLENBQTJCTCxVQUEzQixDQUFILEdBQTRDQSxVQUFVLENBQUNRLFVBQXZIO0FBQ0g7O0FBRUQsUUFBSW5ELFNBQVMsQ0FBQzJDLFVBQUQsRUFBYSxVQUFiLENBQWIsRUFBdUM7QUFDbkN4QyxNQUFBQSxHQUFHLENBQUMyQyxRQUFKLENBQWFuQyxNQUFiLEVBQXFCLEtBQXJCLEVBQTRCOEIsU0FBNUIsRUFBdUNHLEtBQUssR0FBR0QsVUFBVSxDQUFDUyxRQUFYLENBQW9CSixJQUFwQixDQUF5QkwsVUFBekIsQ0FBSCxHQUEwQ0EsVUFBVSxDQUFDUyxRQUFqRztBQUNIOztBQUVELFFBQUlwRCxTQUFTLENBQUMyQyxVQUFELEVBQWEsWUFBYixDQUFiLEVBQXlDO0FBQ3JDeEMsTUFBQUEsR0FBRyxDQUFDMkMsUUFBSixDQUFhbkMsTUFBYixFQUFxQixLQUFyQixFQUE0QjhCLFNBQTVCLEVBQXVDRyxLQUFLLEdBQUdELFVBQVUsQ0FBQ1UsVUFBWCxDQUFzQkwsSUFBdEIsQ0FBMkJMLFVBQTNCLENBQUgsR0FBNENBLFVBQVUsQ0FBQ1UsVUFBbkc7QUFDSDs7QUFFRCxRQUFJckQsU0FBUyxDQUFDMkMsVUFBRCxFQUFhLFlBQWIsQ0FBYixFQUF5QztBQUNyQ3hDLE1BQUFBLEdBQUcsQ0FBQzJDLFFBQUosQ0FBYW5DLE1BQWIsRUFBcUIsS0FBckIsRUFBNEI4QixTQUE1QixFQUF1Q0csS0FBSyxHQUFHRCxVQUFVLENBQUNXLFVBQVgsQ0FBc0JOLElBQXRCLENBQTJCTCxVQUEzQixDQUFILEdBQTRDQSxVQUFVLENBQUNXLFVBQW5HO0FBQ0g7QUFDSixHQTVDRDs7QUE4Q0FuRCxFQUFBQSxHQUFHLENBQUNvRCxTQUFKLENBQWM1QyxNQUFkO0FBQ0gsQ0E3REQiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgXyA9IFV0aWwuXztcbmNvbnN0IFByb21pc2UgPSBVdGlsLlByb21pc2U7XG5jb25zdCBMaXRlcmFsID0gcmVxdWlyZSgnLi4vZW51bS9MaXRlcmFsJyk7XG5jb25zdCBSb3V0ZXIgPSByZXF1aXJlKCdAa29hL3JvdXRlcicpO1xuY29uc3QgQ29udHJvbGxlciA9IHJlcXVpcmUoJy4uL3BhdHRlcm5zL0NvbnRyb2xsZXInKTtcbmNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24gfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0Vycm9ycycpO1xuY29uc3QgeyBoYXNNZXRob2QgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0hlbHBlcnMnKTtcblxuLyoqXG4gKiBSRVNUZnVsIHJvdXRlci5cbiAqIEBtb2R1bGUgUm91dGVyX1Jlc3RcbiAqL1xuXG4vKipcbiAqIENyZWF0ZSBhIFJFU1RmdWwgcm91dGVyLlxuICogQHBhcmFtIHsqfSBhcHAgXG4gKiBAcGFyYW0ge3N0cmluZ30gYmFzZVJvdXRlIFxuICogQHBhcmFtIHtvYmplY3RzfSBvcHRpb25zIFxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnJlc291cmNlc1BhdGhdXG4gKiBAcHJvcGVydHkge29iamVjdHxhcnJheX0gW29wdGlvbnMubWlkZGxld2FyZXNdXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLndpdGhLZXlWYWx1ZVBhaXJJblBhdGhdXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuaWRSZWdFeHBdXG4gKiBAZXhhbXBsZVxuICogICc8YmFzZSBwYXRoPic6IHtcbiAqICAgICAgcmVzdDoge1xuICogICAgICAgICAgcmVzb3VyY2VzUGF0aDpcbiAqICAgICAgICAgIG1pZGRsZXdhcmVzOlxuICogICAgICB9XG4gKiAgfVxuICogIFxuICogIHJvdXRlICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwIG1ldGhvZCAgICBmdW5jdGlvbiBvZiBjdHJsXG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIGZpbmRNYW55XyBcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgcG9zdCAgICAgICAgICAgY3JlYXRlX1xuICogIC86cmVzb3VyY2UvOnVuaXF1ZS1rZXkvOnZhbHVlICBnZXQgICAgICAgICAgICBmaW5kT25lQnlfXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIGZpbmRPbmVfXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIHB1dCAgICAgICAgICAgIHVwZGF0ZU9uZV9cbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZGVsZXRlICAgICAgICAgZGVsZXRlT25lX1xuICovXG5tb2R1bGUuZXhwb3J0cyA9IChhcHAsIGJhc2VSb3V0ZSwgb3B0aW9ucykgPT4ge1xuICAgIGxldCByZXNvdXJjZVBhdGggPSBwYXRoLnJlc29sdmUoYXBwLmJhY2tlbmRQYXRoLCBvcHRpb25zLnJlc291cmNlc1BhdGggfHwgTGl0ZXJhbC5SRVNPVVJDRVNfUEFUSCk7XG4gICAgXG4gICAgbGV0IHJvdXRlciA9IGJhc2VSb3V0ZSA9PT0gJy8nID8gbmV3IFJvdXRlcigpIDogbmV3IFJvdXRlcih7cHJlZml4OiBiYXNlUm91dGV9KTtcblxuICAgIGFwcC51c2VNaWRkbGV3YXJlKHJvdXRlciwgYXBwLmdldE1pZGRsZXdhcmVGYWN0b3J5KCdqc29uRXJyb3InKShvcHRpb25zLmVycm9yT3B0aW9ucywgYXBwKSwgJ2pzb25FcnJvcicpO1xuXG4gICAgaWYgKG9wdGlvbnMubWlkZGxld2FyZXMpIHtcbiAgICAgICAgYXBwLnVzZU1pZGRsZXdhcmVzKHJvdXRlciwgb3B0aW9ucy5taWRkbGV3YXJlcyk7XG4gICAgfVxuXG4gICAgbGV0IHJlc291cmNlc1BhdGggPSBwYXRoLmpvaW4ocmVzb3VyY2VQYXRoLCBcIioqXCIsIFwiKi5qc1wiKTtcbiAgICBsZXQgZmlsZXMgPSBVdGlsLmdsb2Iuc3luYyhyZXNvdXJjZXNQYXRoLCB7bm9kaXI6IHRydWV9KTtcblxuICAgIF8uZWFjaChmaWxlcywgZmlsZSA9PiB7XG4gICAgICAgIGxldCByZWxQYXRoV29lID0gcGF0aC5yZWxhdGl2ZShyZXNvdXJjZVBhdGgsIGZpbGUpLnNsaWNlKDAsIC0zKTsgICAgICAgICAgXG4gICAgICAgIGxldCBiYXNlRW5kcG9pbnQsIGVudGl0eU5hbWUgPSBwYXRoLmJhc2VuYW1lKGZpbGUsICcuanMnKTtcblxuICAgICAgICBpZiAob3B0aW9ucy5yZW1hcHMgJiYgcmVsUGF0aFdvZSBpbiBvcHRpb25zLnJlbWFwcykge1xuICAgICAgICAgICAgYmFzZUVuZHBvaW50ID0gVXRpbC5lbnN1cmVMZWZ0U2xhc2goVXRpbC50cmltUmlnaHRTbGFzaChvcHRpb25zLnJlbWFwc1tyZWxQYXRoV29lXSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYmFzZUVuZHBvaW50ID0gVXRpbC5lbnN1cmVMZWZ0U2xhc2gocmVsUGF0aFdvZS5zcGxpdChwYXRoLnNlcCkubWFwKHAgPT4gXy5rZWJhYkNhc2UocCkpLmpvaW4oJy8nKSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgaWROYW1lID0gXy5jYW1lbENhc2UoZW50aXR5TmFtZSkgKyAnSWQnO1xuICAgICAgICBsZXQgc2luZ2xlVXJsID0gb3B0aW9ucy5pZFJlZ0V4cCA/IGJhc2VFbmRwb2ludCArIGAvOiR7aWROYW1lfSgke29wdGlvbnMuaWRSZWdFeHB9KWAgOiBiYXNlRW5kcG9pbnQgKyBgLzoke2lkTmFtZX1gOyBcbiAgICAgICAgXG4gICAgICAgIGxldCBjb250cm9sbGVyID0gcmVxdWlyZShmaWxlKTtcbiAgICAgICAgbGV0IGlzT2JqID0gZmFsc2U7XG4gICAgXG4gICAgICAgIGlmIChjb250cm9sbGVyLnByb3RvdHlwZSBpbnN0YW5jZW9mIENvbnRyb2xsZXIpIHtcbiAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBuZXcgY29udHJvbGxlcihhcHApO1xuICAgICAgICAgICAgaXNPYmogPSB0cnVlO1xuICAgICAgICB9ICAgICAgICBcblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdmaW5kTWFueV8nKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIGJhc2VFbmRwb2ludCwgaXNPYmogPyBjb250cm9sbGVyLmZpbmRNYW55Xy5iaW5kKGNvbnRyb2xsZXIpIDogY29udHJvbGxlci5maW5kTWFueV8pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAnY3JlYXRlXycpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncG9zdCcsIGJhc2VFbmRwb2ludCwgaXNPYmogPyBjb250cm9sbGVyLmNyZWF0ZV8uYmluZChjb250cm9sbGVyKSA6IGNvbnRyb2xsZXIuY3JlYXRlXyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3B0aW9ucy53aXRoS2V5VmFsdWVQYWlySW5QYXRoICYmIGhhc01ldGhvZChjb250cm9sbGVyLCAnZmluZE9uZUJ5XycpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgYmFzZUVuZHBvaW50ICsgJy86a2V5Lzp2YWx1ZScsIGlzT2JqID8gY29udHJvbGxlci5maW5kT25lQnlfLmJpbmQoY29udHJvbGxlcikgOiBjb250cm9sbGVyLmZpbmRPbmVCeV8pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAnZmluZE9uZV8nKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIHNpbmdsZVVybCwgaXNPYmogPyBjb250cm9sbGVyLmZpbmRPbmVfLmJpbmQoY29udHJvbGxlcikgOiBjb250cm9sbGVyLmZpbmRPbmVfKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ3VwZGF0ZU9uZV8nKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3B1dCcsIHNpbmdsZVVybCwgaXNPYmogPyBjb250cm9sbGVyLnVwZGF0ZU9uZV8uYmluZChjb250cm9sbGVyKSA6IGNvbnRyb2xsZXIudXBkYXRlT25lXyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdkZWxldGVPbmVfJykpIHtcbiAgICAgICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdkZWwnLCBzaW5nbGVVcmwsIGlzT2JqID8gY29udHJvbGxlci5kZWxldGVPbmVfLmJpbmQoY29udHJvbGxlcikgOiBjb250cm9sbGVyLmRlbGV0ZU9uZV8pO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICBhcHAuYWRkUm91dGVyKHJvdXRlcik7XG59OyJdfQ==