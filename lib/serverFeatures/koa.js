"use strict";

require("source-map-support/register");

const Feature = require('@genx/app/lib/enum/Feature');

const Util = require('rk-utils');

const _ = Util._;
const Promise = Util.Promise;

const validator = require('validator');

const {
  InvalidConfiguration
} = require('../utils/Errors');

module.exports = {
  type: Feature.SERVICE,
  load_: function (server, options) {
    let koa = server.router;
    server.koa = koa;
    koa.env = server.env;
    koa.proxy = options.trustProxy && validator.toBoolean(options.trustProxy);

    if ('subdomainOffset' in options && options.subdomainOffset !== 2) {
      if (options.subdomainOffset < 2) {
        throw new InvalidConfiguration('Invalid subdomainOffset. Should be larger or equal to 2.', appModule, 'koa.subdomainOffset');
      }

      koa.subdomainOffset = options.subdomainOffset;
    }

    if (options.keys) {
      if (!_.isArray(options.keys)) {
        koa.keys = [options.keys];
      } else {
        koa.keys = options.keys;
      }
    }

    koa.on('error', (err, ctx) => {
      let extra = _.pick(err, ['status', 'code', 'info']);

      if (ctx) {
        extra.request = _.pick(ctx, ['method', 'url', 'ip']);
      }

      extra.app = ctx.appModule.name;

      if (err.status && err.status < 500) {
        if (server.env === 'development') {
          extra.stack = err.stack;
        }

        server.log('warn', `[${err.status}] ` + err.message, extra);
        return;
      }

      server.logError(err);
    });
    server.httpServer = require('http').createServer(koa.callback());
    let port = options.httpPort || 2331;
    server.on('ready', () => {
      server.httpServer.listen(port, function (err) {
        if (err) throw err;
        let address = server.httpServer.address();
        let host;

        if (address.family === 'IPv6' && address.address === '::') {
          host = '127.0.0.1';
        } else {
          host = address.address;
        }

        server.host = `${host}:${address.port}`;
        server.port = address.port;
        server.log('info', `A http service is listening on port [${address.port}] ...`);
        server.emit('httpReady');
      });
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXJGZWF0dXJlcy9rb2EuanMiXSwibmFtZXMiOlsiRmVhdHVyZSIsInJlcXVpcmUiLCJVdGlsIiwiXyIsIlByb21pc2UiLCJ2YWxpZGF0b3IiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0eXBlIiwiU0VSVklDRSIsImxvYWRfIiwic2VydmVyIiwib3B0aW9ucyIsImtvYSIsInJvdXRlciIsImVudiIsInByb3h5IiwidHJ1c3RQcm94eSIsInRvQm9vbGVhbiIsInN1YmRvbWFpbk9mZnNldCIsImFwcE1vZHVsZSIsImtleXMiLCJpc0FycmF5Iiwib24iLCJlcnIiLCJjdHgiLCJleHRyYSIsInBpY2siLCJyZXF1ZXN0IiwiYXBwIiwibmFtZSIsInN0YXR1cyIsInN0YWNrIiwibG9nIiwibWVzc2FnZSIsImxvZ0Vycm9yIiwiaHR0cFNlcnZlciIsImNyZWF0ZVNlcnZlciIsImNhbGxiYWNrIiwicG9ydCIsImh0dHBQb3J0IiwibGlzdGVuIiwiYWRkcmVzcyIsImhvc3QiLCJmYW1pbHkiLCJlbWl0Il0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLDRCQUFELENBQXZCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTUUsQ0FBQyxHQUFHRCxJQUFJLENBQUNDLENBQWY7QUFDQSxNQUFNQyxPQUFPLEdBQUdGLElBQUksQ0FBQ0UsT0FBckI7O0FBQ0EsTUFBTUMsU0FBUyxHQUFHSixPQUFPLENBQUMsV0FBRCxDQUF6Qjs7QUFDQSxNQUFNO0FBQUVLLEVBQUFBO0FBQUYsSUFBMkJMLE9BQU8sQ0FBQyxpQkFBRCxDQUF4Qzs7QUFpQkFNLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQU1iQyxFQUFBQSxJQUFJLEVBQUVULE9BQU8sQ0FBQ1UsT0FORDtBQWtCYkMsRUFBQUEsS0FBSyxFQUFFLFVBQVVDLE1BQVYsRUFB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VUFBUCxDQUFrQk0sT0FBbEIsRUFBZDtBQUVBLFlBQUlDLElBQUo7O0FBQ0EsWUFBSUQsT0FBTyxDQUFDRSxNQUFSLEtBQW1CLE1BQW5CLElBQTZCRixPQUFPLENBQUNBLE9BQVIsS0FBb0IsSUFBckQsRUFBMkQ7QUFDdkRDLFVBQUFBLElBQUksR0FBRyxXQUFQO0FBQ0gsU0FGRCxNQUVPO0FBQ0hBLFVBQUFBLElBQUksR0FBR0QsT0FBTyxDQUFDQSxPQUFmO0FBQ0g7O0FBRUQvQixRQUFBQSxNQUFNLENBQUNnQyxJQUFQLEdBQWUsR0FBRUEsSUFBSyxJQUFHRCxPQUFPLENBQUNILElBQUssRUFBdEM7QUFDQTVCLFFBQUFBLE1BQU0sQ0FBQzRCLElBQVAsR0FBY0csT0FBTyxDQUFDSCxJQUF0QjtBQUVBNUIsUUFBQUEsTUFBTSxDQUFDc0IsR0FBUCxDQUFXLE1BQVgsRUFBb0Isd0NBQXVDUyxPQUFPLENBQUNILElBQUssT0FBeEU7QUFLQTVCLFFBQUFBLE1BQU0sQ0FBQ2tDLElBQVAsQ0FBWSxXQUFaO0FBQ0gsT0FyQkQ7QUFzQkgsS0F2QkQ7QUF3Qkg7QUE3RlksQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgRmVhdHVyZSA9IHJlcXVpcmUoJ0BnZW54L2FwcC9saWIvZW51bS9GZWF0dXJlJyk7XG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IF8gPSBVdGlsLl87XG5jb25zdCBQcm9taXNlID0gVXRpbC5Qcm9taXNlO1xuY29uc3QgdmFsaWRhdG9yID0gcmVxdWlyZSgndmFsaWRhdG9yJyk7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uIH0gPSByZXF1aXJlKCcuLi91dGlscy9FcnJvcnMnKTtcblxuLyoqXG4gKiBLb2EgbWlkZGxld2FyZSBmdW5jdGlvblxuICogQGNhbGxiYWNrIEtvYUFjdGlvbkZ1bmN0aW9uXG4gKiBAYXN5bmNcbiAqIEBwYXJhbSB7b2JqZWN0fSBjdHggLSBUaGUga29hIHJlcXVlc3QgYW5kIHJlc3BvbnNlIGNvbnRleHQuIFtTZWUga29hanMgYWJvdXQgY3R4IGRldGFpbHNde0BsaW5rIGh0dHA6Ly9rb2Fqcy5jb20vI2NvbnRleHR9XG4gKiBAcHJvcGVydHkge29iamVjdH0gY3R4LnJlcWV1c3QgLSBUaGUga29hIHJlcXVlc3Qgb2JqZWN0LlxuICogQHByb3BlcnR5IHtvYmplY3R9IGN0eC5yZXNwb25zZSAtIFRoZSBrb2EgcmVzcG9uc2Ugb2JqZWN0LlxuICogQHBhcmFtIHtLb2FBY3Rpb25GdW5jdGlvbn0gW25leHRdIC0gTmV4dCBtaWRkbGV3YXJlIG9yIGFjdGlvbi5cbiAqL1xuXG4vKipcbiAqIEVuYWJsZSBrb2EtYmFzZWQgd2ViIGVuZ2luZS5cbiAqIEBtb2R1bGUgRmVhdHVyZV9Lb2EgXG4gKi9cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IHNlcnZpY2Ugc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5TRVJWSUNFLFxuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7V2ViU2VydmVyfSBzZXJ2ZXIgLSBUaGUgd2ViIHNlcnZlclxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIC0gT3B0aW9ucyBmb3IgdGhlIGZlYXR1cmUgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMudHJ1c3RQcm94eV0gLSBXaGVuIHRydWUgcHJveHkgaGVhZGVyIGZpZWxkcyB3aWxsIGJlIHRydXN0ZWRcbiAgICAgKiBAcHJvcGVydHkge0FycmF5LjxzdHJpbmc+fSBbb3B0aW9ucy5rZXlzXSAtIFNldCBzaWduZWQgY29va2llIGtleXNcbiAgICAgKiBAcHJvcGVydHkge2ludH0gW29wdGlvbnMuaHR0cFBvcnRdIC0gVGhlIGh0dHAgcG9ydCBudW1iZXJcbiAgICAgKiBAcHJvcGVydHkge2ludH0gW29wdGlvbnMuc3ViZG9tYWluT2Zmc2V0PTJdIC0gVGhlIG9mZnNldCBvZiBzdWJkb21haW5zIHRvIGlnbm9yZSwgZGVmYXVsdDogMlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogZnVuY3Rpb24gKHNlcnZlciwgb3B0aW9ucykge1xuICAgICAgICBsZXQga29hID0gc2VydmVyLnJvdXRlcjtcbiAgICAgICAgc2VydmVyLmtvYSA9IGtvYTtcbiAgICAgICAgXG4gICAgICAgIGtvYS5lbnYgPSBzZXJ2ZXIuZW52O1xuICAgICAgICBrb2EucHJveHkgPSBvcHRpb25zLnRydXN0UHJveHkgJiYgdmFsaWRhdG9yLnRvQm9vbGVhbihvcHRpb25zLnRydXN0UHJveHkpO1xuXG4gICAgICAgIGlmICgoJ3N1YmRvbWFpbk9mZnNldCcgaW4gb3B0aW9ucykgJiYgb3B0aW9ucy5zdWJkb21haW5PZmZzZXQgIT09IDIpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnN1YmRvbWFpbk9mZnNldCA8IDIpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgICAgICdJbnZhbGlkIHN1YmRvbWFpbk9mZnNldC4gU2hvdWxkIGJlIGxhcmdlciBvciBlcXVhbCB0byAyLicsXG4gICAgICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICAgICAgJ2tvYS5zdWJkb21haW5PZmZzZXQnXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAga29hLnN1YmRvbWFpbk9mZnNldCA9IG9wdGlvbnMuc3ViZG9tYWluT2Zmc2V0O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9wdGlvbnMua2V5cykge1xuICAgICAgICAgICAgaWYgKCFfLmlzQXJyYXkob3B0aW9ucy5rZXlzKSkge1xuICAgICAgICAgICAgICAgIGtvYS5rZXlzID0gWyBvcHRpb25zLmtleXMgXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAga29hLmtleXMgPSBvcHRpb25zLmtleXM7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBrb2Eub24oJ2Vycm9yJywgKGVyciwgY3R4KSA9PiB7XG4gICAgICAgICAgICBsZXQgZXh0cmEgPSBfLnBpY2soZXJyLCBbICdzdGF0dXMnLCAnY29kZScsICdpbmZvJyBdKTtcblxuICAgICAgICAgICAgaWYgKGN0eCkge1xuICAgICAgICAgICAgICAgIGV4dHJhLnJlcXVlc3QgPSBfLnBpY2soY3R4LCBbJ21ldGhvZCcsICd1cmwnLCAnaXAnXSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGV4dHJhLmFwcCA9IGN0eC5hcHBNb2R1bGUubmFtZTtcblxuICAgICAgICAgICAgaWYgKGVyci5zdGF0dXMgJiYgZXJyLnN0YXR1cyA8IDUwMCkgeyAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoc2VydmVyLmVudiA9PT0gJ2RldmVsb3BtZW50Jykge1xuICAgICAgICAgICAgICAgICAgICBleHRyYS5zdGFjayA9IGVyci5zdGFjaztcbiAgICAgICAgICAgICAgICB9ICAgXG4gICAgICAgICAgICAgICAgc2VydmVyLmxvZygnd2FybicsIGBbJHtlcnIuc3RhdHVzfV0gYCArIGVyci5tZXNzYWdlLCBleHRyYSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfSBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgc2VydmVyLmxvZ0Vycm9yKGVycik7XG4gICAgICAgIH0pOyAgICAgICAgICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIHNlcnZlci5odHRwU2VydmVyID0gcmVxdWlyZSgnaHR0cCcpLmNyZWF0ZVNlcnZlcihrb2EuY2FsbGJhY2soKSk7ICAgICAgICAgICAgICAgIFxuXG4gICAgICAgIGxldCBwb3J0ID0gb3B0aW9ucy5odHRwUG9ydCB8fCAyMzMxO1xuXG4gICAgICAgIHNlcnZlci5vbigncmVhZHknLCAoKSA9PiB7XG4gICAgICAgICAgICBzZXJ2ZXIuaHR0cFNlcnZlci5saXN0ZW4ocG9ydCwgZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHRocm93IGVycjtcblxuICAgICAgICAgICAgICAgIGxldCBhZGRyZXNzID0gc2VydmVyLmh0dHBTZXJ2ZXIuYWRkcmVzcygpO1xuXG4gICAgICAgICAgICAgICAgbGV0IGhvc3Q7XG4gICAgICAgICAgICAgICAgaWYgKGFkZHJlc3MuZmFtaWx5ID09PSAnSVB2NicgJiYgYWRkcmVzcy5hZGRyZXNzID09PSAnOjonKSB7XG4gICAgICAgICAgICAgICAgICAgIGhvc3QgPSAnMTI3LjAuMC4xJztcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBob3N0ID0gYWRkcmVzcy5hZGRyZXNzO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHNlcnZlci5ob3N0ID0gYCR7aG9zdH06JHthZGRyZXNzLnBvcnR9YDtcbiAgICAgICAgICAgICAgICBzZXJ2ZXIucG9ydCA9IGFkZHJlc3MucG9ydDtcblxuICAgICAgICAgICAgICAgIHNlcnZlci5sb2coJ2luZm8nLCBgQSBodHRwIHNlcnZpY2UgaXMgbGlzdGVuaW5nIG9uIHBvcnQgWyR7YWRkcmVzcy5wb3J0fV0gLi4uYCk7XG4gICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICogSHR0cCBzZXJ2ZXIgcmVhZHkgZXZlbnRcbiAgICAgICAgICAgICAgICAgKiBAZXZlbnQgV2ViU2VydmVyI2h0dHBSZWFkeVxuICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgIHNlcnZlci5lbWl0KCdodHRwUmVhZHknKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59OyJdfQ==