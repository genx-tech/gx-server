"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  Promise,
  replaceAll,
  ensureRightSlash,
  trimLeftSlash
} = require('rk-utils');

const {
  Helpers: {
    tryRequire
  }
} = require('@genx/app');

const cachePages = {};
let cacheLayout;
const defaultOpts = {
  cache: false,
  titleHolder: '{{TITLE}}',
  bodyHolder: '{{BODY}}',
  indexName: 'index',
  baseUrl: '/'
};

module.exports = function (options, app) {
  if (!(options && options.root)) {
    throw new Error('options.root required');
  }

  _.defaults(options, defaultOpts);

  options.baseUrl = ensureRightSlash(trimLeftSlash(options.baseUrl));
  options.layout = options.layout || path.join(options.root, 'layout.html');

  if (typeof options.render !== 'function') {
    let md = tryRequire('markdown-it')(options.mdOptions);

    options.render = content => md.render(content);
  }

  const defaultLayout = `
<!DOCTYPE html>
<html>
  <head>
    <title>{{TITLE}}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="https://cdn.staticfile.org/twitter-bootstrap/3.0.0-rc1/css/bootstrap.min.css" rel="stylesheet" media="screen">
  </head>
  <body>
    <div class="container">
    {{BODY}}
    </div>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="https://cdn.staticfile.org/jquery/2.0.3/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.0.0-rc1/js/bootstrap.min.js"></script>

    <!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
    <script src="https://cdn.staticfile.org/respond.js/1.2.0/respond.min.js"></script>
  </body>
</html>
`;
  return async (ctx, next) => {
    if (ctx.method !== 'GET') {
      return next();
    }

    let pathname = trimLeftSlash(ctx.path);

    if (pathname + '/' === options.baseUrl || pathname === options.baseUrl) {
      pathname = options.baseUrl + options.indexName;
    } else if (!pathname.startsWith(options.baseUrl)) {
      return next();
    }

    pathname = pathname.substr(options.baseUrl.length);
    pathname = path.join(options.root, pathname + '.md');
    let html = await getPage(pathname);

    if (html === null) {
      return next();
    }

    ctx.type = 'html';
    ctx.body = html;
  };

  async function getPage(filepath) {
    if (options.cache && filepath in cachePages) {
      return cachePages[filepath];
    }

    let r;

    try {
      r = await Promise.all([getLayout(), getContent(filepath)]);
    } catch (err) {
      if (err.code === 'ENOENT') {
        return null;
      }

      throw err;
    }

    let layout = r[0];
    let content = r[1];
    let html = replaceAll(layout, options.titleHolder, content.title);
    html = replaceAll(html, options.bodyHolder, content.body);

    if (options.cache) {
      cachePages[filepath] = html;
    }

    return html;
  }

  async function getLayout() {
    if (options.cache && cacheLayout) return cacheLayout;
    let layout = (await fs.exists(options.layout)) ? await fs.readFile(options.layout, 'utf8') : defaultLayout;
    if (options.cache) cacheLayout = layout;
    return layout;
  }

  async function getContent(filepath) {
    let content = await fs.readFile(filepath, 'utf8');
    let title = content.slice(0, content.indexOf('\n')).trim().replace(/^[#\s]+/, '');
    let body = options.render(content);
    return {
      title: title,
      body: body
    };
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlcy9tYXJrZG93bi5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsIlByb21pc2UiLCJyZXBsYWNlQWxsIiwiZW5zdXJlUmlnaHRTbGFzaCIsInRyaW1MZWZ0U2xhc2giLCJIZWxwZXJzIiwidHJ5UmVxdWlyZSIsImNhY2hlUGFnZXMiLCJjYWNoZUxheW91dCIsImRlZmF1bHRPcHRzIiwiY2FjaGUiLCJ0aXRsZUhvbGRlciIsImJvZHlIb2xkZXIiLCJpbmRleE5hbWUiLCJiYXNlVXJsIiwibW9kdWxlIiwiZXhwb3J0cyIsIm9wdGlvbnMiLCJhcHAiLCJyb290IiwiZGVmYXVsdHMiLCJsYXlvdXQiLCJqb2luIiwicmVuZGVyIiwibWQiLCJtZE9wdGlvbnMiLCJjb250ZW50IiwiZGVmYXVsdExheW91dCIsImN0eCIsIm5leHQiLCJtZXRob2QiLCJwYXRobmFtZSIsInN0YXJ0c1dpdGgiLCJzdWJzdHIiLCJsZW5ndGgiLCJodG1sIiwiZ2V0UGFnZSIsInR5cGUiLCJib2R5IiwiZmlsZXBhdGgiLCJyIiwiYWxsIiwiZ2V0TGF5b3V0IiwiZ2V0Q29udGVudCIsImVyciIsImNvZGUiLCJ0aXRsZSIsImV4aXN0cyIsInJlYWRGaWxlIiwic2xpY2UiLCJpbmRleE9mIiwidHJpbSIsInJlcGxhY2UiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxFQUFMO0FBQVNDLEVBQUFBLE9BQVQ7QUFBa0JDLEVBQUFBLFVBQWxCO0FBQThCQyxFQUFBQSxnQkFBOUI7QUFBZ0RDLEVBQUFBO0FBQWhELElBQWtFTixPQUFPLENBQUMsVUFBRCxDQUEvRTs7QUFDQSxNQUFNO0FBQUVPLEVBQUFBLE9BQU8sRUFBRTtBQUFFQyxJQUFBQTtBQUFGO0FBQVgsSUFBOEJSLE9BQU8sQ0FBQyxXQUFELENB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QUNQLEtBQVosRUFBbUJGLFdBQVcsR0FBR2EsTUFBZDtBQUNuQixXQUFPQSxNQUFQO0FBQ0Q7O0FBRUQsaUJBQWVzQixVQUFmLENBQTBCSixRQUExQixFQUFvQztBQUNsQyxRQUFJYixPQUFPLEdBQUcsTUFBTTFCLEVBQUUsQ0FBQ2dELFFBQUgsQ0FBWVQsUUFBWixFQUFzQixNQUF0QixDQUFwQjtBQUNBLFFBQUlPLEtBQUssR0FBR3BCLE9BQU8sQ0FBQ3VCLEtBQVIsQ0FBYyxDQUFkLEVBQWlCdkIsT0FBTyxDQUFDd0IsT0FBUixDQUFnQixJQUFoQixDQUFqQixFQUF3Q0MsSUFBeEMsR0FBK0NDLE9BQS9DLENBQXVELFNBQXZELEVBQWtFLEVBQWxFLENBQVo7QUFDQSxRQUFJZCxJQUFJLEdBQUdyQixPQUFPLENBQUNNLE1BQVIsQ0FBZUcsT0FBZixDQUFYO0FBQ0EsV0FBTztBQUNMb0IsTUFBQUEsS0FBSyxFQUFFQSxLQURGO0FBRUxSLE1BQUFBLElBQUksRUFBRUE7QUFGRCxLQUFQO0FBSUQ7QUFDRixDQTNHRCIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IF8sIGZzLCBQcm9taXNlLCByZXBsYWNlQWxsLCBlbnN1cmVSaWdodFNsYXNoLCB0cmltTGVmdFNsYXNoIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBIZWxwZXJzOiB7IHRyeVJlcXVpcmUgfSB9ID0gcmVxdWlyZSgnQGdlbngvYXBwJyk7XG5cbi8qKlxuICogTWFya2Rvd24gbWlkZGxld2FyZS5cbiAqIEBtb2R1bGUgTWlkZGxld2FyZV9NYXJrZG93blxuICovXG5cbmNvbnN0IGNhY2hlUGFnZXMgPSB7fTtcbmxldCBjYWNoZUxheW91dDtcblxuY29uc3QgZGVmYXVsdE9wdHMgPSB7XG4gIGNhY2hlOiBmYWxzZSxcbiAgdGl0bGVIb2xkZXI6ICd7e1RJVExFfX0nLFxuICBib2R5SG9sZGVyOiAne3tCT0RZfX0nLFxuICBpbmRleE5hbWU6ICdpbmRleCcsXG4gIGJhc2VVcmw6ICcvJ1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAob3B0aW9ucywgYXBwKSB7XG4gIGFzc2VydDogb3B0aW9ucyAmJiBvcHRpb25zLnJvb3QsICdvcHRpb25zLnJvb3QgcmVxdWlyZWQnO1xuXG4gIF8uZGVmYXVsdHMob3B0aW9ucywgZGVmYXVsdE9wdHMpO1xuXG4gIG9wdGlvbnMuYmFzZVVybCA9IGVuc3VyZVJpZ2h0U2xhc2godHJpbUxlZnRTbGFzaChvcHRpb25zLmJhc2VVcmwpKTtcbiAgb3B0aW9ucy5sYXlvdXQgPSBvcHRpb25zLmxheW91dCB8fCBwYXRoLmpvaW4ob3B0aW9ucy5yb290LCAnbGF5b3V0Lmh0bWwnKTtcblxuICAvLyBzdXBwb3J0IGN1c3RvbSBtYXJrZG93biByZW5kZXJcbiAgaWYgKHR5cGVvZiBvcHRpb25zLnJlbmRlciAhPT0gJ2Z1bmN0aW9uJykge1xuICAgIGxldCBtZCA9IHRyeVJlcXVpcmUoJ21hcmtkb3duLWl0Jykob3B0aW9ucy5tZE9wdGlvbnMpO1xuICAgIG9wdGlvbnMucmVuZGVyID0gY29udGVudCA9PiBtZC5yZW5kZXIoY29udGVudCk7XG4gIH1cblxuICBjb25zdCBkZWZhdWx0TGF5b3V0ID0gYFxuPCFET0NUWVBFIGh0bWw+XG48aHRtbD5cbiAgPGhlYWQ+XG4gICAgPHRpdGxlPnt7VElUTEV9fTwvdGl0bGU+XG4gICAgPG1ldGEgbmFtZT1cInZpZXdwb3J0XCIgY29udGVudD1cIndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xLjBcIj5cbiAgICA8IS0tIEJvb3RzdHJhcCAtLT5cbiAgICA8bGluayBocmVmPVwiaHR0cHM6Ly9jZG4uc3RhdGljZmlsZS5vcmcvdHdpdHRlci1ib290c3RyYXAvMy4wLjAtcmMxL2Nzcy9ib290c3RyYXAubWluLmNzc1wiIHJlbD1cInN0eWxlc2hlZXRcIiBtZWRpYT1cInNjcmVlblwiPlxuICA8L2hlYWQ+XG4gIDxib2R5PlxuICAgIDxkaXYgY2xhc3M9XCJjb250YWluZXJcIj5cbiAgICB7e0JPRFl9fVxuICAgIDwvZGl2PlxuICAgIDwhLS0gSmF2YVNjcmlwdCBwbHVnaW5zIChyZXF1aXJlcyBqUXVlcnkpIC0tPlxuICAgIDxzY3JpcHQgc3JjPVwiaHR0cHM6Ly9jZG4uc3RhdGljZmlsZS5vcmcvanF1ZXJ5LzIuMC4zL2pxdWVyeS5taW4uanNcIj48L3NjcmlwdD5cbiAgICA8IS0tIEluY2x1ZGUgYWxsIGNvbXBpbGVkIHBsdWdpbnMgKGJlbG93KSwgb3IgaW5jbHVkZSBpbmRpdmlkdWFsIGZpbGVzIGFzIG5lZWRlZCAtLT5cbiAgICA8c2NyaXB0IHNyYz1cImh0dHBzOi8vY2RuLnN0YXRpY2ZpbGUub3JnL3R3aXR0ZXItYm9vdHN0cmFwLzMuMC4wLXJjMS9qcy9ib290c3RyYXAubWluLmpzXCI+PC9zY3JpcHQ+XG5cbiAgICA8IS0tIEVuYWJsZSByZXNwb25zaXZlIGZlYXR1cmVzIGluIElFOCB3aXRoIFJlc3BvbmQuanMgKGh0dHBzOi8vZ2l0aHViLmNvbS9zY290dGplaGwvUmVzcG9uZCkgLS0+XG4gICAgPHNjcmlwdCBzcmM9XCJodHRwczovL2Nkbi5zdGF0aWNmaWxlLm9yZy9yZXNwb25kLmpzLzEuMi4wL3Jlc3BvbmQubWluLmpzXCI+PC9zY3JpcHQ+XG4gIDwvYm9keT5cbjwvaHRtbD5cbmA7XG5cbiAgcmV0dXJuIGFzeW5jIChjdHgsIG5leHQpID0+IHtcbiAgICBpZiAoY3R4Lm1ldGhvZCAhPT0gJ0dFVCcpIHtcbiAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgfVxuXG4gICAgbGV0IHBhdGhuYW1lID0gdHJpbUxlZnRTbGFzaChjdHgucGF0aCk7XG4gICAgLy8gZ2V0IG1kIGZpbGUgcGF0aFxuXG4gICAgLy8gaW5kZXggZmlsZVxuICAgIGlmIChwYXRobmFtZSArICcvJyA9PT0gb3B0aW9ucy5iYXNlVXJsXG4gICAgICB8fCBwYXRobmFtZSA9PT0gb3B0aW9ucy5iYXNlVXJsKSB7XG4gICAgICBwYXRobmFtZSA9IG9wdGlvbnMuYmFzZVVybCArIG9wdGlvbnMuaW5kZXhOYW1lO1xuICAgIH0gZWxzZSBpZiAoIXBhdGhuYW1lLnN0YXJ0c1dpdGgob3B0aW9ucy5iYXNlVXJsKSkge1xuICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgIH1cblxuICAgIHBhdGhuYW1lID0gcGF0aG5hbWUuc3Vic3RyKG9wdGlvbnMuYmFzZVVybC5sZW5ndGgpOyAgICBcbiAgICBwYXRobmFtZSA9IHBhdGguam9pbihvcHRpb25zLnJvb3QsIHBhdGhuYW1lICsgJy5tZCcpO1xuXG4gICAgLy8gZ2VuZXJhdGUgaHRtbFxuICAgIGxldCBodG1sID0gYXdhaXQgZ2V0UGFnZShwYXRobmFtZSk7XG4gICAgaWYgKGh0bWwgPT09IG51bGwpIHsgIFxuICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICB9XG4gICAgY3R4LnR5cGUgPSAnaHRtbCc7XG4gICAgY3R4LmJvZHkgPSBodG1sO1xuICB9O1xuXG4gIGFzeW5jIGZ1bmN0aW9uIGdldFBhZ2UoZmlsZXBhdGgpIHsgICAgICBcbiAgICBpZiAob3B0aW9ucy5jYWNoZSAmJiBmaWxlcGF0aCBpbiBjYWNoZVBhZ2VzKSB7XG4gICAgICByZXR1cm4gY2FjaGVQYWdlc1tmaWxlcGF0aF07XG4gICAgfVxuICAgIGxldCByO1xuICAgIHRyeSB7XG4gICAgICByID0gYXdhaXQgUHJvbWlzZS5hbGwoW2dldExheW91dCgpLCBnZXRDb250ZW50KGZpbGVwYXRoKV0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGVyci5jb2RlID09PSAnRU5PRU5UJykge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICAgIHRocm93IGVycjtcbiAgICB9XG5cbiAgICBsZXQgbGF5b3V0ID0gclswXTtcbiAgICBsZXQgY29udGVudCA9IHJbMV07XG4gICAgbGV0IGh0bWwgPSByZXBsYWNlQWxsKGxheW91dCwgb3B0aW9ucy50aXRsZUhvbGRlciwgY29udGVudC50aXRsZSk7XG4gICAgaHRtbCA9IHJlcGxhY2VBbGwoaHRtbCwgb3B0aW9ucy5ib2R5SG9sZGVyLCBjb250ZW50LmJvZHkpO1xuXG4gICAgaWYgKG9wdGlvbnMuY2FjaGUpIHtcbiAgICAgIGNhY2hlUGFnZXNbZmlsZXBhdGhdID0gaHRtbDtcbiAgICB9XG4gICAgcmV0dXJuIGh0bWw7XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBnZXRMYXlvdXQoKSB7XG4gICAgaWYgKG9wdGlvbnMuY2FjaGUgJiYgY2FjaGVMYXlvdXQpIHJldHVybiBjYWNoZUxheW91dDtcbiAgICBsZXQgbGF5b3V0ID0gKGF3YWl0IGZzLmV4aXN0cyhvcHRpb25zLmxheW91dCkpID8gKGF3YWl0IGZzLnJlYWRGaWxlKG9wdGlvbnMubGF5b3V0LCAndXRmOCcpKSA6IGRlZmF1bHRMYXlvdXQ7XG4gICAgaWYgKG9wdGlvbnMuY2FjaGUpIGNhY2hlTGF5b3V0ID0gbGF5b3V0O1xuICAgIHJldHVybiBsYXlvdXQ7XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBnZXRDb250ZW50KGZpbGVwYXRoKSB7XG4gICAgbGV0IGNvbnRlbnQgPSBhd2FpdCBmcy5yZWFkRmlsZShmaWxlcGF0aCwgJ3V0ZjgnKTtcbiAgICBsZXQgdGl0bGUgPSBjb250ZW50LnNsaWNlKDAsIGNvbnRlbnQuaW5kZXhPZignXFxuJykpLnRyaW0oKS5yZXBsYWNlKC9eWyNcXHNdKy8sICcnKTtcbiAgICBsZXQgYm9keSA9IG9wdGlvbnMucmVuZGVyKGNvbnRlbnQpO1xuICAgIHJldHVybiB7XG4gICAgICB0aXRsZTogdGl0bGUsXG4gICAgICBib2R5OiBib2R5XG4gICAgfTtcbiAgfVxufTtcbiJdfQ==