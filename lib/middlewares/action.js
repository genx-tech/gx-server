"use strict";

require("source-map-support/register");

const path = require('path');

const {
  InvalidConfiguration
} = require('@genx/error');

const Literal = require('../enum/Literal');

module.exports = (controllerAction, app) => {
  if (typeof controllerAction !== 'string') {
    throw new InvalidConfiguration('Invalid action syntax.', app);
  }

  let pos = controllerAction.lastIndexOf('.');

  if (pos < 0) {
    throw new InvalidConfiguration(`Unrecognized controller & action syntax: ${controllerAction}.`, app);
  }

  let controller = controllerAction.substr(0, pos);
  let action = controllerAction.substr(pos + 1);
  let controllerBasePath = path.join(app.backendPath, Literal.CONTROLLERS_PATH);
  let controllerPath = path.resolve(controllerBasePath, controller + '.js');

  let ctrl = require(controllerPath);

  let actioner = ctrl[action];

  if (Array.isArray(actioner)) {
    let actionFunction = actioner.concat().pop();

    if (typeof actionFunction !== 'function') {
      throw new InvalidConfiguration(`${controllerAction} does not contain a valid action in returned middleware chain.`, app);
    }

    return actioner.concat(actionFunction);
  }

  if (typeof actioner !== 'function') {
    throw new InvalidConfiguration(`${controllerAction} is not a valid action.`, app);
  }

  return actioner;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlcy9hY3Rpb24uanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsIkxpdGVyYWwiLCJtb2R1bGUiLCJleHBvcnRzIiwiY29udHJvbGxlckFjdGlvbiIsImFwcCIsInBvcyIsImxhc3RJbmRleE9mIiwiY29udHJvbGxlciIsInN1YnN0ciIsImFjdGlvbiIsImNvbnRyb2xsZXJCYXNlUGF0aCIsImpvaW4iLCJiYWNrZW5kUGF0aCIsIkNPTlRST0xMRVJTX1BBVEgiLCJjb250cm9sbGVyUGF0aCIsInJlc29sdmUiLCJjdHJsIiwiYWN0aW9uZXIiLCJBcnJheSIsImlzQXJyYXkiLCJhY3Rpb25GdW5jdGlvbiIsImNvbmNhdCIsInBvcCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFPQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUEyQkQsT0FBTyxDQUFDLGFBQUQsQ0FBeEM7O0FBQ0EsTUFBTUUsT0FBTyxHQUFHRixPQUFPLENBQUMsaUJBQUQsQ0FBdkI7O0FBT0FHLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQixDQUFDQyxnQkFBRCxFQUFtQkMsR0FBbkIsS0FBMkI7QUFDeEMsTUFBSSxPQUFPRCxnQkFBUCxLQUE0QixRQUFoQyxFQUEwQztBQUN0QyxVQUFNLElBQUlKLG9CQUFKLENBQXlCLHdCQUF6QixFQUFtREssR0FBbkQsQ0FBTjtBQUNIOztBQUVELE1BQUlDLEdBQUcsR0FBR0YsZ0JBQWdCLENBQUNHLFdBQWpCLENBQTZCLEdBQTdCLENBQVY7O0FBQ0EsTUFBSUQsR0FBRyxHQUFHLENBQVYsRUFBYTtBQUNULFVBQU0sSUFBSU4sb0JBQUosQ0FBMEIsNENBQTJDSSxnQkFBaUIsR0FBdEYsRUFBMEZDLEdBQTFGLENBQU47QUFDSDs7QUFFRCxNQUFJRyxVQUFVLEdBQUdKLGdCQUFnQixDQUFDSyxNQUFqQixDQUF3QixDQUF4QixFQUEyQkgsR0FBM0IsQ0FBakI7QUFDQSxNQUFJSSxNQUFNLEdBQUdOLGdCQUFnQixDQUFDSyxNQUFqQixDQUF3QkgsR0FBRyxHQUFHLENBQTlCLENBQWI7QUFDQSxNQUFJSyxrQkFBa0IsR0FBR2IsSUFBSSxDQUFDYyxJQUFMLENBQVVQLEdBQUcsQ0FBQ1EsV0FBZCxFQUEyQlosT0FBTyxDQUFDYSxnQkFBbkMsQ0FBekI7QUFFQSxNQUFJQyxjQUFjLEdBQUdqQixJQUFJLENBQUNrQixPQUFMLENBQWFMLGtCQUFiLEVBQWlDSCxVQUFVLEdBQUcsS0FBOUMsQ0FBckI7O0FBQ0EsTUFBSVMsSUFBSSxHQUFHbEIsT0FBTyxDQUFDZ0IsY0FBRCxDQUFsQjs7QUFFQSxNQUFJRyxRQUFRLEdBQUdELElBQUksQ0FBQ1AsTUFBRCxDQUFuQjs7QUFFQSxNQUFJUyxLQUFLLENBQUNDLE9BQU4sQ0FBY0YsUUFBZCxDQUFKLEVBQTZCO0FBQ3pCLFFBQUlHLGNBQWMsR0FBR0gsUUFBUSxDQUFDSSxNQUFULEdBQWtCQyxHQUFsQixFQUFyQjs7QUFDQSxRQUFJLE9BQU9GLGNBQVAsS0FBMEIsVUFBOUIsRUFBMEM7QUFDdEMsWUFBTSxJQUFJckIsb0JBQUosQ0FBMEIsR0FBRUksZ0JBQWlCLGdFQUE3QyxFQUE4R0MsR0FBOUcsQ0FBTjtBQUNIOztBQUVELFdBQU9hLFFBQVEsQ0FBQ0ksTUFBVCxDQUFnQkQsY0FBaEIsQ0FBUDtBQUNIOztBQUVELE1BQUksT0FBT0gsUUFBUCxLQUFvQixVQUF4QixFQUFvQztBQUNoQyxVQUFNLElBQUlsQixvQkFBSixDQUEwQixHQUFFSSxnQkFBaUIseUJBQTdDLEVBQXVFQyxHQUF2RSxDQUFOO0FBQ0g7O0FBRUQsU0FBT2EsUUFBUDtBQUNILENBakNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbi8qKlxuICogUmVzcG9uc2UgYWN0aW9uIGFzIG1pZGRsZXdhcmVcbiAqIEBtb2R1bGUgTWlkZGxld2FyZV9BY3Rpb25cbiAqL1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiB9ID0gcmVxdWlyZSgnQGdlbngvZXJyb3InKTtcbmNvbnN0IExpdGVyYWwgPSByZXF1aXJlKCcuLi9lbnVtL0xpdGVyYWwnKTtcblxuLyoqXG4gKiBBY3Rpb24gbWlkZGxld2FyZSBjcmVhdG9yXG4gKiBAcGFyYW0ge3N0cmluZ30gY29udHJvbGxlckFjdGlvbiBcbiAqIEBwYXJhbSB7Um91dGFibGV9IGFwcCBcbiAqL1xubW9kdWxlLmV4cG9ydHMgPSAoY29udHJvbGxlckFjdGlvbiwgYXBwKSA9PiB7XG4gICAgaWYgKHR5cGVvZiBjb250cm9sbGVyQWN0aW9uICE9PSAnc3RyaW5nJykge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oJ0ludmFsaWQgYWN0aW9uIHN5bnRheC4nLCBhcHApO1xuICAgIH1cblxuICAgIGxldCBwb3MgPSBjb250cm9sbGVyQWN0aW9uLmxhc3RJbmRleE9mKCcuJyk7XG4gICAgaWYgKHBvcyA8IDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKGBVbnJlY29nbml6ZWQgY29udHJvbGxlciAmIGFjdGlvbiBzeW50YXg6ICR7Y29udHJvbGxlckFjdGlvbn0uYCwgYXBwKTtcbiAgICB9XG5cbiAgICBsZXQgY29udHJvbGxlciA9IGNvbnRyb2xsZXJBY3Rpb24uc3Vic3RyKDAsIHBvcyk7XG4gICAgbGV0IGFjdGlvbiA9IGNvbnRyb2xsZXJBY3Rpb24uc3Vic3RyKHBvcyArIDEpO1xuICAgIGxldCBjb250cm9sbGVyQmFzZVBhdGggPSBwYXRoLmpvaW4oYXBwLmJhY2tlbmRQYXRoLCBMaXRlcmFsLkNPTlRST0xMRVJTX1BBVEgpO1xuXG4gICAgbGV0IGNvbnRyb2xsZXJQYXRoID0gcGF0aC5yZXNvbHZlKGNvbnRyb2xsZXJCYXNlUGF0aCwgY29udHJvbGxlciArICcuanMnKTtcbiAgICBsZXQgY3RybCA9IHJlcXVpcmUoY29udHJvbGxlclBhdGgpOyAgICBcblxuICAgIGxldCBhY3Rpb25lciA9IGN0cmxbYWN0aW9uXTsgICBcblxuICAgIGlmIChBcnJheS5pc0FycmF5KGFjdGlvbmVyKSkge1xuICAgICAgICBsZXQgYWN0aW9uRnVuY3Rpb24gPSBhY3Rpb25lci5jb25jYXQoKS5wb3AoKTtcbiAgICAgICAgaWYgKHR5cGVvZiBhY3Rpb25GdW5jdGlvbiAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKGAke2NvbnRyb2xsZXJBY3Rpb259IGRvZXMgbm90IGNvbnRhaW4gYSB2YWxpZCBhY3Rpb24gaW4gcmV0dXJuZWQgbWlkZGxld2FyZSBjaGFpbi5gLCBhcHApO1xuICAgICAgICB9ICAgIFxuXG4gICAgICAgIHJldHVybiBhY3Rpb25lci5jb25jYXQoYWN0aW9uRnVuY3Rpb24pO1xuICAgIH0gXG5cbiAgICBpZiAodHlwZW9mIGFjdGlvbmVyICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihgJHtjb250cm9sbGVyQWN0aW9ufSBpcyBub3QgYSB2YWxpZCBhY3Rpb24uYCwgYXBwKTtcbiAgICB9ICAgIFxuXG4gICAgcmV0dXJuIGFjdGlvbmVyO1xufTsiXX0=