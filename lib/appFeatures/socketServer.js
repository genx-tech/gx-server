"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  urlJoin,
  ensureLeftSlash
} = require('rk-utils');

const {
  Feature
} = require('..').enum;

const {
  Helpers: {
    tryRequire
  }
} = require('@genx/app');

const SocketServer = tryRequire('socket.io');

const {
  InvalidConfiguration
} = require('../utils/Errors');

const DEFAULT_CONTROLLER_PATH = 'events';

function loadEventHandler(appModule, namespace, controllerBasePath, handlerName, isMiddleware = false) {
  let pos = handlerName.lastIndexOf('.');

  if (pos < 0) {
    if (isMiddleware) {
      throw new InvalidConfiguration(`Invalid middleware reference: ${handlerName}`, appModule, namespace ? `socketServer.routes["${namespace}"].middlewares` : 'socketServer.middlewares');
    } else {
      throw new InvalidConfiguration(`Invalid event handler reference: ${handlerName}`, appModule, `socketServer.routes["${namespace}"].events`);
    }
  }

  let controller = handlerName.substr(0, pos);
  let action = handlerName.substr(pos + 1);
  let controllerPath = path.resolve(controllerBasePath, controller + '.js');

  let ctrl = require(controllerPath);

  let middlewareHandler = ctrl[action];

  if (typeof middlewareHandler !== 'function') {
    if (isMiddleware) {
      throw new InvalidConfiguration(`Middleware function not found: ${handlerName}`, appModule, namespace ? `socketServer.routes["${namespace}"].middlewares` : 'socketServer.middlewares');
    } else {
      throw new InvalidConfiguration(`Event handler function not found: ${handlerName}`, appModule, `socketServer.routes["${namespace}"].events`);
    }
  }

  return middlewareHandler;
}

function startSocketServer(appModule, config) {
  let {
    port,
    logger,
    path: wsPath,
    ...options
  } = config;

  if (logger && typeof logger === 'string') {
    logger = appModule.getService('logger.' + logger);
  }

  function log(...args) {
    logger && logger.log(...args);
  }

  let io,
      standalone = false;
  let endpointPath = wsPath ? urlJoin(appModule.route, wsPath) : appModule.route;
  endpointPath = ensureLeftSlash(endpointPath);
  let serviceTag = port ? `socketServer:${port}${endpointPath}` : `socketServer:${endpointPath}`;

  if (appModule.hasService(serviceTag)) {
    throw new InvalidConfiguration('Socket server path or port conflict.', appModule, `socketServer[${i}].(path|port)`);
  }

  options.path = endpointPath;

  if (port) {
    io = new SocketServer(options);
    standalone = true;
    appModule.log('verbose', `A standalone socket server is listening at [port=${port}, path=${endpointPath}].`);
  } else {
    io = new SocketServer(appModule.server.httpServer, options);
    port = appModule.server.port;
    appModule.log('verbose', `A socket server is listening at [path=${endpointPath}].`);
  }

  io.on('connection', socket => {
    log('info', 'client connect', {
      endpoint: endpointPath,
      port,
      id: socket.id,
      ...socket.handshake
    });
  });
  let controllersPath = path.resolve(appModule.backendPath, config.controllersPath || DEFAULT_CONTROLLER_PATH);

  if (config.middlewares) {
    io.use(loadEventHandler(appModule, null, controllersPath, middlewareName, true));
  }

  if (_.isEmpty(config.routes)) {
    throw new InvalidConfiguration('Missing routes config.', appModule, 'socketServer.routes');
  }

  _.forOwn(config.routes, (info, name) => {
    name = ensureLeftSlash(name);
    let namespaceChannel = io.of(name);

    if (info.middlewares) {
      let m = Array.isArray(info.middlewares) ? info.middlewares : [info.middlewares];
      m.forEach(middlewareName => {
        namespaceChannel.use(loadEventHandler(appModule, name, controllersPath, middlewareName, true));
      });
    }

    let eventHandlers;

    if (info.controller) {
      let rpcControllerPath = path.resolve(controllersPath, info.controller + '.js');
      eventHandlers = require(rpcControllerPath);
      appModule.log('verbose', `[${serviceTag}]Controller "${info.controller}" is attached for namespace "${name}".`);
    }

    if (info.events) {
      eventHandlers = {};

      _.forOwn(info.events, (handler, event) => {
        eventHandlers[event] = loadEventHandler(appModule, name, controllersPath, handler);
      });

      appModule.log('verbose', `[${serviceTag}]Event handlers are attached for namespace "${name}".`, {
        events: Object.keys(eventHandlers)
      });
    }

    if (_.isEmpty(eventHandlers)) {
      throw new InvalidConfiguration('Missing socket response controller or event hooks.', appModule, `socketServer.routes.${name}`);
    }

    namespaceChannel.on('connect', function (socket) {
      socket.on('disconnect', () => {
        log('verbose', 'namespace disconnect', {
          endpoint: endpointPath,
          port,
          id: socket.id,
          namespace: name
        });
      });
      log('verbose', 'namespace connect', {
        endpoint: endpointPath,
        port,
        id: socket.id,
        namespace: name
      });
      let ctx = {
        appModule,
        socket
      };

      for (let event in eventHandlers) {
        let handler = eventHandlers[event];
        socket.on(event, (data, cb) => handler(ctx, data).then(cb));
      }

      if (info.welcome) {
        loadEventHandler(appModule, name, controllersPath, info.welcome)(ctx).catch(error => log('error', error.message));
      }
    });
  });

  if (standalone) {
    io.listen(config.port);
  }

  appModule.registerService(serviceTag, io);
  return io;
}

module.exports = {
  type: Feature.PLUGIN,
  load_: (appModule, servers) => {
    if (Array.isArray(servers)) {
      return servers.forEach(server => startSocketServer(appModule, server));
    }

    let io = startSocketServer(appModule, servers);
    appModule.registerService('socketServer', io);
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcHBGZWF0dXJlcy9zb2NrZXRTZXJ2ZXIuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwidXJsSm9pbiIsImVuc3VyZUxlZnRTbGFzaCIsIkZlYXR1cmUiLCJlbnVtIiwiSGVscGVycyIsInRyeVJlcXVpcmUiLCJTb2NrZXRTZXJ2ZXIiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsIkRFRkFVTFRfQ09OVFJPTExFUl9QQVRIIiwibG9hZEV2ZW50SGFuZGxlciIsImFwcE1vZHVsZSIsIm5hbWVzcGFjZSIsImNvbnRyb2xsZXJCYXNlUGF0aCIsImhhbmRsZXJOYW1lIiwiaXNNaWRkbGV3YXJlIiwicG9zIiwibGFzdEluZGV4T2YiLCJjb250cm9sbGVyIiwic3Vic3RyIiwiYWN0aW9uIiwiY29udHJvbGxlclBhdGgiLCJyZXNvbHZlIiwiY3RybCIsIm1pZGRsZXdhcmVIYW5kbGVyIiwic3RhcnRTb2NrZXRTZXJ2ZXIiLCJjb25maWciLCJwb3J0IiwibG9nZ2VyIiwid3NQYXRoIiwib3B0aW9ucyIsImdldFNlcnZpY2UiLCJsb2ciLCJhcmdzIiwiaW8iLCJzdGFuZGFsb25lIiwiZW5kcG9pbnRQYXRoIiwicm91dGUiLCJzZXJ2aWNlVGFnIiwiaGFzU2VydmljZSIsImkiLCJzZXJ2ZXIiLCJodHRwU2VydmVyIiwib24iLCJzb2NrZXQiLCJlbmRwb2ludCIsImlkIiwiaGFuZHNoYWtlIiwiY29udHJvbGxlcnNQYXRoIiwiYmFja2VuZFBhdGgiLCJtaWRkbGV3YXJlcyIsInVzZSIsIm1pZGRsZXdhcmVOYW1lIiwiaXNFbXB0eSIsInJvdXRlcyIsImZvck93biIsImluZm8iLCJuYW1lIiwibmFtZXNwYWNlQ2hhbm5lbCIsIm9mIiwibSIsIkFycmF5IiwiaXNBcnJheSIsImZvckVhY2giLCJldmVudEhhbmRsZXJzIiwicnBjQ29udHJvbGxlclBhdGgiLCJldmVudHMiLCJoYW5kbGVyIiwiZXZlbnQiLCJPYmplY3QiLCJrZXlzIiwiY3R4IiwiZGF0YSIsImNiIiwidGhlbiIsIndlbGNvbWUiLCJjYXRjaCIsImVycm9yIiwibWVzc2FnZSIsImxpc3RlbiIsInJlZ2lzdGVyU2VydmljZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0eXBlIiwiUExVR0lOIiwibG9hZF8iLCJzZXJ2ZXJzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQVNBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLE9BQUw7QUFBY0MsRUFBQUE7QUFBZCxJQUFrQ0gsT0FBTyxDQUFDLFVBQUQsQ0FBL0M7O0FBQ0EsTUFBTTtBQUFFSSxFQUFBQTtBQUFGLElBQWNKLE9BQU8sQ0FBQyxJQUFELENBQVAsQ0FBY0ssSUFBbEM7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxPQUFPLEVBQUU7QUFBRUMsSUFBQUE7QUFBRjtBQUFYLElBQThCUCxPQUFPLENBQUMsV0FBRCxDQUEzQzs7QUFDQSxNQUFNUSxZQUFZLEdBQUdELFVBQVUsQ0FBQyxXQUFELENBQS9COztBQUNBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUEyQlQsT0FBTyxDQUFDLGlCQUFELENBQXhDOztBQUVBLE1BQU1VLHVCQUF1QixHQUFHLFFBQWhDOztBQUVBLFNBQVNDLGdCQUFULENBQTBCQyxTQUExQixFQUFxQ0MsU0FBckMsRUFBZ0RDLGtCQUFoRCxFQUFvRUMsV0FBcEUsRUFBaUZDLFlBQVksR0FBRyxLQUFoRyxFQUF1RztBQUNuRyxNQUFJQyxHQUFHLEdBQUdGLFdBQVcsQ0FBQ0csV0FBWixDQUF3QixHQUF4QixDQUFWOztBQUNBLE1BQUlELEdBQUcsR0FBRyxDQUFWLEVBQWE7QUFDVCxRQUFJRCxZQUFKLEVBQWtCO0FBQ2QsWUFBTSxJQUFJUCxvQkFBSixDQUNELGlDQUFnQ00sV0FBWSxFQUQzQyxFQUVGSCxTQUZFLEVBR0ZDLFNBQVMsR0FBSSx3QkFBdUJBLFNBQVUsZ0JBQXJDLEdBQXVELDBCQUg5RCxDQUFOO0FBS0gsS0FO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QUFDZCxTQUFELEVBQVk4QixNQUFaLENBQTNDLENBQVA7QUFDSDs7QUFFRCxRQUFJUCxFQUFFLEdBQUdULGlCQUFpQixDQUFDZCxTQUFELEVBQVkyRSxPQUFaLENBQTFCO0FBR0EzRSxJQUFBQSxTQUFTLENBQUNxRSxlQUFWLENBQTBCLGNBQTFCLEVBQTBDOUMsRUFBMUM7QUFDSDtBQWxDWSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKipcbiAqIFNvY2tldCBiYXNlZCBScGMgU2VydmVyXG4gKiBAbW9kdWxlIEZlYXR1cmVfU29ja2V0U2VydmVyXG4gKiBcbiAqIG1pZGRsZXdhcmU6IChwYWNrZXQsIG5leHQpID0+IHt9XG4gKi9cblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgdXJsSm9pbiwgZW5zdXJlTGVmdFNsYXNoIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBGZWF0dXJlIH0gPSByZXF1aXJlKCcuLicpLmVudW07XG5jb25zdCB7IEhlbHBlcnM6IHsgdHJ5UmVxdWlyZSB9IH0gPSByZXF1aXJlKCdAZ2VueC9hcHAnKTtcbmNvbnN0IFNvY2tldFNlcnZlciA9IHRyeVJlcXVpcmUoJ3NvY2tldC5pbycpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvRXJyb3JzJyk7XG5cbmNvbnN0IERFRkFVTFRfQ09OVFJPTExFUl9QQVRIID0gJ2V2ZW50cyc7XG5cbmZ1bmN0aW9uIGxvYWRFdmVudEhhbmRsZXIoYXBwTW9kdWxlLCBuYW1lc3BhY2UsIGNvbnRyb2xsZXJCYXNlUGF0aCwgaGFuZGxlck5hbWUsIGlzTWlkZGxld2FyZSA9IGZhbHNlKSB7XG4gICAgbGV0IHBvcyA9IGhhbmRsZXJOYW1lLmxhc3RJbmRleE9mKCcuJyk7XG4gICAgaWYgKHBvcyA8IDApIHtcbiAgICAgICAgaWYgKGlzTWlkZGxld2FyZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgIGBJbnZhbGlkIG1pZGRsZXdhcmUgcmVmZXJlbmNlOiAke2hhbmRsZXJOYW1lfWAsXG4gICAgICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgICAgIG5hbWVzcGFjZSA/IGBzb2NrZXRTZXJ2ZXIucm91dGVzW1wiJHtuYW1lc3BhY2V9XCJdLm1pZGRsZXdhcmVzYCA6ICdzb2NrZXRTZXJ2ZXIubWlkZGxld2FyZXMnXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgIGBJbnZhbGlkIGV2ZW50IGhhbmRsZXIgcmVmZXJlbmNlOiAke2hhbmRsZXJOYW1lfWAsXG4gICAgICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgICAgIGBzb2NrZXRTZXJ2ZXIucm91dGVzW1wiJHtuYW1lc3BhY2V9XCJdLmV2ZW50c2BcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgY29udHJvbGxlciA9IGhhbmRsZXJOYW1lLnN1YnN0cigwLCBwb3MpO1xuICAgIGxldCBhY3Rpb24gPSBoYW5kbGVyTmFtZS5zdWJzdHIocG9zICsgMSk7XG5cbiAgICBsZXQgY29udHJvbGxlclBhdGggPSBwYXRoLnJlc29sdmUoY29udHJvbGxlckJhc2VQYXRoLCBjb250cm9sbGVyICsgJy5qcycpO1xuICAgIGxldCBjdHJsID0gcmVxdWlyZShjb250cm9sbGVyUGF0aCk7XG4gICAgXG4gICAgbGV0IG1pZGRsZXdhcmVIYW5kbGVyID0gY3RybFthY3Rpb25dO1xuICAgIGlmICh0eXBlb2YgbWlkZGxld2FyZUhhbmRsZXIgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgaWYgKGlzTWlkZGxld2FyZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgIGBNaWRkbGV3YXJlIGZ1bmN0aW9uIG5vdCBmb3VuZDogJHtoYW5kbGVyTmFtZX1gLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICBuYW1lc3BhY2UgPyBgc29ja2V0U2VydmVyLnJvdXRlc1tcIiR7bmFtZXNwYWNlfVwiXS5taWRkbGV3YXJlc2AgOiAnc29ja2V0U2VydmVyLm1pZGRsZXdhcmVzJ1xuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICBgRXZlbnQgaGFuZGxlciBmdW5jdGlvbiBub3QgZm91bmQ6ICR7aGFuZGxlck5hbWV9YCxcbiAgICAgICAgICAgICAgICBhcHBNb2R1bGUsXG4gICAgICAgICAgICAgICAgYHNvY2tldFNlcnZlci5yb3V0ZXNbXCIke25hbWVzcGFjZX1cIl0uZXZlbnRzYFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBtaWRkbGV3YXJlSGFuZGxlcjtcbn1cblxuZnVuY3Rpb24gc3RhcnRTb2NrZXRTZXJ2ZXIoYXBwTW9kdWxlLCBjb25maWcpIHtcbiAgICBsZXQgeyBwb3J0LCBsb2dnZXIsIHBhdGg6IHdzUGF0aCwgLi4ub3B0aW9ucyB9ID0gY29uZmlnO1xuXG4gICAgaWYgKGxvZ2dlciAmJiB0eXBlb2YgbG9nZ2VyID09PSAnc3RyaW5nJykge1xuICAgICAgICBsb2dnZXIgPSBhcHBNb2R1bGUuZ2V0U2VydmljZSgnbG9nZ2VyLicgKyBsb2dnZXIpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGxvZyguLi5hcmdzKSB7XG4gICAgICAgIGxvZ2dlciAmJiBsb2dnZXIubG9nKC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIGxldCBpbywgc3RhbmRhbG9uZSA9IGZhbHNlO1xuXG4gICAgbGV0IGVuZHBvaW50UGF0aCA9IHdzUGF0aCA/IHVybEpvaW4oYXBwTW9kdWxlLnJvdXRlLCB3c1BhdGgpIDogYXBwTW9kdWxlLnJvdXRlO1xuICAgIGVuZHBvaW50UGF0aCA9IGVuc3VyZUxlZnRTbGFzaChlbmRwb2ludFBhdGgpO1xuXG4gICAgbGV0IHNlcnZpY2VUYWcgPSBwb3J0ID8gYHNvY2tldFNlcnZlcjoke3BvcnR9JHtlbmRwb2ludFBhdGh9YCA6IGBzb2NrZXRTZXJ2ZXI6JHtlbmRwb2ludFBhdGh9YDtcblxuICAgIGlmIChhcHBNb2R1bGUuaGFzU2VydmljZShzZXJ2aWNlVGFnKSkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAnU29ja2V0IHNlcnZlciBwYXRoIG9yIHBvcnQgY29uZmxpY3QuJyxcbiAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgIGBzb2NrZXRTZXJ2ZXJbJHtpfV0uKHBhdGh8cG9ydClgXG4gICAgICAgICk7XG4gICAgfSAgICAgICAgICAgIFxuXG4gICAgb3B0aW9ucy5wYXRoID0gZW5kcG9pbnRQYXRoO1xuXG4gICAgaWYgKHBvcnQpIHtcbiAgICAgICAgaW8gPSBuZXcgU29ja2V0U2VydmVyKG9wdGlvbnMpO1xuICAgICAgICBzdGFuZGFsb25lID0gdHJ1ZTtcbiAgICAgICAgYXBwTW9kdWxlLmxvZygndmVyYm9zZScsIGBBIHN0YW5kYWxvbmUgc29ja2V0IHNlcnZlciBpcyBsaXN0ZW5pbmcgYXQgW3BvcnQ9JHtwb3J0fSwgcGF0aD0ke2VuZHBvaW50UGF0aH1dLmApOyAgICAgICAgXG4gICAgfSBlbHNlIHtcbiAgICAgICAgaW8gPSBuZXcgU29ja2V0U2VydmVyKGFwcE1vZHVsZS5zZXJ2ZXIuaHR0cFNlcnZlciwgb3B0aW9ucyk7XG4gICAgICAgIHBvcnQgPSBhcHBNb2R1bGUuc2VydmVyLnBvcnQ7XG4gICAgICAgIGFwcE1vZHVsZS5sb2coJ3ZlcmJvc2UnLCBgQSBzb2NrZXQgc2VydmVyIGlzIGxpc3RlbmluZyBhdCBbcGF0aD0ke2VuZHBvaW50UGF0aH1dLmApOyAgICAgICAgXG4gICAgfVxuXG4gICAgaW8ub24oJ2Nvbm5lY3Rpb24nLCBzb2NrZXQgPT4ge1xuICAgICAgICBsb2coJ2luZm8nLCAnY2xpZW50IGNvbm5lY3QnLCB7XG4gICAgICAgICAgICBlbmRwb2ludDogZW5kcG9pbnRQYXRoLFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIGlkOiBzb2NrZXQuaWQsXG4gICAgICAgICAgICAuLi5zb2NrZXQuaGFuZHNoYWtlXG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgbGV0IGNvbnRyb2xsZXJzUGF0aCA9IHBhdGgucmVzb2x2ZShhcHBNb2R1bGUuYmFja2VuZFBhdGgsIGNvbmZpZy5jb250cm9sbGVyc1BhdGggfHwgREVGQVVMVF9DT05UUk9MTEVSX1BBVEgpO1xuXG4gICAgaWYgKGNvbmZpZy5taWRkbGV3YXJlcykge1xuICAgICAgICBpby51c2UobG9hZEV2ZW50SGFuZGxlcihhcHBNb2R1bGUsIG51bGwsIGNvbnRyb2xsZXJzUGF0aCwgbWlkZGxld2FyZU5hbWUsIHRydWUpKTtcbiAgICB9XG5cbiAgICBpZiAoXy5pc0VtcHR5KGNvbmZpZy5yb3V0ZXMpKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIHJvdXRlcyBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICdzb2NrZXRTZXJ2ZXIucm91dGVzJ1xuICAgICAgICApO1xuICAgIH0gICAgICAgIFxuXG4gICAgXy5mb3JPd24oY29uZmlnLnJvdXRlcywgKGluZm8sIG5hbWUpID0+IHtcbiAgICAgICAgbmFtZSA9IGVuc3VyZUxlZnRTbGFzaChuYW1lKTtcblxuICAgICAgICBsZXQgbmFtZXNwYWNlQ2hhbm5lbCA9IGlvLm9mKG5hbWUpO1xuXG4gICAgICAgIGlmIChpbmZvLm1pZGRsZXdhcmVzKSB7XG4gICAgICAgICAgICBsZXQgbSA9IEFycmF5LmlzQXJyYXkoaW5mby5taWRkbGV3YXJlcykgPyBpbmZvLm1pZGRsZXdhcmVzIDogWyBpbmZvLm1pZGRsZXdhcmVzIF07XG4gICAgICAgICAgICBtLmZvckVhY2gobWlkZGxld2FyZU5hbWUgPT4ge1xuICAgICAgICAgICAgICAgIG5hbWVzcGFjZUNoYW5uZWwudXNlKGxvYWRFdmVudEhhbmRsZXIoYXBwTW9kdWxlLCBuYW1lLCBjb250cm9sbGVyc1BhdGgsIG1pZGRsZXdhcmVOYW1lLCB0cnVlKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBldmVudEhhbmRsZXJzO1xuXG4gICAgICAgIGlmIChpbmZvLmNvbnRyb2xsZXIpIHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgcnBjQ29udHJvbGxlclBhdGggPSBwYXRoLnJlc29sdmUoY29udHJvbGxlcnNQYXRoLCBpbmZvLmNvbnRyb2xsZXIgKyAnLmpzJyk7XG4gICAgICAgICAgICBldmVudEhhbmRsZXJzID0gcmVxdWlyZShycGNDb250cm9sbGVyUGF0aCk7XG5cbiAgICAgICAgICAgIGFwcE1vZHVsZS5sb2coJ3ZlcmJvc2UnLCBgWyR7c2VydmljZVRhZ31dQ29udHJvbGxlciBcIiR7aW5mby5jb250cm9sbGVyfVwiIGlzIGF0dGFjaGVkIGZvciBuYW1lc3BhY2UgXCIke25hbWV9XCIuYCk7XG4gICAgICAgIH0gXG4gICAgICAgIFxuICAgICAgICBpZiAoaW5mby5ldmVudHMpIHtcbiAgICAgICAgICAgIGV2ZW50SGFuZGxlcnMgPSB7fTtcblxuICAgICAgICAgICAgXy5mb3JPd24oaW5mby5ldmVudHMsIChoYW5kbGVyLCBldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGV2ZW50SGFuZGxlcnNbZXZlbnRdID0gbG9hZEV2ZW50SGFuZGxlcihhcHBNb2R1bGUsIG5hbWUsIGNvbnRyb2xsZXJzUGF0aCwgaGFuZGxlcik7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBhcHBNb2R1bGUubG9nKCd2ZXJib3NlJywgYFske3NlcnZpY2VUYWd9XUV2ZW50IGhhbmRsZXJzIGFyZSBhdHRhY2hlZCBmb3IgbmFtZXNwYWNlIFwiJHtuYW1lfVwiLmAsIHtcbiAgICAgICAgICAgICAgICBldmVudHM6IE9iamVjdC5rZXlzKGV2ZW50SGFuZGxlcnMpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChfLmlzRW1wdHkoZXZlbnRIYW5kbGVycykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICAnTWlzc2luZyBzb2NrZXQgcmVzcG9uc2UgY29udHJvbGxlciBvciBldmVudCBob29rcy4nLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICBgc29ja2V0U2VydmVyLnJvdXRlcy4ke25hbWV9YFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG5hbWVzcGFjZUNoYW5uZWwub24oJ2Nvbm5lY3QnLCBmdW5jdGlvbiAoc29ja2V0KSB7XG4gICAgICAgICAgICBzb2NrZXQub24oJ2Rpc2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgbG9nKCd2ZXJib3NlJywgJ25hbWVzcGFjZSBkaXNjb25uZWN0JywgeyBcbiAgICAgICAgICAgICAgICAgICAgZW5kcG9pbnQ6IGVuZHBvaW50UGF0aCxcbiAgICAgICAgICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgICAgICAgICAgaWQ6IHNvY2tldC5pZCwgXG4gICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZTogbmFtZSBcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBsb2coJ3ZlcmJvc2UnLCAnbmFtZXNwYWNlIGNvbm5lY3QnLCB7IFxuICAgICAgICAgICAgICAgIGVuZHBvaW50OiBlbmRwb2ludFBhdGgsXG4gICAgICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgICAgICBpZDogc29ja2V0LmlkLCBcbiAgICAgICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWUgXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbGV0IGN0eCA9IHsgYXBwTW9kdWxlLCBzb2NrZXQgfTtcblxuICAgICAgICAgICAgLy9SZWdpc3RlciBldmVudCBoYW5kbGVyc1xuICAgICAgICAgICAgZm9yIChsZXQgZXZlbnQgaW4gZXZlbnRIYW5kbGVycykge1xuICAgICAgICAgICAgICAgIGxldCBoYW5kbGVyID0gZXZlbnRIYW5kbGVyc1tldmVudF07XG5cbiAgICAgICAgICAgICAgICBzb2NrZXQub24oZXZlbnQsIChkYXRhLCBjYikgPT4gaGFuZGxlcihjdHgsIGRhdGEpLnRoZW4oY2IpKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGlmIChpbmZvLndlbGNvbWUpIHtcbiAgICAgICAgICAgICAgICBsb2FkRXZlbnRIYW5kbGVyKGFwcE1vZHVsZSwgbmFtZSwgY29udHJvbGxlcnNQYXRoLCBpbmZvLndlbGNvbWUpKGN0eCkuY2F0Y2goZXJyb3IgPT4gbG9nKCdlcnJvcicsIGVycm9yLm1lc3NhZ2UpKTsgICAgICAgICAgICBcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpZiAoc3RhbmRhbG9uZSkge1xuICAgICAgICBpby5saXN0ZW4oY29uZmlnLnBvcnQpO1xuICAgIH1cblxuICAgIGFwcE1vZHVsZS5yZWdpc3RlclNlcnZpY2Uoc2VydmljZVRhZywgaW8pO1xuXG4gICAgcmV0dXJuIGlvO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblxuICAgIC8qKlxuICAgICAqIFRoaXMgZmVhdHVyZSBpcyBsb2FkZWQgYXQgcGx1Z2luIHN0YWdlXG4gICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAqL1xuICAgIHR5cGU6IEZlYXR1cmUuUExVR0lOLFxuXG4gICAgLyoqXG4gICAgICogVGhlIHNvY2tldCBzZXJ2ZXIgb3B0aW9ucy5cbiAgICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBTZXJ2ZXJPcHRpb25zXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtwYXRoPS9zb2NrZXQuaW9dIC0gbmFtZSBvZiB0aGUgcGF0aCB0byBjYXB0dXJlXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbc2VydmVDbGllbnQ9dHJ1ZV0gLSB3aGV0aGVyIHRvIHNlcnZlIHRoZSBjbGllbnQgZmlsZXNcbiAgICAgKiBAcHJvcGVydHkge0FkYXB0ZXJ9IGFkYXB0ZXIgLSB0aGUgYWRhcHRlciB0byB1c2UuIERlZmF1bHRzIHRvIGFuIGluc3RhbmNlIG9mIHRoZSBBZGFwdGVyIHRoYXQgc2hpcHMgd2l0aCBzb2NrZXQuaW8gd2hpY2ggaXMgbWVtb3J5IGJhc2VkLiBTZWUgc29ja2V0LmlvLWFkYXB0ZXJcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gb3JpZ2lucyAtIHRoZSBhbGxvd2VkIG9yaWdpbnNcbiAgICAgKiBAcHJvcGVydHkge1BhcnNlcn0gcGFyc2VyIC0gdGhlIHBhcnNlciB0byB1c2UuIERlZmF1bHRzIHRvIGFuIGluc3RhbmNlIG9mIHRoZSBQYXJzZXIgdGhhdCBzaGlwcyB3aXRoIHNvY2tldC5pby4gU2VlIHNvY2tldC5pby1wYXJzZXJcbiAgICAgKiBAc2VlIHtAbGluayBodHRwczovL3NvY2tldC5pby9kb2NzL3NlcnZlci1hcGkvfSBmb3IgbW9yZSBvcHRpb25zXG4gICAgICovXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIHRoZSBycGMgU2VydmVyXG4gICAgICogQHBhcmFtIHtBcHBNb2R1bGV9IGFwcE1vZHVsZSAtIFRoZSBhcHAgbW9kdWxlIG9iamVjdFxuICAgICAqIEBwYXJhbSB7U2VydmVyT3B0aW9uc1tdfSBzZXJ2ZXJzIC0gUnBjIHNlcnZlciBjb25maWdcbiAgICAgKi9cbiAgICBsb2FkXzogKGFwcE1vZHVsZSwgc2VydmVycykgPT4geyAgICAgICAgXG5cbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc2VydmVycykpIHtcbiAgICAgICAgICAgIHJldHVybiBzZXJ2ZXJzLmZvckVhY2goc2VydmVyID0+IHN0YXJ0U29ja2V0U2VydmVyKGFwcE1vZHVsZSwgc2VydmVyKSk7ICAgICAgICAgICAgXG4gICAgICAgIH1cblxuICAgICAgICBsZXQgaW8gPSBzdGFydFNvY2tldFNlcnZlcihhcHBNb2R1bGUsIHNlcnZlcnMpO1xuXG4gICAgICAgIC8vZGVmYXVsdCBzb2NrZXQgc2VydmVyXG4gICAgICAgIGFwcE1vZHVsZS5yZWdpc3RlclNlcnZpY2UoJ3NvY2tldFNlcnZlcicsIGlvKTtcbiAgICB9XG59OyJdfQ==