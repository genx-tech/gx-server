{"version":3,"file":"Controller.js","names":["ApplicationError","require","Controller","constructor","app","_this$app$settings","apiWrapper","getService","settings","apiWrapperService","db","name","tryTtlCache","ctx","key","query","ttlCache","_cache","get","send","deleteTtlCache","del","result","payload","ttlCacheInfo","body","wrapResult","value","push","set","ttl","cache","factory","module","exports"],"sources":["../../src/utils/Controller.js"],"sourcesContent":["const { ApplicationError } = require('@genx/error');\n\nclass Controller {\n    constructor(app) {\n        this.app = app;\n        this.apiWrapper = this.app.getService(this.app.settings?.apiWrapperService || 'apiWrapper');\n\n        if (!this.apiWrapper) {\n            throw new ApplicationError('\"apiWrapper\" service is required when using the Controller helper.');\n        }\n    }\n\n    db(name) {\n        return this.app.db(name || this.app.settings.db);\n    }\n\n    /**\n     * Try to send back data from time-to-live cache\n     * @param {*} ctx \n     * @param {*} key \n     * @returns {boolean} \n     */\n    tryTtlCache(ctx, key) {\n        if (ctx.query['no-cache']) {\n            return false;\n        }\n\n        const ttlCache = this.app.getService('ttlMemCache');\n        if (!ttlCache) {\n            throw new ApplicationError('\"ttlMemCache\" service is required. Please check npm module \"@genx/app-feat-commons\".');\n        }\n\n        const _cache = ttlCache.get(key);\n        if (_cache) {\n            this.send(ctx, ..._cache);\n            return true;\n        }\n        return false;\n    }\n\n    deleteTtlCache(key) {\n        const ttlCache = this.app.getService('ttlMemCache');\n        ttlCache.del(key);\n    }\n\n    send(ctx, result, payload, ttlCacheInfo) {\n        ctx.body = this.apiWrapper.wrapResult(ctx, result, payload);\n        if (ttlCacheInfo) {\n            const ttlCache = this.app.getService('ttlMemCache');\n            const value = [result];\n            if (payload) {\n                value.push(payload);\n            }\n            ttlCache.set(ttlCacheInfo.key, [result, payload], ttlCacheInfo.ttl);\n        }\n    }\n\n    /**\n     * Immutable cache, suitable for long-term unchanged dictionary data\n     * @param {*} key \n     * @param {*} factory \n     * @returns {object}\n     */\n    cache(key, factory) {\n        if (!this._cache) {\n            this._cache = {};\n        }\n\n        let value = this._cache[key];\n        if (value == null) {\n            value = this._cache[key] = factory();\n        }\n\n        return value;\n    }\n}\n\nmodule.exports = Controller;\n"],"mappings":";;;AAAA,MAAM;EAAEA;AAAiB,CAAC,GAAGC,OAAO,CAAC,aAAa,CAAC;AAEnD,MAAMC,UAAU,CAAC;EACbC,WAAWA,CAACC,GAAG,EAAE;IAAA,IAAAC,kBAAA;IACb,IAAI,CAACD,GAAG,GAAGA,GAAG;IACd,IAAI,CAACE,UAAU,GAAG,IAAI,CAACF,GAAG,CAACG,UAAU,CAAC,EAAAF,kBAAA,OAAI,CAACD,GAAG,CAACI,QAAQ,cAAAH,kBAAA,uBAAjBA,kBAAA,CAAmBI,iBAAiB,KAAI,YAAY,CAAC;IAE3F,IAAI,CAAC,IAAI,CAACH,UAAU,EAAE;MAClB,MAAM,IAAIN,gBAAgB,CAAC,oEAAoE,CAAC;IACpG;EACJ;EAEAU,EAAEA,CAACC,IAAI,EAAE;IACL,OAAO,IAAI,CAACP,GAAG,CAACM,EAAE,CAACC,IAAI,IAAI,IAAI,CAACP,GAAG,CAACI,QAAQ,CAACE,EAAE,CAAC;EACpD;EAQAE,WAAWA,CAACC,GAAG,EAAEC,GAAG,EAAE;IAClB,IAAID,GAAG,CAACE,KAAK,CAAC,UAAU,CAAC,EAAE;MACvB,OAAO,KAAK;IAChB;IAEA,MAAMC,QAAQ,GAAG,IAAI,CAACZ,GAAG,CAACG,UAAU,CAAC,aAAa,CAAC;IACnD,IAAI,CAACS,QAAQ,EAAE;MACX,MAAM,IAAIhB,gBAAgB,CAAC,sFAAsF,CAAC;IACtH;IAEA,MAAMiB,MAAM,GAAGD,QAAQ,CAACE,GAAG,CAACJ,GAAG,CAAC;IAChC,IAAIG,MAAM,EAAE;MACR,IAAI,CAACE,IAAI,CAACN,GAAG,EAAE,GAAGI,MAAM,CAAC;MACzB,OAAO,IAAI;IACf;IACA,OAAO,KAAK;EAChB;EAEAG,cAAcA,CAACN,GAAG,EAAE;IAChB,MAAME,QAAQ,GAAG,IAAI,CAACZ,GAAG,CAACG,UAAU,CAAC,aAAa,CAAC;IACnDS,QAAQ,CAACK,GAAG,CAACP,GAAG,CAAC;EACrB;EAEAK,IAAIA,CAACN,GAAG,EAAES,MAAM,EAAEC,OAAO,EAAEC,YAAY,EAAE;IACrCX,GAAG,CAACY,IAAI,GAAG,IAAI,CAACnB,UAAU,CAACoB,UAAU,CAACb,GAAG,EAAES,MAAM,EAAEC,OAAO,CAAC;IAC3D,IAAIC,YAAY,EAAE;MACd,MAAMR,QAAQ,GAAG,IAAI,CAACZ,GAAG,CAACG,UAAU,CAAC,aAAa,CAAC;MACnD,MAAMoB,KAAK,GAAG,CAACL,MAAM,CAAC;MACtB,IAAIC,OAAO,EAAE;QACTI,KAAK,CAACC,IAAI,CAACL,OAAO,CAAC;MACvB;MACAP,QAAQ,CAACa,GAAG,CAACL,YAAY,CAACV,GAAG,EAAE,CAACQ,MAAM,EAAEC,OAAO,CAAC,EAAEC,YAAY,CAACM,GAAG,CAAC;IACvE;EACJ;EAQAC,KAAKA,CAACjB,GAAG,EAAEkB,OAAO,EAAE;IAChB,IAAI,CAAC,IAAI,CAACf,MAAM,EAAE;MACd,IAAI,CAACA,MAAM,GAAG,CAAC,CAAC;IACpB;IAEA,IAAIU,KAAK,GAAG,IAAI,CAACV,MAAM,CAACH,GAAG,CAAC;IAC5B,IAAIa,KAAK,IAAI,IAAI,EAAE;MACfA,KAAK,GAAG,IAAI,CAACV,MAAM,CAACH,GAAG,CAAC,GAAGkB,OAAO,CAAC,CAAC;IACxC;IAEA,OAAOL,KAAK;EAChB;AACJ;AAEAM,MAAM,CAACC,OAAO,GAAGhC,UAAU"}