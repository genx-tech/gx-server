{"version":3,"sources":["../../src/middlewares/accessLog.js"],"names":["InvalidConfiguration","require","requireFeatures","HttpStatus","module","exports","opt","app","logger","getService","ctx","next","startAt","now","info","ip","header","method","url","originalUrl","httpVersion","req","protocol","toUpperCase","status","size","length","referer","userAgent","isoTimestamp","toISO","duration","diff","milliseconds","level","log","getStatusText"],"mappings":"AAAA;;;;AAOA,MAAM;AAAEA,EAAAA;AAAF,IAA2BC,OAAO,CAAC,aAAD,CAAxC;;AACA,MAAM;AAAEC,EAAAA;AAAF,IAAsBD,OAAO,CAAC,kBAAD,CAAnC;;AACA,MAAME,UAAU,GAAGF,OAAO,CAAC,mBAAD,CAA1B;;AAEAG,MAAM,CAACC,OAAP,GAAiB,CAACC,GAAD,EAAMC,GAAN,KAAc;AAC3BL,EAAAA,eAAe,CAAC,CAAE,UAAF,EAAc,SAAd,CAAD,EAA4BK,GAA5B,EAAiC,WAAjC,CAAf;;AAEA,MAAI,CAACD,GAAG,CAACE,MAAT,EAAiB;AACb,UAAM,IAAIR,oBAAJ,CAAyB,oBAAzB,EAA+CO,GAA/C,EAAoD,8BAApD,CAAN;AACH;;AAED,MAAIC,MAAM,GAAGD,GAAG,CAACE,UAAJ,CAAe,YAAYH,GAAG,CAACE,MAA/B,CAAb;;AACA,MAAI,CAACA,MAAL,EAAa;AACT,UAAM,IAAIR,oBAAJ,CAAyB,2BAA2BM,GAAG,CAACE,MAAxD,EAAgED,GAAhE,EAAqE,8BAArE,CAAN;AACH;;AAED,SAAO,OAAOG,GAAP,EAAYC,IAAZ,KAAqB;AACxB,QAAIC,OAAO,GAAGL,GAAG,CAACM,GAAJ,EAAd;AAEA,UAAMF,IAAI,EAAV;AAEA,QAAIG,IAAI,GAAG;AACPC,MAAAA,EAAE,EAAEL,GAAG,CAACM,MAAJ,CAAW,WAAX,KAA2BN,GAAG,CAACK,EAD5B;AAEPE,MAAAA,MAAM,EAAEP,GAAG,CAACO,MAFL;AAGPC,MAAAA,GAAG,EAAER,GAAG,CAACQ,GAHF;AAIPC,MAAAA,WAAW,EAAET,GAAG,CAACS,WAJV;AAKPC,MAAAA,WAAW,EAAEV,GAAG,CAACW,GAAJ,CAAQD,WALd;AAMPE,MAAAA,QAAQ,EAAEZ,GAAG,CAACY,QAAJ,CAAaC,WAAb,EANH;AAOPC,MAAAA,MAAM,EAAEd,GAAG,CAACc,MAPL;AAQPC,MAAAA,IAAI,EAAEf,GAAG,CAACgB,MAAJ,IAAc,GARb;AASPC,MAAAA,OAAO,EAAEjB,GAAG,CAACM,MAAJ,CAAW,SAAX,KAAyB,GAT3B;AAUPY,MAAAA,SAAS,EAAElB,GAAG,CAACM,MAAJ,CAAW,YAAX,KAA4B,GAVhC;AAWPa,MAAAA,YAAY,EAAEjB,OAAO,CAACkB,KAAR,EAXP;AAYPC,MAAAA,QAAQ,EAAExB,GAAG,CAACM,GAAJ,GAAUmB,IAAV,CAAepB,OAAf,EAAwBqB;AAZ3B,KAAX;AAeA,QAAIC,KAAK,GAAG,MAAZ;;AAEA,QAAIxB,GAAG,CAACc,MAAJ,IAAc,GAAlB,EAAuB;AACnBU,MAAAA,KAAK,GAAG,OAAR;AACH,KAFD,MAEO,IAAIxB,GAAG,CAACc,MAAJ,IAAc,GAAlB,EAAuB;AAC1BU,MAAAA,KAAK,GAAG,MAAR;AACH;;AAED1B,IAAAA,MAAM,CAAC2B,GAAP,CAAWD,KAAX,EAAkB/B,UAAU,CAACiC,aAAX,CAAyB1B,GAAG,CAACc,MAA7B,CAAlB,EAAwDV,IAAxD;AACH,GA7BD;AA8BH,CA1CD","sourcesContent":["\"use strict\";\n\n/**\n * Add access log for every http request\n * @module Middleware_AccessLog\n */\n\nconst { InvalidConfiguration } = require('@genx/error');\nconst { requireFeatures } = require('../utils/Helpers');\nconst HttpStatus = require('http-status-codes');\n\nmodule.exports = (opt, app) => {        \n    requireFeatures([ 'timezone', 'loggers' ], app, 'accessLog');    \n\n    if (!opt.logger) {\n        throw new InvalidConfiguration('Missing logger id.', app, 'middlewares.accessLog.logger');\n    }\n\n    let logger = app.getService('logger.' + opt.logger);\n    if (!logger) {\n        throw new InvalidConfiguration('Logger not found. Id: ' + opt.logger, app, 'middlewares.accessLog.logger');\n    }\n\n    return async (ctx, next) => {\n        let startAt = app.now();       \n\n        await next();        \n\n        let info = {\n            ip: ctx.header['x-real-ip'] || ctx.ip,\n            method: ctx.method,\n            url: ctx.url,\n            originalUrl: ctx.originalUrl,           \n            httpVersion: ctx.req.httpVersion,        \n            protocol: ctx.protocol.toUpperCase(),\n            status: ctx.status,\n            size: ctx.length || '-',\n            referer: ctx.header['referer'] || '-',\n            userAgent: ctx.header['user-agent'] || '-',\n            isoTimestamp: startAt.toISO(),        \n            duration: app.now().diff(startAt).milliseconds\n        };\n\n        let level = 'info';\n\n        if (ctx.status >= 500) {\n            level = 'error';\n        } else if (ctx.status >= 400) {\n            level = 'warn';\n        }\n        \n        logger.log(level, HttpStatus.getStatusText(ctx.status), info);\n    };\n};"],"file":"accessLog.js"}