"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  eachAsync_
} = require('rk-utils');

const {
  Feature
} = require('..').enum;

const {
  tryRequire
} = require('@genx/app/lib/utils/Helpers');

const KoaPassport = tryRequire('koa-passport').KoaPassport;

const {
  InvalidConfiguration
} = require('../utils/Errors');

module.exports = {
  type: Feature.SERVICE,
  load_: function (app, config) {
    let passport = new KoaPassport();

    if (_.isEmpty(config) || _.isEmpty(config.strategies)) {
      throw new InvalidConfiguration('Missing passport strategies.', app, 'passport.strategies');
    }

    let initializeMiddleware = passport.initialize(config.init);
    passport.middlewares = config.useSession ? [initializeMiddleware, passport.session()] : initializeMiddleware;
    app.on('before:' + Feature.READY, () => {
      app.useMiddlewares(app.router, passport.middlewares);
    });

    passport.hasStrategy = name => {
      return name in passport._strategies;
    };

    app.registerService('passport', passport);

    if (config.exposeToServer && app !== app.server) {
      app.server.registerService('passport', passport);
    }

    let strategies = Array.isArray(config.strategies) ? config.strategies : [config.strategies];
    return eachAsync_(strategies, async strategy => {
      let strategyScript = path.join(app.backendPath, 'passports', strategy + '.js');

      let strategyInitiator = require(strategyScript);

      return strategyInitiator(app, passport);
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcHBGZWF0dXJlcy9wYXNzcG9ydC5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJlYWNoQXN5bmNfIiwiRmVhdHVyZSIsImVudW0iLCJ0cnlSZXF1aXJlIiwiS29hUGFzc3BvcnQiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0eXBlIiwiU0VSVklDRSIsImxvYWRfIiwiYXBwIiwiY29uZmlnIiwicGFzc3BvcnQiLCJpc0VtcHR5Iiwic3RyYXRlZ2llcyIsImluaXRpYWxpemVNaWRkbGV3YXJlIiwiaW5pdGlhbGl6ZSIsImluaXQiLCJtaWRkbGV3YXJlcyIsInVzZVNlc3Npb24iLCJzZXNzaW9uIiwib24iLCJSRUFEWSIsInVzZU1pZGRsZXdhcmVzIiwicm91dGVyIiwiaGFzU3RyYXRlZ3kiLCJuYW1lIiwiX3N0cmF0ZWdpZXMiLCJyZWdpc3RlclNlcnZpY2UiLCJleHBvc2VUb1NlcnZlciIsInNlcnZlciIsIkFycmF5IiwiaXNBcnJheSIsInN0cmF0ZWd5Iiwic3RyYXRlZ3lTY3JpcHQiLCJqb2luIiwiYmFja2VuZFBhdGgiLCJzdHJhdGVneUluaXRpYXRvciJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFPQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQW9CRixPQUFPLENBQUMsVUFBRCxDQUFqQzs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBO0FBQUYsSUFBY0gsT0FBTyxDQUFDLElBQUQsQ0FBUCxDQUFjSSxJQUFsQzs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBaUJMLE9BQU8sQ0FBQyw2QkFBRCxDQUE5Qjs7QUFDQSxNQUFNTSxXQUFXLEdBQUdELFVBQVUsQ0FBQyxjQUFELENBQVYsQ0FBMkJDLFdBQS9DOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUEyQlAsT0FBTyxDQUFDLGlCQUFELENBQXhDOztBQUVBUSxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFNYkMsRUFBQUEsSUFBSSxFQUFFUCxPQUFPLENBQUNRLE9BTkQ7QUFxQmJDLEVBQUFBLEtBQUssRUFBRSxVQUFVQyxHQUFWLEVBQWVDLE1BQWYsRUFBdUI7QUFDMUIsUUFBSUMsUUFBUSxHQUFHLElBQUlULFdBQUosRUFBZjs7QUFDQSxRQUFJTCxDQUFDLENBQUNlLE9BQUYsQ0FBVUYsTUFBVixLQUFxQmIsQ0FBQyxDQUFDZSxPQUFGLENBQVVGLE1BQU0sQ0FBQ0csVUFBakIsQ0FBekIsRUFBdUQ7QUFDbkQsWUFBTSxJQUFJVixvQkFBSixDQUNGLDhCQURFLEVBRUZNLEdBRkUsRUFHRixxQkFIRSxDQUFOO0FBS0g7O0FBRUQsUUFBSUssb0JBQW9CLEdBQUdILFFBQVEsQ0FBQ0ksVUFBVCxDQUFvQkwsTUFBTSxDQUFDTSxJQUEzQixDQUEzQjtBQUVBTCxJQUFBQSxRQUFRLENBQUNNLFdBQVQsR0FBdUJQLE1BQU0sQ0FBQ1EsVUFBUCxHQUFvQixDQUFFSixvQkFBRixFQUF3QkgsUUFBUSxDQUFDUSxPQUFULEVBQXhCLENBQXBCLEdBQW1FTCxvQkFBMUY7QUFFQUwsSUFBQUEsR0FBRyxDQUFDVyxFQUFKLENBQU8sWUFBWXJCLE9BQU8sQ0FBQ3NCLEtBQTNCLEVBQWtDLE1BQU07QUFDcENaLE1BQUFBLEdBQUcsQ0FBQ2EsY0FBSixDQUFtQmIsR0FBRyxDQUFDYyxNQUF2QixFQUErQlosUUFBUSxDQUFDTSxXQUF4QztBQUNILEtBRkQ7O0FBSUFOLElBQUFBLFFBQVEsQ0FBQ2EsV0FBVCxHQUF3QkMsSUFBRCxJQUFVO0FBQzdCLGFBQU9BLElBQUksSUFBSWQsUUFBUSxDQUFDZSxXQUF4QjtBQUNILEtBRkQ7O0FBSUFqQixJQUFBQSxHQUFHLENBQUNrQixlQUFKLENBQW9CLFVBQXBCLEVBQWdDaEIsUUFBaEM7O0FBRUEsUUFBSUQsTUFBTSxDQUFDa0IsY0FBUCxJQUF5Qm5CLEdBQUcsS0FBS0EsR0FBRyxDQUFDb0IsTUFBekMsRUFBaUQ7QUFDN0NwQixNQUFBQSxHQUFHLENBQUNvQixNQUFKLENBQVdGLGVBQVgsQ0FBMkIsVUFBM0IsRUFBdUNoQixRQUF2QztBQUNIOztBQUVELFFBQUlFLFVBQVUsR0FBR2lCLEtBQUssQ0FBQ0MsT0FBTixDQUFjckIsTUFBTSxDQUFDRyxVQUFyQixJQUFtQ0gsTUFBTSxDQUFDRyxVQUExQyxHQUF1RCxDQUFFSCxNQUFNLENBQUNHLFVBQVQsQ0FBeEU7QUFFQSxXQUFPZixVQUFVLENBQUNlLFVBQUQsRUFBYSxNQUFNbUIsUUFBTixJQUFrQjtBQUM1QyxVQUFJQyxjQUFjLEdBQUd0QyxJQUFJLENBQUN1QyxJQUFMLENBQVV6QixHQUFHLENBQUMwQixXQUFkLEVBQTJCLFdBQTNCLEVBQXdDSCxRQUFRLEdBQUcsS0FBbkQsQ0FBckI7O0FBQ0EsVUFBSUksaUJBQWlCLEdBQUd4QyxPQUFPLENBQUNxQyxjQUFELENBQS9COztBQUNBLGFBQU9HLGlCQUFpQixDQUFDM0IsR0FBRCxFQUFNRSxRQUFOLENBQXhCO0FBQ0gsS0FKZ0IsQ0FBakI7QUFLSDtBQXhEWSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKipcbiAqIEVuYWJsZSBwYXNzcG9ydCBmZWF0dXJlXG4gKiBAbW9kdWxlIEZlYXR1cmVfUGFzc3BvcnRcbiAqL1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCBlYWNoQXN5bmNfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBGZWF0dXJlIH0gPSByZXF1aXJlKCcuLicpLmVudW07XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJ0BnZW54L2FwcC9saWIvdXRpbHMvSGVscGVycycpO1xuY29uc3QgS29hUGFzc3BvcnQgPSB0cnlSZXF1aXJlKCdrb2EtcGFzc3BvcnQnKS5Lb2FQYXNzcG9ydDtcbmNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24gfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0Vycm9ycycpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblxuICAgIC8qKlxuICAgICAqIFRoaXMgZmVhdHVyZSBpcyBsb2FkZWQgYXQgc2VydmljZSBzdGFnZVxuICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgKi9cbiAgICB0eXBlOiBGZWF0dXJlLlNFUlZJQ0UsXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIHRoZSBmZWF0dXJlXG4gICAgICogQHBhcmFtIHtSb3V0YWJsZX0gYXBwIC0gVGhlIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZyAtIFBhc3Nwb3J0IHNldHRpbmdzXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbY29uZmlnLnVzZVNlc3Npb249ZmFsc2VdIC0gVXNlIHNlc3Npb24gb3Igbm90LCBkZWZhdWx0OiBmYWxzZVxuICAgICAqICBcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gY29uZmlnLmluaXQgLSBQYXNzcG9ydCBpbml0aWFsaXphdGlvbiBzZXR0aW5ncyAgICAgXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtjb25maWcuaW5pdC51c2VyUHJvcGVydHk9J3VzZXInXSAtIFVzZXIgcHJvcGVydHkgbmFtZSwgZGVmYXVsdDogdXNlciAgICAgIFxuICAgICAqIFxuICAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IGNvbmZpZy5zdHJhdGVnaWVzIC0gUGFzc3BvcnQgc3RyYXRlZ2llcywgZS5nLiBbICdsb2NhbCcsICdmYWNlYm9vaycgXVxuICAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IGNvbmZpZy5leHBvc2VUb1NlcnZlciAtIEV4cG9zZSB0aGUgcGFzc3BvcnQgc2VydmNpZSB0byB3aGlsZSBzZXJ2ZXJcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48Kj59XG4gICAgICovXG4gICAgbG9hZF86IGZ1bmN0aW9uIChhcHAsIGNvbmZpZykge1xuICAgICAgICBsZXQgcGFzc3BvcnQgPSBuZXcgS29hUGFzc3BvcnQoKTtcbiAgICAgICAgaWYgKF8uaXNFbXB0eShjb25maWcpIHx8IF8uaXNFbXB0eShjb25maWcuc3RyYXRlZ2llcykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICAnTWlzc2luZyBwYXNzcG9ydCBzdHJhdGVnaWVzLicsXG4gICAgICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgICAgICdwYXNzcG9ydC5zdHJhdGVnaWVzJ1xuICAgICAgICAgICAgKTtcbiAgICAgICAgfSAgICAgICAgXG5cbiAgICAgICAgbGV0IGluaXRpYWxpemVNaWRkbGV3YXJlID0gcGFzc3BvcnQuaW5pdGlhbGl6ZShjb25maWcuaW5pdCk7XG5cbiAgICAgICAgcGFzc3BvcnQubWlkZGxld2FyZXMgPSBjb25maWcudXNlU2Vzc2lvbiA/IFsgaW5pdGlhbGl6ZU1pZGRsZXdhcmUsIHBhc3Nwb3J0LnNlc3Npb24oKSBdIDogaW5pdGlhbGl6ZU1pZGRsZXdhcmU7XG5cbiAgICAgICAgYXBwLm9uKCdiZWZvcmU6JyArIEZlYXR1cmUuUkVBRFksICgpID0+IHtcbiAgICAgICAgICAgIGFwcC51c2VNaWRkbGV3YXJlcyhhcHAucm91dGVyLCBwYXNzcG9ydC5taWRkbGV3YXJlcyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHBhc3Nwb3J0Lmhhc1N0cmF0ZWd5ID0gKG5hbWUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuYW1lIGluIHBhc3Nwb3J0Ll9zdHJhdGVnaWVzO1xuICAgICAgICB9O1xuXG4gICAgICAgIGFwcC5yZWdpc3RlclNlcnZpY2UoJ3Bhc3Nwb3J0JywgcGFzc3BvcnQpOyAgICAgICAgXG5cbiAgICAgICAgaWYgKGNvbmZpZy5leHBvc2VUb1NlcnZlciAmJiBhcHAgIT09IGFwcC5zZXJ2ZXIpIHtcbiAgICAgICAgICAgIGFwcC5zZXJ2ZXIucmVnaXN0ZXJTZXJ2aWNlKCdwYXNzcG9ydCcsIHBhc3Nwb3J0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBzdHJhdGVnaWVzID0gQXJyYXkuaXNBcnJheShjb25maWcuc3RyYXRlZ2llcykgPyBjb25maWcuc3RyYXRlZ2llcyA6IFsgY29uZmlnLnN0cmF0ZWdpZXMgXTtcblxuICAgICAgICByZXR1cm4gZWFjaEFzeW5jXyhzdHJhdGVnaWVzLCBhc3luYyBzdHJhdGVneSA9PiB7XG4gICAgICAgICAgICBsZXQgc3RyYXRlZ3lTY3JpcHQgPSBwYXRoLmpvaW4oYXBwLmJhY2tlbmRQYXRoLCAncGFzc3BvcnRzJywgc3RyYXRlZ3kgKyAnLmpzJyk7XG4gICAgICAgICAgICBsZXQgc3RyYXRlZ3lJbml0aWF0b3IgPSByZXF1aXJlKHN0cmF0ZWd5U2NyaXB0KTtcbiAgICAgICAgICAgIHJldHVybiBzdHJhdGVneUluaXRpYXRvcihhcHAsIHBhc3Nwb3J0KTtcbiAgICAgICAgfSk7XG4gICAgfVxufTsiXX0=