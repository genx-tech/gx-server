{"version":3,"file":"middlewareFactory.js","names":["require","_","Feature","Enums","InvalidConfiguration","module","exports","type","INIT","load_","app","factories","forOwn","factoryInfo","name","registerMiddlewareFactory","opt","ownerApp","assert","isEmpty","chains","isPlainObject","options","middleware","push","getMiddlewareFactory","Array","isArray","map","middlewareInfo","i","length","undefined"],"sources":["../../src/appFeatures/middlewareFactory.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Enable middleware factory\n * @module Feature_MiddlewareFactory\n * \n * @example\n *   \"middlewareFactory\": {\n *       //new middleware name\n *       \"listOfMiddleware\": {\n *           \"middleware1\": { // options\n *               ...\n *           },\n *           \"middleware2\": { // options\n *               ...\n *           }\n *       },\n *        \"altListOfMiddleware\": [\n *           {\n *               \"name\": \"middleware1\",\n *               \"options\": { ... } \n *           },\n *           [ \"middleware2\", { ... } ],\n *           \"middleware3\"\n *       ]\n *   },\n */\n\nconst { _ } = require('@genx/july');\nconst { Feature } = require('..').Enums;\nconst { InvalidConfiguration } = require('@genx/error');\n\nmodule.exports = {\n    /**\n     * This feature is loaded at init stage\n     * @member {string}\n     */\n    type: Feature.INIT,\n\n    /**\n     * Load the feature\n     * @param {App} app - The app module object\n     * @param {object} factories - Object factories\n     * @returns {Promise.<*>}\n     */\n    load_: (app, factories) => {\n        _.forOwn(factories, (factoryInfo, name) => {\n            app.registerMiddlewareFactory(name, (opt, ownerApp) => { \n                assert: _.isEmpty(opt), `Pre-configured middleware factory \"${name}\" should be used with empty options.`;\n                let chains;\n\n                if (_.isPlainObject(factoryInfo)) {\n                    chains = [];\n    \n                    _.forOwn(factoryInfo, (options, middleware) => {\n                        chains.push(app.getMiddlewareFactory(middleware)(options, ownerApp));\n                    });                    \n                } else if (Array.isArray(factoryInfo)) {\n                    chains = factoryInfo.map((middlewareInfo, i) => {\n                        if (_.isPlainObject(middlewareInfo)) {\n                            if (!middlewareInfo.name) {\n                                throw new InvalidConfiguration(\n                                    'Missing referenced middleware name.',\n                                    app,\n                                    `middlewareFactory.${name}[${i}].name`);\n                            }\n\n                            return app.getMiddlewareFactory(middlewareInfo.name)(middlewareInfo.options, ownerApp);\n                        }\n\n                        if (Array.isArray(middlewareInfo)) {\n                            if (middlewareInfo.length < 1 || middlewareInfo.length > 2 || typeof middlewareInfo[0] !== 'string') {\n                                throw new InvalidConfiguration(\n                                    'Invalid middleware factory item config.',\n                                    app,\n                                    `middlewareFactory.${name}[${i}]`);\n                            }\n\n                            return app.getMiddlewareFactory(middlewareInfo[0])(middlewareInfo.length > 1 ? middlewareInfo[1] : undefined, ownerApp);\n                        }\n\n                        if (typeof middlewareInfo === 'string') {\n                            return app.getMiddlewareFactory(middlewareInfo)(undefined, ownerApp);\n                        }\n\n                        throw new InvalidConfiguration(\n                            'Invalid middleware factory item config.',\n                            app,\n                            `middlewareFactory.${name}[${i}]`);\n                    });\n                } else {\n                    throw new InvalidConfiguration(\n                        'Invalid middleware factory config.',\n                        app,\n                        `middlewareFactory.${name}`);\n                }\n\n                return chains.length === 1 ? chains[0] : chains;\n            });\n        });\n    }\n};"],"mappings":"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"}