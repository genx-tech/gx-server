{"version":3,"file":"Controller.js","names":["require","Controller","constructor","app","apiWrapper","getService","settings","apiWrapperService","ApplicationError","db","name","tryTtlCache","ctx","key","query","ttlCache","_cache","get","send","deleteTtlCache","del","result","payload","ttlCacheInfo","body","wrapResult","value","push","set","ttl","cache","factory","module","exports"],"sources":["../../src/utils/Controller.js"],"sourcesContent":["const {  } = require('@genx/error');\n\nclass Controller {\n    constructor(app) {\n        this.app = app;\n        this.apiWrapper = this.app.getService(this.app.settings?.apiWrapperService || 'apiWrapper');\n\n        if (!this.apiWrapper) {\n            throw new ApplicationError('\"apiWrapper\" service is required when using the Controller helper.');\n        }\n    }\n\n    db(name) {\n        return this.app.db(name || this.app.settings.db);\n    }\n\n    /**\n     * Time-to-live cache\n     * @param {*} ctx \n     * @param {*} key \n     * @returns \n     */\n    tryTtlCache(ctx, key) {\n        if (ctx.query['no-cache']) {\n            return false;\n        }\n\n        const ttlCache = this.app.getService('ttlMemCache');\n        if (!ttlCache) {\n            throw new ApplicationError('\"ttlMemCache\" service is required. Please check npm module \"@genx/app-feat-commons\".');\n        }\n\n        const _cache = ttlCache.get(key);\n        if (_cache) {\n            this.send(ctx, ..._cache);\n            return true;\n        }\n        return false;\n    }\n\n    deleteTtlCache(key) {\n        const ttlCache = this.app.getService('ttlMemCache');\n        ttlCache.del(key);\n    }\n\n    send(ctx, result, payload, ttlCacheInfo) {\n        ctx.body = this.apiWrapper.wrapResult(ctx, result, payload);\n        if (ttlCacheInfo) {\n            const ttlCache = this.app.getService('ttlMemCache');\n            const value = [result];\n            if (payload) {\n                value.push(payload);\n            }\n            ttlCache.set(ttlCacheInfo.key, [result, payload], ttlCacheInfo.ttl);\n        }\n    }\n\n    /**\n     * Immutable cache, suitable for long-term unchanged dictionary data\n     * @param {*} key \n     * @param {*} factory \n     * @returns \n     */\n    cache(key, factory) {\n        if (!this._cache) {\n            this._cache = {};\n        }\n\n        let value = this._cache[key];\n        if (value == null) {\n            value = this._cache[key] = factory();\n        }\n\n        return value;\n    }\n}\n\nmodule.exports = Controller;\n"],"mappings":";;;;AAAA,MAAM,KAAOA,OAAO,CAAC,aAAD,CAApB;;AAEA,MAAMC,UAAN,CAAiB;EACbC,WAAW,CAACC,GAAD,EAAM;IAAA;;IACb,KAAKA,GAAL,GAAWA,GAAX;IACA,KAAKC,UAAL,GAAkB,KAAKD,GAAL,CAASE,UAAT,CAAoB,4BAAKF,GAAL,CAASG,QAAT,0EAAmBC,iBAAnB,KAAwC,YAA5D,CAAlB;;IAEA,IAAI,CAAC,KAAKH,UAAV,EAAsB;MAClB,MAAM,IAAII,gBAAJ,CAAqB,oEAArB,CAAN;IACH;EACJ;;EAEDC,EAAE,CAACC,IAAD,EAAO;IACL,OAAO,KAAKP,GAAL,CAASM,EAAT,CAAYC,IAAI,IAAI,KAAKP,GAAL,CAASG,QAAT,CAAkBG,EAAtC,CAAP;EACH;;EAQDE,WAAW,CAACC,GAAD,EAAMC,GAAN,EAAW;IAClB,IAAID,GAAG,CAACE,KAAJ,CAAU,UAAV,CAAJ,EAA2B;MACvB,OAAO,KAAP;IACH;;IAED,MAAMC,QAAQ,GAAG,KAAKZ,GAAL,CAASE,UAAT,CAAoB,aAApB,CAAjB;;IACA,IAAI,CAACU,QAAL,EAAe;MACX,MAAM,IAAIP,gBAAJ,CAAqB,sFAArB,CAAN;IACH;;IAED,MAAMQ,MAAM,GAAGD,QAAQ,CAACE,GAAT,CAAaJ,GAAb,CAAf;;IACA,IAAIG,MAAJ,EAAY;MACR,KAAKE,IAAL,CAAUN,GAAV,EAAe,GAAGI,MAAlB;MACA,OAAO,IAAP;IACH;;IACD,OAAO,KAAP;EACH;;EAEDG,cAAc,CAACN,GAAD,EAAM;IAChB,MAAME,QAAQ,GAAG,KAAKZ,GAAL,CAASE,UAAT,CAAoB,aAApB,CAAjB;IACAU,QAAQ,CAACK,GAAT,CAAaP,GAAb;EACH;;EAEDK,IAAI,CAACN,GAAD,EAAMS,MAAN,EAAcC,OAAd,EAAuBC,YAAvB,EAAqC;IACrCX,GAAG,CAACY,IAAJ,GAAW,KAAKpB,UAAL,CAAgBqB,UAAhB,CAA2Bb,GAA3B,EAAgCS,MAAhC,EAAwCC,OAAxC,CAAX;;IACA,IAAIC,YAAJ,EAAkB;MACd,MAAMR,QAAQ,GAAG,KAAKZ,GAAL,CAASE,UAAT,CAAoB,aAApB,CAAjB;MACA,MAAMqB,KAAK,GAAG,CAACL,MAAD,CAAd;;MACA,IAAIC,OAAJ,EAAa;QACTI,KAAK,CAACC,IAAN,CAAWL,OAAX;MACH;;MACDP,QAAQ,CAACa,GAAT,CAAaL,YAAY,CAACV,GAA1B,EAA+B,CAACQ,MAAD,EAASC,OAAT,CAA/B,EAAkDC,YAAY,CAACM,GAA/D;IACH;EACJ;;EAQDC,KAAK,CAACjB,GAAD,EAAMkB,OAAN,EAAe;IAChB,IAAI,CAAC,KAAKf,MAAV,EAAkB;MACd,KAAKA,MAAL,GAAc,EAAd;IACH;;IAED,IAAIU,KAAK,GAAG,KAAKV,MAAL,CAAYH,GAAZ,CAAZ;;IACA,IAAIa,KAAK,IAAI,IAAb,EAAmB;MACfA,KAAK,GAAG,KAAKV,MAAL,CAAYH,GAAZ,IAAmBkB,OAAO,EAAlC;IACH;;IAED,OAAOL,KAAP;EACH;;AAxEY;;AA2EjBM,MAAM,CAACC,OAAP,GAAiBhC,UAAjB"}