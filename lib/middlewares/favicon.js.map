{"version":3,"file":"favicon.js","names":["_","require","fs","path","HttpCode","InvalidConfiguration","favicon","options","app","isString","faviconPath","toAbsolutePath","join","publicPath","existsSync","icon","maxAge","Math","min","max","cacheControl","ctx","next","method","stats","stat","size","log","throw","NOT_FOUND","readFile","set","type","body","module","exports"],"sources":["../../src/middlewares/favicon.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Middleware to serve favicon request.\n * @module Middleware_Favicon\n */\n\nconst { _ } = require('@genx/july');\nconst { fs } = require('@genx/sys');\nconst path = require('path');\nconst { HttpCode, InvalidConfiguration } = require('@genx/error');\n\nlet favicon = (options, app) => {\n    if (_.isString(options)) {\n        options = { path: options };\n    } \n    \n    let faviconPath = options && options.path && app.toAbsolutePath(options.path) || path.join(app.publicPath, 'favicon.ico');\n    if (!fs.existsSync(faviconPath)) {\n        throw new InvalidConfiguration(\n            `Favicon path \"${faviconPath}\" not exists.`,\n            app,\n            'middlewares.favicon'\n        );\n    }   \n\n    let icon;\n    const maxAge = options.maxAge == null\n        ? 86400000\n        : Math.min(Math.max(0, options.maxAge), 31556926000);\n    const cacheControl = `public, max-age=${maxAge / 1000 | 0}`;\n\n    return async (ctx, next) => {\n        if ('/favicon.ico' !== ctx.path || ('GET' !== ctx.method && 'HEAD' !== ctx.method)) {\n            return next();\n        }\n\n        if (!icon) {\n            let stats = await fs.stat(faviconPath);\n            //maximum 1M\n            if (stats.size > 1048576) {\n                app.log('warn', 'favicon.ico too large.', stats);\n                ctx.throw(HttpCode.NOT_FOUND);                \n            }\n            \n            icon = await fs.readFile(faviconPath);\n        }\n        ctx.set('Cache-Control', cacheControl);\n        ctx.type = 'image/x-icon';\n        ctx.body = icon;\n    };\n};\n\nmodule.exports = favicon;"],"mappings":"AAAA;;;;AAOA,MAAM;EAAEA;AAAF,IAAQC,OAAO,CAAC,YAAD,CAArB;;AACA,MAAM;EAAEC;AAAF,IAASD,OAAO,CAAC,WAAD,CAAtB;;AACA,MAAME,IAAI,GAAGF,OAAO,CAAC,MAAD,CAApB;;AACA,MAAM;EAAEG,QAAF;EAAYC;AAAZ,IAAqCJ,OAAO,CAAC,aAAD,CAAlD;;AAEA,IAAIK,OAAO,GAAG,CAACC,OAAD,EAAUC,GAAV,KAAkB;EAC5B,IAAIR,CAAC,CAACS,QAAF,CAAWF,OAAX,CAAJ,EAAyB;IACrBA,OAAO,GAAG;MAAEJ,IAAI,EAAEI;IAAR,CAAV;EACH;;EAED,IAAIG,WAAW,GAAGH,OAAO,IAAIA,OAAO,CAACJ,IAAnB,IAA2BK,GAAG,CAACG,cAAJ,CAAmBJ,OAAO,CAACJ,IAA3B,CAA3B,IAA+DA,IAAI,CAACS,IAAL,CAAUJ,GAAG,CAACK,UAAd,EAA0B,aAA1B,CAAjF;;EACA,IAAI,CAACX,EAAE,CAACY,UAAH,CAAcJ,WAAd,CAAL,EAAiC;IAC7B,MAAM,IAAIL,oBAAJ,CACD,iBAAgBK,WAAY,eAD3B,EAEFF,GAFE,EAGF,qBAHE,CAAN;EAKH;;EAED,IAAIO,IAAJ;EACA,MAAMC,MAAM,GAAGT,OAAO,CAACS,MAAR,IAAkB,IAAlB,GACT,QADS,GAETC,IAAI,CAACC,GAAL,CAASD,IAAI,CAACE,GAAL,CAAS,CAAT,EAAYZ,OAAO,CAACS,MAApB,CAAT,EAAsC,WAAtC,CAFN;EAGA,MAAMI,YAAY,GAAI,mBAAkBJ,MAAM,GAAG,IAAT,GAAgB,CAAE,EAA1D;EAEA,OAAO,OAAOK,GAAP,EAAYC,IAAZ,KAAqB;IACxB,IAAI,mBAAmBD,GAAG,CAAClB,IAAvB,IAAgC,UAAUkB,GAAG,CAACE,MAAd,IAAwB,WAAWF,GAAG,CAACE,MAA3E,EAAoF;MAChF,OAAOD,IAAI,EAAX;IACH;;IAED,IAAI,CAACP,IAAL,EAAW;MACP,IAAIS,KAAK,GAAG,MAAMtB,EAAE,CAACuB,IAAH,CAAQf,WAAR,CAAlB;;MAEA,IAAIc,KAAK,CAACE,IAAN,GAAa,OAAjB,EAA0B;QACtBlB,GAAG,CAACmB,GAAJ,CAAQ,MAAR,EAAgB,wBAAhB,EAA0CH,KAA1C;QACAH,GAAG,CAACO,KAAJ,CAAUxB,QAAQ,CAACyB,SAAnB;MACH;;MAEDd,IAAI,GAAG,MAAMb,EAAE,CAAC4B,QAAH,CAAYpB,WAAZ,CAAb;IACH;;IACDW,GAAG,CAACU,GAAJ,CAAQ,eAAR,EAAyBX,YAAzB;IACAC,GAAG,CAACW,IAAJ,GAAW,cAAX;IACAX,GAAG,CAACY,IAAJ,GAAWlB,IAAX;EACH,CAlBD;AAmBH,CAvCD;;AAyCAmB,MAAM,CAACC,OAAP,GAAiB7B,OAAjB"}