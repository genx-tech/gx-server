"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const _ = Util._;
const fs = Util.fs;

const path = require('path');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration
} = require('@genx/error');

let favicon = (options, app) => {
  if (_.isString(options)) {
    options = {
      path: options
    };
  }

  let faviconPath = options && options.path && app.toAbsolutePath(options.path) || path.join(app.publicPath, 'favicon.ico');

  if (!fs.existsSync(faviconPath)) {
    throw new InvalidConfiguration(`Favicon path "${faviconPath}" not exists.`, app, 'middlewares.favicon');
  }

  let icon;
  const maxAge = options.maxAge == null ? 86400000 : Math.min(Math.max(0, options.maxAge), 31556926000);
  const cacheControl = `public, max-age=${maxAge / 1000 | 0}`;
  return async (ctx, next) => {
    if ('/favicon.ico' !== ctx.path || 'GET' !== ctx.method && 'HEAD' !== ctx.method) {
      return next();
    }

    if (!icon) {
      let stats = await fs.stat(faviconPath);

      if (stats.size > 1048576) {
        app.log('warn', 'favicon.ico too large.', stats);
        ctx.throw(HttpCode.NOT_FOUND);
      }

      icon = await fs.readFile(faviconPath);
    }

    ctx.set('Cache-Control', cacheControl);
    ctx.type = 'image/x-icon';
    ctx.body = icon;
  };
};

module.exports = favicon;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlcy9mYXZpY29uLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiXyIsImZzIiwicGF0aCIsIkh0dHBDb2RlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJmYXZpY29uIiwib3B0aW9ucyIsImFwcCIsImlzU3RyaW5nIiwiZmF2aWNvblBhdGgiLCJ0b0Fic29sdXRlUGF0aCIsImpvaW4iLCJwdWJsaWNQYXRoIiwiZXhpc3RzU3luYyIsImljb24iLCJtYXhBZ2UiLCJNYXRoIiwibWluIiwibWF4IiwiY2FjaGVDb250cm9sIiwiY3R4IiwibmV4dCIsIm1ldGhvZCIsInN0YXRzIiwic3RhdCIsInNpemUiLCJsb2ciLCJ0aHJvdyIsIk5PVF9GT1VORCIsInJlYWRGaWxlIiwic2V0IiwidHlwZSIsImJvZHkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQU9BLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTUMsQ0FBQyxHQUFHRixJQUFJLENBQUNFLENBQWY7QUFDQSxNQUFNQyxFQUFFLEdBQUdILElBQUksQ0FBQ0csRUFBaEI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHSCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNSSxRQUFRLEdBQUdKLE9BQU8sQ0FBQyxtQkFBRCxDQUF4Qjs7QUFDQSxNQUFNO0FBQUVLLEVBQUFBO0FBQUYsSUFBMkJMLE9BQU8sQ0FBQyxhQUFELENBQXhDOztBQUVBLElBQUlNLE9BQU8sR0FBRyxDQUFDQyxPQUFELEVBQVVDLEdBQVYsS0FBa0I7QUFDNUIsTUFBSVAsQ0FBQyxDQUFDUSxRQUFGLENBQVdGLE9BQVgsQ0FBSixFQUF5QjtBQUNyQkEsSUFBQUEsT0FBTyxHQUFHO0FBQUVKLE1BQUFBLElBQUksRUFBRUk7QUFBUixLQUFWO0FBQ0g7O0FBRUQsTUFBSUcsV0FBVyxHQUFHSCxPQUFPLElBQUlBLE9BQU8sQ0FBQ0osSUFBbkIsSUFBMkJLLEdBQUcsQ0FBQ0csY0FBSixDQUFtQkosT0FBTyxDQUFDSixJQUEzQixDQUEzQixJQUErREEsSUFBSSxDQUFDUyxJQUFMLENBQVVKLEdBQUcsQ0FBQ0ssVUFBZCxFQUEwQixhQUExQixDQUFqRjs7QUFDQSxNQUFJLENBQUNYLEVBQUUsQ0FBQ1ksVUFBSCxDQUFjSixXQUFkLENBQUwsRUFBaUM7QUFDN0IsVUFBTSxJQUFJTCxvQkFBSixDQUNELGlCQUFnQkssV0FBWSxlQUQzQixFQUVGRixHQUZFLEVBR0YscUJBSEUsQ0FBTjtBQUtIOztBQUVELE1BQUlPLElBQUo7QUFDQSxRQUFNQyxNQUFNLEdBQUdULE9BQU8sQ0FBQ1MsTUFBUixJQUFrQixJQUFsQixHQUNULFFBRFMsR0FFVEMsSUFBSSxDQUFDQyxHQUFMLENBQVNELElBQUksQ0FBQ0UsR0FBTCxDQUFTLENBQVQsRUFBWVosT0FBTyxDQUFDUyxNQUFwQixDQUFULEVBQXNDLFdBQXRDLENBRk47QUFHQSxRQUFNSSxZQUFZLEdBQUksbUJBQWtCSixNQUFNLEdBQUcsSUFBVCxHQUFnQixDQUFFLEVBQTFEO0FBRUEsU0FBTyxPQUFPSyxHQUFQLEVBQVlDLElBQVosS0FBcUI7QUFDeEIsUUFBSSxtQkFBbUJELEdBQUcsQ0FBQ2xCLElBQXZCLElBQWdDLFVBQVVrQixHQUFHLENBQUNFLE1BQWQsSUFBd0IsV0FBV0YsR0FBRyxDQUFDRSxNQUEzRSxFQUFvRjtBQUNoRixhQUFPRCxJQUFJLEVBQVg7QUFDSDs7QUFFRCxRQUFJLENBQUNQLElBQUwsRUFBVztBQUNQLFVBQUlTLEtBQUssR0FBRyxNQUFNdEIsRUFBRSxDQUFDdUIsSUFBSCxDQUFRZixXQUFSLENBQWxCOztBQUVBLFVBQUljLEtBQUssQ0FBQ0UsSUFBTixHQUFhLE9BQWpCLEVBQTBCO0FBQ3RCbEIsUUFBQUEsR0FBRyxDQUFDbUIsR0FBSixDQUFRLE1BQVIsRUFBZ0Isd0JBQWhCLEVBQTBDSCxLQUExQztBQUNBSCxRQUFBQSxHQUFHLENBQUNPLEtBQUosQ0FBVXhCLFFBQVEsQ0FBQ3lCLFNBQW5CO0FBQ0g7O0FBRURkLE1BQUFBLElBQUksR0FBRyxNQUFNYixFQUFFLENBQUM0QixRQUFILENBQVlwQixXQUFaLENBQWI7QUFDSDs7QUFDRFcsSUFBQUEsR0FBRyxDQUFDVSxHQUFKLENBQVEsZUFBUixFQUF5QlgsWUFBekI7QUFDQUMsSUFBQUEsR0FBRyxDQUFDVyxJQUFKLEdBQVcsY0FBWDtBQUNBWCxJQUFBQSxHQUFHLENBQUNZLElBQUosR0FBV2xCLElBQVg7QUFDSCxHQWxCRDtBQW1CSCxDQXZDRDs7QUF5Q0FtQixNQUFNLENBQUNDLE9BQVAsR0FBaUI3QixPQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKipcbiAqIE1pZGRsZXdhcmUgdG8gc2VydmUgZmF2aWNvbiByZXF1ZXN0LlxuICogQG1vZHVsZSBNaWRkbGV3YXJlX0Zhdmljb25cbiAqL1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IF8gPSBVdGlsLl87XG5jb25zdCBmcyA9IFV0aWwuZnM7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgSHR0cENvZGUgPSByZXF1aXJlKCdodHRwLXN0YXR1cy1jb2RlcycpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiB9ID0gcmVxdWlyZSgnQGdlbngvZXJyb3InKTtcblxubGV0IGZhdmljb24gPSAob3B0aW9ucywgYXBwKSA9PiB7XG4gICAgaWYgKF8uaXNTdHJpbmcob3B0aW9ucykpIHtcbiAgICAgICAgb3B0aW9ucyA9IHsgcGF0aDogb3B0aW9ucyB9O1xuICAgIH0gXG4gICAgXG4gICAgbGV0IGZhdmljb25QYXRoID0gb3B0aW9ucyAmJiBvcHRpb25zLnBhdGggJiYgYXBwLnRvQWJzb2x1dGVQYXRoKG9wdGlvbnMucGF0aCkgfHwgcGF0aC5qb2luKGFwcC5wdWJsaWNQYXRoLCAnZmF2aWNvbi5pY28nKTtcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZmF2aWNvblBhdGgpKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgIGBGYXZpY29uIHBhdGggXCIke2Zhdmljb25QYXRofVwiIG5vdCBleGlzdHMuYCxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgICdtaWRkbGV3YXJlcy5mYXZpY29uJ1xuICAgICAgICApO1xuICAgIH0gICBcblxuICAgIGxldCBpY29uO1xuICAgIGNvbnN0IG1heEFnZSA9IG9wdGlvbnMubWF4QWdlID09IG51bGxcbiAgICAgICAgPyA4NjQwMDAwMFxuICAgICAgICA6IE1hdGgubWluKE1hdGgubWF4KDAsIG9wdGlvbnMubWF4QWdlKSwgMzE1NTY5MjYwMDApO1xuICAgIGNvbnN0IGNhY2hlQ29udHJvbCA9IGBwdWJsaWMsIG1heC1hZ2U9JHttYXhBZ2UgLyAxMDAwIHwgMH1gO1xuXG4gICAgcmV0dXJuIGFzeW5jIChjdHgsIG5leHQpID0+IHtcbiAgICAgICAgaWYgKCcvZmF2aWNvbi5pY28nICE9PSBjdHgucGF0aCB8fCAoJ0dFVCcgIT09IGN0eC5tZXRob2QgJiYgJ0hFQUQnICE9PSBjdHgubWV0aG9kKSkge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghaWNvbikge1xuICAgICAgICAgICAgbGV0IHN0YXRzID0gYXdhaXQgZnMuc3RhdChmYXZpY29uUGF0aCk7XG4gICAgICAgICAgICAvL21heGltdW0gMU1cbiAgICAgICAgICAgIGlmIChzdGF0cy5zaXplID4gMTA0ODU3Nikge1xuICAgICAgICAgICAgICAgIGFwcC5sb2coJ3dhcm4nLCAnZmF2aWNvbi5pY28gdG9vIGxhcmdlLicsIHN0YXRzKTtcbiAgICAgICAgICAgICAgICBjdHgudGhyb3coSHR0cENvZGUuTk9UX0ZPVU5EKTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGljb24gPSBhd2FpdCBmcy5yZWFkRmlsZShmYXZpY29uUGF0aCk7XG4gICAgICAgIH1cbiAgICAgICAgY3R4LnNldCgnQ2FjaGUtQ29udHJvbCcsIGNhY2hlQ29udHJvbCk7XG4gICAgICAgIGN0eC50eXBlID0gJ2ltYWdlL3gtaWNvbic7XG4gICAgICAgIGN0eC5ib2R5ID0gaWNvbjtcbiAgICB9O1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBmYXZpY29uOyJdfQ==