"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const _ = Util._;
const fs = Util.fs;

const Literal = require('../enum/Literal');

const Router = require('@koa/router');

const Controller = require('../patterns/Controller');

const {
  hasMethod
} = require('../utils/Helpers');

const appendId = (baseEndpoint, idName) => idName ? `${baseEndpoint}/:${idName}` : baseEndpoint;

module.exports = (app, baseRoute, options) => {
  let resourcePath = path.resolve(app.backendPath, options.resourcesPath || Literal.RESOURCES_PATH);
  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(options.errorOptions, app), 'jsonError');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let resourcesPath = path.join(resourcePath, "*.js");
  let files = Util.glob.sync(resourcesPath, {
    nodir: true
  });

  _.each(files, file => {
    let entityName = path.basename(file, '.js');
    let customPath = path.join(resourcePath, 'custom', entityName + '.js');

    let controller = require(file);

    if (fs.existsSync(customPath)) {
      let subClassFactory = require(customPath);

      controller = subClassFactory(controller);
    }

    let baseEndpoint;

    if (options.remaps && entityName in options.remaps) {
      baseEndpoint = Util.ensureLeftSlash(Util.trimRightSlash(options.remaps[entityName]));
    } else {
      baseEndpoint = Util.ensureLeftSlash(_.kebabCase(entityName));
    }

    let idName = _.camelCase(entityName) + 'Id';
    let endpointWithId = appendId(baseEndpoint, idName);

    if (hasMethod(controller, 'find')) {
      app.addRoute(router, 'get', baseEndpoint, ctx => controller.find(ctx));
    }

    if (hasMethod(controller, 'post')) {
      app.addRoute(router, 'post', baseEndpoint, ctx => controller.post(ctx));
    }

    if (hasMethod(controller, 'findById')) {
      app.addRoute(router, 'get', endpointWithId, ctx => controller.findById(ctx, ctx.params[idName]));
    }

    if (hasMethod(controller, 'updateById')) {
      app.addRoute(router, 'put', endpointWithId, ctx => controller.updateById(ctx, ctx.params[idName]));
    }

    if (hasMethod(controller, 'deleteById')) {
      app.addRoute(router, 'del', endpointWithId, ctx => controller.deleteById(ctx, ctx.params[idName]));
    }
  });

  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhbWwuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJVdGlsIiwiXyIsImZzIiwiTGl0ZXJhbCIsIlJvdXRlciIsIkNvbnRyb2xsZXIiLCJoYXNNZXRob2QiLCJhcHBlbmRJZCIsImJhc2VFbmRwb2ludCIsImlkTmFtZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJhcHAiLCJiYXNlUm91dGUiLCJvcHRpb25zIiwicmVzb3VyY2VQYXRoIiwicmVzb2x2ZSIsImJhY2tlbmRQYXRoIiwicmVzb3VyY2VzUGF0aCIsIlJFU09VUkNFU19QQVRIIiwicm91dGVyIiwicHJlZml4IiwidXNlTWlkZGxld2FyZSIsImdldE1pZGRsZXdhcmVGYWN0b3J5IiwiZXJyb3JPcHRpb25zIiwibWlkZGxld2FyZXMiLCJ1c2VNaWRkbGV3YXJlcyIsImpvaW4iLCJmaWxlcyIsImdsb2IiLCJzeW5jIiwibm9kaXIiLCJlYWNoIiwiZmlsZSIsImVudGl0eU5hbWUiLCJiYXNlbmFtZSIsImN1c3RvbVBhdGgiLCJjb250cm9sbGVyIiwiZXhpc3RzU3luYyIsInN1YkNsYXNzRmFjdG9yeSIsInJlbWFwcyIsImVuc3VyZUxlZnRTbGFzaCIsInRyaW1SaWdodFNsYXNoIiwia2ViYWJDYXNlIiwiY2FtZWxDYXNlIiwiZW5kcG9pbnRXaXRoSWQiLCJhZGRSb3V0ZSIsImN0eCIsImZpbmQiLCJwb3N0IiwiZmluZEJ5SWQiLCJwYXJhbXMiLCJ1cGRhdGVCeUlkIiwiZGVsZXRlQnlJZCIsImFkZFJvdXRlciJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTUUsQ0FBQyxHQUFHRCxJQUFJLENBQUNDLENBQWY7QUFDQSxNQUFNQyxFQUFFLEdBQUdGLElBQUksQ0FBQ0UsRUFBaEI7O0FBQ0EsTUFBTUMs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eUM7QUFDckN6QixNQUFBQSxHQUFHLENBQUNrQyxRQUFKLENBQWExQixNQUFiLEVBQXFCLEtBQXJCLEVBQTRCeUIsY0FBNUIsRUFBNkNFLEdBQUQsSUFBU1YsVUFBVSxDQUFDZ0IsVUFBWCxDQUFzQk4sR0FBdEIsRUFBMkJBLEdBQUcsQ0FBQ0ksTUFBSixDQUFXMUMsTUFBWCxDQUEzQixDQUFyRDtBQUNIO0FBQ0osR0F6Q0Q7O0FBMkNBRyxFQUFBQSxHQUFHLENBQUMwQyxTQUFKLENBQWNsQyxNQUFkO0FBQ0gsQ0EvREQiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgXyA9IFV0aWwuXztcbmNvbnN0IGZzID0gVXRpbC5mcztcbmNvbnN0IExpdGVyYWwgPSByZXF1aXJlKCcuLi9lbnVtL0xpdGVyYWwnKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJ0Brb2Evcm91dGVyJyk7XG5jb25zdCBDb250cm9sbGVyID0gcmVxdWlyZSgnLi4vcGF0dGVybnMvQ29udHJvbGxlcicpO1xuY29uc3QgeyBoYXNNZXRob2QgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0hlbHBlcnMnKTtcblxuLyoqXG4gKiBHYW1sIHJvdXRlci5cbiAqIEBtb2R1bGUgUm91dGVyX0dhbWxcbiAqL1xuXG5jb25zdCBhcHBlbmRJZCA9IChiYXNlRW5kcG9pbnQsIGlkTmFtZSkgPT4gaWROYW1lID8gYCR7YmFzZUVuZHBvaW50fS86JHtpZE5hbWV9YCA6IGJhc2VFbmRwb2ludDsgXG5cblxuLypcbmNvbnN0IGJhdGNoUXVlcnlfID0gYXN5bmMgKGN0eCkgPT4ge1xuXG4gICAgXG5cbn07XG4qL1xuXG4vKipcbiAqIENyZWF0ZSBhIGdhbWwgcm91dGVyLlxuICogQHBhcmFtIHsqfSBhcHAgXG4gKiBAcGFyYW0ge3N0cmluZ30gYmFzZVJvdXRlIFxuICogQHBhcmFtIHtvYmplY3RzfSBvcHRpb25zIFxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnJlc291cmNlc1BhdGhdXG4gKiBAcHJvcGVydHkge29iamVjdHxhcnJheX0gW29wdGlvbnMubWlkZGxld2FyZXNdXG4gKiBAZXhhbXBsZVxuICogICc8YmFzZSBwYXRoPic6IHtcbiAqICAgICAgZ2FtbDoge1xuICogICAgICAgICAgcmVzb3VyY2VzUGF0aDpcbiAqICAgICAgICAgIG1pZGRsZXdhcmVzOlxuICogICAgICB9XG4gKiAgfVxuICogIFxuICogIHJvdXRlICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwIG1ldGhvZCAgICBmdW5jdGlvbiBvZiBjdHJsXG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIGZpbmRNYW55XyBcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgcG9zdCAgICAgICAgICAgY3JlYXRlX1xuICogIC86cmVzb3VyY2UvOnVuaXF1ZS1rZXkvOnZhbHVlICBnZXQgICAgICAgICAgICBmaW5kT25lQnlfXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIGZpbmRPbmVfXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIHB1dCAgICAgICAgICAgIHVwZGF0ZU9uZV9cbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZGVsICAgICAgICAgICAgZGVsZXRlT25lX1xuICovXG5tb2R1bGUuZXhwb3J0cyA9IChhcHAsIGJhc2VSb3V0ZSwgb3B0aW9ucykgPT4ge1xuICAgIGxldCByZXNvdXJjZVBhdGggPSBwYXRoLnJlc29sdmUoYXBwLmJhY2tlbmRQYXRoLCBvcHRpb25zLnJlc291cmNlc1BhdGggfHwgTGl0ZXJhbC5SRVNPVVJDRVNfUEFUSCk7XG4gICAgXG4gICAgbGV0IHJvdXRlciA9IGJhc2VSb3V0ZSA9PT0gJy8nID8gbmV3IFJvdXRlcigpIDogbmV3IFJvdXRlcih7cHJlZml4OiBiYXNlUm91dGV9KTtcblxuICAgIGFwcC51c2VNaWRkbGV3YXJlKHJvdXRlciwgYXBwLmdldE1pZGRsZXdhcmVGYWN0b3J5KCdqc29uRXJyb3InKShvcHRpb25zLmVycm9yT3B0aW9ucywgYXBwKSwgJ2pzb25FcnJvcicpO1xuXG4gICAgaWYgKG9wdGlvbnMubWlkZGxld2FyZXMpIHtcbiAgICAgICAgYXBwLnVzZU1pZGRsZXdhcmVzKHJvdXRlciwgb3B0aW9ucy5taWRkbGV3YXJlcyk7XG4gICAgfVxuXG4gICAgbGV0IHJlc291cmNlc1BhdGggPSBwYXRoLmpvaW4ocmVzb3VyY2VQYXRoLCBcIiouanNcIik7XG4gICAgbGV0IGZpbGVzID0gVXRpbC5nbG9iLnN5bmMocmVzb3VyY2VzUGF0aCwge25vZGlyOiB0cnVlfSk7XG5cbiAgICAvKlxuICAgIGlmIChvcHRpb25zLmJhdGNoUXVlcnkpIHtcbiAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3Bvc3QnLCBvcHRpb25zLmJhdGNoUXVlcnksIGJhdGNoUXVlcnlfKTtcbiAgICB9Ki9cblxuICAgIF8uZWFjaChmaWxlcywgZmlsZSA9PiB7XG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gcGF0aC5iYXNlbmFtZShmaWxlLCAnLmpzJyk7XG4gICAgICAgIFxuICAgICAgICBsZXQgY3VzdG9tUGF0aCA9IHBhdGguam9pbihyZXNvdXJjZVBhdGgsICdjdXN0b20nLCBlbnRpdHlOYW1lICsgJy5qcycpO1xuICAgICAgICBsZXQgY29udHJvbGxlciA9IHJlcXVpcmUoZmlsZSk7XG5cbiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoY3VzdG9tUGF0aCkpIHtcbiAgICAgICAgICAgIGxldCBzdWJDbGFzc0ZhY3RvcnkgPSByZXF1aXJlKGN1c3RvbVBhdGgpO1xuICAgICAgICAgICAgY29udHJvbGxlciA9IHN1YkNsYXNzRmFjdG9yeShjb250cm9sbGVyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBiYXNlRW5kcG9pbnQ7XG5cbiAgICAgICAgaWYgKG9wdGlvbnMucmVtYXBzICYmIGVudGl0eU5hbWUgaW4gb3B0aW9ucy5yZW1hcHMpIHtcbiAgICAgICAgICAgIGJhc2VFbmRwb2ludCA9IFV0aWwuZW5zdXJlTGVmdFNsYXNoKFV0aWwudHJpbVJpZ2h0U2xhc2gob3B0aW9ucy5yZW1hcHNbZW50aXR5TmFtZV0pKTsgICAgICAgICAgICAgICAgXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBiYXNlRW5kcG9pbnQgPSBVdGlsLmVuc3VyZUxlZnRTbGFzaChfLmtlYmFiQ2FzZShlbnRpdHlOYW1lKSk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGxldCBpZE5hbWUgPSBfLmNhbWVsQ2FzZShlbnRpdHlOYW1lKSArICdJZCc7XG4gICAgICAgIGxldCBlbmRwb2ludFdpdGhJZCA9IGFwcGVuZElkKGJhc2VFbmRwb2ludCwgaWROYW1lKTsgICAgICAgIFxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ2ZpbmQnKSkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIGJhc2VFbmRwb2ludCwgKGN0eCkgPT4gY29udHJvbGxlci5maW5kKGN0eCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAncG9zdCcpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncG9zdCcsIGJhc2VFbmRwb2ludCwgKGN0eCkgPT4gY29udHJvbGxlci5wb3N0KGN0eCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAnZmluZEJ5SWQnKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIGVuZHBvaW50V2l0aElkLCAoY3R4KSA9PiBjb250cm9sbGVyLmZpbmRCeUlkKGN0eCwgY3R4LnBhcmFtc1tpZE5hbWVdKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICd1cGRhdGVCeUlkJykpIHtcbiAgICAgICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwdXQnLCBlbmRwb2ludFdpdGhJZCwgKGN0eCkgPT4gY29udHJvbGxlci51cGRhdGVCeUlkKGN0eCwgY3R4LnBhcmFtc1tpZE5hbWVdKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdkZWxldGVCeUlkJykpIHtcbiAgICAgICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdkZWwnLCBlbmRwb2ludFdpdGhJZCwgKGN0eCkgPT4gY29udHJvbGxlci5kZWxldGVCeUlkKGN0eCwgY3R4LnBhcmFtc1tpZE5hbWVdKSk7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGFwcC5hZGRSb3V0ZXIocm91dGVyKTtcbn07Il19