"use strict";

require("source-map-support/register");

const Feature = require('@genx/app/lib/enum/Feature');

const path = require('path');

const Util = require('rk-utils');

const Promise = Util.Promise;

const {
  InvalidConfiguration
} = require('../utils/Errors');

const WebModule = require('../WebModule');

module.exports = {
  type: Feature.PLUGIN,
  load_: async (server, routes) => Util.eachAsync_(routes, async (config, baseRoute) => {
    if (!config.name) {
      throw new InvalidConfiguration('Missing app name.', app, `appRouting.${baseRoute}.name`);
    }

    let options = Object.assign({
      env: server.env,
      logWithAppName: server.options.logWithAppName,
      traceMiddlewares: server.options.traceMiddlewares
    }, config.options);
    let appPath;

    if (config.npmModule) {
      appPath = server.toAbsolutePath('node_modules', config.name);
    } else {
      appPath = path.join(server.appModulesPath, config.name);
    }

    let exists = (await Util.fs.pathExists(appPath)) && (await Util.fs.stat(appPath)).isDirectory();

    if (!exists) {
      throw new InvalidConfiguration(`App [${config.name}] not exists.`, server, `appRouting.${baseRoute}.name`);
    }

    let app = new WebModule(server, config.name, baseRoute, appPath, options);

    if (!Util._.isEmpty(config.custom)) {
      app.customConfig = config.custom;
    }

    app.on('configLoaded', () => {
      if (!Util._.isEmpty(config.settings)) {
        app.config.settings = Object.assign({}, app.config.settings, config.settings);
        server.log('verbose', `App settings of [${app.name}] is overrided.`);
      }

      if (!Util._.isEmpty(config.middlewares)) {
        let middlewaresToAppend = app.config.middlewares;
        app.config.middlewares = Object.assign({}, config.middlewares);

        Util._.defaults(app.config.middlewares, middlewaresToAppend);
      }
    });
    let relativePath = path.relative(server.workingPath, appPath);
    server.log('verbose', `Loading app [${app.name}] from "${relativePath}" ...`);
    await app.start_();
    server.log('verbose', `App [${app.name}] is loaded.`);
    server.on('after:' + Feature.PLUGIN, () => {
      server.mountApp(app);
    });
  })
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXJGZWF0dXJlcy9hcHBSb3V0aW5nLmpzIl0sIm5hbWVzIjpbIkZlYXR1cmUiLCJyZXF1aXJlIiwicGF0aCIsIlV0aWwiLCJQcm9taXNlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJXZWJNb2R1bGUiLCJtb2R1bGUiLCJleHBvcnRzIiwidHlwZSIsIlBMVUdJTiIsImxvYWRfIiwic2VydmVyIiwicm91dGVzIiwiZWFjaEFzeW5jXyIsImNvbmZpZyIsImJhc2VSb3V0ZSIsIm5hbWUiLCJhcHAiLCJvcHRpb25zIiwiT2JqZWN0IiwiYXNzaWduIiwiZW52IiwibG9nV2l0aEFwcE5hbWUiLCJ0cmFjZU1pZGRsZXdhcmVzIiwiYXBwUGF0aCIsIm5wbU1vZHVsZSIsInRvQWJzb2x1dGVQYXRoIiwiam9pbiIsImFwcE1vZHVsZXNQYXRoIiwiZXhpc3RzIiwiZnMiLCJwYXRoRXhpc3RzIiwic3RhdCIsImlzRGlyZWN0b3J5IiwiXyIsImlzRW1wdHkiLCJjdXN0b20iLCJjdXN0b21Db25maWciLCJvbiIsInNldHRpbmdzIiwibG9nIiwibWlkZGxld2FyZXMiLCJtaWRkbGV3YXJlc1RvQXBwZW5kIiwiZGVmYXVsdHMiLCJyZWxhdGl2ZVBhdGgiLCJyZWxhdGl2ZSIsIndvcmtpbmdQYXRoIiwic3RhcnRfIiwibW91bnRBcHAiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBc0JBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLDRCQUFELENBQXZCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNRyxPQUFPLEdBQUdELElBQUksQ0FBQ0MsT0FBckI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQTJCSixPQUFPLENBQUMsaUJBQUQsQ0FBeEM7O0FBQ0EsTUFBTUssU0FBUyxHQUFHTCxPQUFPLENBQUMsY0FBRCxD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ckM7QUFDQXhCLFFBQUFBLEdBQUcsQ0FBQ0gsTUFBSixDQUFXMkIsV0FBWCxHQUF5QnRCLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JOLE1BQU0sQ0FBQzJCLFdBQXpCLENBQXpCOztBQUNBdkMsUUFBQUEsSUFBSSxDQUFDZ0MsQ0FBTCxDQUFPUyxRQUFQLENBQWdCMUIsR0FBRyxDQUFDSCxNQUFKLENBQVcyQixXQUEzQixFQUF3Q0MsbUJBQXhDO0FBQ0g7QUFDSixLQVhEO0FBYUEsUUFBSUUsWUFBWSxHQUFHM0MsSUFBSSxDQUFDNEMsUUFBTCxDQUFjbEMsTUFBTSxDQUFDbUMsV0FBckIsRUFBa0N0QixPQUFsQyxDQUFuQjtBQUNBYixJQUFBQSxNQUFNLENBQUM2QixHQUFQLENBQVcsU0FBWCxFQUF1QixnQkFBZXZCLEdBQUcsQ0FBQ0QsSUFBSyxXQUFVNEIsWUFBYSxPQUF0RTtBQUVBLFVBQU0zQixHQUFHLENBQUM4QixNQUFKLEVBQU47QUFFQXBDLElBQUFBLE1BQU0sQ0FBQzZCLEdBQVAsQ0FBVyxTQUFYLEVBQXVCLFFBQU92QixHQUFHLENBQUNELElBQUssY0FBdkM7QUFHQUwsSUFBQUEsTUFBTSxDQUFDMkIsRUFBUCxDQUFVLFdBQVd2QyxPQUFPLENBQUNVLE1BQTdCLEVBQXFDLE1BQU07QUFDdkNFLE1BQUFBLE1BQU0sQ0FBQ3FDLFFBQVAsQ0FBZ0IvQixHQUFoQjtBQUNILEtBRkQ7QUFHSCxHQTNEZ0M7QUFkcEIsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuLyoqXG4gKiBFbmFibGUgcm91dGluZyB3ZWIgcmVxdWVzdHMgdG8gYSBjaGlsZCBhcHAuXG4gKiBAbW9kdWxlIEZlYXR1cmVfQXBwUm91dGluZ1xuICogXG4gKiBAZXhhbXBsZVxuICogIFxuICogICdhcHBSb3V0aW5nJzoge1xuICogICAgICAnPG1vdW50aW5nIHBvaW50Pic6IHtcbiAqICAgICAgICAgIG5hbWU6ICdhcHAgbmFtZScsIFxuICogICAgICAgICAgbnBtTW9kdWxlOiBmYWxzZSwgLy8gd2hldGhlciBpcyBhIG5wbSBtb2R1bGVcbiAqICAgICAgICAgIG9wdGlvbnM6IHsgLy8gbW9kdWxlIG9wdGlvbnMgXG4gKiAgICAgICAgICB9LFxuICogICAgICAgICAgc2V0dGluZ3M6IHsgLy8gY2FuIG92ZXJyaWRlIG1vZHVsZSBkZWZpbmVkIHNldHRpbmdzXG4gKiAgICAgICAgICB9LFxuICogICAgICAgICAgbWlkZGxld2FyZXM6IHsgLy8gY2FuIG92ZXJyaWRlIG1pZGRsZXdhcmVzIFxuICogICAgICAgICAgfVxuICogICAgICB9XG4gKiAgfSBcbiAqL1xuXG5jb25zdCBGZWF0dXJlID0gcmVxdWlyZSgnQGdlbngvYXBwL2xpYi9lbnVtL0ZlYXR1cmUnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IFByb21pc2UgPSBVdGlsLlByb21pc2U7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uIH0gPSByZXF1aXJlKCcuLi91dGlscy9FcnJvcnMnKTtcbmNvbnN0IFdlYk1vZHVsZSA9IHJlcXVpcmUoJy4uL1dlYk1vZHVsZScpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblxuICAgIC8qKlxuICAgICAqIFRoaXMgZmVhdHVyZSBpcyBsb2FkZWQgYXQgcGx1Z2luIHN0YWdlLlxuICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgKi9cbiAgICB0eXBlOiBGZWF0dXJlLlBMVUdJTixcblxuICAgIC8qKlxuICAgICAqIExvYWQgdGhlIGZlYXR1cmUuXG4gICAgICogQHBhcmFtIHtXZWJTZXJ2ZXJ9IHNlcnZlciAtIFRoZSB3ZWIgc2VydmVyIG1vZHVsZSBvYmplY3QuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJvdXRlcyAtIFJvdXRlcyBhbmQgY29uZmlndXJhdGlvbi5cbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48Kj59XG4gICAgICovXG4gICAgbG9hZF86IGFzeW5jIChzZXJ2ZXIsIHJvdXRlcykgPT4gVXRpbC5lYWNoQXN5bmNfKHJvdXRlcywgYXN5bmMgKGNvbmZpZywgYmFzZVJvdXRlKSA9PiB7XG4gICAgICAgIGlmICghY29uZmlnLm5hbWUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICAnTWlzc2luZyBhcHAgbmFtZS4nLFxuICAgICAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgICAgICBgYXBwUm91dGluZy4ke2Jhc2VSb3V0ZX0ubmFtZWApO1xuICAgICAgICB9XG4gICAgXG4gICAgICAgIGxldCBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7IFxuICAgICAgICAgICAgZW52OiBzZXJ2ZXIuZW52LCBcbiAgICAgICAgICAgIGxvZ1dpdGhBcHBOYW1lOiBzZXJ2ZXIub3B0aW9ucy5sb2dXaXRoQXBwTmFtZSxcbiAgICAgICAgICAgIHRyYWNlTWlkZGxld2FyZXM6IHNlcnZlci5vcHRpb25zLnRyYWNlTWlkZGxld2FyZXNcbiAgICAgICAgfSwgY29uZmlnLm9wdGlvbnMpO1xuXG4gICAgICAgIGxldCBhcHBQYXRoOyAgICAgXG5cbiAgICAgICAgaWYgKGNvbmZpZy5ucG1Nb2R1bGUpIHtcbiAgICAgICAgICAgIGFwcFBhdGggPSBzZXJ2ZXIudG9BYnNvbHV0ZVBhdGgoJ25vZGVfbW9kdWxlcycsIGNvbmZpZy5uYW1lKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFwcFBhdGggPSBwYXRoLmpvaW4oc2VydmVyLmFwcE1vZHVsZXNQYXRoLCBjb25maWcubmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZXhpc3RzID0gYXdhaXQgVXRpbC5mcy5wYXRoRXhpc3RzKGFwcFBhdGgpICYmIChhd2FpdCBVdGlsLmZzLnN0YXQoYXBwUGF0aCkpLmlzRGlyZWN0b3J5KCk7XG4gICAgICAgIGlmICghZXhpc3RzKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgYEFwcCBbJHtjb25maWcubmFtZX1dIG5vdCBleGlzdHMuYCxcbiAgICAgICAgICAgICAgICBzZXJ2ZXIsXG4gICAgICAgICAgICAgICAgYGFwcFJvdXRpbmcuJHtiYXNlUm91dGV9Lm5hbWVgKTtcbiAgICAgICAgfVxuICAgIFxuICAgICAgICBsZXQgYXBwID0gbmV3IFdlYk1vZHVsZShzZXJ2ZXIsIGNvbmZpZy5uYW1lLCBiYXNlUm91dGUsIGFwcFBhdGgsIG9wdGlvbnMpO1xuICAgICAgICBpZiAoIVV0aWwuXy5pc0VtcHR5KGNvbmZpZy5jdXN0b20pKSB7XG4gICAgICAgICAgICBhcHAuY3VzdG9tQ29uZmlnID0gY29uZmlnLmN1c3RvbTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgYXBwLm9uKCdjb25maWdMb2FkZWQnLCAoKSA9PiB7XG4gICAgICAgICAgICBpZiAoIVV0aWwuXy5pc0VtcHR5KGNvbmZpZy5zZXR0aW5ncykpIHtcbiAgICAgICAgICAgICAgICBhcHAuY29uZmlnLnNldHRpbmdzID0gT2JqZWN0LmFzc2lnbih7fSwgYXBwLmNvbmZpZy5zZXR0aW5ncywgY29uZmlnLnNldHRpbmdzKTtcbiAgICAgICAgICAgICAgICBzZXJ2ZXIubG9nKCd2ZXJib3NlJywgYEFwcCBzZXR0aW5ncyBvZiBbJHthcHAubmFtZX1dIGlzIG92ZXJyaWRlZC5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFVdGlsLl8uaXNFbXB0eShjb25maWcubWlkZGxld2FyZXMpKSB7XG4gICAgICAgICAgICAgICAgbGV0IG1pZGRsZXdhcmVzVG9BcHBlbmQgPSBhcHAuY29uZmlnLm1pZGRsZXdhcmVzO1xuICAgICAgICAgICAgICAgIGFwcC5jb25maWcubWlkZGxld2FyZXMgPSBPYmplY3QuYXNzaWduKHt9LCBjb25maWcubWlkZGxld2FyZXMpO1xuICAgICAgICAgICAgICAgIFV0aWwuXy5kZWZhdWx0cyhhcHAuY29uZmlnLm1pZGRsZXdhcmVzLCBtaWRkbGV3YXJlc1RvQXBwZW5kKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IHJlbGF0aXZlUGF0aCA9IHBhdGgucmVsYXRpdmUoc2VydmVyLndvcmtpbmdQYXRoLCBhcHBQYXRoKTtcbiAgICAgICAgc2VydmVyLmxvZygndmVyYm9zZScsIGBMb2FkaW5nIGFwcCBbJHthcHAubmFtZX1dIGZyb20gXCIke3JlbGF0aXZlUGF0aH1cIiAuLi5gKTtcbiAgICBcbiAgICAgICAgYXdhaXQgYXBwLnN0YXJ0XygpO1xuICAgICAgICBcbiAgICAgICAgc2VydmVyLmxvZygndmVyYm9zZScsIGBBcHAgWyR7YXBwLm5hbWV9XSBpcyBsb2FkZWQuYCk7XG5cbiAgICAgICAgLy9kZWxheWVkIHRoZSBhcHAgcm91dGVzIG1vdW50aW5nIGFmdGVyIGFsbCBwbHVnaW5zIG9mIHRoZSBzZXJ2ZXIgYXJlIGxvYWRlZFxuICAgICAgICBzZXJ2ZXIub24oJ2FmdGVyOicgKyBGZWF0dXJlLlBMVUdJTiwgKCkgPT4ge1xuICAgICAgICAgICAgc2VydmVyLm1vdW50QXBwKGFwcCk7XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfSlcbn07Il19