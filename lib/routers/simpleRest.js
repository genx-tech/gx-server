"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const _ = Util._;
const Promise = Util.Promise;

const Literal = require('../enum/Literal');

const Router = require('@koa/router');

const Controller = require('../patterns/Controller');

const {
  InvalidConfiguration
} = require('../utils/Errors');

const {
  hasMethod
} = require('../utils/Helpers');

module.exports = (app, baseRoute, options) => {
  let resourcePath = path.resolve(app.backendPath, options.resourcesPath || Literal.RESOURCES_PATH);
  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(), 'jsonError');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let resourcesPath = path.join(resourcePath, "**", "*.js");
  let files = Util.glob.sync(resourcesPath, {
    nodir: true
  });

  _.each(files, file => {
    let relPath = path.relative(resourcePath, file);
    let batchUrl = Util.ensureLeftSlash(relPath.substring(0, relPath.length - 3).split(path.sep).map(p => _.kebabCase(p)).join('/'));
    let singleUrl = batchUrl + '/:id';

    let controller = require(file);

    let isObj = false;

    if (controller.prototype instanceof Controller) {
      controller = new controller(app);
      isObj = true;
    }

    if (hasMethod(controller, 'query')) {
      app.addRoute(router, 'get', batchUrl, isObj ? controller.query.bind(controller) : controller.query);
    }

    if (hasMethod(controller, 'create')) {
      app.addRoute(router, 'post', batchUrl, isObj ? controller.create.bind(controller) : controller.create);
    }

    if (hasMethod(controller, 'detail')) {
      app.addRoute(router, 'get', singleUrl, isObj ? controller.detail.bind(controller) : controller.detail);
    }

    if (hasMethod(controller, 'update')) {
      app.addRoute(router, 'put', singleUrl, isObj ? controller.update.bind(controller) : controller.update);
    }

    if (hasMethod(controller, 'remove')) {
      app.addRoute(router, 'del', singleUrl, isObj ? controller.remove.bind(controller) : controller.remove);
    }
  });

  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL3NpbXBsZVJlc3QuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJVdGlsIiwiXyIsIlByb21pc2UiLCJMaXRlcmFsIiwiUm91dGVyIiwiQ29udHJvbGxlciIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiaGFzTWV0aG9kIiwibW9kdWxlIiwiZXhwb3J0cyIsImFwcCIsImJhc2VSb3V0ZSIsIm9wdGlvbnMiLCJyZXNvdXJjZVBhdGgiLCJyZXNvbHZlIiwiYmFja2VuZFBhdGgiLCJyZXNvdXJjZXNQYXRoIiwiUkVTT1VSQ0VTX1BBVEgiLCJyb3V0ZXIiLCJwcmVmaXgiLCJ1c2VNaWRkbGV3YXJlIiwiZ2V0TWlkZGxld2FyZUZhY3RvcnkiLCJtaWRkbGV3YXJlcyIsInVzZU1pZGRsZXdhcmVzIiwiam9pbiIsImZpbGVzIiwiZ2xvYiIsInN5bmMiLCJub2RpciIsImVhY2giLCJmaWxlIiwicmVsUGF0aCIsInJlbGF0aXZlIiwiYmF0Y2hVcmwiLCJlbnN1cmVMZWZ0U2xhc2giLCJzdWJzdHJpbmciLCJsZW5ndGgiLCJzcGxpdCIsInNlcCIsIm1hcCIsInAiLCJrZWJhYkNhc2UiLCJzaW5nbGVVcmwiLCJjb250cm9sbGVyIiwiaXNPYmoiLCJwcm90b3R5cGUiLCJhZGRSb3V0ZSIsInF1ZXJ5IiwiYmluZCIsImNyZWF0ZSIsImRldGFpbCIsInVwZGF0ZSIsInJlbW92ZSIsImFkZFJvdXRlciJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTUUsQ0FBQyxHQUFHRCxJQUFJLENBQUNDLENBQWY7QUFDQSxNQUFNQyxPQUFPLEdBQUdGLElBQUksQ0FBQ0UsT0FBckI7O0FBQ0EsTUFBTUMsT0FBTyxHQUFHSixPQUFPLENBQUMsaUJBQUQsQ0FBdkI7O0FBQ0EsTUFBTUss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IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgXyA9IFV0aWwuXztcbmNvbnN0IFByb21pc2UgPSBVdGlsLlByb21pc2U7XG5jb25zdCBMaXRlcmFsID0gcmVxdWlyZSgnLi4vZW51bS9MaXRlcmFsJyk7XG5jb25zdCBSb3V0ZXIgPSByZXF1aXJlKCdAa29hL3JvdXRlcicpO1xuY29uc3QgQ29udHJvbGxlciA9IHJlcXVpcmUoJy4uL3BhdHRlcm5zL0NvbnRyb2xsZXInKTtcbmNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24gfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0Vycm9ycycpO1xuY29uc3QgeyBoYXNNZXRob2QgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0hlbHBlcnMnKTtcblxuLyoqXG4gKiBSRVNUZnVsIHJvdXRlci5cbiAqIEBtb2R1bGUgUm91dGVyX1Jlc3RcbiAqL1xuXG4vKipcbiAqIENyZWF0ZSBhIFJFU1RmdWwgcm91dGVyLlxuICogQHBhcmFtIHsqfSBhcHAgXG4gKiBAcGFyYW0ge3N0cmluZ30gYmFzZVJvdXRlIFxuICogQHBhcmFtIHtvYmplY3RzfSBvcHRpb25zIFxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnJlc291cmNlc1BhdGhdXG4gKiBAcHJvcGVydHkge29iamVjdHxhcnJheX0gW29wdGlvbnMubWlkZGxld2FyZXNdXG4gKiBAZXhhbXBsZVxuICogICc8YmFzZSBwYXRoPic6IHtcbiAqICAgICAgcmVzdDoge1xuICogICAgICAgICAgcmVzb3VyY2VzUGF0aDpcbiAqICAgICAgICAgIG1pZGRsZXdhcmVzOlxuICogICAgICB9XG4gKiAgfVxuICogIFxuICogIHJvdXRlICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwIG1ldGhvZCAgICBmdW5jdGlvbiBvZiBjdHJsXG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIHF1ZXJ5XG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIHBvc3QgICAgICAgICAgIGNyZWF0ZVxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBkZXRhaWxcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgcHV0ICAgICAgICAgICAgdXBkYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGRlbGV0ZSAgICAgICAgIHJlbW92ZSBcbiAqL1xubW9kdWxlLmV4cG9ydHMgPSAoYXBwLCBiYXNlUm91dGUsIG9wdGlvbnMpID0+IHtcbiAgICBsZXQgcmVzb3VyY2VQYXRoID0gcGF0aC5yZXNvbHZlKGFwcC5iYWNrZW5kUGF0aCwgb3B0aW9ucy5yZXNvdXJjZXNQYXRoIHx8IExpdGVyYWwuUkVTT1VSQ0VTX1BBVEgpO1xuICAgIFxuICAgIGxldCByb3V0ZXIgPSBiYXNlUm91dGUgPT09ICcvJyA/IG5ldyBSb3V0ZXIoKSA6IG5ldyBSb3V0ZXIoe3ByZWZpeDogYmFzZVJvdXRlfSk7XG5cbiAgICBhcHAudXNlTWlkZGxld2FyZShyb3V0ZXIsIGFwcC5nZXRNaWRkbGV3YXJlRmFjdG9yeSgnanNvbkVycm9yJykoKSwgJ2pzb25FcnJvcicpO1xuXG4gICAgaWYgKG9wdGlvbnMubWlkZGxld2FyZXMpIHtcbiAgICAgICAgYXBwLnVzZU1pZGRsZXdhcmVzKHJvdXRlciwgb3B0aW9ucy5taWRkbGV3YXJlcyk7XG4gICAgfVxuXG4gICAgbGV0IHJlc291cmNlc1BhdGggPSBwYXRoLmpvaW4ocmVzb3VyY2VQYXRoLCBcIioqXCIsIFwiKi5qc1wiKTtcbiAgICBsZXQgZmlsZXMgPSBVdGlsLmdsb2Iuc3luYyhyZXNvdXJjZXNQYXRoLCB7bm9kaXI6IHRydWV9KTtcblxuICAgIF8uZWFjaChmaWxlcywgZmlsZSA9PiB7XG4gICAgICAgIGxldCByZWxQYXRoID0gcGF0aC5yZWxhdGl2ZShyZXNvdXJjZVBhdGgsIGZpbGUpOyAgICAgICAgICBcbiAgICAgICAgbGV0IGJhdGNoVXJsID0gVXRpbC5lbnN1cmVMZWZ0U2xhc2gocmVsUGF0aC5zdWJzdHJpbmcoMCwgcmVsUGF0aC5sZW5ndGggLSAzKS5zcGxpdChwYXRoLnNlcCkubWFwKHAgPT4gXy5rZWJhYkNhc2UocCkpLmpvaW4oJy8nKSk7XG4gICAgICAgIGxldCBzaW5nbGVVcmwgPSBiYXRjaFVybCArICcvOmlkJzsgXG4gICAgICAgIFxuICAgICAgICBsZXQgY29udHJvbGxlciA9IHJlcXVpcmUoZmlsZSk7XG4gICAgICAgIGxldCBpc09iaiA9IGZhbHNlO1xuICAgIFxuICAgICAgICBpZiAoY29udHJvbGxlci5wcm90b3R5cGUgaW5zdGFuY2VvZiBDb250cm9sbGVyKSB7XG4gICAgICAgICAgICBjb250cm9sbGVyID0gbmV3IGNvbnRyb2xsZXIoYXBwKTtcbiAgICAgICAgICAgIGlzT2JqID0gdHJ1ZTtcbiAgICAgICAgfSAgICAgICAgXG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAncXVlcnknKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIGJhdGNoVXJsLCBpc09iaiA/IGNvbnRyb2xsZXIucXVlcnkuYmluZChjb250cm9sbGVyKSA6IGNvbnRyb2xsZXIucXVlcnkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAnY3JlYXRlJykpIHtcbiAgICAgICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwb3N0JywgYmF0Y2hVcmwsIGlzT2JqID8gY29udHJvbGxlci5jcmVhdGUuYmluZChjb250cm9sbGVyKSA6IGNvbnRyb2xsZXIuY3JlYXRlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ2RldGFpbCcpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0Jywgc2luZ2xlVXJsLCBpc09iaiA/IGNvbnRyb2xsZXIuZGV0YWlsLmJpbmQoY29udHJvbGxlcikgOiBjb250cm9sbGVyLmRldGFpbCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICd1cGRhdGUnKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3B1dCcsIHNpbmdsZVVybCwgaXNPYmogPyBjb250cm9sbGVyLnVwZGF0ZS5iaW5kKGNvbnRyb2xsZXIpIDogY29udHJvbGxlci51cGRhdGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAncmVtb3ZlJykpIHtcbiAgICAgICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdkZWwnLCBzaW5nbGVVcmwsIGlzT2JqID8gY29udHJvbGxlci5yZW1vdmUuYmluZChjb250cm9sbGVyKSA6IGNvbnRyb2xsZXIucmVtb3ZlKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgYXBwLmFkZFJvdXRlcihyb3V0ZXIpO1xufTsiXX0=