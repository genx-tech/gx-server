{"version":3,"file":"jsonError.js","names":["http","require","module","exports","opt","app","handler","customHandler","getBackendAction","apiWrapper","getService","settings","apiWrapperService","wrapError","ctx","next","errorHandled","status","type","throw","body","err","emit","error","innerError","expose","message","STATUS_CODES"],"sources":["../../src/middlewares/jsonError.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Error response middleware with json\n * @module Middleware_JsonError\n */\n\nconst http = require('http');\n\nmodule.exports = (opt, app) => { \n    let handler;\n\n    if (opt && opt.customHandler) {\n        handler = app.getBackendAction(opt.customHandler);\n    }\n\n    if (!handler) {\n        const apiWrapper = app.getService(app.settings?.apiWrapperService || 'apiWrapper');\n        handler = apiWrapper && apiWrapper.wrapError;\n    }\n\n    return async (ctx, next) => {\n        try {\n            await next();\n\n            if (ctx.errorHandled) {\n                return;\n            }\n\n            if (ctx.status >= 400) {\n                if (ctx.type === 'text/plain') {\n                    ctx.throw(ctx.status, ctx.body);\n                } else {\n                    ctx.throw(ctx.status);\n                }  \n            }\n        } catch (err) {        \n            ctx.status = typeof err.status === 'number' && err.status >= 100 ? err.status : 500;               \n            ctx.type = 'application/json';\n\n            // accepted types\n            if (handler) {      \n                try {                    \n                    ctx.body = await handler(ctx, err);     \n                    ctx.app.emit('error', err, ctx);  \n                    ctx.errorHandled = true;      \n                    return;\n                } catch (error) {\n                    error.innerError = err;\n                    err = error;\n                }                   \n            }             \n\n            ctx.body = { error: (err.expose && err.message) ? err.message : http.STATUS_CODES[ctx.status] };\n            ctx.app.emit('error', err, ctx);\n        }        \n    } \n};       "],"mappings":"AAAA;;;;AAOA,MAAMA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAApB;;AAEAC,MAAM,CAACC,OAAP,GAAiB,CAACC,GAAD,EAAMC,GAAN,KAAc;EAC3B,IAAIC,OAAJ;;EAEA,IAAIF,GAAG,IAAIA,GAAG,CAACG,aAAf,EAA8B;IAC1BD,OAAO,GAAGD,GAAG,CAACG,gBAAJ,CAAqBJ,GAAG,CAACG,aAAzB,CAAV;EACH;;EAED,IAAI,CAACD,OAAL,EAAc;IAAA;;IACV,MAAMG,UAAU,GAAGJ,GAAG,CAACK,UAAJ,CAAe,kBAAAL,GAAG,CAACM,QAAJ,gEAAcC,iBAAd,KAAmC,YAAlD,CAAnB;IACAN,OAAO,GAAGG,UAAU,IAAIA,UAAU,CAACI,SAAnC;EACH;;EAED,OAAO,OAAOC,GAAP,EAAYC,IAAZ,KAAqB;IACxB,IAAI;MACA,MAAMA,IAAI,EAAV;;MAEA,IAAID,GAAG,CAACE,YAAR,EAAsB;QAClB;MACH;;MAED,IAAIF,GAAG,CAACG,MAAJ,IAAc,GAAlB,EAAuB;QACnB,IAAIH,GAAG,CAACI,IAAJ,KAAa,YAAjB,EAA+B;UAC3BJ,GAAG,CAACK,KAAJ,CAAUL,GAAG,CAACG,MAAd,EAAsBH,GAAG,CAACM,IAA1B;QACH,CAFD,MAEO;UACHN,GAAG,CAACK,KAAJ,CAAUL,GAAG,CAACG,MAAd;QACH;MACJ;IACJ,CAdD,CAcE,OAAOI,GAAP,EAAY;MACVP,GAAG,CAACG,MAAJ,GAAa,OAAOI,GAAG,CAACJ,MAAX,KAAsB,QAAtB,IAAkCI,GAAG,CAACJ,MAAJ,IAAc,GAAhD,GAAsDI,GAAG,CAACJ,MAA1D,GAAmE,GAAhF;MACAH,GAAG,CAACI,IAAJ,GAAW,kBAAX;;MAGA,IAAIZ,OAAJ,EAAa;QACT,IAAI;UACAQ,GAAG,CAACM,IAAJ,GAAW,MAAMd,OAAO,CAACQ,GAAD,EAAMO,GAAN,CAAxB;UACAP,GAAG,CAACT,GAAJ,CAAQiB,IAAR,CAAa,OAAb,EAAsBD,GAAtB,EAA2BP,GAA3B;UACAA,GAAG,CAACE,YAAJ,GAAmB,IAAnB;UACA;QACH,CALD,CAKE,OAAOO,KAAP,EAAc;UACZA,KAAK,CAACC,UAAN,GAAmBH,GAAnB;UACAA,GAAG,GAAGE,KAAN;QACH;MACJ;;MAEDT,GAAG,CAACM,IAAJ,GAAW;QAAEG,KAAK,EAAGF,GAAG,CAACI,MAAJ,IAAcJ,GAAG,CAACK,OAAnB,GAA8BL,GAAG,CAACK,OAAlC,GAA4C1B,IAAI,CAAC2B,YAAL,CAAkBb,GAAG,CAACG,MAAtB;MAArD,CAAX;MACAH,GAAG,CAACT,GAAJ,CAAQiB,IAAR,CAAa,OAAb,EAAsBD,GAAtB,EAA2BP,GAA3B;IACH;EACJ,CAnCD;AAoCH,CAhDD"}