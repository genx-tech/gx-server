{"version":3,"file":"module.js","names":["path","require","_","url","urlUtil","text","Literal","Router","InvalidConfiguration","module","exports","app","baseRoute","moduleItem","controllerPath","join","backendPath","CONTROLLERS_PATH","controller","currentPrefix","route","router","prefix","dropIfEndsWith","middlewares","useMiddlewares","controllers","castArray","forEach","moduleController","controllerFile","isController","actionName","action","__metaHttpMethod","method","subRoute","ensureStartsWith","__metaRoute","kebabCase","bindAction","bind","ALLOWED_HTTP_METHODS","has","addRoute","__metaMiddlewares","concat","addRouter"],"sources":["../../src/routers/module.js"],"sourcesContent":["\"use strict\";\n\nconst path = require(\"path\");\nconst { _, url: urlUtil, text } = require(\"@genx/july\");\nconst Literal = require(\"../enum/Literal\");\nconst Router = require(\"@koa/router\");\nconst { InvalidConfiguration } = require(\"@genx/error\");\n\n/**\n * Module router for mounting a specific controller.\n * @module Router_Module\n */\n\n/**\n * Create a module-based router.\n * @param {Routable} app\n * @param {string} baseRoute\n * @param {*} moduleItem\n * @example\n *   '<base path>': {\n *       module: {\n *           middlewares:\n *           controller:\n *       }\n *   }\n *\n *   '<base path>': {\n *       module: \"controller\"\n *   }\n */\nmodule.exports = function (app, baseRoute, moduleItem) {\n    let controllerPath = path.join(app.backendPath, Literal.CONTROLLERS_PATH);\n\n    if (typeof moduleItem === \"string\") {\n        // [ 'controllerName' ]\n        moduleItem = {\n            controller: moduleItem,\n        };\n    }\n\n    let currentPrefix = urlUtil.join(baseRoute, moduleItem.route || \"/\");\n    let router = currentPrefix === \"/\" ? new Router() : new Router({ prefix: text.dropIfEndsWith(currentPrefix, \"/\") });\n\n    if (moduleItem.middlewares) {\n        //module-wide middlewares\n        app.useMiddlewares(router, moduleItem.middlewares);\n    }\n\n    const controllers = _.castArray(moduleItem.controller);\n\n    controllers.forEach((moduleController) => {\n        let controllerFile = path.join(controllerPath, moduleController + \".js\");\n        let controller;\n\n        controller = require(controllerFile);\n        let isController = false;\n\n        if (typeof controller === \"function\") {\n            controller = new controller(app);\n            isController = true;\n        }\n\n        for (let actionName in controller) {\n            let action = controller[actionName];\n            if (typeof action !== \"function\" || !action.__metaHttpMethod) continue; // only marked httpMethod should be mounted\n\n            const method = action.__metaHttpMethod;\n            let subRoute = text.ensureStartsWith(action.__metaRoute || _.kebabCase(actionName), \"/\");\n\n            let bindAction;\n\n            if (isController) {\n                bindAction = action.bind(controller);\n            } else {\n                bindAction = action;\n            }\n\n            if (!Literal.ALLOWED_HTTP_METHODS.has(method)) {\n                throw new InvalidConfiguration(\n                    \"Unsupported http method: \" + method,\n                    app,\n                    `routing.${baseRoute}.modules ${moduleItem.controller}.${actionName}`\n                );\n            }\n\n            app.addRoute(\n                router,\n                method,\n                subRoute,\n                action.__metaMiddlewares ? action.__metaMiddlewares.concat([bindAction]) : bindAction\n            );\n        }\n    });\n\n    app.addRouter(router);\n};\n"],"mappings":"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"}