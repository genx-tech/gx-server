"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  eachAsync_
} = require('rk-utils');

const {
  Runable,
  ServiceContainer
} = require('@genx/app');

const Routable = require('./Routable');

const Literal = require('./enum/Literal');

const {
  defaultBackendPath
} = require('./utils/Helpers');

class WebServer extends Routable(Runable(ServiceContainer)) {
  constructor(name, options) {
    if (typeof options === 'undefined' && _.isPlainObject(name)) {
      options = name;
      name = undefined;
    }

    super(name || 'server', Object.assign({
      configName: Literal.SERVER_CFG_NAME
    }, options));
    this.server = this;
    this.isServer = true;
    this.backendPath = this.toAbsolutePath(this.options.backendPath || defaultBackendPath);
    this.appModulesPath = this.toAbsolutePath(this.options.appModulesPath || Literal.APP_MODULES_PATH);
    this.route = "/";
    this.on('configLoaded', () => {
      this.loadMiddlewaresFrom(path.resolve(__dirname, Literal.MIDDLEWARES_PATH));
    });
  }

  async stop_() {
    if (this.started) {
      if (this.appModules) {
        await eachAsync_(this.appModules, app => app.stop_());
        delete this.appModules;
        delete this.appModulesByAlias;
      }
    }

    if (this.httpServer) {
      await new Promise((resolve, reject) => {
        this.httpServer.close(err => {
          if (err) return reject(err);
          resolve();
        });
      });
      delete this.httpServer;
      this.log('info', `The http service is stopped.`);
    }

    return super.stop_();
  }

  mountApp(app) {
    if (!this.appModules) {
      this.appModules = {};
      this.appModulesByAlias = {};
    }

    if (!!this.appModules.hasOwnProperty(app.route)) {
      throw new Error("Assertion failed: !this.appModules.hasOwnProperty(app.route)");
    }

    this.mountRouter(app.route, app.router);
    this.appModules[app.route] = app;

    if (app.name in this.appModulesByAlias) {
      let existingApp = this.appModulesByAlias[app.name];
      this.appModulesByAlias[`${existingApp.name}[@${existingApp.route}]`] = existingApp;
      delete this.appModulesByAlias[app.name];
      this.appModulesByAlias[`${app.name}[@${app.route}]`] = app;
    } else {
      this.appModulesByAlias[app.name] = app;
    }

    this.log('verbose', `All routes from app [${app.name}] are mounted under "${app.route}".`);
  }

  getAppByRoute(p) {
    return this.appModules[p];
  }

  getAppByAlias(a) {
    return this.appModulesByAlias[a];
  }

  requireFromApp(appName, relativePath) {
    const app = this.getAppByAlias(appName);
    return app.require(relativePath);
  }

  getService(name) {
    let pos = name.indexOf(':');

    if (pos === -1) {
      return super.getService(name);
    }

    let modAlias = name.substr(0, pos);
    name = name.substr(pos + 1);
    let app = this.getAppByAlias(modAlias);
    return app && app.getService(name, true);
  }

  _getFeatureFallbackPath() {
    let pathArray = super._getFeatureFallbackPath();

    pathArray.splice(1, 0, path.resolve(__dirname, Literal.FEATURES_PATH), path.resolve(__dirname, Literal.APP_FEATURES_PATH), path.resolve(__dirname, Literal.SERVER_FEATURES_PATH));
    return pathArray;
  }

}

module.exports = WebServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9XZWJTZXJ2ZXIuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwiZWFjaEFzeW5jXyIsIlJ1bmFibGUiLCJTZXJ2aWNlQ29udGFpbmVyIiwiUm91dGFibGUiLCJMaXRlcmFsIiwiZGVmYXVsdEJhY2tlbmRQYXRoIiwiV2ViU2VydmVyIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImlzUGxhaW5PYmplY3QiLCJ1bmRlZmluZWQiLCJPYmplY3QiLCJhc3NpZ24iLCJjb25maWdOYW1lIiwiU0VSVkVSX0NGR19OQU1FIiwic2VydmVyIiwiaXNTZXJ2ZXIiLCJiYWNrZW5kUGF0aCIsInRvQWJzb2x1dGVQYXRoIiwiYXBwTW9kdWxlc1BhdGgiLCJBUFBfTU9EVUxFU19QQVRIIiwicm91dGUiLCJvbiIsImxvYWRNaWRkbGV3YXJlc0Zyb20iLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiTUlERExFV0FSRVNfUEFUSCIsInN0b3BfIiwic3RhcnRlZCIsImFwcE1vZHVsZXMiLCJhcHAiLCJhcHBNb2R1bGVzQnlBbGlhcyIsImh0dHBTZXJ2ZXIiLCJQcm9taXNlIiwicmVqZWN0IiwiY2xvc2UiLCJlcnIiLCJsb2ciLCJtb3VudEFwcCIsImhhc093blByb3BlcnR5IiwibW91bnRSb3V0ZXIiLCJyb3V0ZXIiLCJleGlzdGluZ0FwcCIsImdldEFwcEJ5Um91dGUiLCJwIiwiZ2V0QXBwQnlBbGlhcyIsImEiLCJyZXF1aXJlRnJvbUFwcCIsImFwcE5hbWUiLCJyZWxhdGl2ZVBhdGgiLCJnZXRTZXJ2aWNlIiwicG9zIiwiaW5kZXhPZiIsIm1vZEFsaWFzIiwic3Vic3RyIiwiX2dldEZlYXR1cmVGYWxsYmFja1BhdGgiLCJwYXRoQXJyYXkiLCJzcGxpY2UiLCJGRUFUVVJFU19QQVRIIiwiQVBQX0ZFQVRVUkVTX1BBVEgiLCJTRVJWRVJfRkVBVFVSRVNfUEFUSCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEs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QUFpQnpELFNBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IF8sIGVhY2hBc3luY18gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IFJ1bmFibGUsIFNlcnZpY2VDb250YWluZXIgfSA9IHJlcXVpcmUoJ0BnZW54L2FwcCcpO1xuY29uc3QgUm91dGFibGUgPSByZXF1aXJlKCcuL1JvdXRhYmxlJyk7XG5jb25zdCBMaXRlcmFsID0gcmVxdWlyZSgnLi9lbnVtL0xpdGVyYWwnKTtcbmNvbnN0IHsgZGVmYXVsdEJhY2tlbmRQYXRoIH0gPSByZXF1aXJlKCcuL3V0aWxzL0hlbHBlcnMnKTtcblxuLyoqXG4gKiBXZWIgc2VydmVyIGNsYXNzLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBSb3V0YWJsZShBcHApXG4gKi9cbmNsYXNzIFdlYlNlcnZlciBleHRlbmRzIFJvdXRhYmxlKFJ1bmFibGUoU2VydmljZUNvbnRhaW5lcikpIHtcbiAgICAvKiogICAgICAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IFtuYW1lPSdzZXJ2ZXInXSAtIFRoZSBuYW1lIG9mIHRoZSBzZXJ2ZXIuICAgICBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gVGhlIGFwcCBtb2R1bGUncyBleHRyYSBvcHRpb25zIGRlZmluZWQgaW4gaXRzIHBhcmVudCdzIGNvbmZpZ3VyYXRpb24uXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLmxvZ2dlcl0gLSBMb2dnZXIgb3B0aW9uc1xuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMudmVyYm9zZT1mYWxzZV0gLSBGbGFnIHRvIG91dHB1dCB0cml2aWFsIGluZm9ybWF0aW9uIGZvciBkaWFnbm9zdGljc1xuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5lbnZdIC0gRW52aXJvbm1lbnQsIGRlZmF1bHQgdG8gcHJvY2Vzcy5lbnYuTk9ERV9FTlZcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMud29ya2luZ1BhdGhdIC0gQXBwJ3Mgd29ya2luZyBwYXRoLCBkZWZhdWx0IHRvIHByb2Nlc3MuY3dkKClcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuY29uZmlnUGF0aF0gLSBBcHAncyBjb25maWcgcGF0aCwgZGVmYXVsdCB0byBcImNvbmZcIiB1bmRlciB3b3JraW5nUGF0aCAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5jb25maWdOYW1lXSAtIEFwcCdzIGNvbmZpZyBiYXNlbmFtZSwgZGVmYXVsdCB0byBcImFwcFwiXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmJhY2tlbmRQYXRoPSdzZXJ2ZXInXSAtIFJlbGF0aXZlIHBhdGggb2YgYmFjay1lbmQgc2VydmVyIHNvdXJjZSBmaWxlc1xuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5jbGllbnRQYXRoPSdjbGllbnQnXSAtIFJlbGF0aXZlIHBhdGggb2YgZnJvbnQtZW5kIGNsaWVudCBzb3VyY2UgZmlsZXMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5wdWJsaWNQYXRoPSdwdWJsaWMnXSAtIFJlbGF0aXZlIHBhdGggb2YgZnJvbnQtZW5kIHN0YXRpYyBmaWxlcyAgICBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuYXBwTW9kdWxlc1BhdGg9YXBwX21vZHVsZXNdIC0gUmVsYXRpdmUgcGF0aCBvZiBjaGlsZCBtb2R1bGVzICAgICAgICAgICAgICAgICAgICBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihuYW1lLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3VuZGVmaW5lZCcgJiYgXy5pc1BsYWluT2JqZWN0KG5hbWUpKSB7XG4gICAgICAgICAgICBvcHRpb25zID0gbmFtZTtcbiAgICAgICAgICAgIG5hbWUgPSB1bmRlZmluZWQ7XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIHN1cGVyKG5hbWUgfHwgJ3NlcnZlcicsIE9iamVjdC5hc3NpZ24oeyBjb25maWdOYW1lOiBMaXRlcmFsLlNFUlZFUl9DRkdfTkFNRSB9LCBvcHRpb25zKSk7ICAgIFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBIb3N0aW5nIHNlcnZlci5cbiAgICAgICAgICogQG1lbWJlciB7V2ViU2VydmVyfVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMuc2VydmVyID0gdGhpcztcblxuICAgICAgICAvKipcbiAgICAgICAgICogV2hldGhlciBpdCBpcyBhIHNlcnZlci5cbiAgICAgICAgICogQG1lbWJlciB7Ym9vbGVhbn1cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLmlzU2VydmVyID0gdHJ1ZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQmFja2VuZCBmaWxlcyBwYXRoLlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9ICAgICAgICAgXG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5iYWNrZW5kUGF0aCA9IHRoaXMudG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLmJhY2tlbmRQYXRoIHx8IGRlZmF1bHRCYWNrZW5kUGF0aCk7IFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBcHAgbW9kdWxlcyBwYXRoLlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmFwcE1vZHVsZXNQYXRoID0gdGhpcy50b0Fic29sdXRlUGF0aCh0aGlzLm9wdGlvbnMuYXBwTW9kdWxlc1BhdGggfHwgTGl0ZXJhbC5BUFBfTU9EVUxFU19QQVRIKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQmFzZSByb3V0ZS5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5yb3V0ZSA9IFwiL1wiO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5vbignY29uZmlnTG9hZGVkJywgKCkgPT4ge1xuICAgICAgICAgICAgLy8gbG9hZCBidWlsdGluIG1pZGRsZXdhcmVzXG4gICAgICAgICAgICB0aGlzLmxvYWRNaWRkbGV3YXJlc0Zyb20ocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgTGl0ZXJhbC5NSURETEVXQVJFU19QQVRIKSk7XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuXG4gICAgYXN5bmMgc3RvcF8oKSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXJ0ZWQpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmFwcE1vZHVsZXMpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBlYWNoQXN5bmNfKHRoaXMuYXBwTW9kdWxlcywgYXBwID0+IGFwcC5zdG9wXygpKTtcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5hcHBNb2R1bGVzO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmFwcE1vZHVsZXNCeUFsaWFzO1xuICAgICAgICAgICAgfSAgICAgXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5odHRwU2VydmVyKSB7XG4gICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5odHRwU2VydmVyLmNsb3NlKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdChlcnIpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmh0dHBTZXJ2ZXI7XG4gICAgICAgICAgICB0aGlzLmxvZygnaW5mbycsIGBUaGUgaHR0cCBzZXJ2aWNlIGlzIHN0b3BwZWQuYCk7IFxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHN1cGVyLnN0b3BfKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTW91bnQgYW4gYXBwIGF0IHNwZWNpZmllZCByb3V0ZS5cbiAgICAgKiBAcGFyYW0ge1dlYk1vZHVsZX0gYXBwIFxuICAgICAqL1xuICAgIG1vdW50QXBwKGFwcCkge1xuICAgICAgICBpZiAoIXRoaXMuYXBwTW9kdWxlcykge1xuICAgICAgICAgICAgdGhpcy5hcHBNb2R1bGVzID0ge307XG4gICAgICAgICAgICB0aGlzLmFwcE1vZHVsZXNCeUFsaWFzID0ge307XG4gICAgICAgIH1cblxuICAgICAgICBhc3NlcnQ6ICF0aGlzLmFwcE1vZHVsZXMuaGFzT3duUHJvcGVydHkoYXBwLnJvdXRlKTtcblxuICAgICAgICB0aGlzLm1vdW50Um91dGVyKGFwcC5yb3V0ZSwgYXBwLnJvdXRlcik7XG4gICAgICAgIFxuICAgICAgICB0aGlzLmFwcE1vZHVsZXNbYXBwLnJvdXRlXSA9IGFwcDtcblxuICAgICAgICBpZiAoYXBwLm5hbWUgaW4gdGhpcy5hcHBNb2R1bGVzQnlBbGlhcykge1xuICAgICAgICAgICAgbGV0IGV4aXN0aW5nQXBwID0gdGhpcy5hcHBNb2R1bGVzQnlBbGlhc1thcHAubmFtZV07XG4gICAgICAgICAgICAvL21vdmUgYnVja2V0XG4gICAgICAgICAgICB0aGlzLmFwcE1vZHVsZXNCeUFsaWFzW2Ake2V4aXN0aW5nQXBwLm5hbWV9W0Ake2V4aXN0aW5nQXBwLnJvdXRlfV1gXSA9IGV4aXN0aW5nQXBwO1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMuYXBwTW9kdWxlc0J5QWxpYXNbYXBwLm5hbWVdO1xuXG4gICAgICAgICAgICB0aGlzLmFwcE1vZHVsZXNCeUFsaWFzW2Ake2FwcC5uYW1lfVtAJHthcHAucm91dGV9XWBdID0gYXBwO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5hcHBNb2R1bGVzQnlBbGlhc1thcHAubmFtZV0gPSBhcHA7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBBbGwgcm91dGVzIGZyb20gYXBwIFske2FwcC5uYW1lfV0gYXJlIG1vdW50ZWQgdW5kZXIgXCIke2FwcC5yb3V0ZX1cIi5gKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGFwcCBtb2R1bGUgb2JqZWN0IGJ5IGJhc2Ugcm91dGVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcCAtIEFwcCBtb2R1bGUgYmFzZSByb3V0ZSBzdGFydGVkIHdpdGggXCIvXCJcbiAgICAgKi9cbiAgICBnZXRBcHBCeVJvdXRlKHApIHtcbiAgICAgICAgLy90b2RvOiBjaGFuZ2UgdG8gcC10cmVlXG4gICAgICAgIHJldHVybiB0aGlzLmFwcE1vZHVsZXNbcF07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSBhcHAgbW9kdWxlIG9iamVjdCBieSBhcHAgYWxpYXMsIHVzdWFsbHkgdGhlIGFwcCBuYW1lIGlmIG5vIGR1cGxpY2F0ZSBlbnRyeVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBhIC0gQXBwIG1vZHVsZSBhbGlhc1xuICAgICAqL1xuICAgIGdldEFwcEJ5QWxpYXMoYSkge1xuICAgICAgICByZXR1cm4gdGhpcy5hcHBNb2R1bGVzQnlBbGlhc1thXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXF1aXJlIGEgbW9kdWxlIGZyb20gdGhlIHNvdXJjZSBwYXRoIG9mIGFuIGFwcCBtb2R1bGVcbiAgICAgKiBAcGFyYW0geyp9IHJlbGF0aXZlUGF0aCBcbiAgICAgKi9cbiAgICByZXF1aXJlRnJvbUFwcChhcHBOYW1lLCByZWxhdGl2ZVBhdGgpIHtcbiAgICAgICAgY29uc3QgYXBwID0gdGhpcy5nZXRBcHBCeUFsaWFzKGFwcE5hbWUpO1xuICAgICAgICByZXR1cm4gYXBwLnJlcXVpcmUocmVsYXRpdmVQYXRoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYSByZWdpc3RlcmVkIHNlcnZpY2VcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBcbiAgICAgKi9cbiAgICBnZXRTZXJ2aWNlKG5hbWUpIHtcbiAgICAgICAgbGV0IHBvcyA9IG5hbWUuaW5kZXhPZignOicpO1xuICAgICAgICBpZiAocG9zID09PSAtMSkge1xuICAgICAgICAgICAgcmV0dXJuIHN1cGVyLmdldFNlcnZpY2UobmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbW9kQWxpYXMgPSBuYW1lLnN1YnN0cigwLCBwb3MpO1xuICAgICAgICBuYW1lID0gbmFtZS5zdWJzdHIocG9zKzEpO1xuXG4gICAgICAgIGxldCBhcHAgPSB0aGlzLmdldEFwcEJ5QWxpYXMobW9kQWxpYXMpO1xuICAgICAgICByZXR1cm4gYXBwICYmIGFwcC5nZXRTZXJ2aWNlKG5hbWUsIHRydWUpO1xuICAgIH1cblxuICAgIF9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoKCkge1xuICAgICAgICBsZXQgcGF0aEFycmF5ID0gc3VwZXIuX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKTtcbiAgICAgICAgcGF0aEFycmF5LnNwbGljZSgxLCAwLCBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBMaXRlcmFsLkZFQVRVUkVTX1BBVEgpLCBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBMaXRlcmFsLkFQUF9GRUFUVVJFU19QQVRIKSwgcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgTGl0ZXJhbC5TRVJWRVJfRkVBVFVSRVNfUEFUSCkpO1xuICAgICAgICByZXR1cm4gcGF0aEFycmF5O1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBXZWJTZXJ2ZXI7Il19