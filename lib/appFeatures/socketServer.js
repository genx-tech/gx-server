"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  urlJoin,
  ensureLeftSlash
} = require('rk-utils');

const {
  Feature
} = require('..').enum;

const {
  Helpers: {
    tryRequire
  }
} = require('@genx/app');

const SocketServer = tryRequire('socket.io');

const {
  InvalidConfiguration
} = require('../utils/Errors');

const DEFAULT_CONTROLLER_PATH = 'events';

function loadEventHandler(appModule, namespace, controllerBasePath, handlerName, isMiddleware = false) {
  let pos = handlerName.lastIndexOf('.');

  if (pos < 0) {
    if (isMiddleware) {
      throw new InvalidConfiguration(`Invalid middleware reference: ${handlerName}`, appModule, namespace ? `socketServer.routes["${namespace}"].middlewares` : 'socketServer.middlewares');
    } else {
      throw new InvalidConfiguration(`Invalid event handler reference: ${handlerName}`, appModule, `socketServer.routes["${namespace}"].events`);
    }
  }

  let controller = handlerName.substr(0, pos);
  let action = handlerName.substr(pos + 1);
  let controllerPath = path.resolve(controllerBasePath, controller + '.js');

  let ctrl = require(controllerPath);

  let middlewareHandler = ctrl[action];

  if (typeof middlewareHandler !== 'function') {
    if (isMiddleware) {
      throw new InvalidConfiguration(`Middleware function not found: ${handlerName}`, appModule, namespace ? `socketServer.routes["${namespace}"].middlewares` : 'socketServer.middlewares');
    } else {
      throw new InvalidConfiguration(`Event handler function not found: ${handlerName}`, appModule, `socketServer.routes["${namespace}"].events`);
    }
  }

  return middlewareHandler;
}

function startSocketServer(appModule, config) {
  let {
    port,
    logger,
    path: wsPath,
    ...options
  } = config;

  if (logger && typeof logger === 'string') {
    logger = appModule.getService('logger.' + logger);
  }

  function log(...args) {
    logger && logger.log(...args);
  }

  let io,
      standalone = false;
  let endpointPath = wsPath ? urlJoin(appModule.route, wsPath) : appModule.route;
  endpointPath = ensureLeftSlash(endpointPath);
  let serviceTag = port ? `socketServer:${port}${endpointPath}` : `socketServer:${endpointPath}`;

  if (appModule.hasService(serviceTag)) {
    throw new InvalidConfiguration('Socket server path or port conflict.', appModule, `socketServer[${i}].(path|port)`);
  }

  options.path = endpointPath;

  if (port) {
    io = new SocketServer(options);
    standalone = true;
    appModule.log('verbose', `A standalone socket server is listening at [port=${port}, path=${endpointPath}].`);
  } else {
    io = new SocketServer(appModule.server.httpServer, options);
    port = appModule.server.port;
    appModule.log('verbose', `A socket server is listening at [path=${endpointPath}].`);
  }

  io.on('connection', socket => {
    log('info', 'client connect', {
      endpoint: endpointPath,
      port,
      id: socket.id,
      ...socket.handshake
    });
  });
  let controllersPath = path.resolve(appModule.backendPath, config.controllersPath || DEFAULT_CONTROLLER_PATH);

  if (config.middlewares) {
    io.use(loadEventHandler(appModule, null, controllersPath, middlewareName, true));
  }

  if (_.isEmpty(config.routes)) {
    throw new InvalidConfiguration('Missing routes config.', appModule, 'socketServer.routes');
  }

  _.forOwn(config.routes, (info, name) => {
    name = ensureLeftSlash(name);
    let namespaceChannel = io.of(name);

    if (info.middlewares) {
      let m = Array.isArray(info.middlewares) ? info.middlewares : [info.middlewares];
      m.forEach(middlewareName => {
        namespaceChannel.use(loadEventHandler(appModule, name, controllersPath, middlewareName, true));
      });
    }

    let eventHandlers;

    if (info.controller) {
      let rpcControllerPath = path.resolve(controllersPath, info.controller + '.js');
      eventHandlers = require(rpcControllerPath);
      appModule.log('verbose', `[${serviceTag}]Controller "${info.controller}" is attached for namespace "${name}".`);
    }

    if (info.events) {
      eventHandlers = {};

      _.forOwn(info.events, (handler, event) => {
        eventHandlers[event] = loadEventHandler(appModule, name, controllersPath, handler);
      });

      appModule.log('verbose', `[${serviceTag}]Event handlers are attached for namespace "${name}".`, {
        events: Object.keys(eventHandlers)
      });
    }

    namespaceChannel.on('connect', function (socket) {
      let ctx = {
        appModule,
        socket
      };
      socket.on('disconnect', () => {
        log('verbose', 'namespace disconnect', {
          endpoint: endpointPath,
          port,
          id: socket.id,
          namespace: name
        });

        if (info.onDisconnect) {
          loadEventHandler(appModule, name, controllersPath, info.onDisconnect)(ctx).catch(error => log('error', error.message));
        }
      });
      log('verbose', 'namespace connect', {
        endpoint: endpointPath,
        port,
        id: socket.id,
        namespace: name
      });
      eventHandlers && _.forOwn(eventHandlers, (handler, event) => {
        socket.on(event, (data, cb) => handler(ctx, data).then(cb));
      });

      if (info.onConnect) {
        loadEventHandler(appModule, name, controllersPath, info.onConnect)(ctx).catch(error => log('error', error.message));
      }
    });
  });

  if (standalone) {
    io.listen(config.port);
  }

  appModule.registerService(serviceTag, io);
  return io;
}

module.exports = {
  type: Feature.PLUGIN,
  load_: (appModule, servers) => {
    if (Array.isArray(servers)) {
      return servers.forEach(server => startSocketServer(appModule, server));
    }

    let io = startSocketServer(appModule, servers);
    appModule.registerService('socketServer', io);
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcHBGZWF0dXJlcy9zb2NrZXRTZXJ2ZXIuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwidXJsSm9pbiIsImVuc3VyZUxlZnRTbGFzaCIsIkZlYXR1cmUiLCJlbnVtIiwiSGVscGVycyIsInRyeVJlcXVpcmUiLCJTb2NrZXRTZXJ2ZXIiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsIkRFRkFVTFRfQ09OVFJPTExFUl9QQVRIIiwibG9hZEV2ZW50SGFuZGxlciIsImFwcE1vZHVsZSIsIm5hbWVzcGFjZSIsImNvbnRyb2xsZXJCYXNlUGF0aCIsImhhbmRsZXJOYW1lIiwiaXNNaWRkbGV3YXJlIiwicG9zIiwibGFzdEluZGV4T2YiLCJjb250cm9sbGVyIiwic3Vic3RyIiwiYWN0aW9uIiwiY29udHJvbGxlclBhdGgiLCJyZXNvbHZlIiwiY3RybCIsIm1pZGRsZXdhcmVIYW5kbGVyIiwic3RhcnRTb2NrZXRTZXJ2ZXIiLCJjb25maWciLCJwb3J0IiwibG9nZ2VyIiwid3NQYXRoIiwib3B0aW9ucyIsImdldFNlcnZpY2UiLCJsb2ciLCJhcmdzIiwiaW8iLCJzdGFuZGFsb25lIiwiZW5kcG9pbnRQYXRoIiwicm91dGUiLCJzZXJ2aWNlVGFnIiwiaGFzU2VydmljZSIsImkiLCJzZXJ2ZXIiLCJodHRwU2VydmVyIiwib24iLCJzb2NrZXQiLCJlbmRwb2ludCIsImlkIiwiaGFuZHNoYWtlIiwiY29udHJvbGxlcnNQYXRoIiwiYmFja2VuZFBhdGgiLCJtaWRkbGV3YXJlcyIsInVzZSIsIm1pZGRsZXdhcmVOYW1lIiwiaXNFbXB0eSIsInJvdXRlcyIsImZvck93biIsImluZm8iLCJuYW1lIiwibmFtZXNwYWNlQ2hhbm5lbCIsIm9mIiwibSIsIkFycmF5IiwiaXNBcnJheSIsImZvckVhY2giLCJldmVudEhhbmRsZXJzIiwicnBjQ29udHJvbGxlclBhdGgiLCJldmVudHMiLCJoYW5kbGVyIiwiZXZlbnQiLCJPYmplY3QiLCJrZXlzIiwiY3R4Iiwib25EaXNjb25uZWN0IiwiY2F0Y2giLCJlcnJvciIsIm1lc3NhZ2UiLCJkYXRhIiwiY2IiLCJ0aGVuIiwib25Db25uZWN0IiwibGlzdGVuIiwicmVnaXN0ZXJTZXJ2aWNlIiwibW9kdWxlIiwiZXhwb3J0cyIsInR5cGUiLCJQTFVHSU4iLCJsb2FkXyIsInNlcnZlcnMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBU0EsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsT0FBTDtBQUFjQyxFQUFBQTtBQUFkLElBQWtDSCxPQUFPLENBQUMsVUFBRCxDQUEvQzs7QUFDQSxNQUFNO0FBQUVJLEVBQUFBO0FBQUYsSUFBY0osT0FBTyxDQUFDLElBQUQsQ0FBUCxDQUFjSyxJQUFsQzs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLE9BQU8sRUFBRTtBQUFFQyxJQUFBQTtBQUFGO0FBQVgsSUFBOEJQLE9BQU8sQ0FBQyxXQUFELENBQTNDOztBQUNBLE1BQU1RLFlBQVksR0FBR0QsVUFBVSxDQUFDLFdBQUQsQ0FBL0I7O0FBQ0EsTUFBTTtBQUFFRSxFQUFBQTtBQUFGLElBQTJCVCxPQUFPLENBQUMsaUJBQUQsQ0FBeEM7O0FBRUEsTUFBTVUsdUJBQXVCLEdBQUcsUUFBaEM7O0FBRUEsU0FBU0MsZ0JBQVQsQ0FBMEJDLFNBQTFCLEVBQXFDQyxTQUFyQyxFQUFnREMsa0JBQWhELEVBQW9FQyxXQUFwRSxFQUFpRkMsWUFBWSxHQUFHLEtBQWhHLEVBQXVHO0FBQ25HLE1BQUlDLEdBQUcsR0FBR0YsV0FBVyxDQUFDRyxXQUFaLENBQXdCLEdBQXhCLENBQVY7O0FBQ0EsTUFBSUQsR0FBRyxHQUFHLENBQVYsRUFBYTtBQUNULFFBQUlELFlBQUosRUFBa0I7QUFDZCxZQUFNLElBQUlQLG9CQUFKLENBQ0QsaUNBQWdDTSxXQUFZLEVBRDNDLEVBRUZILFNBRkUsRUFHRkMsU0FBUyxHQUFJLHdCQUF1QkEsU0FBVSxnQkFBckMsR0FBdUQsMEJB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LEtBQXdCO0FBRTNCLFFBQUkxQixLQUFLLENBQUNDLE9BQU4sQ0FBY3lCLE9BQWQsQ0FBSixFQUE0QjtBQUN4QixhQUFPQSxPQUFPLENBQUN4QixPQUFSLENBQWdCdEIsTUFBTSxJQUFJaEIsaUJBQWlCLENBQUNkLFNBQUQsRUFBWThCLE1BQVosQ0FBM0MsQ0FBUDtBQUNIOztBQUVELFFBQUlQLEVBQUUsR0FBR1QsaUJBQWlCLENBQUNkLFNBQUQsRUFBWTRFLE9BQVosQ0FBMUI7QUFHQTVFLElBQUFBLFNBQVMsQ0FBQ3NFLGVBQVYsQ0FBMEIsY0FBMUIsRUFBMEMvQyxFQUExQztBQUNIO0FBbENZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbi8qKlxuICogU29ja2V0IGJhc2VkIFJwYyBTZXJ2ZXJcbiAqIEBtb2R1bGUgRmVhdHVyZV9Tb2NrZXRTZXJ2ZXJcbiAqIFxuICogbWlkZGxld2FyZTogKHBhY2tldCwgbmV4dCkgPT4ge31cbiAqL1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCB1cmxKb2luLCBlbnN1cmVMZWZ0U2xhc2ggfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IEZlYXR1cmUgfSA9IHJlcXVpcmUoJy4uJykuZW51bTtcbmNvbnN0IHsgSGVscGVyczogeyB0cnlSZXF1aXJlIH0gfSA9IHJlcXVpcmUoJ0BnZW54L2FwcCcpO1xuY29uc3QgU29ja2V0U2VydmVyID0gdHJ5UmVxdWlyZSgnc29ja2V0LmlvJyk7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uIH0gPSByZXF1aXJlKCcuLi91dGlscy9FcnJvcnMnKTtcblxuY29uc3QgREVGQVVMVF9DT05UUk9MTEVSX1BBVEggPSAnZXZlbnRzJztcblxuZnVuY3Rpb24gbG9hZEV2ZW50SGFuZGxlcihhcHBNb2R1bGUsIG5hbWVzcGFjZSwgY29udHJvbGxlckJhc2VQYXRoLCBoYW5kbGVyTmFtZSwgaXNNaWRkbGV3YXJlID0gZmFsc2UpIHtcbiAgICBsZXQgcG9zID0gaGFuZGxlck5hbWUubGFzdEluZGV4T2YoJy4nKTtcbiAgICBpZiAocG9zIDwgMCkge1xuICAgICAgICBpZiAoaXNNaWRkbGV3YXJlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgYEludmFsaWQgbWlkZGxld2FyZSByZWZlcmVuY2U6ICR7aGFuZGxlck5hbWV9YCxcbiAgICAgICAgICAgICAgICBhcHBNb2R1bGUsXG4gICAgICAgICAgICAgICAgbmFtZXNwYWNlID8gYHNvY2tldFNlcnZlci5yb3V0ZXNbXCIke25hbWVzcGFjZX1cIl0ubWlkZGxld2FyZXNgIDogJ3NvY2tldFNlcnZlci5taWRkbGV3YXJlcydcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgYEludmFsaWQgZXZlbnQgaGFuZGxlciByZWZlcmVuY2U6ICR7aGFuZGxlck5hbWV9YCxcbiAgICAgICAgICAgICAgICBhcHBNb2R1bGUsXG4gICAgICAgICAgICAgICAgYHNvY2tldFNlcnZlci5yb3V0ZXNbXCIke25hbWVzcGFjZX1cIl0uZXZlbnRzYFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGxldCBjb250cm9sbGVyID0gaGFuZGxlck5hbWUuc3Vic3RyKDAsIHBvcyk7XG4gICAgbGV0IGFjdGlvbiA9IGhhbmRsZXJOYW1lLnN1YnN0cihwb3MgKyAxKTtcblxuICAgIGxldCBjb250cm9sbGVyUGF0aCA9IHBhdGgucmVzb2x2ZShjb250cm9sbGVyQmFzZVBhdGgsIGNvbnRyb2xsZXIgKyAnLmpzJyk7XG4gICAgbGV0IGN0cmwgPSByZXF1aXJlKGNvbnRyb2xsZXJQYXRoKTtcbiAgICBcbiAgICBsZXQgbWlkZGxld2FyZUhhbmRsZXIgPSBjdHJsW2FjdGlvbl07XG4gICAgaWYgKHR5cGVvZiBtaWRkbGV3YXJlSGFuZGxlciAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBpZiAoaXNNaWRkbGV3YXJlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgYE1pZGRsZXdhcmUgZnVuY3Rpb24gbm90IGZvdW5kOiAke2hhbmRsZXJOYW1lfWAsXG4gICAgICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgICAgIG5hbWVzcGFjZSA/IGBzb2NrZXRTZXJ2ZXIucm91dGVzW1wiJHtuYW1lc3BhY2V9XCJdLm1pZGRsZXdhcmVzYCA6ICdzb2NrZXRTZXJ2ZXIubWlkZGxld2FyZXMnXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgIGBFdmVudCBoYW5kbGVyIGZ1bmN0aW9uIG5vdCBmb3VuZDogJHtoYW5kbGVyTmFtZX1gLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICBgc29ja2V0U2VydmVyLnJvdXRlc1tcIiR7bmFtZXNwYWNlfVwiXS5ldmVudHNgXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG1pZGRsZXdhcmVIYW5kbGVyO1xufVxuXG5mdW5jdGlvbiBzdGFydFNvY2tldFNlcnZlcihhcHBNb2R1bGUsIGNvbmZpZykge1xuICAgIGxldCB7IHBvcnQsIGxvZ2dlciwgcGF0aDogd3NQYXRoLCAuLi5vcHRpb25zIH0gPSBjb25maWc7XG5cbiAgICBpZiAobG9nZ2VyICYmIHR5cGVvZiBsb2dnZXIgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGxvZ2dlciA9IGFwcE1vZHVsZS5nZXRTZXJ2aWNlKCdsb2dnZXIuJyArIGxvZ2dlcik7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gbG9nKC4uLmFyZ3MpIHtcbiAgICAgICAgbG9nZ2VyICYmIGxvZ2dlci5sb2coLi4uYXJncyk7XG4gICAgfVxuXG4gICAgbGV0IGlvLCBzdGFuZGFsb25lID0gZmFsc2U7XG5cbiAgICBsZXQgZW5kcG9pbnRQYXRoID0gd3NQYXRoID8gdXJsSm9pbihhcHBNb2R1bGUucm91dGUsIHdzUGF0aCkgOiBhcHBNb2R1bGUucm91dGU7XG4gICAgZW5kcG9pbnRQYXRoID0gZW5zdXJlTGVmdFNsYXNoKGVuZHBvaW50UGF0aCk7XG5cbiAgICBsZXQgc2VydmljZVRhZyA9IHBvcnQgPyBgc29ja2V0U2VydmVyOiR7cG9ydH0ke2VuZHBvaW50UGF0aH1gIDogYHNvY2tldFNlcnZlcjoke2VuZHBvaW50UGF0aH1gO1xuXG4gICAgaWYgKGFwcE1vZHVsZS5oYXNTZXJ2aWNlKHNlcnZpY2VUYWcpKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdTb2NrZXQgc2VydmVyIHBhdGggb3IgcG9ydCBjb25mbGljdC4nLFxuICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgYHNvY2tldFNlcnZlclske2l9XS4ocGF0aHxwb3J0KWBcbiAgICAgICAgKTtcbiAgICB9ICAgICAgICAgICAgXG5cbiAgICBvcHRpb25zLnBhdGggPSBlbmRwb2ludFBhdGg7XG5cbiAgICBpZiAocG9ydCkge1xuICAgICAgICBpbyA9IG5ldyBTb2NrZXRTZXJ2ZXIob3B0aW9ucyk7XG4gICAgICAgIHN0YW5kYWxvbmUgPSB0cnVlO1xuICAgICAgICBhcHBNb2R1bGUubG9nKCd2ZXJib3NlJywgYEEgc3RhbmRhbG9uZSBzb2NrZXQgc2VydmVyIGlzIGxpc3RlbmluZyBhdCBbcG9ydD0ke3BvcnR9LCBwYXRoPSR7ZW5kcG9pbnRQYXRofV0uYCk7ICAgICAgICBcbiAgICB9IGVsc2Uge1xuICAgICAgICBpbyA9IG5ldyBTb2NrZXRTZXJ2ZXIoYXBwTW9kdWxlLnNlcnZlci5odHRwU2VydmVyLCBvcHRpb25zKTtcbiAgICAgICAgcG9ydCA9IGFwcE1vZHVsZS5zZXJ2ZXIucG9ydDtcbiAgICAgICAgYXBwTW9kdWxlLmxvZygndmVyYm9zZScsIGBBIHNvY2tldCBzZXJ2ZXIgaXMgbGlzdGVuaW5nIGF0IFtwYXRoPSR7ZW5kcG9pbnRQYXRofV0uYCk7ICAgICAgICBcbiAgICB9XG5cbiAgICBpby5vbignY29ubmVjdGlvbicsIHNvY2tldCA9PiB7XG4gICAgICAgIGxvZygnaW5mbycsICdjbGllbnQgY29ubmVjdCcsIHtcbiAgICAgICAgICAgIGVuZHBvaW50OiBlbmRwb2ludFBhdGgsXG4gICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgaWQ6IHNvY2tldC5pZCxcbiAgICAgICAgICAgIC4uLnNvY2tldC5oYW5kc2hha2VcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBsZXQgY29udHJvbGxlcnNQYXRoID0gcGF0aC5yZXNvbHZlKGFwcE1vZHVsZS5iYWNrZW5kUGF0aCwgY29uZmlnLmNvbnRyb2xsZXJzUGF0aCB8fCBERUZBVUxUX0NPTlRST0xMRVJfUEFUSCk7XG5cbiAgICBpZiAoY29uZmlnLm1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGlvLnVzZShsb2FkRXZlbnRIYW5kbGVyKGFwcE1vZHVsZSwgbnVsbCwgY29udHJvbGxlcnNQYXRoLCBtaWRkbGV3YXJlTmFtZSwgdHJ1ZSkpO1xuICAgIH1cblxuICAgIGlmIChfLmlzRW1wdHkoY29uZmlnLnJvdXRlcykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3Npbmcgcm91dGVzIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgJ3NvY2tldFNlcnZlci5yb3V0ZXMnXG4gICAgICAgICk7XG4gICAgfSAgICAgICAgXG5cbiAgICBfLmZvck93bihjb25maWcucm91dGVzLCAoaW5mbywgbmFtZSkgPT4ge1xuICAgICAgICBuYW1lID0gZW5zdXJlTGVmdFNsYXNoKG5hbWUpO1xuXG4gICAgICAgIGxldCBuYW1lc3BhY2VDaGFubmVsID0gaW8ub2YobmFtZSk7XG5cbiAgICAgICAgaWYgKGluZm8ubWlkZGxld2FyZXMpIHtcbiAgICAgICAgICAgIGxldCBtID0gQXJyYXkuaXNBcnJheShpbmZvLm1pZGRsZXdhcmVzKSA/IGluZm8ubWlkZGxld2FyZXMgOiBbIGluZm8ubWlkZGxld2FyZXMgXTtcbiAgICAgICAgICAgIG0uZm9yRWFjaChtaWRkbGV3YXJlTmFtZSA9PiB7XG4gICAgICAgICAgICAgICAgbmFtZXNwYWNlQ2hhbm5lbC51c2UobG9hZEV2ZW50SGFuZGxlcihhcHBNb2R1bGUsIG5hbWUsIGNvbnRyb2xsZXJzUGF0aCwgbWlkZGxld2FyZU5hbWUsIHRydWUpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGV2ZW50SGFuZGxlcnM7XG5cbiAgICAgICAgaWYgKGluZm8uY29udHJvbGxlcikgeyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBycGNDb250cm9sbGVyUGF0aCA9IHBhdGgucmVzb2x2ZShjb250cm9sbGVyc1BhdGgsIGluZm8uY29udHJvbGxlciArICcuanMnKTtcbiAgICAgICAgICAgIGV2ZW50SGFuZGxlcnMgPSByZXF1aXJlKHJwY0NvbnRyb2xsZXJQYXRoKTtcblxuICAgICAgICAgICAgYXBwTW9kdWxlLmxvZygndmVyYm9zZScsIGBbJHtzZXJ2aWNlVGFnfV1Db250cm9sbGVyIFwiJHtpbmZvLmNvbnRyb2xsZXJ9XCIgaXMgYXR0YWNoZWQgZm9yIG5hbWVzcGFjZSBcIiR7bmFtZX1cIi5gKTtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIGlmIChpbmZvLmV2ZW50cykge1xuICAgICAgICAgICAgZXZlbnRIYW5kbGVycyA9IHt9O1xuXG4gICAgICAgICAgICBfLmZvck93bihpbmZvLmV2ZW50cywgKGhhbmRsZXIsIGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgZXZlbnRIYW5kbGVyc1tldmVudF0gPSBsb2FkRXZlbnRIYW5kbGVyKGFwcE1vZHVsZSwgbmFtZSwgY29udHJvbGxlcnNQYXRoLCBoYW5kbGVyKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGFwcE1vZHVsZS5sb2coJ3ZlcmJvc2UnLCBgWyR7c2VydmljZVRhZ31dRXZlbnQgaGFuZGxlcnMgYXJlIGF0dGFjaGVkIGZvciBuYW1lc3BhY2UgXCIke25hbWV9XCIuYCwge1xuICAgICAgICAgICAgICAgIGV2ZW50czogT2JqZWN0LmtleXMoZXZlbnRIYW5kbGVycylcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgbmFtZXNwYWNlQ2hhbm5lbC5vbignY29ubmVjdCcsIGZ1bmN0aW9uIChzb2NrZXQpIHtcbiAgICAgICAgICAgIGxldCBjdHggPSB7IGFwcE1vZHVsZSwgc29ja2V0IH07XG5cbiAgICAgICAgICAgIHNvY2tldC5vbignZGlzY29ubmVjdCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICBsb2coJ3ZlcmJvc2UnLCAnbmFtZXNwYWNlIGRpc2Nvbm5lY3QnLCB7IFxuICAgICAgICAgICAgICAgICAgICBlbmRwb2ludDogZW5kcG9pbnRQYXRoLFxuICAgICAgICAgICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgICAgICAgICBpZDogc29ja2V0LmlkLCBcbiAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlOiBuYW1lIFxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgaWYgKGluZm8ub25EaXNjb25uZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgIGxvYWRFdmVudEhhbmRsZXIoYXBwTW9kdWxlLCBuYW1lLCBjb250cm9sbGVyc1BhdGgsIGluZm8ub25EaXNjb25uZWN0KShjdHgpLmNhdGNoKGVycm9yID0+IGxvZygnZXJyb3InLCBlcnJvci5tZXNzYWdlKSk7ICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSAgICAgXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbG9nKCd2ZXJib3NlJywgJ25hbWVzcGFjZSBjb25uZWN0JywgeyBcbiAgICAgICAgICAgICAgICBlbmRwb2ludDogZW5kcG9pbnRQYXRoLFxuICAgICAgICAgICAgICAgIHBvcnQsXG4gICAgICAgICAgICAgICAgaWQ6IHNvY2tldC5pZCwgXG4gICAgICAgICAgICAgICAgbmFtZXNwYWNlOiBuYW1lIFxuICAgICAgICAgICAgfSk7ICAgICAgICAgICBcblxuICAgICAgICAgICAgLy9SZWdpc3RlciBldmVudCBoYW5kbGVyc1xuICAgICAgICAgICAgZXZlbnRIYW5kbGVycyAmJiBfLmZvck93bihldmVudEhhbmRsZXJzLCAoaGFuZGxlciwgZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBzb2NrZXQub24oZXZlbnQsIChkYXRhLCBjYikgPT4gaGFuZGxlcihjdHgsIGRhdGEpLnRoZW4oY2IpKTtcbiAgICAgICAgICAgIH0pOyAgICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgaWYgKGluZm8ub25Db25uZWN0KSB7XG4gICAgICAgICAgICAgICAgbG9hZEV2ZW50SGFuZGxlcihhcHBNb2R1bGUsIG5hbWUsIGNvbnRyb2xsZXJzUGF0aCwgaW5mby5vbkNvbm5lY3QpKGN0eCkuY2F0Y2goZXJyb3IgPT4gbG9nKCdlcnJvcicsIGVycm9yLm1lc3NhZ2UpKTsgICAgICAgICAgICBcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpZiAoc3RhbmRhbG9uZSkge1xuICAgICAgICBpby5saXN0ZW4oY29uZmlnLnBvcnQpO1xuICAgIH1cblxuICAgIGFwcE1vZHVsZS5yZWdpc3RlclNlcnZpY2Uoc2VydmljZVRhZywgaW8pO1xuXG4gICAgcmV0dXJuIGlvO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblxuICAgIC8qKlxuICAgICAqIFRoaXMgZmVhdHVyZSBpcyBsb2FkZWQgYXQgcGx1Z2luIHN0YWdlXG4gICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAqL1xuICAgIHR5cGU6IEZlYXR1cmUuUExVR0lOLFxuXG4gICAgLyoqXG4gICAgICogVGhlIHNvY2tldCBzZXJ2ZXIgb3B0aW9ucy5cbiAgICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBTZXJ2ZXJPcHRpb25zXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtwYXRoPS9zb2NrZXQuaW9dIC0gbmFtZSBvZiB0aGUgcGF0aCB0byBjYXB0dXJlXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbc2VydmVDbGllbnQ9dHJ1ZV0gLSB3aGV0aGVyIHRvIHNlcnZlIHRoZSBjbGllbnQgZmlsZXNcbiAgICAgKiBAcHJvcGVydHkge0FkYXB0ZXJ9IGFkYXB0ZXIgLSB0aGUgYWRhcHRlciB0byB1c2UuIERlZmF1bHRzIHRvIGFuIGluc3RhbmNlIG9mIHRoZSBBZGFwdGVyIHRoYXQgc2hpcHMgd2l0aCBzb2NrZXQuaW8gd2hpY2ggaXMgbWVtb3J5IGJhc2VkLiBTZWUgc29ja2V0LmlvLWFkYXB0ZXJcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gb3JpZ2lucyAtIHRoZSBhbGxvd2VkIG9yaWdpbnNcbiAgICAgKiBAcHJvcGVydHkge1BhcnNlcn0gcGFyc2VyIC0gdGhlIHBhcnNlciB0byB1c2UuIERlZmF1bHRzIHRvIGFuIGluc3RhbmNlIG9mIHRoZSBQYXJzZXIgdGhhdCBzaGlwcyB3aXRoIHNvY2tldC5pby4gU2VlIHNvY2tldC5pby1wYXJzZXJcbiAgICAgKiBAc2VlIHtAbGluayBodHRwczovL3NvY2tldC5pby9kb2NzL3NlcnZlci1hcGkvfSBmb3IgbW9yZSBvcHRpb25zXG4gICAgICovXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIHRoZSBycGMgU2VydmVyXG4gICAgICogQHBhcmFtIHtBcHBNb2R1bGV9IGFwcE1vZHVsZSAtIFRoZSBhcHAgbW9kdWxlIG9iamVjdFxuICAgICAqIEBwYXJhbSB7U2VydmVyT3B0aW9uc1tdfSBzZXJ2ZXJzIC0gUnBjIHNlcnZlciBjb25maWdcbiAgICAgKi9cbiAgICBsb2FkXzogKGFwcE1vZHVsZSwgc2VydmVycykgPT4geyAgICAgICAgXG5cbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc2VydmVycykpIHtcbiAgICAgICAgICAgIHJldHVybiBzZXJ2ZXJzLmZvckVhY2goc2VydmVyID0+IHN0YXJ0U29ja2V0U2VydmVyKGFwcE1vZHVsZSwgc2VydmVyKSk7ICAgICAgICAgICAgXG4gICAgICAgIH1cblxuICAgICAgICBsZXQgaW8gPSBzdGFydFNvY2tldFNlcnZlcihhcHBNb2R1bGUsIHNlcnZlcnMpO1xuXG4gICAgICAgIC8vZGVmYXVsdCBzb2NrZXQgc2VydmVyXG4gICAgICAgIGFwcE1vZHVsZS5yZWdpc3RlclNlcnZpY2UoJ3NvY2tldFNlcnZlcicsIGlvKTtcbiAgICB9XG59OyJdfQ==