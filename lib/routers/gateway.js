"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('@koa/router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  MethodNotAllowed
} = require('../utils/Errors');

const validator = require('validator');

function ensureInt(name, value) {
  let sanitized = _.isInteger(value) ? value : validator.toInt(value);

  if (isNaN(sanitized)) {
    throw new BadRequest(`"${name}" should be an integer.`);
  }

  return sanitized;
}

function processKeyValuePair(ctx, meta, assocs, queries, key, value) {
  let lastDot = key.lastIndexOf('.');

  if (lastDot > 0) {
    let lastPart = key.substr(lastDot + 1);
    let leftPart = key.substr(0, lastDot);

    if (lastPart.startsWith('$')) {
      value = {
        [lastPart]: value
      };
      return processKeyValuePair(ctx, meta, assocs, queries, leftPart, value);
    }

    assocs.add(leftPart);
    queries.push({
      [key]: value
    });
  } else if (key in meta.fields) {
    queries.push({
      [key]: value
    });
  } else {
    throw new BadRequest(`Unknown query field "${key}".`);
  }
}

function processQuery(ctx, apiInfo, meta) {
  let condition = {};
  let queries = apiInfo.where ? [apiInfo.where] : [];
  let assocs = new Set();
  let {
    $orderBy,
    $offset,
    $limit,
    $returnTotal,
    $exist,
    $notExist
  } = ctx.query;

  if ($exist) {
    $exist = _.castArray($exist);
    $exist.map(item => queries.push({
      [item]: {
        $ne: null
      }
    }));
  }

  if ($notExist) {
    $notExist = _.castArray($notExist);
    $notExist.map(item => queries.push({
      [item]: {
        $eq: null
      }
    }));
  }

  if ($orderBy) {
    let orderBy;

    if (meta) {
      orderBy = {};

      let rawOrderBy = _.castArray($orderBy);

      rawOrderBy.forEach(byField => {
        let ascend = true;

        if (byField.startsWith('>')) {
          ascend = false;
          byField = byField.substr(1);
        } else if (byField.startsWith('<')) {
          byField = byField.substr(1);
        }

        if (byField.startsWith(':')) {
          byField = byField.substr(1);
        } else if (!(byField in meta.fields)) {
          throw new BadRequest(`Unknown orderBy field "${byField}".`);
        }

        orderBy[byField] = ascend;
      });
    } else {
      orderBy = apiInfo.orderBy[$orderBy];

      if (!orderBy) {
        throw new BadRequest(`Order by "${orderBy}" is not supported.`);
      }
    }

    condition.$orderBy = orderBy;
  } else if (apiInfo.orderBy && apiInfo.orderBy['$default']) {
    condition.$orderBy = apiInfo.orderBy['$default'];
  }

  if ($offset) {
    condition.$offset = ensureInt('$offset', $offset);
  }

  if ($limit) {
    condition.$limit = ensureInt('$limit', $limit);
  }

  if ($returnTotal) {
    if ($returnTotal === '1' || $returnTotal === 'true') {
      condition.$totalCount = true;
    } else {
      condition.$totalCount = $returnTotal;
    }
  }

  if (!_.isEmpty(apiInfo.query)) {
    _.forOwn(apiInfo.query, (info, param) => {
      if (param in ctx.query) {
        queries.push(info.where);
      }
    });
  } else if (meta) {
    _.forOwn(ctx.query, (value, key) => {
      if (key.startsWith('$')) return;

      if (key.startsWith(':')) {
        let assoc = key.substr(1);

        if (_.isNil(value) || value !== '0') {
          assocs.add(assoc);
        }
      } else {
        processKeyValuePair(ctx, meta, assocs, queries, key, value);
      }
    });
  }

  let l = queries.length;

  if (l > 0) {
    condition.$query = l > 1 ? {
      $and: queries
    } : queries[0];
  }

  if (assocs.size > 0) {
    condition.$association = Array.from(assocs);
  }

  return condition;
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(), 'jsonError');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let descEndpoint = options.metadataEndpoint || '/_desc';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    let db = ctx.appModule.db(options.schemaName);

    _.forOwn(entityModels, (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      let keyFieldName;

      if (config.type === 'view') {
        keyFieldName = config.key || db.model(config.selectFrom).meta.keyField;
      } else {
        keyFieldName = db.model(entityName).meta.keyField;
      }

      keyFieldName = ':' + keyFieldName;
      let singleUrl = urlJoin(baseRoute, entityNameInUrl, keyFieldName);
      let batchUrl = urlJoin(baseRoute, entityNameInUrl);
      let descUrl = app.toWebPath(urlJoin(baseRoute, '_desc', _.kebabCase(entityName)));
      list.push({
        type: 'list',
        method: 'get',
        url: batchUrl,
        apiDesc: descUrl
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: singleUrl
      });

      if (!config.readOnly) {
        list.push({
          type: 'create',
          method: 'post',
          url: batchUrl
        });
        list.push({
          type: 'update',
          method: 'put',
          url: singleUrl
        });
        list.push({
          type: 'delete',
          method: 'del',
          url: singleUrl
        });
      }
    });

    ctx.body = list;
  });
  app.addRoute(router, 'get', urlJoin(descEndpoint, ':entity'), async ctx => {
    let list;
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let config = entityModels[entityName];
    let EntityModel;

    if (config.type === 'view') {
      list = {
        'type': 'view',
        'mainEntity': config.selectFrom
      };

      if (config.joinWith) {
        list.associations = config.joinWith;
      }

      if (config.where) {
        list.where = config.where;
      }

      if (config.key) {
        list.key = config.key;
      }

      EntityModel = db.model(config.selectFrom);

      if (config.query) {
        list.query = _.mapValues(config.query, info => info.desc);
      }

      if (config.orderBy) {
        list.orderBy = config.orderBy;
      }
    } else {
      list = {
        'type': 'entity',
        'entity': entityName
      };
      EntityModel = db.model(entityName);
      list.query = _.mapValues(EntityModel.meta.fields, info => info.displayName);
    }

    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      let apiInfo = entityModels[entityName];

      if (!apiInfo) {
        throw new BadRequest('Entity endpoint not found.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(apiInfo.type && apiInfo.type === 'view' ? apiInfo.selectFrom : entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions, EntityModel;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      queryOptions = { ...processQuery(ctx, apiInfo),
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      queryOptions = { ...processQuery(ctx, apiInfo, EntityModel.meta)
      };
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel, queryOptions, keyField;
    let keyValue = ctx.params.id;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      keyField = apiInfo.key || EntityModel.meta.keyField;
      queryOptions = {
        $query: {
          [keyField]: keyValue,
          ...apiInfo.where
        },
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      keyField = EntityModel.meta.keyField;
      let assocs = [];

      _.forOwn(ctx.query, (value, key) => {
        if (key.startsWith(':') && (_.isNil(value) || value !== '0')) {
          assocs.push(key.substr(1));
        }
      });

      queryOptions = {
        $query: {
          [keyField]: keyValue
        }
      };

      if (assocs.length > 0) {
        queryOptions.$association = assocs;
      }
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.NOT_FOUND, `"${EntityModel.meta.name}" with [${keyField}=${keyValue}] not found.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let {
      where,
      data
    } = ctx.request.body;
    let model = await EntityModel.updateMany_(data, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.updateOne_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let deleted = await EntityModel.deleteOne_({
      $query: where,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = {
      status: 'OK',
      deleted
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwidXJsSm9pbiIsImdldFZhbHVlQnlQYXRoIiwicmVxdWlyZSIsIlJvdXRlciIsIkh0dHBDb2RlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJCYWRSZXF1ZXN0IiwiTWV0aG9kTm90QWxsb3dlZCIsInZhbGlkYXRvciIsImVuc3VyZUludCIsIm5hbWUiLCJ2YWx1ZSIsInNhbml0aXplZCIsImlzSW50ZWdlciIsInRvSW50IiwiaXNOYU4iLCJwcm9jZXNzS2V5VmFsdWVQYWlyIiwiY3R4IiwibWV0YSIsImFzc29jcyIsInF1ZXJpZXMiLCJrZXkiLCJsYXN0RG90IiwibGFzdEluZGV4T2YiLCJsYXN0UGFydCIsInN1YnN0ciIsImxlZnRQYXJ0Iiwic3RhcnRzV2l0aCIsImFkZCIsInB1c2giLCJmaWVsZHMiLCJwcm9jZXNzUXVlcnkiLCJhcGlJbmZvIiwiY29uZGl0aW9uIiwid2hlcmUiLCJTZXQiLCIkb3JkZXJCeSIsIiRvZmZzZXQiLCIkbGltaXQiLCIkcmV0dXJuVG90YWwiLCIkZXhpc3QiLCIkbm90RXhpc3QiLCJxdWVyeSIsImNhc3RBcnJheSIsIm1hcCIsIml0ZW0iLCIkbmUiLCIkZXEiLCJvcmRlckJ5IiwicmF3T3JkZXJCeSIsImZvckVhY2giLCJieUZpZWxkIiwiYXNjZW5kIiwiJHRvdGFsQ291bnQiLCJpc0VtcHR5IiwiZm9yT3duIiwiaW5mbyIsInBhcmFtIiwiYXNzb2MiLCJpc05pbCIsImwiLCJsZW5ndGgiLCIkcXVlcnkiLCIkYW5kIiwic2l6ZSIsIiRhc3NvY2lhdGlvbiIsIkFycmF5IiwiZnJvbSIsIm1vZHVsZSIsImV4cG9ydHMiLCJhcHAiLCJiYXNlUm91dGUiLCJvcHRpb25zIiwic2NoZW1hTmFtZSIsImVudGl0eU1vZGVscyIsInJvdXRlciIsInByZWZpeCIsInVzZU1pZGRsZXdhcmUiLCJnZXRNaWRkbGV3YXJlRmFjdG9yeSIsIm1pZGRsZXdhcmVzIiwidXNlTWlkZGxld2FyZXMiLCJhcGlMaXN0RW5kcG9pbnQiLCJtZXRhZGF0YUVuZHBvaW50IiwiZGVzY0VuZHBvaW50IiwicmVhZEpzb25TeW5jIiwidG9BYnNvbHV0ZVBhdGgiLCJhZGRSb3V0ZSIsImxpc3QiLCJkYiIsImFwcE1vZHVsZSIsImNvbmZpZyIsImVudGl0eU5hbWUiLCJlbnRpdHlOYW1lSW5VcmwiLCJrZWJhYkNhc2UiLCJrZXlGaWVsZE5hbWUiLCJ0eXBlIiwibW9kZWwiLCJzZWxlY3RGcm9tIiwia2V5RmllbGQiLCJzaW5nbGVVcmwiLCJiYXRjaFVybCIsImRlc2NVcmwiLCJ0b1dlYlBhdGgiLCJtZXRob2QiLCJ1cmwiLCJhcGlEZXNjIiwicmVhZE9ubHkiLCJib2R5IiwiY2FtZWxDYXNlIiwicGFyYW1zIiwiZW50aXR5IiwiRW50aXR5TW9kZWwiLCJqb2luV2l0aCIsImFzc29jaWF0aW9ucyIsIm1hcFZhbHVlcyIsImRlc2MiLCJkaXNwbGF5TmFtZSIsImVudiIsImZpbHRlciIsInRocm93IiwiQkFEX1JFUVVFU1QiLCJleHBvc2UiLCJxdWVyeU9wdGlvbnMiLCIkdmFyaWFibGVzIiwic2Vzc2lvbiIsInNlc3Npb25WYXJpYWJsZXMiLCJmaW5kQWxsXyIsImtleVZhbHVlIiwiaWQiLCJmaW5kT25lXyIsIk5PVF9GT1VORCIsImNyZWF0ZV8iLCJyZXF1ZXN0IiwiJHJldHJpZXZlQ3JlYXRlZCIsImRhdGEiLCJ1cGRhdGVNYW55XyIsIiRyZXRyaWV2ZVVwZGF0ZWQiLCJ1cGRhdGVPbmVfIiwiZGVsZXRlZCIsImRlbGV0ZU9uZV8iLCJzdGF0dXMiLCJhZGRSb3V0ZXIiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTTtBQUFFQSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUEsT0FBVDtBQUFrQkMsRUFBQUE7QUFBbEIsSUFBcUNDLE9BQU8sQ0FBQyxVQUFELENBQWxEOztBQUNBLE1BQU1DLE1BQU0sR0FBR0QsT0FBTyxDQUFDLGFBQUQsQ0FBdEI7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QUFBLE1BQU0sRUFBRTVCLEtBRCtCO0FBRXZDeUYsTUFBQUEsVUFBVSxFQUFFO0FBQ1JDLFFBQUFBLE9BQU8sRUFBRTNHLEdBQUcsQ0FBQzRHLGdCQURMO0FBRVJuRixRQUFBQSxLQUFLLEVBQUV6QixHQUFHLENBQUN5QjtBQUZIO0FBRjJCLEtBQXZCLENBQXBCO0FBUUF6QixJQUFBQSxHQUFHLENBQUMwRixJQUFKLEdBQVc7QUFBRWlDLE1BQUFBLE1BQU0sRUFBRSxJQUFWO0FBQWdCRixNQUFBQTtBQUFoQixLQUFYO0FBQ0gsR0ExQkQ7QUE0QkFwRSxFQUFBQSxHQUFHLENBQUN1RSxTQUFKLENBQWNsRSxNQUFkO0FBQ0gsQ0FqV0QiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBfLCBmcywgdXJsSm9pbiwgZ2V0VmFsdWVCeVBhdGggfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCBSb3V0ZXIgPSByZXF1aXJlKCdAa29hL3JvdXRlcicpO1xuY29uc3QgSHR0cENvZGUgPSByZXF1aXJlKCdodHRwLXN0YXR1cy1jb2RlcycpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiwgQmFkUmVxdWVzdCwgTWV0aG9kTm90QWxsb3dlZCB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvRXJyb3JzJyk7XG5jb25zdCB2YWxpZGF0b3IgPSByZXF1aXJlKCd2YWxpZGF0b3InKTtcblxuLyoqXG4gKiBSRVNUZnVsIHJvdXRlci5cbiAqIEBtb2R1bGUgUm91dGVyX1Jlc3RcbiAqL1xuXG5mdW5jdGlvbiBlbnN1cmVJbnQobmFtZSwgdmFsdWUpIHtcbiAgICBsZXQgc2FuaXRpemVkID0gXy5pc0ludGVnZXIodmFsdWUpID8gdmFsdWUgOiB2YWxpZGF0b3IudG9JbnQodmFsdWUpO1xuICAgIGlmIChpc05hTihzYW5pdGl6ZWQpKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KGBcIiR7bmFtZX1cIiBzaG91bGQgYmUgYW4gaW50ZWdlci5gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2FuaXRpemVkO1xufVxuXG5mdW5jdGlvbiBwcm9jZXNzS2V5VmFsdWVQYWlyKGN0eCwgbWV0YSwgYXNzb2NzLCBxdWVyaWVzLCBrZXksIHZhbHVlKSB7XG4gICAgbGV0IGxhc3REb3QgPSBrZXkubGFzdEluZGV4T2YoJy4nKTtcblxuICAgIGlmIChsYXN0RG90ID4gMCkge1xuICAgICAgICBsZXQgbGFzdFBhcnQgPSBrZXkuc3Vic3RyKGxhc3REb3QrMSk7XG4gICAgICAgIGxldCBsZWZ0UGFydCA9IGtleS5zdWJzdHIoMCwgbGFzdERvdCk7XG4gICAgICAgIFxuICAgICAgICBpZiAobGFzdFBhcnQuc3RhcnRzV2l0aCgnJCcpKSB7XG4gICAgICAgICAgICB2YWx1ZSA9IHsgW2xhc3RQYXJ0XTogdmFsdWUgfTtcblxuICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3NLZXlWYWx1ZVBhaXIoY3R4LCBtZXRhLCBhc3NvY3MsIHF1ZXJpZXMsIGxlZnRQYXJ0LCB2YWx1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBhc3NvY3MuYWRkKGxlZnRQYXJ0KTtcbiAgICAgICAgcXVlcmllcy5wdXNoKHsgW2tleV06IHZhbHVlIH0pO1xuICAgIH0gZWxzZSBpZiAoKGtleSBpbiBtZXRhLmZpZWxkcykpIHtcbiAgICAgICAgcXVlcmllcy5wdXNoKHsgW2tleV06IHZhbHVlIH0pOyAgICAgICAgICAgICBcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdChgVW5rbm93biBxdWVyeSBmaWVsZCBcIiR7a2V5fVwiLmApO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gcHJvY2Vzc1F1ZXJ5KGN0eCwgYXBpSW5mbywgbWV0YSkgeyAgICBcbiAgICBsZXQgY29uZGl0aW9uID0ge307XG4gICAgbGV0IHF1ZXJpZXMgPSBhcGlJbmZvLndoZXJlID8gWyBhcGlJbmZvLndoZXJlIF0gOiBbXTtcbiAgICBsZXQgYXNzb2NzID0gbmV3IFNldCgpO1xuXG4gICAgbGV0IHsgJG9yZGVyQnksICRvZmZzZXQsICRsaW1pdCwgJHJldHVyblRvdGFsLCAkZXhpc3QsICRub3RFeGlzdCB9ID0gY3R4LnF1ZXJ5O1xuXG4gICAgaWYgKCRleGlzdCkge1xuICAgICAgICAkZXhpc3QgPSBfLmNhc3RBcnJheSgkZXhpc3QpO1xuICAgICAgICAkZXhpc3QubWFwKGl0ZW0gPT4gcXVlcmllcy5wdXNoKHtbaXRlbV06IHsgJG5lOiBudWxsIH19KSk7ICAgICAgICBcbiAgICB9XG5cbiAgICBpZiAoJG5vdEV4aXN0KSB7XG4gICAgICAgICRub3RFeGlzdCA9IF8uY2FzdEFycmF5KCRub3RFeGlzdCk7XG4gICAgICAgICRub3RFeGlzdC5tYXAoaXRlbSA9PiBxdWVyaWVzLnB1c2goe1tpdGVtXTogeyAkZXE6IG51bGwgfX0pKTsgICAgICAgIFxuICAgIH1cbiAgICAgICAgXG4gICAgaWYgKCRvcmRlckJ5KSB7XG4gICAgICAgIGxldCBvcmRlckJ5O1xuXG4gICAgICAgIGlmIChtZXRhKSB7XG4gICAgICAgICAgICBvcmRlckJ5ID0ge307XG4gICAgICAgICAgICBsZXQgcmF3T3JkZXJCeSA9IF8uY2FzdEFycmF5KCRvcmRlckJ5KTtcbiAgICAgICAgICAgIHJhd09yZGVyQnkuZm9yRWFjaChieUZpZWxkID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgYXNjZW5kID0gdHJ1ZTtcblxuICAgICAgICAgICAgICAgIGlmIChieUZpZWxkLnN0YXJ0c1dpdGgoJz4nKSkge1xuICAgICAgICAgICAgICAgICAgICBhc2NlbmQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgYnlGaWVsZCA9IGJ5RmllbGQuc3Vic3RyKDEpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYnlGaWVsZC5zdGFydHNXaXRoKCc8JykpIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBieUZpZWxkID0gYnlGaWVsZC5zdWJzdHIoMSk7XG4gICAgICAgICAgICAgICAgfSBcblxuICAgICAgICAgICAgICAgIGlmIChieUZpZWxkLnN0YXJ0c1dpdGgoJzonKSkge1xuICAgICAgICAgICAgICAgICAgICBieUZpZWxkID0gYnlGaWVsZC5zdWJzdHIoMSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCEoYnlGaWVsZCBpbiBtZXRhLmZpZWxkcykpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoYFVua25vd24gb3JkZXJCeSBmaWVsZCBcIiR7YnlGaWVsZH1cIi5gKVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIG9yZGVyQnlbYnlGaWVsZF0gPSBhc2NlbmQ7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb3JkZXJCeSA9IGFwaUluZm8ub3JkZXJCeVskb3JkZXJCeV07XG4gICAgICAgICAgICBpZiAoIW9yZGVyQnkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdChgT3JkZXIgYnkgXCIke29yZGVyQnl9XCIgaXMgbm90IHN1cHBvcnRlZC5gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbmRpdGlvbi4kb3JkZXJCeSA9IG9yZGVyQnk7XG4gICAgfSBlbHNlIGlmIChhcGlJbmZvLm9yZGVyQnkgJiYgYXBpSW5mby5vcmRlckJ5WyckZGVmYXVsdCddKSB7XG4gICAgICAgIGNvbmRpdGlvbi4kb3JkZXJCeSA9IGFwaUluZm8ub3JkZXJCeVsnJGRlZmF1bHQnXTtcbiAgICB9XG5cbiAgICBpZiAoJG9mZnNldCkgeyAgICAgICAgXG4gICAgICAgIGNvbmRpdGlvbi4kb2Zmc2V0ID0gZW5zdXJlSW50KCckb2Zmc2V0JywgJG9mZnNldCk7XG4gICAgfVxuXG4gICAgaWYgKCRsaW1pdCkge1xuICAgICAgICBjb25kaXRpb24uJGxpbWl0ID0gZW5zdXJlSW50KCckbGltaXQnLCAkbGltaXQpO1xuICAgIH0gICAgXG5cbiAgICBpZiAoJHJldHVyblRvdGFsKSB7ICAgXG4gICAgICAgIGlmICgkcmV0dXJuVG90YWwgPT09ICcxJyB8fCAkcmV0dXJuVG90YWwgPT09ICd0cnVlJykge1xuICAgICAgICAgICAgY29uZGl0aW9uLiR0b3RhbENvdW50ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHsgICAgICAgIFxuICAgICAgICAgICAgY29uZGl0aW9uLiR0b3RhbENvdW50ID0gJHJldHVyblRvdGFsO1xuICAgICAgICB9XG4gICAgfSAgICBcblxuICAgIGlmICghXy5pc0VtcHR5KGFwaUluZm8ucXVlcnkpKSB7XG4gICAgICAgIF8uZm9yT3duKGFwaUluZm8ucXVlcnksIChpbmZvLCBwYXJhbSkgPT4ge1xuICAgICAgICAgICAgaWYgKHBhcmFtIGluIGN0eC5xdWVyeSkge1xuICAgICAgICAgICAgICAgIHF1ZXJpZXMucHVzaChpbmZvLndoZXJlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChtZXRhKSB7XG4gICAgICAgIF8uZm9yT3duKGN0eC5xdWVyeSwgKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aCgnJCcpKSByZXR1cm47IFxuXG4gICAgICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoJzonKSkge1xuICAgICAgICAgICAgICAgIGxldCBhc3NvYyA9IGtleS5zdWJzdHIoMSk7XG4gICAgICAgICAgICAgICAgaWYgKF8uaXNOaWwodmFsdWUpIHx8IHZhbHVlICE9PSAnMCcpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzb2NzLmFkZChhc3NvYyk7XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcHJvY2Vzc0tleVZhbHVlUGFpcihjdHgsIG1ldGEsIGFzc29jcywgcXVlcmllcywga2V5LCB2YWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0gICBcblxuICAgIGxldCBsID0gcXVlcmllcy5sZW5ndGg7XG4gICAgaWYgKGwgPiAwKSB7XG4gICAgICAgIGNvbmRpdGlvbi4kcXVlcnkgPSBsID4gMSA/IHsgJGFuZDogcXVlcmllcyB9IDogcXVlcmllc1swXTtcbiAgICB9XG5cbiAgICBpZiAoYXNzb2NzLnNpemUgPiAwKSB7XG4gICAgICAgIGNvbmRpdGlvbi4kYXNzb2NpYXRpb24gPSBBcnJheS5mcm9tKGFzc29jcyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbmRpdGlvbjtcbn1cblxuLyoqXG4gKiBDcmVhdGUgYSBSRVNUZnVsIHJvdXRlci5cbiAqIEBwYXJhbSB7Kn0gYXBwIFxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2VSb3V0ZSBcbiAqIEBwYXJhbSB7b2JqZWN0c30gb3B0aW9ucyBcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5yZXNvdXJjZXNQYXRoXVxuICogQHByb3BlcnR5IHtvYmplY3R8YXJyYXl9IFtvcHRpb25zLm1pZGRsZXdhcmVzXVxuICogQGV4YW1wbGVcbiAqICAnPGJhc2UgcGF0aD4nOiB7XG4gKiAgICAgIGdhdGV3YXk6IHsgICAgICAgICAgXG4gKiAgICAgICAgICBtaWRkbGV3YXJlczoge30sXG4gKiAgICAgICAgICBzY2hlbWFOYW1lOiAnJyxcbiAqICAgICAgICAgIGVudGl0eU1vZGVsczoge318PGNvbmZpZyBwYXRoPiwgIFxuICogICAgICAgICAgYXBpTGlzdEVuZHBvaW50OiAnL19saXN0JyxcbiAqICAgICAgICAgIG1ldGFkYXRhRW5kcG9pbnQ6ICcvX21ldGEnXG4gKiAgICAgIH1cbiAqICB9XG4gKiAgXG4gKiAgcm91dGUgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAgbWV0aG9kICAgIGZ1bmN0aW9uIG9mIGN0cmxcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgcXVlcnlcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgcG9zdCAgICAgICAgICAgY3JlYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIGRldGFpbFxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBwdXQgICAgICAgICAgICB1cGRhdGVcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZGVsZXRlICAgICAgICAgcmVtb3ZlIFxuICovXG5tb2R1bGUuZXhwb3J0cyA9IChhcHAsIGJhc2VSb3V0ZSwgb3B0aW9ucykgPT4ge1xuICAgIGlmICghb3B0aW9ucy5zY2hlbWFOYW1lKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIHNjaGVtYSBuYW1lIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgYHJvdXRpbmcuJHtiYXNlUm91dGV9LmdhdGV3YXkuc2NoZW1hTmFtZWBcbiAgICAgICAgKTtcbiAgICB9ICAgIFxuXG4gICAgaWYgKCFvcHRpb25zLmVudGl0eU1vZGVscykge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAnTWlzc2luZyBlbnRpdHkgbW9kZWxzIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgYHJvdXRpbmcuJHtiYXNlUm91dGV9LmdhdGV3YXkuZW50aXR5TW9kZWxzYFxuICAgICAgICApOyAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIGxldCByb3V0ZXIgPSBiYXNlUm91dGUgPT09ICcvJyA/IG5ldyBSb3V0ZXIoKSA6IG5ldyBSb3V0ZXIoe3ByZWZpeDogYmFzZVJvdXRlfSk7XG5cbiAgICBhcHAudXNlTWlkZGxld2FyZShyb3V0ZXIsIGFwcC5nZXRNaWRkbGV3YXJlRmFjdG9yeSgnanNvbkVycm9yJykoKSwgJ2pzb25FcnJvcicpO1xuXG4gICAgaWYgKG9wdGlvbnMubWlkZGxld2FyZXMpIHtcbiAgICAgICAgYXBwLnVzZU1pZGRsZXdhcmVzKHJvdXRlciwgb3B0aW9ucy5taWRkbGV3YXJlcyk7XG4gICAgfVxuXG4gICAgbGV0IGFwaUxpc3RFbmRwb2ludCA9IG9wdGlvbnMuYXBpTGlzdEVuZHBvaW50IHx8ICcvX2xpc3QnO1xuICAgIGxldCBtZXRhZGF0YUVuZHBvaW50ID0gb3B0aW9ucy5tZXRhZGF0YUVuZHBvaW50IHx8ICcvX2luZm8nO1xuICAgIGxldCBkZXNjRW5kcG9pbnQgPSBvcHRpb25zLm1ldGFkYXRhRW5kcG9pbnQgfHwgJy9fZGVzYyc7XG5cbiAgICBsZXQgZW50aXR5TW9kZWxzID0gb3B0aW9ucy5lbnRpdHlNb2RlbHM7XG5cbiAgICBpZiAodHlwZW9mIG9wdGlvbnMuZW50aXR5TW9kZWxzID09PSAnc3RyaW5nJykge1xuICAgICAgICBlbnRpdHlNb2RlbHMgPSBmcy5yZWFkSnNvblN5bmMoYXBwLnRvQWJzb2x1dGVQYXRoKG9wdGlvbnMuZW50aXR5TW9kZWxzKSk7IFxuICAgIH1cblxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCBhcGlMaXN0RW5kcG9pbnQsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGxpc3QgPSBbXTtcblxuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG4gICAgICAgIFxuICAgICAgICBfLmZvck93bihlbnRpdHlNb2RlbHMsIChjb25maWcsIGVudGl0eU5hbWUpID0+IHtcbiAgICAgICAgICAgIC8vdG9kbzogZmlsdGVyIGVudGl0eSBvciBtZXRob2RzIGJ5IGNvbmZpZ1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWVJblVybCA9IF8ua2ViYWJDYXNlKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgbGV0IGtleUZpZWxkTmFtZTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgaWYgKGNvbmZpZy50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgICAgICBrZXlGaWVsZE5hbWUgPSBjb25maWcua2V5IHx8IGRiLm1vZGVsKGNvbmZpZy5zZWxlY3RGcm9tKS5tZXRhLmtleUZpZWxkOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAga2V5RmllbGROYW1lID0gZGIubW9kZWwoZW50aXR5TmFtZSkubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgIH0gICAgICAgICAgXG5cbiAgICAgICAgICAgIGtleUZpZWxkTmFtZSA9ICc6JyArIGtleUZpZWxkTmFtZTtcblxuICAgICAgICAgICAgbGV0IHNpbmdsZVVybCA9IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwsIGtleUZpZWxkTmFtZSk7XG4gICAgICAgICAgICBsZXQgYmF0Y2hVcmwgPSB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsKTtcbiAgICAgICAgICAgIGxldCBkZXNjVXJsID0gYXBwLnRvV2ViUGF0aCh1cmxKb2luKGJhc2VSb3V0ZSwgJ19kZXNjJywgXy5rZWJhYkNhc2UoZW50aXR5TmFtZSkpKTtcblxuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2xpc3QnLCBtZXRob2Q6ICdnZXQnLCB1cmw6IGJhdGNoVXJsLCBhcGlEZXNjOiBkZXNjVXJsIH0pO1xuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2RldGFpbCcsIG1ldGhvZDogJ2dldCcsIHVybDogc2luZ2xlVXJsIH0pO1xuXG4gICAgICAgICAgICBpZiAoIWNvbmZpZy5yZWFkT25seSkge1xuICAgICAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdjcmVhdGUnLCBtZXRob2Q6ICdwb3N0JywgdXJsOiBiYXRjaFVybCB9KTtcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAndXBkYXRlJywgbWV0aG9kOiAncHV0JywgdXJsOiBzaW5nbGVVcmwgfSk7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2RlbGV0ZScsIG1ldGhvZDogJ2RlbCcsIHVybDogc2luZ2xlVXJsIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjdHguYm9keSA9IGxpc3Q7XG4gICAgfSk7XG5cbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgdXJsSm9pbihkZXNjRW5kcG9pbnQsICc6ZW50aXR5JyksIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGxpc3Q7ICAgICAgICBcblxuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgY29uZmlnID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBsZXQgRW50aXR5TW9kZWw7XG5cbiAgICAgICAgaWYgKGNvbmZpZy50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgIGxpc3QgPSB7XG4gICAgICAgICAgICAgICAgJ3R5cGUnOiAndmlldycsXG4gICAgICAgICAgICAgICAgJ21haW5FbnRpdHknOiBjb25maWcuc2VsZWN0RnJvbSAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmIChjb25maWcuam9pbldpdGgpIHtcbiAgICAgICAgICAgICAgICBsaXN0LmFzc29jaWF0aW9ucyA9IGNvbmZpZy5qb2luV2l0aDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbmZpZy53aGVyZSkge1xuICAgICAgICAgICAgICAgIGxpc3Qud2hlcmUgPSBjb25maWcud2hlcmU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb25maWcua2V5KSB7XG4gICAgICAgICAgICAgICAgbGlzdC5rZXkgPSBjb25maWcua2V5O1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGNvbmZpZy5zZWxlY3RGcm9tKTtcblxuICAgICAgICAgICAgaWYgKGNvbmZpZy5xdWVyeSkge1xuICAgICAgICAgICAgICAgIGxpc3QucXVlcnkgPSBfLm1hcFZhbHVlcyhjb25maWcucXVlcnksIChpbmZvKSA9PiBpbmZvLmRlc2MpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY29uZmlnLm9yZGVyQnkpIHtcbiAgICAgICAgICAgICAgICBsaXN0Lm9yZGVyQnkgPSBjb25maWcub3JkZXJCeTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxpc3QgPSB7XG4gICAgICAgICAgICAgICAgJ3R5cGUnOiAnZW50aXR5JyxcbiAgICAgICAgICAgICAgICAnZW50aXR5JzogZW50aXR5TmFtZSAgICBcbiAgICAgICAgICAgIH07ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBsaXN0LnF1ZXJ5ID0gXy5tYXBWYWx1ZXMoRW50aXR5TW9kZWwubWV0YS5maWVsZHMsIChpbmZvKSA9PiBpbmZvLmRpc3BsYXlOYW1lKTtcbiAgICAgICAgfSAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbGlzdDtcbiAgICB9KTtcblxuICAgIGlmIChhcHAuZW52ID09PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCB1cmxKb2luKG1ldGFkYXRhRW5kcG9pbnQsICc6ZW50aXR5JyksIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3JykgPyBhcGlJbmZvLnNlbGVjdEZyb20gOiBlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxldCBpbmZvID0gRW50aXR5TW9kZWwubWV0YTtcblxuICAgICAgICAgICAgaWYgKGN0eC5xdWVyeS5maWx0ZXIpIHtcbiAgICAgICAgICAgICAgICBpbmZvID0gZ2V0VmFsdWVCeVBhdGgoaW5mbywgY3R4LnF1ZXJ5LmZpbHRlcik7XG4gICAgICAgICAgICAgICAgaWYgKCFpbmZvKSB7XG4gICAgICAgICAgICAgICAgICAgIGN0eC50aHJvdyhIdHRwQ29kZS5CQURfUkVRVUVTVCwgYEVtcHR5IGNvbnRlbnQuYCwgeyBleHBvc2U6IHRydWUgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjdHguYm9keSA9IGluZm87XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIC8vZ2V0IGxpc3QgICAgXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBxdWVyeU9wdGlvbnMsIEVudGl0eU1vZGVsO1xuXG4gICAgICAgIGlmIChhcGlJbmZvLnR5cGUgJiYgYXBpSW5mby50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgIGVudGl0eU5hbWUgPSBhcGlJbmZvLnNlbGVjdEZyb207XG5cbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgLi4ucHJvY2Vzc1F1ZXJ5KGN0eCwgYXBpSW5mbyksICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICRhc3NvY2lhdGlvbjogYXBpSW5mby5qb2luV2l0aFxuICAgICAgICAgICAgfTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAuLi5wcm9jZXNzUXVlcnkoY3R4LCBhcGlJbmZvLCBFbnRpdHlNb2RlbC5tZXRhKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHF1ZXJ5T3B0aW9ucy4kdmFyaWFibGVzID0geyBcbiAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgcXVlcnk6IGN0eC5xdWVyeVxuICAgICAgICB9O1xuXG4gICAgICAgIGN0eC5ib2R5ID0gYXdhaXQgRW50aXR5TW9kZWwuZmluZEFsbF8ocXVlcnlPcHRpb25zKTtcbiAgICB9KTtcblxuICAgIC8vZ2V0IGRldGFpbFxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsLCBxdWVyeU9wdGlvbnMsIGtleUZpZWxkO1xuICAgICAgICBsZXQga2V5VmFsdWUgPSBjdHgucGFyYW1zLmlkOyAgICAgICAgXG5cbiAgICAgICAgaWYgKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgZW50aXR5TmFtZSA9IGFwaUluZm8uc2VsZWN0RnJvbTtcbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBrZXlGaWVsZCA9IGFwaUluZm8ua2V5IHx8IEVudGl0eU1vZGVsLm1ldGEua2V5RmllbGQ7XG5cbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgJHF1ZXJ5OiB7IFtrZXlGaWVsZF06IGtleVZhbHVlLCAuLi5hcGlJbmZvLndoZXJlIH0sXG4gICAgICAgICAgICAgICAgJGFzc29jaWF0aW9uOiBhcGlJbmZvLmpvaW5XaXRoXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH0gZWxzZSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAga2V5RmllbGQgPSBFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkO1xuXG4gICAgICAgICAgICBsZXQgYXNzb2NzID0gW107XG5cbiAgICAgICAgICAgIF8uZm9yT3duKGN0eC5xdWVyeSwgKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoJzonKSAmJiAoXy5pc05pbCh2YWx1ZSkgfHwgdmFsdWUgIT09ICcwJykpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzb2NzLnB1c2goa2V5LnN1YnN0cigxKSk7XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgICRxdWVyeTogeyBba2V5RmllbGRdOiBrZXlWYWx1ZSB9XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAoYXNzb2NzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMuJGFzc29jaWF0aW9uID0gYXNzb2NzO1xuICAgICAgICAgICAgfVxuICAgICAgICB9ICAgICAgICBcblxuICAgICAgICBxdWVyeU9wdGlvbnMuJHZhcmlhYmxlcyA9IHsgXG4gICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC5maW5kT25lXyhxdWVyeU9wdGlvbnMpOyAgICAgICAgXG4gICAgICAgIGlmICghbW9kZWwpIHtcbiAgICAgICAgICAgIGN0eC50aHJvdyhIdHRwQ29kZS5OT1RfRk9VTkQsIGBcIiR7RW50aXR5TW9kZWwubWV0YS5uYW1lfVwiIHdpdGggWyR7a2V5RmllbGR9PSR7a2V5VmFsdWV9XSBub3QgZm91bmQuYCwgeyBleHBvc2U6IHRydWUgfSk7XG4gICAgICAgIH0gXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vY3JlYXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3Bvc3QnLCAnLzplbnRpdHknLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7ICAgICAgIFxuXG4gICAgICAgIGxldCBtb2RlbCA9IGF3YWl0IEVudGl0eU1vZGVsLmNyZWF0ZV8oY3R4LnJlcXVlc3QuYm9keSwgeyBcbiAgICAgICAgICAgICRyZXRyaWV2ZUNyZWF0ZWQ6IHRydWUsXG4gICAgICAgICAgICAkdmFyaWFibGVzOiB7IFxuICAgICAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy91cGRhdGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncHV0JywgJy86ZW50aXR5JywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGxldCB7IHdoZXJlLCBkYXRhIH0gPSBjdHgucmVxdWVzdC5ib2R5O1xuXG4gICAgICAgIGxldCBtb2RlbCA9IGF3YWl0IEVudGl0eU1vZGVsLnVwZGF0ZU1hbnlfKGRhdGEsIHsgXG4gICAgICAgICAgICAkcXVlcnk6IHdoZXJlLCBcbiAgICAgICAgICAgICRyZXRyaWV2ZVVwZGF0ZWQ6IHRydWUsXG4gICAgICAgICAgICAkdmFyaWFibGVzOiB7IFxuICAgICAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgICAgIH0gXG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vdXBkYXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3B1dCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHdoZXJlID0geyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfTtcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC51cGRhdGVPbmVfKGN0eC5yZXF1ZXN0LmJvZHksIHsgXG4gICAgICAgICAgICAkcXVlcnk6IHdoZXJlLCBcbiAgICAgICAgICAgICRyZXRyaWV2ZVVwZGF0ZWQ6IHRydWUsXG4gICAgICAgICAgICAkdmFyaWFibGVzOiB7IFxuICAgICAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgICAgIH0gXG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vZGVsZXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2RlbCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHdoZXJlID0geyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfTtcblxuICAgICAgICBsZXQgZGVsZXRlZCA9IGF3YWl0IEVudGl0eU1vZGVsLmRlbGV0ZU9uZV8oeyBcbiAgICAgICAgICAgICRxdWVyeTogd2hlcmUsXG4gICAgICAgICAgICAkdmFyaWFibGVzOiB7IFxuICAgICAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7ICAgICAgICAgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0geyBzdGF0dXM6ICdPSycsIGRlbGV0ZWQgfTtcbiAgICB9KTsgICBcblxuICAgIGFwcC5hZGRSb3V0ZXIocm91dGVyKTtcbn07Il19