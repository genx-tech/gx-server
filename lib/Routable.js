"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob,
  urlJoin,
  ensureLeftSlash,
  ensureRightSlash,
  urlAppendQuery
} = require('rk-utils');

const {
  Helpers: {
    tryRequire
  }
} = require('@genx/app');

const Errors = require('./utils/Errors');

const Literal = require('./enum/Literal');

const Koa = require('koa');

const Routable = T => class extends T {
  constructor(name, options) {
    super(name, options);
    this.clientPath = this.toAbsolutePath(this.options.clientPath || Literal.CLIENT_SRC_PATH);
    this.publicPath = this.toAbsolutePath(this.options.publicPath || Literal.PUBLIC_PATH);
    this.backendPath = this.toAbsolutePath(this.options.backendPath || (process.env.NODE_RT && process.env.NODE_RT === 'babel' ? Literal.BACKEND_SRC_PATH : Literal.BACKEND_PATH));
    this.router = new Koa();
    this.router.use((ctx, next) => {
      ctx.appModule = this;
      return next();
    });
    this.on('configLoaded', () => {
      let middlewareDir = path.join(this.backendPath, Literal.MIDDLEWARES_PATH);

      if (fs.existsSync(middlewareDir)) {
        this.loadMiddlewaresFrom(middlewareDir);
      }
    });
  }

  async start_() {
    this.middlewareFactoryRegistry = {};
    return super.start_();
  }

  async stop_() {
    delete this.middlewareFactoryRegistry;
    return super.stop_();
  }

  loadMiddlewaresFrom(dir) {
    let files = glob.sync(path.join(dir, '*.js'), {
      nodir: true
    });
    files.forEach(file => this.registerMiddlewareFactory(path.basename(file, '.js'), require(file)));
  }

  registerMiddlewareFactory(name, factoryMethod) {
    if (!(typeof factoryMethod === 'function')) {
      throw new Error('Invalid middleware factory: ' + name);
    }

    if (name in this.middlewareFactoryRegistry) {
      throw new Errors.ServerError('Middleware "' + name + '" already registered!');
    }

    this.middlewareFactoryRegistry[name] = factoryMethod;
    this.log('verbose', `Registered named middleware [${name}].`);
  }

  getMiddlewareFactory(name) {
    if (this.middlewareFactoryRegistry.hasOwnProperty(name)) {
      return this.middlewareFactoryRegistry[name];
    }

    if (this.server && this.server !== this) {
      return this.server.getMiddlewareFactory(name);
    }

    let npmMiddleware = tryRequire(name);

    if (npmMiddleware) {
      return npmMiddleware;
    }

    throw new Errors.ServerError(`Don't know where to load middleware "${name}".`);
  }

  useMiddlewares(router, middlewares) {
    let middlewareFactory, middleware;
    let middlewareFunctions = [];

    if (_.isPlainObject(middlewares)) {
      _.forOwn(middlewares, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        middleware = middlewareFactory(options, this);
        middlewareFunctions.push({
          name,
          middleware
        });
      });
    } else {
      middlewares = _.castArray(middlewares);

      _.each(middlewares, middlewareEntry => {
        let type = typeof middlewareEntry;

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(middlewareEntry);
          middleware = middlewareFactory(undefined, this);
          middlewareFunctions.push({
            name: middlewareEntry,
            middleware
          });
        } else if (type === 'function') {
          middlewareFunctions.push({
            name: middlewareEntry.name || 'unamed middleware',
            middleware: middlewareEntry
          });
        } else if (Array.isArray(middlewareEntry)) {
          if (middlewareEntry.length === 0) {
            throw new Errors.InvalidConfiguration('Empty array found as middleware entry!', this, 'middlewares');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry[0]);
          middleware = middlewareFactory(middlewareEntry.length > 1 ? middlewareEntry[1] : null, this);
          middlewareFunctions.push({
            name: middlewareEntry[0],
            middleware
          });
        } else {
          if (!_.isPlainObject(middlewareEntry) || !('name' in middlewareEntry)) {
            throw new Errors.InvalidConfiguration('Invalid middleware entry!', this, 'middlewares');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry.name);
          middleware = middlewareFactory(middlewareEntry.options, this);
          middlewareFunctions.push({
            name: middlewareEntry.name,
            middleware
          });
        }
      });
    }

    middlewareFunctions.forEach(({
      name,
      middleware
    }) => {
      if (Array.isArray(middleware)) {
        middleware.forEach(m => this.useMiddleware(router, m, name));
      } else {
        this.useMiddleware(router, middleware, name);
      }
    });
    return this;
  }

  addRoute(router, method, route, actions) {
    let handlers = [],
        middlewareFactory;

    if (_.isPlainObject(actions)) {
      _.forOwn(actions, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        handlers.push(this._wrapMiddlewareTracer(middlewareFactory(options, this), name));
      });
    } else {
      actions = _.castArray(actions);
      let lastIndex = actions.length - 1;

      _.each(actions, (action, i) => {
        let type = typeof action;

        if (i === lastIndex) {
          if (type === 'string' && action.lastIndexOf('.') > 0) {
            action = {
              name: 'action',
              options: action
            };
            type = 'object';
          }
        }

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(action);
          let middleware = middlewareFactory(null, this);

          if (Array.isArray(middleware)) {
            middleware.forEach((middlewareItem, i) => handlers.push(this._wrapMiddlewareTracer(middlewareItem, `${action}-${i}` + (middleware.name ? '-' + middleware.name : ''))));
          } else {
            handlers.push(this._wrapMiddlewareTracer(middleware, action));
          }
        } else if (type === 'function') {
          handlers.push(this._wrapMiddlewareTracer(action));
        } else if (Array.isArray(action)) {
          if (!(action.length > 0 && action.length <= 2)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action[0]);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.length > 1 ? action[1] : undefined, this)));
        } else {
          if (!(_.isPlainObject(action) && 'name' in action)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action.name);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.options, this), action.name));
        }
      });
    }

    router[method](route, ...handlers);
    let endpoint = router.opts.prefix ? urlJoin(this.route, router.opts.prefix, route) : urlJoin(this.route, route);
    this.log('verbose', `Route "${method}:${endpoint}" is added from module [${this.name}].`);
    return this;
  }

  addRouter(nestedRouter) {
    this.router.use(nestedRouter.routes());
    this.router.use(nestedRouter.allowedMethods());
    return this;
  }

  toWebPath(relativePath, ...pathOrQuery) {
    let url, query;

    if (pathOrQuery && pathOrQuery.length > 0 && (pathOrQuery.length > 1 || pathOrQuery[0] !== undefined)) {
      if (_.isObject(pathOrQuery[pathOrQuery.length - 1])) {
        query = pathOrQuery.pop();
      }

      pathOrQuery.unshift(relativePath);
      url = urlJoin(this.route, ...pathOrQuery);
    } else {
      url = urlJoin(this.route, relativePath);
    }

    url = ensureLeftSlash(url);

    if (query) {
      url = urlAppendQuery(url, query);
      url = url.replace('/?', '?');
    }

    return url;
  }

  wrapAction(action) {
    return async ctx => {
      ctx.toUrl = (relativePath, ...pathOrQuery) => {
        return ctx.origin + this.toWebPath(relativePath, ...pathOrQuery);
      };

      Object.assign(ctx.state, {
        _self: ctx.originalUrl || this.toWebPath(ctx.url),
        __: ctx.__,
        _base: ensureRightSlash(this.toWebPath()),
        _makePath: (relativePath, query) => this.toWebPath(relativePath, query),
        _makeUrl: (relativePath, query) => ctx.toUrl(relativePath, query)
      });

      if (ctx.csrf) {
        ctx.state._csrf = ctx.csrf;
      }

      return action(ctx);
    };
  }

  useMiddleware(router, middleware, name) {
    if (!(typeof middleware === 'function')) {
      throw new Error(middleware);
    }

    router.use(this._wrapMiddlewareTracer(middleware, name));
    this.log('verbose', `Attached middleware [${name}].`);
  }

  _wrapMiddlewareTracer(middleware, name) {
    if (this.options.traceMiddlewares) {
      return async (ctx, next) => {
        this.log('debug', `Step in middleware "${name || middleware.name}" ...`);
        let ret = await middleware(ctx, next);
        this.log('debug', `Step out from middleware "${name || middleware.name}".`);
        return ret;
      };
    }

    return middleware;
  }

  _getFeatureFallbackPath() {
    return super._getFeatureFallbackPath().concat([path.join(this.backendPath, Literal.FEATURES_PATH)]);
  }

};

module.exports = Routable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Sb3V0YWJsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJ1cmxKb2luIiwiZW5zdXJlTGVmdFNsYXNoIiwiZW5zdXJlUmlnaHRTbGFzaCIsInVybEFwcGVuZFF1ZXJ5IiwiSGVscGVycyIsInRyeVJlcXVpcmUiLCJFcnJvcnMiLCJMaXRlcmFsIiwiS29hIiwiUm91dGFibGUiLCJUIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImNsaWVudFBhdGgiLCJ0b0Fic29sdXRlUGF0aCIsIkNMSUVOVF9TUkNfUEFUSCIsInB1YmxpY1BhdGgiLCJQVUJMSUNfUEFUSCIsImJhY2tlbmRQYXRoIiwicHJvY2VzcyIsImVudiIsIk5PREVfUlQiLCJCQUNLRU5EX1NSQ19QQVRIIiwiQkFDS0VORF9QQVRIIiwicm91dGVyIiwidXNlIiwiY3R4IiwibmV4dCIsImFwcE1vZHVsZSIsIm9uIiwibWlkZGxld2FyZURpciIsImpvaW4iLCJNSURETEVXQVJFU19QQVRIIiwiZXhpc3RzU3luYyIsImxvYWRNaWRkbGV3YXJlc0Zyb20iLCJzdGFydF8iLCJtaWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5Iiwic3RvcF8iLCJkaXIiLCJmaWxlcyIsInN5bmMiLCJub2RpciIsImZvckVhY2giLCJmaWxlIiwicmVnaXN0ZXJNaWRkbGV3YXJlRmFjdG9yeSIsImJhc2VuYW1lIiwiZmFjdG9yeU1ldGhvZCIsIlNlcnZlckVycm9yIiwibG9nIiwiZ2V0TWlkZGxld2FyZUZhY3RvcnkiLCJoYXNPd25Qcm9wZXJ0eSIsInNlcnZlciIsIm5wbU1pZGRsZXdhcmUiLCJ1c2VNaWRkbGV3YXJlcyIsIm1pZGRsZXdhcmVzIiwibWlkZGxld2FyZUZhY3RvcnkiLCJtaWRkbGV3YXJlIiwibWlkZGxld2FyZUZ1bmN0aW9ucyIsImlzUGxhaW5PYmplY3QiLCJmb3JPd24iLCJwdXNoIiwiY2FzdEFycmF5IiwiZWFjaCIsIm1pZGRsZXdhcmVFbnRyeSIsInR5cGUiLCJ1bmRlZmluZWQiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsIm0iLCJ1c2VNaWRkbGV3YXJlIiwiYWRkUm91dGUiLCJtZXRob2QiLCJyb3V0ZSIsImFjdGlvbnMiLCJoYW5kbGVycyIsIl93cmFwTWlkZGxld2FyZVRyYWNlciIsImxhc3RJbmRleCIsImFjdGlvbiIsImkiLCJsYXN0SW5kZXhPZiIsIm1pZGRsZXdhcmVJdGVtIiwiZW5kcG9pbnQiLCJvcHRzIiwicHJlZml4IiwiYWRkUm91dGVyIiwibmVzdGVkUm91dGVyIiwicm91dGVzIiwiYWxsb3dlZE1ldGhvZHMiLCJ0b1dlYlBhdGgiLCJyZWxhdGl2ZVBhdGgiLCJwYXRoT3JRdWVyeSIsInVybCIsInF1ZXJ5IiwiaXNPYmplY3QiLCJwb3AiLCJ1bnNoaWZ0IiwicmVwbGFjZSIsIndyYXBBY3Rpb24iLCJ0b1VybCIsIm9yaWdpbiIsIk9iamVjdCIsImFzc2lnbiIsInN0YXRlIiwiX3NlbGYiLCJvcmlnaW5hbFVybCIsIl9fIiwiX2Jhc2UiLCJfbWFrZVBhdGgiLCJfbWFrZVVybCIsImNzcmYiLCJfY3NyZiIsInRyYWNlTWlkZGxld2FyZXMiLCJyZXQiLCJfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCIsImNvbmNhdCIsIkZFQVRVUkVTX1BBVEgiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUEsSUFBVDtBQUFlQyxFQUFBQSxPQUFmO0FBQXdCQyxFQUFBQSxlQUF4QjtBQUF5Q0MsRUFBQUEsZ0JBQXpDO0FBQTJEQyxFQUFBQTtBQUEzRCxJQUE4RVAsT0FBTyxDQUFDLFVBQUQsQ0FBM0Y7O0FBQ0EsTUFBTTtBQUFFUSxFQUFBQSxPQUFPLEVBQUU7QUFBRUMsSUFBQUE7QUFBRjtBQUFYLElBQThCVCxPQUFPLENBQUMsV0FBRCxDQUEzQzs7QUFDQSxNQUFNVSxNQUFNLEdBQUdWLE9BQU8sQ0FBQyxnQkFBRCxDQUF0Qjs7QUFDQSxNQUFNVyxPQUFPLEdBQUdYLE9BQU8sQ0FBQyxnQkFBRCxDQUF2Qjs7QUFDQSxNQUFNWSxHQUFHLEdBQUdaLE9BQU8sQ0FBQyxLQUFELENBQW5COztBQUVBLE1BQU1hLFFBQVEsR0FBR0MsQ0FBQyxJQUFJLGNBQWNBLENBQWQsQ0FBZ0I7QUFRbENDLEVBQUFBLFdBQVcsQ0FBQ0MsSUFBRCxFQUFPQyxPQUFQLEVBQWdCO0FBQ3ZCLFVBQU1ELElBQU4sRUFBWUMsT0FBWjtBQU1BLFNBQUtDLFVBQUwsR0FBa0IsS0FBS0MsY0FBTCxDQUFvQixLQUFLRixPQUFMLENBQWFDLFVBQWIsSUFBMkJQLE9BQU8sQ0FBQ1MsZUFBdkQsQ0FBbEI7QUFNQSxTQUFLQyxVQUFMLEdBQWtCLEtBQUtGLGNBQUwsQ0FBb0IsS0FBS0YsT0FBTCxDQUFhSSxVQUFiLElBQTJCVixPQUFPLENBQUNXLFdBQXZELENBQWxCO0FBTUEsU0FBS0MsV0FBTCxHQUFtQixLQUFLSixjQUFMLENBQW9CLEtBQUtGLE9BQUwsQ0FBYU0sV0FBYixLQUE2QkMsT0FBTyxDQUFDQyxHQUFSLENBQVlDLE9BQVosSUFBdUJGLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxPQUFaLEtBQXdCLE9BQS9DLEdBQXlEZixPQUFPLENBQUNnQixnQkFBakUsR0FBb0ZoQixPQUFPLENBQUNpQixZQUF6SCxDQUFwQixDQUFuQjtBQU1BLFNBQUtDLE1BQUwsR0FBYyxJQUFJakIsR0FBSixFQUFkO0FBR0EsU0FBS2lCLE1BQUwsQ0FBWUMsR0FBWixDQUFnQixDQUFDQyxHQUFELEVBQU1DLElBQU4sS0FBZTtBQUMzQkQsTUFBQUEsR0FBRyxDQUFDRSxTQUFKLEdBQWdCLElBQWhCO0FBQ0EsYUFBT0QsSUFBSSxFQUFYO0FBQ0gsS0FIRDtBQUtBLFNBQUtFLEVBQUwsQ0FBUSxjQUFSLEVBQXdCLE1BQU07QUFFMUIsVUFBSUMsYUFBYSxHQUFHcEMsSUFBSSxDQUFDcUMsSUFBTCxDQUFVLEtBQUtiLFdBQWYsRUFBNEJaLE9BQU8sQ0FBQzBCLGdCQUFwQyxDQUFwQjs7QUFFQSxVQUFJbkMsRUFBRSxDQUFDb0MsVUFBSCxDQUFjSCxhQUFkLENBQUosRUFBa0M7QUFDOUIsYUFBS0ksbUJBQUwsQ0FBeUJKLGFBQXpCO0FBQ0g7QUFDSixLQVBEO0FBUUg7O0FBRUQsUUFBTUssTUFBTixHQUFlO0FBS1gsU0FBS0MseUJBQUwsR0FBaUMsRUFBakM7QUFFQSxXQUFPLE1BQU1ELE1BQU4sRUFBUDtBQUNIOztBQUVELFFBQU1FLEtBQU4sR0FBYztBQUNWLFdBQU8sS0FBS0QseUJBQVo7QUFFQSxXQUFPLE1BQU1DLEtBQU4sRUFBUDtBQUNIOztBQU1ESCxFQUFBQSxtQkFBbUIsQ0FBQ0ksR0FBRCxFQUFNO0FBQ3JCLFFBQUlDLEtBQUssR0FBR3pDLElBQUksQ0FBQzBDLElBQUwsQ0FBVTlDLElBQUksQ0FBQ3FDLElBQUwsQ0FBVU8sR0FBVixFQUFlLE1BQWYsQ0FBVixFQUFrQztBQUFDRyxNQUFBQSxLQUFLLEVBQUU7QUFBUixLQUFsQyxDQUFaO0FBQ0FGLElBQUFBLEtBQUssQ0FBQ0csT0FBTixDQUFjQyxJQUFJLElBQUksS0FBS0MseUJBQUwsQ0FBK0JsRCxJQUFJLENBQUNtRCxRQUFMLENBQWNGLElBQWQsRUFBb0IsS0FBcEIsQ0FBL0IsRUFBMkRoRCxPQUFPLENBQUNnRCxJQUFELENBQWxFLENBQXRCO0FBQ0g7O0FBT0RDLEVBQUFBLHlCQUF5QixDQUFDakMsSUFBRCxFQUFPbUMsYUFBUCxFQUFzQjtBQUFBLFVBQ3RDLE9BQU9BLGFBQVAsS0FBeUIsVUFEYTtBQUFBLHNCQUNELGlDQUFpQ25DLElBRGhDO0FBQUE7O0FBRzNDLFFBQUlBLElBQUksSUFBSSxLQUFLeUIseUJBQWpCLEVBQTRDO0FBQ3hDLFlBQU0sSUFBSS9CLE1BQU0sQ0FBQzBDLFdBQVgsQ0FBdUIsaUJBQWdCcEMsSUFBaEIsR0FBc0IsdUJBQTdDLENBQU47QUFDSDs7QUFFRCxTQUFLeUIseUJBQUwsQ0FBK0J6QixJQUEvQixJQUF1Q21DLGFBQXZDO0FBQ0EsU0FBS0UsR0FBTCxDQUFTLFNBQVQsRUFBcUIsZ0NBQStCckMsSUFBSyxJQUF6RDtBQUNIOztBQU9Ec0MsRUFBQUEsb0JBQW9CLENBQUN0QyxJQUFELEVBQU87QUFDdkIsUUFBSSxLQUFLeUIseUJBQUwsQ0FBK0JjLGNBQS9CLENBQThDdkMsSUFBOUMsQ0FBSixFQUF5RDtBQUNyRCxhQUFPLEtBQUt5Qix5QkFBTCxDQUErQnpCLElBQS9CLENBQVA7QUFDSDs7QUFFRCxRQUFJLEtBQUt3QyxNQUFMLElBQWUsS0FBS0EsTUFBTCxLQUFnQixJQUFuQyxFQUF5QztBQUNyQyxhQUFPLEtBQUtBLE1BQUwsQ0FBWUYsb0JBQVosQ0FBaUN0QyxJQUFqQyxDQUFQO0FBQ0g7O0FBRUQsUUFBSXlDLGFBQWEsR0FBR2hELFVBQVUsQ0FBQ08sSUFBRCxDQUE5Qjs7QUFDQSxRQUFJeUMsYUFBSixFQUFtQjtBQUNmLGFBQU9BLGFBQVA7QUFDSDs7QUFFRCxVQUFNLElBQUkvQyxNQUFNLENBQUMwQyxXQUFYLENBQXdCLHdDQUF1Q3BDLElBQUssSUFBcEUsQ0FBTjtBQUNIOztBQVFEMEMsRUFBQUEsY0FBYyxDQUFDN0IsTUFBRCxFQUFTOEIsV0FBVCxFQUFzQjtBQUNoQyxRQUFJQyxpQkFBSixFQUF1QkMsVUFBdkI7QUFDQSxRQUFJQyxtQkFBbUIsR0FBRyxFQUExQjs7QUFFQSxRQUFJN0QsQ0FBQyxDQUFDOEQsYUFBRixDQUFnQkosV0FBaEIsQ0FBSixFQUFrQztBQUM5QjFELE1BQUFBLENBQUMsQ0FBQytELE1BQUYsQ0FBU0wsV0FBVCxFQUFzQixDQUFDMUMsT0FBRCxFQUFVRCxJQUFWLEtBQW1CO0FBQ3JDNEMsUUFBQUEsaUJBQWlCLEdBQUcsS0FBS04sb0JBQUwsQ0FBMEJ0QyxJQUExQixDQUFwQjtBQUNBNkMsUUFBQUEsVUFBVSxHQUFHRCxpQkFBaUIsQ0FBQzNDLE9BQUQsRUFBVSxJQUFWLENBQTlCO0FBQ0E2QyxRQUFBQSxtQkFBbUIsQ0FBQ0csSUFBcEIsQ0FBeUI7QUFBRWpELFVBQUFBLElBQUY7QUFBUTZDLFVBQUFBO0FBQVIsU0FBekI7QUFDSCxPQUpEO0FBS0gsS0FORCxNQU1PO0FBQ0hGLE1BQUFBLFdBQVcsR0FBRzFELENBQUMsQ0FBQ2lFLFNBQUYsQ0FBWVAsV0FBWixDQUFkOztBQUVBMUQsTUFBQUEsQ0FBQyxDQUFDa0UsSUFBRixDQUFPUixXQUFQLEVBQW9CUyxlQUFlLElBQUk7QUFDbkMsWUFBSUMsSUFBSSxHQUFHLE9BQU9ELGVBQWxCOztBQUVBLFlBQUlDLElBQUksS0FBSyxRQUFiLEVBQXVCO0FBRW5CVCxVQUFBQSxpQkFBaUIsR0FBRyxLQUFLTixvQkFBTCxDQUEwQmMsZUFBMUIsQ0FBcEI7QUFDQVAsVUFBQUEsVUFBVSxHQUFHRCxpQkFBaUIsQ0FBQ1UsU0FBRCxFQUFZLElBQVosQ0FBOUI7QUFDQVIsVUFBQUEsbUJBQW1CLENBQUNHLElBQXBCLENBQXlCO0FBQUVqRCxZQUFBQSxJQUFJLEVBQUVvRCxlQUFSO0FBQTBCUCxZQUFBQTtBQUExQixXQUF6QjtBQUNILFNBTEQsTUFLTyxJQUFJUSxJQUFJLEtBQUssVUFBYixFQUF5QjtBQUM1QlAsVUFBQUEsbUJBQW1CLENBQUNHLElBQXBCLENBQXlCO0FBQUVqRCxZQUFBQSxJQUFJLEVBQUVvRCxlQUFlLENBQUNwRCxJQUFoQixJQUF3QixtQkFBaEM7QUFBcUQ2QyxZQUFBQSxVQUFVLEVBQUVPO0FBQWpFLFdBQXpCO0FBQ0gsU0FGTSxNQUVBLElBQUlHLEtBQUssQ0FBQ0MsT0FBTixDQUFjSixlQUFkLENBQUosRUFBb0M7QUFFdkMsY0FBSUEsZUFBZSxDQUFDSyxNQUFoQixLQUEyQixDQUEvQixFQUFrQztBQUM5QixrQkFBTSxJQUFJL0QsTUFBTSxDQUFDZ0Usb0JBQVgsQ0FDRix3Q0FERSxFQUVGLElBRkUsRUFHRixhQUhFLENBQU47QUFLSDs7QUFFRGQsVUFBQUEsaUJBQWlCLEdBQUcsS0FBS04sb0JBQUwsQ0FBMEJjLGVBQWUsQ0FBQyxDQUFELENBQXpDLENBQXBCO0FBQ0FQLFVBQUFBLFVBQVUsR0FBR0QsaUJBQWlCLENBQUNRLGVBQWUsQ0FBQ0ssTUFBaEIsR0FBeUIsQ0FBekIsR0FBNkJMLGVBQWUsQ0FBQyxDQUFELENBQTVDLEdBQWtELElBQW5ELEVBQXlELElBQXpELENBQTlCO0FBQ0FOLFVBQUFBLG1CQUFtQixDQUFDRyxJQUFwQixDQUF5QjtBQUFFakQsWUFBQUEsSUFBSSxFQUFFb0QsZUFBZSxDQUFDLENBQUQsQ0FBdkI7QUFBNEJQLFlBQUFBO0FBQTVCLFdBQXpCO0FBQ0gsU0FiTSxNQWFBO0FBQ0gsY0FBSSxDQUFDNUQsQ0FBQyxDQUFDOEQsYUFBRixDQUFnQkssZUFBaEIsQ0FBRCxJQUFxQyxFQUFFLFVBQVVBLGVBQVosQ0FBekMsRUFBdUU7QUFDbkUsa0JBQU0sSUFBSTFELE1BQU0sQ0FBQ2dFLG9CQUFYLENBQ0YsMkJBREUsRUFFRixJQUZFLEVBR0YsYUFIRSxDQUFOO0FBS0g7O0FBRURkLFVBQUFBLGlCQUFpQixHQUFHLEtBQUtOLG9CQUFMLENBQTBCYyxlQUFlLENBQUNwRCxJQUExQyxDQUFwQjtBQUNBNkMsVUFBQUEsVUFBVSxHQUFHRCxpQkFBaUIsQ0FBQ1EsZUFBZSxDQUFDbkQsT0FBakIsRUFBMEIsSUFBMUIsQ0FBOUI7QUFDQTZDLFVBQUFBLG1CQUFtQixDQUFDRyxJQUFwQixDQUF5QjtBQUFFakQsWUFBQUEsSUFBSSxFQUFFb0QsZUFBZSxDQUFDcEQsSUFBeEI7QUFBOEI2QyxZQUFBQTtBQUE5QixXQUF6QjtBQUNIO0FBQ0osT0FwQ0Q7QUFxQ0g7O0FBRURDLElBQUFBLG1CQUFtQixDQUFDZixPQUFwQixDQUE0QixDQUFDO0FBQUUvQixNQUFBQSxJQUFGO0FBQVE2QyxNQUFBQTtBQUFSLEtBQUQsS0FBMEI7QUFDbEQsVUFBSVUsS0FBSyxDQUFDQyxPQUFOLENBQWNYLFVBQWQsQ0FBSixFQUErQjtBQUMzQkEsUUFBQUEsVUFBVSxDQUFDZCxPQUFYLENBQW1CNEIsQ0FBQyxJQUFJLEtBQUtDLGFBQUwsQ0FBbUIvQyxNQUFuQixFQUEyQjhDLENBQTNCLEVBQThCM0QsSUFBOUIsQ0FBeEI7QUFDSCxPQUZELE1BRU87QUFDSCxhQUFLNEQsYUFBTCxDQUFtQi9DLE1BQW5CLEVBQTJCZ0MsVUFBM0IsRUFBdUM3QyxJQUF2QztBQUNIO0FBQ0osS0FORDtBQVFBLFdBQU8sSUFBUDtBQUNIOztBQVNENkQsRUFBQUEsUUFBUSxDQUFDaEQsTUFBRCxFQUFTaUQsTUFBVCxFQUFpQkMsS0FBakIsRUFBd0JDLE9BQXhCLEVBQWlDO0FBQ3JDLFFBQUlDLFFBQVEsR0FBRyxFQUFmO0FBQUEsUUFBbUJyQixpQkFBbkI7O0FBRUEsUUFBSTNELENBQUMsQ0FBQzhELGFBQUYsQ0FBZ0JpQixPQUFoQixDQUFKLEVBQThCO0FBQzFCL0UsTUFBQUEsQ0FBQyxDQUFDK0QsTUFBRixDQUFTZ0IsT0FBVCxFQUFrQixDQUFDL0QsT0FBRCxFQUFVRCxJQUFWLEtBQW1CO0FBQ2pDNEMsUUFBQUEsaUJBQWlCLEdBQUcsS0FBS04sb0JBQUwsQ0FBMEJ0QyxJQUExQixDQUFwQjtBQUNBaUUsUUFBQUEsUUFBUSxDQUFDaEIsSUFBVCxDQUFjLEtBQUtpQixxQkFBTCxDQUEyQnRCLGlCQUFpQixDQUFDM0MsT0FBRCxFQUFVLElBQVYsQ0FBNUMsRUFBNkRELElBQTdELENBQWQ7QUFDSCxPQUhEO0FBSUgsS0FMRCxNQUtPO0FBQ0hnRSxNQUFBQSxPQUFPLEdBQUcvRSxDQUFDLENBQUNpRSxTQUFGLENBQVljLE9BQVosQ0FBVjtBQUNBLFVBQUlHLFNBQVMsR0FBR0gsT0FBTyxDQUFDUCxNQUFSLEdBQWlCLENBQWpDOztBQUVBeEUsTUFBQUEsQ0FBQyxDQUFDa0UsSUFBRixDQUFPYSxPQUFQLEVBQWdCLENBQUNJLE1BQUQsRUFBU0MsQ0FBVCxLQUFlO0FBQzNCLFlBQUloQixJQUFJLEdBQUcsT0FBT2UsTUFBbEI7O0FBRUEsWUFBSUMsQ0FBQyxLQUFLRixTQUFWLEVBQXFCO0FBRWpCLGNBQUlkLElBQUksS0FBSyxRQUFULElBQXFCZSxNQUFNLENBQUNFLFdBQVAsQ0FBbUIsR0FBbkIsSUFBMEIsQ0FBbkQsRUFBc0Q7QUFDbERGLFlBQUFBLE1BQU0sR0FBRztBQUNMcEUsY0FBQUEsSUFBSSxFQUFFLFFBREQ7QUFFTEMsY0FBQUEsT0FBTyxFQUFFbUU7QUFGSixhQUFUO0FBS0FmLFlBQUFBLElBQUksR0FBRyxRQUFQO0FBQ0g7QUFDSjs7QUFFRCxZQUFJQSxJQUFJLEtBQUssUUFBYixFQUF1QjtBQUVuQlQsVUFBQUEsaUJBQWlCLEdBQUcsS0FBS04sb0JBQUwsQ0FBMEI4QixNQUExQixDQUFwQjtBQUVBLGNBQUl2QixVQUFVLEdBQUdELGlCQUFpQixDQUFDLElBQUQsRUFBTyxJQUFQLENBQWxDOztBQUdBLGNBQUlXLEtBQUssQ0FBQ0MsT0FBTixDQUFjWCxVQUFkLENBQUosRUFBK0I7QUFDM0JBLFlBQUFBLFVBQVUsQ0FBQ2QsT0FBWCxDQUFtQixDQUFDd0MsY0FBRCxFQUFpQkYsQ0FBakIsS0FBdUJKLFFBQVEsQ0FBQ2hCLElBQVQsQ0FDdEMsS0FBS2lCLHFCQUFMLENBQTJCSyxjQUEzQixFQUE0QyxHQUFFSCxNQUFPLElBQUdDLENBQUUsRUFBZixJQUFvQnhCLFVBQVUsQ0FBQzdDLElBQVgsR0FBbUIsTUFBTTZDLFVBQVUsQ0FBQzdDLElBQXBDLEdBQTRDLEVBQWhFLENBQTNDLENBRHNDLENBQTFDO0FBR0gsV0FKRCxNQUlPO0FBQ0hpRSxZQUFBQSxRQUFRLENBQUNoQixJQUFULENBQWMsS0FBS2lCLHFCQUFMLENBQTJCckIsVUFBM0IsRUFBdUN1QixNQUF2QyxDQUFkO0FBQ0g7QUFDSixTQWRELE1BY08sSUFBSWYsSUFBSSxLQUFLLFVBQWIsRUFBeUI7QUFDNUJZLFVBQUFBLFFBQVEsQ0FBQ2hCLElBQVQsQ0FBYyxLQUFLaUIscUJBQUwsQ0FBMkJFLE1BQTNCLENBQWQ7QUFDSCxTQUZNLE1BRUEsSUFBSWIsS0FBSyxDQUFDQyxPQUFOLENBQWNZLE1BQWQsQ0FBSixFQUEyQjtBQUFBLGdCQUN0QkEsTUFBTSxDQUFDWCxNQUFQLEdBQWdCLENBQWhCLElBQXFCVyxNQUFNLENBQUNYLE1BQVAsSUFBaUIsQ0FEaEI7QUFBQSw0QkFDbUIsMEJBRG5CO0FBQUE7O0FBRzlCYixVQUFBQSxpQkFBaUIsR0FBRyxLQUFLTixvQkFBTCxDQUEwQjhCLE1BQU0sQ0FBQyxDQUFELENBQWhDLENBQXBCO0FBQ0FILFVBQUFBLFFBQVEsQ0FBQ2hCLElBQVQsQ0FBYyxLQUFLaUIscUJBQUwsQ0FBMkJ0QixpQkFBaUIsQ0FBQ3dCLE1BQU0sQ0FBQ1gsTUFBUCxHQUFnQixDQUFoQixHQUFvQlcsTUFBTSxDQUFDLENBQUQsQ0FBMUIsR0FBZ0NkLFNBQWpDLEVBQTRDLElBQTVDLENBQTVDLENBQWQ7QUFDSCxTQUxNLE1BS0E7QUFBQSxnQkFDS3JFLENBQUMsQ0FBQzhELGFBQUYsQ0FBZ0JxQixNQUFoQixLQUEyQixVQUFVQSxNQUQxQztBQUFBLDRCQUNrRCwwQkFEbEQ7QUFBQTs7QUFHSHhCLFVBQUFBLGlCQUFpQixHQUFHLEtBQUtOLG9CQUFMLENBQTBCOEIsTUFBTSxDQUFDcEUsSUFBakMsQ0FBcEI7QUFDQWlFLFVBQUFBLFFBQVEsQ0FBQ2hCLElBQVQsQ0FBYyxLQUFLaUIscUJBQUwsQ0FBMkJ0QixpQkFBaUIsQ0FBQ3dCLE1BQU0sQ0FBQ25FLE9BQVIsRUFBaUIsSUFBakIsQ0FBNUMsRUFBb0VtRSxNQUFNLENBQUNwRSxJQUEzRSxDQUFkO0FBQ0g7QUFDSixPQTFDRDtBQTJDSDs7QUFFRGEsSUFBQUEsTUFBTSxDQUFDaUQsTUFBRCxDQUFOLENBQWVDLEtBQWYsRUFBc0IsR0FBR0UsUUFBekI7QUFFQSxRQUFJTyxRQUFRLEdBQUczRCxNQUFNLENBQUM0RCxJQUFQLENBQVlDLE1BQVosR0FBcUJ0RixPQUFPLENBQUMsS0FBSzJFLEtBQU4sRUFBYWxELE1BQU0sQ0FBQzRELElBQVAsQ0FBWUMsTUFBekIsRUFBaUNYLEtBQWpDLENBQTVCLEdBQXNFM0UsT0FBTyxDQUFDLEtBQUsyRSxLQUFOLEVBQWFBLEtBQWIsQ0FBNUY7QUFFQSxTQUFLMUIsR0FBTCxDQUFTLFNBQVQsRUFBcUIsVUFBU3lCLE1BQU8sSUFBR1UsUUFBUywyQkFBMEIsS0FBS3hFLElBQUssSUFBckY7QUFFQSxXQUFPLElBQVA7QUFDSDs7QUFNRDJFLEVBQUFBLFNBQVMsQ0FBQ0MsWUFBRCxFQUFlO0FBQ3BCLFNBQUsvRCxNQUFMLENBQVlDLEdBQVosQ0FBZ0I4RCxZQUFZLENBQUNDLE1BQWIsRUFBaEI7QUFDQSxTQUFLaEUsTUFBTCxDQUFZQyxHQUFaLENBQWdCOEQsWUFBWSxDQUFDRSxjQUFiLEVBQWhCO0FBQ0EsV0FBTyxJQUFQO0FBQ0g7O0FBUURDLEVBQUFBLFNBQVMsQ0FBQ0MsWUFBRCxFQUFlLEdBQUdDLFdBQWxCLEVBQStCO0FBQ3BDLFFBQUlDLEdBQUosRUFBU0MsS0FBVDs7QUFFQSxRQUFJRixXQUFXLElBQUlBLFdBQVcsQ0FBQ3hCLE1BQVosR0FBcUIsQ0FBcEMsS0FBMEN3QixXQUFXLENBQUN4QixNQUFaLEdBQXFCLENBQXJCLElBQTBCd0IsV0FBVyxDQUFDLENBQUQsQ0FBWCxLQUFtQjNCLFNBQXZGLENBQUosRUFBdUc7QUFDbkcsVUFBSXJFLENBQUMsQ0FBQ21HLFFBQUYsQ0FBV0gsV0FBVyxDQUFDQSxXQUFXLENBQUN4QixNQUFaLEdBQXFCLENBQXRCLENBQXRCLENBQUosRUFBcUQ7QUFDakQwQixRQUFBQSxLQUFLLEdBQUdGLFdBQVcsQ0FBQ0ksR0FBWixFQUFSO0FBQ0g7O0FBQ0RKLE1BQUFBLFdBQVcsQ0FBQ0ssT0FBWixDQUFvQk4sWUFBcEI7QUFDQUUsTUFBQUEsR0FBRyxHQUFHOUYsT0FBTyxDQUFDLEtBQUsyRSxLQUFOLEVBQWEsR0FBR2tCLFdBQWhCLENBQWI7QUFDSCxLQU5ELE1BTU87QUFDSEMsTUFBQUEsR0FBRyxHQUFHOUYsT0FBTyxDQUFDLEtBQUsyRSxLQUFOLEVBQWFpQixZQUFiLENBQWI7QUFDSDs7QUFFREUsSUFBQUEsR0FBRyxHQUFHN0YsZUFBZSxDQUFDNkYsR0FBRCxDQUFyQjs7QUFFQSxRQUFJQyxLQUFKLEVBQVc7QUFDUEQsTUFBQUEsR0FBRyxHQUFHM0YsY0FBYyxDQUFDMkYsR0FBRCxFQUFNQyxLQUFOLENBQXBCO0FBQ0FELE1BQUFBLEdBQUcsR0FBR0EsR0FBRyxDQUFDSyxPQUFKLENBQVksSUFBWixFQUFrQixHQUFsQixDQUFOO0FBQ0g7O0FBRUQsV0FBT0wsR0FBUDtBQUNIOztBQVFETSxFQUFBQSxVQUFVLENBQUNwQixNQUFELEVBQVM7QUFDZixXQUFPLE1BQU9yRCxHQUFQLElBQWU7QUFDbEJBLE1BQUFBLEdBQUcsQ0FBQzBFLEtBQUosR0FBWSxDQUFDVCxZQUFELEVBQWUsR0FBR0MsV0FBbEIsS0FBa0M7QUFDMUMsZUFBT2xFLEdBQUcsQ0FBQzJFLE1BQUosR0FBYSxLQUFLWCxTQUFMLENBQWVDLFlBQWYsRUFBNkIsR0FBR0MsV0FBaEMsQ0FBcEI7QUFDSCxPQUZEOztBQUlBVSxNQUFBQSxNQUFNLENBQUNDLE1BQVAsQ0FBYzdFLEdBQUcsQ0FBQzhFLEtBQWxCLEVBQXlCO0FBQ3JCQyxRQUFBQSxLQUFLLEVBQUUvRSxHQUFHLENBQUNnRixXQUFKLElBQW1CLEtBQUtoQixTQUFMLENBQWVoRSxHQUFHLENBQUNtRSxHQUFuQixDQURMO0FBRXJCYyxRQUFBQSxFQUFFLEVBQUVqRixHQUFHLENBQUNpRixFQUZhO0FBR3JCQyxRQUFBQSxLQUFLLEVBQUUzRyxnQkFBZ0IsQ0FBQyxLQUFLeUYsU0FBTCxFQUFELENBSEY7QUFJckJtQixRQUFBQSxTQUFTLEVBQUUsQ0FBQ2xCLFlBQUQsRUFBZUcsS0FBZixLQUF5QixLQUFLSixTQUFMLENBQWVDLFlBQWYsRUFBNkJHLEtBQTdCLENBSmY7QUFLckJnQixRQUFBQSxRQUFRLEVBQUUsQ0FBQ25CLFlBQUQsRUFBZUcsS0FBZixLQUF5QnBFLEdBQUcsQ0FBQzBFLEtBQUosQ0FBVVQsWUFBVixFQUF3QkcsS0FBeEI7QUFMZCxPQUF6Qjs7QUFRQSxVQUFJcEUsR0FBRyxDQUFDcUYsSUFBUixFQUFjO0FBQ1ZyRixRQUFBQSxHQUFHLENBQUM4RSxLQUFKLENBQVVRLEtBQVYsR0FBa0J0RixHQUFHLENBQUNxRixJQUF0QjtBQUNIOztBQUVELGFBQU9oQyxNQUFNLENBQUNyRCxHQUFELENBQWI7QUFDSCxLQWxCRDtBQW1CSDs7QUFFRDZDLEVBQUFBLGFBQWEsQ0FBQy9DLE1BQUQsRUFBU2dDLFVBQVQsRUFBcUI3QyxJQUFyQixFQUEyQjtBQUFBLFVBQzVCLE9BQU82QyxVQUFQLEtBQXNCLFVBRE07QUFBQSxzQkFDTUEsVUFETjtBQUFBOztBQUVwQ2hDLElBQUFBLE1BQU0sQ0FBQ0MsR0FBUCxDQUFXLEtBQUtvRCxxQkFBTCxDQUEyQnJCLFVBQTNCLEVBQXVDN0MsSUFBdkMsQ0FBWDtBQUNBLFNBQUtxQyxHQUFMLENBQVMsU0FBVCxFQUFxQix3QkFBdUJyQyxJQUFLLElBQWpEO0FBQ0g7O0FBRURrRSxFQUFBQSxxQkFBcUIsQ0FBQ3JCLFVBQUQsRUFBYTdDLElBQWIsRUFBbUI7QUFDcEMsUUFBSSxLQUFLQyxPQUFMLENBQWFxRyxnQkFBakIsRUFBbUM7QUFDL0IsYUFBTyxPQUFPdkYsR0FBUCxFQUFZQyxJQUFaLEtBQXFCO0FBQ3hCLGFBQUtxQixHQUFMLENBQVMsT0FBVCxFQUFtQix1QkFBc0JyQyxJQUFJLElBQUk2QyxVQUFVLENBQUM3QyxJQUFLLE9BQWpFO0FBQ0EsWUFBSXVHLEdBQUcsR0FBRyxNQUFNMUQsVUFBVSxDQUFDOUIsR0FBRCxFQUFNQyxJQUFOLENBQTFCO0FBQ0EsYUFBS3FCLEdBQUwsQ0FBUyxPQUFULEVBQW1CLDZCQUE0QnJDLElBQUksSUFBSTZDLFVBQVUsQ0FBQzdDLElBQUssSUFBdkU7QUFDQSxlQUFPdUcsR0FBUDtBQUNILE9BTEQ7QUFNSDs7QUFFRCxXQUFPMUQsVUFBUDtBQUNIOztBQUVEMkQsRUFBQUEsdUJBQXVCLEdBQUc7QUFDdEIsV0FBTyxNQUFNQSx1QkFBTixHQUFnQ0MsTUFBaEMsQ0FBdUMsQ0FBRTFILElBQUksQ0FBQ3FDLElBQUwsQ0FBVSxLQUFLYixXQUFmLEVBQTRCWixPQUFPLENBQUMrRyxhQUFwQyxDQUFGLENBQXZDLENBQVA7QUFDSDs7QUF4VmlDLENBQXRDOztBQTJWQUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCL0csUUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgZnMsIGdsb2IsIHVybEpvaW4sIGVuc3VyZUxlZnRTbGFzaCwgZW5zdXJlUmlnaHRTbGFzaCwgdXJsQXBwZW5kUXVlcnkgfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IEhlbHBlcnM6IHsgdHJ5UmVxdWlyZSB9IH0gPSByZXF1aXJlKCdAZ2VueC9hcHAnKTtcbmNvbnN0IEVycm9ycyA9IHJlcXVpcmUoJy4vdXRpbHMvRXJyb3JzJyk7XG5jb25zdCBMaXRlcmFsID0gcmVxdWlyZSgnLi9lbnVtL0xpdGVyYWwnKTtcbmNvbnN0IEtvYSA9IHJlcXVpcmUoJ2tvYScpO1xuXG5jb25zdCBSb3V0YWJsZSA9IFQgPT4gY2xhc3MgZXh0ZW5kcyBUIHsgICAgXG4gICAgLyoqICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSByb3V0YWJsZSBpbnN0YW5jZS4gICAgIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBSb3V0YWJsZSBvcHRpb25zICAgICAgICAgICAgICAgXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmJhY2tlbmRQYXRoPSdzZXJ2ZXInXSAtIFJlbGF0aXZlIHBhdGggb2YgYmFjay1lbmQgc2VydmVyIHNvdXJjZSBmaWxlc1xuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5jbGllbnRQYXRoPSdjbGllbnQnXSAtIFJlbGF0aXZlIHBhdGggb2YgZnJvbnQtZW5kIGNsaWVudCBzb3VyY2UgZmlsZXMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5wdWJsaWNQYXRoPSdwdWJsaWMnXSAtIFJlbGF0aXZlIHBhdGggb2YgZnJvbnQtZW5kIHN0YXRpYyBmaWxlcyBcbiAgICAgKi8gICAgICAgICBcbiAgICBjb25zdHJ1Y3RvcihuYW1lLCBvcHRpb25zKSB7XG4gICAgICAgIHN1cGVyKG5hbWUsIG9wdGlvbnMpOyAgICAgICAgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEZyb250ZW5kIHNvdXJjZSBmaWxlcyBwYXRoLlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5jbGllbnRQYXRoID0gdGhpcy50b0Fic29sdXRlUGF0aCh0aGlzLm9wdGlvbnMuY2xpZW50UGF0aCB8fCBMaXRlcmFsLkNMSUVOVF9TUkNfUEFUSCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEZyb250ZW5kIHN0YXRpYyBmaWxlcyBwYXRoLlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5wdWJsaWNQYXRoID0gdGhpcy50b0Fic29sdXRlUGF0aCh0aGlzLm9wdGlvbnMucHVibGljUGF0aCB8fCBMaXRlcmFsLlBVQkxJQ19QQVRIKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQmFja2VuZCBmaWxlcyBwYXRoLlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9ICAgICAgICAgXG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5iYWNrZW5kUGF0aCA9IHRoaXMudG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLmJhY2tlbmRQYXRoIHx8IChwcm9jZXNzLmVudi5OT0RFX1JUICYmIHByb2Nlc3MuZW52Lk5PREVfUlQgPT09ICdiYWJlbCcgPyBMaXRlcmFsLkJBQ0tFTkRfU1JDX1BBVEggOiBMaXRlcmFsLkJBQ0tFTkRfUEFUSCkpOyBcblxuICAgICAgICAvKipcbiAgICAgICAgICogRWFjaCBhcHAgaGFzIGl0cyBvd24gcm91dGVyLlxuICAgICAgICAgKiBAbWVtYmVyIHtLb2F9XG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5yb3V0ZXIgPSBuZXcgS29hKCk7XG5cbiAgICAgICAgLy9pbmplY3QgdGhlIGFwcE1vZHVsZSBpbnN0YW5jZSBpbiB0aGUgZmlyc3QgbWlkZGxld2FyZVxuICAgICAgICB0aGlzLnJvdXRlci51c2UoKGN0eCwgbmV4dCkgPT4geyBcbiAgICAgICAgICAgIGN0eC5hcHBNb2R1bGUgPSB0aGlzOyBcbiAgICAgICAgICAgIHJldHVybiBuZXh0KCk7IFxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLm9uKCdjb25maWdMb2FkZWQnLCAoKSA9PiB7XG4gICAgICAgICAgICAvL2xvYWQgbWlkZGxld2FyZXMgaWYgZXhpc3RzIGluIHNlcnZlciBvciBhcHAgcGF0aFxuICAgICAgICAgICAgbGV0IG1pZGRsZXdhcmVEaXIgPSBwYXRoLmpvaW4odGhpcy5iYWNrZW5kUGF0aCwgTGl0ZXJhbC5NSURETEVXQVJFU19QQVRIKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMobWlkZGxld2FyZURpcikpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvYWRNaWRkbGV3YXJlc0Zyb20obWlkZGxld2FyZURpcik7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgIH0pOyAgXG4gICAgfVxuXG4gICAgYXN5bmMgc3RhcnRfKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogTWlkZGxld2FyZSBmYWN0b3J5IHJlZ2lzdHJ5LlxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnkgPSB7fTtcblxuICAgICAgICByZXR1cm4gc3VwZXIuc3RhcnRfKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RvcF8oKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnk7XG5cbiAgICAgICAgcmV0dXJuIHN1cGVyLnN0b3BfKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9hZCBhbmQgcmVnc2l0ZXIgbWlkZGxld2FyZSBmaWxlcyBmcm9tIGEgc3BlY2lmaWVkIHBhdGguXG4gICAgICogQHBhcmFtIGRpclxuICAgICAqL1xuICAgIGxvYWRNaWRkbGV3YXJlc0Zyb20oZGlyKSB7XG4gICAgICAgIGxldCBmaWxlcyA9IGdsb2Iuc3luYyhwYXRoLmpvaW4oZGlyLCAnKi5qcycpLCB7bm9kaXI6IHRydWV9KTtcbiAgICAgICAgZmlsZXMuZm9yRWFjaChmaWxlID0+IHRoaXMucmVnaXN0ZXJNaWRkbGV3YXJlRmFjdG9yeShwYXRoLmJhc2VuYW1lKGZpbGUsICcuanMnKSwgcmVxdWlyZShmaWxlKSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlZ2lzdGVyIHRoZSBmYWN0b3J5IG1ldGhvZCBvZiBhIG5hbWVkIG1pZGRsZXdhcmUuICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBtaWRkbGV3YXJlIFxuICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGZhY3RvcnlNZXRob2QgLSBUaGUgZmFjdG9yeSBtZXRob2Qgb2YgYSBtaWRkbGV3YXJlXG4gICAgICovXG4gICAgcmVnaXN0ZXJNaWRkbGV3YXJlRmFjdG9yeShuYW1lLCBmYWN0b3J5TWV0aG9kKSB7XG4gICAgICAgIHByZTogdHlwZW9mIGZhY3RvcnlNZXRob2QgPT09ICdmdW5jdGlvbicsICdJbnZhbGlkIG1pZGRsZXdhcmUgZmFjdG9yeTogJyArIG5hbWU7ICAgICAgICBcblxuICAgICAgICBpZiAobmFtZSBpbiB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcnMuU2VydmVyRXJyb3IoJ01pZGRsZXdhcmUgXCInKyBuYW1lICsnXCIgYWxyZWFkeSByZWdpc3RlcmVkIScpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5W25hbWVdID0gZmFjdG9yeU1ldGhvZDtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgUmVnaXN0ZXJlZCBuYW1lZCBtaWRkbGV3YXJlIFske25hbWV9XS5gKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGZhY3RvcnkgbWV0aG9kIG9mIGEgbWlkZGxld2FyZSBmcm9tIG1vZHVsZSBoaWVyYXJjaHkuICAgICBcbiAgICAgKiBAcGFyYW0gbmFtZVxuICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbn1cbiAgICAgKi9cbiAgICBnZXRNaWRkbGV3YXJlRmFjdG9yeShuYW1lKSB7XG4gICAgICAgIGlmICh0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnkuaGFzT3duUHJvcGVydHkobmFtZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnlbbmFtZV07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5zZXJ2ZXIgJiYgdGhpcy5zZXJ2ZXIgIT09IHRoaXMpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNlcnZlci5nZXRNaWRkbGV3YXJlRmFjdG9yeShuYW1lKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBucG1NaWRkbGV3YXJlID0gdHJ5UmVxdWlyZShuYW1lKTtcbiAgICAgICAgaWYgKG5wbU1pZGRsZXdhcmUpIHtcbiAgICAgICAgICAgIHJldHVybiBucG1NaWRkbGV3YXJlO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhyb3cgbmV3IEVycm9ycy5TZXJ2ZXJFcnJvcihgRG9uJ3Qga25vdyB3aGVyZSB0byBsb2FkIG1pZGRsZXdhcmUgXCIke25hbWV9XCIuYCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXNlIG1pZGRsZXdhcmVzXG4gICAgICogQHBhcmFtIHtSb3V0ZXJ9IHJvdXRlclxuICAgICAqIEBwYXJhbSB7Kn0gbWlkZGxld2FyZXMgLSBDYW4gYmUgYW4gYXJyYXkgb2YgbWlkZGxld2FyZSBlbnRyaWVzIG9yIGEga2V5LXZhbHVlIGxpc3Qgb2YgcmVnaXN0ZXJyZWQgbWlkZGxld2FyZXNcbiAgICAgKiBAcmV0dXJucyB7Um91dGFibGV9XG4gICAgICovXG4gICAgdXNlTWlkZGxld2FyZXMocm91dGVyLCBtaWRkbGV3YXJlcykge1xuICAgICAgICBsZXQgbWlkZGxld2FyZUZhY3RvcnksIG1pZGRsZXdhcmU7XG4gICAgICAgIGxldCBtaWRkbGV3YXJlRnVuY3Rpb25zID0gW107XG4gICAgICAgIFxuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KG1pZGRsZXdhcmVzKSkge1xuICAgICAgICAgICAgXy5mb3JPd24obWlkZGxld2FyZXMsIChvcHRpb25zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KG5hbWUpOyAgIFxuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeShvcHRpb25zLCB0aGlzKTtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lLCBtaWRkbGV3YXJlIH0pOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbWlkZGxld2FyZXMgPSBfLmNhc3RBcnJheShtaWRkbGV3YXJlcyk7ICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgIF8uZWFjaChtaWRkbGV3YXJlcywgbWlkZGxld2FyZUVudHJ5ID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgdHlwZSA9IHR5cGVvZiBtaWRkbGV3YXJlRW50cnk7XG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gWyAnbmFtZWRNaWRkbGV3YXJlJyBdXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShtaWRkbGV3YXJlRW50cnkpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlID0gbWlkZGxld2FyZUZhY3RvcnkodW5kZWZpbmVkLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5wdXNoKHsgbmFtZTogbWlkZGxld2FyZUVudHJ5ICwgbWlkZGxld2FyZSB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5wdXNoKHsgbmFtZTogbWlkZGxld2FyZUVudHJ5Lm5hbWUgfHwgJ3VuYW1lZCBtaWRkbGV3YXJlJywgbWlkZGxld2FyZTogbWlkZGxld2FyZUVudHJ5fSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KG1pZGRsZXdhcmVFbnRyeSkpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gWyBbICduYW1lZE1pZGRsZXdhcmUnLCBjb25maWcgXSBdXG4gICAgICAgICAgICAgICAgICAgIGlmIChtaWRkbGV3YXJlRW50cnkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3JzLkludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdFbXB0eSBhcnJheSBmb3VuZCBhcyBtaWRkbGV3YXJlIGVudHJ5IScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWlkZGxld2FyZXMnXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmVFbnRyeVswXSk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeShtaWRkbGV3YXJlRW50cnkubGVuZ3RoID4gMSA/IG1pZGRsZXdhcmVFbnRyeVsxXSA6IG51bGwsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lOiBtaWRkbGV3YXJlRW50cnlbMF0sIG1pZGRsZXdhcmUgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFfLmlzUGxhaW5PYmplY3QobWlkZGxld2FyZUVudHJ5KSB8fCAhKCduYW1lJyBpbiBtaWRkbGV3YXJlRW50cnkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3JzLkludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdJbnZhbGlkIG1pZGRsZXdhcmUgZW50cnkhJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtaWRkbGV3YXJlcydcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUVudHJ5Lm5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlID0gbWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUVudHJ5Lm9wdGlvbnMsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lOiBtaWRkbGV3YXJlRW50cnkubmFtZSwgbWlkZGxld2FyZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMuZm9yRWFjaCgoeyBuYW1lLCBtaWRkbGV3YXJlIH0pID0+IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG1pZGRsZXdhcmUpKSB7XG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZS5mb3JFYWNoKG0gPT4gdGhpcy51c2VNaWRkbGV3YXJlKHJvdXRlciwgbSwgbmFtZSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVzZU1pZGRsZXdhcmUocm91dGVyLCBtaWRkbGV3YXJlLCBuYW1lKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSByb3V0ZSB0byBhIHJvdXRlciwgc2tpcHBlZCB3aGlsZSB0aGUgc2VydmVyIHJ1bm5pbmcgaW4gZGVhZiBtb2RlLiAgICAgXG4gICAgICogQHBhcmFtIHJvdXRlclxuICAgICAqIEBwYXJhbSBtZXRob2RcbiAgICAgKiBAcGFyYW0gcm91dGVcbiAgICAgKiBAcGFyYW0gYWN0aW9uc1xuICAgICAqL1xuICAgIGFkZFJvdXRlKHJvdXRlciwgbWV0aG9kLCByb3V0ZSwgYWN0aW9ucykge1xuICAgICAgICBsZXQgaGFuZGxlcnMgPSBbXSwgbWlkZGxld2FyZUZhY3Rvcnk7XG5cbiAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChhY3Rpb25zKSkge1xuICAgICAgICAgICAgXy5mb3JPd24oYWN0aW9ucywgKG9wdGlvbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSk7XG4gICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaCh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlRmFjdG9yeShvcHRpb25zLCB0aGlzKSwgbmFtZSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhY3Rpb25zID0gXy5jYXN0QXJyYXkoYWN0aW9ucyk7XG4gICAgICAgICAgICBsZXQgbGFzdEluZGV4ID0gYWN0aW9ucy5sZW5ndGggLSAxO1xuXG4gICAgICAgICAgICBfLmVhY2goYWN0aW9ucywgKGFjdGlvbiwgaSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCB0eXBlID0gdHlwZW9mIGFjdGlvbjtcblxuICAgICAgICAgICAgICAgIGlmIChpID09PSBsYXN0SW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gbGFzdCBtaWRkbGV3YXJlIG1heSBiZSBhbiBhY3Rpb25cbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnICYmIGFjdGlvbi5sYXN0SW5kZXhPZignLicpID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICdhY3Rpb24nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IGFjdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICdvYmplY3QnO1xuICAgICAgICAgICAgICAgICAgICB9ICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAvLyBbICduYW1lZE1pZGRsZXdhcmUnIF1cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvbik7ICAgXG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeShudWxsLCB0aGlzKTtcblxuICAgICAgICAgICAgICAgICAgICAvL2luIGNhc2UgaXQncyByZWdpc3RlciBieSB0aGUgbWlkZGxld2FyZUZhY3RvcnkgZmVhdHVyZVxuICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShtaWRkbGV3YXJlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZS5mb3JFYWNoKChtaWRkbGV3YXJlSXRlbSwgaSkgPT4gaGFuZGxlcnMucHVzaChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlSXRlbSwgYCR7YWN0aW9ufS0ke2l9YCArIChtaWRkbGV3YXJlLm5hbWUgPyAoJy0nICsgbWlkZGxld2FyZS5uYW1lKSA6ICcnKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICkpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmUsIGFjdGlvbikpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIoYWN0aW9uKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGFjdGlvbikpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiBhY3Rpb24ubGVuZ3RoID4gMCAmJiBhY3Rpb24ubGVuZ3RoIDw9IDIsICdJbnZhbGlkIG1pZGRsZXdhcmUgZW50cnknO1xuXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShhY3Rpb25bMF0pOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uLmxlbmd0aCA+IDEgPyBhY3Rpb25bMV0gOiB1bmRlZmluZWQsIHRoaXMpKSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQ6IF8uaXNQbGFpbk9iamVjdChhY3Rpb24pICYmICduYW1lJyBpbiBhY3Rpb24sICdJbnZhbGlkIG1pZGRsZXdhcmUgZW50cnknO1xuXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShhY3Rpb24ubmFtZSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaCh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlRmFjdG9yeShhY3Rpb24ub3B0aW9ucywgdGhpcyksIGFjdGlvbi5uYW1lKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIHJvdXRlclttZXRob2RdKHJvdXRlLCAuLi5oYW5kbGVycyk7XG5cbiAgICAgICAgbGV0IGVuZHBvaW50ID0gcm91dGVyLm9wdHMucHJlZml4ID8gdXJsSm9pbih0aGlzLnJvdXRlLCByb3V0ZXIub3B0cy5wcmVmaXgsIHJvdXRlKSA6IHVybEpvaW4odGhpcy5yb3V0ZSwgcm91dGUpO1xuXG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYFJvdXRlIFwiJHttZXRob2R9OiR7ZW5kcG9pbnR9XCIgaXMgYWRkZWQgZnJvbSBtb2R1bGUgWyR7dGhpcy5uYW1lfV0uYCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfSAgICBcblxuICAgIC8qKlxuICAgICAqIEF0dGFjaCBhIHJvdXRlciB0byB0aGlzIGFwcCBtb2R1bGUsIHNraXBwZWQgd2hpbGUgdGhlIHNlcnZlciBydW5uaW5nIGluIGRlYWYgbW9kZSAgICAgXG4gICAgICogQHBhcmFtIHtSb3V0ZXJ9IG5lc3RlZFJvdXRlclxuICAgICAqL1xuICAgIGFkZFJvdXRlcihuZXN0ZWRSb3V0ZXIpIHtcbiAgICAgICAgdGhpcy5yb3V0ZXIudXNlKG5lc3RlZFJvdXRlci5yb3V0ZXMoKSk7XG4gICAgICAgIHRoaXMucm91dGVyLnVzZShuZXN0ZWRSb3V0ZXIuYWxsb3dlZE1ldGhvZHMoKSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRyYW5zbGF0ZSBhIHJlbGF0aXZlIHBhdGggYW5kIHF1ZXJ5IHBhcmFtZXRlcnMgaWYgYW55IHRvIGEgdXJsIHBhdGggICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSByZWxhdGl2ZVBhdGggLSBSZWxhdGl2ZSBwYXRoXG4gICAgICogQHBhcmFtIHsuLi4qfSBbcGF0aE9yUXVlcnldIC0gUXVlcmllc1xuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAgICovXG4gICAgdG9XZWJQYXRoKHJlbGF0aXZlUGF0aCwgLi4ucGF0aE9yUXVlcnkpIHtcbiAgICAgICAgbGV0IHVybCwgcXVlcnk7XG5cbiAgICAgICAgaWYgKHBhdGhPclF1ZXJ5ICYmIHBhdGhPclF1ZXJ5Lmxlbmd0aCA+IDAgJiYgKHBhdGhPclF1ZXJ5Lmxlbmd0aCA+IDEgfHwgcGF0aE9yUXVlcnlbMF0gIT09IHVuZGVmaW5lZCkpIHtcbiAgICAgICAgICAgIGlmIChfLmlzT2JqZWN0KHBhdGhPclF1ZXJ5W3BhdGhPclF1ZXJ5Lmxlbmd0aCAtIDFdKSkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5ID0gcGF0aE9yUXVlcnkucG9wKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwYXRoT3JRdWVyeS51bnNoaWZ0KHJlbGF0aXZlUGF0aCk7XG4gICAgICAgICAgICB1cmwgPSB1cmxKb2luKHRoaXMucm91dGUsIC4uLnBhdGhPclF1ZXJ5KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHVybCA9IHVybEpvaW4odGhpcy5yb3V0ZSwgcmVsYXRpdmVQYXRoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHVybCA9IGVuc3VyZUxlZnRTbGFzaCh1cmwpO1xuXG4gICAgICAgIGlmIChxdWVyeSkge1xuICAgICAgICAgICAgdXJsID0gdXJsQXBwZW5kUXVlcnkodXJsLCBxdWVyeSk7XG4gICAgICAgICAgICB1cmwgPSB1cmwucmVwbGFjZSgnLz8nLCAnPycpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHVybDtcbiAgICB9ICAgIFxuXG4gICAgLyoqXG4gICAgICogUHJlcGFyZSBjb250ZXh0IGZvciBrb2EgYWN0aW9uXG4gICAgICogQHBhcmFtIHtPYmplY3R9IGN0eCAtIEtvYSByZXF1ZXN0IGNvbnRleHRcbiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBhY3Rpb24gLSBBY3Rpb24gZnVuY3Rpb25cbiAgICAgKiBAcmV0dXJuIHtmdW5jdGlvbn1cbiAgICAgKi9cbiAgICB3cmFwQWN0aW9uKGFjdGlvbikge1xuICAgICAgICByZXR1cm4gYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICAgICAgY3R4LnRvVXJsID0gKHJlbGF0aXZlUGF0aCwgLi4ucGF0aE9yUXVlcnkpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY3R4Lm9yaWdpbiArIHRoaXMudG9XZWJQYXRoKHJlbGF0aXZlUGF0aCwgLi4ucGF0aE9yUXVlcnkpO1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihjdHguc3RhdGUsIHtcbiAgICAgICAgICAgICAgICBfc2VsZjogY3R4Lm9yaWdpbmFsVXJsIHx8IHRoaXMudG9XZWJQYXRoKGN0eC51cmwpLFxuICAgICAgICAgICAgICAgIF9fOiBjdHguX18sXG4gICAgICAgICAgICAgICAgX2Jhc2U6IGVuc3VyZVJpZ2h0U2xhc2godGhpcy50b1dlYlBhdGgoKSksXG4gICAgICAgICAgICAgICAgX21ha2VQYXRoOiAocmVsYXRpdmVQYXRoLCBxdWVyeSkgPT4gdGhpcy50b1dlYlBhdGgocmVsYXRpdmVQYXRoLCBxdWVyeSksXG4gICAgICAgICAgICAgICAgX21ha2VVcmw6IChyZWxhdGl2ZVBhdGgsIHF1ZXJ5KSA9PiBjdHgudG9VcmwocmVsYXRpdmVQYXRoLCBxdWVyeSkgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoY3R4LmNzcmYpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjdHguc3RhdGUuX2NzcmYgPSBjdHguY3NyZjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGFjdGlvbihjdHgpO1xuICAgICAgICB9OyAgICAgICAgXG4gICAgfSAgIFxuXG4gICAgdXNlTWlkZGxld2FyZShyb3V0ZXIsIG1pZGRsZXdhcmUsIG5hbWUpIHsgICAgICAgICAgXG4gICAgICAgIGFzc2VydDogdHlwZW9mIG1pZGRsZXdhcmUgPT09ICdmdW5jdGlvbicsIG1pZGRsZXdhcmU7XG4gICAgICAgIHJvdXRlci51c2UodGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZSwgbmFtZSkpO1xuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBBdHRhY2hlZCBtaWRkbGV3YXJlIFske25hbWV9XS5gKTtcbiAgICB9XG5cbiAgICBfd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZSwgbmFtZSkgeyAgICAgICAgXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMudHJhY2VNaWRkbGV3YXJlcykgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGFzeW5jIChjdHgsIG5leHQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZygnZGVidWcnLCBgU3RlcCBpbiBtaWRkbGV3YXJlIFwiJHtuYW1lIHx8IG1pZGRsZXdhcmUubmFtZX1cIiAuLi5gKTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IG1pZGRsZXdhcmUoY3R4LCBuZXh0KTtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZygnZGVidWcnLCBgU3RlcCBvdXQgZnJvbSBtaWRkbGV3YXJlIFwiJHtuYW1lIHx8IG1pZGRsZXdhcmUubmFtZX1cIi5gKTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBtaWRkbGV3YXJlO1xuICAgIH1cblxuICAgIF9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoKCkge1xuICAgICAgICByZXR1cm4gc3VwZXIuX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKS5jb25jYXQoWyBwYXRoLmpvaW4odGhpcy5iYWNrZW5kUGF0aCwgTGl0ZXJhbC5GRUFUVVJFU19QQVRIKSBdKTtcbiAgICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFJvdXRhYmxlOyJdfQ==