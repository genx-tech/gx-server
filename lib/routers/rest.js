"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  text
} = require('@genx/july');

const {
  glob
} = require('@genx/sys');

const {
  InvalidConfiguration
} = require('@genx/error');

const Router = require('@koa/router');

const Literal = require('../enum/Literal');

const {
  hasMethod
} = require('../utils/Helpers');

module.exports = (app, baseRoute, options) => {
  let resourcePath = path.resolve(app.backendPath, options.resourcesPath || Literal.RESOURCES_PATH);
  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(options.errorOptions, app), 'jsonError');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let resourcesPath = path.join(resourcePath, "**", "*.js");
  let files = glob.sync(resourcesPath, {
    nodir: true
  });

  _.each(files, file => {
    let relPath = path.relative(resourcePath, file);
    let batchUrl = text.ensureStartsWith(relPath.substring(0, relPath.length - 3).split(path.sep).map(p => _.kebabCase(p)).join('/'), '/');
    let singleUrl = batchUrl + '/:id';

    let controller = require(file);

    if (typeof controller === 'function') {
      controller = new controller(app);
    }

    if (hasMethod(controller, 'query')) {
      app.addRoute(router, 'get', batchUrl, ctx => controller.query(ctx));
    }

    if (hasMethod(controller, 'create')) {
      app.addRoute(router, 'post', batchUrl, ctx => controller.create(ctx));
    }

    if (hasMethod(controller, 'detail')) {
      app.addRoute(router, 'get', singleUrl, ctx => controller.detail(ctx));
    }

    if (hasMethod(controller, 'update')) {
      app.addRoute(router, 'put', singleUrl, ctx => controller.update(ctx));
    }

    if (hasMethod(controller, 'remove')) {
      app.addRoute(router, 'del', singleUrl, ctx => controller.remove(ctx));
    }
  });

  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL3Jlc3QuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwidGV4dCIsImdsb2IiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsIlJvdXRlciIsIkxpdGVyYWwiLCJoYXNNZXRob2QiLCJtb2R1bGUiLCJleHBvcnRzIiwiYXBwIiwiYmFzZVJvdXRlIiwib3B0aW9ucyIsInJlc291cmNlUGF0aCIsInJlc29sdmUiLCJiYWNrZW5kUGF0aCIsInJlc291cmNlc1BhdGgiLCJSRVNPVVJDRVNfUEFUSCIsInJvdXRlciIsInByZWZpeCIsInVzZU1pZGRsZXdhcmUiLCJnZXRNaWRkbGV3YXJlRmFjdG9yeSIsImVycm9yT3B0aW9ucyIsIm1pZGRsZXdhcmVzIiwidXNlTWlkZGxld2FyZXMiLCJqb2luIiwiZmlsZXMiLCJzeW5jIiwibm9kaXIiLCJlYWNoIiwiZmlsZSIsInJlbFBhdGgiLCJyZWxhdGl2ZSIsImJhdGNoVXJsIiwiZW5zdXJlU3RhcnRzV2l0aCIsInN1YnN0cmluZyIsImxlbmd0aCIsInNwbGl0Iiwic2VwIiwibWFwIiwicCIsImtlYmFiQ2FzZSIsInNpbmdsZVVybCIsImNvbnRyb2xsZXIiLCJhZGRSb3V0ZSIsImN0eCIsInF1ZXJ5IiwiY3JlYXRlIiwiZGV0YWlsIiwidXBkYXRlIiwicmVtb3ZlIiwiYWRkUm91dGVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBY0YsT0FBTyxDQUFDLFlBQUQsQ0FBM0I7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQTtBQUFGLElBQVdILE9BQU8sQ0FBQyxXQUFELENBQXhCOztBQUNBLE1BQU07QUFBRUksRUFBQUE7QUFBRixJQUEyQkosT0FBTyxDQUFDLGFBQUQsQ0FBeEM7O0FBQ0EsTUFBTUssTUFBTSxHQUFHTCxPQUFPLENB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LFFBQWIsQ0FBYixFQUFxQztBQUNqQ2pDLE1BQUFBLEdBQUcsQ0FBQ2tDLFFBQUosQ0FBYTFCLE1BQWIsRUFBcUIsS0FBckIsRUFBNEJ3QixTQUE1QixFQUF1Q0csR0FBRyxJQUFJRixVQUFVLENBQUNLLE1BQVgsQ0FBa0JILEdBQWxCLENBQTlDO0FBQ0g7O0FBRUQsUUFBSXRDLFNBQVMsQ0FBQ29DLFVBQUQsRUFBYSxRQUFiLENBQWIsRUFBcUM7QUFDakNqQyxNQUFBQSxHQUFHLENBQUNrQyxRQUFKLENBQWExQixNQUFiLEVBQXFCLEtBQXJCLEVBQTRCd0IsU0FBNUIsRUFBdUNHLEdBQUcsSUFBSUYsVUFBVSxDQUFDTSxNQUFYLENBQWtCSixHQUFsQixDQUE5QztBQUNIOztBQUVELFFBQUl0QyxTQUFTLENBQUNvQyxVQUFELEVBQWEsUUFBYixDQUFiLEVBQXFDO0FBQ2pDakMsTUFBQUEsR0FBRyxDQUFDa0MsUUFBSixDQUFhMUIsTUFBYixFQUFxQixLQUFyQixFQUE0QndCLFNBQTVCLEVBQXVDRyxHQUFHLElBQUlGLFVBQVUsQ0FBQ08sTUFBWCxDQUFrQkwsR0FBbEIsQ0FBOUM7QUFDSDtBQUNKLEdBOUJEOztBQWdDQW5DLEVBQUFBLEdBQUcsQ0FBQ3lDLFNBQUosQ0FBY2pDLE1BQWQ7QUFDSCxDQS9DRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCB0ZXh0IH0gPSByZXF1aXJlKCdAZ2VueC9qdWx5Jyk7XG5jb25zdCB7IGdsb2IgfSA9IHJlcXVpcmUoJ0BnZW54L3N5cycpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiB9ID0gcmVxdWlyZSgnQGdlbngvZXJyb3InKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJ0Brb2Evcm91dGVyJyk7XG5jb25zdCBMaXRlcmFsID0gcmVxdWlyZSgnLi4vZW51bS9MaXRlcmFsJyk7XG5jb25zdCB7IGhhc01ldGhvZCB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvSGVscGVycycpO1xuXG4vKipcbiAqIFJFU1RmdWwgcm91dGVyLlxuICogQG1vZHVsZSBSb3V0ZXJfUmVzdFxuICovXG5cbi8qKlxuICogQ3JlYXRlIGEgUkVTVGZ1bCByb3V0ZXIuXG4gKiBAcGFyYW0geyp9IGFwcCBcbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUm91dGUgXG4gKiBAcGFyYW0ge29iamVjdHN9IG9wdGlvbnMgXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucmVzb3VyY2VzUGF0aF1cbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fGFycmF5fSBbb3B0aW9ucy5taWRkbGV3YXJlc11cbiAqIEBleGFtcGxlXG4gKiAgJzxiYXNlIHBhdGg+Jzoge1xuICogICAgICByZXN0OiB7XG4gKiAgICAgICAgICByZXNvdXJjZXNQYXRoOlxuICogICAgICAgICAgbWlkZGxld2FyZXM6XG4gKiAgICAgIH1cbiAqICB9XG4gKiAgXG4gKiAgcm91dGUgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAgbWV0aG9kICAgIGZ1bmN0aW9uIG9mIGN0cmxcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgcXVlcnlcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgcG9zdCAgICAgICAgICAgY3JlYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIGRldGFpbFxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBwdXQgICAgICAgICAgICB1cGRhdGVcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZGVsZXRlICAgICAgICAgcmVtb3ZlIFxuICovXG5tb2R1bGUuZXhwb3J0cyA9IChhcHAsIGJhc2VSb3V0ZSwgb3B0aW9ucykgPT4ge1xuICAgIGxldCByZXNvdXJjZVBhdGggPSBwYXRoLnJlc29sdmUoYXBwLmJhY2tlbmRQYXRoLCBvcHRpb25zLnJlc291cmNlc1BhdGggfHwgTGl0ZXJhbC5SRVNPVVJDRVNfUEFUSCk7XG4gICAgXG4gICAgbGV0IHJvdXRlciA9IGJhc2VSb3V0ZSA9PT0gJy8nID8gbmV3IFJvdXRlcigpIDogbmV3IFJvdXRlcih7cHJlZml4OiBiYXNlUm91dGV9KTtcblxuICAgIGFwcC51c2VNaWRkbGV3YXJlKHJvdXRlciwgYXBwLmdldE1pZGRsZXdhcmVGYWN0b3J5KCdqc29uRXJyb3InKShvcHRpb25zLmVycm9yT3B0aW9ucywgYXBwKSwgJ2pzb25FcnJvcicpO1xuXG4gICAgaWYgKG9wdGlvbnMubWlkZGxld2FyZXMpIHtcbiAgICAgICAgYXBwLnVzZU1pZGRsZXdhcmVzKHJvdXRlciwgb3B0aW9ucy5taWRkbGV3YXJlcyk7XG4gICAgfVxuXG4gICAgbGV0IHJlc291cmNlc1BhdGggPSBwYXRoLmpvaW4ocmVzb3VyY2VQYXRoLCBcIioqXCIsIFwiKi5qc1wiKTtcbiAgICBsZXQgZmlsZXMgPSBnbG9iLnN5bmMocmVzb3VyY2VzUGF0aCwge25vZGlyOiB0cnVlfSk7XG5cbiAgICBfLmVhY2goZmlsZXMsIGZpbGUgPT4ge1xuICAgICAgICBsZXQgcmVsUGF0aCA9IHBhdGgucmVsYXRpdmUocmVzb3VyY2VQYXRoLCBmaWxlKTsgICAgICAgICAgXG4gICAgICAgIGxldCBiYXRjaFVybCA9IHRleHQuZW5zdXJlU3RhcnRzV2l0aChyZWxQYXRoLnN1YnN0cmluZygwLCByZWxQYXRoLmxlbmd0aCAtIDMpLnNwbGl0KHBhdGguc2VwKS5tYXAocCA9PiBfLmtlYmFiQ2FzZShwKSkuam9pbignLycpLCAnLycpO1xuICAgICAgICBsZXQgc2luZ2xlVXJsID0gYmF0Y2hVcmwgKyAnLzppZCc7IFxuICAgICAgICBcbiAgICAgICAgbGV0IGNvbnRyb2xsZXIgPSByZXF1aXJlKGZpbGUpO1xuXG4gICAgICAgIGlmICh0eXBlb2YgY29udHJvbGxlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgY29udHJvbGxlciA9IG5ldyBjb250cm9sbGVyKGFwcCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdxdWVyeScpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgYmF0Y2hVcmwsIGN0eCA9PiBjb250cm9sbGVyLnF1ZXJ5KGN0eCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAnY3JlYXRlJykpIHtcbiAgICAgICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwb3N0JywgYmF0Y2hVcmwsIGN0eCA9PiBjb250cm9sbGVyLmNyZWF0ZShjdHgpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ2RldGFpbCcpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0Jywgc2luZ2xlVXJsLCBjdHggPT4gY29udHJvbGxlci5kZXRhaWwoY3R4KSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICd1cGRhdGUnKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3B1dCcsIHNpbmdsZVVybCwgY3R4ID0+IGNvbnRyb2xsZXIudXBkYXRlKGN0eCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAncmVtb3ZlJykpIHtcbiAgICAgICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdkZWwnLCBzaW5nbGVVcmwsIGN0eCA9PiBjb250cm9sbGVyLnJlbW92ZShjdHgpKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgYXBwLmFkZFJvdXRlcihyb3V0ZXIpO1xufTsiXX0=