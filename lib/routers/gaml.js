"use strict";

require("source-map-support/register");

const path = require("path");

const {
  glob
} = require("@genx/sys");

const {
  _,
  naming,
  text
} = require("@genx/july");

const Literal = require("../enum/Literal");

const Router = require("@koa/router");

const {
  hasMethod
} = require("../utils/Helpers");

const appendId = (baseEndpoint, idName) => idName ? `${baseEndpoint}/:${idName}` : baseEndpoint;

module.exports = (app, baseRoute, options) => {
  let resourcePath = path.resolve(app.backendPath, options.resourcesPath || Literal.RESOURCES_PATH);
  let router = baseRoute === "/" ? new Router() : new Router({
    prefix: text.dropIfEndsWith(baseRoute, '/')
  });
  app.useMiddleware(router, app.getMiddlewareFactory("jsonError")(options.errorOptions, app), "jsonError");

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let resourcesPath = path.join(resourcePath, "*.js");
  let files = glob.sync(resourcesPath, {
    nodir: true
  });

  _.each(files, file => {
    let entityName = path.basename(file, ".js");

    let controller = require(file);

    if (typeof controller === "function") {
      controller = new controller(app);
    }

    let baseEndpoint;

    if (options.remaps && entityName in options.remaps) {
      baseEndpoint = text.ensureStartsWith(text.dropIfEndsWith(options.remaps[entityName], "/"), "/");
    } else {
      baseEndpoint = text.ensureStartsWith(naming.kebabCase(entityName), "/");
    }

    let idName = naming.camelCase(entityName) + "Id";
    let endpointWithId = appendId(baseEndpoint, idName);

    if (hasMethod(controller, "find")) {
      app.addRoute(router, "get", baseEndpoint, ctx => controller.find(ctx));
    }

    if (hasMethod(controller, "post")) {
      app.addRoute(router, "post", baseEndpoint, ctx => controller.post(ctx));
    }

    if (hasMethod(controller, "findById")) {
      app.addRoute(router, "get", endpointWithId, ctx => controller.findById(ctx, ctx.params[idName]));
    }

    if (hasMethod(controller, "updateById")) {
      app.addRoute(router, "put", endpointWithId, ctx => controller.updateById(ctx, ctx.params[idName]));
    }

    if (hasMethod(controller, "deleteById")) {
      app.addRoute(router, "del", endpointWithId, ctx => controller.deleteById(ctx, ctx.params[idName]));
    }
  });

  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhbWwuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJnbG9iIiwiXyIsIm5hbWluZyIsInRleHQiLCJMaXRlcmFsIiwiUm91dGVyIiwiaGFzTWV0aG9kIiwiYXBwZW5kSWQiLCJiYXNlRW5kcG9pbnQiLCJpZE5hbWUiLCJtb2R1bGUiLCJleHBvcnRzIiwiYXBwIiwiYmFzZVJvdXRlIiwib3B0aW9ucyIsInJlc291cmNlUGF0aCIsInJlc29sdmUiLCJiYWNrZW5kUGF0aCIsInJlc291cmNlc1BhdGgiLCJSRVNPVVJDRVNfUEFUSCIsInJvdXRlciIsInByZWZpeCIsImRyb3BJZkVuZHNXaXRoIiwidXNlTWlkZGxld2FyZSIsImdldE1pZGRsZXdhcmVGYWN0b3J5IiwiZXJyb3JPcHRpb25zIiwibWlkZGxld2FyZXMiLCJ1c2VNaWRkbGV3YXJlcyIsImpvaW4iLCJmaWxlcyIsInN5bmMiLCJub2RpciIsImVhY2giLCJmaWxlIiwiZW50aXR5TmFtZSIsImJhc2VuYW1lIiwiY29udHJvbGxlciIsInJlbWFwcyIsImVuc3VyZVN0YXJ0c1dpdGgiLCJrZWJhYkNhc2UiLCJjYW1lbENhc2UiLCJlbmRwb2ludFdpdGhJZCIsImFkZFJvdXRlIiwiY3R4IiwiZmluZCIsInBvc3QiLCJmaW5kQnlJZCIsInBhcmFtcyIsInVwZGF0ZUJ5SWQiLCJkZWxldGVCeUlkIiwiYWRkUm91dGVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQVdELE9BQU8sQ0FBQyxXQUFELENBQXhCOztBQUNBLE1BQU07QUFBRUUsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxNQUFMO0FBQWFDLEVBQUFBO0FBQWIsSUFBc0JKLE9BQU8sQ0FBQyxZQUFELENBQW5DOztBQUNBLE1BQU1LLE9BQU8sR0FBR0wsT0FBTyxDQUFDLGlCQUFELENB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QUFYLENBQTNCLENBQXJEO0FBQ0g7QUFDSixHQXRDRDs7QUF3Q0FHLEVBQUFBLEdBQUcsQ0FBQ3NDLFNBQUosQ0FBYzlCLE1BQWQ7QUFDSCxDQXZERCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XG5jb25zdCB7IGdsb2IgfSA9IHJlcXVpcmUoXCJAZ2VueC9zeXNcIik7XG5jb25zdCB7IF8sIG5hbWluZywgdGV4dCB9ID0gcmVxdWlyZShcIkBnZW54L2p1bHlcIik7XG5jb25zdCBMaXRlcmFsID0gcmVxdWlyZShcIi4uL2VudW0vTGl0ZXJhbFwiKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoXCJAa29hL3JvdXRlclwiKTtcbmNvbnN0IHsgaGFzTWV0aG9kIH0gPSByZXF1aXJlKFwiLi4vdXRpbHMvSGVscGVyc1wiKTtcblxuLyoqXG4gKiBHYW1sIHJvdXRlci5cbiAqIEBtb2R1bGUgUm91dGVyX0dhbWxcbiAqL1xuXG5jb25zdCBhcHBlbmRJZCA9IChiYXNlRW5kcG9pbnQsIGlkTmFtZSkgPT4gKGlkTmFtZSA/IGAke2Jhc2VFbmRwb2ludH0vOiR7aWROYW1lfWAgOiBiYXNlRW5kcG9pbnQpO1xuXG4vKipcbiAqIENyZWF0ZSBhIGdhbWwgcm91dGVyLlxuICogQHBhcmFtIHsqfSBhcHBcbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUm91dGVcbiAqIEBwYXJhbSB7b2JqZWN0c30gb3B0aW9uc1xuICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnJlc291cmNlc1BhdGhdXG4gKiBAcHJvcGVydHkge29iamVjdHxhcnJheX0gW29wdGlvbnMubWlkZGxld2FyZXNdXG4gKiBAZXhhbXBsZVxuICogICc8YmFzZSBwYXRoPic6IHtcbiAqICAgICAgZ2FtbDoge1xuICogICAgICAgICAgcmVzb3VyY2VzUGF0aDpcbiAqICAgICAgICAgIG1pZGRsZXdhcmVzOlxuICogICAgICB9XG4gKiAgfVxuICpcbiAqICByb3V0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cCBtZXRob2QgICAgZnVuY3Rpb24gb2YgY3RybFxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBmaW5kXG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIHBvc3QgICAgICAgICAgIHBvc3RcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgZmluZEJ5SWRcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgcHV0ICAgICAgICAgICAgdXBkYXRlQnlJZFxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBkZWwgICAgICAgICAgICBkZWxldGVCeUlkXG4gKi9cbm1vZHVsZS5leHBvcnRzID0gKGFwcCwgYmFzZVJvdXRlLCBvcHRpb25zKSA9PiB7XG4gICAgbGV0IHJlc291cmNlUGF0aCA9IHBhdGgucmVzb2x2ZShhcHAuYmFja2VuZFBhdGgsIG9wdGlvbnMucmVzb3VyY2VzUGF0aCB8fCBMaXRlcmFsLlJFU09VUkNFU19QQVRIKTtcblxuICAgIGxldCByb3V0ZXIgPSBiYXNlUm91dGUgPT09IFwiL1wiID8gbmV3IFJvdXRlcigpIDogbmV3IFJvdXRlcih7IHByZWZpeDogdGV4dC5kcm9wSWZFbmRzV2l0aChiYXNlUm91dGUsICcvJykgfSk7XG5cbiAgICBhcHAudXNlTWlkZGxld2FyZShyb3V0ZXIsIGFwcC5nZXRNaWRkbGV3YXJlRmFjdG9yeShcImpzb25FcnJvclwiKShvcHRpb25zLmVycm9yT3B0aW9ucywgYXBwKSwgXCJqc29uRXJyb3JcIik7XG5cbiAgICBpZiAob3B0aW9ucy5taWRkbGV3YXJlcykge1xuICAgICAgICBhcHAudXNlTWlkZGxld2FyZXMocm91dGVyLCBvcHRpb25zLm1pZGRsZXdhcmVzKTtcbiAgICB9XG5cbiAgICBsZXQgcmVzb3VyY2VzUGF0aCA9IHBhdGguam9pbihyZXNvdXJjZVBhdGgsIFwiKi5qc1wiKTtcbiAgICBsZXQgZmlsZXMgPSBnbG9iLnN5bmMocmVzb3VyY2VzUGF0aCwgeyBub2RpcjogdHJ1ZSB9KTtcblxuICAgIF8uZWFjaChmaWxlcywgKGZpbGUpID0+IHtcbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBwYXRoLmJhc2VuYW1lKGZpbGUsIFwiLmpzXCIpO1xuICAgICAgICBsZXQgY29udHJvbGxlciA9IHJlcXVpcmUoZmlsZSk7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBjb250cm9sbGVyID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBuZXcgY29udHJvbGxlcihhcHApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGJhc2VFbmRwb2ludDtcblxuICAgICAgICBpZiAob3B0aW9ucy5yZW1hcHMgJiYgZW50aXR5TmFtZSBpbiBvcHRpb25zLnJlbWFwcykge1xuICAgICAgICAgICAgYmFzZUVuZHBvaW50ID0gdGV4dC5lbnN1cmVTdGFydHNXaXRoKHRleHQuZHJvcElmRW5kc1dpdGgob3B0aW9ucy5yZW1hcHNbZW50aXR5TmFtZV0sIFwiL1wiKSwgXCIvXCIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYmFzZUVuZHBvaW50ID0gdGV4dC5lbnN1cmVTdGFydHNXaXRoKG5hbWluZy5rZWJhYkNhc2UoZW50aXR5TmFtZSksIFwiL1wiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBpZE5hbWUgPSBuYW1pbmcuY2FtZWxDYXNlKGVudGl0eU5hbWUpICsgXCJJZFwiO1xuICAgICAgICBsZXQgZW5kcG9pbnRXaXRoSWQgPSBhcHBlbmRJZChiYXNlRW5kcG9pbnQsIGlkTmFtZSk7XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCBcImZpbmRcIikpIHtcbiAgICAgICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsIFwiZ2V0XCIsIGJhc2VFbmRwb2ludCwgKGN0eCkgPT4gY29udHJvbGxlci5maW5kKGN0eCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCBcInBvc3RcIikpIHtcbiAgICAgICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsIFwicG9zdFwiLCBiYXNlRW5kcG9pbnQsIChjdHgpID0+IGNvbnRyb2xsZXIucG9zdChjdHgpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgXCJmaW5kQnlJZFwiKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgXCJnZXRcIiwgZW5kcG9pbnRXaXRoSWQsIChjdHgpID0+IGNvbnRyb2xsZXIuZmluZEJ5SWQoY3R4LCBjdHgucGFyYW1zW2lkTmFtZV0pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgXCJ1cGRhdGVCeUlkXCIpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCBcInB1dFwiLCBlbmRwb2ludFdpdGhJZCwgKGN0eCkgPT4gY29udHJvbGxlci51cGRhdGVCeUlkKGN0eCwgY3R4LnBhcmFtc1tpZE5hbWVdKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsIFwiZGVsZXRlQnlJZFwiKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgXCJkZWxcIiwgZW5kcG9pbnRXaXRoSWQsIChjdHgpID0+IGNvbnRyb2xsZXIuZGVsZXRlQnlJZChjdHgsIGN0eC5wYXJhbXNbaWROYW1lXSkpO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICBhcHAuYWRkUm91dGVyKHJvdXRlcik7XG59O1xuIl19