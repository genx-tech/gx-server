{"version":3,"file":"rule.js","names":["require","_","text","Router","InvalidConfiguration","Literal","load_","app","baseRoute","options","router","prefix","dropIfEndsWith","middlewares","useMiddlewares","forOwn","rules","methods","subRoute","pos","indexOf","embeddedMethod","substr","toLocaleLowerCase","ensureStartsWith","Array","isArray","get","method","ALLOWED_HTTP_METHODS","has","addRoute","addRouter","module","exports"],"sources":["../../src/routers/rule.js"],"sourcesContent":["\"use strict\";\n\nconst { _, text } = require(\"@genx/july\");\nconst Router = require(\"@koa/router\");\nconst { InvalidConfiguration } = require(\"@genx/error\");\nconst Literal = require(\"../enum/Literal\");\n\n/**\n * Rule based router.\n * @module Router_Rule\n */\n\n/**\n * Create a rule-based router.\n * @param {WebModule} app\n * @param {string} baseRoute\n * @param {object} options\n * @example\n * '<base path>': {\n *     rule: {\n *         middlewares:\n *         rules: {\n *             // type 1, default is \"get\", methods mapped to one action\n *             '<sub route>': '<controller with relative path>.<action>',\n *\n *             // type 2, different methods mapped to different method\n *             '<sub route>': {\n *                '<method>': '<controller with relative path>.<action>'\n *             },\n *\n *             // type 3, with middleware\n *             '<sub route>': {\n *                 '<method>': {\n *                    '<middleware name>': { //middleware options }\n *                 }\n *             },\n *\n *             // type 4, all methods mapped to one action\n *             '<method>:/<sub route>': '<controller with relative path>.<action>'\n *\n *             // type 5, all methods mapped to one action\n *             '<method>:/<sub route>': {\n *                 '<middleware name>': { //middleware options }\n *             }\n *         }\n *     }\n * }\n */\nfunction load_(app, baseRoute, options) {\n    let router = baseRoute === \"/\" ? new Router() : new Router({ prefix: text.dropIfEndsWith(baseRoute, \"/\") });\n\n    if (options.middlewares) {\n        app.useMiddlewares(router, options.middlewares);\n    }\n\n    _.forOwn(options.rules || {}, (methods, subRoute) => {\n        let pos = subRoute.indexOf(\":/\");\n\n        if (pos !== -1) {\n            if (pos === 0) {\n                throw new InvalidConfiguration(\n                    \"Invalid route rule syntax: \" + subRoute,\n                    app,\n                    `routing[${baseRoute}].rule.rules`\n                );\n            }\n\n            // like get:/, or post:/\n\n            let embeddedMethod = subRoute.substr(0, pos).toLocaleLowerCase();\n            subRoute = subRoute.substr(pos + 2);\n\n            methods = { [embeddedMethod]: methods };\n        }\n\n        subRoute = text.ensureStartsWith(subRoute, \"/\");\n\n        if (typeof methods === \"string\" || Array.isArray(methods)) {\n            methods = { get: methods };\n        }\n\n        _.forOwn(methods, (middlewares, method) => {\n            if (!Literal.ALLOWED_HTTP_METHODS.has(method) && method !== \"all\") {\n                throw new InvalidConfiguration(\n                    \"Unsupported http method: \" + method,\n                    app,\n                    `routing[${baseRoute}].rule.rules[${subRoute}]`\n                );\n            }\n\n            app.addRoute(router, method, subRoute, middlewares);\n        });\n    });\n\n    app.addRouter(router);\n}\n\nmodule.exports = load_;\n"],"mappings":"AAAA,YAAY;;AAACA,OAAA;AAEb,MAAM;EAAEC,CAAC;EAAEC;AAAK,CAAC,GAAGF,OAAO,CAAC,YAAY,CAAC;AACzC,MAAMG,MAAM,GAAGH,OAAO,CAAC,aAAa,CAAC;AACrC,MAAM;EAAEI;AAAqB,CAAC,GAAGJ,OAAO,CAAC,aAAa,CAAC;AACvD,MAAMK,OAAO,GAAGL,OAAO,CAAC,iBAAiB,CAAC;AA2C1C,SAASM,KAAKA,CAACC,GAAG,EAAEC,SAAS,EAAEC,OAAO,EAAE;EACpC,IAAIC,MAAM,GAAGF,SAAS,KAAK,GAAG,GAAG,IAAIL,MAAM,CAAC,CAAC,GAAG,IAAIA,MAAM,CAAC;IAAEQ,MAAM,EAAET,IAAI,CAACU,cAAc,CAACJ,SAAS,EAAE,GAAG;EAAE,CAAC,CAAC;EAE3G,IAAIC,OAAO,CAACI,WAAW,EAAE;IACrBN,GAAG,CAACO,cAAc,CAACJ,MAAM,EAAED,OAAO,CAACI,WAAW,CAAC;EACnD;EAEAZ,CAAC,CAACc,MAAM,CAACN,OAAO,CAACO,KAAK,IAAI,CAAC,CAAC,EAAE,CAACC,OAAO,EAAEC,QAAQ,KAAK;IACjD,IAAIC,GAAG,GAAGD,QAAQ,CAACE,OAAO,CAAC,IAAI,CAAC;IAEhC,IAAID,GAAG,KAAK,CAAC,CAAC,EAAE;MACZ,IAAIA,GAAG,KAAK,CAAC,EAAE;QACX,MAAM,IAAIf,oBAAoB,CAC1B,6BAA6B,GAAGc,QAAQ,EACxCX,GAAG,EACF,WAAUC,SAAU,cACzB,CAAC;MACL;MAIA,IAAIa,cAAc,GAAGH,QAAQ,CAACI,MAAM,CAAC,CAAC,EAAEH,GAAG,CAAC,CAACI,iBAAiB,CAAC,CAAC;MAChEL,QAAQ,GAAGA,QAAQ,CAACI,MAAM,CAACH,GAAG,GAAG,CAAC,CAAC;MAEnCF,OAAO,GAAG;QAAE,CAACI,cAAc,GAAGJ;MAAQ,CAAC;IAC3C;IAEAC,QAAQ,GAAGhB,IAAI,CAACsB,gBAAgB,CAACN,QAAQ,EAAE,GAAG,CAAC;IAE/C,IAAI,OAAOD,OAAO,KAAK,QAAQ,IAAIQ,KAAK,CAACC,OAAO,CAACT,OAAO,CAAC,EAAE;MACvDA,OAAO,GAAG;QAAEU,GAAG,EAAEV;MAAQ,CAAC;IAC9B;IAEAhB,CAAC,CAACc,MAAM,CAACE,OAAO,EAAE,CAACJ,WAAW,EAAEe,MAAM,KAAK;MACvC,IAAI,CAACvB,OAAO,CAACwB,oBAAoB,CAACC,GAAG,CAACF,MAAM,CAAC,IAAIA,MAAM,KAAK,KAAK,EAAE;QAC/D,MAAM,IAAIxB,oBAAoB,CAC1B,2BAA2B,GAAGwB,MAAM,EACpCrB,GAAG,EACF,WAAUC,SAAU,gBAAeU,QAAS,GACjD,CAAC;MACL;MAEAX,GAAG,CAACwB,QAAQ,CAACrB,MAAM,EAAEkB,MAAM,EAAEV,QAAQ,EAAEL,WAAW,CAAC;IACvD,CAAC,CAAC;EACN,CAAC,CAAC;EAEFN,GAAG,CAACyB,SAAS,CAACtB,MAAM,CAAC;AACzB;AAEAuB,MAAM,CAACC,OAAO,GAAG5B,KAAK"}