"use strict";

require("source-map-support/register");

const Feature = require('@genx/app/lib/enum/Feature');

const path = require('path');

const Util = require('rk-utils');

const Promise = Util.Promise;

const {
  InvalidConfiguration
} = require('../utils/Errors');

const WebModule = require('../WebModule');

module.exports = {
  type: Feature.PLUGIN,
  load_: async (server, routes) => Util.eachAsync_(routes, async (config, baseRoute) => {
    if (!config.name) {
      throw new InvalidConfiguration('Missing app name.', app, `appRouting.${baseRoute}.name`);
    }

    let options = Object.assign({
      env: server.env,
      logWithAppName: server.options.logWithAppName,
      traceMiddlewares: server.options.traceMiddlewares
    }, config.options);
    let appPath;

    if (config.npmModule) {
      appPath = server.toAbsolutePath('node_modules', config.name);
    } else {
      appPath = path.join(server.appModulesPath, config.name);
    }

    let exists = (await Util.fs.pathExists(appPath)) && (await Util.fs.stat(appPath)).isDirectory();

    if (!exists) {
      throw new InvalidConfiguration(`App [${config.name}] not exists.`, server, `appRouting.${baseRoute}.name`);
    }

    let app = new WebModule(server, config.name, baseRoute, appPath, options);
    app.on('configLoaded', () => {
      if (!Util._.isEmpty(config.settings)) {
        app.config.settings = Object.assign({}, app.config.settings, config.settings);
        server.log('verbose', `App settings of [${app.name}] is overrided.`);
      }

      if (!Util._.isEmpty(config.middlewares)) {
        let middlewaresToAppend = app.config.middlewares;
        app.config.middlewares = Object.assign({}, config.middlewares);

        Util._.defaults(app.config.middlewares, middlewaresToAppend);
      }
    });
    let relativePath = path.relative(server.workingPath, appPath);
    server.log('verbose', `Loading app [${app.name}] from "${relativePath}" ...`);
    await app.start_();
    server.log('verbose', `App [${app.name}] is loaded.`);
    server.on('after:' + Feature.PLUGIN, () => {
      server.mountApp(app);
    });
  })
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXJGZWF0dXJlcy9hcHBSb3V0aW5nLmpzIl0sIm5hbWVzIjpbIkZlYXR1cmUiLCJyZXF1aXJlIiwicGF0aCIsIlV0aWwiLCJQcm9taXNlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJXZWJNb2R1bGUiLCJtb2R1bGUiLCJleHBvcnRzIiwidHlwZSIsIlBMVUdJTiIsImxvYWRfIiwic2VydmVyIiwicm91dGVzIiwiZWFjaEFzeW5jXyIsImNvbmZpZyIsImJhc2VSb3V0ZSIsIm5hbWUiLCJhcHAiLCJvcHRpb25zIiwiT2JqZWN0IiwiYXNzaWduIiwiZW52IiwibG9nV2l0aEFwcE5hbWUiLCJ0cmFjZU1pZGRsZXdhcmVzIiwiYXBwUGF0aCIsIm5wbU1vZHVsZSIsInRvQWJzb2x1dGVQYXRoIiwiam9pbiIsImFwcE1vZHVsZXNQYXRoIiwiZXhpc3RzIiwiZnMiLCJwYXRoRXhpc3RzIiwic3RhdCIsImlzRGlyZWN0b3J5Iiwib24iLCJfIiwiaXNFbXB0eSIsInNldHRpbmdzIiwibG9nIiwibWlkZGxld2FyZXMiLCJtaWRkbGV3YXJlc1RvQXBwZW5kIiwiZGVmYXVsdHMiLCJyZWxhdGl2ZVBhdGgiLCJyZWxhdGl2ZSIsIndvcmtpbmdQYXRoIiwic3RhcnRfIiwibW91bnRBcHAiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBc0JBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLDRCQUFELENBQXZCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNRyxPQUFPLEdBQUdELElBQUksQ0FBQ0MsT0FBckI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQTJCSixPQUFPLENBQUMsaUJBQUQsQ0FBeEM7O0FBQ0EsTUFBTUssU0FBUyxHQUFHTCxPQUFPLENBQUMsY0FBRCxDQUF6Qjs7QUFFQU0sTUFBTSxDQUFDQyxP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TUFBSixDQUFXeUIsV0FBM0IsRUFBd0NDLG1CQUF4QztBQUNIO0FBQ0osS0FYRDtBQWFBLFFBQUlFLFlBQVksR0FBR3pDLElBQUksQ0FBQzBDLFFBQUwsQ0FBY2hDLE1BQU0sQ0FBQ2lDLFdBQXJCLEVBQWtDcEIsT0FBbEMsQ0FBbkI7QUFDQWIsSUFBQUEsTUFBTSxDQUFDMkIsR0FBUCxDQUFXLFNBQVgsRUFBdUIsZ0JBQWVyQixHQUFHLENBQUNELElBQUssV0FBVTBCLFlBQWEsT0FBdEU7QUFFQSxVQUFNekIsR0FBRyxDQUFDNEIsTUFBSixFQUFOO0FBRUFsQyxJQUFBQSxNQUFNLENBQUMyQixHQUFQLENBQVcsU0FBWCxFQUF1QixRQUFPckIsR0FBRyxDQUFDRCxJQUFLLGNBQXZDO0FBR0FMLElBQUFBLE1BQU0sQ0FBQ3VCLEVBQVAsQ0FBVSxXQUFXbkMsT0FBTyxDQUFDVSxNQUE3QixFQUFxQyxNQUFNO0FBQ3ZDRSxNQUFBQSxNQUFNLENBQUNtQyxRQUFQLENBQWdCN0IsR0FBaEI7QUFDSCxLQUZEO0FBR0gsR0F4RGdDO0FBZHBCLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbi8qKlxuICogRW5hYmxlIHJvdXRpbmcgd2ViIHJlcXVlc3RzIHRvIGEgY2hpbGQgYXBwLlxuICogQG1vZHVsZSBGZWF0dXJlX0FwcFJvdXRpbmdcbiAqIFxuICogQGV4YW1wbGVcbiAqICBcbiAqICAnYXBwUm91dGluZyc6IHtcbiAqICAgICAgJzxtb3VudGluZyBwb2ludD4nOiB7XG4gKiAgICAgICAgICBuYW1lOiAnYXBwIG5hbWUnLCBcbiAqICAgICAgICAgIG5wbU1vZHVsZTogZmFsc2UsIC8vIHdoZXRoZXIgaXMgYSBucG0gbW9kdWxlXG4gKiAgICAgICAgICBvcHRpb25zOiB7IC8vIG1vZHVsZSBvcHRpb25zIFxuICogICAgICAgICAgfSxcbiAqICAgICAgICAgIHNldHRpbmdzOiB7IC8vIGNhbiBvdmVycmlkZSBtb2R1bGUgZGVmaW5lZCBzZXR0aW5nc1xuICogICAgICAgICAgfSxcbiAqICAgICAgICAgIG1pZGRsZXdhcmVzOiB7IC8vIGNhbiBvdmVycmlkZSBtaWRkbGV3YXJlcyBcbiAqICAgICAgICAgIH1cbiAqICAgICAgfVxuICogIH0gXG4gKi9cblxuY29uc3QgRmVhdHVyZSA9IHJlcXVpcmUoJ0BnZW54L2FwcC9saWIvZW51bS9GZWF0dXJlJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCBQcm9taXNlID0gVXRpbC5Qcm9taXNlO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvRXJyb3JzJyk7XG5jb25zdCBXZWJNb2R1bGUgPSByZXF1aXJlKCcuLi9XZWJNb2R1bGUnKTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IHBsdWdpbiBzdGFnZS5cbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5QTFVHSU4sXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIHRoZSBmZWF0dXJlLlxuICAgICAqIEBwYXJhbSB7V2ViU2VydmVyfSBzZXJ2ZXIgLSBUaGUgd2ViIHNlcnZlciBtb2R1bGUgb2JqZWN0LlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByb3V0ZXMgLSBSb3V0ZXMgYW5kIGNvbmZpZ3VyYXRpb24uXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPCo+fVxuICAgICAqL1xuICAgIGxvYWRfOiBhc3luYyAoc2VydmVyLCByb3V0ZXMpID0+IFV0aWwuZWFjaEFzeW5jXyhyb3V0ZXMsIGFzeW5jIChjb25maWcsIGJhc2VSb3V0ZSkgPT4ge1xuICAgICAgICBpZiAoIWNvbmZpZy5uYW1lKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgJ01pc3NpbmcgYXBwIG5hbWUuJyxcbiAgICAgICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICAgICAgYGFwcFJvdXRpbmcuJHtiYXNlUm91dGV9Lm5hbWVgKTtcbiAgICAgICAgfVxuICAgIFxuICAgICAgICBsZXQgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBcbiAgICAgICAgICAgIGVudjogc2VydmVyLmVudiwgXG4gICAgICAgICAgICBsb2dXaXRoQXBwTmFtZTogc2VydmVyLm9wdGlvbnMubG9nV2l0aEFwcE5hbWUsXG4gICAgICAgICAgICB0cmFjZU1pZGRsZXdhcmVzOiBzZXJ2ZXIub3B0aW9ucy50cmFjZU1pZGRsZXdhcmVzXG4gICAgICAgIH0sIGNvbmZpZy5vcHRpb25zKTtcblxuICAgICAgICBsZXQgYXBwUGF0aDsgICAgIFxuXG4gICAgICAgIGlmIChjb25maWcubnBtTW9kdWxlKSB7XG4gICAgICAgICAgICBhcHBQYXRoID0gc2VydmVyLnRvQWJzb2x1dGVQYXRoKCdub2RlX21vZHVsZXMnLCBjb25maWcubmFtZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhcHBQYXRoID0gcGF0aC5qb2luKHNlcnZlci5hcHBNb2R1bGVzUGF0aCwgY29uZmlnLm5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGV4aXN0cyA9IGF3YWl0IFV0aWwuZnMucGF0aEV4aXN0cyhhcHBQYXRoKSAmJiAoYXdhaXQgVXRpbC5mcy5zdGF0KGFwcFBhdGgpKS5pc0RpcmVjdG9yeSgpO1xuICAgICAgICBpZiAoIWV4aXN0cykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgIGBBcHAgWyR7Y29uZmlnLm5hbWV9XSBub3QgZXhpc3RzLmAsXG4gICAgICAgICAgICAgICAgc2VydmVyLFxuICAgICAgICAgICAgICAgIGBhcHBSb3V0aW5nLiR7YmFzZVJvdXRlfS5uYW1lYCk7XG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgbGV0IGFwcCA9IG5ldyBXZWJNb2R1bGUoc2VydmVyLCBjb25maWcubmFtZSwgYmFzZVJvdXRlLCBhcHBQYXRoLCBvcHRpb25zKTtcbiAgICAgICAgXG4gICAgICAgIGFwcC5vbignY29uZmlnTG9hZGVkJywgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKCFVdGlsLl8uaXNFbXB0eShjb25maWcuc2V0dGluZ3MpKSB7XG4gICAgICAgICAgICAgICAgYXBwLmNvbmZpZy5zZXR0aW5ncyA9IE9iamVjdC5hc3NpZ24oe30sIGFwcC5jb25maWcuc2V0dGluZ3MsIGNvbmZpZy5zZXR0aW5ncyk7XG4gICAgICAgICAgICAgICAgc2VydmVyLmxvZygndmVyYm9zZScsIGBBcHAgc2V0dGluZ3Mgb2YgWyR7YXBwLm5hbWV9XSBpcyBvdmVycmlkZWQuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghVXRpbC5fLmlzRW1wdHkoY29uZmlnLm1pZGRsZXdhcmVzKSkge1xuICAgICAgICAgICAgICAgIGxldCBtaWRkbGV3YXJlc1RvQXBwZW5kID0gYXBwLmNvbmZpZy5taWRkbGV3YXJlcztcbiAgICAgICAgICAgICAgICBhcHAuY29uZmlnLm1pZGRsZXdhcmVzID0gT2JqZWN0LmFzc2lnbih7fSwgY29uZmlnLm1pZGRsZXdhcmVzKTtcbiAgICAgICAgICAgICAgICBVdGlsLl8uZGVmYXVsdHMoYXBwLmNvbmZpZy5taWRkbGV3YXJlcywgbWlkZGxld2FyZXNUb0FwcGVuZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCByZWxhdGl2ZVBhdGggPSBwYXRoLnJlbGF0aXZlKHNlcnZlci53b3JraW5nUGF0aCwgYXBwUGF0aCk7XG4gICAgICAgIHNlcnZlci5sb2coJ3ZlcmJvc2UnLCBgTG9hZGluZyBhcHAgWyR7YXBwLm5hbWV9XSBmcm9tIFwiJHtyZWxhdGl2ZVBhdGh9XCIgLi4uYCk7XG4gICAgXG4gICAgICAgIGF3YWl0IGFwcC5zdGFydF8oKTtcbiAgICAgICAgXG4gICAgICAgIHNlcnZlci5sb2coJ3ZlcmJvc2UnLCBgQXBwIFske2FwcC5uYW1lfV0gaXMgbG9hZGVkLmApO1xuXG4gICAgICAgIC8vZGVsYXllZCB0aGUgYXBwIHJvdXRlcyBtb3VudGluZyBhZnRlciBhbGwgcGx1Z2lucyBvZiB0aGUgc2VydmVyIGFyZSBsb2FkZWRcbiAgICAgICAgc2VydmVyLm9uKCdhZnRlcjonICsgRmVhdHVyZS5QTFVHSU4sICgpID0+IHtcbiAgICAgICAgICAgIHNlcnZlci5tb3VudEFwcChhcHApO1xuICAgICAgICB9KTsgICAgICAgIFxuICAgIH0pXG59OyJdfQ==