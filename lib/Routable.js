"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob,
  urlJoin,
  ensureLeftSlash,
  ensureRightSlash,
  urlAppendQuery
} = require('rk-utils');

const {
  Helpers: {
    tryRequire
  }
} = require('@genx/app');

const Errors = require('./utils/Errors');

const Literal = require('./enum/Literal');

const Koa = require('koa');

const Routable = T => class extends T {
  constructor(name, options) {
    super(name, options);
    this.clientPath = this.toAbsolutePath(this.options.clientPath || Literal.CLIENT_SRC_PATH);
    this.publicPath = this.toAbsolutePath(this.options.publicPath || Literal.PUBLIC_PATH);
    this.router = new Koa();
    this.router.use((ctx, next) => {
      ctx.appModule = this;
      return next();
    });
    this.on('configLoaded', () => {
      let middlewareDir = path.join(this.backendPath, Literal.MIDDLEWARES_PATH);

      if (fs.existsSync(middlewareDir)) {
        this.loadMiddlewaresFrom(middlewareDir);
      }
    });
  }

  async start_() {
    this.middlewareFactoryRegistry = {};
    return super.start_();
  }

  async stop_() {
    delete this.middlewareFactoryRegistry;
    return super.stop_();
  }

  getBackendAction(actionByPath) {
    let lpos = actionByPath.lastIndexOf('.');

    if (lpos === -1) {
      throw new Error(`Invalid action path: ${actionByPath}`);
    }

    let controller = actionByPath.substr(0, lpos);
    let method = actionByPath.substr(lpos + 1);
    let controllerObj;

    try {
      controllerObj = require(path.join(this.backendPath, controller));
    } catch (error) {
      throw new Error(`Backend controller not found: ${controller}`);
    }

    let methodFunc = controllerObj[method];

    if (typeof methodFunc !== 'function') {
      throw new Error(`The specified action is not a function: ${actionByPath}`);
    }

    return methodFunc;
  }

  loadMiddlewaresFrom(dir) {
    let files = glob.sync(path.join(dir, '*.js'), {
      nodir: true
    });
    files.forEach(file => this.registerMiddlewareFactory(path.basename(file, '.js'), require(file)));
  }

  registerMiddlewareFactory(name, factoryMethod) {
    if (!(typeof factoryMethod === 'function')) {
      throw new Error('Invalid middleware factory: ' + name);
    }

    if (name in this.middlewareFactoryRegistry) {
      throw new Errors.ServerError('Middleware "' + name + '" already registered!');
    }

    this.middlewareFactoryRegistry[name] = factoryMethod;
    this.log('verbose', `Registered named middleware [${name}].`);
  }

  getMiddlewareFactory(name) {
    if (this.middlewareFactoryRegistry.hasOwnProperty(name)) {
      return this.middlewareFactoryRegistry[name];
    }

    if (this.server && this.server !== this) {
      return this.server.getMiddlewareFactory(name);
    }

    let npmMiddleware = tryRequire(name);

    if (npmMiddleware) {
      return npmMiddleware;
    }

    throw new Errors.ServerError(`Don't know where to load middleware "${name}".`);
  }

  useMiddlewares(router, middlewares) {
    let middlewareFactory, middleware;
    let middlewareFunctions = [];

    if (_.isPlainObject(middlewares)) {
      _.forOwn(middlewares, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        middleware = middlewareFactory(options, this);
        middlewareFunctions.push({
          name,
          middleware
        });
      });
    } else {
      middlewares = _.castArray(middlewares);

      _.each(middlewares, middlewareEntry => {
        let type = typeof middlewareEntry;

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(middlewareEntry);
          middleware = middlewareFactory(undefined, this);
          middlewareFunctions.push({
            name: middlewareEntry,
            middleware
          });
        } else if (type === 'function') {
          middlewareFunctions.push({
            name: middlewareEntry.name || 'unamed middleware',
            middleware: middlewareEntry
          });
        } else if (Array.isArray(middlewareEntry)) {
          if (middlewareEntry.length === 0) {
            throw new Errors.InvalidConfiguration('Empty array found as middleware entry!', this, 'middlewares');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry[0]);
          middleware = middlewareFactory(middlewareEntry.length > 1 ? middlewareEntry[1] : null, this);
          middlewareFunctions.push({
            name: middlewareEntry[0],
            middleware
          });
        } else {
          if (!_.isPlainObject(middlewareEntry) || !('name' in middlewareEntry)) {
            throw new Errors.InvalidConfiguration('Invalid middleware entry!', this, 'middlewares');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry.name);
          middleware = middlewareFactory(middlewareEntry.options, this);
          middlewareFunctions.push({
            name: middlewareEntry.name,
            middleware
          });
        }
      });
    }

    middlewareFunctions.forEach(({
      name,
      middleware
    }) => {
      if (Array.isArray(middleware)) {
        middleware.forEach(m => this.useMiddleware(router, m, name));
      } else {
        this.useMiddleware(router, middleware, name);
      }
    });
    return this;
  }

  addRoute(router, method, route, actions) {
    let handlers = [],
        middlewareFactory;

    if (_.isPlainObject(actions)) {
      _.forOwn(actions, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        handlers.push(this._wrapMiddlewareTracer(middlewareFactory(options, this), name));
      });
    } else {
      actions = _.castArray(actions);
      let lastIndex = actions.length - 1;

      _.each(actions, (action, i) => {
        let type = typeof action;

        if (i === lastIndex) {
          if (type === 'string' && action.lastIndexOf('.') > 0) {
            action = {
              name: 'action',
              options: action
            };
            type = 'object';
          }
        }

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(action);
          let middleware = middlewareFactory(null, this);

          if (Array.isArray(middleware)) {
            middleware.forEach((middlewareItem, i) => handlers.push(this._wrapMiddlewareTracer(middlewareItem, `${action}-${i}` + (middleware.name ? '-' + middleware.name : ''))));
          } else {
            handlers.push(this._wrapMiddlewareTracer(middleware, action));
          }
        } else if (type === 'function') {
          handlers.push(this._wrapMiddlewareTracer(action));
        } else if (Array.isArray(action)) {
          if (!(action.length > 0 && action.length <= 2)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action[0]);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.length > 1 ? action[1] : undefined, this)));
        } else {
          if (!(_.isPlainObject(action) && 'name' in action)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action.name);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.options, this), action.name));
        }
      });
    }

    router[method](route, ...handlers);
    let endpoint = router.opts.prefix ? urlJoin(this.route, router.opts.prefix, route) : urlJoin(this.route, route);
    this.log('verbose', `Route "${method}:${endpoint}" is added from module [${this.name}].`);
    return this;
  }

  addRouter(nestedRouter) {
    this.router.use(nestedRouter.routes());
    this.router.use(nestedRouter.allowedMethods());
    return this;
  }

  toWebPath(relativePath, ...pathOrQuery) {
    let url, query;

    if (pathOrQuery && pathOrQuery.length > 0 && (pathOrQuery.length > 1 || pathOrQuery[0] !== undefined)) {
      if (_.isObject(pathOrQuery[pathOrQuery.length - 1])) {
        query = pathOrQuery.pop();
      }

      pathOrQuery.unshift(relativePath);
      url = urlJoin(this.route, ...pathOrQuery);
    } else {
      url = urlJoin(this.route, relativePath);
    }

    url = ensureLeftSlash(url);

    if (query) {
      url = urlAppendQuery(url, query);
      url = url.replace('/?', '?');
    }

    return url;
  }

  wrapAction(action) {
    return async ctx => {
      ctx.toUrl = (relativePath, ...pathOrQuery) => {
        return ctx.origin + this.toWebPath(relativePath, ...pathOrQuery);
      };

      Object.assign(ctx.state, {
        _self: ctx.originalUrl || this.toWebPath(ctx.url),
        __: ctx.__,
        _base: ensureRightSlash(this.toWebPath()),
        _makePath: (relativePath, query) => this.toWebPath(relativePath, query),
        _makeUrl: (relativePath, query) => ctx.toUrl(relativePath, query)
      });

      if (ctx.csrf) {
        ctx.state._csrf = ctx.csrf;
      }

      return action(ctx);
    };
  }

  useMiddleware(router, middleware, name) {
    if (!(typeof middleware === 'function')) {
      throw new Error(middleware);
    }

    router.use(this._wrapMiddlewareTracer(middleware, name));
    this.log('verbose', `Attached middleware [${name}].`);
  }

  _wrapMiddlewareTracer(middleware, name) {
    if (this.options.traceMiddlewares) {
      return async (ctx, next) => {
        this.log('debug', `Step in middleware "${name || middleware.name}" ...`);
        let ret = await middleware(ctx, next);
        this.log('debug', `Step out from middleware "${name || middleware.name}".`);
        return ret;
      };
    }

    return middleware;
  }

  _getFeatureFallbackPath() {
    return super._getFeatureFallbackPath().concat([path.join(this.backendPath, Literal.FEATURES_PATH)]);
  }

};

module.exports = Routable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Sb3V0YWJsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJ1cmxKb2luIiwiZW5zdXJlTGVmdFNsYXNoIiwiZW5zdXJlUmlnaHRTbGFzaCIsInVybEFwcGVuZFF1ZXJ5IiwiSGVscGVycyIsInRyeVJlcXVpcmUiLCJFcnJvcnMiLCJMaXRlcmFsIiwiS29hIiwiUm91dGFibGUiLCJUIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImNsaWVudFBhdGgiLCJ0b0Fic29sdXRlUGF0aCIsIkNMSUVOVF9TUkNfUEFUSCIsInB1YmxpY1BhdGgiLCJQVUJMSUNfUEFUSCIsInJvdXRlciIsInVzZSIsImN0eCIsIm5leHQiLCJhcHBNb2R1bGUiLCJvbiIsIm1pZGRsZXdhcmVEaXIiLCJqb2luIiwiYmFja2VuZFBhdGgiLCJNSURETEVXQVJFU19QQVRIIiwiZXhpc3RzU3luYyIsImxvYWRNaWRkbGV3YXJlc0Zyb20iLCJzdGFydF8iLCJtaWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5Iiwic3RvcF8iLCJnZXRCYWNrZW5kQWN0aW9uIiwiYWN0aW9uQnlQYXRoIiwibHBvcyIsImxhc3RJbmRleE9mIiwiRXJyb3IiLCJjb250cm9sbGVyIiwic3Vic3RyIiwibWV0aG9kIiwiY29udHJvbGxlck9iaiIsImVycm9yIiwibWV0aG9kRnVuYyIsImRpciIsImZpbGVzIiwic3luYyIsIm5vZGlyIiwiZm9yRWFjaCIsImZpbGUiLCJyZWdpc3Rlck1pZGRsZXdhcmVGYWN0b3J5IiwiYmFzZW5hbWUiLCJmYWN0b3J5TWV0aG9kIiwiU2VydmVyRXJyb3IiLCJsb2ciLCJnZXRNaWRkbGV3YXJlRmFjdG9yeSIsImhhc093blByb3BlcnR5Iiwic2VydmVyIiwibnBtTWlkZGxld2FyZSIsInVzZU1pZGRsZXdhcmVzIiwibWlkZGxld2FyZXMiLCJtaWRkbGV3YXJlRmFjdG9yeSIsIm1pZGRsZXdhcmUiLCJtaWRkbGV3YXJlRnVuY3Rpb25zIiwiaXNQbGFpbk9iamVjdCIsImZvck93biIsInB1c2giLCJjYXN0QXJyYXkiLCJlYWNoIiwibWlkZGxld2FyZUVudHJ5IiwidHlwZSIsInVuZGVmaW5lZCIsIkFycmF5IiwiaXNBcnJheSIsImxlbmd0aCIsIkludmFsaWRDb25maWd1cmF0aW9uIiwibSIsInVzZU1pZGRsZXdhcmUiLCJhZGRSb3V0ZSIsInJvdXRlIiwiYWN0aW9ucyIsImhhbmRsZXJzIiwiX3dyYXBNaWRkbGV3YXJlVHJhY2VyIiwibGFzdEluZGV4IiwiYWN0aW9uIiwiaSIsIm1pZGRsZXdhcmVJdGVtIiwiZW5kcG9pbnQiLCJvcHRzIiwicHJlZml4IiwiYWRkUm91dGVyIiwibmVzdGVkUm91dGVyIiwicm91dGVzIiwiYWxsb3dlZE1ldGhvZHMiLCJ0b1dlYlBhdGgiLCJyZWxhdGl2ZVBhdGgiLCJwYXRoT3JRdWVyeSIsInVybCIsInF1ZXJ5IiwiaXNPYmplY3QiLCJwb3AiLCJ1bnNoaWZ0IiwicmVwbGFjZSIsIndyYXBBY3Rpb24iLCJ0b1VybCIsIm9yaWdpbiIsIk9iamVjdCIsImFzc2lnbiIsInN0YXRlIiwiX3NlbGYiLCJvcmlnaW5hbFVybCIsIl9fIiwiX2Jhc2UiLCJfbWFrZVBhdGgiLCJfbWFrZVVybCIsImNzcmYiLCJfY3NyZiIsInRyYWNlTWlkZGxld2FyZXMiLCJyZXQiLCJfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCIsImNvbmNhdCIsIkZFQVRVUkVTX1BBVEgiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUEsSUFBVDtBQUFlQyxFQUFBQSxPQUFmO0FBQXdCQyxFQUFBQSxlQUF4QjtBQUF5Q0MsRUFBQUEsZ0JBQXpDO0FBQTJEQyxFQUFBQTtBQUEzRCxJQUE4RVAsT0FBTyxDQUFDLFVBQUQsQ0FBM0Y7O0FBQ0Es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QWpCLEVBQW1DO0FBQy9CLGFBQU8sT0FBT2pHLEdBQVAsRUFBWUMsSUFBWixLQUFxQjtBQUN4QixhQUFLaUMsR0FBTCxDQUFTLE9BQVQsRUFBbUIsdUJBQXNCM0MsSUFBSSxJQUFJbUQsVUFBVSxDQUFDbkQsSUFBSyxPQUFqRTtBQUNBLFlBQUkyRyxHQUFHLEdBQUcsTUFBTXhELFVBQVUsQ0FBQzFDLEdBQUQsRUFBTUMsSUFBTixDQUExQjtBQUNBLGFBQUtpQyxHQUFMLENBQVMsT0FBVCxFQUFtQiw2QkFBNEIzQyxJQUFJLElBQUltRCxVQUFVLENBQUNuRCxJQUFLLElBQXZFO0FBQ0EsZUFBTzJHLEdBQVA7QUFDSCxPQUxEO0FBTUg7O0FBRUQsV0FBT3hELFVBQVA7QUFDSDs7QUFFRHlELEVBQUFBLHVCQUF1QixHQUFHO0FBQ3RCLFdBQU8sTUFBTUEsdUJBQU4sR0FBZ0NDLE1BQWhDLENBQXVDLENBQUU5SCxJQUFJLENBQUMrQixJQUFMLENBQVUsS0FBS0MsV0FBZixFQUE0QnBCLE9BQU8sQ0FBQ21ILGFBQXBDLENBQUYsQ0FBdkMsQ0FBUDtBQUNIOztBQTNXaUMsQ0FBdEM7O0FBOFdBQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJuSCxRQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCBmcywgZ2xvYiwgdXJsSm9pbiwgZW5zdXJlTGVmdFNsYXNoLCBlbnN1cmVSaWdodFNsYXNoLCB1cmxBcHBlbmRRdWVyeSB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgSGVscGVyczogeyB0cnlSZXF1aXJlIH0gfSA9IHJlcXVpcmUoJ0BnZW54L2FwcCcpO1xuY29uc3QgRXJyb3JzID0gcmVxdWlyZSgnLi91dGlscy9FcnJvcnMnKTtcbmNvbnN0IExpdGVyYWwgPSByZXF1aXJlKCcuL2VudW0vTGl0ZXJhbCcpO1xuY29uc3QgS29hID0gcmVxdWlyZSgna29hJyk7XG5cbmNvbnN0IFJvdXRhYmxlID0gVCA9PiBjbGFzcyBleHRlbmRzIFQgeyAgICBcbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHJvdXRhYmxlIGluc3RhbmNlLiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIFJvdXRhYmxlIG9wdGlvbnMgICAgICAgICAgICAgICBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuYmFja2VuZFBhdGg9J3NlcnZlciddIC0gUmVsYXRpdmUgcGF0aCBvZiBiYWNrLWVuZCBzZXJ2ZXIgc291cmNlIGZpbGVzXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmNsaWVudFBhdGg9J2NsaWVudCddIC0gUmVsYXRpdmUgcGF0aCBvZiBmcm9udC1lbmQgY2xpZW50IHNvdXJjZSBmaWxlcyAgICAgXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnB1YmxpY1BhdGg9J3B1YmxpYyddIC0gUmVsYXRpdmUgcGF0aCBvZiBmcm9udC1lbmQgc3RhdGljIGZpbGVzIFxuICAgICAqLyAgICAgICAgIFxuICAgIGNvbnN0cnVjdG9yKG5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIobmFtZSwgb3B0aW9ucyk7ICAgICAgICBcblxuICAgICAgICAvKipcbiAgICAgICAgICogRnJvbnRlbmQgc291cmNlIGZpbGVzIHBhdGguXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLmNsaWVudFBhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5jbGllbnRQYXRoIHx8IExpdGVyYWwuQ0xJRU5UX1NSQ19QQVRIKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogRnJvbnRlbmQgc3RhdGljIGZpbGVzIHBhdGguXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLnB1YmxpY1BhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5wdWJsaWNQYXRoIHx8IExpdGVyYWwuUFVCTElDX1BBVEgpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBFYWNoIGFwcCBoYXMgaXRzIG93biByb3V0ZXIuXG4gICAgICAgICAqIEBtZW1iZXIge0tvYX1cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLnJvdXRlciA9IG5ldyBLb2EoKTtcblxuICAgICAgICAvL2luamVjdCB0aGUgYXBwTW9kdWxlIGluc3RhbmNlIGluIHRoZSBmaXJzdCBtaWRkbGV3YXJlXG4gICAgICAgIHRoaXMucm91dGVyLnVzZSgoY3R4LCBuZXh0KSA9PiB7IFxuICAgICAgICAgICAgY3R4LmFwcE1vZHVsZSA9IHRoaXM7IFxuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTsgXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMub24oJ2NvbmZpZ0xvYWRlZCcsICgpID0+IHtcbiAgICAgICAgICAgIC8vbG9hZCBtaWRkbGV3YXJlcyBpZiBleGlzdHMgaW4gc2VydmVyIG9yIGFwcCBwYXRoXG4gICAgICAgICAgICBsZXQgbWlkZGxld2FyZURpciA9IHBhdGguam9pbih0aGlzLmJhY2tlbmRQYXRoLCBMaXRlcmFsLk1JRERMRVdBUkVTX1BBVEgpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhtaWRkbGV3YXJlRGlyKSkge1xuICAgICAgICAgICAgICAgIHRoaXMubG9hZE1pZGRsZXdhcmVzRnJvbShtaWRkbGV3YXJlRGlyKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSk7ICBcbiAgICB9XG5cbiAgICBhc3luYyBzdGFydF8oKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBNaWRkbGV3YXJlIGZhY3RvcnkgcmVnaXN0cnkuXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeSA9IHt9O1xuXG4gICAgICAgIHJldHVybiBzdXBlci5zdGFydF8oKTtcbiAgICB9XG5cbiAgICBhc3luYyBzdG9wXygpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeTtcblxuICAgICAgICByZXR1cm4gc3VwZXIuc3RvcF8oKTtcbiAgICB9XG5cbiAgICBnZXRCYWNrZW5kQWN0aW9uKGFjdGlvbkJ5UGF0aCkge1xuICAgICAgICBsZXQgbHBvcyA9IGFjdGlvbkJ5UGF0aC5sYXN0SW5kZXhPZignLicpO1xuXG4gICAgICAgIGlmIChscG9zID09PSAtMSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGFjdGlvbiBwYXRoOiAke2FjdGlvbkJ5UGF0aH1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjb250cm9sbGVyID0gYWN0aW9uQnlQYXRoLnN1YnN0cigwLCBscG9zKTtcbiAgICAgICAgbGV0IG1ldGhvZCA9IGFjdGlvbkJ5UGF0aC5zdWJzdHIobHBvcysxKTtcbiAgICAgICAgbGV0IGNvbnRyb2xsZXJPYmo7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnRyb2xsZXJPYmogPSByZXF1aXJlKHBhdGguam9pbih0aGlzLmJhY2tlbmRQYXRoLCBjb250cm9sbGVyKSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEJhY2tlbmQgY29udHJvbGxlciBub3QgZm91bmQ6ICR7Y29udHJvbGxlcn1gKTtcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICBsZXQgbWV0aG9kRnVuYyA9IGNvbnRyb2xsZXJPYmpbbWV0aG9kXTtcbiAgICAgICAgaWYgKHR5cGVvZiBtZXRob2RGdW5jICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBzcGVjaWZpZWQgYWN0aW9uIGlzIG5vdCBhIGZ1bmN0aW9uOiAke2FjdGlvbkJ5UGF0aH1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBtZXRob2RGdW5jO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExvYWQgYW5kIHJlZ3NpdGVyIG1pZGRsZXdhcmUgZmlsZXMgZnJvbSBhIHNwZWNpZmllZCBwYXRoLlxuICAgICAqIEBwYXJhbSBkaXJcbiAgICAgKi9cbiAgICBsb2FkTWlkZGxld2FyZXNGcm9tKGRpcikge1xuICAgICAgICBsZXQgZmlsZXMgPSBnbG9iLnN5bmMocGF0aC5qb2luKGRpciwgJyouanMnKSwge25vZGlyOiB0cnVlfSk7XG4gICAgICAgIGZpbGVzLmZvckVhY2goZmlsZSA9PiB0aGlzLnJlZ2lzdGVyTWlkZGxld2FyZUZhY3RvcnkocGF0aC5iYXNlbmFtZShmaWxlLCAnLmpzJyksIHJlcXVpcmUoZmlsZSkpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZWdpc3RlciB0aGUgZmFjdG9yeSBtZXRob2Qgb2YgYSBuYW1lZCBtaWRkbGV3YXJlLiAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgbWlkZGxld2FyZSBcbiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBmYWN0b3J5TWV0aG9kIC0gVGhlIGZhY3RvcnkgbWV0aG9kIG9mIGEgbWlkZGxld2FyZVxuICAgICAqL1xuICAgIHJlZ2lzdGVyTWlkZGxld2FyZUZhY3RvcnkobmFtZSwgZmFjdG9yeU1ldGhvZCkge1xuICAgICAgICBwcmU6IHR5cGVvZiBmYWN0b3J5TWV0aG9kID09PSAnZnVuY3Rpb24nLCAnSW52YWxpZCBtaWRkbGV3YXJlIGZhY3Rvcnk6ICcgKyBuYW1lOyAgICAgICAgXG5cbiAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3JzLlNlcnZlckVycm9yKCdNaWRkbGV3YXJlIFwiJysgbmFtZSArJ1wiIGFscmVhZHkgcmVnaXN0ZXJlZCEnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeVtuYW1lXSA9IGZhY3RvcnlNZXRob2Q7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYFJlZ2lzdGVyZWQgbmFtZWQgbWlkZGxld2FyZSBbJHtuYW1lfV0uYCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSBmYWN0b3J5IG1ldGhvZCBvZiBhIG1pZGRsZXdhcmUgZnJvbSBtb2R1bGUgaGllcmFyY2h5LiAgICAgXG4gICAgICogQHBhcmFtIG5hbWVcbiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb259XG4gICAgICovXG4gICAgZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSkge1xuICAgICAgICBpZiAodGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5Lmhhc093blByb3BlcnR5KG5hbWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5W25hbWVdO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuc2VydmVyICYmIHRoaXMuc2VydmVyICE9PSB0aGlzKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXJ2ZXIuZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbnBtTWlkZGxld2FyZSA9IHRyeVJlcXVpcmUobmFtZSk7XG4gICAgICAgIGlmIChucG1NaWRkbGV3YXJlKSB7XG4gICAgICAgICAgICByZXR1cm4gbnBtTWlkZGxld2FyZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRocm93IG5ldyBFcnJvcnMuU2VydmVyRXJyb3IoYERvbid0IGtub3cgd2hlcmUgdG8gbG9hZCBtaWRkbGV3YXJlIFwiJHtuYW1lfVwiLmApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVzZSBtaWRkbGV3YXJlc1xuICAgICAqIEBwYXJhbSB7Um91dGVyfSByb3V0ZXJcbiAgICAgKiBAcGFyYW0geyp9IG1pZGRsZXdhcmVzIC0gQ2FuIGJlIGFuIGFycmF5IG9mIG1pZGRsZXdhcmUgZW50cmllcyBvciBhIGtleS12YWx1ZSBsaXN0IG9mIHJlZ2lzdGVycmVkIG1pZGRsZXdhcmVzXG4gICAgICogQHJldHVybnMge1JvdXRhYmxlfVxuICAgICAqL1xuICAgIHVzZU1pZGRsZXdhcmVzKHJvdXRlciwgbWlkZGxld2FyZXMpIHtcbiAgICAgICAgbGV0IG1pZGRsZXdhcmVGYWN0b3J5LCBtaWRkbGV3YXJlO1xuICAgICAgICBsZXQgbWlkZGxld2FyZUZ1bmN0aW9ucyA9IFtdO1xuICAgICAgICBcbiAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChtaWRkbGV3YXJlcykpIHtcbiAgICAgICAgICAgIF8uZm9yT3duKG1pZGRsZXdhcmVzLCAob3B0aW9ucywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShuYW1lKTsgICBcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlID0gbWlkZGxld2FyZUZhY3Rvcnkob3B0aW9ucywgdGhpcyk7XG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5wdXNoKHsgbmFtZSwgbWlkZGxld2FyZSB9KTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG1pZGRsZXdhcmVzID0gXy5jYXN0QXJyYXkobWlkZGxld2FyZXMpOyAgICAgICAgICBcbiAgICAgICAgXG4gICAgICAgICAgICBfLmVhY2gobWlkZGxld2FyZXMsIG1pZGRsZXdhcmVFbnRyeSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHR5cGUgPSB0eXBlb2YgbWlkZGxld2FyZUVudHJ5O1xuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFsgJ25hbWVkTWlkZGxld2FyZScgXVxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUVudHJ5KTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZSA9IG1pZGRsZXdhcmVGYWN0b3J5KHVuZGVmaW5lZCwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMucHVzaCh7IG5hbWU6IG1pZGRsZXdhcmVFbnRyeSAsIG1pZGRsZXdhcmUgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMucHVzaCh7IG5hbWU6IG1pZGRsZXdhcmVFbnRyeS5uYW1lIHx8ICd1bmFtZWQgbWlkZGxld2FyZScsIG1pZGRsZXdhcmU6IG1pZGRsZXdhcmVFbnRyeX0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShtaWRkbGV3YXJlRW50cnkpKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFsgWyAnbmFtZWRNaWRkbGV3YXJlJywgY29uZmlnIF0gXVxuICAgICAgICAgICAgICAgICAgICBpZiAobWlkZGxld2FyZUVudHJ5Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9ycy5JbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnRW1wdHkgYXJyYXkgZm91bmQgYXMgbWlkZGxld2FyZSBlbnRyeSEnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ21pZGRsZXdhcmVzJ1xuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShtaWRkbGV3YXJlRW50cnlbMF0pO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlID0gbWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUVudHJ5Lmxlbmd0aCA+IDEgPyBtaWRkbGV3YXJlRW50cnlbMV0gOiBudWxsLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5wdXNoKHsgbmFtZTogbWlkZGxld2FyZUVudHJ5WzBdLCBtaWRkbGV3YXJlIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KG1pZGRsZXdhcmVFbnRyeSkgfHwgISgnbmFtZScgaW4gbWlkZGxld2FyZUVudHJ5KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9ycy5JbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnSW52YWxpZCBtaWRkbGV3YXJlIGVudHJ5IScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWlkZGxld2FyZXMnXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmVFbnRyeS5uYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZSA9IG1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmVFbnRyeS5vcHRpb25zLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5wdXNoKHsgbmFtZTogbWlkZGxld2FyZUVudHJ5Lm5hbWUsIG1pZGRsZXdhcmUgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gXG4gICAgICAgIFxuICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLmZvckVhY2goKHsgbmFtZSwgbWlkZGxld2FyZSB9KSA9PiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShtaWRkbGV3YXJlKSkge1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUuZm9yRWFjaChtID0+IHRoaXMudXNlTWlkZGxld2FyZShyb3V0ZXIsIG0sIG5hbWUpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy51c2VNaWRkbGV3YXJlKHJvdXRlciwgbWlkZGxld2FyZSwgbmFtZSk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgcm91dGUgdG8gYSByb3V0ZXIsIHNraXBwZWQgd2hpbGUgdGhlIHNlcnZlciBydW5uaW5nIGluIGRlYWYgbW9kZS4gICAgIFxuICAgICAqIEBwYXJhbSByb3V0ZXJcbiAgICAgKiBAcGFyYW0gbWV0aG9kXG4gICAgICogQHBhcmFtIHJvdXRlXG4gICAgICogQHBhcmFtIGFjdGlvbnNcbiAgICAgKi9cbiAgICBhZGRSb3V0ZShyb3V0ZXIsIG1ldGhvZCwgcm91dGUsIGFjdGlvbnMpIHtcbiAgICAgICAgbGV0IGhhbmRsZXJzID0gW10sIG1pZGRsZXdhcmVGYWN0b3J5O1xuXG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QoYWN0aW9ucykpIHtcbiAgICAgICAgICAgIF8uZm9yT3duKGFjdGlvbnMsIChvcHRpb25zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KG5hbWUpO1xuICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZUZhY3Rvcnkob3B0aW9ucywgdGhpcyksIG5hbWUpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYWN0aW9ucyA9IF8uY2FzdEFycmF5KGFjdGlvbnMpO1xuICAgICAgICAgICAgbGV0IGxhc3RJbmRleCA9IGFjdGlvbnMubGVuZ3RoIC0gMTtcblxuICAgICAgICAgICAgXy5lYWNoKGFjdGlvbnMsIChhY3Rpb24sIGkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgdHlwZSA9IHR5cGVvZiBhY3Rpb247XG5cbiAgICAgICAgICAgICAgICBpZiAoaSA9PT0gbGFzdEluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGxhc3QgbWlkZGxld2FyZSBtYXkgYmUgYW4gYWN0aW9uXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJyAmJiBhY3Rpb24ubGFzdEluZGV4T2YoJy4nKSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbiA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAnYWN0aW9uJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiBhY3Rpb25cbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSAnb2JqZWN0JztcbiAgICAgICAgICAgICAgICAgICAgfSAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gWyAnbmFtZWRNaWRkbGV3YXJlJyBdXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShhY3Rpb24pOyAgIFxuXG4gICAgICAgICAgICAgICAgICAgIGxldCBtaWRkbGV3YXJlID0gbWlkZGxld2FyZUZhY3RvcnkobnVsbCwgdGhpcyk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy9pbiBjYXNlIGl0J3MgcmVnaXN0ZXIgYnkgdGhlIG1pZGRsZXdhcmVGYWN0b3J5IGZlYXR1cmVcbiAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobWlkZGxld2FyZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUuZm9yRWFjaCgobWlkZGxld2FyZUl0ZW0sIGkpID0+IGhhbmRsZXJzLnB1c2goXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZUl0ZW0sIGAke2FjdGlvbn0tJHtpfWAgKyAobWlkZGxld2FyZS5uYW1lID8gKCctJyArIG1pZGRsZXdhcmUubmFtZSkgOiAnJykpXG4gICAgICAgICAgICAgICAgICAgICAgICApKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaCh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlLCBhY3Rpb24pKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKGFjdGlvbikpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShhY3Rpb24pKSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydDogYWN0aW9uLmxlbmd0aCA+IDAgJiYgYWN0aW9uLmxlbmd0aCA8PSAyLCAnSW52YWxpZCBtaWRkbGV3YXJlIGVudHJ5JztcblxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uWzBdKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvbi5sZW5ndGggPiAxID8gYWN0aW9uWzFdIDogdW5kZWZpbmVkLCB0aGlzKSkpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiBfLmlzUGxhaW5PYmplY3QoYWN0aW9uKSAmJiAnbmFtZScgaW4gYWN0aW9uLCAnSW52YWxpZCBtaWRkbGV3YXJlIGVudHJ5JztcblxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uLm5hbWUpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uLm9wdGlvbnMsIHRoaXMpLCBhY3Rpb24ubmFtZSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICByb3V0ZXJbbWV0aG9kXShyb3V0ZSwgLi4uaGFuZGxlcnMpO1xuXG4gICAgICAgIGxldCBlbmRwb2ludCA9IHJvdXRlci5vcHRzLnByZWZpeCA/IHVybEpvaW4odGhpcy5yb3V0ZSwgcm91dGVyLm9wdHMucHJlZml4LCByb3V0ZSkgOiB1cmxKb2luKHRoaXMucm91dGUsIHJvdXRlKTtcblxuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBSb3V0ZSBcIiR7bWV0aG9kfToke2VuZHBvaW50fVwiIGlzIGFkZGVkIGZyb20gbW9kdWxlIFske3RoaXMubmFtZX1dLmApO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH0gICAgXG5cbiAgICAvKipcbiAgICAgKiBBdHRhY2ggYSByb3V0ZXIgdG8gdGhpcyBhcHAgbW9kdWxlLCBza2lwcGVkIHdoaWxlIHRoZSBzZXJ2ZXIgcnVubmluZyBpbiBkZWFmIG1vZGUgICAgIFxuICAgICAqIEBwYXJhbSB7Um91dGVyfSBuZXN0ZWRSb3V0ZXJcbiAgICAgKi9cbiAgICBhZGRSb3V0ZXIobmVzdGVkUm91dGVyKSB7XG4gICAgICAgIHRoaXMucm91dGVyLnVzZShuZXN0ZWRSb3V0ZXIucm91dGVzKCkpO1xuICAgICAgICB0aGlzLnJvdXRlci51c2UobmVzdGVkUm91dGVyLmFsbG93ZWRNZXRob2RzKCkpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUcmFuc2xhdGUgYSByZWxhdGl2ZSBwYXRoIGFuZCBxdWVyeSBwYXJhbWV0ZXJzIGlmIGFueSB0byBhIHVybCBwYXRoICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcmVsYXRpdmVQYXRoIC0gUmVsYXRpdmUgcGF0aFxuICAgICAqIEBwYXJhbSB7Li4uKn0gW3BhdGhPclF1ZXJ5XSAtIFF1ZXJpZXNcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgICAqL1xuICAgIHRvV2ViUGF0aChyZWxhdGl2ZVBhdGgsIC4uLnBhdGhPclF1ZXJ5KSB7XG4gICAgICAgIGxldCB1cmwsIHF1ZXJ5O1xuXG4gICAgICAgIGlmIChwYXRoT3JRdWVyeSAmJiBwYXRoT3JRdWVyeS5sZW5ndGggPiAwICYmIChwYXRoT3JRdWVyeS5sZW5ndGggPiAxIHx8IHBhdGhPclF1ZXJ5WzBdICE9PSB1bmRlZmluZWQpKSB7XG4gICAgICAgICAgICBpZiAoXy5pc09iamVjdChwYXRoT3JRdWVyeVtwYXRoT3JRdWVyeS5sZW5ndGggLSAxXSkpIHtcbiAgICAgICAgICAgICAgICBxdWVyeSA9IHBhdGhPclF1ZXJ5LnBvcCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGF0aE9yUXVlcnkudW5zaGlmdChyZWxhdGl2ZVBhdGgpO1xuICAgICAgICAgICAgdXJsID0gdXJsSm9pbih0aGlzLnJvdXRlLCAuLi5wYXRoT3JRdWVyeSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB1cmwgPSB1cmxKb2luKHRoaXMucm91dGUsIHJlbGF0aXZlUGF0aCk7XG4gICAgICAgIH1cblxuICAgICAgICB1cmwgPSBlbnN1cmVMZWZ0U2xhc2godXJsKTtcblxuICAgICAgICBpZiAocXVlcnkpIHtcbiAgICAgICAgICAgIHVybCA9IHVybEFwcGVuZFF1ZXJ5KHVybCwgcXVlcnkpO1xuICAgICAgICAgICAgdXJsID0gdXJsLnJlcGxhY2UoJy8/JywgJz8nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB1cmw7XG4gICAgfSAgICBcblxuICAgIC8qKlxuICAgICAqIFByZXBhcmUgY29udGV4dCBmb3Iga29hIGFjdGlvblxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjdHggLSBLb2EgcmVxdWVzdCBjb250ZXh0XG4gICAgICogQHBhcmFtIHtmdW5jdGlvbn0gYWN0aW9uIC0gQWN0aW9uIGZ1bmN0aW9uXG4gICAgICogQHJldHVybiB7ZnVuY3Rpb259XG4gICAgICovXG4gICAgd3JhcEFjdGlvbihhY3Rpb24pIHtcbiAgICAgICAgcmV0dXJuIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgICAgIGN0eC50b1VybCA9IChyZWxhdGl2ZVBhdGgsIC4uLnBhdGhPclF1ZXJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGN0eC5vcmlnaW4gKyB0aGlzLnRvV2ViUGF0aChyZWxhdGl2ZVBhdGgsIC4uLnBhdGhPclF1ZXJ5KTtcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oY3R4LnN0YXRlLCB7XG4gICAgICAgICAgICAgICAgX3NlbGY6IGN0eC5vcmlnaW5hbFVybCB8fCB0aGlzLnRvV2ViUGF0aChjdHgudXJsKSxcbiAgICAgICAgICAgICAgICBfXzogY3R4Ll9fLFxuICAgICAgICAgICAgICAgIF9iYXNlOiBlbnN1cmVSaWdodFNsYXNoKHRoaXMudG9XZWJQYXRoKCkpLFxuICAgICAgICAgICAgICAgIF9tYWtlUGF0aDogKHJlbGF0aXZlUGF0aCwgcXVlcnkpID0+IHRoaXMudG9XZWJQYXRoKHJlbGF0aXZlUGF0aCwgcXVlcnkpLFxuICAgICAgICAgICAgICAgIF9tYWtlVXJsOiAocmVsYXRpdmVQYXRoLCBxdWVyeSkgPT4gY3R4LnRvVXJsKHJlbGF0aXZlUGF0aCwgcXVlcnkpICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKGN0eC5jc3JmKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY3R4LnN0YXRlLl9jc3JmID0gY3R4LmNzcmY7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBhY3Rpb24oY3R4KTtcbiAgICAgICAgfTsgICAgICAgIFxuICAgIH0gICBcblxuICAgIHVzZU1pZGRsZXdhcmUocm91dGVyLCBtaWRkbGV3YXJlLCBuYW1lKSB7ICAgICAgICAgIFxuICAgICAgICBhc3NlcnQ6IHR5cGVvZiBtaWRkbGV3YXJlID09PSAnZnVuY3Rpb24nLCBtaWRkbGV3YXJlO1xuICAgICAgICByb3V0ZXIudXNlKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmUsIG5hbWUpKTtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgQXR0YWNoZWQgbWlkZGxld2FyZSBbJHtuYW1lfV0uYCk7XG4gICAgfVxuXG4gICAgX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmUsIG5hbWUpIHsgICAgICAgIFxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnRyYWNlTWlkZGxld2FyZXMpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBhc3luYyAoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2coJ2RlYnVnJywgYFN0ZXAgaW4gbWlkZGxld2FyZSBcIiR7bmFtZSB8fCBtaWRkbGV3YXJlLm5hbWV9XCIgLi4uYCk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCBtaWRkbGV3YXJlKGN0eCwgbmV4dCk7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2coJ2RlYnVnJywgYFN0ZXAgb3V0IGZyb20gbWlkZGxld2FyZSBcIiR7bmFtZSB8fCBtaWRkbGV3YXJlLm5hbWV9XCIuYCk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbWlkZGxld2FyZTtcbiAgICB9XG5cbiAgICBfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCgpIHtcbiAgICAgICAgcmV0dXJuIHN1cGVyLl9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoKCkuY29uY2F0KFsgcGF0aC5qb2luKHRoaXMuYmFja2VuZFBhdGgsIExpdGVyYWwuRkVBVFVSRVNfUEFUSCkgXSk7XG4gICAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBSb3V0YWJsZTsiXX0=