"use strict";

require("source-map-support/register");

const path = require('path');

const {
  fs,
  glob
} = require('@genx/sys');

const {
  _,
  url: urlUtil,
  text
} = require('@genx/july');

const {
  ApplicationError,
  InvalidConfiguration
} = require('@genx/error');

const Literal = require('./enum/Literal');

const Koa = require('koa');

const mount = require('koa-mount');

const Routable = T => class extends T {
  constructor(name, options) {
    super(name, options);
    this.clientPath = this.toAbsolutePath(this.options.clientPath || Literal.CLIENT_SRC_PATH);
    this.publicPath = this.toAbsolutePath(this.options.publicPath || Literal.PUBLIC_PATH);
    this.router = new Koa();
    this.router.use((ctx, next) => {
      ctx.appModule = this;
      return next();
    });
    this.on('configLoaded', () => {
      let middlewareDir = path.join(this.backendPath, Literal.MIDDLEWARES_PATH);

      if (fs.existsSync(middlewareDir)) {
        this.loadMiddlewaresFrom(middlewareDir);
      }
    });
  }

  async start_() {
    this.middlewareFactoryRegistry = {};
    return super.start_();
  }

  async stop_() {
    delete this.middlewareFactoryRegistry;
    return super.stop_();
  }

  getBackendAction(actionByPath) {
    let lpos = actionByPath.lastIndexOf('.');

    if (lpos === -1) {
      throw new Error(`Invalid action path: ${actionByPath}`);
    }

    let controller = actionByPath.substr(0, lpos);
    let method = actionByPath.substr(lpos + 1);
    let controllerObj;

    try {
      controllerObj = require(path.resolve(this.backendPath, controller));
    } catch (error) {
      throw new Error(`Backend controller not found: ${controller}`);
    }

    let methodFunc = controllerObj[method];

    if (typeof methodFunc !== 'function') {
      throw new Error(`The specified action is not a function: ${actionByPath}`);
    }

    return methodFunc;
  }

  loadMiddlewaresFrom(dir) {
    let files = glob.sync(path.join(dir, '*.js'), {
      nodir: true
    });
    files.forEach(file => this.registerMiddlewareFactory(path.basename(file, '.js'), require(file)));
  }

  registerMiddlewareFactory(name, factoryMethod) {
    if (!(typeof factoryMethod === 'function')) {
      throw new Error('Invalid middleware factory: ' + name);
    }

    if (name in this.middlewareFactoryRegistry) {
      throw new ApplicationError('Middleware "' + name + '" already registered!');
    }

    this.middlewareFactoryRegistry[name] = factoryMethod;
    this.log('verbose', `Registered named middleware [${name}].`);
  }

  getMiddlewareFactory(name) {
    if (this.middlewareFactoryRegistry.hasOwnProperty(name)) {
      return this.middlewareFactoryRegistry[name];
    }

    if (this.server && this.server !== this) {
      return this.server.getMiddlewareFactory(name);
    }

    let npmMiddleware = this.tryRequire(name);

    if (npmMiddleware) {
      return npmMiddleware;
    }

    throw new ApplicationError(`Don't know where to load middleware "${name}".`);
  }

  useMiddlewares(router, middlewares) {
    let middlewareFactory, middleware;
    let middlewareFunctions = [];

    if (_.isPlainObject(middlewares)) {
      _.forOwn(middlewares, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        middleware = middlewareFactory(options, this);
        middlewareFunctions.push({
          name,
          middleware
        });
      });
    } else {
      middlewares = _.castArray(middlewares);

      _.each(middlewares, middlewareEntry => {
        let type = typeof middlewareEntry;

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(middlewareEntry);
          middleware = middlewareFactory(undefined, this);
          middlewareFunctions.push({
            name: middlewareEntry,
            middleware
          });
        } else if (type === 'function') {
          middlewareFunctions.push({
            name: middlewareEntry.name || 'unamed middleware',
            middleware: middlewareEntry
          });
        } else if (Array.isArray(middlewareEntry)) {
          if (middlewareEntry.length === 0) {
            throw new InvalidConfiguration('Empty array found as middleware entry!', this, 'middlewares');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry[0]);
          middleware = middlewareFactory(middlewareEntry.length > 1 ? middlewareEntry[1] : null, this);
          middlewareFunctions.push({
            name: middlewareEntry[0],
            middleware
          });
        } else {
          if (!_.isPlainObject(middlewareEntry) || !('name' in middlewareEntry)) {
            throw new InvalidConfiguration('Invalid middleware entry!', this, 'middlewares');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry.name);
          middleware = middlewareFactory(middlewareEntry.options, this);
          middlewareFunctions.push({
            name: middlewareEntry.name,
            middleware
          });
        }
      });
    }

    middlewareFunctions.forEach(({
      name,
      middleware
    }) => {
      if (Array.isArray(middleware)) {
        middleware.forEach(m => this.useMiddleware(router, m, name));
      } else {
        this.useMiddleware(router, middleware, name);
      }
    });
    return this;
  }

  addRoute(router, method, route, actions) {
    let handlers = [],
        middlewareFactory;

    if (_.isPlainObject(actions)) {
      _.forOwn(actions, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        handlers.push(this._wrapMiddlewareTracer(middlewareFactory(options, this), name));
      });
    } else {
      actions = _.castArray(actions);
      let lastIndex = actions.length - 1;

      _.each(actions, (action, i) => {
        let type = typeof action;

        if (i === lastIndex) {
          if (type === 'string' && action.lastIndexOf('.') > 0) {
            action = {
              name: 'action',
              options: action
            };
            type = 'object';
          }
        }

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(action);
          let middleware = middlewareFactory(null, this);

          if (Array.isArray(middleware)) {
            middleware.forEach((middlewareItem, i) => handlers.push(this._wrapMiddlewareTracer(middlewareItem, `${action}-${i}` + (middleware.name ? '-' + middleware.name : ''))));
          } else {
            handlers.push(this._wrapMiddlewareTracer(middleware, action));
          }
        } else if (type === 'function') {
          handlers.push(this._wrapMiddlewareTracer(action));
        } else if (Array.isArray(action)) {
          if (!(action.length > 0 && action.length <= 2)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action[0]);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.length > 1 ? action[1] : undefined, this)));
        } else {
          if (!(_.isPlainObject(action) && 'name' in action)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action.name);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.options, this), action.name));
        }
      });
    }

    router[method](route, ...handlers);
    let endpoint = router.opts.prefix ? urlUtil.join(this.route, router.opts.prefix, route) : urlUtil.join(this.route, route);
    this.log('verbose', `Route "${method}:${endpoint}" is added from module [${this.name}].`);
    return this;
  }

  addRouter(nestedRouter) {
    this.router.use(nestedRouter.routes());
    this.router.use(nestedRouter.allowedMethods());
    return this;
  }

  mountRouter(route, router) {
    this.router.use(mount(route, router));
  }

  toWebPath(relativePath, ...pathOrQuery) {
    let url, query;

    if (pathOrQuery && pathOrQuery.length > 0 && (pathOrQuery.length > 1 || pathOrQuery[0] !== undefined)) {
      if (_.isObject(pathOrQuery[pathOrQuery.length - 1])) {
        query = pathOrQuery.pop();
      }

      pathOrQuery.unshift(relativePath);
      url = urlUtil.join(this.route, ...pathOrQuery);
    } else {
      url = urlUtil.join(this.route, relativePath);
    }

    url = text.ensureStartsWith(url, '/');

    if (query) {
      url = urlUtil.appendQuery(url, query);
      url = url.replace('/?', '?');
    }

    return url;
  }

  useMiddleware(router, middleware, name) {
    if (!(typeof middleware === 'function')) {
      throw new Error(middleware);
    }

    router.use(this._wrapMiddlewareTracer(middleware, name));
    this.log('verbose', `Attached middleware [${name}].`);
  }

  _wrapMiddlewareTracer(middleware, name) {
    if (this.options.traceMiddlewares) {
      return async (ctx, next) => {
        this.log('debug', `Step in middleware "${name || middleware.name}" ...`);
        let ret = await middleware(ctx, next);
        this.log('debug', `Step out from middleware "${name || middleware.name}".`);
        return ret;
      };
    }

    return middleware;
  }

  _getFeatureFallbackPath() {
    return super._getFeatureFallbackPath().concat([path.join(this.backendPath, Literal.FEATURES_PATH)]);
  }

};

module.exports = Routable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Sb3V0YWJsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsImZzIiwiZ2xvYiIsIl8iLCJ1cmwiLCJ1cmxVdGlsIiwidGV4dCIsIkFwcGxpY2F0aW9uRXJyb3IiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsIkxpdGVyYWwiLCJLb2EiLCJtb3VudCIsIlJvdXRhYmxlIiwiVCIsImNvbnN0cnVjdG9yIiwibmFtZSIsIm9wdGlvbnMiLCJjbGllbnRQYXRoIiwidG9BYnNvbHV0ZVBhdGgiLCJDTElFTlRfU1JDX1BBVEgiLCJwdWJsaWNQYXRoIiwiUFVCTElDX1BBVEgiLCJyb3V0ZXIiLCJ1c2UiLCJjdHgiLCJuZXh0IiwiYXBwTW9kdWxlIiwib24iLCJtaWRkbGV3YXJlRGlyIiwiam9pbiIsImJhY2tlbmRQYXRoIiwiTUlERExFV0FSRVNfUEFUSCIsImV4aXN0c1N5bmMiLCJsb2FkTWlkZGxld2FyZXNGcm9tIiwic3RhcnRfIiwibWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeSIsInN0b3BfIiwiZ2V0QmFja2VuZEFjdGlvbiIsImFjdGlvbkJ5UGF0aCIsImxwb3MiLCJsYXN0SW5kZXhPZiIsIkVycm9yIiwiY29udHJvbGxlciIsInN1YnN0ciIsIm1ldGhvZCIsImNvbnRyb2xsZXJPYmoiLCJyZXNvbHZlIiwiZXJyb3IiLCJtZXRob2RGdW5jIiwiZGlyIiwiZmlsZXMiLCJzeW5jIiwibm9kaXIiLCJmb3JFYWNoIiwiZmlsZSIsInJlZ2lzdGVyTWlkZGxld2FyZUZhY3RvcnkiLCJiYXNlbmFtZSIsImZhY3RvcnlNZXRob2QiLCJsb2ciLCJnZXRNaWRkbGV3YXJlRmFjdG9yeSIsImhhc093blByb3BlcnR5Iiwic2VydmVyIiwibnBtTWlkZGxld2FyZSIsInRyeVJlcXVpcmUiLCJ1c2VNaWRkbGV3YXJlcyIsIm1pZGRsZXdhcmVzIiwibWlkZGxld2FyZUZhY3RvcnkiLCJtaWRkbGV3YXJlIiwibWlkZGxld2FyZUZ1bmN0aW9ucyIsImlzUGxhaW5PYmplY3QiLCJmb3JPd24iLCJwdXNoIiwiY2FzdEFycmF5IiwiZWFjaCIsIm1pZGRsZXdhcmVFbnRyeSIsInR5cGUiLCJ1bmRlZmluZWQiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJtIiwidXNlTWlkZGxld2FyZSIsImFkZFJvdXRlIiwicm91dGUiLCJhY3Rpb25zIiwiaGFuZGxlcnMiLCJfd3JhcE1pZGRsZXdhcmVUcmFjZXIiLCJsYXN0SW5kZXgiLCJhY3Rpb24iLCJpIiwibWlkZGxld2FyZUl0ZW0iLCJlbmRwb2ludCIsIm9wdHMiLCJwcmVmaXgiLCJhZGRSb3V0ZXIiLCJuZXN0ZWRSb3V0ZXIiLCJyb3V0ZXMiLCJhbGxvd2VkTWV0aG9kcyIsIm1vdW50Um91dGVyIiwidG9XZWJQYXRoIiwicmVsYXRpdmVQYXRoIiwicGF0aE9yUXVlcnkiLCJxdWVyeSIsImlzT2JqZWN0IiwicG9wIiwidW5zaGlmdCIsImVuc3VyZVN0YXJ0c1dpdGgiLCJhcHBlbmRRdWVyeSIsInJlcGxhY2UiLCJ0cmFjZU1pZGRsZXdhcmVzIiwicmV0IiwiX2dldEZlYXR1cmVGYWxsYmFja1BhdGgiLCJjb25jYXQiLCJGRUFUVVJFU19QQVRIIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsRUFBRjtBQUFNQyxFQUFBQTtBQUFOLElBQWVGLE9BQU8sQ0FBQyxXQUFELENBQTVCOztBQUNBLE1BQU07QUFBRUcsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxHQUFHLEVBQUVDLE9BQVY7QUFBbUJDLEVBQUFBO0FBQW5CLElBQTRCTixPQUFPLENBQUMsWUFBRCxDQUF6Qzs7QUFDQSxNQUFNO0FBQUVPLEVBQUFBLGdCQUFGO0FBQW9CQyxFQUFBQTtBQUFwQixJQUE2Q1IsT0FBTyxDQUFDLGFBQUQsQ0FBMUQ7O0FBQ0EsTUFBTVMsT0FBTyxHQUFHVCxPQUFPLENBQUMsZ0JBQUQsQ0FBdkI7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QyxHQUFMLENBQVMsU0FBVCxFQUFxQix3QkFBdUIzQyxJQUFLLElBQWpEO0FBQ0g7O0FBRUR1RSxFQUFBQSxxQkFBcUIsQ0FBQ25CLFVBQUQsRUFBYXBELElBQWIsRUFBbUI7QUFDcEMsUUFBSSxLQUFLQyxPQUFMLENBQWE2RixnQkFBakIsRUFBbUM7QUFDL0IsYUFBTyxPQUFPckYsR0FBUCxFQUFZQyxJQUFaLEtBQXFCO0FBQ3hCLGFBQUtpQyxHQUFMLENBQVMsT0FBVCxFQUFtQix1QkFBc0IzQyxJQUFJLElBQUlvRCxVQUFVLENBQUNwRCxJQUFLLE9BQWpFO0FBQ0EsWUFBSStGLEdBQUcsR0FBRyxNQUFNM0MsVUFBVSxDQUFDM0MsR0FBRCxFQUFNQyxJQUFOLENBQTFCO0FBQ0EsYUFBS2lDLEdBQUwsQ0FBUyxPQUFULEVBQW1CLDZCQUE0QjNDLElBQUksSUFBSW9ELFVBQVUsQ0FBQ3BELElBQUssSUFBdkU7QUFDQSxlQUFPK0YsR0FBUDtBQUNILE9BTEQ7QUFNSDs7QUFFRCxXQUFPM0MsVUFBUDtBQUNIOztBQUVENEMsRUFBQUEsdUJBQXVCLEdBQUc7QUFDdEIsV0FBTyxNQUFNQSx1QkFBTixHQUFnQ0MsTUFBaEMsQ0FBdUMsQ0FBRWpILElBQUksQ0FBQzhCLElBQUwsQ0FBVSxLQUFLQyxXQUFmLEVBQTRCckIsT0FBTyxDQUFDd0csYUFBcEMsQ0FBRixDQUF2QyxDQUFQO0FBQ0g7O0FBeFZpQyxDQUF0Qzs7QUEyVkFDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnZHLFFBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IGZzLCBnbG9iIH0gPSByZXF1aXJlKCdAZ2VueC9zeXMnKTtcbmNvbnN0IHsgXywgdXJsOiB1cmxVdGlsLCB0ZXh0IH0gPSByZXF1aXJlKCdAZ2VueC9qdWx5Jyk7XG5jb25zdCB7IEFwcGxpY2F0aW9uRXJyb3IsIEludmFsaWRDb25maWd1cmF0aW9uIH0gPSByZXF1aXJlKCdAZ2VueC9lcnJvcicpO1xuY29uc3QgTGl0ZXJhbCA9IHJlcXVpcmUoJy4vZW51bS9MaXRlcmFsJyk7XG5jb25zdCBLb2EgPSByZXF1aXJlKCdrb2EnKTtcbmNvbnN0IG1vdW50ID0gcmVxdWlyZSgna29hLW1vdW50Jyk7XG5cbmNvbnN0IFJvdXRhYmxlID0gVCA9PiBjbGFzcyBleHRlbmRzIFQgeyAgICBcbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHJvdXRhYmxlIGluc3RhbmNlLiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIFJvdXRhYmxlIG9wdGlvbnMgICAgICAgICAgICAgICBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuYmFja2VuZFBhdGg9J3NlcnZlciddIC0gUmVsYXRpdmUgcGF0aCBvZiBiYWNrLWVuZCBzZXJ2ZXIgc291cmNlIGZpbGVzXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmNsaWVudFBhdGg9J2NsaWVudCddIC0gUmVsYXRpdmUgcGF0aCBvZiBmcm9udC1lbmQgY2xpZW50IHNvdXJjZSBmaWxlcyAgICAgXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnB1YmxpY1BhdGg9J3B1YmxpYyddIC0gUmVsYXRpdmUgcGF0aCBvZiBmcm9udC1lbmQgc3RhdGljIGZpbGVzIFxuICAgICAqLyAgICAgICAgIFxuICAgIGNvbnN0cnVjdG9yKG5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIobmFtZSwgb3B0aW9ucyk7ICAgICAgICBcblxuICAgICAgICAvKipcbiAgICAgICAgICogRnJvbnRlbmQgc291cmNlIGZpbGVzIHBhdGguXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLmNsaWVudFBhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5jbGllbnRQYXRoIHx8IExpdGVyYWwuQ0xJRU5UX1NSQ19QQVRIKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogRnJvbnRlbmQgc3RhdGljIGZpbGVzIHBhdGguXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLnB1YmxpY1BhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5wdWJsaWNQYXRoIHx8IExpdGVyYWwuUFVCTElDX1BBVEgpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBFYWNoIGFwcCBoYXMgaXRzIG93biByb3V0ZXIuXG4gICAgICAgICAqIEBtZW1iZXIge0tvYX1cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLnJvdXRlciA9IG5ldyBLb2EoKTtcblxuICAgICAgICAvL2luamVjdCB0aGUgYXBwTW9kdWxlIGluc3RhbmNlIGluIHRoZSBmaXJzdCBtaWRkbGV3YXJlXG4gICAgICAgIHRoaXMucm91dGVyLnVzZSgoY3R4LCBuZXh0KSA9PiB7IFxuICAgICAgICAgICAgY3R4LmFwcE1vZHVsZSA9IHRoaXM7IFxuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTsgXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMub24oJ2NvbmZpZ0xvYWRlZCcsICgpID0+IHtcbiAgICAgICAgICAgIC8vbG9hZCBtaWRkbGV3YXJlcyBpZiBleGlzdHMgaW4gc2VydmVyIG9yIGFwcCBwYXRoXG4gICAgICAgICAgICBsZXQgbWlkZGxld2FyZURpciA9IHBhdGguam9pbih0aGlzLmJhY2tlbmRQYXRoLCBMaXRlcmFsLk1JRERMRVdBUkVTX1BBVEgpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhtaWRkbGV3YXJlRGlyKSkge1xuICAgICAgICAgICAgICAgIHRoaXMubG9hZE1pZGRsZXdhcmVzRnJvbShtaWRkbGV3YXJlRGlyKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSk7ICBcbiAgICB9XG5cbiAgICBhc3luYyBzdGFydF8oKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBNaWRkbGV3YXJlIGZhY3RvcnkgcmVnaXN0cnkuXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeSA9IHt9O1xuXG4gICAgICAgIHJldHVybiBzdXBlci5zdGFydF8oKTtcbiAgICB9XG5cbiAgICBhc3luYyBzdG9wXygpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeTtcblxuICAgICAgICByZXR1cm4gc3VwZXIuc3RvcF8oKTtcbiAgICB9XG5cbiAgICBnZXRCYWNrZW5kQWN0aW9uKGFjdGlvbkJ5UGF0aCkge1xuICAgICAgICBsZXQgbHBvcyA9IGFjdGlvbkJ5UGF0aC5sYXN0SW5kZXhPZignLicpO1xuXG4gICAgICAgIGlmIChscG9zID09PSAtMSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGFjdGlvbiBwYXRoOiAke2FjdGlvbkJ5UGF0aH1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjb250cm9sbGVyID0gYWN0aW9uQnlQYXRoLnN1YnN0cigwLCBscG9zKTtcbiAgICAgICAgbGV0IG1ldGhvZCA9IGFjdGlvbkJ5UGF0aC5zdWJzdHIobHBvcysxKTtcbiAgICAgICAgbGV0IGNvbnRyb2xsZXJPYmo7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnRyb2xsZXJPYmogPSByZXF1aXJlKHBhdGgucmVzb2x2ZSh0aGlzLmJhY2tlbmRQYXRoLCBjb250cm9sbGVyKSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEJhY2tlbmQgY29udHJvbGxlciBub3QgZm91bmQ6ICR7Y29udHJvbGxlcn1gKTtcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICBsZXQgbWV0aG9kRnVuYyA9IGNvbnRyb2xsZXJPYmpbbWV0aG9kXTtcbiAgICAgICAgaWYgKHR5cGVvZiBtZXRob2RGdW5jICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBzcGVjaWZpZWQgYWN0aW9uIGlzIG5vdCBhIGZ1bmN0aW9uOiAke2FjdGlvbkJ5UGF0aH1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBtZXRob2RGdW5jO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExvYWQgYW5kIHJlZ3NpdGVyIG1pZGRsZXdhcmUgZmlsZXMgZnJvbSBhIHNwZWNpZmllZCBwYXRoLlxuICAgICAqIEBwYXJhbSBkaXJcbiAgICAgKi9cbiAgICBsb2FkTWlkZGxld2FyZXNGcm9tKGRpcikge1xuICAgICAgICBsZXQgZmlsZXMgPSBnbG9iLnN5bmMocGF0aC5qb2luKGRpciwgJyouanMnKSwge25vZGlyOiB0cnVlfSk7XG4gICAgICAgIGZpbGVzLmZvckVhY2goZmlsZSA9PiB0aGlzLnJlZ2lzdGVyTWlkZGxld2FyZUZhY3RvcnkocGF0aC5iYXNlbmFtZShmaWxlLCAnLmpzJyksIHJlcXVpcmUoZmlsZSkpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZWdpc3RlciB0aGUgZmFjdG9yeSBtZXRob2Qgb2YgYSBuYW1lZCBtaWRkbGV3YXJlLiAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgbWlkZGxld2FyZSBcbiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBmYWN0b3J5TWV0aG9kIC0gVGhlIGZhY3RvcnkgbWV0aG9kIG9mIGEgbWlkZGxld2FyZVxuICAgICAqL1xuICAgIHJlZ2lzdGVyTWlkZGxld2FyZUZhY3RvcnkobmFtZSwgZmFjdG9yeU1ldGhvZCkge1xuICAgICAgICBwcmU6IHR5cGVvZiBmYWN0b3J5TWV0aG9kID09PSAnZnVuY3Rpb24nLCAnSW52YWxpZCBtaWRkbGV3YXJlIGZhY3Rvcnk6ICcgKyBuYW1lOyAgICAgICAgXG5cbiAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQXBwbGljYXRpb25FcnJvcignTWlkZGxld2FyZSBcIicrIG5hbWUgKydcIiBhbHJlYWR5IHJlZ2lzdGVyZWQhJyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnlbbmFtZV0gPSBmYWN0b3J5TWV0aG9kO1xuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBSZWdpc3RlcmVkIG5hbWVkIG1pZGRsZXdhcmUgWyR7bmFtZX1dLmApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgZmFjdG9yeSBtZXRob2Qgb2YgYSBtaWRkbGV3YXJlIGZyb20gbW9kdWxlIGhpZXJhcmNoeS4gICAgIFxuICAgICAqIEBwYXJhbSBuYW1lXG4gICAgICogQHJldHVybnMge2Z1bmN0aW9ufVxuICAgICAqL1xuICAgIGdldE1pZGRsZXdhcmVGYWN0b3J5KG5hbWUpIHtcbiAgICAgICAgaWYgKHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeVtuYW1lXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnNlcnZlciAmJiB0aGlzLnNlcnZlciAhPT0gdGhpcykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VydmVyLmdldE1pZGRsZXdhcmVGYWN0b3J5KG5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG5wbU1pZGRsZXdhcmUgPSB0aGlzLnRyeVJlcXVpcmUobmFtZSk7XG4gICAgICAgIGlmIChucG1NaWRkbGV3YXJlKSB7XG4gICAgICAgICAgICByZXR1cm4gbnBtTWlkZGxld2FyZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRocm93IG5ldyBBcHBsaWNhdGlvbkVycm9yKGBEb24ndCBrbm93IHdoZXJlIHRvIGxvYWQgbWlkZGxld2FyZSBcIiR7bmFtZX1cIi5gKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVc2UgbWlkZGxld2FyZXNcbiAgICAgKiBAcGFyYW0ge1JvdXRlcn0gcm91dGVyXG4gICAgICogQHBhcmFtIHsqfSBtaWRkbGV3YXJlcyAtIENhbiBiZSBhbiBhcnJheSBvZiBtaWRkbGV3YXJlIGVudHJpZXMgb3IgYSBrZXktdmFsdWUgbGlzdCBvZiByZWdpc3RlcnJlZCBtaWRkbGV3YXJlc1xuICAgICAqIEByZXR1cm5zIHtSb3V0YWJsZX1cbiAgICAgKi9cbiAgICB1c2VNaWRkbGV3YXJlcyhyb3V0ZXIsIG1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGxldCBtaWRkbGV3YXJlRmFjdG9yeSwgbWlkZGxld2FyZTtcbiAgICAgICAgbGV0IG1pZGRsZXdhcmVGdW5jdGlvbnMgPSBbXTtcbiAgICAgICAgXG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QobWlkZGxld2FyZXMpKSB7XG4gICAgICAgICAgICBfLmZvck93bihtaWRkbGV3YXJlcywgKG9wdGlvbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSk7ICAgXG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZSA9IG1pZGRsZXdhcmVGYWN0b3J5KG9wdGlvbnMsIHRoaXMpO1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMucHVzaCh7IG5hbWUsIG1pZGRsZXdhcmUgfSk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtaWRkbGV3YXJlcyA9IF8uY2FzdEFycmF5KG1pZGRsZXdhcmVzKTsgICAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgXy5lYWNoKG1pZGRsZXdhcmVzLCBtaWRkbGV3YXJlRW50cnkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCB0eXBlID0gdHlwZW9mIG1pZGRsZXdhcmVFbnRyeTtcblxuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAvLyBbICduYW1lZE1pZGRsZXdhcmUnIF1cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmVFbnRyeSk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeSh1bmRlZmluZWQsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lOiBtaWRkbGV3YXJlRW50cnkgLCBtaWRkbGV3YXJlIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lOiBtaWRkbGV3YXJlRW50cnkubmFtZSB8fCAndW5hbWVkIG1pZGRsZXdhcmUnLCBtaWRkbGV3YXJlOiBtaWRkbGV3YXJlRW50cnl9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkobWlkZGxld2FyZUVudHJ5KSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBbIFsgJ25hbWVkTWlkZGxld2FyZScsIGNvbmZpZyBdIF1cbiAgICAgICAgICAgICAgICAgICAgaWYgKG1pZGRsZXdhcmVFbnRyeS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnRW1wdHkgYXJyYXkgZm91bmQgYXMgbWlkZGxld2FyZSBlbnRyeSEnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ21pZGRsZXdhcmVzJ1xuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShtaWRkbGV3YXJlRW50cnlbMF0pO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlID0gbWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUVudHJ5Lmxlbmd0aCA+IDEgPyBtaWRkbGV3YXJlRW50cnlbMV0gOiBudWxsLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5wdXNoKHsgbmFtZTogbWlkZGxld2FyZUVudHJ5WzBdLCBtaWRkbGV3YXJlIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KG1pZGRsZXdhcmVFbnRyeSkgfHwgISgnbmFtZScgaW4gbWlkZGxld2FyZUVudHJ5KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdJbnZhbGlkIG1pZGRsZXdhcmUgZW50cnkhJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtaWRkbGV3YXJlcydcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUVudHJ5Lm5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlID0gbWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUVudHJ5Lm9wdGlvbnMsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lOiBtaWRkbGV3YXJlRW50cnkubmFtZSwgbWlkZGxld2FyZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMuZm9yRWFjaCgoeyBuYW1lLCBtaWRkbGV3YXJlIH0pID0+IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG1pZGRsZXdhcmUpKSB7XG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZS5mb3JFYWNoKG0gPT4gdGhpcy51c2VNaWRkbGV3YXJlKHJvdXRlciwgbSwgbmFtZSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVzZU1pZGRsZXdhcmUocm91dGVyLCBtaWRkbGV3YXJlLCBuYW1lKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSByb3V0ZSB0byBhIHJvdXRlciwgc2tpcHBlZCB3aGlsZSB0aGUgc2VydmVyIHJ1bm5pbmcgaW4gZGVhZiBtb2RlLiAgICAgXG4gICAgICogQHBhcmFtIHJvdXRlclxuICAgICAqIEBwYXJhbSBtZXRob2RcbiAgICAgKiBAcGFyYW0gcm91dGVcbiAgICAgKiBAcGFyYW0gYWN0aW9uc1xuICAgICAqL1xuICAgIGFkZFJvdXRlKHJvdXRlciwgbWV0aG9kLCByb3V0ZSwgYWN0aW9ucykge1xuICAgICAgICBsZXQgaGFuZGxlcnMgPSBbXSwgbWlkZGxld2FyZUZhY3Rvcnk7XG5cbiAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChhY3Rpb25zKSkge1xuICAgICAgICAgICAgXy5mb3JPd24oYWN0aW9ucywgKG9wdGlvbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSk7XG4gICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaCh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlRmFjdG9yeShvcHRpb25zLCB0aGlzKSwgbmFtZSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhY3Rpb25zID0gXy5jYXN0QXJyYXkoYWN0aW9ucyk7XG4gICAgICAgICAgICBsZXQgbGFzdEluZGV4ID0gYWN0aW9ucy5sZW5ndGggLSAxO1xuXG4gICAgICAgICAgICBfLmVhY2goYWN0aW9ucywgKGFjdGlvbiwgaSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCB0eXBlID0gdHlwZW9mIGFjdGlvbjtcblxuICAgICAgICAgICAgICAgIGlmIChpID09PSBsYXN0SW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gbGFzdCBtaWRkbGV3YXJlIG1heSBiZSBhbiBhY3Rpb25cbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnICYmIGFjdGlvbi5sYXN0SW5kZXhPZignLicpID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICdhY3Rpb24nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IGFjdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICdvYmplY3QnO1xuICAgICAgICAgICAgICAgICAgICB9ICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAvLyBbICduYW1lZE1pZGRsZXdhcmUnIF1cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvbik7ICAgXG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeShudWxsLCB0aGlzKTtcblxuICAgICAgICAgICAgICAgICAgICAvL2luIGNhc2UgaXQncyByZWdpc3RlciBieSB0aGUgbWlkZGxld2FyZUZhY3RvcnkgZmVhdHVyZVxuICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShtaWRkbGV3YXJlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZS5mb3JFYWNoKChtaWRkbGV3YXJlSXRlbSwgaSkgPT4gaGFuZGxlcnMucHVzaChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlSXRlbSwgYCR7YWN0aW9ufS0ke2l9YCArIChtaWRkbGV3YXJlLm5hbWUgPyAoJy0nICsgbWlkZGxld2FyZS5uYW1lKSA6ICcnKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICkpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmUsIGFjdGlvbikpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIoYWN0aW9uKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGFjdGlvbikpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiBhY3Rpb24ubGVuZ3RoID4gMCAmJiBhY3Rpb24ubGVuZ3RoIDw9IDIsICdJbnZhbGlkIG1pZGRsZXdhcmUgZW50cnknO1xuXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShhY3Rpb25bMF0pOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uLmxlbmd0aCA+IDEgPyBhY3Rpb25bMV0gOiB1bmRlZmluZWQsIHRoaXMpKSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQ6IF8uaXNQbGFpbk9iamVjdChhY3Rpb24pICYmICduYW1lJyBpbiBhY3Rpb24sICdJbnZhbGlkIG1pZGRsZXdhcmUgZW50cnknO1xuXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShhY3Rpb24ubmFtZSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaCh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlRmFjdG9yeShhY3Rpb24ub3B0aW9ucywgdGhpcyksIGFjdGlvbi5uYW1lKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIHJvdXRlclttZXRob2RdKHJvdXRlLCAuLi5oYW5kbGVycyk7XG5cbiAgICAgICAgbGV0IGVuZHBvaW50ID0gcm91dGVyLm9wdHMucHJlZml4ID8gdXJsVXRpbC5qb2luKHRoaXMucm91dGUsIHJvdXRlci5vcHRzLnByZWZpeCwgcm91dGUpIDogdXJsVXRpbC5qb2luKHRoaXMucm91dGUsIHJvdXRlKTtcblxuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBSb3V0ZSBcIiR7bWV0aG9kfToke2VuZHBvaW50fVwiIGlzIGFkZGVkIGZyb20gbW9kdWxlIFske3RoaXMubmFtZX1dLmApO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH0gICAgXG5cbiAgICAvKipcbiAgICAgKiBBdHRhY2ggYSByb3V0ZXIgdG8gdGhpcyBhcHAgbW9kdWxlLCBza2lwcGVkIHdoaWxlIHRoZSBzZXJ2ZXIgcnVubmluZyBpbiBkZWFmIG1vZGUgICAgIFxuICAgICAqIEBwYXJhbSB7Um91dGVyfSBuZXN0ZWRSb3V0ZXJcbiAgICAgKi9cbiAgICBhZGRSb3V0ZXIobmVzdGVkUm91dGVyKSB7XG4gICAgICAgIHRoaXMucm91dGVyLnVzZShuZXN0ZWRSb3V0ZXIucm91dGVzKCkpO1xuICAgICAgICB0aGlzLnJvdXRlci51c2UobmVzdGVkUm91dGVyLmFsbG93ZWRNZXRob2RzKCkpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBdHRhY2ggYSByb3V0ZXIgdG8gdGhpcyBhcHAgbW9kdWxlIGJ5IG1vdW50aW5nIHRoZSByb3V0ZXIgdG8gYSByb3V0ZVxuICAgICAqIEBwYXJhbSB7Kn0gcm91dGUgXG4gICAgICogQHBhcmFtIHsqfSByb3V0ZXIgXG4gICAgICovXG4gICAgbW91bnRSb3V0ZXIocm91dGUsIHJvdXRlcikge1xuICAgICAgICB0aGlzLnJvdXRlci51c2UobW91bnQocm91dGUsIHJvdXRlcikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRyYW5zbGF0ZSBhIHJlbGF0aXZlIHBhdGggYW5kIHF1ZXJ5IHBhcmFtZXRlcnMgaWYgYW55IHRvIGEgdXJsIHBhdGggICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSByZWxhdGl2ZVBhdGggLSBSZWxhdGl2ZSBwYXRoXG4gICAgICogQHBhcmFtIHsuLi4qfSBbcGF0aE9yUXVlcnldIC0gUXVlcmllc1xuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAgICovXG4gICAgdG9XZWJQYXRoKHJlbGF0aXZlUGF0aCwgLi4ucGF0aE9yUXVlcnkpIHtcbiAgICAgICAgbGV0IHVybCwgcXVlcnk7XG5cbiAgICAgICAgaWYgKHBhdGhPclF1ZXJ5ICYmIHBhdGhPclF1ZXJ5Lmxlbmd0aCA+IDAgJiYgKHBhdGhPclF1ZXJ5Lmxlbmd0aCA+IDEgfHwgcGF0aE9yUXVlcnlbMF0gIT09IHVuZGVmaW5lZCkpIHtcbiAgICAgICAgICAgIGlmIChfLmlzT2JqZWN0KHBhdGhPclF1ZXJ5W3BhdGhPclF1ZXJ5Lmxlbmd0aCAtIDFdKSkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5ID0gcGF0aE9yUXVlcnkucG9wKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwYXRoT3JRdWVyeS51bnNoaWZ0KHJlbGF0aXZlUGF0aCk7XG4gICAgICAgICAgICB1cmwgPSB1cmxVdGlsLmpvaW4odGhpcy5yb3V0ZSwgLi4ucGF0aE9yUXVlcnkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdXJsID0gdXJsVXRpbC5qb2luKHRoaXMucm91dGUsIHJlbGF0aXZlUGF0aCk7XG4gICAgICAgIH1cblxuICAgICAgICB1cmwgPSB0ZXh0LmVuc3VyZVN0YXJ0c1dpdGgodXJsLCAnLycpO1xuXG4gICAgICAgIGlmIChxdWVyeSkge1xuICAgICAgICAgICAgdXJsID0gdXJsVXRpbC5hcHBlbmRRdWVyeSh1cmwsIHF1ZXJ5KTtcbiAgICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKCcvPycsICc/Jyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdXJsO1xuICAgIH0gICBcblxuICAgIHVzZU1pZGRsZXdhcmUocm91dGVyLCBtaWRkbGV3YXJlLCBuYW1lKSB7ICAgICAgICAgIFxuICAgICAgICBhc3NlcnQ6IHR5cGVvZiBtaWRkbGV3YXJlID09PSAnZnVuY3Rpb24nLCBtaWRkbGV3YXJlO1xuICAgICAgICByb3V0ZXIudXNlKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmUsIG5hbWUpKTtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgQXR0YWNoZWQgbWlkZGxld2FyZSBbJHtuYW1lfV0uYCk7XG4gICAgfVxuXG4gICAgX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmUsIG5hbWUpIHsgICAgICAgIFxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnRyYWNlTWlkZGxld2FyZXMpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBhc3luYyAoY3R4LCBuZXh0KSA9PiB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRoaXMubG9nKCdkZWJ1ZycsIGBTdGVwIGluIG1pZGRsZXdhcmUgXCIke25hbWUgfHwgbWlkZGxld2FyZS5uYW1lfVwiIC4uLmApOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgbWlkZGxld2FyZShjdHgsIG5leHQpO1xuICAgICAgICAgICAgICAgIHRoaXMubG9nKCdkZWJ1ZycsIGBTdGVwIG91dCBmcm9tIG1pZGRsZXdhcmUgXCIke25hbWUgfHwgbWlkZGxld2FyZS5uYW1lfVwiLmApOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICByZXR1cm4gcmV0O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG1pZGRsZXdhcmU7XG4gICAgfVxuXG4gICAgX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKSB7XG4gICAgICAgIHJldHVybiBzdXBlci5fZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCgpLmNvbmNhdChbIHBhdGguam9pbih0aGlzLmJhY2tlbmRQYXRoLCBMaXRlcmFsLkZFQVRVUkVTX1BBVEgpIF0pO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gUm91dGFibGU7Il19