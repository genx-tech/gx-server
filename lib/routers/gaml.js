"use strict";

require("source-map-support/register");

const path = require('path');

const {
  glob
} = require('@genx/sys');

const {
  _,
  naming,
  text
} = require('@genx/july');

const Literal = require('../enum/Literal');

const Router = require('@koa/router');

const {
  hasMethod
} = require('../utils/Helpers');

const appendId = (baseEndpoint, idName) => idName ? `${baseEndpoint}/:${idName}` : baseEndpoint;

module.exports = (app, baseRoute, options) => {
  let resourcePath = path.resolve(app.backendPath, options.resourcesPath || Literal.RESOURCES_PATH);
  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(options.errorOptions, app), 'jsonError');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let resourcesPath = path.join(resourcePath, "*.js");
  let files = glob.sync(resourcesPath, {
    nodir: true
  });

  _.each(files, file => {
    let entityName = path.basename(file, '.js');

    let controller = require(file);

    if (typeof controller === 'function') {
      controller = new controller(app);
    }

    let baseEndpoint;

    if (options.remaps && entityName in options.remaps) {
      baseEndpoint = text.ensureStartsWith(text.dropIfEndsWith(options.remaps[entityName], '/'), '/');
    } else {
      baseEndpoint = text.ensureStartsWith(naming.kebabCase(entityName), '/');
    }

    let idName = naming.camelCase(entityName) + 'Id';
    let endpointWithId = appendId(baseEndpoint, idName);

    if (hasMethod(controller, 'find')) {
      app.addRoute(router, 'get', baseEndpoint, ctx => controller.find(ctx));
    }

    if (hasMethod(controller, 'post')) {
      app.addRoute(router, 'post', baseEndpoint, ctx => controller.post(ctx));
    }

    if (hasMethod(controller, 'findById')) {
      app.addRoute(router, 'get', endpointWithId, ctx => controller.findById(ctx, ctx.params[idName]));
    }

    if (hasMethod(controller, 'updateById')) {
      app.addRoute(router, 'put', endpointWithId, ctx => controller.updateById(ctx, ctx.params[idName]));
    }

    if (hasMethod(controller, 'deleteById')) {
      app.addRoute(router, 'del', endpointWithId, ctx => controller.deleteById(ctx, ctx.params[idName]));
    }
  });

  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhbWwuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJnbG9iIiwiXyIsIm5hbWluZyIsInRleHQiLCJMaXRlcmFsIiwiUm91dGVyIiwiaGFzTWV0aG9kIiwiYXBwZW5kSWQiLCJiYXNlRW5kcG9pbnQiLCJpZE5hbWUiLCJtb2R1bGUiLCJleHBvcnRzIiwiYXBwIiwiYmFzZVJvdXRlIiwib3B0aW9ucyIsInJlc291cmNlUGF0aCIsInJlc29sdmUiLCJiYWNrZW5kUGF0aCIsInJlc291cmNlc1BhdGgiLCJSRVNPVVJDRVNfUEFUSCIsInJvdXRlciIsInByZWZpeCIsInVzZU1pZGRsZXdhcmUiLCJnZXRNaWRkbGV3YXJlRmFjdG9yeSIsImVycm9yT3B0aW9ucyIsIm1pZGRsZXdhcmVzIiwidXNlTWlkZGxld2FyZXMiLCJqb2luIiwiZmlsZXMiLCJzeW5jIiwibm9kaXIiLCJlYWNoIiwiZmlsZSIsImVudGl0eU5hbWUiLCJiYXNlbmFtZSIsImNvbnRyb2xsZXIiLCJyZW1hcHMiLCJlbnN1cmVTdGFydHNXaXRoIiwiZHJvcElmRW5kc1dpdGgiLCJrZWJhYkNhc2UiLCJjYW1lbENhc2UiLCJlbmRwb2ludFdpdGhJZCIsImFkZFJvdXRlIiwiY3R4IiwiZmluZCIsInBvc3QiLCJmaW5kQnlJZCIsInBhcmFtcyIsInVwZGF0ZUJ5SWQiLCJkZWxldGVCeUlkIiwiYWRkUm91dGVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQVdELE9BQU8sQ0FBQyxXQUFELENBQXhCOztBQUNBLE1BQU07QUFBRUUsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxNQUFMO0FBQWFDLEVBQUFBO0FBQWIsSUFBc0JKLE9BQU8sQ0FBQyxZQUFELENBQW5DOztBQUNBLE1BQU1LLE9BQU8sR0FBR0wsT0FBTyxDQUFDLGlCQUFELENB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QUFBLEdBQUcsQ0FBQ3NDLFNBQUosQ0FBYzlCLE1BQWQ7QUFDSCxDQXZERCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBnbG9iIH0gPSByZXF1aXJlKCdAZ2VueC9zeXMnKTtcbmNvbnN0IHsgXywgbmFtaW5nLCB0ZXh0IH0gPSByZXF1aXJlKCdAZ2VueC9qdWx5Jyk7XG5jb25zdCBMaXRlcmFsID0gcmVxdWlyZSgnLi4vZW51bS9MaXRlcmFsJyk7XG5jb25zdCBSb3V0ZXIgPSByZXF1aXJlKCdAa29hL3JvdXRlcicpO1xuY29uc3QgeyBoYXNNZXRob2QgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0hlbHBlcnMnKTtcblxuLyoqXG4gKiBHYW1sIHJvdXRlci5cbiAqIEBtb2R1bGUgUm91dGVyX0dhbWxcbiAqL1xuXG5jb25zdCBhcHBlbmRJZCA9IChiYXNlRW5kcG9pbnQsIGlkTmFtZSkgPT4gaWROYW1lID8gYCR7YmFzZUVuZHBvaW50fS86JHtpZE5hbWV9YCA6IGJhc2VFbmRwb2ludDsgXG5cbi8qKlxuICogQ3JlYXRlIGEgZ2FtbCByb3V0ZXIuXG4gKiBAcGFyYW0geyp9IGFwcCBcbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUm91dGUgXG4gKiBAcGFyYW0ge29iamVjdHN9IG9wdGlvbnMgXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucmVzb3VyY2VzUGF0aF1cbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fGFycmF5fSBbb3B0aW9ucy5taWRkbGV3YXJlc11cbiAqIEBleGFtcGxlXG4gKiAgJzxiYXNlIHBhdGg+Jzoge1xuICogICAgICBnYW1sOiB7XG4gKiAgICAgICAgICByZXNvdXJjZXNQYXRoOlxuICogICAgICAgICAgbWlkZGxld2FyZXM6XG4gKiAgICAgIH1cbiAqICB9XG4gKiAgXG4gKiAgcm91dGUgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAgbWV0aG9kICAgIGZ1bmN0aW9uIG9mIGN0cmxcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgZmluZCBcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgcG9zdCAgICAgICAgICAgcG9zdFxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBmaW5kQnlJZFxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBwdXQgICAgICAgICAgICB1cGRhdGVCeUlkXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGRlbCAgICAgICAgICAgIGRlbGV0ZUJ5SWRcbiAqL1xubW9kdWxlLmV4cG9ydHMgPSAoYXBwLCBiYXNlUm91dGUsIG9wdGlvbnMpID0+IHtcbiAgICBsZXQgcmVzb3VyY2VQYXRoID0gcGF0aC5yZXNvbHZlKGFwcC5iYWNrZW5kUGF0aCwgb3B0aW9ucy5yZXNvdXJjZXNQYXRoIHx8IExpdGVyYWwuUkVTT1VSQ0VTX1BBVEgpO1xuICAgIFxuICAgIGxldCByb3V0ZXIgPSBiYXNlUm91dGUgPT09ICcvJyA/IG5ldyBSb3V0ZXIoKSA6IG5ldyBSb3V0ZXIoe3ByZWZpeDogYmFzZVJvdXRlfSk7XG5cbiAgICBhcHAudXNlTWlkZGxld2FyZShyb3V0ZXIsIGFwcC5nZXRNaWRkbGV3YXJlRmFjdG9yeSgnanNvbkVycm9yJykob3B0aW9ucy5lcnJvck9wdGlvbnMsIGFwcCksICdqc29uRXJyb3InKTtcblxuICAgIGlmIChvcHRpb25zLm1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGFwcC51c2VNaWRkbGV3YXJlcyhyb3V0ZXIsIG9wdGlvbnMubWlkZGxld2FyZXMpO1xuICAgIH1cblxuICAgIGxldCByZXNvdXJjZXNQYXRoID0gcGF0aC5qb2luKHJlc291cmNlUGF0aCwgXCIqLmpzXCIpO1xuICAgIGxldCBmaWxlcyA9IGdsb2Iuc3luYyhyZXNvdXJjZXNQYXRoLCB7bm9kaXI6IHRydWV9KTtcblxuICAgIF8uZWFjaChmaWxlcywgZmlsZSA9PiB7XG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gcGF0aC5iYXNlbmFtZShmaWxlLCAnLmpzJyk7XG4gICAgICAgIGxldCBjb250cm9sbGVyID0gcmVxdWlyZShmaWxlKTtcblxuICAgICAgICBpZiAodHlwZW9mIGNvbnRyb2xsZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBuZXcgY29udHJvbGxlcihhcHApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGJhc2VFbmRwb2ludDtcblxuICAgICAgICBpZiAob3B0aW9ucy5yZW1hcHMgJiYgZW50aXR5TmFtZSBpbiBvcHRpb25zLnJlbWFwcykge1xuICAgICAgICAgICAgYmFzZUVuZHBvaW50ID0gdGV4dC5lbnN1cmVTdGFydHNXaXRoKHRleHQuZHJvcElmRW5kc1dpdGgob3B0aW9ucy5yZW1hcHNbZW50aXR5TmFtZV0sICcvJyksICcvJyk7ICAgICAgICAgICAgICAgIFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYmFzZUVuZHBvaW50ID0gdGV4dC5lbnN1cmVTdGFydHNXaXRoKG5hbWluZy5rZWJhYkNhc2UoZW50aXR5TmFtZSksICcvJyk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGxldCBpZE5hbWUgPSBuYW1pbmcuY2FtZWxDYXNlKGVudGl0eU5hbWUpICsgJ0lkJztcbiAgICAgICAgbGV0IGVuZHBvaW50V2l0aElkID0gYXBwZW5kSWQoYmFzZUVuZHBvaW50LCBpZE5hbWUpOyAgICAgICAgXG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAnZmluZCcpKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgYmFzZUVuZHBvaW50LCAoY3R4KSA9PiBjb250cm9sbGVyLmZpbmQoY3R4KSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdwb3N0JykpIHtcbiAgICAgICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwb3N0JywgYmFzZUVuZHBvaW50LCAoY3R4KSA9PiBjb250cm9sbGVyLnBvc3QoY3R4KSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdmaW5kQnlJZCcpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgZW5kcG9pbnRXaXRoSWQsIChjdHgpID0+IGNvbnRyb2xsZXIuZmluZEJ5SWQoY3R4LCBjdHgucGFyYW1zW2lkTmFtZV0pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ3VwZGF0ZUJ5SWQnKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3B1dCcsIGVuZHBvaW50V2l0aElkLCAoY3R4KSA9PiBjb250cm9sbGVyLnVwZGF0ZUJ5SWQoY3R4LCBjdHgucGFyYW1zW2lkTmFtZV0pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ2RlbGV0ZUJ5SWQnKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2RlbCcsIGVuZHBvaW50V2l0aElkLCAoY3R4KSA9PiBjb250cm9sbGVyLmRlbGV0ZUJ5SWQoY3R4LCBjdHgucGFyYW1zW2lkTmFtZV0pKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgYXBwLmFkZFJvdXRlcihyb3V0ZXIpO1xufTsiXX0=