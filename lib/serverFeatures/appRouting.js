"use strict";

require("source-map-support/register");

const Feature = require('@genx/app/lib/enum/Feature');

const path = require('path');

const Util = require('rk-utils');

const Promise = Util.Promise;

const {
  InvalidConfiguration
} = require('../utils/Errors');

const WebModule = require('../WebModule');

module.exports = {
  type: Feature.PLUGIN,
  load_: async (server, routes) => Util.eachAsync_(routes, async (config, baseRoute) => {
    if (!config.name) {
      throw new InvalidConfiguration('Missing app name.', app, `appRouting.${baseRoute}.name`);
    }

    let options = Object.assign({
      env: server.env,
      logWithAppName: server.options.logWithAppName,
      traceMiddlewares: server.options.traceMiddlewares
    }, config.options);
    let appPath;

    if (config.npmModule) {
      appPath = server.toAbsolutePath('node_modules', config.name);
    } else {
      appPath = path.join(server.appModulesPath, config.name);
    }

    let exists = (await Util.fs.pathExists(appPath)) && (await Util.fs.stat(appPath)).isDirectory();

    if (!exists) {
      throw new InvalidConfiguration(`App [${config.name}] not exists.`, server, `appRouting.${baseRoute}.name`);
    }

    let app = new WebModule(server, config.name, baseRoute, appPath, options);
    app.on('configLoaded', () => {
      if (!Util._.isEmpty(config.settings)) {
        app.config.settings = Object.assign({}, app.config.settings, config.settings);
        server.log('verbose', `App settings of [${app.name}] is overrided.`);
      }

      if (!Util._.isEmpty(config.middlewares)) {
        let middlewaresToAppend = app.config.middlewares;
        app.config.middlewares = Object.assign({}, config.middlewares);

        Util._.defaults(app.config.middlewares, middlewaresToAppend);
      }
    });
    let relativePath = path.relative(server.workingPath, appPath);
    server.log('verbose', `Loading app [${app.name}] from "${relativePath}" ...`);
    await app.start_();
    server.log('verbose', `App [${app.name}] is loaded.`);
    server.on('before:' + Feature.READY, () => {
      server.mountApp(app);
    });
  })
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXJGZWF0dXJlcy9hcHBSb3V0aW5nLmpzIl0sIm5hbWVzIjpbIkZlYXR1cmUiLCJyZXF1aXJlIiwicGF0aCIsIlV0aWwiLCJQcm9taXNlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJXZWJNb2R1bGUiLCJtb2R1bGUiLCJleHBvcnRzIiwidHlwZSIsIlBMVUdJTiIsImxvYWRfIiwic2VydmVyIiwicm91dGVzIiwiZWFjaEFzeW5jXyIsImNvbmZpZyIsImJhc2VSb3V0ZSIsIm5hbWUiLCJhcHAiLCJvcHRpb25zIiwiT2JqZWN0IiwiYXNzaWduIiwiZW52IiwibG9nV2l0aEFwcE5hbWUiLCJ0cmFjZU1pZGRsZXdhcmVzIiwiYXBwUGF0aCIsIm5wbU1vZHVsZSIsInRvQWJzb2x1dGVQYXRoIiwiam9pbiIsImFwcE1vZHVsZXNQYXRoIiwiZXhpc3RzIiwiZnMiLCJwYXRoRXhpc3RzIiwic3RhdCIsImlzRGlyZWN0b3J5Iiwib24iLCJfIiwiaXNFbXB0eSIsInNldHRpbmdzIiwibG9nIiwibWlkZGxld2FyZXMiLCJtaWRkbGV3YXJlc1RvQXBwZW5kIiwiZGVmYXVsdHMiLCJyZWxhdGl2ZVBhdGgiLCJyZWxhdGl2ZSIsIndvcmtpbmdQYXRoIiwic3RhcnRfIiwiUkVBRFkiLCJtb3VudEFwcCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFzQkEsTUFBTUEsT0FBTyxHQUFHQyxPQUFPLENBQUMsNEJBQUQsQ0FBdkI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNRSxJQUFJLEdBQUdGLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU1HLE9BQU8sR0FBR0QsSUFBSSxDQUFDQyxPQUFyQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBMkJKLE9BQU8sQ0FBQyxpQkFBRCxDQUF4Qzs7QUFDQSxNQUFNSyxTQUFTLEdBQUdMLE9BQU8sQ0FBQyxjQUFELENBQXpCOztBQUVBTSxNQUFN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RyxDQUFDSCxNQUFKLENBQVd5QixXQUEzQixFQUF3Q0MsbUJBQXhDO0FBQ0g7QUFDSixLQVhEO0FBYUEsUUFBSUUsWUFBWSxHQUFHekMsSUFBSSxDQUFDMEMsUUFBTCxDQUFjaEMsTUFBTSxDQUFDaUMsV0FBckIsRUFBa0NwQixPQUFsQyxDQUFuQjtBQUNBYixJQUFBQSxNQUFNLENBQUMyQixHQUFQLENBQVcsU0FBWCxFQUF1QixnQkFBZXJCLEdBQUcsQ0FBQ0QsSUFBSyxXQUFVMEIsWUFBYSxPQUF0RTtBQUVBLFVBQU16QixHQUFHLENBQUM0QixNQUFKLEVBQU47QUFFQWxDLElBQUFBLE1BQU0sQ0FBQzJCLEdBQVAsQ0FBVyxTQUFYLEVBQXVCLFFBQU9yQixHQUFHLENBQUNELElBQUssY0FBdkM7QUFHQUwsSUFBQUEsTUFBTSxDQUFDdUIsRUFBUCxDQUFVLFlBQVluQyxPQUFPLENBQUMrQyxLQUE5QixFQUFxQyxNQUFNO0FBQ3ZDbkMsTUFBQUEsTUFBTSxDQUFDb0MsUUFBUCxDQUFnQjlCLEdBQWhCO0FBQ0gsS0FGRDtBQUdILEdBeERnQztBQWRwQixDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKipcbiAqIEVuYWJsZSByb3V0aW5nIHdlYiByZXF1ZXN0cyB0byBhIGNoaWxkIGFwcC5cbiAqIEBtb2R1bGUgRmVhdHVyZV9BcHBSb3V0aW5nXG4gKiBcbiAqIEBleGFtcGxlXG4gKiAgXG4gKiAgJ2FwcFJvdXRpbmcnOiB7XG4gKiAgICAgICc8bW91bnRpbmcgcG9pbnQ+Jzoge1xuICogICAgICAgICAgbmFtZTogJ2FwcCBuYW1lJywgXG4gKiAgICAgICAgICBucG1Nb2R1bGU6IGZhbHNlLCAvLyB3aGV0aGVyIGlzIGEgbnBtIG1vZHVsZVxuICogICAgICAgICAgb3B0aW9uczogeyAvLyBtb2R1bGUgb3B0aW9ucyBcbiAqICAgICAgICAgIH0sXG4gKiAgICAgICAgICBzZXR0aW5nczogeyAvLyBjYW4gb3ZlcnJpZGUgbW9kdWxlIGRlZmluZWQgc2V0dGluZ3NcbiAqICAgICAgICAgIH0sXG4gKiAgICAgICAgICBtaWRkbGV3YXJlczogeyAvLyBjYW4gb3ZlcnJpZGUgbWlkZGxld2FyZXMgXG4gKiAgICAgICAgICB9XG4gKiAgICAgIH1cbiAqICB9IFxuICovXG5cbmNvbnN0IEZlYXR1cmUgPSByZXF1aXJlKCdAZ2VueC9hcHAvbGliL2VudW0vRmVhdHVyZScpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgUHJvbWlzZSA9IFV0aWwuUHJvbWlzZTtcbmNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24gfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0Vycm9ycycpO1xuY29uc3QgV2ViTW9kdWxlID0gcmVxdWlyZSgnLi4vV2ViTW9kdWxlJyk7XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuXG4gICAgLyoqXG4gICAgICogVGhpcyBmZWF0dXJlIGlzIGxvYWRlZCBhdCBwbHVnaW4gc3RhZ2UuXG4gICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAqL1xuICAgIHR5cGU6IEZlYXR1cmUuUExVR0lOLFxuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgZmVhdHVyZS5cbiAgICAgKiBAcGFyYW0ge1dlYlNlcnZlcn0gc2VydmVyIC0gVGhlIHdlYiBzZXJ2ZXIgbW9kdWxlIG9iamVjdC5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcm91dGVzIC0gUm91dGVzIGFuZCBjb25maWd1cmF0aW9uLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogYXN5bmMgKHNlcnZlciwgcm91dGVzKSA9PiBVdGlsLmVhY2hBc3luY18ocm91dGVzLCBhc3luYyAoY29uZmlnLCBiYXNlUm91dGUpID0+IHtcbiAgICAgICAgaWYgKCFjb25maWcubmFtZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICdNaXNzaW5nIGFwcCBuYW1lLicsXG4gICAgICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgICAgIGBhcHBSb3V0aW5nLiR7YmFzZVJvdXRlfS5uYW1lYCk7XG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgbGV0IG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHsgXG4gICAgICAgICAgICBlbnY6IHNlcnZlci5lbnYsIFxuICAgICAgICAgICAgbG9nV2l0aEFwcE5hbWU6IHNlcnZlci5vcHRpb25zLmxvZ1dpdGhBcHBOYW1lLFxuICAgICAgICAgICAgdHJhY2VNaWRkbGV3YXJlczogc2VydmVyLm9wdGlvbnMudHJhY2VNaWRkbGV3YXJlc1xuICAgICAgICB9LCBjb25maWcub3B0aW9ucyk7XG5cbiAgICAgICAgbGV0IGFwcFBhdGg7ICAgICBcblxuICAgICAgICBpZiAoY29uZmlnLm5wbU1vZHVsZSkge1xuICAgICAgICAgICAgYXBwUGF0aCA9IHNlcnZlci50b0Fic29sdXRlUGF0aCgnbm9kZV9tb2R1bGVzJywgY29uZmlnLm5hbWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYXBwUGF0aCA9IHBhdGguam9pbihzZXJ2ZXIuYXBwTW9kdWxlc1BhdGgsIGNvbmZpZy5uYW1lKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBleGlzdHMgPSBhd2FpdCBVdGlsLmZzLnBhdGhFeGlzdHMoYXBwUGF0aCkgJiYgKGF3YWl0IFV0aWwuZnMuc3RhdChhcHBQYXRoKSkuaXNEaXJlY3RvcnkoKTtcbiAgICAgICAgaWYgKCFleGlzdHMpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICBgQXBwIFske2NvbmZpZy5uYW1lfV0gbm90IGV4aXN0cy5gLFxuICAgICAgICAgICAgICAgIHNlcnZlcixcbiAgICAgICAgICAgICAgICBgYXBwUm91dGluZy4ke2Jhc2VSb3V0ZX0ubmFtZWApO1xuICAgICAgICB9XG4gICAgXG4gICAgICAgIGxldCBhcHAgPSBuZXcgV2ViTW9kdWxlKHNlcnZlciwgY29uZmlnLm5hbWUsIGJhc2VSb3V0ZSwgYXBwUGF0aCwgb3B0aW9ucyk7XG4gICAgICAgIFxuICAgICAgICBhcHAub24oJ2NvbmZpZ0xvYWRlZCcsICgpID0+IHtcbiAgICAgICAgICAgIGlmICghVXRpbC5fLmlzRW1wdHkoY29uZmlnLnNldHRpbmdzKSkge1xuICAgICAgICAgICAgICAgIGFwcC5jb25maWcuc2V0dGluZ3MgPSBPYmplY3QuYXNzaWduKHt9LCBhcHAuY29uZmlnLnNldHRpbmdzLCBjb25maWcuc2V0dGluZ3MpO1xuICAgICAgICAgICAgICAgIHNlcnZlci5sb2coJ3ZlcmJvc2UnLCBgQXBwIHNldHRpbmdzIG9mIFske2FwcC5uYW1lfV0gaXMgb3ZlcnJpZGVkLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIVV0aWwuXy5pc0VtcHR5KGNvbmZpZy5taWRkbGV3YXJlcykpIHtcbiAgICAgICAgICAgICAgICBsZXQgbWlkZGxld2FyZXNUb0FwcGVuZCA9IGFwcC5jb25maWcubWlkZGxld2FyZXM7XG4gICAgICAgICAgICAgICAgYXBwLmNvbmZpZy5taWRkbGV3YXJlcyA9IE9iamVjdC5hc3NpZ24oe30sIGNvbmZpZy5taWRkbGV3YXJlcyk7XG4gICAgICAgICAgICAgICAgVXRpbC5fLmRlZmF1bHRzKGFwcC5jb25maWcubWlkZGxld2FyZXMsIG1pZGRsZXdhcmVzVG9BcHBlbmQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgcmVsYXRpdmVQYXRoID0gcGF0aC5yZWxhdGl2ZShzZXJ2ZXIud29ya2luZ1BhdGgsIGFwcFBhdGgpO1xuICAgICAgICBzZXJ2ZXIubG9nKCd2ZXJib3NlJywgYExvYWRpbmcgYXBwIFske2FwcC5uYW1lfV0gZnJvbSBcIiR7cmVsYXRpdmVQYXRofVwiIC4uLmApO1xuICAgIFxuICAgICAgICBhd2FpdCBhcHAuc3RhcnRfKCk7XG4gICAgICAgIFxuICAgICAgICBzZXJ2ZXIubG9nKCd2ZXJib3NlJywgYEFwcCBbJHthcHAubmFtZX1dIGlzIGxvYWRlZC5gKTtcblxuICAgICAgICAvL2RlbGF5ZWQgdGhlIGFwcCByb3V0ZXMgbW91bnRpbmcgYWZ0ZXIgYWxsIHBsdWdpbnMgb2YgdGhlIHNlcnZlciBhcmUgbG9hZGVkXG4gICAgICAgIHNlcnZlci5vbignYmVmb3JlOicgKyBGZWF0dXJlLlJFQURZLCAoKSA9PiB7XG4gICAgICAgICAgICBzZXJ2ZXIubW91bnRBcHAoYXBwKTtcbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9KVxufTsiXX0=