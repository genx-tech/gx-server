"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const _ = Util._;

const Literal = require('../enum/Literal');

const Router = require('@koa/router');

const {
  hasMethod
} = require('../utils/Helpers');

const appendId = (baseEndpoint, idName) => idName ? `${baseEndpoint}/:${idName}` : baseEndpoint;

module.exports = (app, baseRoute, options) => {
  let resourcePath = path.resolve(app.backendPath, options.resourcesPath || Literal.RESOURCES_PATH);
  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(options.errorOptions, app), 'jsonError');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let resourcesPath = path.join(resourcePath, "*.js");
  let files = Util.glob.sync(resourcesPath, {
    nodir: true
  });

  _.each(files, file => {
    let entityName = path.basename(file, '.js');

    let controller = require(file);

    if (typeof controller === 'function') {
      controller = new controller(app);
    }

    let baseEndpoint;

    if (options.remaps && entityName in options.remaps) {
      baseEndpoint = Util.ensureLeftSlash(Util.trimRightSlash(options.remaps[entityName]));
    } else {
      baseEndpoint = Util.ensureLeftSlash(_.kebabCase(entityName));
    }

    let idName = _.camelCase(entityName) + 'Id';
    let endpointWithId = appendId(baseEndpoint, idName);

    if (hasMethod(controller, 'find')) {
      app.addRoute(router, 'get', baseEndpoint, ctx => controller.find(ctx));
    }

    if (hasMethod(controller, 'post')) {
      app.addRoute(router, 'post', baseEndpoint, ctx => controller.post(ctx));
    }

    if (hasMethod(controller, 'findById')) {
      app.addRoute(router, 'get', endpointWithId, ctx => controller.findById(ctx, ctx.params[idName]));
    }

    if (hasMethod(controller, 'updateById')) {
      app.addRoute(router, 'put', endpointWithId, ctx => controller.updateById(ctx, ctx.params[idName]));
    }

    if (hasMethod(controller, 'deleteById')) {
      app.addRoute(router, 'del', endpointWithId, ctx => controller.deleteById(ctx, ctx.params[idName]));
    }
  });

  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhbWwuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJVdGlsIiwiXyIsIkxpdGVyYWwiLCJSb3V0ZXIiLCJoYXNNZXRob2QiLCJhcHBlbmRJZCIsImJhc2VFbmRwb2ludCIsImlkTmFtZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJhcHAiLCJiYXNlUm91dGUiLCJvcHRpb25zIiwicmVzb3VyY2VQYXRoIiwicmVzb2x2ZSIsImJhY2tlbmRQYXRoIiwicmVzb3VyY2VzUGF0aCIsIlJFU09VUkNFU19QQVRIIiwicm91dGVyIiwicHJlZml4IiwidXNlTWlkZGxld2FyZSIsImdldE1pZGRsZXdhcmVGYWN0b3J5IiwiZXJyb3JPcHRpb25zIiwibWlkZGxld2FyZXMiLCJ1c2VNaWRkbGV3YXJlcyIsImpvaW4iLCJmaWxlcyIsImdsb2IiLCJzeW5jIiwibm9kaXIiLCJlYWNoIiwiZmlsZSIsImVudGl0eU5hbWUiLCJiYXNlbmFtZSIsImNvbnRyb2xsZXIiLCJyZW1hcHMiLCJlbnN1cmVMZWZ0U2xhc2giLCJ0cmltUmlnaHRTbGFzaCIsImtlYmFiQ2FzZSIsImNhbWVsQ2FzZSIsImVuZHBvaW50V2l0aElkIiwiYWRkUm91dGUiLCJjdHgiLCJmaW5kIiwicG9zdCIsImZpbmRCeUlkIiwicGFyYW1zIiwidXBkYXRlQnlJZCIsImRlbGV0ZUJ5SWQiLCJhZGRSb3V0ZXIiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU1FLENBQUMsR0FBR0QsSUFBSSxDQUFDQyxDQUFmOztBQUNBLE1BQU1DLE9BQU8sR0FBR0gsT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUNBLE1BQU1JLE1BQU0sR0FBR0osT0FBTyxDQUFDLGFBQUQsQ0FBdEI7O0FBQ0EsTUFBTTtBQUFFSyxFQUFBQTtB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J3BhdGgnKTtcbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgXyA9IFV0aWwuXztcbmNvbnN0IExpdGVyYWwgPSByZXF1aXJlKCcuLi9lbnVtL0xpdGVyYWwnKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJ0Brb2Evcm91dGVyJyk7XG5jb25zdCB7IGhhc01ldGhvZCB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvSGVscGVycycpO1xuXG4vKipcbiAqIEdhbWwgcm91dGVyLlxuICogQG1vZHVsZSBSb3V0ZXJfR2FtbFxuICovXG5cbmNvbnN0IGFwcGVuZElkID0gKGJhc2VFbmRwb2ludCwgaWROYW1lKSA9PiBpZE5hbWUgPyBgJHtiYXNlRW5kcG9pbnR9Lzoke2lkTmFtZX1gIDogYmFzZUVuZHBvaW50OyBcblxuLyoqXG4gKiBDcmVhdGUgYSBnYW1sIHJvdXRlci5cbiAqIEBwYXJhbSB7Kn0gYXBwIFxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2VSb3V0ZSBcbiAqIEBwYXJhbSB7b2JqZWN0c30gb3B0aW9ucyBcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5yZXNvdXJjZXNQYXRoXVxuICogQHByb3BlcnR5IHtvYmplY3R8YXJyYXl9IFtvcHRpb25zLm1pZGRsZXdhcmVzXVxuICogQGV4YW1wbGVcbiAqICAnPGJhc2UgcGF0aD4nOiB7XG4gKiAgICAgIGdhbWw6IHtcbiAqICAgICAgICAgIHJlc291cmNlc1BhdGg6XG4gKiAgICAgICAgICBtaWRkbGV3YXJlczpcbiAqICAgICAgfVxuICogIH1cbiAqICBcbiAqICByb3V0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cCBtZXRob2QgICAgZnVuY3Rpb24gb2YgY3RybFxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBmaW5kIFxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBwb3N0ICAgICAgICAgICBwb3N0XG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIGZpbmRCeUlkXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIHB1dCAgICAgICAgICAgIHVwZGF0ZUJ5SWRcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZGVsICAgICAgICAgICAgZGVsZXRlQnlJZFxuICovXG5tb2R1bGUuZXhwb3J0cyA9IChhcHAsIGJhc2VSb3V0ZSwgb3B0aW9ucykgPT4ge1xuICAgIGxldCByZXNvdXJjZVBhdGggPSBwYXRoLnJlc29sdmUoYXBwLmJhY2tlbmRQYXRoLCBvcHRpb25zLnJlc291cmNlc1BhdGggfHwgTGl0ZXJhbC5SRVNPVVJDRVNfUEFUSCk7XG4gICAgXG4gICAgbGV0IHJvdXRlciA9IGJhc2VSb3V0ZSA9PT0gJy8nID8gbmV3IFJvdXRlcigpIDogbmV3IFJvdXRlcih7cHJlZml4OiBiYXNlUm91dGV9KTtcblxuICAgIGFwcC51c2VNaWRkbGV3YXJlKHJvdXRlciwgYXBwLmdldE1pZGRsZXdhcmVGYWN0b3J5KCdqc29uRXJyb3InKShvcHRpb25zLmVycm9yT3B0aW9ucywgYXBwKSwgJ2pzb25FcnJvcicpO1xuXG4gICAgaWYgKG9wdGlvbnMubWlkZGxld2FyZXMpIHtcbiAgICAgICAgYXBwLnVzZU1pZGRsZXdhcmVzKHJvdXRlciwgb3B0aW9ucy5taWRkbGV3YXJlcyk7XG4gICAgfVxuXG4gICAgbGV0IHJlc291cmNlc1BhdGggPSBwYXRoLmpvaW4ocmVzb3VyY2VQYXRoLCBcIiouanNcIik7XG4gICAgbGV0IGZpbGVzID0gVXRpbC5nbG9iLnN5bmMocmVzb3VyY2VzUGF0aCwge25vZGlyOiB0cnVlfSk7XG5cbiAgICAvKlxuICAgIGlmIChvcHRpb25zLmJhdGNoUXVlcnkpIHtcbiAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3Bvc3QnLCBvcHRpb25zLmJhdGNoUXVlcnksIGJhdGNoUXVlcnlfKTtcbiAgICB9Ki9cblxuICAgIF8uZWFjaChmaWxlcywgZmlsZSA9PiB7XG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gcGF0aC5iYXNlbmFtZShmaWxlLCAnLmpzJyk7XG4gICAgICAgIGxldCBjb250cm9sbGVyID0gcmVxdWlyZShmaWxlKTtcblxuICAgICAgICBpZiAodHlwZW9mIGNvbnRyb2xsZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBuZXcgY29udHJvbGxlcihhcHApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGJhc2VFbmRwb2ludDtcblxuICAgICAgICBpZiAob3B0aW9ucy5yZW1hcHMgJiYgZW50aXR5TmFtZSBpbiBvcHRpb25zLnJlbWFwcykge1xuICAgICAgICAgICAgYmFzZUVuZHBvaW50ID0gVXRpbC5lbnN1cmVMZWZ0U2xhc2goVXRpbC50cmltUmlnaHRTbGFzaChvcHRpb25zLnJlbWFwc1tlbnRpdHlOYW1lXSkpOyAgICAgICAgICAgICAgICBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGJhc2VFbmRwb2ludCA9IFV0aWwuZW5zdXJlTGVmdFNsYXNoKF8ua2ViYWJDYXNlKGVudGl0eU5hbWUpKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgbGV0IGlkTmFtZSA9IF8uY2FtZWxDYXNlKGVudGl0eU5hbWUpICsgJ0lkJztcbiAgICAgICAgbGV0IGVuZHBvaW50V2l0aElkID0gYXBwZW5kSWQoYmFzZUVuZHBvaW50LCBpZE5hbWUpOyAgICAgICAgXG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAnZmluZCcpKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgYmFzZUVuZHBvaW50LCAoY3R4KSA9PiBjb250cm9sbGVyLmZpbmQoY3R4KSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdwb3N0JykpIHtcbiAgICAgICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwb3N0JywgYmFzZUVuZHBvaW50LCAoY3R4KSA9PiBjb250cm9sbGVyLnBvc3QoY3R4KSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdmaW5kQnlJZCcpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgZW5kcG9pbnRXaXRoSWQsIChjdHgpID0+IGNvbnRyb2xsZXIuZmluZEJ5SWQoY3R4LCBjdHgucGFyYW1zW2lkTmFtZV0pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ3VwZGF0ZUJ5SWQnKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3B1dCcsIGVuZHBvaW50V2l0aElkLCAoY3R4KSA9PiBjb250cm9sbGVyLnVwZGF0ZUJ5SWQoY3R4LCBjdHgucGFyYW1zW2lkTmFtZV0pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ2RlbGV0ZUJ5SWQnKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2RlbCcsIGVuZHBvaW50V2l0aElkLCAoY3R4KSA9PiBjb250cm9sbGVyLmRlbGV0ZUJ5SWQoY3R4LCBjdHgucGFyYW1zW2lkTmFtZV0pKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgYXBwLmFkZFJvdXRlcihyb3V0ZXIpO1xufTsiXX0=