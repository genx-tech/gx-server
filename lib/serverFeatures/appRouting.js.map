{"version":3,"file":"appRouting.js","names":["path","require","_","eachAsync_","fs","InvalidConfiguration","WebModule","Feature","module","exports","type","PLUGIN","load_","server","routes","config","baseRoute","name","app","options","Object","assign","env","logWithAppName","traceMiddlewares","appPath","npmModule","toAbsolutePath","join","appModulesPath","exists","pathExists","stat","isDirectory","now","__","on","isEmpty","overrides","log","settings","middlewares","middlewaresToAppend","defaults","relativePath","relative","workingPath","start_","READY","mountApp"],"sources":["../../src/serverFeatures/appRouting.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Enable routing web requests to a child app.\n * @module Feature_AppRouting\n * \n * @example\n *  \n *  'appRouting': {\n *      '<mounting point>': {\n *          name: 'app name', \n *          npmModule: false, // whether is a npm module\n *          options: { // module options \n *          },\n *          settings: { // can override module defined settings\n *          },\n *          middlewares: { // can override middlewares \n *          }\n *      }\n *  } \n */\n\nconst path = require('path');\nconst { _, eachAsync_ } = require('@genx/july');\nconst { fs } = require('@genx/sys');\nconst { InvalidConfiguration } = require('@genx/error');\nconst WebModule = require('../WebModule');\nconst Feature = require('@genx/app/lib/enum/Feature');\n\nmodule.exports = {\n\n    /**\n     * This feature is loaded at plugin stage.\n     * @member {string}\n     */\n    type: Feature.PLUGIN,\n\n    /**\n     * Load the feature.\n     * @param {WebServer} server - The web server module object.\n     * @param {object} routes - Routes and configuration.\n     * @returns {Promise.<*>}\n     */\n    load_: async (server, routes) => eachAsync_(routes, async (config, baseRoute) => {\n        if (!config.name) {\n            throw new InvalidConfiguration(\n                'Missing app name.',\n                app,\n                `appRouting.${baseRoute}.name`);\n        }\n    \n        let options = Object.assign({ \n            env: server.env, \n            logWithAppName: server.options.logWithAppName,\n            traceMiddlewares: server.options.traceMiddlewares\n        }, config.options);\n\n        let appPath;     \n\n        if (config.npmModule) {\n            appPath = server.toAbsolutePath('node_modules', config.name);\n        } else {\n            appPath = path.join(server.appModulesPath, config.name);\n        }\n\n        let exists = await fs.pathExists(appPath) && (await fs.stat(appPath)).isDirectory();\n        if (!exists) {\n            throw new InvalidConfiguration(\n                `App [${config.name}] not found at ${appPath}`,\n                server,\n                `appRouting.${baseRoute}.name`);\n        }\n    \n        let app = new WebModule(server, config.name, baseRoute, appPath, options);\n        app.now = server.now;\n        app.__ = server.__;\n        \n        app.on('configLoaded', () => {\n            if (!_.isEmpty(config.overrides)) {\n                Object.assign(app.config, config.overrides);\n                server.log('verbose', \"App config is overrided.\");\n            }\n\n            if (!_.isEmpty(config.settings)) {\n                app.config.settings = Object.assign({}, app.config.settings, config.settings);\n                server.log('verbose', `App settings of [${app.name}] is overrided.`);\n            }\n\n            if (!_.isEmpty(config.middlewares)) {\n                let middlewaresToAppend = app.config.middlewares;\n                app.config.middlewares = { ...config.middlewares };\n                _.defaults(app.config.middlewares, middlewaresToAppend);\n            }\n        });\n\n        let relativePath = path.relative(server.workingPath, appPath);\n        server.log('verbose', `Loading app [${app.name}] from \"${relativePath}\" ...`);\n    \n        await app.start_();\n        \n        server.log('verbose', `App [${app.name}] is loaded.`);\n\n        //delayed the app routes mounting after all plugins of the server are loaded\n        server.on('before:' + Feature.READY, () => {\n            server.mountApp(app);\n        });        \n    })\n};"],"mappings":"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"}