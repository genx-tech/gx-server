{"version":3,"file":"favicon.js","names":["require","_","fs","path","HttpCode","InvalidConfiguration","favicon","options","app","isString","faviconPath","toAbsolutePath","join","publicPath","existsSync","icon","maxAge","Math","min","max","cacheControl","ctx","next","method","stats","stat","size","log","throw","NOT_FOUND","readFile","set","type","body","module","exports"],"sources":["../../src/middlewares/favicon.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Middleware to serve favicon request.\n * @module Middleware_Favicon\n */\n\nconst { _ } = require('@genx/july');\nconst { fs } = require('@genx/sys');\nconst path = require('path');\nconst { HttpCode, InvalidConfiguration } = require('@genx/error');\n\nlet favicon = (options, app) => {\n    if (_.isString(options)) {\n        options = { path: options };\n    } \n    \n    let faviconPath = options && options.path && app.toAbsolutePath(options.path) || path.join(app.publicPath, 'favicon.ico');\n    if (!fs.existsSync(faviconPath)) {\n        throw new InvalidConfiguration(\n            `Favicon path \"${faviconPath}\" not exists.`,\n            app,\n            'middlewares.favicon'\n        );\n    }   \n\n    let icon;\n    const maxAge = options.maxAge == null\n        ? 86400000\n        : Math.min(Math.max(0, options.maxAge), 31556926000);\n    const cacheControl = `public, max-age=${maxAge / 1000 | 0}`;\n\n    return async (ctx, next) => {\n        if ('/favicon.ico' !== ctx.path || ('GET' !== ctx.method && 'HEAD' !== ctx.method)) {\n            return next();\n        }\n\n        if (!icon) {\n            let stats = await fs.stat(faviconPath);\n            //maximum 1M\n            if (stats.size > 1048576) {\n                app.log('warn', 'favicon.ico too large.', stats);\n                ctx.throw(HttpCode.NOT_FOUND);                \n            }\n            \n            icon = await fs.readFile(faviconPath);\n        }\n        ctx.set('Cache-Control', cacheControl);\n        ctx.type = 'image/x-icon';\n        ctx.body = icon;\n    };\n};\n\nmodule.exports = favicon;"],"mappings":"AAAA,YAAY;AAACA,OAAA;AAOb,MAAM;EAAEC;AAAE,CAAC,GAAGD,OAAO,CAAC,YAAY,CAAC;AACnC,MAAM;EAAEE;AAAG,CAAC,GAAGF,OAAO,CAAC,WAAW,CAAC;AACnC,MAAMG,IAAI,GAAGH,OAAO,CAAC,MAAM,CAAC;AAC5B,MAAM;EAAEI,QAAQ;EAAEC;AAAqB,CAAC,GAAGL,OAAO,CAAC,aAAa,CAAC;AAEjE,IAAIM,OAAO,GAAGA,CAACC,OAAO,EAAEC,GAAG,KAAK;EAC5B,IAAIP,CAAC,CAACQ,QAAQ,CAACF,OAAO,CAAC,EAAE;IACrBA,OAAO,GAAG;MAAEJ,IAAI,EAAEI;IAAQ,CAAC;EAC/B;EAEA,IAAIG,WAAW,GAAGH,OAAO,IAAIA,OAAO,CAACJ,IAAI,IAAIK,GAAG,CAACG,cAAc,CAACJ,OAAO,CAACJ,IAAI,CAAC,IAAIA,IAAI,CAACS,IAAI,CAACJ,GAAG,CAACK,UAAU,EAAE,aAAa,CAAC;EACzH,IAAI,CAACX,EAAE,CAACY,UAAU,CAACJ,WAAW,CAAC,EAAE;IAC7B,MAAM,IAAIL,oBAAoB,CACzB,iBAAgBK,WAAY,eAAc,EAC3CF,GAAG,EACH,qBACJ,CAAC;EACL;EAEA,IAAIO,IAAI;EACR,MAAMC,MAAM,GAAGT,OAAO,CAACS,MAAM,IAAI,IAAI,GAC/B,QAAQ,GACRC,IAAI,CAACC,GAAG,CAACD,IAAI,CAACE,GAAG,CAAC,CAAC,EAAEZ,OAAO,CAACS,MAAM,CAAC,EAAE,WAAW,CAAC;EACxD,MAAMI,YAAY,GAAI,mBAAkBJ,MAAM,GAAG,IAAI,GAAG,CAAE,EAAC;EAE3D,OAAO,OAAOK,GAAG,EAAEC,IAAI,KAAK;IACxB,IAAI,cAAc,KAAKD,GAAG,CAAClB,IAAI,IAAK,KAAK,KAAKkB,GAAG,CAACE,MAAM,IAAI,MAAM,KAAKF,GAAG,CAACE,MAAO,EAAE;MAChF,OAAOD,IAAI,CAAC,CAAC;IACjB;IAEA,IAAI,CAACP,IAAI,EAAE;MACP,IAAIS,KAAK,GAAG,MAAMtB,EAAE,CAACuB,IAAI,CAACf,WAAW,CAAC;MAEtC,IAAIc,KAAK,CAACE,IAAI,GAAG,OAAO,EAAE;QACtBlB,GAAG,CAACmB,GAAG,CAAC,MAAM,EAAE,wBAAwB,EAAEH,KAAK,CAAC;QAChDH,GAAG,CAACO,KAAK,CAACxB,QAAQ,CAACyB,SAAS,CAAC;MACjC;MAEAd,IAAI,GAAG,MAAMb,EAAE,CAAC4B,QAAQ,CAACpB,WAAW,CAAC;IACzC;IACAW,GAAG,CAACU,GAAG,CAAC,eAAe,EAAEX,YAAY,CAAC;IACtCC,GAAG,CAACW,IAAI,GAAG,cAAc;IACzBX,GAAG,CAACY,IAAI,GAAGlB,IAAI;EACnB,CAAC;AACL,CAAC;AAEDmB,MAAM,CAACC,OAAO,GAAG7B,OAAO"}