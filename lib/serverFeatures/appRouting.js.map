{"version":3,"file":"appRouting.js","names":["require","path","_","eachAsync_","fs","InvalidConfiguration","WebModule","Feature","module","exports","type","PLUGIN","load_","server","routes","config","baseRoute","name","app","options","Object","assign","env","logWithAppName","traceMiddlewares","appPath","npmModule","toAbsolutePath","join","appModulesPath","exists","pathExists","stat","isDirectory","now","__","on","isEmpty","overrides","log","settings","middlewares","middlewaresToAppend","defaults","relativePath","relative","workingPath","start_","READY","mountApp"],"sources":["../../src/serverFeatures/appRouting.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Enable routing web requests to a child app.\n * @module Feature_AppRouting\n * \n * @example\n *  \n *  'appRouting': {\n *      '<mounting point>': {\n *          name: 'app name', \n *          npmModule: false, // whether is a npm module\n *          options: { // module options \n *          },\n *          settings: { // can override module defined settings\n *          },\n *          middlewares: { // can override middlewares \n *          }\n *      }\n *  } \n */\n\nconst path = require('path');\nconst { _, eachAsync_ } = require('@genx/july');\nconst { fs } = require('@genx/sys');\nconst { InvalidConfiguration } = require('@genx/error');\nconst WebModule = require('../WebModule');\nconst { Feature } = require('@genx/app');\n\nmodule.exports = {\n\n    /**\n     * This feature is loaded at plugin stage.\n     * @member {string}\n     */\n    type: Feature.PLUGIN,\n\n    /**\n     * Load the feature.\n     * @param {WebServer} server - The web server module object.\n     * @param {object} routes - Routes and configuration.\n     * @returns {Promise.<*>}\n     */\n    load_: async (server, routes) => eachAsync_(routes, async (config, baseRoute) => {\n        if (!config.name) {\n            throw new InvalidConfiguration(\n                'Missing app name.',\n                app,\n                `appRouting.${baseRoute}.name`);\n        }\n    \n        let options = Object.assign({ \n            env: server.env, \n            logWithAppName: server.options.logWithAppName,\n            traceMiddlewares: server.options.traceMiddlewares\n        }, config.options);\n\n        let appPath;     \n\n        if (config.npmModule) {\n            appPath = server.toAbsolutePath('node_modules', config.name);\n        } else {\n            appPath = path.join(server.appModulesPath, config.name);\n        }\n\n        let exists = await fs.pathExists(appPath) && (await fs.stat(appPath)).isDirectory();\n        if (!exists) {\n            throw new InvalidConfiguration(\n                `App [${config.name}] not found at ${appPath}`,\n                server,\n                `appRouting.${baseRoute}.name`);\n        }\n    \n        let app = new WebModule(server, config.name, baseRoute, appPath, options);\n        app.now = server.now;\n        app.__ = server.__;\n        \n        app.on('configLoaded', () => {\n            if (!_.isEmpty(config.overrides)) {\n                Object.assign(app.config, config.overrides);\n                server.log('verbose', \"App config is overrided.\");\n            }\n\n            if (!_.isEmpty(config.settings)) {\n                app.config.settings = Object.assign({}, app.config.settings, config.settings);\n                server.log('verbose', `App settings of [${app.name}] is overrided.`);\n            }\n\n            if (!_.isEmpty(config.middlewares)) {\n                let middlewaresToAppend = app.config.middlewares;\n                app.config.middlewares = { ...config.middlewares };\n                _.defaults(app.config.middlewares, middlewaresToAppend);\n            }\n        });\n\n        let relativePath = path.relative(server.workingPath, appPath);\n        server.log('verbose', `Loading app [${app.name}] from \"${relativePath}\" ...`);\n    \n        await app.start_();\n        \n        server.log('verbose', `App [${app.name}] is loaded.`);\n\n        //delayed the app routes mounting after all plugins of the server are loaded\n        server.on('before:' + Feature.READY, () => {\n            server.mountApp(app);\n        });        \n    })\n};"],"mappings":"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"}