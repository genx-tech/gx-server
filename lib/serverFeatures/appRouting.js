"use strict";

require("source-map-support/register");

const Feature = require('@genx/app/lib/enum/Feature');

const path = require('path');

const Util = require('rk-utils');

const Promise = Util.Promise;

const {
  InvalidConfiguration
} = require('../utils/Errors');

const WebModule = require('../WebModule');

module.exports = {
  type: Feature.PLUGIN,
  load_: async (server, routes) => Util.eachAsync_(routes, async (config, baseRoute) => {
    if (!config.name) {
      throw new InvalidConfiguration('Missing app name.', app, `appRouting.${baseRoute}.name`);
    }

    let options = Object.assign({
      env: server.env,
      logWithAppName: server.options.logWithAppName,
      traceMiddlewares: server.options.traceMiddlewares
    }, config.options);
    let appPath;

    if (config.npmModule) {
      appPath = server.toAbsolutePath('node_modules', config.name);
    } else {
      appPath = path.join(server.appModulesPath, config.name);
    }

    let exists = (await Util.fs.pathExists(appPath)) && (await Util.fs.stat(appPath)).isDirectory();

    if (!exists) {
      throw new InvalidConfiguration(`App [${config.name}] not exists.`, server, `appRouting.${baseRoute}.name`);
    }

    let app = new WebModule(server, config.name, baseRoute, appPath, options);
    app.now = server.now;
    app.__ = server.__;
    app.on('configLoaded', () => {
      if (!Util._.isEmpty(config.settings)) {
        app.config.settings = Object.assign({}, app.config.settings, config.settings);
        server.log('verbose', `App settings of [${app.name}] is overrided.`);
      }

      if (!Util._.isEmpty(config.middlewares)) {
        let middlewaresToAppend = app.config.middlewares;
        app.config.middlewares = Object.assign({}, config.middlewares);

        Util._.defaults(app.config.middlewares, middlewaresToAppend);
      }
    });
    let relativePath = path.relative(server.workingPath, appPath);
    server.log('verbose', `Loading app [${app.name}] from "${relativePath}" ...`);
    await app.start_();
    server.log('verbose', `App [${app.name}] is loaded.`);
    server.on('before:' + Feature.READY, () => {
      server.mountApp(app);
    });
  })
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXJGZWF0dXJlcy9hcHBSb3V0aW5nLmpzIl0sIm5hbWVzIjpbIkZlYXR1cmUiLCJyZXF1aXJlIiwicGF0aCIsIlV0aWwiLCJQcm9taXNlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJXZWJNb2R1bGUiLCJtb2R1bGUiLCJleHBvcnRzIiwidHlwZSIsIlBMVUdJTiIsImxvYWRfIiwic2VydmVyIiwicm91dGVzIiwiZWFjaEFzeW5jXyIsImNvbmZpZyIsImJhc2VSb3V0ZSIsIm5hbWUiLCJhcHAiLCJvcHRpb25zIiwiT2JqZWN0IiwiYXNzaWduIiwiZW52IiwibG9nV2l0aEFwcE5hbWUiLCJ0cmFjZU1pZGRsZXdhcmVzIiwiYXBwUGF0aCIsIm5wbU1vZHVsZSIsInRvQWJzb2x1dGVQYXRoIiwiam9pbiIsImFwcE1vZHVsZXNQYXRoIiwiZXhpc3RzIiwiZnMiLCJwYXRoRXhpc3RzIiwic3RhdCIsImlzRGlyZWN0b3J5Iiwibm93IiwiX18iLCJvbiIsIl8iLCJpc0VtcHR5Iiwic2V0dGluZ3MiLCJsb2ciLCJtaWRkbGV3YXJlcyIsIm1pZGRsZXdhcmVzVG9BcHBlbmQiLCJkZWZhdWx0cyIsInJlbGF0aXZlUGF0aCIsInJlbGF0aXZlIiwid29ya2luZ1BhdGgiLCJzdGFydF8iLCJSRUFEWSIsIm1vdW50QXBwIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQXNCQSxNQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyw0QkFBRCxDQUF2Qjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1FLElBQUksR0FBR0YsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTUcsT0FBTyxHQUFHRCxJQUFJLENBQUNDLE9BQXJCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUEyQkosT0FBTyxDQUFDLGlCQUFELENBQXhDOztBQUNBLE1BQU1LLFNBQVMsR0FBR0wsT0FBTyxDQUFDLGNBQUQsQ0FBekI7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QVgsR0FBeUJ0QixNQUFNLENBQUNDLE1BQVAsQ0FBYyxFQUFkLEVBQWtCTixNQUFNLENBQUMyQixXQUF6QixDQUF6Qjs7QUFDQXZDLFFBQUFBLElBQUksQ0FBQ21DLENBQUwsQ0FBT00sUUFBUCxDQUFnQjFCLEdBQUcsQ0FBQ0gsTUFBSixDQUFXMkIsV0FBM0IsRUFBd0NDLG1CQUF4QztBQUNIO0FBQ0osS0FYRDtBQWFBLFFBQUlFLFlBQVksR0FBRzNDLElBQUksQ0FBQzRDLFFBQUwsQ0FBY2xDLE1BQU0sQ0FBQ21DLFdBQXJCLEVBQWtDdEIsT0FBbEMsQ0FBbkI7QUFDQWIsSUFBQUEsTUFBTSxDQUFDNkIsR0FBUCxDQUFXLFNBQVgsRUFBdUIsZ0JBQWV2QixHQUFHLENBQUNELElBQUssV0FBVTRCLFlBQWEsT0FBdEU7QUFFQSxVQUFNM0IsR0FBRyxDQUFDOEIsTUFBSixFQUFOO0FBRUFwQyxJQUFBQSxNQUFNLENBQUM2QixHQUFQLENBQVcsU0FBWCxFQUF1QixRQUFPdkIsR0FBRyxDQUFDRCxJQUFLLGNBQXZDO0FBR0FMLElBQUFBLE1BQU0sQ0FBQ3lCLEVBQVAsQ0FBVSxZQUFZckMsT0FBTyxDQUFDaUQsS0FBOUIsRUFBcUMsTUFBTTtBQUN2Q3JDLE1BQUFBLE1BQU0sQ0FBQ3NDLFFBQVAsQ0FBZ0JoQyxHQUFoQjtBQUNILEtBRkQ7QUFHSCxHQTFEZ0M7QUFkcEIsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuLyoqXG4gKiBFbmFibGUgcm91dGluZyB3ZWIgcmVxdWVzdHMgdG8gYSBjaGlsZCBhcHAuXG4gKiBAbW9kdWxlIEZlYXR1cmVfQXBwUm91dGluZ1xuICogXG4gKiBAZXhhbXBsZVxuICogIFxuICogICdhcHBSb3V0aW5nJzoge1xuICogICAgICAnPG1vdW50aW5nIHBvaW50Pic6IHtcbiAqICAgICAgICAgIG5hbWU6ICdhcHAgbmFtZScsIFxuICogICAgICAgICAgbnBtTW9kdWxlOiBmYWxzZSwgLy8gd2hldGhlciBpcyBhIG5wbSBtb2R1bGVcbiAqICAgICAgICAgIG9wdGlvbnM6IHsgLy8gbW9kdWxlIG9wdGlvbnMgXG4gKiAgICAgICAgICB9LFxuICogICAgICAgICAgc2V0dGluZ3M6IHsgLy8gY2FuIG92ZXJyaWRlIG1vZHVsZSBkZWZpbmVkIHNldHRpbmdzXG4gKiAgICAgICAgICB9LFxuICogICAgICAgICAgbWlkZGxld2FyZXM6IHsgLy8gY2FuIG92ZXJyaWRlIG1pZGRsZXdhcmVzIFxuICogICAgICAgICAgfVxuICogICAgICB9XG4gKiAgfSBcbiAqL1xuXG5jb25zdCBGZWF0dXJlID0gcmVxdWlyZSgnQGdlbngvYXBwL2xpYi9lbnVtL0ZlYXR1cmUnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IFByb21pc2UgPSBVdGlsLlByb21pc2U7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uIH0gPSByZXF1aXJlKCcuLi91dGlscy9FcnJvcnMnKTtcbmNvbnN0IFdlYk1vZHVsZSA9IHJlcXVpcmUoJy4uL1dlYk1vZHVsZScpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblxuICAgIC8qKlxuICAgICAqIFRoaXMgZmVhdHVyZSBpcyBsb2FkZWQgYXQgcGx1Z2luIHN0YWdlLlxuICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgKi9cbiAgICB0eXBlOiBGZWF0dXJlLlBMVUdJTixcblxuICAgIC8qKlxuICAgICAqIExvYWQgdGhlIGZlYXR1cmUuXG4gICAgICogQHBhcmFtIHtXZWJTZXJ2ZXJ9IHNlcnZlciAtIFRoZSB3ZWIgc2VydmVyIG1vZHVsZSBvYmplY3QuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJvdXRlcyAtIFJvdXRlcyBhbmQgY29uZmlndXJhdGlvbi5cbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48Kj59XG4gICAgICovXG4gICAgbG9hZF86IGFzeW5jIChzZXJ2ZXIsIHJvdXRlcykgPT4gVXRpbC5lYWNoQXN5bmNfKHJvdXRlcywgYXN5bmMgKGNvbmZpZywgYmFzZVJvdXRlKSA9PiB7XG4gICAgICAgIGlmICghY29uZmlnLm5hbWUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICAnTWlzc2luZyBhcHAgbmFtZS4nLFxuICAgICAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgICAgICBgYXBwUm91dGluZy4ke2Jhc2VSb3V0ZX0ubmFtZWApO1xuICAgICAgICB9XG4gICAgXG4gICAgICAgIGxldCBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7IFxuICAgICAgICAgICAgZW52OiBzZXJ2ZXIuZW52LCBcbiAgICAgICAgICAgIGxvZ1dpdGhBcHBOYW1lOiBzZXJ2ZXIub3B0aW9ucy5sb2dXaXRoQXBwTmFtZSxcbiAgICAgICAgICAgIHRyYWNlTWlkZGxld2FyZXM6IHNlcnZlci5vcHRpb25zLnRyYWNlTWlkZGxld2FyZXNcbiAgICAgICAgfSwgY29uZmlnLm9wdGlvbnMpO1xuXG4gICAgICAgIGxldCBhcHBQYXRoOyAgICAgXG5cbiAgICAgICAgaWYgKGNvbmZpZy5ucG1Nb2R1bGUpIHtcbiAgICAgICAgICAgIGFwcFBhdGggPSBzZXJ2ZXIudG9BYnNvbHV0ZVBhdGgoJ25vZGVfbW9kdWxlcycsIGNvbmZpZy5uYW1lKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFwcFBhdGggPSBwYXRoLmpvaW4oc2VydmVyLmFwcE1vZHVsZXNQYXRoLCBjb25maWcubmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZXhpc3RzID0gYXdhaXQgVXRpbC5mcy5wYXRoRXhpc3RzKGFwcFBhdGgpICYmIChhd2FpdCBVdGlsLmZzLnN0YXQoYXBwUGF0aCkpLmlzRGlyZWN0b3J5KCk7XG4gICAgICAgIGlmICghZXhpc3RzKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgYEFwcCBbJHtjb25maWcubmFtZX1dIG5vdCBleGlzdHMuYCxcbiAgICAgICAgICAgICAgICBzZXJ2ZXIsXG4gICAgICAgICAgICAgICAgYGFwcFJvdXRpbmcuJHtiYXNlUm91dGV9Lm5hbWVgKTtcbiAgICAgICAgfVxuICAgIFxuICAgICAgICBsZXQgYXBwID0gbmV3IFdlYk1vZHVsZShzZXJ2ZXIsIGNvbmZpZy5uYW1lLCBiYXNlUm91dGUsIGFwcFBhdGgsIG9wdGlvbnMpO1xuICAgICAgICBhcHAubm93ID0gc2VydmVyLm5vdztcbiAgICAgICAgYXBwLl9fID0gc2VydmVyLl9fO1xuICAgICAgICBcbiAgICAgICAgYXBwLm9uKCdjb25maWdMb2FkZWQnLCAoKSA9PiB7XG4gICAgICAgICAgICBpZiAoIVV0aWwuXy5pc0VtcHR5KGNvbmZpZy5zZXR0aW5ncykpIHtcbiAgICAgICAgICAgICAgICBhcHAuY29uZmlnLnNldHRpbmdzID0gT2JqZWN0LmFzc2lnbih7fSwgYXBwLmNvbmZpZy5zZXR0aW5ncywgY29uZmlnLnNldHRpbmdzKTtcbiAgICAgICAgICAgICAgICBzZXJ2ZXIubG9nKCd2ZXJib3NlJywgYEFwcCBzZXR0aW5ncyBvZiBbJHthcHAubmFtZX1dIGlzIG92ZXJyaWRlZC5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFVdGlsLl8uaXNFbXB0eShjb25maWcubWlkZGxld2FyZXMpKSB7XG4gICAgICAgICAgICAgICAgbGV0IG1pZGRsZXdhcmVzVG9BcHBlbmQgPSBhcHAuY29uZmlnLm1pZGRsZXdhcmVzO1xuICAgICAgICAgICAgICAgIGFwcC5jb25maWcubWlkZGxld2FyZXMgPSBPYmplY3QuYXNzaWduKHt9LCBjb25maWcubWlkZGxld2FyZXMpO1xuICAgICAgICAgICAgICAgIFV0aWwuXy5kZWZhdWx0cyhhcHAuY29uZmlnLm1pZGRsZXdhcmVzLCBtaWRkbGV3YXJlc1RvQXBwZW5kKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IHJlbGF0aXZlUGF0aCA9IHBhdGgucmVsYXRpdmUoc2VydmVyLndvcmtpbmdQYXRoLCBhcHBQYXRoKTtcbiAgICAgICAgc2VydmVyLmxvZygndmVyYm9zZScsIGBMb2FkaW5nIGFwcCBbJHthcHAubmFtZX1dIGZyb20gXCIke3JlbGF0aXZlUGF0aH1cIiAuLi5gKTtcbiAgICBcbiAgICAgICAgYXdhaXQgYXBwLnN0YXJ0XygpO1xuICAgICAgICBcbiAgICAgICAgc2VydmVyLmxvZygndmVyYm9zZScsIGBBcHAgWyR7YXBwLm5hbWV9XSBpcyBsb2FkZWQuYCk7XG5cbiAgICAgICAgLy9kZWxheWVkIHRoZSBhcHAgcm91dGVzIG1vdW50aW5nIGFmdGVyIGFsbCBwbHVnaW5zIG9mIHRoZSBzZXJ2ZXIgYXJlIGxvYWRlZFxuICAgICAgICBzZXJ2ZXIub24oJ2JlZm9yZTonICsgRmVhdHVyZS5SRUFEWSwgKCkgPT4ge1xuICAgICAgICAgICAgc2VydmVyLm1vdW50QXBwKGFwcCk7XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfSlcbn07Il19