{"version":3,"sources":["../../src/middlewares/markdown.js"],"names":["path","require","fs","_","text","cachePages","cacheLayout","defaultOpts","cache","titleHolder","bodyHolder","indexName","baseUrl","module","exports","options","app","assert","root","defaults","ensureEndsWith","dropIfStartsWith","layout","join","render","md","tryRequire","mdOptions","content","defaultLayout","ctx","next","method","pathname","startsWith","substr","length","html","getPage","type","body","filepath","r","Promise","all","getLayout","getContent","err","code","replaceAll","title","exists","readFile","slice","indexOf","trim","replace"],"mappings":"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","sourcesContent":["const path = require(\"path\");\nconst { fs } = require(\"@genx/sys\");\nconst { _, text } = require(\"@genx/july\");\n\n/**\n * Markdown middleware.\n * @module Middleware_Markdown\n */\n\nconst cachePages = {};\nlet cacheLayout;\n\nconst defaultOpts = {\n    cache: false,\n    titleHolder: \"{{TITLE}}\",\n    bodyHolder: \"{{BODY}}\",\n    indexName: \"index\",\n    baseUrl: \"/\",\n};\n\nmodule.exports = function (options, app) {\n    assert: options && options.root, \"options.root required\";\n\n    _.defaults(options, defaultOpts);\n\n    options.baseUrl = text.ensureEndsWith(text.dropIfStartsWith(options.baseUrl, '/'), '/');\n    options.layout = options.layout || path.join(options.root, \"layout.html\");\n\n    // support custom markdown render\n    if (typeof options.render !== \"function\") {\n        let md = app.tryRequire(\"markdown-it\")(options.mdOptions);\n        options.render = (content) => md.render(content);\n    }\n\n    const defaultLayout = `\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>{{TITLE}}</title>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <!-- Bootstrap -->\n    <link href=\"https://cdn.staticfile.org/twitter-bootstrap/3.0.0-rc1/css/bootstrap.min.css\" rel=\"stylesheet\" media=\"screen\">\n  </head>\n  <body>\n    <div class=\"container\">\n    {{BODY}}\n    </div>\n    <!-- JavaScript plugins (requires jQuery) -->\n    <script src=\"https://cdn.staticfile.org/jquery/2.0.3/jquery.min.js\"></script>\n    <!-- Include all compiled plugins (below), or include individual files as needed -->\n    <script src=\"https://cdn.staticfile.org/twitter-bootstrap/3.0.0-rc1/js/bootstrap.min.js\"></script>\n\n    <!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->\n    <script src=\"https://cdn.staticfile.org/respond.js/1.2.0/respond.min.js\"></script>\n  </body>\n</html>\n`;\n\n    return async (ctx, next) => {\n        if (ctx.method !== \"GET\") {\n            return next();\n        }\n\n        let pathname = text.dropIfStartsWith(ctx.path, '/');\n        // get md file path\n\n        // index file\n        if (pathname + \"/\" === options.baseUrl || pathname === options.baseUrl) {\n            pathname = options.baseUrl + options.indexName;\n        } else if (!pathname.startsWith(options.baseUrl)) {\n            return next();\n        }\n\n        pathname = pathname.substr(options.baseUrl.length);\n        pathname = path.join(options.root, pathname + \".md\");\n\n        // generate html\n        let html = await getPage(pathname);\n        if (html === null) {\n            return next();\n        }\n        ctx.type = \"html\";\n        ctx.body = html;\n    };\n\n    async function getPage(filepath) {\n        if (options.cache && filepath in cachePages) {\n            return cachePages[filepath];\n        }\n        let r;\n        try {\n            r = await Promise.all([getLayout(), getContent(filepath)]);\n        } catch (err) {\n            if (err.code === \"ENOENT\") {\n                return null;\n            }\n            throw err;\n        }\n\n        let layout = r[0];\n        let content = r[1];\n        let html = text.replaceAll(layout, options.titleHolder, content.title);\n        html = text.replaceAll(html, options.bodyHolder, content.body);\n\n        if (options.cache) {\n            cachePages[filepath] = html;\n        }\n        return html;\n    }\n\n    async function getLayout() {\n        if (options.cache && cacheLayout) return cacheLayout;\n        let layout = (await fs.exists(options.layout)) ? await fs.readFile(options.layout, \"utf8\") : defaultLayout;\n        if (options.cache) cacheLayout = layout;\n        return layout;\n    }\n\n    async function getContent(filepath) {\n        let content = await fs.readFile(filepath, \"utf8\");\n        let title = content\n            .slice(0, content.indexOf(\"\\n\"))\n            .trim()\n            .replace(/^[#\\s]+/, \"\");\n        let body = options.render(content);\n        return {\n            title: title,\n            body: body,\n        };\n    }\n};\n"],"file":"markdown.js"}