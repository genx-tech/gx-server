{"version":3,"file":"acl.js","names":["_","eachAsync_","require","Feature","Enums","InvalidConfiguration","module","exports","type","PLUGIN","load_","app","config","Acl","tryRequire","backend","backendType","backendStore","indexOf","memoryBackend","dataSource","mongodb","getService","mongodbBackend","connect_","prefix","Error","acl"],"sources":["../../src/features/acl.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Enable acl feature\n * @module Feature_Acl\n */\n\nconst { _, eachAsync_ } = require('@genx/july');\nconst { Feature } = require('..').Enums;\nconst { InvalidConfiguration } = require('@genx/error');\n\nmodule.exports = {\n\n    /**\n     * This feature is loaded at service stage\n     * @member {string}\n     */\n    type: Feature.PLUGIN,\n\n    /**\n     * Load the feature\n     * @param {Routable} app - The app module object\n     * @param {object} config - Acl settings\n     * @property {string} config.backend - Backend store type of acl, memory, mongodb, redis\n     * @property {string} [config.dataSource] - Store type of acl\n     * @property {object} [config.prefix] - Store options\n     * @returns {Promise.<*>}\n     * \n     * @example\n     * \n     * acl: {\n     *   backend: 'mongodb.dataSourceName'\n     * }\n     */\n    load_: async function (app, config) {\n        const Acl = app.tryRequire('acl');\n        let backend = config.backend || 'memory';\n        let backendType, backendStore;\n\n        if (backend.indexOf('.') > 0) {\n            backendType = '';\n        }\n\n        switch (backend) {\n            case 'memory':\n            backendStore = new Acl.memoryBackend();\n            break;\n\n            case 'mongodb':\n            if (!config.dataSource) {\n                throw new InvalidConfiguration('\"dataSource\" is required for mongodb backend of acl.', app, 'acl.dataSource');\n            }\n\n            let mongodb = app.getService(config.dataSource);\n            if (!mongodb) {\n                throw new InvalidConfiguration(`Data source \"${config.dataSource}\" not found.`, app, 'acl.dataSource');\n            }\n\n            backendStore = new Acl.mongodbBackend(await mongodb.connect_(), config.prefix);\n            break;\n\n            case 'redis':\n            throw new Error('to be implemented');\n            break;\n\n            default:\n            throw new InvalidConfiguration('Unsupported acl backend: ' + backend, app, 'acl.backend');\n        }        \n    \n        app.acl = new Acl(backendStore);       \n    }\n};"],"mappings":"AAAA;;;;AAOA,MAAM;EAAEA,CAAF;EAAKC;AAAL,IAAoBC,OAAO,CAAC,YAAD,CAAjC;;AACA,MAAM;EAAEC;AAAF,IAAcD,OAAO,CAAC,IAAD,CAAP,CAAcE,KAAlC;;AACA,MAAM;EAAEC;AAAF,IAA2BH,OAAO,CAAC,aAAD,CAAxC;;AAEAI,MAAM,CAACC,OAAP,GAAiB;EAMbC,IAAI,EAAEL,OAAO,CAACM,MAND;EAuBbC,KAAK,EAAE,gBAAgBC,GAAhB,EAAqBC,MAArB,EAA6B;IAChC,MAAMC,GAAG,GAAGF,GAAG,CAACG,UAAJ,CAAe,KAAf,CAAZ;IACA,IAAIC,OAAO,GAAGH,MAAM,CAACG,OAAP,IAAkB,QAAhC;IACA,IAAIC,WAAJ,EAAiBC,YAAjB;;IAEA,IAAIF,OAAO,CAACG,OAAR,CAAgB,GAAhB,IAAuB,CAA3B,EAA8B;MAC1BF,WAAW,GAAG,EAAd;IACH;;IAED,QAAQD,OAAR;MACI,KAAK,QAAL;QACAE,YAAY,GAAG,IAAIJ,GAAG,CAACM,aAAR,EAAf;QACA;;MAEA,KAAK,SAAL;QACA,IAAI,CAACP,MAAM,CAACQ,UAAZ,EAAwB;UACpB,MAAM,IAAIf,oBAAJ,CAAyB,sDAAzB,EAAiFM,GAAjF,EAAsF,gBAAtF,CAAN;QACH;;QAED,IAAIU,OAAO,GAAGV,GAAG,CAACW,UAAJ,CAAeV,MAAM,CAACQ,UAAtB,CAAd;;QACA,IAAI,CAACC,OAAL,EAAc;UACV,MAAM,IAAIhB,oBAAJ,CAA0B,gBAAeO,MAAM,CAACQ,UAAW,cAA3D,EAA0ET,GAA1E,EAA+E,gBAA/E,CAAN;QACH;;QAEDM,YAAY,GAAG,IAAIJ,GAAG,CAACU,cAAR,CAAuB,MAAMF,OAAO,CAACG,QAAR,EAA7B,EAAiDZ,MAAM,CAACa,MAAxD,CAAf;QACA;;MAEA,KAAK,OAAL;QACA,MAAM,IAAIC,KAAJ,CAAU,mBAAV,CAAN;QACA;;MAEA;QACA,MAAM,IAAIrB,oBAAJ,CAAyB,8BAA8BU,OAAvD,EAAgEJ,GAAhE,EAAqE,aAArE,CAAN;IAvBJ;;IA0BAA,GAAG,CAACgB,GAAJ,GAAU,IAAId,GAAJ,CAAQI,YAAR,CAAV;EACH;AA3DY,CAAjB"}