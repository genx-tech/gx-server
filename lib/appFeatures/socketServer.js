"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  urlJoin,
  ensureLeftSlash
} = require('rk-utils');

const {
  Feature
} = require('..').enum;

const {
  Helpers: {
    tryRequire
  }
} = require('@genx/app');

const SocketServer = tryRequire('socket.io');

const {
  InvalidConfiguration
} = require('../utils/Errors');

const DEFAULT_CONTROLLER_PATH = 'events';

function loadEventHandler(appModule, namespace, controllerBasePath, handlerName, isMiddleware = false) {
  let pos = handlerName.lastIndexOf('.');

  if (pos < 0) {
    if (isMiddleware) {
      throw new InvalidConfiguration(`Invalid middleware reference: ${handlerName}`, appModule, namespace ? `socketServer.routes["${namespace}"].middlewares` : 'socketServer.middlewares');
    } else {
      throw new InvalidConfiguration(`Invalid event handler reference: ${handlerName}`, appModule, `socketServer.routes["${namespace}"].events`);
    }
  }

  let controller = handlerName.substr(0, pos);
  let action = handlerName.substr(pos + 1);
  let controllerPath = path.resolve(controllerBasePath, controller + '.js');

  let ctrl = require(controllerPath);

  let middlewareHandler = ctrl[action];

  if (typeof middlewareHandler !== 'function') {
    if (isMiddleware) {
      throw new InvalidConfiguration(`Middleware function not found: ${handlerName}`, appModule, namespace ? `socketServer.routes["${namespace}"].middlewares` : 'socketServer.middlewares');
    } else {
      throw new InvalidConfiguration(`Event handler function not found: ${handlerName}`, appModule, `socketServer.routes["${namespace}"].events`);
    }
  }

  return middlewareHandler;
}

function startSocketServer(appModule, config) {
  let {
    port,
    logger,
    path: wsPath,
    ...options
  } = config;

  if (logger && typeof logger === 'string') {
    logger = appModule.getService('logger.' + logger);
  }

  function log(...args) {
    logger && logger.log(...args);
  }

  let io,
      standalone = false;
  let endpointPath = wsPath ? urlJoin(appModule.route, wsPath) : appModule.route;
  endpointPath = ensureLeftSlash(endpointPath);
  let serviceTag = port ? `socketServer:${port}${endpointPath}` : `socketServer:${endpointPath}`;

  if (appModule.hasService(serviceTag)) {
    throw new InvalidConfiguration('Socket server path or port conflict.', appModule, `socketServer[${i}].(path|port)`);
  }

  options.path = endpointPath;

  if (port) {
    io = new SocketServer(options);
    standalone = true;
    appModule.log('verbose', `A standalone socket server is listening at [port=${port}, path=${endpointPath}].`);
  } else {
    io = new SocketServer(appModule.server.httpServer, options);
    port = appModule.server.port;
    appModule.log('verbose', `A socket server is listening at [path=${endpointPath}].`);
  }

  io.on('connection', socket => {
    log('info', 'client connect', {
      endpoint: endpointPath,
      port,
      id: socket.id,
      ...socket.handshake
    });
  });
  let controllersPath = path.resolve(appModule.backendPath, config.controllersPath || DEFAULT_CONTROLLER_PATH);

  if (config.middlewares) {
    io.use(loadEventHandler(appModule, null, controllersPath, middlewareName, true));
  }

  if (_.isEmpty(config.routes)) {
    throw new InvalidConfiguration('Missing routes config.', appModule, 'socketServer.routes');
  }

  _.forOwn(config.routes, (info, name) => {
    name = ensureLeftSlash(name);
    let namespaceChannel = io.of(name);

    if (info.middlewares) {
      let m = Array.isArray(info.middlewares) ? info.middlewares : [info.middlewares];
      m.forEach(middlewareName => {
        namespaceChannel.use(loadEventHandler(appModule, name, controllersPath, middlewareName, true));
      });
    }

    let eventHandlers;

    if (info.controller) {
      let rpcControllerPath = path.resolve(controllersPath, info.controller + '.js');
      eventHandlers = require(rpcControllerPath);
      appModule.log('verbose', `[${serviceTag}]Controller "${info.controller}" is attached for namespace "${name}".`);
    }

    if (info.events) {
      eventHandlers = {};

      _.forOwn(info.events, (handler, event) => {
        eventHandlers[event] = loadEventHandler(appModule, name, controllersPath, handler);
      });

      appModule.log('verbose', `[${serviceTag}]Event handlers are attached for namespace "${name}".`, {
        events: Object.keys(eventHandlers)
      });
    }

    namespaceChannel.on('connect', function (socket) {
      socket.on('disconnect', () => {
        log('verbose', 'namespace disconnect', {
          endpoint: endpointPath,
          port,
          id: socket.id,
          namespace: name
        });
      });
      log('verbose', 'namespace connect', {
        endpoint: endpointPath,
        port,
        id: socket.id,
        namespace: name
      });
      let ctx = {
        appModule,
        socket
      };
      eventHandlers && eventHandlers.forOwn((handler, event) => {
        socket.on(event, (data, cb) => handler(ctx, data).then(cb));
      });

      if (info.welcome) {
        loadEventHandler(appModule, name, controllersPath, info.welcome)(ctx).catch(error => log('error', error.message));
      }
    });
  });

  if (standalone) {
    io.listen(config.port);
  }

  appModule.registerService(serviceTag, io);
  return io;
}

module.exports = {
  type: Feature.PLUGIN,
  load_: (appModule, servers) => {
    if (Array.isArray(servers)) {
      return servers.forEach(server => startSocketServer(appModule, server));
    }

    let io = startSocketServer(appModule, servers);
    appModule.registerService('socketServer', io);
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcHBGZWF0dXJlcy9zb2NrZXRTZXJ2ZXIuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwidXJsSm9pbiIsImVuc3VyZUxlZnRTbGFzaCIsIkZlYXR1cmUiLCJlbnVtIiwiSGVscGVycyIsInRyeVJlcXVpcmUiLCJTb2NrZXRTZXJ2ZXIiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsIkRFRkFVTFRfQ09OVFJPTExFUl9QQVRIIiwibG9hZEV2ZW50SGFuZGxlciIsImFwcE1vZHVsZSIsIm5hbWVzcGFjZSIsImNvbnRyb2xsZXJCYXNlUGF0aCIsImhhbmRsZXJOYW1lIiwiaXNNaWRkbGV3YXJlIiwicG9zIiwibGFzdEluZGV4T2YiLCJjb250cm9sbGVyIiwic3Vic3RyIiwiYWN0aW9uIiwiY29udHJvbGxlclBhdGgiLCJyZXNvbHZlIiwiY3RybCIsIm1pZGRsZXdhcmVIYW5kbGVyIiwic3RhcnRTb2NrZXRTZXJ2ZXIiLCJjb25maWciLCJwb3J0IiwibG9nZ2VyIiwid3NQYXRoIiwib3B0aW9ucyIsImdldFNlcnZpY2UiLCJsb2ciLCJhcmdzIiwiaW8iLCJzdGFuZGFsb25lIiwiZW5kcG9pbnRQYXRoIiwicm91dGUiLCJzZXJ2aWNlVGFnIiwiaGFzU2VydmljZSIsImkiLCJzZXJ2ZXIiLCJodHRwU2VydmVyIiwib24iLCJzb2NrZXQiLCJlbmRwb2ludCIsImlkIiwiaGFuZHNoYWtlIiwiY29udHJvbGxlcnNQYXRoIiwiYmFja2VuZFBhdGgiLCJtaWRkbGV3YXJlcyIsInVzZSIsIm1pZGRsZXdhcmVOYW1lIiwiaXNFbXB0eSIsInJvdXRlcyIsImZvck93biIsImluZm8iLCJuYW1lIiwibmFtZXNwYWNlQ2hhbm5lbCIsIm9mIiwibSIsIkFycmF5IiwiaXNBcnJheSIsImZvckVhY2giLCJldmVudEhhbmRsZXJzIiwicnBjQ29udHJvbGxlclBhdGgiLCJldmVudHMiLCJoYW5kbGVyIiwiZXZlbnQiLCJPYmplY3QiLCJrZXlzIiwiY3R4IiwiZGF0YSIsImNiIiwidGhlbiIsIndlbGNvbWUiLCJjYXRjaCIsImVycm9yIiwibWVzc2FnZSIsImxpc3RlbiIsInJlZ2lzdGVyU2VydmljZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0eXBlIiwiUExVR0lOIiwibG9hZF8iLCJzZXJ2ZXJzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQVNBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLE9BQUw7QUFBY0MsRUFBQUE7QUFBZCxJQUFrQ0gsT0FBTyxDQUFDLFVBQUQsQ0FBL0M7O0FBQ0EsTUFBTTtBQUFFSSxFQUFBQTtBQUFGLElBQWNKLE9BQU8sQ0FBQyxJQUFELENBQVAsQ0FBY0ssSUFBbEM7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxPQUFPLEVBQUU7QUFBRUMsSUFBQUE7QUFBRjtBQUFYLElBQThCUCxPQUFPLENBQUMsV0FBRCxDQUEzQzs7QUFDQSxNQUFNUSxZQUFZLEdBQUdELFVBQVUsQ0FBQyxXQUFELENBQS9COztBQUNBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUEyQlQsT0FBTyxDQUFDLGlCQUFELENBQXhDOztBQUVBLE1BQU1VLHVCQUF1QixHQUFHLFFBQWhDOztBQUVBLFNBQVNDLGdCQUFULENBQTBCQyxTQUExQixFQUFxQ0MsU0FBckMsRUFBZ0RDLGtCQUFoRCxFQUFvRUMsV0FBcEUsRUFBaUZDLFlBQVksR0FBRyxLQUFoRyxFQUF1RztBQUNuRyxNQUFJQyxHQUFHLEdBQUdGLFdBQVcsQ0FBQ0csV0FBWixDQUF3QixHQUF4QixDQUFWOztBQUNBLE1BQUlELEdBQUcsR0FBRyxDQUFWLEVBQWE7QUFDVCxRQUFJRCxZQUFKLEVBQWtCO0FBQ2QsWUFBTSxJQUFJUCxvQkFBSixDQUNELGlDQUFnQ00sV0FBWSxFQUQzQyxFQUVGSCxTQUZFLEVBR0ZDLFNBQVMsR0FBSSx3QkFBdUJBLFNBQVUsZ0JBQXJDLEdBQXVELDBCQUg5RCxDQUFOO0FBS0gsS0FO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Y0FBMUIsRUFBMEM5QyxFQUExQztBQUNIO0FBbENZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbi8qKlxuICogU29ja2V0IGJhc2VkIFJwYyBTZXJ2ZXJcbiAqIEBtb2R1bGUgRmVhdHVyZV9Tb2NrZXRTZXJ2ZXJcbiAqIFxuICogbWlkZGxld2FyZTogKHBhY2tldCwgbmV4dCkgPT4ge31cbiAqL1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCB1cmxKb2luLCBlbnN1cmVMZWZ0U2xhc2ggfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IEZlYXR1cmUgfSA9IHJlcXVpcmUoJy4uJykuZW51bTtcbmNvbnN0IHsgSGVscGVyczogeyB0cnlSZXF1aXJlIH0gfSA9IHJlcXVpcmUoJ0BnZW54L2FwcCcpO1xuY29uc3QgU29ja2V0U2VydmVyID0gdHJ5UmVxdWlyZSgnc29ja2V0LmlvJyk7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uIH0gPSByZXF1aXJlKCcuLi91dGlscy9FcnJvcnMnKTtcblxuY29uc3QgREVGQVVMVF9DT05UUk9MTEVSX1BBVEggPSAnZXZlbnRzJztcblxuZnVuY3Rpb24gbG9hZEV2ZW50SGFuZGxlcihhcHBNb2R1bGUsIG5hbWVzcGFjZSwgY29udHJvbGxlckJhc2VQYXRoLCBoYW5kbGVyTmFtZSwgaXNNaWRkbGV3YXJlID0gZmFsc2UpIHtcbiAgICBsZXQgcG9zID0gaGFuZGxlck5hbWUubGFzdEluZGV4T2YoJy4nKTtcbiAgICBpZiAocG9zIDwgMCkge1xuICAgICAgICBpZiAoaXNNaWRkbGV3YXJlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgYEludmFsaWQgbWlkZGxld2FyZSByZWZlcmVuY2U6ICR7aGFuZGxlck5hbWV9YCxcbiAgICAgICAgICAgICAgICBhcHBNb2R1bGUsXG4gICAgICAgICAgICAgICAgbmFtZXNwYWNlID8gYHNvY2tldFNlcnZlci5yb3V0ZXNbXCIke25hbWVzcGFjZX1cIl0ubWlkZGxld2FyZXNgIDogJ3NvY2tldFNlcnZlci5taWRkbGV3YXJlcydcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgYEludmFsaWQgZXZlbnQgaGFuZGxlciByZWZlcmVuY2U6ICR7aGFuZGxlck5hbWV9YCxcbiAgICAgICAgICAgICAgICBhcHBNb2R1bGUsXG4gICAgICAgICAgICAgICAgYHNvY2tldFNlcnZlci5yb3V0ZXNbXCIke25hbWVzcGFjZX1cIl0uZXZlbnRzYFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGxldCBjb250cm9sbGVyID0gaGFuZGxlck5hbWUuc3Vic3RyKDAsIHBvcyk7XG4gICAgbGV0IGFjdGlvbiA9IGhhbmRsZXJOYW1lLnN1YnN0cihwb3MgKyAxKTtcblxuICAgIGxldCBjb250cm9sbGVyUGF0aCA9IHBhdGgucmVzb2x2ZShjb250cm9sbGVyQmFzZVBhdGgsIGNvbnRyb2xsZXIgKyAnLmpzJyk7XG4gICAgbGV0IGN0cmwgPSByZXF1aXJlKGNvbnRyb2xsZXJQYXRoKTtcbiAgICBcbiAgICBsZXQgbWlkZGxld2FyZUhhbmRsZXIgPSBjdHJsW2FjdGlvbl07XG4gICAgaWYgKHR5cGVvZiBtaWRkbGV3YXJlSGFuZGxlciAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBpZiAoaXNNaWRkbGV3YXJlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgYE1pZGRsZXdhcmUgZnVuY3Rpb24gbm90IGZvdW5kOiAke2hhbmRsZXJOYW1lfWAsXG4gICAgICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgICAgIG5hbWVzcGFjZSA/IGBzb2NrZXRTZXJ2ZXIucm91dGVzW1wiJHtuYW1lc3BhY2V9XCJdLm1pZGRsZXdhcmVzYCA6ICdzb2NrZXRTZXJ2ZXIubWlkZGxld2FyZXMnXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgIGBFdmVudCBoYW5kbGVyIGZ1bmN0aW9uIG5vdCBmb3VuZDogJHtoYW5kbGVyTmFtZX1gLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICBgc29ja2V0U2VydmVyLnJvdXRlc1tcIiR7bmFtZXNwYWNlfVwiXS5ldmVudHNgXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG1pZGRsZXdhcmVIYW5kbGVyO1xufVxuXG5mdW5jdGlvbiBzdGFydFNvY2tldFNlcnZlcihhcHBNb2R1bGUsIGNvbmZpZykge1xuICAgIGxldCB7IHBvcnQsIGxvZ2dlciwgcGF0aDogd3NQYXRoLCAuLi5vcHRpb25zIH0gPSBjb25maWc7XG5cbiAgICBpZiAobG9nZ2VyICYmIHR5cGVvZiBsb2dnZXIgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGxvZ2dlciA9IGFwcE1vZHVsZS5nZXRTZXJ2aWNlKCdsb2dnZXIuJyArIGxvZ2dlcik7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gbG9nKC4uLmFyZ3MpIHtcbiAgICAgICAgbG9nZ2VyICYmIGxvZ2dlci5sb2coLi4uYXJncyk7XG4gICAgfVxuXG4gICAgbGV0IGlvLCBzdGFuZGFsb25lID0gZmFsc2U7XG5cbiAgICBsZXQgZW5kcG9pbnRQYXRoID0gd3NQYXRoID8gdXJsSm9pbihhcHBNb2R1bGUucm91dGUsIHdzUGF0aCkgOiBhcHBNb2R1bGUucm91dGU7XG4gICAgZW5kcG9pbnRQYXRoID0gZW5zdXJlTGVmdFNsYXNoKGVuZHBvaW50UGF0aCk7XG5cbiAgICBsZXQgc2VydmljZVRhZyA9IHBvcnQgPyBgc29ja2V0U2VydmVyOiR7cG9ydH0ke2VuZHBvaW50UGF0aH1gIDogYHNvY2tldFNlcnZlcjoke2VuZHBvaW50UGF0aH1gO1xuXG4gICAgaWYgKGFwcE1vZHVsZS5oYXNTZXJ2aWNlKHNlcnZpY2VUYWcpKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdTb2NrZXQgc2VydmVyIHBhdGggb3IgcG9ydCBjb25mbGljdC4nLFxuICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgYHNvY2tldFNlcnZlclske2l9XS4ocGF0aHxwb3J0KWBcbiAgICAgICAgKTtcbiAgICB9ICAgICAgICAgICAgXG5cbiAgICBvcHRpb25zLnBhdGggPSBlbmRwb2ludFBhdGg7XG5cbiAgICBpZiAocG9ydCkge1xuICAgICAgICBpbyA9IG5ldyBTb2NrZXRTZXJ2ZXIob3B0aW9ucyk7XG4gICAgICAgIHN0YW5kYWxvbmUgPSB0cnVlO1xuICAgICAgICBhcHBNb2R1bGUubG9nKCd2ZXJib3NlJywgYEEgc3RhbmRhbG9uZSBzb2NrZXQgc2VydmVyIGlzIGxpc3RlbmluZyBhdCBbcG9ydD0ke3BvcnR9LCBwYXRoPSR7ZW5kcG9pbnRQYXRofV0uYCk7ICAgICAgICBcbiAgICB9IGVsc2Uge1xuICAgICAgICBpbyA9IG5ldyBTb2NrZXRTZXJ2ZXIoYXBwTW9kdWxlLnNlcnZlci5odHRwU2VydmVyLCBvcHRpb25zKTtcbiAgICAgICAgcG9ydCA9IGFwcE1vZHVsZS5zZXJ2ZXIucG9ydDtcbiAgICAgICAgYXBwTW9kdWxlLmxvZygndmVyYm9zZScsIGBBIHNvY2tldCBzZXJ2ZXIgaXMgbGlzdGVuaW5nIGF0IFtwYXRoPSR7ZW5kcG9pbnRQYXRofV0uYCk7ICAgICAgICBcbiAgICB9XG5cbiAgICBpby5vbignY29ubmVjdGlvbicsIHNvY2tldCA9PiB7XG4gICAgICAgIGxvZygnaW5mbycsICdjbGllbnQgY29ubmVjdCcsIHtcbiAgICAgICAgICAgIGVuZHBvaW50OiBlbmRwb2ludFBhdGgsXG4gICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgaWQ6IHNvY2tldC5pZCxcbiAgICAgICAgICAgIC4uLnNvY2tldC5oYW5kc2hha2VcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBsZXQgY29udHJvbGxlcnNQYXRoID0gcGF0aC5yZXNvbHZlKGFwcE1vZHVsZS5iYWNrZW5kUGF0aCwgY29uZmlnLmNvbnRyb2xsZXJzUGF0aCB8fCBERUZBVUxUX0NPTlRST0xMRVJfUEFUSCk7XG5cbiAgICBpZiAoY29uZmlnLm1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGlvLnVzZShsb2FkRXZlbnRIYW5kbGVyKGFwcE1vZHVsZSwgbnVsbCwgY29udHJvbGxlcnNQYXRoLCBtaWRkbGV3YXJlTmFtZSwgdHJ1ZSkpO1xuICAgIH1cblxuICAgIGlmIChfLmlzRW1wdHkoY29uZmlnLnJvdXRlcykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3Npbmcgcm91dGVzIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgJ3NvY2tldFNlcnZlci5yb3V0ZXMnXG4gICAgICAgICk7XG4gICAgfSAgICAgICAgXG5cbiAgICBfLmZvck93bihjb25maWcucm91dGVzLCAoaW5mbywgbmFtZSkgPT4ge1xuICAgICAgICBuYW1lID0gZW5zdXJlTGVmdFNsYXNoKG5hbWUpO1xuXG4gICAgICAgIGxldCBuYW1lc3BhY2VDaGFubmVsID0gaW8ub2YobmFtZSk7XG5cbiAgICAgICAgaWYgKGluZm8ubWlkZGxld2FyZXMpIHtcbiAgICAgICAgICAgIGxldCBtID0gQXJyYXkuaXNBcnJheShpbmZvLm1pZGRsZXdhcmVzKSA/IGluZm8ubWlkZGxld2FyZXMgOiBbIGluZm8ubWlkZGxld2FyZXMgXTtcbiAgICAgICAgICAgIG0uZm9yRWFjaChtaWRkbGV3YXJlTmFtZSA9PiB7XG4gICAgICAgICAgICAgICAgbmFtZXNwYWNlQ2hhbm5lbC51c2UobG9hZEV2ZW50SGFuZGxlcihhcHBNb2R1bGUsIG5hbWUsIGNvbnRyb2xsZXJzUGF0aCwgbWlkZGxld2FyZU5hbWUsIHRydWUpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGV2ZW50SGFuZGxlcnM7XG5cbiAgICAgICAgaWYgKGluZm8uY29udHJvbGxlcikgeyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBycGNDb250cm9sbGVyUGF0aCA9IHBhdGgucmVzb2x2ZShjb250cm9sbGVyc1BhdGgsIGluZm8uY29udHJvbGxlciArICcuanMnKTtcbiAgICAgICAgICAgIGV2ZW50SGFuZGxlcnMgPSByZXF1aXJlKHJwY0NvbnRyb2xsZXJQYXRoKTtcblxuICAgICAgICAgICAgYXBwTW9kdWxlLmxvZygndmVyYm9zZScsIGBbJHtzZXJ2aWNlVGFnfV1Db250cm9sbGVyIFwiJHtpbmZvLmNvbnRyb2xsZXJ9XCIgaXMgYXR0YWNoZWQgZm9yIG5hbWVzcGFjZSBcIiR7bmFtZX1cIi5gKTtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIGlmIChpbmZvLmV2ZW50cykge1xuICAgICAgICAgICAgZXZlbnRIYW5kbGVycyA9IHt9O1xuXG4gICAgICAgICAgICBfLmZvck93bihpbmZvLmV2ZW50cywgKGhhbmRsZXIsIGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgZXZlbnRIYW5kbGVyc1tldmVudF0gPSBsb2FkRXZlbnRIYW5kbGVyKGFwcE1vZHVsZSwgbmFtZSwgY29udHJvbGxlcnNQYXRoLCBoYW5kbGVyKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGFwcE1vZHVsZS5sb2coJ3ZlcmJvc2UnLCBgWyR7c2VydmljZVRhZ31dRXZlbnQgaGFuZGxlcnMgYXJlIGF0dGFjaGVkIGZvciBuYW1lc3BhY2UgXCIke25hbWV9XCIuYCwge1xuICAgICAgICAgICAgICAgIGV2ZW50czogT2JqZWN0LmtleXMoZXZlbnRIYW5kbGVycylcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgbmFtZXNwYWNlQ2hhbm5lbC5vbignY29ubmVjdCcsIGZ1bmN0aW9uIChzb2NrZXQpIHtcbiAgICAgICAgICAgIHNvY2tldC5vbignZGlzY29ubmVjdCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICBsb2coJ3ZlcmJvc2UnLCAnbmFtZXNwYWNlIGRpc2Nvbm5lY3QnLCB7IFxuICAgICAgICAgICAgICAgICAgICBlbmRwb2ludDogZW5kcG9pbnRQYXRoLFxuICAgICAgICAgICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgICAgICAgICBpZDogc29ja2V0LmlkLCBcbiAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlOiBuYW1lIFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGxvZygndmVyYm9zZScsICduYW1lc3BhY2UgY29ubmVjdCcsIHsgXG4gICAgICAgICAgICAgICAgZW5kcG9pbnQ6IGVuZHBvaW50UGF0aCxcbiAgICAgICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgICAgIGlkOiBzb2NrZXQuaWQsIFxuICAgICAgICAgICAgICAgIG5hbWVzcGFjZTogbmFtZSBcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBsZXQgY3R4ID0geyBhcHBNb2R1bGUsIHNvY2tldCB9O1xuXG4gICAgICAgICAgICAvL1JlZ2lzdGVyIGV2ZW50IGhhbmRsZXJzXG4gICAgICAgICAgICBldmVudEhhbmRsZXJzICYmIGV2ZW50SGFuZGxlcnMuZm9yT3duKChoYW5kbGVyLCBldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHNvY2tldC5vbihldmVudCwgKGRhdGEsIGNiKSA9PiBoYW5kbGVyKGN0eCwgZGF0YSkudGhlbihjYikpO1xuICAgICAgICAgICAgfSk7ICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBpZiAoaW5mby53ZWxjb21lKSB7XG4gICAgICAgICAgICAgICAgbG9hZEV2ZW50SGFuZGxlcihhcHBNb2R1bGUsIG5hbWUsIGNvbnRyb2xsZXJzUGF0aCwgaW5mby53ZWxjb21lKShjdHgpLmNhdGNoKGVycm9yID0+IGxvZygnZXJyb3InLCBlcnJvci5tZXNzYWdlKSk7ICAgICAgICAgICAgXG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaWYgKHN0YW5kYWxvbmUpIHtcbiAgICAgICAgaW8ubGlzdGVuKGNvbmZpZy5wb3J0KTtcbiAgICB9XG5cbiAgICBhcHBNb2R1bGUucmVnaXN0ZXJTZXJ2aWNlKHNlcnZpY2VUYWcsIGlvKTtcblxuICAgIHJldHVybiBpbztcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IHBsdWdpbiBzdGFnZVxuICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgKi9cbiAgICB0eXBlOiBGZWF0dXJlLlBMVUdJTixcblxuICAgIC8qKlxuICAgICAqIFRoZSBzb2NrZXQgc2VydmVyIG9wdGlvbnMuXG4gICAgICogQHR5cGVkZWYge09iamVjdH0gU2VydmVyT3B0aW9uc1xuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbcGF0aD0vc29ja2V0LmlvXSAtIG5hbWUgb2YgdGhlIHBhdGggdG8gY2FwdHVyZVxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW3NlcnZlQ2xpZW50PXRydWVdIC0gd2hldGhlciB0byBzZXJ2ZSB0aGUgY2xpZW50IGZpbGVzXG4gICAgICogQHByb3BlcnR5IHtBZGFwdGVyfSBhZGFwdGVyIC0gdGhlIGFkYXB0ZXIgdG8gdXNlLiBEZWZhdWx0cyB0byBhbiBpbnN0YW5jZSBvZiB0aGUgQWRhcHRlciB0aGF0IHNoaXBzIHdpdGggc29ja2V0LmlvIHdoaWNoIGlzIG1lbW9yeSBiYXNlZC4gU2VlIHNvY2tldC5pby1hZGFwdGVyXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG9yaWdpbnMgLSB0aGUgYWxsb3dlZCBvcmlnaW5zXG4gICAgICogQHByb3BlcnR5IHtQYXJzZXJ9IHBhcnNlciAtIHRoZSBwYXJzZXIgdG8gdXNlLiBEZWZhdWx0cyB0byBhbiBpbnN0YW5jZSBvZiB0aGUgUGFyc2VyIHRoYXQgc2hpcHMgd2l0aCBzb2NrZXQuaW8uIFNlZSBzb2NrZXQuaW8tcGFyc2VyXG4gICAgICogQHNlZSB7QGxpbmsgaHR0cHM6Ly9zb2NrZXQuaW8vZG9jcy9zZXJ2ZXItYXBpL30gZm9yIG1vcmUgb3B0aW9uc1xuICAgICAqL1xuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgcnBjIFNlcnZlclxuICAgICAqIEBwYXJhbSB7QXBwTW9kdWxlfSBhcHBNb2R1bGUgLSBUaGUgYXBwIG1vZHVsZSBvYmplY3RcbiAgICAgKiBAcGFyYW0ge1NlcnZlck9wdGlvbnNbXX0gc2VydmVycyAtIFJwYyBzZXJ2ZXIgY29uZmlnXG4gICAgICovXG4gICAgbG9hZF86IChhcHBNb2R1bGUsIHNlcnZlcnMpID0+IHsgICAgICAgIFxuXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHNlcnZlcnMpKSB7XG4gICAgICAgICAgICByZXR1cm4gc2VydmVycy5mb3JFYWNoKHNlcnZlciA9PiBzdGFydFNvY2tldFNlcnZlcihhcHBNb2R1bGUsIHNlcnZlcikpOyAgICAgICAgICAgIFxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGlvID0gc3RhcnRTb2NrZXRTZXJ2ZXIoYXBwTW9kdWxlLCBzZXJ2ZXJzKTtcblxuICAgICAgICAvL2RlZmF1bHQgc29ja2V0IHNlcnZlclxuICAgICAgICBhcHBNb2R1bGUucmVnaXN0ZXJTZXJ2aWNlKCdzb2NrZXRTZXJ2ZXInLCBpbyk7XG4gICAgfVxufTsiXX0=