"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  url: urlUtil,
  text
} = require('@genx/july');

const {
  Feature
} = require('..').Enums;

const {
  InvalidConfiguration
} = require('@genx/error');

const DEFAULT_CONTROLLER_PATH = 'events';

function loadEventHandler(appModule, namespace, controllerBasePath, handlerName, isMiddleware = false) {
  let pos = handlerName.lastIndexOf('.');

  if (pos < 0) {
    if (isMiddleware) {
      throw new InvalidConfiguration(`Invalid middleware reference: ${handlerName}`, appModule, namespace ? `socketServer.routes["${namespace}"].middlewares` : 'socketServer.middlewares');
    } else {
      throw new InvalidConfiguration(`Invalid event handler reference: ${handlerName}`, appModule, `socketServer.routes["${namespace}"].events`);
    }
  }

  let controller = handlerName.substr(0, pos);
  let action = handlerName.substr(pos + 1);
  let controllerPath = path.resolve(controllerBasePath, controller + '.js');

  let ctrl = require(controllerPath);

  let middlewareHandler = ctrl[action];

  if (typeof middlewareHandler !== 'function') {
    if (isMiddleware) {
      throw new InvalidConfiguration(`Middleware function not found: ${handlerName}`, appModule, namespace ? `socketServer.routes["${namespace}"].middlewares` : 'socketServer.middlewares');
    } else {
      throw new InvalidConfiguration(`Event handler function not found: ${handlerName}`, appModule, `socketServer.routes["${namespace}"].events`);
    }
  }

  return middlewareHandler;
}

function startSocketServer(appModule, config) {
  const SocketServer = appModule.tryRequire('socket.io');
  let {
    port,
    logger,
    path: wsPath,
    ...options
  } = config;

  if (logger && typeof logger === 'string') {
    logger = appModule.getService('logger.' + logger);
  }

  function log(...args) {
    logger && logger.log(...args);
  }

  let io,
      standalone = false;
  let endpointPath = wsPath ? urlUtil.join(appModule.route, wsPath) : appModule.route;
  endpointPath = text.ensureStartsWith(endpointPath, '/');
  let serviceTag = port ? `socketServer:${port}${endpointPath}` : `socketServer:${endpointPath}`;

  if (appModule.hasService(serviceTag)) {
    throw new InvalidConfiguration('Socket server path or port conflict.', appModule, `socketServer[${i}].(path|port)`);
  }

  options.path = endpointPath;

  if (port) {
    io = new SocketServer(options);
    standalone = true;
    appModule.log('verbose', `A standalone socket server is listening at [port=${port}, path=${endpointPath}].`);
  } else {
    io = new SocketServer(appModule.server.httpServer, options);
    port = appModule.server.port;
    appModule.log('verbose', `A socket server is listening at [path=${endpointPath}].`);
  }

  io.on('connection', socket => {
    log('info', 'client connect', {
      endpoint: endpointPath,
      port,
      id: socket.id,
      ...socket.handshake
    });
  });
  let controllersPath = path.resolve(appModule.backendPath, config.controllersPath || DEFAULT_CONTROLLER_PATH);

  if (config.middlewares) {
    io.use(loadEventHandler(appModule, null, controllersPath, middlewareName, true));
  }

  if (_.isEmpty(config.routes)) {
    throw new InvalidConfiguration('Missing routes config.', appModule, 'socketServer.routes');
  }

  _.forOwn(config.routes, (info, name) => {
    name = text.ensureStartsWith(name, '/');
    let namespaceChannel = io.of(name);

    if (info.middlewares) {
      let m = Array.isArray(info.middlewares) ? info.middlewares : [info.middlewares];
      m.forEach(middlewareName => {
        namespaceChannel.use(loadEventHandler(appModule, name, controllersPath, middlewareName, true));
      });
    }

    let eventHandlers;

    if (info.controller) {
      let rpcControllerPath = path.resolve(controllersPath, info.controller + '.js');
      eventHandlers = require(rpcControllerPath);
      appModule.log('verbose', `[${serviceTag}]Controller "${info.controller}" is attached for namespace "${name}".`);
    }

    if (info.events) {
      eventHandlers = {};

      _.forOwn(info.events, (handler, event) => {
        eventHandlers[event] = loadEventHandler(appModule, name, controllersPath, handler);
      });

      appModule.log('verbose', `[${serviceTag}]Event handlers are attached for namespace "${name}".`, {
        events: Object.keys(eventHandlers)
      });
    }

    namespaceChannel.on('connect', function (socket) {
      let ctx = {
        appModule,
        socket
      };
      socket.on('disconnect', () => {
        log('verbose', 'namespace disconnect', {
          endpoint: endpointPath,
          port,
          id: socket.id,
          namespace: name
        });

        if (info.onDisconnect) {
          loadEventHandler(appModule, name, controllersPath, info.onDisconnect)(ctx).catch(error => log('error', error.message));
        }
      });
      log('verbose', 'namespace connect', {
        endpoint: endpointPath,
        port,
        id: socket.id,
        namespace: name
      });
      eventHandlers && _.forOwn(eventHandlers, (handler, event) => {
        socket.on(event, (data, cb) => handler(ctx, data).then(cb));
      });

      if (info.onConnect) {
        loadEventHandler(appModule, name, controllersPath, info.onConnect)(ctx).catch(error => log('error', error.message));
      }
    });
  });

  if (standalone) {
    io.listen(config.port);
  }

  appModule.registerService(serviceTag, io);
  return io;
}

module.exports = {
  type: Feature.PLUGIN,
  load_: (appModule, servers) => {
    if (Array.isArray(servers)) {
      return servers.forEach(server => startSocketServer(appModule, server));
    }

    let io = startSocketServer(appModule, servers);
    appModule.registerService('socketServer', io);
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcHBGZWF0dXJlcy9zb2NrZXRTZXJ2ZXIuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwidXJsIiwidXJsVXRpbCIsInRleHQiLCJGZWF0dXJlIiwiRW51bXMiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsIkRFRkFVTFRfQ09OVFJPTExFUl9QQVRIIiwibG9hZEV2ZW50SGFuZGxlciIsImFwcE1vZHVsZSIsIm5hbWVzcGFjZSIsImNvbnRyb2xsZXJCYXNlUGF0aCIsImhhbmRsZXJOYW1lIiwiaXNNaWRkbGV3YXJlIiwicG9zIiwibGFzdEluZGV4T2YiLCJjb250cm9sbGVyIiwic3Vic3RyIiwiYWN0aW9uIiwiY29udHJvbGxlclBhdGgiLCJyZXNvbHZlIiwiY3RybCIsIm1pZGRsZXdhcmVIYW5kbGVyIiwic3RhcnRTb2NrZXRTZXJ2ZXIiLCJjb25maWciLCJTb2NrZXRTZXJ2ZXIiLCJ0cnlSZXF1aXJlIiwicG9ydCIsImxvZ2dlciIsIndzUGF0aCIsIm9wdGlvbnMiLCJnZXRTZXJ2aWNlIiwibG9nIiwiYXJncyIsImlvIiwic3RhbmRhbG9uZSIsImVuZHBvaW50UGF0aCIsImpvaW4iLCJyb3V0ZSIsImVuc3VyZVN0YXJ0c1dpdGgiLCJzZXJ2aWNlVGFnIiwiaGFzU2VydmljZSIsImkiLCJzZXJ2ZXIiLCJodHRwU2VydmVyIiwib24iLCJzb2NrZXQiLCJlbmRwb2ludCIsImlkIiwiaGFuZHNoYWtlIiwiY29udHJvbGxlcnNQYXRoIiwiYmFja2VuZFBhdGgiLCJtaWRkbGV3YXJlcyIsInVzZSIsIm1pZGRsZXdhcmVOYW1lIiwiaXNFbXB0eSIsInJvdXRlcyIsImZvck93biIsImluZm8iLCJuYW1lIiwibmFtZXNwYWNlQ2hhbm5lbCIsIm9mIiwibSIsIkFycmF5IiwiaXNBcnJheSIsImZvckVhY2giLCJldmVudEhhbmRsZXJzIiwicnBjQ29udHJvbGxlclBhdGgiLCJldmVudHMiLCJoYW5kbGVyIiwiZXZlbnQiLCJPYmplY3QiLCJrZXlzIiwiY3R4Iiwib25EaXNjb25uZWN0IiwiY2F0Y2giLCJlcnJvciIsIm1lc3NhZ2UiLCJkYXRhIiwiY2IiLCJ0aGVuIiwib25Db25uZWN0IiwibGlzdGVuIiwicmVnaXN0ZXJTZXJ2aWNlIiwibW9kdWxlIiwiZXhwb3J0cyIsInR5cGUiLCJQTFVHSU4iLCJsb2FkXyIsInNlcnZlcnMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBU0EsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsR0FBRyxFQUFFQyxPQUFWO0FBQW1CQyxFQUFBQTtBQUFuQixJQUE0QkosT0FBTyxDQUFDLFlBQUQsQ0FBekM7O0FBQ0EsTUFBTTtBQUFFSyxFQUFBQTtBQUFGLElBQWNMLE9BQU8sQ0FBQyxJQUFELENBQVAsQ0FBY00sS0FBbEM7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQTJCUCxPQUFPLENBQUMsYUFBRCxDQUF4Qzs7QUFFQSxNQUFNUSx1QkFBdUIsR0FBRyxRQUFoQzs7QUFFQSxTQUFTQyxnQkFBVCxDQUEwQkMsU0FBMUIsRUFBcUNDLFNBQXJDLEVBQWdEQyxrQkFBaEQsRUFBb0VDLFdBQXBFLEVBQWlGQyxZQUFZLEdBQUcsS0FBaEcsRUFBdUc7QUFDbkcsTUFBSUMsR0FBRyxHQUFHRixXQUFXLENBQUNHLFdBQVosQ0FBd0IsR0FBeEIsQ0FBVjs7QUFDQSxNQUFJRCxHQUFHLEdBQUcsQ0FBVixFQUFhO0FBQ1QsUUFBSUQsWUFBSixFQUFrQjtBQUNkLFlBQU0sSUFBSVAsb0JBQUosQ0FDRCxpQ0FBZ0NNLFdBQVksRUFEM0MsRUFFRkgsU0FGRSxFQUdGQyxTQUFTLEdBQUksd0JBQXVCQSxTQUFVLGdCQUFyQyxHQUF1RCwwQkFIOUQsQ0FBTjtBQUtILEtBTkQsTUFNTztBQUNILFlBQU0sSUFBSUosb0JBQUosQ0FDRCxvQ0FBbUNNLFdBQVksRUFEOUMsRUFFRkgsU0FGRSxFQUdELHdCQUF1QkMsU0FBVSxXQUho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L0UsU0FBRCxFQUFZZ0YsT0FBWixLQUF3QjtBQUUzQixRQUFJMUIsS0FBSyxDQUFDQyxPQUFOLENBQWN5QixPQUFkLENBQUosRUFBNEI7QUFDeEIsYUFBT0EsT0FBTyxDQUFDeEIsT0FBUixDQUFnQnRCLE1BQU0sSUFBSXBCLGlCQUFpQixDQUFDZCxTQUFELEVBQVlrQyxNQUFaLENBQTNDLENBQVA7QUFDSDs7QUFFRCxRQUFJVCxFQUFFLEdBQUdYLGlCQUFpQixDQUFDZCxTQUFELEVBQVlnRixPQUFaLENBQTFCO0FBR0FoRixJQUFBQSxTQUFTLENBQUMwRSxlQUFWLENBQTBCLGNBQTFCLEVBQTBDakQsRUFBMUM7QUFDSDtBQWxDWSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKipcbiAqIFNvY2tldCBiYXNlZCBScGMgU2VydmVyXG4gKiBAbW9kdWxlIEZlYXR1cmVfU29ja2V0U2VydmVyXG4gKiBcbiAqIG1pZGRsZXdhcmU6IChwYWNrZXQsIG5leHQpID0+IHt9XG4gKi9cblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgdXJsOiB1cmxVdGlsLCB0ZXh0IH0gPSByZXF1aXJlKCdAZ2VueC9qdWx5Jyk7XG5jb25zdCB7IEZlYXR1cmUgfSA9IHJlcXVpcmUoJy4uJykuRW51bXM7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uIH0gPSByZXF1aXJlKCdAZ2VueC9lcnJvcicpO1xuXG5jb25zdCBERUZBVUxUX0NPTlRST0xMRVJfUEFUSCA9ICdldmVudHMnO1xuXG5mdW5jdGlvbiBsb2FkRXZlbnRIYW5kbGVyKGFwcE1vZHVsZSwgbmFtZXNwYWNlLCBjb250cm9sbGVyQmFzZVBhdGgsIGhhbmRsZXJOYW1lLCBpc01pZGRsZXdhcmUgPSBmYWxzZSkge1xuICAgIGxldCBwb3MgPSBoYW5kbGVyTmFtZS5sYXN0SW5kZXhPZignLicpO1xuICAgIGlmIChwb3MgPCAwKSB7XG4gICAgICAgIGlmIChpc01pZGRsZXdhcmUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICBgSW52YWxpZCBtaWRkbGV3YXJlIHJlZmVyZW5jZTogJHtoYW5kbGVyTmFtZX1gLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICBuYW1lc3BhY2UgPyBgc29ja2V0U2VydmVyLnJvdXRlc1tcIiR7bmFtZXNwYWNlfVwiXS5taWRkbGV3YXJlc2AgOiAnc29ja2V0U2VydmVyLm1pZGRsZXdhcmVzJ1xuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICBgSW52YWxpZCBldmVudCBoYW5kbGVyIHJlZmVyZW5jZTogJHtoYW5kbGVyTmFtZX1gLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICBgc29ja2V0U2VydmVyLnJvdXRlc1tcIiR7bmFtZXNwYWNlfVwiXS5ldmVudHNgXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGNvbnRyb2xsZXIgPSBoYW5kbGVyTmFtZS5zdWJzdHIoMCwgcG9zKTtcbiAgICBsZXQgYWN0aW9uID0gaGFuZGxlck5hbWUuc3Vic3RyKHBvcyArIDEpO1xuXG4gICAgbGV0IGNvbnRyb2xsZXJQYXRoID0gcGF0aC5yZXNvbHZlKGNvbnRyb2xsZXJCYXNlUGF0aCwgY29udHJvbGxlciArICcuanMnKTtcbiAgICBsZXQgY3RybCA9IHJlcXVpcmUoY29udHJvbGxlclBhdGgpO1xuICAgIFxuICAgIGxldCBtaWRkbGV3YXJlSGFuZGxlciA9IGN0cmxbYWN0aW9uXTtcbiAgICBpZiAodHlwZW9mIG1pZGRsZXdhcmVIYW5kbGVyICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGlmIChpc01pZGRsZXdhcmUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICBgTWlkZGxld2FyZSBmdW5jdGlvbiBub3QgZm91bmQ6ICR7aGFuZGxlck5hbWV9YCxcbiAgICAgICAgICAgICAgICBhcHBNb2R1bGUsXG4gICAgICAgICAgICAgICAgbmFtZXNwYWNlID8gYHNvY2tldFNlcnZlci5yb3V0ZXNbXCIke25hbWVzcGFjZX1cIl0ubWlkZGxld2FyZXNgIDogJ3NvY2tldFNlcnZlci5taWRkbGV3YXJlcydcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgYEV2ZW50IGhhbmRsZXIgZnVuY3Rpb24gbm90IGZvdW5kOiAke2hhbmRsZXJOYW1lfWAsXG4gICAgICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgICAgIGBzb2NrZXRTZXJ2ZXIucm91dGVzW1wiJHtuYW1lc3BhY2V9XCJdLmV2ZW50c2BcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbWlkZGxld2FyZUhhbmRsZXI7XG59XG5cbmZ1bmN0aW9uIHN0YXJ0U29ja2V0U2VydmVyKGFwcE1vZHVsZSwgY29uZmlnKSB7XG4gICAgY29uc3QgU29ja2V0U2VydmVyID0gYXBwTW9kdWxlLnRyeVJlcXVpcmUoJ3NvY2tldC5pbycpO1xuXG4gICAgbGV0IHsgcG9ydCwgbG9nZ2VyLCBwYXRoOiB3c1BhdGgsIC4uLm9wdGlvbnMgfSA9IGNvbmZpZztcblxuICAgIGlmIChsb2dnZXIgJiYgdHlwZW9mIGxvZ2dlciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgbG9nZ2VyID0gYXBwTW9kdWxlLmdldFNlcnZpY2UoJ2xvZ2dlci4nICsgbG9nZ2VyKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBsb2coLi4uYXJncykge1xuICAgICAgICBsb2dnZXIgJiYgbG9nZ2VyLmxvZyguLi5hcmdzKTtcbiAgICB9XG5cbiAgICBsZXQgaW8sIHN0YW5kYWxvbmUgPSBmYWxzZTtcblxuICAgIGxldCBlbmRwb2ludFBhdGggPSB3c1BhdGggPyB1cmxVdGlsLmpvaW4oYXBwTW9kdWxlLnJvdXRlLCB3c1BhdGgpIDogYXBwTW9kdWxlLnJvdXRlO1xuICAgIGVuZHBvaW50UGF0aCA9IHRleHQuZW5zdXJlU3RhcnRzV2l0aChlbmRwb2ludFBhdGgsICcvJyk7XG5cbiAgICBsZXQgc2VydmljZVRhZyA9IHBvcnQgPyBgc29ja2V0U2VydmVyOiR7cG9ydH0ke2VuZHBvaW50UGF0aH1gIDogYHNvY2tldFNlcnZlcjoke2VuZHBvaW50UGF0aH1gO1xuXG4gICAgaWYgKGFwcE1vZHVsZS5oYXNTZXJ2aWNlKHNlcnZpY2VUYWcpKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdTb2NrZXQgc2VydmVyIHBhdGggb3IgcG9ydCBjb25mbGljdC4nLFxuICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgYHNvY2tldFNlcnZlclske2l9XS4ocGF0aHxwb3J0KWBcbiAgICAgICAgKTtcbiAgICB9ICAgICAgICAgICAgXG5cbiAgICBvcHRpb25zLnBhdGggPSBlbmRwb2ludFBhdGg7XG5cbiAgICBpZiAocG9ydCkge1xuICAgICAgICBpbyA9IG5ldyBTb2NrZXRTZXJ2ZXIob3B0aW9ucyk7XG4gICAgICAgIHN0YW5kYWxvbmUgPSB0cnVlO1xuICAgICAgICBhcHBNb2R1bGUubG9nKCd2ZXJib3NlJywgYEEgc3RhbmRhbG9uZSBzb2NrZXQgc2VydmVyIGlzIGxpc3RlbmluZyBhdCBbcG9ydD0ke3BvcnR9LCBwYXRoPSR7ZW5kcG9pbnRQYXRofV0uYCk7ICAgICAgICBcbiAgICB9IGVsc2Uge1xuICAgICAgICBpbyA9IG5ldyBTb2NrZXRTZXJ2ZXIoYXBwTW9kdWxlLnNlcnZlci5odHRwU2VydmVyLCBvcHRpb25zKTtcbiAgICAgICAgcG9ydCA9IGFwcE1vZHVsZS5zZXJ2ZXIucG9ydDtcbiAgICAgICAgYXBwTW9kdWxlLmxvZygndmVyYm9zZScsIGBBIHNvY2tldCBzZXJ2ZXIgaXMgbGlzdGVuaW5nIGF0IFtwYXRoPSR7ZW5kcG9pbnRQYXRofV0uYCk7ICAgICAgICBcbiAgICB9XG5cbiAgICBpby5vbignY29ubmVjdGlvbicsIHNvY2tldCA9PiB7XG4gICAgICAgIGxvZygnaW5mbycsICdjbGllbnQgY29ubmVjdCcsIHtcbiAgICAgICAgICAgIGVuZHBvaW50OiBlbmRwb2ludFBhdGgsXG4gICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgaWQ6IHNvY2tldC5pZCxcbiAgICAgICAgICAgIC4uLnNvY2tldC5oYW5kc2hha2VcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBsZXQgY29udHJvbGxlcnNQYXRoID0gcGF0aC5yZXNvbHZlKGFwcE1vZHVsZS5iYWNrZW5kUGF0aCwgY29uZmlnLmNvbnRyb2xsZXJzUGF0aCB8fCBERUZBVUxUX0NPTlRST0xMRVJfUEFUSCk7XG5cbiAgICBpZiAoY29uZmlnLm1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGlvLnVzZShsb2FkRXZlbnRIYW5kbGVyKGFwcE1vZHVsZSwgbnVsbCwgY29udHJvbGxlcnNQYXRoLCBtaWRkbGV3YXJlTmFtZSwgdHJ1ZSkpO1xuICAgIH1cblxuICAgIGlmIChfLmlzRW1wdHkoY29uZmlnLnJvdXRlcykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3Npbmcgcm91dGVzIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgJ3NvY2tldFNlcnZlci5yb3V0ZXMnXG4gICAgICAgICk7XG4gICAgfSAgICAgICAgXG5cbiAgICBfLmZvck93bihjb25maWcucm91dGVzLCAoaW5mbywgbmFtZSkgPT4ge1xuICAgICAgICBuYW1lID0gdGV4dC5lbnN1cmVTdGFydHNXaXRoKG5hbWUsICcvJyk7XG5cbiAgICAgICAgbGV0IG5hbWVzcGFjZUNoYW5uZWwgPSBpby5vZihuYW1lKTtcblxuICAgICAgICBpZiAoaW5mby5taWRkbGV3YXJlcykge1xuICAgICAgICAgICAgbGV0IG0gPSBBcnJheS5pc0FycmF5KGluZm8ubWlkZGxld2FyZXMpID8gaW5mby5taWRkbGV3YXJlcyA6IFsgaW5mby5taWRkbGV3YXJlcyBdO1xuICAgICAgICAgICAgbS5mb3JFYWNoKG1pZGRsZXdhcmVOYW1lID0+IHtcbiAgICAgICAgICAgICAgICBuYW1lc3BhY2VDaGFubmVsLnVzZShsb2FkRXZlbnRIYW5kbGVyKGFwcE1vZHVsZSwgbmFtZSwgY29udHJvbGxlcnNQYXRoLCBtaWRkbGV3YXJlTmFtZSwgdHJ1ZSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZXZlbnRIYW5kbGVycztcblxuICAgICAgICBpZiAoaW5mby5jb250cm9sbGVyKSB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IHJwY0NvbnRyb2xsZXJQYXRoID0gcGF0aC5yZXNvbHZlKGNvbnRyb2xsZXJzUGF0aCwgaW5mby5jb250cm9sbGVyICsgJy5qcycpO1xuICAgICAgICAgICAgZXZlbnRIYW5kbGVycyA9IHJlcXVpcmUocnBjQ29udHJvbGxlclBhdGgpO1xuXG4gICAgICAgICAgICBhcHBNb2R1bGUubG9nKCd2ZXJib3NlJywgYFske3NlcnZpY2VUYWd9XUNvbnRyb2xsZXIgXCIke2luZm8uY29udHJvbGxlcn1cIiBpcyBhdHRhY2hlZCBmb3IgbmFtZXNwYWNlIFwiJHtuYW1lfVwiLmApO1xuICAgICAgICB9IFxuICAgICAgICBcbiAgICAgICAgaWYgKGluZm8uZXZlbnRzKSB7XG4gICAgICAgICAgICBldmVudEhhbmRsZXJzID0ge307XG5cbiAgICAgICAgICAgIF8uZm9yT3duKGluZm8uZXZlbnRzLCAoaGFuZGxlciwgZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBldmVudEhhbmRsZXJzW2V2ZW50XSA9IGxvYWRFdmVudEhhbmRsZXIoYXBwTW9kdWxlLCBuYW1lLCBjb250cm9sbGVyc1BhdGgsIGhhbmRsZXIpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgYXBwTW9kdWxlLmxvZygndmVyYm9zZScsIGBbJHtzZXJ2aWNlVGFnfV1FdmVudCBoYW5kbGVycyBhcmUgYXR0YWNoZWQgZm9yIG5hbWVzcGFjZSBcIiR7bmFtZX1cIi5gLCB7XG4gICAgICAgICAgICAgICAgZXZlbnRzOiBPYmplY3Qua2V5cyhldmVudEhhbmRsZXJzKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBuYW1lc3BhY2VDaGFubmVsLm9uKCdjb25uZWN0JywgZnVuY3Rpb24gKHNvY2tldCkge1xuICAgICAgICAgICAgbGV0IGN0eCA9IHsgYXBwTW9kdWxlLCBzb2NrZXQgfTtcblxuICAgICAgICAgICAgc29ja2V0Lm9uKCdkaXNjb25uZWN0JywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGxvZygndmVyYm9zZScsICduYW1lc3BhY2UgZGlzY29ubmVjdCcsIHsgXG4gICAgICAgICAgICAgICAgICAgIGVuZHBvaW50OiBlbmRwb2ludFBhdGgsXG4gICAgICAgICAgICAgICAgICAgIHBvcnQsXG4gICAgICAgICAgICAgICAgICAgIGlkOiBzb2NrZXQuaWQsIFxuICAgICAgICAgICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWUgXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoaW5mby5vbkRpc2Nvbm5lY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgbG9hZEV2ZW50SGFuZGxlcihhcHBNb2R1bGUsIG5hbWUsIGNvbnRyb2xsZXJzUGF0aCwgaW5mby5vbkRpc2Nvbm5lY3QpKGN0eCkuY2F0Y2goZXJyb3IgPT4gbG9nKCdlcnJvcicsIGVycm9yLm1lc3NhZ2UpKTsgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9ICAgICBcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBsb2coJ3ZlcmJvc2UnLCAnbmFtZXNwYWNlIGNvbm5lY3QnLCB7IFxuICAgICAgICAgICAgICAgIGVuZHBvaW50OiBlbmRwb2ludFBhdGgsXG4gICAgICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgICAgICBpZDogc29ja2V0LmlkLCBcbiAgICAgICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWUgXG4gICAgICAgICAgICB9KTsgICAgICAgICAgIFxuXG4gICAgICAgICAgICAvL1JlZ2lzdGVyIGV2ZW50IGhhbmRsZXJzXG4gICAgICAgICAgICBldmVudEhhbmRsZXJzICYmIF8uZm9yT3duKGV2ZW50SGFuZGxlcnMsIChoYW5kbGVyLCBldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHNvY2tldC5vbihldmVudCwgKGRhdGEsIGNiKSA9PiBoYW5kbGVyKGN0eCwgZGF0YSkudGhlbihjYikpO1xuICAgICAgICAgICAgfSk7ICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBpZiAoaW5mby5vbkNvbm5lY3QpIHtcbiAgICAgICAgICAgICAgICBsb2FkRXZlbnRIYW5kbGVyKGFwcE1vZHVsZSwgbmFtZSwgY29udHJvbGxlcnNQYXRoLCBpbmZvLm9uQ29ubmVjdCkoY3R4KS5jYXRjaChlcnJvciA9PiBsb2coJ2Vycm9yJywgZXJyb3IubWVzc2FnZSkpOyAgICAgICAgICAgIFxuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGlmIChzdGFuZGFsb25lKSB7XG4gICAgICAgIGlvLmxpc3Rlbihjb25maWcucG9ydCk7XG4gICAgfVxuXG4gICAgYXBwTW9kdWxlLnJlZ2lzdGVyU2VydmljZShzZXJ2aWNlVGFnLCBpbyk7XG5cbiAgICByZXR1cm4gaW87XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuXG4gICAgLyoqXG4gICAgICogVGhpcyBmZWF0dXJlIGlzIGxvYWRlZCBhdCBwbHVnaW4gc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5QTFVHSU4sXG5cbiAgICAvKipcbiAgICAgKiBUaGUgc29ja2V0IHNlcnZlciBvcHRpb25zLlxuICAgICAqIEB0eXBlZGVmIHtPYmplY3R9IFNlcnZlck9wdGlvbnNcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW3BhdGg9L3NvY2tldC5pb10gLSBuYW1lIG9mIHRoZSBwYXRoIHRvIGNhcHR1cmVcbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtzZXJ2ZUNsaWVudD10cnVlXSAtIHdoZXRoZXIgdG8gc2VydmUgdGhlIGNsaWVudCBmaWxlc1xuICAgICAqIEBwcm9wZXJ0eSB7QWRhcHRlcn0gYWRhcHRlciAtIHRoZSBhZGFwdGVyIHRvIHVzZS4gRGVmYXVsdHMgdG8gYW4gaW5zdGFuY2Ugb2YgdGhlIEFkYXB0ZXIgdGhhdCBzaGlwcyB3aXRoIHNvY2tldC5pbyB3aGljaCBpcyBtZW1vcnkgYmFzZWQuIFNlZSBzb2NrZXQuaW8tYWRhcHRlclxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBvcmlnaW5zIC0gdGhlIGFsbG93ZWQgb3JpZ2luc1xuICAgICAqIEBwcm9wZXJ0eSB7UGFyc2VyfSBwYXJzZXIgLSB0aGUgcGFyc2VyIHRvIHVzZS4gRGVmYXVsdHMgdG8gYW4gaW5zdGFuY2Ugb2YgdGhlIFBhcnNlciB0aGF0IHNoaXBzIHdpdGggc29ja2V0LmlvLiBTZWUgc29ja2V0LmlvLXBhcnNlclxuICAgICAqIEBzZWUge0BsaW5rIGh0dHBzOi8vc29ja2V0LmlvL2RvY3Mvc2VydmVyLWFwaS99IGZvciBtb3JlIG9wdGlvbnNcbiAgICAgKi9cblxuICAgIC8qKlxuICAgICAqIExvYWQgdGhlIHJwYyBTZXJ2ZXJcbiAgICAgKiBAcGFyYW0ge0FwcE1vZHVsZX0gYXBwTW9kdWxlIC0gVGhlIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtTZXJ2ZXJPcHRpb25zW119IHNlcnZlcnMgLSBScGMgc2VydmVyIGNvbmZpZ1xuICAgICAqL1xuICAgIGxvYWRfOiAoYXBwTW9kdWxlLCBzZXJ2ZXJzKSA9PiB7ICAgICAgICBcblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzZXJ2ZXJzKSkge1xuICAgICAgICAgICAgcmV0dXJuIHNlcnZlcnMuZm9yRWFjaChzZXJ2ZXIgPT4gc3RhcnRTb2NrZXRTZXJ2ZXIoYXBwTW9kdWxlLCBzZXJ2ZXIpKTsgICAgICAgICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBpbyA9IHN0YXJ0U29ja2V0U2VydmVyKGFwcE1vZHVsZSwgc2VydmVycyk7XG5cbiAgICAgICAgLy9kZWZhdWx0IHNvY2tldCBzZXJ2ZXJcbiAgICAgICAgYXBwTW9kdWxlLnJlZ2lzdGVyU2VydmljZSgnc29ja2V0U2VydmVyJywgaW8pO1xuICAgIH1cbn07Il19