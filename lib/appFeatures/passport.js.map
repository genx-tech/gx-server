{"version":3,"file":"passport.js","names":["require","path","_","eachAsync_","Feature","Enums","InvalidConfiguration","module","exports","type","SERVICE","load_","app","config","KoaPassport","tryRequire","passport","isEmpty","strategies","initializeMiddleware","initialize","init","middlewares","useSession","session","on","READY","useMiddlewares","router","hasStrategy","name","_strategies","registerService","exposeToServer","server","Array","isArray","strategy","strategyScript","join","backendPath","strategyInitiator"],"sources":["../../src/appFeatures/passport.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Enable passport feature\n * @module Feature_Passport\n */\n\nconst path = require('path');\nconst { _, eachAsync_ } = require('@genx/july');\nconst { Feature } = require('..').Enums;\nconst { InvalidConfiguration } = require('@genx/error');\n\nmodule.exports = {\n\n    /**\n     * This feature is loaded at service stage\n     * @member {string}\n     */\n    type: Feature.SERVICE,\n\n    /**\n     * Load the feature\n     * @param {Routable} app - The app module object\n     * @param {object} config - Passport settings\n     * @property {bool} [config.useSession=false] - Use session or not, default: false\n     *  \n     * @property {object} config.init - Passport initialization settings     \n     * @property {string} [config.init.userProperty='user'] - User property name, default: user      \n     * \n     * @property {array} config.strategies - Passport strategies, e.g. [ 'local', 'facebook' ]\n     * @property {array} config.exposeToServer - Expose the passport servcie to while server\n     * @returns {Promise.<*>}\n     */\n    load_: function (app, config) {\n        const KoaPassport = app.tryRequire('koa-passport').KoaPassport;\n        let passport = new KoaPassport();\n        if (_.isEmpty(config) || _.isEmpty(config.strategies)) {\n            throw new InvalidConfiguration(\n                'Missing passport strategies.',\n                app,\n                'passport.strategies'\n            );\n        }        \n\n        let initializeMiddleware = passport.initialize(config.init);\n\n        passport.middlewares = config.useSession ? [ initializeMiddleware, passport.session() ] : initializeMiddleware;\n\n        app.on('before:' + Feature.READY, () => {\n            app.useMiddlewares(app.router, passport.middlewares);\n        });\n\n        passport.hasStrategy = (name) => {\n            return name in passport._strategies;\n        };\n\n        app.registerService('passport', passport);        \n\n        if (config.exposeToServer && app !== app.server) {\n            app.server.registerService('passport', passport);\n        }\n\n        let strategies = Array.isArray(config.strategies) ? config.strategies : [ config.strategies ];\n\n        return eachAsync_(strategies, async strategy => {\n            let strategyScript = path.join(app.backendPath, 'passports', strategy + '.js');\n            let strategyInitiator = require(strategyScript);\n            return strategyInitiator(app, passport);\n        });\n    }\n};"],"mappings":"AAAA,YAAY;AAACA,OAAA;AAOb,MAAMC,IAAI,GAAGD,OAAO,CAAC,MAAM,CAAC;AAC5B,MAAM;EAAEE,CAAC;EAAEC;AAAW,CAAC,GAAGH,OAAO,CAAC,YAAY,CAAC;AAC/C,MAAM;EAAEI;AAAQ,CAAC,GAAGJ,OAAO,CAAC,IAAI,CAAC,CAACK,KAAK;AACvC,MAAM;EAAEC;AAAqB,CAAC,GAAGN,OAAO,CAAC,aAAa,CAAC;AAEvDO,MAAM,CAACC,OAAO,GAAG;EAMbC,IAAI,EAAEL,OAAO,CAACM,OAAO;EAerBC,KAAK,EAAE,SAAAA,CAAUC,GAAG,EAAEC,MAAM,EAAE;IAC1B,MAAMC,WAAW,GAAGF,GAAG,CAACG,UAAU,CAAC,cAAc,CAAC,CAACD,WAAW;IAC9D,IAAIE,QAAQ,GAAG,IAAIF,WAAW,CAAC,CAAC;IAChC,IAAIZ,CAAC,CAACe,OAAO,CAACJ,MAAM,CAAC,IAAIX,CAAC,CAACe,OAAO,CAACJ,MAAM,CAACK,UAAU,CAAC,EAAE;MACnD,MAAM,IAAIZ,oBAAoB,CAC1B,8BAA8B,EAC9BM,GAAG,EACH,qBACJ,CAAC;IACL;IAEA,IAAIO,oBAAoB,GAAGH,QAAQ,CAACI,UAAU,CAACP,MAAM,CAACQ,IAAI,CAAC;IAE3DL,QAAQ,CAACM,WAAW,GAAGT,MAAM,CAACU,UAAU,GAAG,CAAEJ,oBAAoB,EAAEH,QAAQ,CAACQ,OAAO,CAAC,CAAC,CAAE,GAAGL,oBAAoB;IAE9GP,GAAG,CAACa,EAAE,CAAC,SAAS,GAAGrB,OAAO,CAACsB,KAAK,EAAE,MAAM;MACpCd,GAAG,CAACe,cAAc,CAACf,GAAG,CAACgB,MAAM,EAAEZ,QAAQ,CAACM,WAAW,CAAC;IACxD,CAAC,CAAC;IAEFN,QAAQ,CAACa,WAAW,GAAIC,IAAI,IAAK;MAC7B,OAAOA,IAAI,IAAId,QAAQ,CAACe,WAAW;IACvC,CAAC;IAEDnB,GAAG,CAACoB,eAAe,CAAC,UAAU,EAAEhB,QAAQ,CAAC;IAEzC,IAAIH,MAAM,CAACoB,cAAc,IAAIrB,GAAG,KAAKA,GAAG,CAACsB,MAAM,EAAE;MAC7CtB,GAAG,CAACsB,MAAM,CAACF,eAAe,CAAC,UAAU,EAAEhB,QAAQ,CAAC;IACpD;IAEA,IAAIE,UAAU,GAAGiB,KAAK,CAACC,OAAO,CAACvB,MAAM,CAACK,UAAU,CAAC,GAAGL,MAAM,CAACK,UAAU,GAAG,CAAEL,MAAM,CAACK,UAAU,CAAE;IAE7F,OAAOf,UAAU,CAACe,UAAU,EAAE,MAAMmB,QAAQ,IAAI;MAC5C,IAAIC,cAAc,GAAGrC,IAAI,CAACsC,IAAI,CAAC3B,GAAG,CAAC4B,WAAW,EAAE,WAAW,EAAEH,QAAQ,GAAG,KAAK,CAAC;MAC9E,IAAII,iBAAiB,GAAGzC,OAAO,CAACsC,cAAc,CAAC;MAC/C,OAAOG,iBAAiB,CAAC7B,GAAG,EAAEI,QAAQ,CAAC;IAC3C,CAAC,CAAC;EACN;AACJ,CAAC"}