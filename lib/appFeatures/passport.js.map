{"version":3,"file":"passport.js","names":["path","require","_","eachAsync_","Feature","Enums","InvalidConfiguration","module","exports","type","SERVICE","load_","app","config","KoaPassport","tryRequire","passport","isEmpty","strategies","initializeMiddleware","initialize","init","middlewares","useSession","session","on","READY","useMiddlewares","router","hasStrategy","name","_strategies","registerService","exposeToServer","server","Array","isArray","strategy","strategyScript","join","backendPath","strategyInitiator"],"sources":["../../src/appFeatures/passport.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Enable passport feature\n * @module Feature_Passport\n */\n\nconst path = require('path');\nconst { _, eachAsync_ } = require('@genx/july');\nconst { Feature } = require('..').Enums;\nconst { InvalidConfiguration } = require('@genx/error');\n\nmodule.exports = {\n\n    /**\n     * This feature is loaded at service stage\n     * @member {string}\n     */\n    type: Feature.SERVICE,\n\n    /**\n     * Load the feature\n     * @param {Routable} app - The app module object\n     * @param {object} config - Passport settings\n     * @property {bool} [config.useSession=false] - Use session or not, default: false\n     *  \n     * @property {object} config.init - Passport initialization settings     \n     * @property {string} [config.init.userProperty='user'] - User property name, default: user      \n     * \n     * @property {array} config.strategies - Passport strategies, e.g. [ 'local', 'facebook' ]\n     * @property {array} config.exposeToServer - Expose the passport servcie to while server\n     * @returns {Promise.<*>}\n     */\n    load_: function (app, config) {\n        const KoaPassport = app.tryRequire('koa-passport').KoaPassport;\n        let passport = new KoaPassport();\n        if (_.isEmpty(config) || _.isEmpty(config.strategies)) {\n            throw new InvalidConfiguration(\n                'Missing passport strategies.',\n                app,\n                'passport.strategies'\n            );\n        }        \n\n        let initializeMiddleware = passport.initialize(config.init);\n\n        passport.middlewares = config.useSession ? [ initializeMiddleware, passport.session() ] : initializeMiddleware;\n\n        app.on('before:' + Feature.READY, () => {\n            app.useMiddlewares(app.router, passport.middlewares);\n        });\n\n        passport.hasStrategy = (name) => {\n            return name in passport._strategies;\n        };\n\n        app.registerService('passport', passport);        \n\n        if (config.exposeToServer && app !== app.server) {\n            app.server.registerService('passport', passport);\n        }\n\n        let strategies = Array.isArray(config.strategies) ? config.strategies : [ config.strategies ];\n\n        return eachAsync_(strategies, async strategy => {\n            let strategyScript = path.join(app.backendPath, 'passports', strategy + '.js');\n            let strategyInitiator = require(strategyScript);\n            return strategyInitiator(app, passport);\n        });\n    }\n};"],"mappings":"AAAA;;;;AAOA,MAAMA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAApB;;AACA,MAAM;EAAEC,CAAF;EAAKC;AAAL,IAAoBF,OAAO,CAAC,YAAD,CAAjC;;AACA,MAAM;EAAEG;AAAF,IAAcH,OAAO,CAAC,IAAD,CAAP,CAAcI,KAAlC;;AACA,MAAM;EAAEC;AAAF,IAA2BL,OAAO,CAAC,aAAD,CAAxC;;AAEAM,MAAM,CAACC,OAAP,GAAiB;EAMbC,IAAI,EAAEL,OAAO,CAACM,OAND;EAqBbC,KAAK,EAAE,UAAUC,GAAV,EAAeC,MAAf,EAAuB;IAC1B,MAAMC,WAAW,GAAGF,GAAG,CAACG,UAAJ,CAAe,cAAf,EAA+BD,WAAnD;IACA,IAAIE,QAAQ,GAAG,IAAIF,WAAJ,EAAf;;IACA,IAAIZ,CAAC,CAACe,OAAF,CAAUJ,MAAV,KAAqBX,CAAC,CAACe,OAAF,CAAUJ,MAAM,CAACK,UAAjB,CAAzB,EAAuD;MACnD,MAAM,IAAIZ,oBAAJ,CACF,8BADE,EAEFM,GAFE,EAGF,qBAHE,CAAN;IAKH;;IAED,IAAIO,oBAAoB,GAAGH,QAAQ,CAACI,UAAT,CAAoBP,MAAM,CAACQ,IAA3B,CAA3B;IAEAL,QAAQ,CAACM,WAAT,GAAuBT,MAAM,CAACU,UAAP,GAAoB,CAAEJ,oBAAF,EAAwBH,QAAQ,CAACQ,OAAT,EAAxB,CAApB,GAAmEL,oBAA1F;IAEAP,GAAG,CAACa,EAAJ,CAAO,YAAYrB,OAAO,CAACsB,KAA3B,EAAkC,MAAM;MACpCd,GAAG,CAACe,cAAJ,CAAmBf,GAAG,CAACgB,MAAvB,EAA+BZ,QAAQ,CAACM,WAAxC;IACH,CAFD;;IAIAN,QAAQ,CAACa,WAAT,GAAwBC,IAAD,IAAU;MAC7B,OAAOA,IAAI,IAAId,QAAQ,CAACe,WAAxB;IACH,CAFD;;IAIAnB,GAAG,CAACoB,eAAJ,CAAoB,UAApB,EAAgChB,QAAhC;;IAEA,IAAIH,MAAM,CAACoB,cAAP,IAAyBrB,GAAG,KAAKA,GAAG,CAACsB,MAAzC,EAAiD;MAC7CtB,GAAG,CAACsB,MAAJ,CAAWF,eAAX,CAA2B,UAA3B,EAAuChB,QAAvC;IACH;;IAED,IAAIE,UAAU,GAAGiB,KAAK,CAACC,OAAN,CAAcvB,MAAM,CAACK,UAArB,IAAmCL,MAAM,CAACK,UAA1C,GAAuD,CAAEL,MAAM,CAACK,UAAT,CAAxE;IAEA,OAAOf,UAAU,CAACe,UAAD,EAAa,MAAMmB,QAAN,IAAkB;MAC5C,IAAIC,cAAc,GAAGtC,IAAI,CAACuC,IAAL,CAAU3B,GAAG,CAAC4B,WAAd,EAA2B,WAA3B,EAAwCH,QAAQ,GAAG,KAAnD,CAArB;;MACA,IAAII,iBAAiB,GAAGxC,OAAO,CAACqC,cAAD,CAA/B;;MACA,OAAOG,iBAAiB,CAAC7B,GAAD,EAAMI,QAAN,CAAxB;IACH,CAJgB,CAAjB;EAKH;AAzDY,CAAjB"}